import{d as E,g as I,bA as H,r as d,v as k,B as q,o as b,bZ as T,aO as S,c as x,z as ie,aU as ce,bO as ue,h as l,f as s,w as a,b as u,q as $,m as U,n as de,C as pe,cx as _e,c9 as me,k as fe,t as R,p as be,_ as ve}from"./index-x4baBB9A.js";import{T as ge}from"./treeTransfer-a78MxaYu.js";const ye=E({__name:"menuPermission",props:{nowNodeObject:{},nowNodeObjectModifiers:{},permissionObject:{},permissionObjectModifiers:{}},emits:["update:nowNodeObject","update:permissionObject"],setup(P,{expose:v}){const{proxy:r}=I(),m=H(P,"nowNodeObject"),g=d([]),y=d([]),f=d([]),h=H(P,"permissionObject"),z=k(()=>{const n=JSON.parse(JSON.stringify(g.value));if(!f.value||!h.value)return console.log("没有权限数据或没有选中的对象",h.value),n;console.log("treeDataFinal");const o=new Map;f.value.forEach(w=>{o.set(w.button_id,w)});const i=w=>w.map(B=>{const _={...B},O=o.get(_.id);return O&&O.source_type!==h.value&&(_.disabled=!0,_.disabledTooltip=`权限来源于${V(O.source_type)}:${O.source_name}，无法在此处修改`),_.children&&_.children.length>0&&(_.children=i(_.children)),_});return i(n)}),V=n=>{switch(n){case"user":return"用户";case"role":return"角色";case"user_group":return"用户组";default:return"未知"}},D=async()=>{let n=await r.$api.getMenuTree();g.value=n.data.results},j=async()=>{let n=await r.$api.getPermissionHas(m.value);f.value=n.data.results,y.value=n.data.results.map(o=>o.button_id)},C=(n,o,i)=>{o=="right"?M(i):p(i)},M=async n=>{const o={...m.value,button_ids:n};let i=await r.$api.addObjectPermissions(o);i.status==200?(T({type:"success",message:"权限添加成功"}),S(()=>{j()})):T({type:"error",message:`权限添加失败: ${JSON.stringify(i.data)}`})},p=async n=>{const o={...m.value,button_ids:n};let i=await r.$api.removeObjectPermissions(o);i.status==200?(T({type:"success",message:"权限删除成功"}),S(()=>{j()})):T({type:"error",message:`权限删除失败: ${JSON.stringify(i.data)}`})};return v({getPermissionTreeData:D,getPermissionOnRight:j}),(n,o)=>(b(),q(ge,{modelValue:y.value,"onUpdate:modelValue":o[0]||(o[0]=i=>y.value=i),data:z.value,"leaf-only":!0,"hide-fully-assigned-parents":!0,titles:["可选权限","已选权限"],"check-strictly":!1,onChange:C},null,8,["modelValue","data"]))}}),we={class:"card"},Oe=E({__name:"cmdbPermission",setup(P){const{proxy:v}=I();return(r,m)=>(b(),x("div",we))}}),he={class:"permission-container"},je={class:"left-panel"},Ne={class:"panel-header"},ke={class:"tree-container"},xe={class:"custom-tree-node"},Pe={class:"right-panel"},Ve={key:0,class:"empty-placeholder"},Ce={key:1,class:"protected-object"},Te={key:2,class:"permission-config"},$e={class:"config-header"},Ue={class:"header-info"},Re={class:"header-text"},ze={class:"object-name"},De={class:"object-type"},Me=E({__name:"permissionView",setup(P){const{proxy:v}=I(),r=d("user"),m=d([]),g=d(""),y=d(),f=d(),h=d(),z={children:"children",label:"label",disabled:"disabled"};k(()=>window.innerHeight-200+"px");const V=()=>{};ie(()=>{window.addEventListener("resize",V),J("user")}),ce(()=>{window.removeEventListener("resize",V)}),ue(g,t=>{y.value.filter(t)});const D=t=>{switch(r.value){case"user":return{user_id:t};case"user_group":return{user_group_id:t};case"role":return{role_id:t}}},j=(t,e)=>t?e.label.includes(t):!0,C=d("menu"),M=(t,e)=>{console.log(t,e)},p=d(""),n=d({}),o=k(()=>["admin","sysadmin","系统管理组"].includes(p.value)),i=k(()=>({user:"用户",user_group:"用户组",role:"角色"})[r.value]||"未知"),w=k(()=>({user:"primary",user_group:"success",role:"warning"})[r.value]||"info"),B=t=>{p.value=t.label,n.value=D(t.id),!o.value&&S(()=>{f.value.getPermissionTreeData(),f.value.getPermissionOnRight()})},_=async()=>{const t=await v.$api.user();m.value=t.data.results.map(e=>({id:e.id,label:e.username,disabled:e.username==="admin"}))},O=async()=>{const t=await v.$api.getUserGroup();m.value=t.data.results.map(e=>({id:e.id,label:e.group_name,disabled:e.group_name==="系统管理组"}))},K=async()=>{const t=await v.$api.getRole();m.value=t.data.results.map(e=>({id:e.id,label:e.role,disabled:e.role==="sysadmin"}))},J=t=>{switch(t){case"user":_(),p.value="";break;case"user_group":O(),p.value="";break;case"role":K(),p.value="";break}};return(t,e)=>{const Z=l("el-text"),N=l("el-icon"),L=l("el-radio-button"),Q=pe,W=l("el-radio-group"),X=l("el-input"),A=l("el-tag"),Y=l("el-tree"),ee=l("el-scrollbar"),F=l("el-splitter-panel"),se=l("el-empty"),te=l("el-result"),ae=l("el-avatar"),G=l("el-tab-pane"),ne=l("el-tabs"),oe=l("el-splitter"),le=l("el-card");return b(),x("div",he,[s(le,{class:"permission-card"},{default:a(()=>[s(oe,{class:"main-splitter"},{default:a(()=>[s(F,{min:250,size:250},{default:a(()=>[u("div",je,[u("div",Ne,[s(Z,{class:"panel-title"},{default:a(()=>[...e[7]||(e[7]=[$("授权对象",-1)])]),_:1}),s(W,{modelValue:r.value,"onUpdate:modelValue":e[0]||(e[0]=c=>r.value=c),size:"small",onChange:J},{default:a(()=>[s(L,{label:"user"},{default:a(()=>[s(N,null,{default:a(()=>[s(U(de))]),_:1}),e[8]||(e[8]=u("span",null,"用户",-1))]),_:1}),s(L,{label:"user_group"},{default:a(()=>[s(N,null,{default:a(()=>[s(Q,{icon:"material-symbols:group-outline"})]),_:1}),e[9]||(e[9]=u("span",null,"用户组",-1))]),_:1}),s(L,{label:"role"},{default:a(()=>[s(N,null,{default:a(()=>[s(U(_e))]),_:1}),e[10]||(e[10]=u("span",null,"角色",-1))]),_:1})]),_:1},8,["modelValue"])]),u("div",ke,[s(X,{modelValue:g.value,"onUpdate:modelValue":e[1]||(e[1]=c=>g.value=c),placeholder:"搜索对象...",clearable:"",class:"search-input"},{prefix:a(()=>[s(N,null,{default:a(()=>[s(U(me))]),_:1})]),_:1},8,["modelValue"]),s(ee,{class:"tree-scrollbar"},{default:a(()=>[s(Y,{ref_key:"treeRef",ref:y,class:"object-tree",data:m.value,props:z,"default-expand-all":"","node-key":"id","highlight-current":"","filter-node-method":j,onNodeClick:B},{default:a(({node:c,data:re})=>[u("div",xe,[u("span",null,R(c.label),1),re.disabled?(b(),q(A,{key:0,type:"warning",size:"small",effect:"plain"},{default:a(()=>[...e[11]||(e[11]=[$(" 内置对象 ",-1)])]),_:1})):fe("",!0)])]),_:1},8,["data"])]),_:1})])])]),_:1}),s(F,{"min-size":30},{default:a(()=>[u("div",Pe,[p.value?o.value?(b(),x("div",Ce,[s(te,{icon:"info",title:"受保护对象","sub-title":"此对象为系统内置对象，无需配置权限"},{icon:a(()=>[s(N,{class:"protected-icon"},{default:a(()=>[s(U(be))]),_:1})]),_:1})])):(b(),x("div",Te,[u("div",$e,[u("div",Ue,[s(ae,{size:40},{default:a(()=>[$(R(p.value.charAt(0).toUpperCase()),1)]),_:1}),u("div",Re,[u("div",ze,R(p.value),1),u("div",De,[s(A,{type:w.value,effect:"plain"},{default:a(()=>[$(R(i.value),1)]),_:1},8,["type"])])])])]),s(ne,{modelValue:C.value,"onUpdate:modelValue":e[6]||(e[6]=c=>C.value=c),type:"border-card",class:"permission-tabs",onTabClick:M},{default:a(()=>[s(G,{label:"菜单授权",name:"menu"},{default:a(()=>[s(ye,{ref_key:"menuPermissionRef",ref:f,nowNodeObject:n.value,"onUpdate:nowNodeObject":e[2]||(e[2]=c=>n.value=c),permissionObject:r.value,"onUpdate:permissionObject":e[3]||(e[3]=c=>r.value=c)},null,8,["nowNodeObject","permissionObject"])]),_:1}),s(G,{label:"资产授权",name:"cmdb"},{default:a(()=>[s(Oe,{ref_key:"cmdbPermissionRef",ref:h,nowNodeObject:n.value,"onUpdate:nowNodeObject":e[4]||(e[4]=c=>n.value=c),permissionObject:r.value,"onUpdate:permissionObject":e[5]||(e[5]=c=>r.value=c)},null,8,["nowNodeObject","permissionObject"])]),_:1})]),_:1},8,["modelValue"])])):(b(),x("div",Ve,[s(se,{description:"请选择左侧授权对象"})]))])]),_:1})]),_:1})]),_:1})])}}}),Se=ve(Me,[["__scopeId","data-v-bcc064a9"]]);export{Se as default};
