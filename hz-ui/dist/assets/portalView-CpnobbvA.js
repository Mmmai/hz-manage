import{_ as He,x as Qe,y as We,g as Xe,r as m,a as j,v as Ye,bP as ge,b_ as r,z as Ze,h as u,bc as _e,c as E,o as f,b,f as l,bV as C,m as h,B as $,w as t,q as d,ca as el,l as ll,F as ee,i as ve,t as le,cc as tl,cd as al,c4 as R}from"./index-CWdEKdsq.js";const ol={class:"card"},rl={class:"portal-header"},nl={class:"toolbar"},sl={class:"search-filters"},ul={key:0},il={key:1},dl={class:"pgroup-container"},pl={class:"toolbar"},ml={class:"upload-tip"},cl=Object.assign({name:"portalView"},{__name:"portalView",setup(fl){const k=Qe(),ye=We(),{proxy:p}=Xe(),q=m(""),F=m(""),M=m(""),K=m(!1),i=j({page:1,page_size:10});j({page:1,page_size:10,owner:ye.state.userinfo.user_id});const te=m([]),ae=m(0),A=m([]),H=m(!1),U=m(!1),z=m(!1),Q=m(!1),s=j({name:"",url:"",target:!0,group:"",sharing_type:"public",status:!0,username:"",password:"",sort:9999,describe:""}),S=j({group:""}),L=m("add"),J=m("add"),T=m([]),O=m([]),oe=m([]),we=m(null),be=m(10),re=j({"Content-Type":"multipart/form-data"});Ye(()=>T.value.map(o=>o.id)),ge(()=>i,o=>{v(o)},{deep:!0}),ge([F,M],()=>{X()});const W=()=>{i.page=1,v(i)},X=()=>{i.page=1,v(i)},he=()=>{q.value="",F.value="",M.value="",i.page=1,v(i)},Ve=o=>{i.page_size=o,i.page=1},xe=o=>{i.page=o},Ce=o=>{T.value=o},$e=o=>{O.value=o},v=async o=>{K.value=!0;try{const e={...o,search:q.value,group:F.value,sharing_type:M.value};Object.keys(e).forEach(_=>{(e[_]===""||e[_]===null||e[_]===void 0)&&delete e[_]});const n=await p.$api.portalGet(e);te.value=n.data.results,ae.value=n.data.count}catch(e){r.error("获取门户数据失败"),console.error(e)}finally{K.value=!1}},P=async()=>{try{const o=await p.$api.pgroupGet({page:1,page_size:1e3});A.value=o.data.results}catch(o){r.error("获取分组数据失败"),console.error(o)}},ke=()=>{z.value=!0,L.value="add",Object.assign(s,{name:"",url:"",target:!0,group:"",sharing_type:"public",status:!0,username:"",password:"",sort:9999,describe:""})},Ue=o=>{z.value=!0,L.value="edit",p.$nextTick(()=>{Object.assign(s,o)})},ze=()=>{var o;z.value=!1,(o=p.$refs.portalForm)==null||o.resetFields()},Se=()=>{p.$refs.portalForm.validate(async o=>{if(o)try{let e;L.value==="add"?(e=await p.$api.portalAdd(s),e.status===201?(r.success("添加成功"),z.value=!1,v(i)):r.error("添加失败: "+JSON.stringify(e.data))):(e=await p.$api.portalUpdate(s),e.status===200?(r.success("更新成功"),z.value=!1,v(i)):r.error("更新失败: "+JSON.stringify(e.data)))}catch(e){r.error("操作失败: "+e.message)}else r.error("请填写正确的表单信息")})},De=o=>{R.confirm(`确定要删除门户 "${o.name}" 吗？`,"确认删除",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{(await p.$api.portalDel(o.id)).status===204?(r.success("删除成功"),v(i)):r.error("删除失败")}catch(e){r.error("删除失败: "+e.message)}}).catch(()=>{r.info("已取消删除")})},Te=()=>{if(T.value.length===0){r.warning("请至少选择一项");return}R.confirm(`确定要删除选中的 ${T.value.length} 项吗？`,"确认删除",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const o=T.value.map(n=>n.id);(await p.$api.portalMuldel({pks:o})).status===204?(r.success("删除成功"),v(i)):r.error("删除失败")}catch(o){r.error("删除失败: "+o.message)}}).catch(()=>{r.info("已取消删除")})},Pe=()=>{H.value=!0},Be=()=>{U.value=!0,J.value="add",S.group=""},Fe=o=>{U.value=!0,J.value="edit",p.$nextTick(()=>{Object.assign(S,o)})},Me=()=>{p.$refs.pgroupForm.validate(async o=>{if(o)try{let e;J.value==="add"?(e=await p.$api.pgroupAdd(S),e.status===201?(r.success("添加成功"),U.value=!1,P()):r.error("添加失败: "+JSON.stringify(e.data))):(e=await p.$api.pgroupUpdate(S),e.status===200?(r.success("更新成功"),U.value=!1,P()):r.error("更新失败: "+JSON.stringify(e.data)))}catch(e){r.error("操作失败: "+e.message)}else r.error("请输入正确的分组名称")})},Oe=o=>{R.confirm(`确定要删除分组 "${o.group}" 吗？`,"确认删除",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{(await p.$api.pgroupDel(o.id)).status===204?(r.success("删除成功"),P()):r.error("删除失败")}catch(e){r.error("删除失败: "+e.message)}}).catch(()=>{r.info("已取消删除")})},Ne=()=>{if(O.value.length===0){r.warning("请至少选择一项");return}R.confirm(`确定要删除选中的 ${O.value.length} 个分组吗？`,"确认删除",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const o=O.value.map(n=>n.id);(await p.$api.pgroupMuldel({pks:o})).status===204?(r.success("删除成功"),P()):r.error("删除失败")}catch(o){r.error("删除失败: "+o.message)}}).catch(()=>{r.info("已取消删除")})},je=async o=>{try{(await p.$api.portalUpdate({status:o.status,id:o.id})).status===200?r.success("状态更新成功"):r.error("状态更新失败")}catch(e){r.error("状态更新失败: "+e.message)}},Ee=async()=>{try{const o=await p.$api.portalDataExport()}catch(o){r.error("导出失败: "+o.message)}},ne=async()=>{try{const o=await p.$api.portalTemplateExport()}catch(o){r.error("模板导出失败: "+o.message)}},qe=o=>{const e=["xlsx"],n=o.name;if(o.type!==""||o.type!==null||o.type!==void 0){const _=o.name.replace(/.+\./,"").toLowerCase();return o.size/1024/1024<5?e.includes(_)?oe.value.find(y=>y.name===n&&y.lastModified===o.lastModified)?(r.error("该文件已上传！"),!1):!0:(r.error(`不能上传${_}类型的文件`),!1):(r.error("上传文件大小不能超过 5MB!"),!1)}},Ae=async o=>{const e=new FormData;e.append("file",o.file);try{const n=await p.$api.importPortalData(e,re,12e4);n.status===200?(r.success(`导入成功: ${JSON.stringify(n.data)}`),v(i),P()):r.error(`导入异常: ${JSON.stringify(n.data)}`)}catch(n){r.error(`导入失败: ${n.message}`)}};return Ze(async()=>{await Promise.all([P(),v(i)])}),(o,e)=>{var me,ce,fe;const n=u("el-button"),_=u("el-dropdown-item"),se=u("el-dropdown-menu"),ue=u("el-dropdown"),y=u("el-input"),B=u("el-option"),I=u("el-select"),g=u("el-table-column"),ie=u("el-tag"),Y=u("el-switch"),de=u("el-table"),Le=u("el-pagination"),c=u("el-form-item"),V=u("el-row"),pe=u("el-form"),G=u("el-dialog"),w=u("el-col"),Je=u("el-input-number"),Ie=u("upload-filled"),Ge=u("el-icon"),Re=u("el-upload"),D=_e("permission"),Ke=_e("loading");return f(),E(ee,null,[b("div",ol,[b("div",rl,[b("div",nl,[C((f(),$(n,{type:"primary",size:"small",onClick:ke},{default:t(()=>[...e[23]||(e[23]=[d("新增",-1)])]),_:1})),[[D,`${(me=h(k).name)==null?void 0:me.replace("_info","")}:add`]]),C((f(),$(n,{type:"primary",size:"small",onClick:Pe},{default:t(()=>[...e[24]||(e[24]=[d("新增分组",-1)])]),_:1})),[[D,`${(ce=h(k).name)==null?void 0:ce.replace("_info","")}:add`]]),C((f(),$(n,{disabled:T.value.length===0,type:"danger",size:"small",onClick:Te},{default:t(()=>[...e[25]||(e[25]=[d("批量删除",-1)])]),_:1},8,["disabled"])),[[D,`${(fe=h(k).name)==null?void 0:fe.replace("_info","")}:delete`]]),l(ue,{size:"small","split-button":"",type:"primary",style:{"margin-left":"15px","margin-right":"15px"}},{dropdown:t(()=>[l(se,null,{default:t(()=>[l(_,{onClick:Ee},{default:t(()=>[...e[26]||(e[26]=[d("全部导出",-1)])]),_:1}),l(_,{onClick:e[0]||(e[0]=a=>Q.value=!0)},{default:t(()=>[...e[27]||(e[27]=[d("批量导入",-1)])]),_:1}),l(_,{onClick:ne},{default:t(()=>[...e[28]||(e[28]=[d("模版下载",-1)])]),_:1})]),_:1})]),default:t(()=>[e[29]||(e[29]=d(" 更多操作 ",-1))]),_:1})]),b("div",sl,[l(y,{modelValue:q.value,"onUpdate:modelValue":e[1]||(e[1]=a=>q.value=a),placeholder:"输入名称、链接或描述",clearable:"",onClear:W,onKeyup:ll(W,["enter"]),style:{width:"200px","margin-right":"10px"}},{append:t(()=>[l(n,{icon:h(el),onClick:W},null,8,["icon"])]),_:1},8,["modelValue"]),l(I,{modelValue:F.value,"onUpdate:modelValue":e[2]||(e[2]=a=>F.value=a),placeholder:"选择分组",clearable:"",onChange:X,style:{width:"150px","margin-right":"10px"}},{default:t(()=>[(f(!0),E(ee,null,ve(A.value,a=>(f(),$(B,{key:a.id,label:a.group,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),l(I,{modelValue:M.value,"onUpdate:modelValue":e[3]||(e[3]=a=>M.value=a),placeholder:"共享类型",clearable:"",onChange:X,style:{width:"120px","margin-right":"10px"}},{default:t(()=>[l(B,{label:"公共",value:"public"}),l(B,{label:"私人",value:"private"})]),_:1},8,["modelValue"]),l(n,{onClick:he},{default:t(()=>[...e[30]||(e[30]=[d("重置",-1)])]),_:1})])]),C((f(),$(de,{border:"",data:te.value,style:{width:"100%",flex:"1"},"max-height":"100%",onSelectionChange:Ce},{default:t(()=>[l(g,{type:"selection",width:"55"}),l(g,{prop:"name",label:"名称","min-width":"120"}),l(g,{prop:"url",label:"链接地址","min-width":"180"}),l(g,{prop:"group_name",label:"分组","min-width":"100"},{default:t(a=>[l(ie,null,{default:t(()=>[d(le(a.row.group_name),1)]),_:2},1024)]),_:1}),l(g,{prop:"sharing_type",label:"共享类型","min-width":"80"},{default:t(a=>[l(ie,{type:a.row.sharing_type==="public"?"success":"warning"},{default:t(()=>[d(le(a.row.sharing_type==="public"?"公共":"私人"),1)]),_:2},1032,["type"])]),_:1}),l(g,{prop:"owner_name",label:"所有者","min-width":"100"},{default:t(a=>[a.row.owner_name?(f(),E("span",ul,le(a.row.owner_name),1)):(f(),E("span",il,"-"))]),_:1}),l(g,{prop:"status",label:"状态",width:"80"},{default:t(a=>[l(Y,{modelValue:a.row.status,"onUpdate:modelValue":x=>a.row.status=x,class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},onChange:x=>je(a.row)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),l(g,{prop:"sort",label:"排序",width:"80"}),l(g,{fixed:"right",label:"操作",width:"150"},{default:t(a=>{var x,N;return[C((f(),$(n,{type:"primary",size:"small",onClick:Z=>Ue(a.row)},{default:t(()=>[...e[31]||(e[31]=[d(" 编辑 ",-1)])]),_:1},8,["onClick"])),[[D,`${(x=h(k).name)==null?void 0:x.replace("_info","")}:edit`]]),C((f(),$(n,{type:"danger",size:"small",onClick:Z=>De(a.row)},{default:t(()=>[...e[32]||(e[32]=[d(" 删除 ",-1)])]),_:1},8,["onClick"])),[[D,`${(N=h(k).name)==null?void 0:N.replace("_info","")}:delete`]])]}),_:1})]),_:1},8,["data"])),[[Ke,K.value]]),l(Le,{"current-page":i.page,"onUpdate:currentPage":e[4]||(e[4]=a=>i.page=a),"page-size":i.page_size,"onUpdate:pageSize":e[5]||(e[5]=a=>i.page_size=a),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:ae.value,style:{"margin-top":"15px","justify-content":"flex-end"},onSizeChange:Ve,onCurrentChange:xe},null,8,["current-page","page-size","total"])]),l(G,{modelValue:H.value,"onUpdate:modelValue":e[9]||(e[9]=a=>H.value=a),title:"编辑分组",width:"50%"},{footer:t(()=>[l(G,{modelValue:U.value,"onUpdate:modelValue":e[8]||(e[8]=a=>U.value=a),width:"30%",title:J.value==="add"?"新增分组":"编辑分组","append-to-body":""},{default:t(()=>[l(pe,{inline:!0,model:S,class:"demo-form-inline","label-position":"right","label-width":"80px",ref:"pgroupForm","status-icon":""},{default:t(()=>[l(c,{label:"分组名称",prop:"group",rules:[{required:!0,message:"请输入分组名称",trigger:"blur"}]},{default:t(()=>[l(y,{modelValue:S.group,"onUpdate:modelValue":e[6]||(e[6]=a=>S.group=a),placeholder:"请输入分组名称",clearable:""},null,8,["modelValue"])]),_:1}),l(V,{style:{"justify-content":"space-around"}},{default:t(()=>[l(c,null,{default:t(()=>[l(n,{onClick:e[7]||(e[7]=a=>U.value=!1)},{default:t(()=>[...e[33]||(e[33]=[d("取消",-1)])]),_:1}),l(n,{type:"primary",onClick:Me},{default:t(()=>[...e[34]||(e[34]=[d(" 确定",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])]),default:t(()=>[b("div",dl,[b("div",pl,[l(n,{type:"primary",size:"small",onClick:Be},{default:t(()=>[...e[35]||(e[35]=[d("新增",-1)])]),_:1}),l(n,{disabled:O.value.length===0,type:"danger",size:"small",onClick:Ne},{default:t(()=>[...e[36]||(e[36]=[d("批量删除",-1)])]),_:1},8,["disabled"])]),l(de,{data:A.value,"default-sort":{prop:"id",order:"ascending"},onSelectionChange:$e,border:""},{default:t(()=>[l(g,{type:"selection",width:"55"}),l(g,{prop:"group",label:"分组名",sortable:""}),l(g,{fixed:"right",label:"操作",width:"120"},{default:t(a=>{var x,N;return[C(l(n,{type:"primary",size:"small",link:"",icon:h(tl),onClick:Z=>Fe(a.row)},null,8,["icon","onClick"]),[[D,`${(x=h(k).name)==null?void 0:x.replace("_info","")}:edit`]]),C(l(n,{type:"danger",link:"",size:"small",icon:h(al),onClick:Z=>Oe(a.row)},null,8,["icon","onClick"]),[[D,`${(N=h(k).name)==null?void 0:N.replace("_info","")}:delete`]])]}),_:1})]),_:1},8,["data"])])]),_:1},8,["modelValue"]),l(G,{modelValue:z.value,"onUpdate:modelValue":e[20]||(e[20]=a=>z.value=a),title:L.value=="add"?"新增链接":"编辑链接",width:"600px"},{default:t(()=>[l(pe,{model:s,class:"portal-form","label-position":"right","label-width":"80px",ref:"portalForm","status-icon":""},{default:t(()=>[l(V,{gutter:20},{default:t(()=>[l(w,{span:12},{default:t(()=>[l(c,{label:"名称",prop:"name",rules:[{required:!0,message:"请输入名称",trigger:"blur"}]},{default:t(()=>[l(y,{modelValue:s.name,"onUpdate:modelValue":e[10]||(e[10]=a=>s.name=a),placeholder:"请输入名称",clearable:""},null,8,["modelValue"])]),_:1})]),_:1}),l(w,{span:12},{default:t(()=>[l(c,{label:"链接地址",prop:"url",rules:[{required:!0,message:"请输入链接地址",trigger:"blur"}]},{default:t(()=>[l(y,{modelValue:s.url,"onUpdate:modelValue":e[11]||(e[11]=a=>s.url=a),placeholder:"请输入链接地址",clearable:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(V,{gutter:20},{default:t(()=>[l(w,{span:12},{default:t(()=>[l(c,{label:"分组",prop:"group",rules:[{required:!0,message:"请选择分组",trigger:"change"}]},{default:t(()=>[l(I,{modelValue:s.group,"onUpdate:modelValue":e[12]||(e[12]=a=>s.group=a),filterable:"",placeholder:"请选择分组",style:{width:"100%"}},{default:t(()=>[(f(!0),E(ee,null,ve(A.value,a=>(f(),$(B,{key:a.id,label:a.group,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(w,{span:12},{default:t(()=>[l(c,{label:"共享类型",prop:"sharing_type",rules:[{required:!0,message:"请选择共享类型",trigger:"change"}]},{default:t(()=>[l(I,{modelValue:s.sharing_type,"onUpdate:modelValue":e[13]||(e[13]=a=>s.sharing_type=a),placeholder:"请选择共享类型",style:{width:"100%"}},{default:t(()=>[l(B,{label:"公共",value:"public"}),l(B,{label:"私人",value:"private"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(V,{gutter:20},{default:t(()=>[l(w,{span:12},{default:t(()=>[l(c,{label:"用户名",prop:"username"},{default:t(()=>[l(y,{modelValue:s.username,"onUpdate:modelValue":e[14]||(e[14]=a=>s.username=a),placeholder:"请输入用户名",clearable:""},null,8,["modelValue"])]),_:1})]),_:1}),l(w,{span:12},{default:t(()=>[l(c,{label:"密码",prop:"password"},{default:t(()=>[l(y,{modelValue:s.password,"onUpdate:modelValue":e[15]||(e[15]=a=>s.password=a),placeholder:"请输入密码",clearable:"","show-password":""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(V,{gutter:20},{default:t(()=>[l(w,{span:12},{default:t(()=>[l(c,{label:"排序",prop:"sort"},{default:t(()=>[l(Je,{modelValue:s.sort,"onUpdate:modelValue":e[16]||(e[16]=a=>s.sort=a),"controls-position":"right",min:0,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),l(w,{span:12},{default:t(()=>[l(c,{label:"跳转方式",prop:"target"},{default:t(()=>[l(Y,{modelValue:s.target,"onUpdate:modelValue":e[17]||(e[17]=a=>s.target=a),class:"ml-2","inline-prompt":"",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},"active-text":"新窗口","inactive-text":"当前窗口"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(V,{gutter:20},{default:t(()=>[l(w,{span:24},{default:t(()=>[l(c,{label:"描述",prop:"describe"},{default:t(()=>[l(y,{modelValue:s.describe,"onUpdate:modelValue":e[18]||(e[18]=a=>s.describe=a),placeholder:"请输入描述",clearable:"",type:"textarea",autosize:{minRows:2,maxRows:4}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(V,{gutter:20},{default:t(()=>[l(w,{span:12},{default:t(()=>[l(c,{label:"状态",prop:"status"},{default:t(()=>[l(Y,{modelValue:s.status,"onUpdate:modelValue":e[19]||(e[19]=a=>s.status=a),class:"ml-2","inline-prompt":"",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},"active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(V,{style:{"justify-content":"flex-end","margin-top":"20px"}},{default:t(()=>[l(c,null,{default:t(()=>[l(n,{onClick:ze},{default:t(()=>[...e[37]||(e[37]=[d("取消",-1)])]),_:1}),l(n,{type:"primary",onClick:Se},{default:t(()=>[...e[38]||(e[38]=[d(" 确定",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(G,{modelValue:Q.value,"onUpdate:modelValue":e[22]||(e[22]=a=>Q.value=a),title:"导入",width:"600px"},{default:t(()=>[l(Re,{class:"upload-demo",drag:"",action:"",ref_key:"refUpload",ref:we,headers:re,"http-request":Ae,"file-list":oe.value,"before-upload":qe,limit:be.value,"show-file-list":""},{tip:t(()=>[b("div",ml,[e[40]||(e[40]=b("div",null,"只支持从此系统下载的模板导入，请按下方按钮下载模板!",-1)),l(n,{link:"",type:"primary",onClick:e[21]||(e[21]=a=>ne())},{default:t(()=>[...e[39]||(e[39]=[d(" 下载模板 ",-1)])]),_:1})])]),default:t(()=>[l(Ge,{class:"el-icon--upload"},{default:t(()=>[l(Ie)]),_:1}),e[41]||(e[41]=b("div",{class:"el-upload__text"},[d("拖拽文件到此或者 "),b("em",null,"点击上传文件")],-1))]),_:1},8,["headers","file-list","limit"])]),_:1},8,["modelValue"])],64)}}}),_l=He(cl,[["__scopeId","data-v-3c008846"]]);export{_l as default};
