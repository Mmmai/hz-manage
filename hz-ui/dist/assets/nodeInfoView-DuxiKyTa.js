import{d as _e,g as me,x as fe,j as ve,r as p,z as ge,b_ as m,h as d,bc as Z,c as y,o as _,f as s,w as a,b as c,q as o,t as n,B as w,bV as I,m as b,cx as ye,cy as be,c8 as ke,k as U,F as xe,i as he,l as we,_ as Ce}from"./index-D37lWo2y.js";import{A as Te}from"./ansi_up-SVqyao32.js";const Ne={class:"node-detail-view"},Se={key:1},Ve={class:"card-header"},$e={class:"header-actions"},Ie={class:"task-item-header"},ze={key:0,style:{flex:"1"}},Me={class:"task-detail-dialog"},De={class:"error-message"},Je=["innerHTML"],Oe={key:1,class:"no-output"},Ae={class:"dialog-footer"},Be=_e({__name:"nodeInfoView",setup(Ue){const{proxy:k}=me(),q=new Te,v=fe(),G=ve(),z=p(""),r=p({id:"",model_instance_name:"",ip_address:"",model_name:"",proxy_name:"",enable_sync:!0,manage_status:2,agent_status:2}),M=p([]),C=p(!1),g=p(1),T=p(10),H=p(0),N=p(""),S=p(!1),i=p({id:"",created_at:"",completed_at:"",status:2,cost_time:0,error_message:"",results:"",asset_info:null}),L=p("overview"),Q=e=>{if(!e)return"";try{let t="";return typeof e=="string"?t=JSON.parse(e):typeof e=="object"&&(e.stdout?t=e.stdout:e.results?t=typeof e.results=="string"?e.results:JSON.stringify(e.results,null,2):t=JSON.stringify(e,null,2)),q.ansi_to_html(t)}catch(t){return console.error("Failed to process ANSI codes:",t),ne(e)}};ge(()=>{z.value=v.params.nodeId?v.params.nodeId:v.path.split("/").at(-1),X(),V()});const W=()=>{G.push({path:"/node_control/nodeManage"})},X=async()=>{try{const e=await k.$api.getNodeDetail(z.value);e.status===200&&(r.value=e.data)}catch{m.error("获取节点信息失败")}},V=async()=>{C.value=!0;try{const e={node_id:z.value,page:g.value,page_size:T.value};N.value&&(e.task_name=N.value);const t=await k.$api.getNodeInfoTasks(e);t.status===200&&(M.value=t.data.results,H.value=t.data.count)}catch{m.error("获取任务历史失败")}finally{C.value=!1}},Y=async e=>{let t=await k.$api.syncZabbixHost({node_id:e.id});t.status==200?m({type:"success",message:"触发成功"}):m({type:"error",message:`触发失败:${t.data.message}`})},ee=async e=>{let t=await k.$api.installAgent(e);t.status==200?m({type:"success",message:"触发成功"}):m({type:"error",message:`触发失败:${t.data.message}`})},te=async e=>{let t=await k.$api.get_inventory(e);t.status==200?m({type:"success",message:"触发成功"}):m({type:"error",message:`触发失败:${t.data.message}`})},D=()=>{g.value=1,V()},ae=e=>{i.value={id:e.id,created_at:e.created_at,completed_at:e.completed_at,status:e.status,cost_time:e.cost_time,error_message:e.error_message,results:e.results,record_info:e.record_info,task_name:e.task_name},S.value=!0},se=e=>{T.value=e,g.value=1,V()},le=e=>{g.value=e,V()},j=e=>e===1?"success":e===0?"danger":"info",F=e=>e===1?"正常":e===0?"异常":"未知",J=e=>({0:"danger",1:"success",2:"info"})[e]||"info",P=e=>({0:"失败",1:"成功",2:"未知"})[e]||"未知",O=e=>e?new Date(e).toLocaleString("zh-CN"):"未知",ne=e=>{if(!e)return"";try{if(typeof e=="string"){const t=JSON.parse(e);return JSON.stringify(t,null,2)}return JSON.stringify(e,null,2)}catch{return typeof e=="string"?e:JSON.stringify(e,null,2)}};return(e,t)=>{const oe=d("el-page-header"),x=d("el-card"),u=d("el-descriptions-item"),f=d("el-tag"),h=d("el-button"),$=d("el-tooltip"),E=d("el-descriptions"),re=d("el-input"),K=d("el-timeline-item"),ue=d("el-timeline"),ie=d("el-pagination"),R=d("el-tab-pane"),de=d("el-tabs"),ce=d("el-dialog"),A=Z("permission"),pe=Z("loading");return _(),y("div",Ne,[s(x,{class:"breadcrumb-card"},{default:a(()=>[s(oe,{onBack:W},{content:a(()=>[...t[9]||(t[9]=[c("span",null," 节点详情",-1)])]),_:1})]),_:1}),s(x,{class:"node-info-card"},{header:a(()=>[...t[10]||(t[10]=[c("div",{class:"card-header"},[c("span",null,"节点基本信息")],-1)])]),default:a(()=>[s(E,{column:2,border:""},{default:a(()=>[s(u,{label:"实例名称"},{default:a(()=>[o(n(r.value.model_instance_name),1)]),_:1}),s(u,{label:"IP地址"},{default:a(()=>[o(n(r.value.ip_address),1)]),_:1}),s(u,{label:"模型"},{default:a(()=>[o(n(r.value.model_name),1)]),_:1}),s(u,{label:"代理"},{default:a(()=>[r.value.proxy_name?(_(),w(f,{key:0},{default:a(()=>[o(n(r.value.proxy_name),1)]),_:1})):(_(),y("span",Se,"无"))]),_:1}),s(u,{label:"同步状态"},{default:a(()=>[s(f,{type:r.value.enable_sync?"success":"danger"},{default:a(()=>[o(n(r.value.enable_sync?"启用":"禁用"),1)]),_:1},8,["type"])]),_:1}),s(u,{label:"管理状态"},{default:a(()=>[s(f,{type:j(r.value.manage_status)},{default:a(()=>[o(n(F(r.value.manage_status)),1)]),_:1},8,["type"])]),_:1}),s(u,{label:"Agent状态"},{default:a(()=>[s(f,{type:j(r.value.agent_status)},{default:a(()=>[o(n(F(r.value.agent_status)),1)]),_:1},8,["type"])]),_:1}),s(u,{label:"操作"},{default:a(()=>[s($,{class:"box-item",effect:"dark",content:"触发同步",placement:"top"},{default:a(()=>{var l;return[I(s(h,{link:"",type:"primary",icon:b(ye),onClick:t[0]||(t[0]=B=>Y({id:r.value.id}))},null,8,["icon"]),[[A,`${(l=b(v).name)==null?void 0:l.replace("_info","")}:edit`]])]}),_:1}),s($,{class:"box-item",effect:"dark",content:"管理状态更新",placement:"top"},{default:a(()=>{var l;return[I(s(h,{link:"",type:"primary",icon:b(be),onClick:t[1]||(t[1]=B=>te({id:r.value.id}))},null,8,["icon"]),[[A,`${(l=b(v).name)==null?void 0:l.replace("_info","")}:edit`]])]}),_:1}),s($,{class:"box-item",effect:"dark",content:"触发agent安装",placement:"top"},{default:a(()=>{var l;return[I(s(h,{link:"",type:"primary",icon:b(ke),onClick:t[2]||(t[2]=B=>ee({id:r.value.id}))},null,8,["icon"]),[[A,`${(l=b(v).name)==null?void 0:l.replace("_info","")}:edit`]])]}),_:1})]),_:1})]),_:1})]),_:1}),s(x,{class:"task-history-card"},{header:a(()=>[c("div",Ve,[t[12]||(t[12]=c("span",null,"任务执行历史",-1)),c("div",$e,[s(re,{modelValue:N.value,"onUpdate:modelValue":t[3]||(t[3]=l=>N.value=l),placeholder:"按任务名过滤",clearable:"",style:{width:"200px","margin-right":"10px"},onClear:D,onKeyup:we(D,["enter"])},null,8,["modelValue"]),s(h,{type:"primary",onClick:D},{default:a(()=>[...t[11]||(t[11]=[o("刷新",-1)])]),_:1})])])]),default:a(()=>[I((_(),w(ue,null,{default:a(()=>[(_(!0),y(xe,null,he(M.value,l=>(_(),w(K,{key:l.id,type:J(l.status),timestamp:O(l.created_at),placement:"top"},{default:a(()=>[s(x,{shadow:"hover",onClick:B=>ae(l)},{default:a(()=>[s($,{content:"点击查看任务详情",placement:"top"},{default:a(()=>[c("div",Ie,[s(f,{type:"primary",size:"small"},{default:a(()=>[o(n(l.task_name),1)]),_:2},1024),s(f,{type:J(l.status),size:"small"},{default:a(()=>[o(n(P(l.status)),1)]),_:2},1032,["type"]),c("span",null,"耗时: "+n(l.cost_time)+" 秒",1),l.error_message?(_(),y("span",ze,"错误信息: "+n(l.error_message),1)):U("",!0)])]),_:2},1024)]),_:2},1032,["onClick"])]),_:2},1032,["type","timestamp"]))),128)),M.value.length===0&&!C.value?(_(),w(K,{key:0},{default:a(()=>[s(x,null,{default:a(()=>[...t[13]||(t[13]=[c("div",{class:"empty-task"},"暂无任务执行历史",-1)])]),_:1})]),_:1})):U("",!0)]),_:1})),[[pe,C.value]]),s(ie,{"current-page":g.value,"onUpdate:currentPage":t[4]||(t[4]=l=>g.value=l),"page-size":T.value,"onUpdate:pageSize":t[5]||(t[5]=l=>T.value=l),"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",total:H.value,onSizeChange:se,onCurrentChange:le,style:{"margin-top":"20px","justify-content":"flex-end",display:"flex"}},null,8,["current-page","page-size","total"])]),_:1}),s(ce,{modelValue:S.value,"onUpdate:modelValue":t[8]||(t[8]=l=>S.value=l),title:"任务执行详情",width:"70%",top:"5vh"},{footer:a(()=>[c("span",Ae,[s(h,{onClick:t[7]||(t[7]=l=>S.value=!1)},{default:a(()=>[...t[14]||(t[14]=[o("关闭",-1)])]),_:1})])]),default:a(()=>[c("div",Me,[s(de,{modelValue:L.value,"onUpdate:modelValue":t[6]||(t[6]=l=>L.value=l)},{default:a(()=>[s(R,{label:"概览",name:"overview"},{default:a(()=>[s(E,{column:1,border:""},{default:a(()=>[s(u,{label:"任务ID"},{default:a(()=>[o(n(i.value.id),1)]),_:1}),s(u,{label:"任务名称"},{default:a(()=>[o(n(i.value.task_name),1)]),_:1}),s(u,{label:"执行时间"},{default:a(()=>[o(n(O(i.value.created_at)),1)]),_:1}),s(u,{label:"完成时间"},{default:a(()=>[o(n(i.value.completed_at?O(i.value.completed_at):"未完成"),1)]),_:1}),s(u,{label:"状态"},{default:a(()=>[s(f,{type:J(i.value.status)},{default:a(()=>[o(n(P(i.value.status)),1)]),_:1},8,["type"])]),_:1}),s(u,{label:"耗时"},{default:a(()=>[o(n(i.value.cost_time?i.value.cost_time+" 秒":"未知"),1)]),_:1}),i.value.error_message?(_(),w(u,{key:0,label:"错误信息"},{default:a(()=>[c("div",De,n(i.value.error_message),1)]),_:1})):U("",!0)]),_:1})]),_:1}),s(R,{label:"详细输出",name:"output"},{default:a(()=>[i.value.results?(_(),y("pre",{key:0,class:"output-pre",innerHTML:Q(i.value.results)},null,8,Je)):(_(),y("div",Oe,"暂无详细输出"))]),_:1})]),_:1},8,["modelValue"])])]),_:1},8,["modelValue"])])}}}),je=Ce(Be,[["__scopeId","data-v-04586636"]]);export{je as default};
