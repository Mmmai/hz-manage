<<<<<<<< HEAD:hz-ui/dist/assets/lokiView-CBP_3Z8M.js
import{d as Ve,g as Le,a as P,r as i,bP as Y,bZ as ke,z as Ce,h as c,c as _,o as p,b as m,f as t,w as a,F as x,i as L,B as b,q as v,k as Te,t as U,m as F,cd as Se,cf as Ue,cv as Fe,bV as Ne,bM as $e,b_ as Q,_ as Re}from"./index-Cm0tF2Sj.js";import{n as Me}from"./nearLogCom-BAex6eiz.js";const Ee={style:{display:"flex","flex-direction":"column","justify-content":"space-between",width:"100%",gap:"10px"}},Oe={class:"card"},ze={style:{display:"flex"}},Ae={class:"card",style:{flex:"0.3"}},Ke={style:{float:"left"}},je={style:{float:"right",color:"var(--el-text-color-secondary)","font-size":"13px"}},Be={style:{float:"left"}},He={style:{float:"right",color:"var(--el-text-color-secondary)","font-size":"13px"}},Ge={class:"card"},qe={style:{display:"flex","justify-content":"space-between","align-items":"center"}},We=["innerHTML"],Pe={class:"operation_show"},Ye=Ve({name:"loki",__name:"lokiView",setup(Qe){const{proxy:g}=Le(),n=P({0:{labelName:"",matchMethod:"=",labelValue:"",isMultiple:!1,labelValueList:[],initLabelValueList:[]}}),u=P({dataSourceUrl:"",labelFilters:{},matchKey:"",matchKeyMethod:"|=",limit:200,dateValue:[]});i(!1);const E=i([]),Z=[{value:"=",label:"=",text:"等于"},{value:"=~",label:"=~",text:"包含(支持多个)"},{value:"!=",label:"!=",text:"不等于"},{value:"!~",label:"!~",text:"不包含(支持多个)"}],J=[{value:"|=",label:"=",text:"包含"},{value:"|~",label:"~",text:"正则匹配"},{value:"!=",label:"!=",text:"不包含"},{value:"!~",label:"!~",text:"反向正则"}],N=i({}),O=i(!1),z=i([]),k=i(!1),$=i([]),X=async()=>{k.value=!0,g.$refs.formRef.validate(async l=>{if(l){console.log(u);let e=await g.$api.lokiQuery(u);console.log(e.data),N.value=e.data,z.value=e.data.queryResult,$.value=e.data.queryLogLevel.map(r=>({text:r,value:r})),console.log($.value),z.value.length>>>1?O.value=!0:Q({showClose:!0,message:"无结果返回",type:"info"}),k.value=!1}else k.value=!1,Q({showClose:!0,message:"请输入正确内容.",type:"error"})})};new Date(new Date().getTime()-1*60*60*1e3),new Date(new Date().getTime()-2*60*60*1e3),new Date(new Date().getTime()-6*60*60*1e3),new Date(new Date().getTime()-12*60*60*1e3),new Date(new Date().getTime()-24*60*60*1e3),new Date(new Date().setHours(0,0,0,0)),new Date(new Date().setHours(23,59,59,999));const I=()=>{A.value=[{text:"Last 1 hours",value:[new Date(new Date().getTime()-1*60*60*1e3),new Date]},{text:"Last 2 hours",value:[new Date(new Date().getTime()-2*60*60*1e3),new Date]},{text:"Last 6 hours",value:[new Date(new Date().getTime()-6*60*60*1e3),new Date]},{text:"Last 12 hours",value:[new Date(new Date().getTime()-12*60*60*1e3),new Date]},{text:"Last 24 hours",value:[new Date(new Date().getTime()-24*60*60*1e3),new Date]},{text:"Today",value:[new Date(new Date().setHours(0,0,0,0)),new Date(new Date().setHours(23,59,59,999))]},{text:"Yesterday",value:()=>[new Date(new Date().getTime()-36e5),new Date]},{text:"A week ago",value:()=>{const l=new Date;return l.setDate(l.getDate()-7),[l.setDate(l.getDate()-7),new Date]}}]},A=i([]),ee=i(["=","!="]),K=l=>{n[l].labelValue=""};Y(()=>n,l=>{u.labelFilters=l},{deep:!0});const le=async l=>{if(!l)return;let e=await g.$api.lokiLabelGet({url:u.dataSourceUrl});console.log(e),E.value=e.data.data},w=i(""),te=async(l,e)=>{if(!e)return;w.value=l,console.log(w.value),n[l].labelValue="";let r=n[l];if(console.log(n),r.labelName!=""){let f=await g.$api.lokiLabelValueGet({url:u.dataSourceUrl,label:r.labelName});console.log(f),n[l].initLabelValueList=f.data.data}},C=i([]),ae=l=>{console.log(l.stream),C.value=[],Object.keys(l.stream).forEach(e=>{let r={};r.label=e,r.value=l.stream[e],C.value.push(r)}),console.log(C.value)},oe=l=>{Object.keys(n).includes(l.label)||(n[l.label]={labelName:l.label,matchMethod:"=",labelValue:l.value,isMultiple:!1,labelValueList:[]})},ne=(l,e)=>{let r=l.replace(/</g,"&lt;").replace(/>/g,"&gt;");if(e){const f=new RegExp(e,"gi");return r.replace(f,'<span style="background-color: #FFFF00;">$&</span>')}else return r},T=i(!1),se=ke.debounce(l=>{T.value=!0,l===""||l===void 0||l instanceof Object?(console.log(n),console.log(w.value),n[w.value].labelValueList=n[w.value].initLabelValueList,T.value=!1):(n[w.value].labelValueList=n[w.value].initLabelValueList.filter(e=>e.label.includes(l)),T.value=!1)},500),ue=(l,e)=>e.level===l,j=i("");Y(()=>u.matchKey,g.$commonFunc.debounceFunc(l=>{j.value=l}),{deep:!0});const re=l=>{Reflect.deleteProperty(n,l)},B=i(1),ie=()=>{B.value+=1,n[B.value]={labelName:"",matchMethod:"=",labelValue:"",isMultiple:!1,labelValueList:[]},console.log(n)},H=i(""),R=i(!1),de=l=>{R.value=!0,console.log(u),H.value.showNearLog(l)},ce=l=>{let e=[];l.forEach(f=>{e.push(`${f.logTime},${f.level},${f.logLine}
========
import{d as Ve,g as Le,a as P,r as i,bP as Y,bZ as ke,z as Ce,h as c,c as _,o as p,b as m,f as t,w as a,F as x,i as L,B as b,q as v,k as Te,t as U,m as F,cd as Se,cf as Ue,cv as Fe,bV as Ne,bM as $e,b_ as Q,_ as Re}from"./index-D37lWo2y.js";import{n as Me}from"./nearLogCom-BfdkbRAg.js";const Ee={style:{display:"flex","flex-direction":"column","justify-content":"space-between",width:"100%",gap:"10px"}},Oe={class:"card"},ze={style:{display:"flex"}},Ae={class:"card",style:{flex:"0.3"}},Ke={style:{float:"left"}},je={style:{float:"right",color:"var(--el-text-color-secondary)","font-size":"13px"}},Be={style:{float:"left"}},He={style:{float:"right",color:"var(--el-text-color-secondary)","font-size":"13px"}},Ge={class:"card"},qe={style:{display:"flex","justify-content":"space-between","align-items":"center"}},We=["innerHTML"],Pe={class:"operation_show"},Ye=Ve({name:"loki",__name:"lokiView",setup(Qe){const{proxy:g}=Le(),n=P({0:{labelName:"",matchMethod:"=",labelValue:"",isMultiple:!1,labelValueList:[],initLabelValueList:[]}}),u=P({dataSourceUrl:"",labelFilters:{},matchKey:"",matchKeyMethod:"|=",limit:200,dateValue:[]});i(!1);const E=i([]),Z=[{value:"=",label:"=",text:"等于"},{value:"=~",label:"=~",text:"包含(支持多个)"},{value:"!=",label:"!=",text:"不等于"},{value:"!~",label:"!~",text:"不包含(支持多个)"}],J=[{value:"|=",label:"=",text:"包含"},{value:"|~",label:"~",text:"正则匹配"},{value:"!=",label:"!=",text:"不包含"},{value:"!~",label:"!~",text:"反向正则"}],N=i({}),O=i(!1),z=i([]),k=i(!1),$=i([]),X=async()=>{k.value=!0,g.$refs.formRef.validate(async l=>{if(l){console.log(u);let e=await g.$api.lokiQuery(u);console.log(e.data),N.value=e.data,z.value=e.data.queryResult,$.value=e.data.queryLogLevel.map(r=>({text:r,value:r})),console.log($.value),z.value.length>>>1?O.value=!0:Q({showClose:!0,message:"无结果返回",type:"info"}),k.value=!1}else k.value=!1,Q({showClose:!0,message:"请输入正确内容.",type:"error"})})};new Date(new Date().getTime()-1*60*60*1e3),new Date(new Date().getTime()-2*60*60*1e3),new Date(new Date().getTime()-6*60*60*1e3),new Date(new Date().getTime()-12*60*60*1e3),new Date(new Date().getTime()-24*60*60*1e3),new Date(new Date().setHours(0,0,0,0)),new Date(new Date().setHours(23,59,59,999));const I=()=>{A.value=[{text:"Last 1 hours",value:[new Date(new Date().getTime()-1*60*60*1e3),new Date]},{text:"Last 2 hours",value:[new Date(new Date().getTime()-2*60*60*1e3),new Date]},{text:"Last 6 hours",value:[new Date(new Date().getTime()-6*60*60*1e3),new Date]},{text:"Last 12 hours",value:[new Date(new Date().getTime()-12*60*60*1e3),new Date]},{text:"Last 24 hours",value:[new Date(new Date().getTime()-24*60*60*1e3),new Date]},{text:"Today",value:[new Date(new Date().setHours(0,0,0,0)),new Date(new Date().setHours(23,59,59,999))]},{text:"Yesterday",value:()=>[new Date(new Date().getTime()-36e5),new Date]},{text:"A week ago",value:()=>{const l=new Date;return l.setDate(l.getDate()-7),[l.setDate(l.getDate()-7),new Date]}}]},A=i([]),ee=i(["=","!="]),K=l=>{n[l].labelValue=""};Y(()=>n,l=>{u.labelFilters=l},{deep:!0});const le=async l=>{if(!l)return;let e=await g.$api.lokiLabelGet({url:u.dataSourceUrl});console.log(e),E.value=e.data.data},w=i(""),te=async(l,e)=>{if(!e)return;w.value=l,console.log(w.value),n[l].labelValue="";let r=n[l];if(console.log(n),r.labelName!=""){let f=await g.$api.lokiLabelValueGet({url:u.dataSourceUrl,label:r.labelName});console.log(f),n[l].initLabelValueList=f.data.data}},C=i([]),ae=l=>{console.log(l.stream),C.value=[],Object.keys(l.stream).forEach(e=>{let r={};r.label=e,r.value=l.stream[e],C.value.push(r)}),console.log(C.value)},oe=l=>{Object.keys(n).includes(l.label)||(n[l.label]={labelName:l.label,matchMethod:"=",labelValue:l.value,isMultiple:!1,labelValueList:[]})},ne=(l,e)=>{let r=l.replace(/</g,"&lt;").replace(/>/g,"&gt;");if(e){const f=new RegExp(e,"gi");return r.replace(f,'<span style="background-color: #FFFF00;">$&</span>')}else return r},T=i(!1),se=ke.debounce(l=>{T.value=!0,l===""||l===void 0||l instanceof Object?(console.log(n),console.log(w.value),n[w.value].labelValueList=n[w.value].initLabelValueList,T.value=!1):(n[w.value].labelValueList=n[w.value].initLabelValueList.filter(e=>e.label.includes(l)),T.value=!1)},500),ue=(l,e)=>e.level===l,j=i("");Y(()=>u.matchKey,g.$commonFunc.debounceFunc(l=>{j.value=l}),{deep:!0});const re=l=>{Reflect.deleteProperty(n,l)},B=i(1),ie=()=>{B.value+=1,n[B.value]={labelName:"",matchMethod:"=",labelValue:"",isMultiple:!1,labelValueList:[]},console.log(n)},H=i(""),R=i(!1),de=l=>{R.value=!0,console.log(u),H.value.showNearLog(l)},ce=l=>{let e=[];l.forEach(f=>{e.push(`${f.logTime},${f.level},${f.logLine}
>>>>>>>> hz-manager/cmdb_permission:hz-ui/dist/assets/lokiView-DEGYAYc6.js
`)});let r=g.$commonFunc.getCurrentTimeString("-","-","_",":",":");console.log(r),g.$commonFunc.downloadArray(`export-log-${r}`,e)},pe=i([]),M=i([]),fe=async()=>{let l=await g.$api.dataSourceGet({page:1,page_size:1e3});pe.value=l.data.results,l.data.results.forEach(e=>{e.source_type=="loki"&&(e.isUsed?M.value.push({label:e.source_name,value:e.url,disabled:!1}):M.value.push({label:e.source_name,value:e.url,disabled:!0}),e.isDefault&&(u.dataSourceUrl=e.url))})};i(100),i(!1),i([]);const me=()=>{window.location.reload()};return Ce(async()=>{console.log("in loki mounted"),await fe()}),(l,e)=>{const r=c("el-option"),f=c("el-select"),D=c("el-form-item"),S=c("el-col"),ve=c("el-date-picker"),h=c("el-button"),G=c("el-row"),be=c("el-space"),ge=c("el-input-number"),_e=c("el-input"),we=c("el-form"),y=c("el-table-column"),q=c("el-table"),V=c("el-tag"),he=c("el-text"),ye=c("Top"),xe=c("el-icon"),De=c("el-backtop");return p(),_(x,null,[m("div",Ee,[t(we,{inline:!0,model:u,ref:"formRef"},{default:a(()=>[m("div",Oe,[t(G,{justify:"space-between"},{default:a(()=>[t(S,{span:6},{default:a(()=>[t(D,{label:"数据源",style:{"margin-bottom":"0px"},rules:[{required:!0}]},{default:a(()=>[t(f,{modelValue:u.dataSourceUrl,"onUpdate:modelValue":e[0]||(e[0]=o=>u.dataSourceUrl=o),placeholder:"Select",size:"default",style:{width:"180px"}},{default:a(()=>[(p(!0),_(x,null,L(M.value,(o,d)=>(p(),b(r,{key:d,label:o.label,value:o.value,disabled:o.disabled},null,8,["label","value","disabled"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),t(S,{span:14,style:{"white-space":"nowrap"}},{default:a(()=>[m("div",ze,[t(D,{label:"时间范围",prop:"dateValue",rules:[{required:!0}],style:{"margin-bottom":"0px"}},{default:a(()=>[t(ve,{modelValue:u.dateValue,"onUpdate:modelValue":e[1]||(e[1]=o=>u.dateValue=o),type:"datetimerange",shortcuts:A.value,"range-separator":"To","start-placeholder":"Start date","end-placeholder":"End date","value-format":"x",onVisibleChange:e[2]||(e[2]=o=>I())},null,8,["modelValue","shortcuts"])]),_:1}),t(h,{type:"primary",size:"default",loading:k.value,onClick:X},{default:a(()=>[...e[8]||(e[8]=[v("检索",-1)])]),_:1},8,["loading"]),t(h,{type:"primary",size:"default",onClick:me},{default:a(()=>[...e[9]||(e[9]=[v("重置",-1)])]),_:1})])]),_:1})]),_:1})]),m("div",Ae,[t(be,null,{default:a(()=>[t(D,{label:"过滤器",prop:"labelValue"},{default:a(()=>[(p(!0),_(x,null,L(n,(o,d,W)=>(p(),_("div",{key:W},[t(f,{modelValue:n[d].labelName,"onUpdate:modelValue":s=>n[d].labelName=s,filterable:"",clearable:"",placeholder:"标签",style:{width:"120px"},onVisibleChange:le,onChange:s=>K(d)},{default:a(()=>[(p(!0),_(x,null,L(E.value,s=>(p(),b(r,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),t(f,{modelValue:n[d].matchMethod,"onUpdate:modelValue":s=>n[d].matchMethod=s,style:{width:"65px"},onChange:s=>K(d)},{default:a(()=>[(p(),_(x,null,L(Z,s=>t(r,{key:s.value,label:s.label,value:s.value},{default:a(()=>[m("span",Ke,U(s.label),1),m("span",je,U(s.text),1)]),_:2},1032,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),t(f,{filterable:"",clearable:"","reserve-keyword":"",loading:T.value,"remote-show-suffix":"",modelValue:n[d].labelValue,"onUpdate:modelValue":s=>n[d].labelValue=s,multiple:!ee.value.includes(n[d].matchMethod),style:{width:"240px"},remote:"",onVisibleChange:s=>te(d,s),"remote-method":F(se)},{default:a(()=>[(p(!0),_(x,null,L(n[d].labelValueList,s=>(p(),b(r,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:2},1032,["loading","modelValue","onUpdate:modelValue","multiple","onVisibleChange","remote-method"]),Object.keys(n).length>>1?(p(),b(h,{key:0,size:"small",icon:F(Se),circle:"",style:{margin:"0 5px 0px 5px"},onClick:s=>re(d)},null,8,["icon","onClick"])):Te("",!0)]))),128)),t(h,{type:"primary",icon:F(Ue),circle:"",size:"small",style:{margin:"0 5px 0px 5px"},onClick:ie},null,8,["icon"])]),_:1})]),_:1}),t(G,null,{default:a(()=>[t(S,{span:4},{default:a(()=>[t(D,{label:"条数"},{default:a(()=>[t(ge,{modelValue:u.limit,"onUpdate:modelValue":e[3]||(e[3]=o=>u.limit=o),step:100,min:1,max:5e3,width:"20"},null,8,["modelValue"])]),_:1})]),_:1}),t(S,{span:10},{default:a(()=>[t(D,{label:"关键字"},{default:a(()=>[t(f,{modelValue:u.matchKeyMethod,"onUpdate:modelValue":e[4]||(e[4]=o=>u.matchKeyMethod=o),style:{width:"60px"}},{default:a(()=>[(p(),_(x,null,L(J,o=>t(r,{key:o.value,label:o.label,value:o.value},{default:a(()=>[m("span",Be,U(o.label),1),m("span",He,U(o.text),1)]),_:2},1032,["label","value"])),64))]),_:1},8,["modelValue"]),t(_e,{modelValue:u.matchKey,"onUpdate:modelValue":e[5]||(e[5]=o=>u.matchKey=o),style:{width:"240px"},autosize:"",type:"textarea",placeholder:"请输入关键字"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})])]),_:1},8,["model"]),m("div",Ge,[t(q,{data:N.value.queryResult,style:{width:"98%"},onExpandChange:ae,"default-sort":{prop:"logTime",order:"descending"}},{default:a(()=>[t(y,{type:"expand"},{default:a(o=>[t(q,{data:C.value,border:"","show-header":!1},{default:a(()=>[t(y,{fixed:"left",label:"Operations",width:"45"},{default:a(d=>[t(h,{icon:F(Fe),link:"",type:"primary",size:"small",onClick:W=>oe(d.row)},null,8,["icon","onClick"])]),_:1}),t(y,{label:"label",prop:"label",width:"120px"}),t(y,{label:"value",prop:"value"})]),_:1},8,["data"])]),_:1}),t(y,{label:"日志时间",prop:"logTime",sortable:"",width:"200px"}),t(y,{label:"日志等级",prop:"level",width:"100px",filters:$.value,"filter-method":ue,"filter-placement":"bottom-end"},{default:a(o=>[o.row.level=="DEBUG"?(p(),b(V,{key:0,type:"primary",effect:"light"},{default:a(()=>[...e[10]||(e[10]=[v("DEBUG",-1)])]),_:1})):o.row.level=="INFO"?(p(),b(V,{key:1,type:"success",effect:"light"},{default:a(()=>[...e[11]||(e[11]=[v("INFO",-1)])]),_:1})):o.row.level=="WARN"?(p(),b(V,{key:2,type:"warning",effect:"light"},{default:a(()=>[...e[12]||(e[12]=[v("WARN",-1)])]),_:1})):o.row.level=="ERROR"?(p(),b(V,{key:3,type:"danger",effect:"light"},{default:a(()=>[...e[13]||(e[13]=[v("ERROR",-1)])]),_:1})):o.row.level=="FATAL"?(p(),b(V,{key:4,type:"danger",effect:"light"},{default:a(()=>[...e[14]||(e[14]=[v("FATAL",-1)])]),_:1})):(p(),b(V,{key:5,type:"info",effect:"light"},{default:a(()=>[...e[15]||(e[15]=[v("UNKNOWN",-1)])]),_:1}))]),_:1},8,["filters"]),t(y,{label:"日志内容"},{header:a(()=>[m("div",qe,[t(he,{style:{color:"var(--el-table-header-text-color)"}},{default:a(()=>[...e[16]||(e[16]=[v("日志内容",-1)])]),_:1}),Ne(t(h,{type:"primary",plain:"",onClick:e[6]||(e[6]=o=>{var d;return ce((d=N.value)==null?void 0:d.queryResult)})},{default:a(()=>[...e[17]||(e[17]=[v("下载日志",-1)])]),_:1},512),[[$e,O.value]])])]),default:a(({row:o})=>[m("span",{innerHTML:ne(o.logLine,j.value)},null,8,We),m("div",Pe,[t(h,{onClick:d=>de(o)},{default:a(()=>[...e[18]||(e[18]=[v("查看上下文",-1)])]),_:1},8,["onClick"])])]),_:1})]),_:1},8,["data"])])]),t(Me,{isShow:R.value,"onUpdate:isShow":e[7]||(e[7]=o=>R.value=o),highlightKey:u.matchKey,url:u.dataSourceUrl,ref_key:"childRef",ref:H},null,8,["isShow","highlightKey","url"]),t(De,{bottom:50,target:".el-main"},{default:a(()=>[t(xe,null,{default:a(()=>[t(ye)]),_:1})]),_:1})],64)}}}),Xe=Re(Ye,[["__scopeId","data-v-b6c46384"]]);export{Xe as default};
