import{d as ne,g as re,j as ue,r as u,v as A,bP as ie,z as ce,b_ as V,h as c,bc as de,c as i,o,b as a,bV as ve,f as n,w as r,k as C,l as _e,m as I,ca as L,q as d,t as v,F as N,i as R,B as w,ch as me,_ as pe}from"./index-CWdEKdsq.js";import{m as fe}from"./model-doa-3kv_.js";const ge={class:"cmdb-search-container"},he={class:"search-header"},ye={class:"search-form"},be={class:"search-options"},ke={key:0,class:"regexp-error-message"},xe={class:"error-text"},Ve={key:1,class:"filter-section"},Ce={class:"search-results"},we={class:"results-header"},Me={class:"results-count"},Se={key:0,class:"model-stats"},Ne={key:0,class:"result-filters"},Re={class:"sort-options"},Be={key:0,class:"results-grid"},Ue={class:"card-content"},ze={class:"card-header"},De=["title"],Ee={class:"card-body"},Fe={class:"instance-info"},Ke={class:"info-item"},Te={class:"info-value"},$e={class:"info-item"},je={class:"info-value"},qe={class:"info-item"},Ae={class:"info-value"},Ie={class:"card-footer"},Le={key:2,class:"initial-placeholder"},Pe=ne({name:"cidataSearch",__name:"cidataSearchView",setup(We){const{proxy:Oe}=re(),P=ue(),F=fe(),b=u(""),k=u(!1),g=u([]),_=u([]),M=u(!1),h=A(()=>F.allModels),p=u([]),K=u(!0),f=u(""),B=u("modelName"),W=s=>{s?p.value=h.value.map(e=>e.id):p.value=[]};ie(h,s=>{s.length>0&&p.value.length===0&&(p.value=s.map(e=>e.id))});const T=A(()=>{const s={};return g.value.forEach(e=>{const t=e.model_id;s[t]=(s[t]||0)+1}),s}),O=s=>{const e=h.value.find(t=>t.id===s);return e?e.verbose_name:"未知模型"},G=s=>{const e=h.value.findIndex(D=>D.id===s),t=["success","warning","danger","info"];return t[e%t.length]||"success"},H=s=>{f.value===s?f.value="":f.value=s,X()},x=u(!1),U=u(!1),y=u(""),J=s=>{s?$():y.value=""},$=()=>{if(!x.value||!b.value)return y.value="",!0;try{return new RegExp(b.value),y.value="",!0}catch(s){return y.value=s.message,!1}},Q=async()=>{if(!b.value.trim()){V.warning("请输入搜索关键词");return}if(x.value&&!$()){V.error("正则表达式格式错误："+y.value);return}if(p.value.length===0){V.warning("请至少选择一个模型");return}k.value=!0,M.value=!0,f.value="";try{const s=await me.searchCiData({query:b.value.trim(),models:p.value,limit:2e4,search_mode:"boolean",regexp:x.value,case_sensitive:U.value});g.value=s.data.results||[],_.value=[...g.value],z()}catch(s){console.error("搜索失败:",s),V.error("搜索失败，请稍后重试"),g.value=[],_.value=[]}finally{k.value=!1}},X=()=>{f.value?_.value=g.value.filter(s=>s.model_id===f.value):_.value=[...g.value],z()},z=()=>{const s=[..._.value];switch(B.value){case"modelName":s.sort((e,t)=>e.model_verbose_name.localeCompare(t.model_verbose_name));break;case"instanceName":s.sort((e,t)=>e.instance_name.localeCompare(t.instance_name));break;case"relevance":s.sort((e,t)=>(t.max_score||0)-(e.max_score||0));break}_.value=s},Y=()=>{y.value="",b.value="",g.value=[],_.value=[],M.value=!1,f.value=""},Z=s=>{P.push({path:"/cmdb/cidata/"+s.instance_id})};return ce(async()=>{try{h.value.length===0&&await F.getModel(),p.value=h.value.map(s=>s.id)}catch(s){console.error("初始化数据失败:",s),V.error("初始化数据失败")}}),(s,e)=>{const t=c("el-icon"),D=c("el-input"),S=c("el-checkbox"),ee=c("Warning"),se=c("el-checkbox-group"),j=c("el-card"),E=c("el-tag"),q=c("el-option"),le=c("el-select"),ae=c("el-button"),te=c("el-empty"),oe=de("loading");return o(),i("div",ge,[a("div",he,[n(j,{class:"search-card"},{default:r(()=>[a("div",ye,[n(D,{modelValue:b.value,"onUpdate:modelValue":e[0]||(e[0]=l=>b.value=l),placeholder:"请输入关键词搜索实例...",clearable:"",onKeyup:_e(Q,["enter"]),class:"search-input",style:{width:"400px"},onClear:Y},{prefix:r(()=>[n(t,null,{default:r(()=>[n(I(L))]),_:1})]),_:1},8,["modelValue"]),a("div",be,[n(S,{modelValue:x.value,"onUpdate:modelValue":e[1]||(e[1]=l=>x.value=l),onChange:J},{default:r(()=>[...e[6]||(e[6]=[d(" 正则表达式 ",-1)])]),_:1},8,["modelValue"]),n(S,{modelValue:U.value,"onUpdate:modelValue":e[2]||(e[2]=l=>U.value=l)},{default:r(()=>[...e[7]||(e[7]=[d(" 区分大小写 ",-1)])]),_:1},8,["modelValue"])])]),y.value?(o(),i("div",ke,[n(t,{color:"#F56C6C"},{default:r(()=>[n(ee)]),_:1}),a("span",xe,v(y.value),1)])):C("",!0),h.value.length>0?(o(),i("div",Ve,[e[9]||(e[9]=a("div",{class:"filter-title"},"模型筛选:",-1)),n(S,{modelValue:K.value,"onUpdate:modelValue":e[3]||(e[3]=l=>K.value=l),onChange:W,class:"select-all-checkbox"},{default:r(()=>[...e[8]||(e[8]=[d(" 全选 ",-1)])]),_:1},8,["modelValue"]),n(se,{modelValue:p.value,"onUpdate:modelValue":e[4]||(e[4]=l=>p.value=l),class:"model-checkbox-group"},{default:r(()=>[(o(!0),i(N,null,R(h.value,l=>(o(),w(S,{key:l.id,label:l.id,class:"model-checkbox"},{default:r(()=>[d(v(l.verbose_name),1)]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])])):C("",!0)]),_:1})]),ve((o(),i("div",Ce,[a("div",we,[a("div",Me,[d(" 找到 "+v(_.value.length)+" 个实例 ",1),Object.keys(T.value).length>0?(o(),i("span",Se,[e[10]||(e[10]=d(" ( ",-1)),(o(!0),i(N,null,R(T.value,(l,m)=>(o(),w(E,{key:m,type:f.value===m?"primary":"info",size:"small",class:"model-stat-tag",onClick:Ge=>H(m),effect:f.value===m?"dark":"light",style:{cursor:"pointer","margin-right":"5px"}},{default:r(()=>[d(v(O(m))+": "+v(l)+"个 ",1)]),_:2},1032,["type","onClick","effect"]))),128)),e[11]||(e[11]=d(" ) ",-1))])):C("",!0)]),g.value.length>0?(o(),i("div",Ne,[a("div",Re,[e[12]||(e[12]=a("span",null,"排序:",-1)),n(le,{modelValue:B.value,"onUpdate:modelValue":e[5]||(e[5]=l=>B.value=l),onChange:z,class:"sort-select"},{default:r(()=>[n(q,{label:"模型名称",value:"modelName"}),n(q,{label:"实例名称",value:"instanceName"})]),_:1},8,["modelValue"])])])):C("",!0)]),_.value.length>0?(o(),i("div",Be,[(o(!0),i(N,null,R(_.value,l=>(o(),w(j,{key:l.instance_id,class:"instance-card",shadow:"hover"},{default:r(()=>[a("div",Ue,[a("div",ze,[a("div",{class:"instance-name",title:l.instance_name},v(l.instance_name),9,De),n(E,{type:G(l.model_id),class:"model-tag"},{default:r(()=>[d(v(l.model_verbose_name),1)]),_:2},1032,["type"])]),a("div",Ee,[a("div",Fe,[a("div",Ke,[e[13]||(e[13]=a("span",{class:"info-label"},"唯一标识:",-1)),a("span",Te,v(l.instance_name),1)]),a("div",$e,[e[14]||(e[14]=a("span",{class:"info-label"},"所属模型:",-1)),a("span",je,v(l.model_verbose_name),1)]),a("div",qe,[e[15]||(e[15]=a("span",{class:"info-label"},"匹配字段:",-1)),a("span",Ae,[(o(!0),i(N,null,R(l.matches,m=>(o(),w(E,{key:m.field_name,size:"small",class:"match-tag"},{default:r(()=>[d(v(m.field_verbose_name)+": "+v(m.display_value),1)]),_:2},1024))),128))])])])]),a("div",Ie,[n(ae,{type:"primary",size:"small",onClick:m=>Z(l),plain:""},{default:r(()=>[...e[16]||(e[16]=[d(" 查看详情 ",-1)])]),_:1},8,["onClick"])])])]),_:2},1024))),128))])):!k.value&&M.value?(o(),w(te,{key:1,description:"未找到相关实例",class:"no-results"})):!k.value&&!M.value?(o(),i("div",Le,[n(t,{size:"48"},{default:r(()=>[n(I(L))]),_:1}),e[17]||(e[17]=a("p",null,"请输入关键词进行搜索",-1))])):C("",!0)])),[[oe,k.value]])])}}}),Qe=pe(Pe,[["__scopeId","data-v-058f0a93"]]);export{Qe as default};
