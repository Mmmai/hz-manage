import{d as ne,f as re,h as de,g as ue,r as c,a as ie,l as A,m as D,e as r,c as $,o as C,i as f,b as l,w as o,y as pe,cC as me,k as B,t as T,F as j,p as E,q as ce,aK as _e,c3 as g,_ as fe}from"./index-BuQNgUX_.js";import{T as be}from"./treeTransfer-BjDokUnJ.js";const ge={class:"divVertical"},ye={class:"card flexJstart gap-5",style:{height:"50px",flex:"none"}},ve={class:"card",style:{flex:"none"}},xe={style:{float:"left"}},he={style:{float:"right",color:"var(--el-text-color-secondary)","font-size":"13px"}},Ve={class:"card"},we={style:{"text-align":"center"}},Ce=ne({__name:"proxyInfoView",setup(ke){const M=re(),U=de(),{proxy:_}=ue(),b=c(null),H=()=>{if(U.name.includes("cmdb_only")){M.push({path:"/cmdb_only/cmdb/cidata"});return}M.push({path:"/node_control/proxyManage"})},J=a=>{a&&a.resetFields()},K=c(""),s=ie({name:"",verbose_name:"",proxy_type:"all",enabled:!0,ip_address:"",port:22,auth_user:"",auth_pass:"",description:""}),L=[{label:"all",value:"all",description:"所有类型,支持zabbix和ansible"},{label:"zabbix",value:"zabbix",description:"zabbix代理"},{label:"ansible",value:"ansible",description:"ansible代理"}],O={name:[{required:!0,message:"请输入代理名称(不支持中文)",trigger:"blur"},{pattern:/^((\d{1,3}\.){1,3}\d{1,3})?[a-zA-Z0-9_-]{1,32}((\d{1,3}\.){1,3}\d{1,3})?$/,message:"请输入正确的代理名称,不支持中文等特殊符号",trigger:"blur"}],proxy_type:[{required:!0,message:"请选择代理类型",trigger:"change"}],ip_address:[{required:!0,message:"请输入代理IP",trigger:"blur"},{pattern:/^(\d{1,3}\.){3}\d{1,3}$/,message:"请输入正确的IP地址格式",trigger:"blur"}],port:[{required:!0,message:"请输入代理端口",trigger:"blur"},{type:"number",min:1,max:65535,message:"端口号应在1-65535之间",trigger:"blur"}],auth_user:[{required:!0,message:"请输入认证用户",trigger:"blur"}],auth_pass:[{required:!0,message:"请输入用户密码",trigger:"blur"}]},I=c([]),S=c([]),v=c("hosts"),k=c([]),z=A(()=>k.value.reduce((a,e)=>(a[e.name]=e,a),{})),Z=(a,e)=>{_e(()=>{F(),R()})},G=async()=>{let a=await _.$api.getModelConfig({ordering:"create_time"});a.status==200&&(k.value=a.data.results.filter(e=>e.is_manage===!0).map(e=>({label:e.model_verbose_name||e.model_name,name:e.model_name,model_id:e.model})))},x=async()=>{let a=await _.$api.getProxyInfo(b.value);a.status==200&&(s.name=a.data.name,s.verbose_name=a.data.verbose_name,s.proxy_type=a.data.proxy_type,s.enabled=a.data.enabled,s.ip_address=a.data.ip_address,s.port=a.data.port,s.auth_user=a.data.auth_user,s.auth_pass=a.data.auth_pass,s.description=a.data.description),N.value=a.data.nodes.map(e=>e.model_instance),console.log("hasConfigNodes:",S.value)},F=async()=>{var e;let a=await _.$api.getNodesArray({model:(e=z.value[v.value])==null?void 0:e.model_id});a.status==200&&(I.value=a.data.map(d=>({label:d.instance_name,id:d.id,instanceId:d.model_instance,disabled:!(d.proxy_id===b.value||d.proxy_id==null)})))},q=A(()=>{let a={};return I.value.forEach(e=>{a[e.instanceId]=e}),a}),Q=async()=>{let a=await _.$api.updateProxy({id:b.value,...s});a.status==200?(g({type:"success",message:"更新成功"}),x(),J(K.value)):g({type:"error",message:`更新失败: ${a.data}`})},W=async a=>{let e=await _.$api.batchAssociateProxy({proxy_id:b.value,ids:a});e.status==200?(g({type:"success",message:"关联成功"}),x()):g({type:"error",message:`关联失败: ${e.data}`})},X=async a=>{let e=await _.$api.batchDissociateProxy({ids:a,proxy_id:b.value});e.status==200?(g({type:"success",message:"取消关联成功"}),x()):g({type:"error",message:`取消关联失败: ${e.data}`})},P=c([]),N=c([]);function Y(a){function e(n){const h={id:n.id,label:n.label};let p=[];n.children&&n.children.length>0&&(p=n.children.map(e).filter(m=>m!==null));let u=[];n.instances&&n.instances.length>0&&(u=n.instances.map(m=>{var V,w;return{id:m.id,label:m.instance_name,disabled:((V=q.value[m.id])==null?void 0:V.disabled)||!1,disabledTooltip:((w=q.value[m.id])==null?void 0:w.disabledTooltip)||"已被其它proxy关联"}}));const i=[...p,...u];if(i.length>0)h.children=i;else if((!n.instances||n.instances.length===0)&&(!n.children||n.children.length===0))return null;return h}return a.map(e).filter(n=>n!==null)}const R=async()=>{var e;let a=await _.$api.getCiModelTreeNode({model:(e=z.value[v.value])==null?void 0:e.model_id});P.value=Y(a.data)},ee=(a,e,d)=>{e=="right"?W(d):X(d)};return D(async()=>{b.value=U.path.split("/").at(-1),await G(),await x(),await F(),await R()}),D(()=>{}),(a,e)=>{const d=r("el-button"),n=r("el-tooltip"),h=r("el-text"),p=r("el-input"),u=r("el-form-item"),i=r("el-col"),m=r("el-option"),V=r("el-select"),w=r("el-switch"),y=r("el-row"),ae=r("el-input-number"),le=r("el-form"),te=r("el-tab-pane"),se=r("el-tabs");return C(),$("div",ge,[f("div",ye,[l(n,{class:"box-item",effect:"dark",content:"返回proxy列表",placement:"top"},{default:o(()=>[l(d,{onClick:e[0]||(e[0]=t=>H()),icon:pe(me),plain:"",size:"small"},null,8,["icon"])]),_:1}),l(h,{tag:"b",size:"large"},{default:o(()=>[B(T(`代理详情【${s.name}】`),1)]),_:1})]),f("div",ve,[l(le,{ref:"proxyFormRef",model:s,rules:O,"label-width":"100px",style:{width:"100%","margin-top":"10px"}},{default:o(()=>[l(y,{gutter:20},{default:o(()=>[l(i,{span:4},{default:o(()=>[l(u,{label:"代理名称",prop:"name"},{default:o(()=>[l(p,{modelValue:s.name,"onUpdate:modelValue":e[1]||(e[1]=t=>s.name=t),placeholder:"请输入代理名称"},null,8,["modelValue"])]),_:1})]),_:1}),l(i,{span:4},{default:o(()=>[l(u,{label:"中文名称",prop:"verbose_name"},{default:o(()=>[l(p,{modelValue:s.verbose_name,"onUpdate:modelValue":e[2]||(e[2]=t=>s.verbose_name=t),placeholder:"请输入中文名称"},null,8,["modelValue"])]),_:1})]),_:1}),l(i,{span:4},{default:o(()=>[l(u,{label:"代理类型",prop:"proxy_type"},{default:o(()=>[l(V,{modelValue:s.proxy_type,"onUpdate:modelValue":e[3]||(e[3]=t=>s.proxy_type=t),placeholder:"请选择代理类型",disabled:""},{default:o(()=>[(C(),$(j,null,E(L,t=>l(m,{key:t.value,label:t.label,value:t.value},{default:o(()=>[f("span",xe,T(t.label),1),f("span",he,T(t.description),1)]),_:2},1032,["label","value"])),64))]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(i,{span:4},{default:o(()=>[l(u,{label:"是否启用",prop:"enabled"},{default:o(()=>[l(w,{modelValue:s.enabled,"onUpdate:modelValue":e[4]||(e[4]=t=>s.enabled=t)},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(y,null,{default:o(()=>[l(i,{span:4},{default:o(()=>[l(u,{label:"代理ip",prop:"ip_address"},{default:o(()=>[l(p,{modelValue:s.ip_address,"onUpdate:modelValue":e[5]||(e[5]=t=>s.ip_address=t),placeholder:"请输入代理ip"},null,8,["modelValue"])]),_:1})]),_:1}),l(i,{span:4},{default:o(()=>[l(u,{label:"代理端口",prop:"port"},{default:o(()=>[l(ae,{modelValue:s.port,"onUpdate:modelValue":e[6]||(e[6]=t=>s.port=t),placeholder:"请输入代理端口",min:1,max:65535,"controls-position":"right",style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),l(i,{span:4},{default:o(()=>[l(u,{label:"认证用户",prop:"auth_user"},{default:o(()=>[l(p,{modelValue:s.auth_user,"onUpdate:modelValue":e[7]||(e[7]=t=>s.auth_user=t),placeholder:"请输入认证用户"},null,8,["modelValue"])]),_:1})]),_:1}),l(i,{span:4},{default:o(()=>[l(u,{label:"用户密码",prop:"auth_pass"},{default:o(()=>[l(p,{modelValue:s.auth_pass,"onUpdate:modelValue":e[8]||(e[8]=t=>s.auth_pass=t),type:"password",placeholder:"请输入用户密码","show-password":""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(y,null,{default:o(()=>[l(i,{span:4},{default:o(()=>[l(u,{label:"备注信息",prop:"description"},{default:o(()=>[l(p,{modelValue:s.description,"onUpdate:modelValue":e[9]||(e[9]=t=>s.description=t),placeholder:"请输入备注信息",autosize:{minRows:2,maxRows:4},type:"textarea"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"]),l(y,{justify:"center"},{default:o(()=>[l(d,{type:"primary",onClick:e[10]||(e[10]=t=>Q())},{default:o(()=>[...e[13]||(e[13]=[B("更新",-1)])]),_:1})]),_:1})]),f("div",Ve,[l(se,{modelValue:v.value,"onUpdate:modelValue":e[11]||(e[11]=t=>v.value=t),type:"card",class:"demo-tabs",onTabClick:Z},{default:o(()=>[(C(!0),$(j,null,E(k.value,(t,oe)=>(C(),ce(te,{label:t.label,name:t.name,key:oe},null,8,["label","name"]))),128))]),_:1},8,["modelValue"]),l(y,{justify:"center"},{default:o(()=>[...e[14]||(e[14]=[f("h3",null,"节点关联配置",-1)])]),_:1}),f("div",we,[l(be,{modelValue:N.value,"onUpdate:modelValue":e[12]||(e[12]=t=>N.value=t),data:P.value,"leaf-only":!0,titles:["可选节点","已选节点"],"check-strictly":!1,onChange:ee},null,8,["modelValue","data"])])])])}}}),Te=fe(Ce,[["__scopeId","data-v-dd8eeb9c"]]);export{Te as default};
