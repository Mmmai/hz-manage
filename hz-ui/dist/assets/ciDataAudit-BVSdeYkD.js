import{d as se,g as le,u as re,v as R,r as p,h as d,c as v,o as _,b as u,f as o,l as ie,w as l,m as M,ca as ue,q as f,t as w,F as ce,i as de,k as h,B as H,cb as pe,b_ as I,_ as me}from"./index-CWdEKdsq.js";import{Q as _e}from"./vue3-json-viewer-DHXfab_Y.js";import{d as ge}from"./gmCrypto-CqnZf592.js";const ve={class:"divVertical"},fe={class:"card filter-card"},we={class:"filter-container"},ye={class:"filter-row filter-row-flex"},be={class:"filter-item"},he={class:"filter-item"},De={class:"filter-item"},Te={class:"card table-container table-main",style:{width:"100%"}},Ve=["onClick"],ke={class:"change-content"},Se={key:0,class:"old-value"},Ce={key:2,class:"new-value"},xe={class:"drawer-content"},Ee=se({__name:"ciDataAudit",props:{instanceId:{type:String,default:""}},setup(Y,{expose:F}){const{proxy:D}=le(),P=re(),O=R(()=>P.gmCry),J=Y,r=p([]),K=[{text:"最近1天",value:()=>{const t=new Date,e=new Date;return e.setTime(t.getTime()-3600*1e3*24*1),[e,t]}},{text:"最近3天",value:()=>{const t=new Date,e=new Date;return e.setTime(t.getTime()-3600*1e3*24*3),[e,t]}},{text:"最近5天",value:()=>{const t=new Date,e=new Date;return e.setTime(t.getTime()-3600*1e3*24*5),[e,t]}},{text:"最近7天",value:()=>{const t=new Date,e=new Date;return e.setTime(t.getTime()-3600*1e3*24*7),[e,t]}},{text:"最近1周",value:()=>{const t=new Date,e=new Date;return e.setTime(t.getTime()-3600*1e3*24*7),[e,t]}},{text:"最近1个月",value:()=>{const t=new Date,e=new Date;return e.setTime(t.getTime()-3600*1e3*24*30),[e,t]}},{text:"最近3个月",value:()=>{const t=new Date,e=new Date;return e.setTime(t.getTime()-3600*1e3*24*90),[e,t]}}],j=()=>{const t=new Date,e=new Date;e.setHours(23,59,59,999),t.setTime(e.getTime()-3600*1e3*24*30),t.setHours(0,0,0,0);const a=s=>{const m=s.getFullYear(),x=String(s.getMonth()+1).padStart(2,"0"),c=String(s.getDate()).padStart(2,"0"),E=String(s.getHours()).padStart(2,"0"),b=String(s.getMinutes()).padStart(2,"0"),$=String(s.getSeconds()).padStart(2,"0"),A=String(s.getMilliseconds()).padStart(3,"0");return`${m}-${x}-${c}T${E}:${b}:${$}.${A}`};r.value=[a(t),a(e)]},y=p(""),q=t=>{r.value=t,g()},z=()=>{g()},N=p([]),T=p(1),V=p(10),U=p(0),B=()=>{g()},Q={model:"模型",model_field:"字段",model_instance:"实例",model_group:"模型组",unique_constraint:"唯一约束",model_field_group:"模型字段组",validation_rule:"校验规则",model_instance_group:"实例组",relation_definition:"关系定义",relation:"关系关联"},k={groups:"实例组",path:"路径",label:"标签",level:"层级",parent:"父级",built_in:"内置",instance_name:"实例名称",order:"排序",verbose_name:"字段名称",model_field_group:"字段分组",instance_name_template:"实例名称模板",fields:"字段组合",using_template:"自动命名",model:"模型",input_mode:"录入方式",relation_attributes:"关系属性",source_attributes:"源属性",target_attributes:"目标属性",relation:"关联关系",attribute_schema:"关系属性",description:"描述",source_instance:"源实例",target_instance:"目标实例",source_model:"源模型",target_model:"目标模型",name:"名称",forward_verb:"正向名称",reverse_verb:"反向名称",topology_type:"拓扑类型"},G=t=>{const e=[];return t.changed_fields&&Object.keys(t.changed_fields).forEach(a=>{const s=t.changed_fields[a];a==="groups"?e.push({field:k[a],oldValue:s[0].map(m=>m.path).join(","),newValue:s[1].map(m=>m.path).join(",")}):a==="model_field_group"?e.push({field:k[a],oldValue:s[0].verbose_name,newValue:s[1].verbose_name}):e.push({field:k[a],oldValue:s[0],newValue:s[1]})}),t.details&&t.details.forEach(a=>{e.push({field:a.verbose_name||a.name,oldValue:L(a.old_value),newValue:L(a.new_value)})}),e},L=t=>{const e=a=>{if(typeof a=="object"&&a!==null)return a.hasOwnProperty("label")&&a.label!==void 0?a.label:a.hasOwnProperty("instance_name")&&a.instance_name!==void 0?a.instance_name:a.hasOwnProperty("verbose_name")&&a.verbose_name!==void 0?a.verbose_name:a.hasOwnProperty("password")&&a.password!==void 0?P.isShowPass?ge(O.value.key,O.value.mode,a.password):"******":JSON.stringify(a)};if(t===null)return t;if(typeof t=="object")return e(t);if(typeof t=="string")try{const a=JSON.parse(t);return e(a)}catch{return t}return t},S=p(!1),C=p({});R(()=>JSON.stringify(C.value,null,2));const W=t=>{C.value=t,S.value=!0},X=t=>Q[t]||t,Z={CREATE:"创建",UPDATE:"修改",DELETE:"删除"},ee=t=>Z[t]||t,te=t=>({CREATE:"success",UPDATE:"warning",DELETE:"danger"})[t]||"",g=async()=>{try{const t={page:T.value,page_size:V.value,target_type:"model_instance",object_id:J.instanceId,time_after:r.value&&r.value[0]?r.value[0]:void 0,time_before:r.value&&r.value[1]?r.value[1]:void 0,search:y.value||void 0},e=await D.$api.getCiAuditLog(t);N.value=e.data.results,U.value=e.data.count}catch(t){console.error("获取审计日志失败:",t),D.$message.error("获取审计日志失败")}},ae=()=>{r.value=[],y.value="",j(),g()},ne=async t=>{let e=await D.$api.ciAuditRockBack({correlation_id:t});e.status==200?I({type:"success",message:"回滚成功"}):I({type:"error",message:"回滚失败"+JSON.stringify(e.data)})};return F({getData:()=>{j(),g()}}),(t,e)=>{const a=d("el-date-picker"),s=d("el-button"),m=d("el-input"),x=d("el-tooltip"),c=d("el-table-column"),E=d("el-tag"),b=d("el-text"),$=d("el-table"),A=d("el-pagination");return _(),v("div",ve,[u("div",fe,[u("div",we,[u("div",ye,[u("div",be,[e[7]||(e[7]=u("span",{class:"filter-label"},"时间范围：",-1)),o(a,{modelValue:r.value,"onUpdate:modelValue":e[0]||(e[0]=n=>r.value=n),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间","value-format":"YYYY-MM-DDTHH:mm:ss",shortcuts:K,onChange:q},null,8,["modelValue"])]),u("div",he,[o(m,{modelValue:y.value,"onUpdate:modelValue":e[1]||(e[1]=n=>y.value=n),placeholder:"请输入搜索关键词",clearable:"",style:{width:"200px"},onKeyup:ie(z,["enter"])},{append:l(()=>[o(s,{icon:M(ue),onClick:z},null,8,["icon"])]),_:1},8,["modelValue"])]),u("div",De,[o(s,{onClick:ae},{default:l(()=>[...e[8]||(e[8]=[f("重置",-1)])]),_:1})])])])]),u("div",Te,[o($,{data:N.value,style:{width:"100%"},border:"",height:"900"},{default:l(()=>[o(c,{prop:"target_type",label:"操作对象",width:"120"},{default:l(n=>[o(x,{content:"查看详情",placement:"right",effect:"dark"},{default:l(()=>[u("span",{class:"target-type-link",onClick:i=>W(n.row)},w(X(n.row.target_type)),9,Ve)]),_:2},1024)]),_:1}),o(c,{label:"操作类型",width:"120"},{default:l(n=>[o(E,{type:te(n.row.action)},{default:l(()=>[f(w(ee(n.row.action)),1)]),_:2},1032,["type"])]),_:1}),o(c,{prop:"operator",label:"操作人",width:"120"}),o(c,{prop:"operator_ip",label:"操作人IP",width:"150"}),o(c,{prop:"comment",label:"操作描述","show-overflow-tooltip":""}),o(c,{label:"变更内容","show-overflow-tooltip":""},{default:l(n=>[u("div",ke,[(_(!0),v(ce,null,de(G(n.row),(i,oe)=>(_(),v("div",{key:oe,class:"change-item"},[o(b,{tag:"b"},{default:l(()=>[f(w(i.field)+": ",1)]),_:2},1024),i.oldValue!==void 0?(_(),v("span",Se,w(i.oldValue!==null?i.oldValue:"null"),1)):h("",!0),i.oldValue!==void 0&&i.newValue!==void 0?(_(),H(b,{key:1,tag:"b",type:"warning"},{default:l(()=>[...e[9]||(e[9]=[f(" → ",-1)])]),_:1})):h("",!0),i.newValue!==void 0?(_(),v("span",Ce,w(i.newValue!==null?i.newValue:"null"),1)):h("",!0)]))),128))])]),_:1}),o(c,{prop:"timestamp",label:"操作时间",width:"300"}),o(c,{label:"操作",fixed:"right",width:"120"},{default:l(n=>[n.row.action==="UPDATE"&&n.row.target_type==="model_instance"&&n.row.is_reverted===!1?(_(),H(s,{key:0,onClick:i=>ne(n.row.correlation_id),type:"primary",link:""},{default:l(()=>[...e[10]||(e[10]=[f("回退",-1)])]),_:1},8,["onClick"])):h("",!0)]),_:1})]),_:1},8,["data"]),o(A,{"current-page":T.value,"onUpdate:currentPage":[e[2]||(e[2]=n=>T.value=n),e[4]||(e[4]=n=>B())],"page-size":V.value,"onUpdate:pageSize":[e[3]||(e[3]=n=>V.value=n),e[5]||(e[5]=n=>B())],"page-sizes":[10,20,50,100,200],layout:"total, sizes, prev, pager, next, jumper",total:U.value,style:{"margin-top":"20px","justify-content":"flex-end",display:"flex"}},null,8,["current-page","page-size","total"])]),o(M(pe),{modelValue:S.value,"onUpdate:modelValue":e[6]||(e[6]=n=>S.value=n),title:"详细信息",direction:"rtl",size:"50%"},{default:l(()=>[u("div",xe,[o(M(_e),{value:C.value,"expand-depth":5,copyable:"",boxed:"",sort:""},null,8,["value"])])]),_:1},8,["modelValue"])])}}}),Oe=me(Ee,[["__scopeId","data-v-8b8dc5dc"]]);export{Oe as c};
