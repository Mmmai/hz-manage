import{d as me,g as fe,h as _e,r,a as J,B as ve,A as W,z as ge,q as be,e as u,ak as ye,c as B,o as n,i as N,b as t,w as o,ab as L,D as i,k as b,v as $,a7 as D,a8 as q,F as we,ap as p,I as H,_ as Ve}from"./index-BGjJrjF8.js";const ke={class:"card"},he={class:"dialog-footer"},xe=me({name:"logModule",__name:"logModuleView",setup(Ce){const{proxy:d}=fe(),y=_e(),K=r(),P=J({module_name:[{required:!0,message:"请填写名称",trigger:"blur"}],label_name:[{required:!0,message:"请添加匹配标签",trigger:"blur"}],label_value:[{required:!0,message:"请填写标签值",trigger:"blur"}]}),Q=async a=>{let e=await d.$api.updateLogModule(a);console.log(e),e.status==200?(p({type:"success",message:"更新成功"}),f(),c.value=!1,k()):p({type:"error",message:"更新失败"})},c=r(!1),M=r(!1);ve("");const f=()=>{Object.keys(s).forEach(a=>{s[a]=Y[a]})},X=a=>{H.confirm("是否关闭?").then(()=>{f(),console.log(s),a()}).catch(()=>{})},w=r({}),Y={data_source:w.value,label_name:"",label_value:"",label_match:"=~",group:"",status:!0},s=J({data_source:w.value,label_name:"",label_value:"",label_match:"=~",group:"",status:!0}),Z=()=>{c.value=!0,M.value=!0},I=a=>{U.value=a.id,F()},E=r([]),ee=async()=>{let a=await d.$api.dataSourceGet();a==null||a.data.results.forEach(e=>{e.source_type=="loki"&&(e.isUsed?E.value.push({label:e.source_name,value:e.id,disabled:!1}):E.value.push({label:e.source_name,value:e.id,disabled:!0}),e.isDefault&&(w.value=e))})},z=r([]),le=async()=>{console.log(w.value);let a=await d.$api.lokiLabelGet({url:w.value.url});z.value=a.data.data},ae=()=>{d.$refs.formRef.validate(async a=>{if(console.log(a),a){let e=await d.$api.addLogModule(s);console.log(e),e.status=="201"?(p({type:"success",message:"添加成功"}),f(),c.value=!1,k()):p({showClose:!0,message:"添加失败:"+JSON.stringify(e.data),type:"error"})}})};r([]);const V=r([]);r([]);const k=async()=>{let a=await d.$api.getLogModule();V.value=a.data.results,A.value=a.data.results},te=W(()=>{let a=[];return V.value.forEach(e=>{a.includes({value:e.group,label:e.group})||a.push({value:e.group,label:e.group})}),a}),oe=W(()=>{var e;let a=["所有"];return(e=V.value)==null||e.forEach(m=>{a.includes(m.group)||a.push(m.group)}),a}),O=r("所有");ge(()=>O.value,a=>{a==="所有"?A.value=V.value:A.value=V.value.filter(e=>e.group===a)});const U=r(""),se=a=>{c.value=!0,M.value=!1,U.value=a.id;let e=["id","update_time","create_time"];Object.keys(a).forEach(m=>{e.indexOf(m)===-1&&(s[m]=a[m])})},ue=()=>{d.$refs.formRef.validate(async a=>{if(a){let e=await d.$api.updateLogModule({id:U.value,...s});console.log(e),e.status==200?(p({type:"success",message:"更新成功"}),f(),c.value=!1,k()):p({type:"error",message:"更新失败"}),f()}})},F=()=>{H.confirm("是否确认删除?","Warning",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await d.$api.delLogModule(U.value)).status==204?(p({type:"success",message:"删除成功"}),f(),c.value=!1,k()):p({type:"error",message:"删除失败"})}).catch(()=>{p({type:"info",message:"Delete canceled"})})};be(async()=>{await ee(),await k()});const A=r([]);return(a,e)=>{const m=u("el-segmented"),j=u("el-col"),_=u("el-button"),ne=u("el-row"),re=u("el-divider"),v=u("el-table-column"),T=u("el-switch"),de=u("el-table"),S=u("el-option"),R=u("el-select"),g=u("el-form-item"),G=u("el-input"),ie=u("el-form"),pe=u("el-dialog"),h=ye("permission");return n(),B(D,null,[N("div",ke,[t(ne,{class:"row-bg",justify:"space-between"},{default:o(()=>[t(j,{span:23},{default:o(()=>[e[8]||(e[8]=N("span",{style:{display:"flex","align-items":"center","margin-right":"10px"}},"分组",-1)),t(m,{modelValue:O.value,"onUpdate:modelValue":e[0]||(e[0]=l=>O.value=l),options:oe.value,size:"large"},null,8,["modelValue","options"])]),_:1}),t(j,{span:1},{default:o(()=>{var l;return[L((n(),i(_,{type:"primary",onClick:Z},{default:o(()=>e[9]||(e[9]=[b("添加")])),_:1})),[[h,`${(l=$(y).name)==null?void 0:l.replace("_info","")}:add`]])]}),_:1})]),_:1}),t(re),t(de,{data:A.value,style:{width:"100%"},"table-layout":"auto"},{default:o(()=>[t(v,{prop:"module_name",label:"环节名称"}),t(v,{prop:"label_name",label:"标签名称"}),t(v,{prop:"label_match",label:"匹配方式"}),t(v,{prop:"label_value",label:"标签值"}),t(v,{prop:"status",label:"状态"},{default:o(l=>{var x;return[L(t(T,{modelValue:l.row.status,"onUpdate:modelValue":C=>l.row.status=C,class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},onChange:C=>Q(l.row)},null,8,["modelValue","onUpdate:modelValue","onChange"]),[[h,{id:`${(x=$(y).name)==null?void 0:x.replace("_info","")}:edit`,action:"disabled"}]])]}),_:1}),t(v,{fixed:"right",label:"操作"},{default:o(l=>{var x,C;return[L((n(),i(_,{link:"",type:"primary",size:"small",onClick:ce=>se(l.row)},{default:o(()=>e[10]||(e[10]=[b(" 编辑 ")])),_:2},1032,["onClick"])),[[h,`${(x=$(y).name)==null?void 0:x.replace("_info","")}:edit`]]),L((n(),i(_,{link:"",type:"primary",size:"small",onClick:ce=>I(l.row)},{default:o(()=>e[11]||(e[11]=[b(" 删除 ")])),_:2},1032,["onClick"])),[[h,`${(C=$(y).name)==null?void 0:C.replace("_info","")}:delete`]])]}),_:1})]),_:1},8,["data"])]),t(pe,{modelValue:c.value,"onUpdate:modelValue":e[7]||(e[7]=l=>c.value=l),title:"环节配置",width:"500","before-close":X,draggable:"",overflow:""},{footer:o(()=>{var l;return[N("div",he,[M.value==!1?L((n(),i(_,{key:0,type:"danger",onClick:F},{default:o(()=>e[12]||(e[12]=[b("删除")])),_:1})),[[h,`${(l=$(y).name)==null?void 0:l.replace("_info","")}:delete`]]):we("",!0),M.value==!1?(n(),i(_,{key:1,type:"primary",onClick:ue},{default:o(()=>e[13]||(e[13]=[b("更新")])),_:1})):(n(),i(_,{key:2,type:"primary",onClick:ae},{default:o(()=>e[14]||(e[14]=[b("添加")])),_:1}))])]}),default:o(()=>[t(ie,{"label-position":"right",model:s,"label-width":"auto",style:{"max-width":"400px"},ref_key:"formRef",ref:K,rules:P},{default:o(()=>[t(g,{label:"数据源",prop:"datasource"},{default:o(()=>[t(R,{modelValue:s.data_source,"onUpdate:modelValue":e[1]||(e[1]=l=>s.data_source=l),filterable:"",clearable:"","allow-create":"",placeholder:"标签",style:{width:"180px"}},{default:o(()=>[(n(!0),B(D,null,q(E.value,l=>(n(),i(S,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(g,{label:"环节名称",prop:"module_name"},{default:o(()=>[t(G,{modelValue:s.module_name,"onUpdate:modelValue":e[2]||(e[2]=l=>s.module_name=l),style:{width:"220px"}},null,8,["modelValue"])]),_:1}),t(g,{label:"标签",prop:"label_name"},{default:o(()=>[t(R,{modelValue:s.label_name,"onUpdate:modelValue":e[3]||(e[3]=l=>s.label_name=l),filterable:"",clearable:"","allow-create":"",placeholder:"标签",style:{width:"180px"},onClick:le},{default:o(()=>[(n(!0),B(D,null,q(z.value,l=>(n(),i(S,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(g,{label:"标签值",prop:"label_value"},{default:o(()=>[t(G,{modelValue:s.label_value,"onUpdate:modelValue":e[4]||(e[4]=l=>s.label_value=l),placeholder:"支持模糊匹配"},null,8,["modelValue"])]),_:1}),t(g,{label:"分组"},{default:o(()=>[t(R,{modelValue:s.group,"onUpdate:modelValue":e[5]||(e[5]=l=>s.group=l),filterable:"",clearable:"","allow-create":"",placeholder:"所属分组，支持新增",style:{width:"180px"}},{default:o(()=>[(n(!0),B(D,null,q(te.value,l=>(n(),i(S,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(g,{label:"是否启用"},{default:o(()=>[t(T,{modelValue:s.status,"onUpdate:modelValue":e[6]||(e[6]=l=>s.status=l),class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])],64)}}}),$e=Ve(xe,[["__scopeId","data-v-d87c7960"]]);export{$e as default};
