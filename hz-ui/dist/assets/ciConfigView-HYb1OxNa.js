import{d as Fe,g as Ne,y as Je,r as s,x as Be,v as U,a as Me,bP as I,z as Te,h as d,bc as De,c as g,o as r,b as O,f as o,bV as ee,m as S,B as _,w as n,q,F as A,i as E,l as Pe,cc as qe,cd as Ae,k as B,ce as Ee,cf as Ke,aP as le,b_ as v,c4 as Le}from"./index-Cm0tF2Sj.js";import{m as We}from"./model-BRqCW4T7.js";const Ge={class:"card table-main"},He={class:"table-header"},Qe={class:"header-button-lf"},Xe={class:"header-button-ri"},Ye={style:{display:"flex","align-items":"center"}},Ze={key:0,class:"el-form-item__error"},Ie={key:0},el={key:1},ll={key:0,class:"flexJstart",style:{"margin-top":"10px"}},tl={style:{overflow:"auto","max-height":"200px"}},al={class:"dialog-footer"},rl=Fe({name:"ciConfig",__name:"ciConfigView",setup(ol){const{proxy:k}=Ne(),K=Je(),te=s([]),L=Be(),de=We(),W=s("verbose_name"),G=s(""),pe=U(()=>({[W.value]:G.value})),M=s(null),ce=U(()=>{if(M.value===null)return!0;var l=RegExp(a.rule);return!!l.test(M.value)}),p=s(),c=s(),ve=U(()=>a.type!=="length"&&a.type!=="range"?!0:p.value===null||p.value===void 0||c.value===null||c.value===void 0?!1:p.value<c.value);I([p,c],([l,e])=>{(a.type==="length"||a.type==="range")&&l!=null&&e!==null&&e!==void 0&&l<=e&&(a.rule=`${l},${e}`)},{deep:!0});const h=s([{name:"",value:""}]),T=U(()=>{let l={};return h.value.forEach(e=>{e.name!==""&&e.value!==""&&(l[e.name]=e.value)}),l}),ae=U(()=>k.$commonFunc.hasDuplicates(Object.keys(T.value))||k.$commonFunc.hasDuplicates(Object.values(T.value)));I(()=>T.value,l=>{Object.keys(l).length!==0&&(a.rule=JSON.stringify(T.value))});const me=l=>{h.value.splice(l+1,0,{name:"",value:""})},fe=l=>{h.value.splice(l,1),console.log(h.value)},ye=s([{value:"name",label:"规则名",sort:!0,filter:!0,type:"string",required:!0},{value:"verbose_name",label:"规则名称",sort:!1,filter:!0,type:"string",required:!0},{value:"field_type",label:"字段类型",sort:!0,filter:!0,type:"object",required:!0},{value:"type",label:"规则类型",sort:!0,filter:!0,type:"object"}]),ge=U(()=>{let l=[];return ye.value.forEach(e=>{e.filter&&l.push({name:e.label,value:e.value})}),l}),z=s(null),a=Me({name:null,verbose_name:null,field_type:"string",type:"regex",rule:null,description:null});I(()=>a.field_type,l=>{a.type=Y.value[l][0].type},{deep:!0});const H=s(1),Q=s(10),_e=s("default"),be=s(!1),oe=s(0),Ve=()=>{b()},xe=()=>{b()},F=s({ordering:"-update_time"}),he=l=>{F.value={ordering:"-update_time"},l.order==="ascending"?F.value.ordering=l.prop:l.order==="descending"?F.value.ordering="-"+l.prop:F.value={ordering:"-update_time"},b()},m=s(!1),ne=()=>{m.value=!1,le(()=>{w(z.value),j.value={}})},$=s(!0),ke=()=>{$.value=!0,w(z.value),le(()=>{m.value=!0})},j=s({}),X=s({}),we=l=>{j.value=l,m.value=!0,$.value=!1,Object.assign(a,l),le(()=>{if(l.field_type==="enum"){let e=[];Object.keys(JSON.parse(l.rule)).forEach(u=>{e.push({name:u,value:JSON.parse(l.rule)[u]})}),h.value=e}else if((l.type==="length"||l.type==="range")&&l.rule)try{const e=l.rule.split(",");p.value=e[0]!==void 0?+e[0]:null,c.value=e[1]!==void 0?+e[1]:null}catch(e){console.warn("解析范围值失败:",e)}X.value=JSON.parse(JSON.stringify(a))})},w=l=>{l&&(console.log(l),l.resetFields(),console.log(JSON.stringify(a)),h.value=[{name:"",value:""}],p.value=null,c.value=null)},se=s([]),Y=s([]),b=async(l=null)=>{let e=await k.$api.getValidationRules({page:H.value,page_size:Q.value,...pe.value,...F.value,...l});te.value=e.data.results,oe.value=e.data.count,de.getValidationRules(!0)},Ce=async()=>{let l=await k.$api.getCiModelFieldType();Y.value=l.data.field_validations;let e=l.data.field_types;se.value=Object.keys(e).filter(u=>u!=="password"&&u!=="model_ref").map(u=>({value:u,label:e[u]}))},D=s({}),Oe=async l=>{await l.validate(async(e,u)=>{if(e){if(a.type==="length"||a.type==="range"){if(p.value===null||p.value===void 0){v({type:"error",message:"请填写最小值"});return}if(c.value===null||c.value===void 0){v({type:"error",message:"请填写最大值"});return}if(p.value>c.value){v({type:"error",message:"最小值不能大于最大值"});return}}if(console.log(ae.value),ae.value){v({type:"error",message:"有重复值！"});return}if($.value){let f=await k.$api.addValidationRules({create_user:K.state.username,update_user:K.state.username,...a});f.status=="201"?(v({type:"success",message:"添加成功"}),m.value=!1,w(l),await b()):v({showClose:!0,message:"添加失败:"+JSON.stringify(f.data),type:"error"})}else{if(JSON.stringify(X.value)===JSON.stringify(a)){m.value=!1,w(l),v({showClose:!0,message:"无更新,关闭窗口",type:"info"});return}else{const R=Object.entries(X.value),y=Object.entries(a),V=R.concat(y).map(i=>JSON.stringify(i)),N=Array.from(new Set(V)).map(i=>JSON.parse(i));N.splice(0,R.length);const J=Object.fromEntries(N);let P={};if(Object.keys(J).forEach(i=>{J[i]!=""&&(P[i]=J[i])}),D.value=P,Object.keys(D.value).length===0){m.value=!1,w(l),v({showClose:!0,message:"无更新,关闭窗口",type:"info"});return}}console.log(D.value),console.log(a);let f=await k.$api.updateValidationRules({id:j.value.id,update_user:K.state.username,...D.value});console.log(f),f.status=="200"?(v({type:"success",message:"更新成功"}),m.value=!1,w(l),b()):v({showClose:!0,message:"更新失败:"+JSON.stringify(f.data),type:"error"})}}})},Se=l=>{Le.confirm("是否确认删除?","删除",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await k.$api.deleteValidationRules(l)).status==204?(v({type:"success",message:"删除成功"}),await b(),w(z.value),m.value=!1):v({type:"error",message:"删除失败"})}).catch(()=>{v({type:"info",message:"取消删除"})})};return Te(()=>{b(),Ce()}),(l,e)=>{var ie;const u=d("el-button"),f=d("el-option"),R=d("el-select"),y=d("el-input"),V=d("el-table-column"),N=d("el-tooltip"),J=d("el-table"),P=d("el-pagination"),i=d("el-form-item"),re=d("el-input-number"),$e=d("el-text"),je=d("SuccessFilled"),ue=d("el-icon"),Re=d("WarningFilled"),Ue=d("el-form"),ze=d("el-dialog"),Z=De("permission");return r(),g("div",Ge,[O("div",He,[O("div",Qe,[ee((r(),_(u,{type:"primary",onClick:ke},{default:n(()=>[...e[17]||(e[17]=[q("添加",-1)])]),_:1})),[[Z,`${(ie=S(L).name)==null?void 0:ie.replace("_info","")}:add`]])]),O("div",Xe,[o(R,{modelValue:W.value,"onUpdate:modelValue":e[0]||(e[0]=t=>W.value=t),placeholder:"Select",style:{width:"120px"}},{default:n(()=>[(r(!0),g(A,null,E(ge.value,t=>(r(),_(f,{key:t.value,label:t.name,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),o(y,{modelValue:G.value,"onUpdate:modelValue":e[1]||(e[1]=t=>G.value=t),style:{width:"240px"},placeholder:"回车查询",clearable:"",onClear:e[2]||(e[2]=t=>b()),onKeyup:e[3]||(e[3]=Pe(t=>b(),["enter","native"]))},null,8,["modelValue"])])]),o(J,{ref:"multipleTableRef",data:te.value,style:{width:"100%"},height:"100%",border:"",onSortChange:he},{default:n(()=>[o(V,{property:"name",label:"规则名",sortable:"custom"}),o(V,{property:"verbose_name",label:"规则名称"}),o(V,{property:"field_type",label:"字段类型",sortable:"custom"}),o(V,{property:"type",label:"规则类型",sortable:"custom"}),o(V,{property:"rule",label:"规则内容","show-overflow-tooltip":""}),o(V,{property:"description",label:"描述"}),o(V,{fixed:"right",width:"100",label:"操作"},{default:n(t=>[o(N,{class:"box-item",effect:"dark",content:"编辑",placement:"top"},{default:n(()=>{var x;return[ee(o(u,{link:"",type:"primary",icon:S(qe),onClick:C=>we(t.row)},null,8,["icon","onClick"]),[[Z,`${(x=S(L).name)==null?void 0:x.replace("_info","")}:edit`]])]}),_:2},1024),o(N,{class:"box-item",effect:"dark",content:"删除",placement:"top"},{default:n(()=>{var x;return[ee(o(u,{link:"",type:"danger",icon:S(Ae),disabled:t.row.built_in,onClick:C=>Se(t.row.id)},null,8,["icon","disabled","onClick"]),[[Z,`${(x=S(L).name)==null?void 0:x.replace("_info","")}:delete`]])]}),_:2},1024)]),_:1})]),_:1},8,["data"]),o(P,{"current-page":H.value,"onUpdate:currentPage":e[4]||(e[4]=t=>H.value=t),"page-size":Q.value,"onUpdate:pageSize":e[5]||(e[5]=t=>Q.value=t),"page-sizes":[10,20,50,100,200],size:_e.value,disabled:be.value,layout:"total, sizes, prev, pager, next, jumper",total:oe.value,onSizeChange:Ve,onCurrentChange:xe,style:{"margin-top":"5px","justify-content":"flex-end"}},null,8,["current-page","page-size","size","disabled","total"]),o(ze,{modelValue:m.value,"onUpdate:modelValue":e[16]||(e[16]=t=>m.value=t),title:"规则配置",width:"500","before-close":ne},{footer:n(()=>[O("div",al,[o(u,{onClick:ne},{default:n(()=>[...e[20]||(e[20]=[q("取消",-1)])]),_:1}),o(u,{type:"primary",onClick:e[15]||(e[15]=t=>Oe(z.value))},{default:n(()=>[...e[21]||(e[21]=[q(" 提交 ",-1)])]),_:1})])]),default:n(()=>[o(Ue,{inline:!0,"label-position":"right",model:a,"label-width":"auto",ref_key:"formRef",ref:z},{default:n(()=>[o(i,{label:"规则名",prop:"name"},{default:n(()=>[o(y,{modelValue:a.name,"onUpdate:modelValue":e[6]||(e[6]=t=>a.name=t),clearable:"",style:{width:"300px"},disabled:!!(j.value.built_in||!$.value)},null,8,["modelValue","disabled"])]),_:1}),o(i,{label:"规则名称",prop:"verbose_name"},{default:n(()=>[o(y,{modelValue:a.verbose_name,"onUpdate:modelValue":e[7]||(e[7]=t=>a.verbose_name=t),clearable:"",style:{width:"300px"}},null,8,["modelValue"])]),_:1}),o(i,{label:"字段类型",prop:"field_type"},{default:n(()=>[o(R,{modelValue:a.field_type,"onUpdate:modelValue":e[8]||(e[8]=t=>a.field_type=t),placeholder:"选择类型",style:{width:"120px"},disabled:!!(j.value.built_in||!$.value)},{default:n(()=>[(r(!0),g(A,null,E(se.value,t=>(r(),_(f,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),o(i,{label:"规则类型",prop:"type"},{default:n(()=>[o(R,{modelValue:a.type,"onUpdate:modelValue":e[9]||(e[9]=t=>a.type=t),placeholder:"选择类型",style:{width:"120px"},disabled:!!(j.value.built_in||!$.value)},{default:n(()=>[(r(!0),g(A,null,E(Y.value[a.field_type],t=>(r(),_(f,{key:t.type,label:t.description,value:t.type},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),a.type==="length"||a.type==="range"?(r(),_(i,{key:0,label:"数值范围",prop:"rule"},{default:n(()=>[O("div",Ye,[o(re,{modelValue:p.value,"onUpdate:modelValue":e[10]||(e[10]=t=>p.value=t),placeholder:"最小值","controls-position":"right",style:{width:"120px","margin-right":"10px"},precision:a.field_type==="float"?2:0,step:a.field_type==="float"?.1:1},null,8,["modelValue","precision","step"]),e[18]||(e[18]=O("span",{style:{"margin-right":"10px"}},"-",-1)),o(re,{modelValue:c.value,"onUpdate:modelValue":e[11]||(e[11]=t=>c.value=t),placeholder:"最大值","controls-position":"right",style:{width:"120px"},precision:a.field_type==="float"?2:0,step:a.field_type==="float"?.1:1},null,8,["modelValue","precision","step"])]),ve.value?B("",!0):(r(),g("div",Ze,[p.value===null||p.value===void 0||c.value===null||c.value===void 0?(r(),g("span",Ie," 请输入完整的范围值 ")):p.value>c.value?(r(),g("span",el," 最小值不能大于最大值 ")):B("",!0)]))]),_:1})):a.type==="regex"?(r(),_(i,{key:1,label:"校验规则",prop:"rule",required:!0},{default:n(()=>[o(y,{modelValue:a.rule,"onUpdate:modelValue":e[12]||(e[12]=t=>a.rule=t),type:"textarea",clearable:"",style:{width:"300px"}},null,8,["modelValue"]),a.type==="regex"?(r(),g("div",ll,[o($e,null,{default:n(()=>[...e[19]||(e[19]=[q("测试正则",-1)])]),_:1}),o(y,{modelValue:M.value,"onUpdate:modelValue":e[13]||(e[13]=t=>M.value=t),clearable:"",style:{width:"200px",margin:"0 10px"}},null,8,["modelValue"]),ce.value?(r(),_(ue,{key:0,style:{color:"var(--el-color-success)"},size:20},{default:n(()=>[o(je)]),_:1})):(r(),_(ue,{key:1,style:{color:"var(--el-color-danger)"},size:20},{default:n(()=>[o(Re)]),_:1}))])):B("",!0)]),_:1})):a.type==="enum"?(r(),_(i,{key:2,label:"枚举值",prop:"rule"},{default:n(()=>[O("div",tl,[(r(!0),g(A,null,E(h.value,(t,x)=>(r(),g("div",{key:x,style:{"margin-right":"10px"}},[o(y,{modelValue:t.name,"onUpdate:modelValue":C=>t.name=C,style:{width:"90px","margin-right":"10px"}},null,8,["modelValue","onUpdate:modelValue"]),o(y,{modelValue:t.value,"onUpdate:modelValue":C=>t.value=C,style:{width:"160px","margin-right":"10px"}},null,8,["modelValue","onUpdate:modelValue"]),h.value.length!==1?(r(),_(u,{key:0,circle:"",type:"danger",size:"small",icon:S(Ee),onClick:C=>fe(x)},null,8,["icon","onClick"])):B("",!0),o(u,{circle:"",type:"primary",size:"small",icon:S(Ke),onClick:C=>me(x)},null,8,["icon","onClick"])]))),128))])]),_:1})):B("",!0),o(i,{label:"描述",prop:"description"},{default:n(()=>[o(y,{modelValue:a.description,"onUpdate:modelValue":e[14]||(e[14]=t=>a.description=t),type:"textarea",clearable:"",style:{width:"300px"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}});export{rl as default};
