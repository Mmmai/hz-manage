import{_ as Qe,x as We,y as Xe,g as Ye,r as m,a as E,v as Ze,bP as _e,b_ as r,z as el,h as u,bc as ve,c as M,o as c,b as h,f as l,bV as $,m as V,B as x,w as t,q as d,ca as ll,l as tl,F as R,i as le,t as te,cc as al,cd as ol,c4 as K}from"./index-Ch0lsCs7.js";const rl={class:"card"},nl={class:"portal-header"},sl={class:"toolbar"},ul={class:"search-filters"},il={key:0},dl={key:1},pl={class:"pgroup-container"},ml={class:"toolbar"},cl={class:"upload-tip"},fl=Object.assign({name:"portalView"},{__name:"portalView",setup(gl){const k=We(),ye=Xe(),{proxy:p}=Ye(),q=m(""),O=m(""),N=m(""),H=m(!1),i=E({page:1,page_size:10});E({page:1,page_size:10,owner:ye.state.userinfo.user_id});const ae=m([]),oe=m(0),A=m([]),Q=m(!1),U=m(!1),z=m(!1),W=m(!1),s=E({name:"",url:"",target:!0,group:"",sharing_type:"public",status:!0,username:"",password:"",sort:9999,describe:""}),S=E({group:""}),L=m("add"),J=m("add"),P=m([]),j=m([]),re=m([]),we=m(null),be=m(10),ne=E({"Content-Type":"multipart/form-data"});Ze(()=>P.value.map(o=>o.id)),_e(()=>i,o=>{v(o)},{deep:!0}),_e([O,N],()=>{Y()});const X=()=>{i.page=1,v(i)},Y=()=>{i.page=1,v(i)},he=()=>{q.value="",O.value="",N.value="",i.page=1,v(i)},Ve=o=>{i.page_size=o,i.page=1},xe=o=>{i.page=o},Ce=o=>{P.value=o},$e=o=>{j.value=o},v=async o=>{H.value=!0;try{const e={...o,search:q.value,group:O.value,sharing_type:N.value};Object.keys(e).forEach(_=>{(e[_]===""||e[_]===null||e[_]===void 0)&&delete e[_]});const n=await p.$api.portalGet(e);ae.value=n.data.results,oe.value=n.data.count}catch(e){r.error("获取门户数据失败"),console.error(e)}finally{H.value=!1}},B=async()=>{try{const o=await p.$api.pgroupGet({page:1,page_size:1e3});A.value=o.data.results}catch(o){r.error("获取分组数据失败"),console.error(o)}},ke=()=>{z.value=!0,L.value="add",Object.assign(s,{name:"",url:"",target:!0,group:"",sharing_type:"public",status:!0,username:"",password:"",sort:9999,describe:""})},Ue=o=>{z.value=!0,L.value="edit",p.$nextTick(()=>{Object.assign(s,o)})},ze=()=>{var o;z.value=!1,(o=p.$refs.portalForm)==null||o.resetFields()},Se=()=>{p.$refs.portalForm.validate(async o=>{if(o)try{let e;L.value==="add"?(e=await p.$api.portalAdd(s),e.status===201?(r.success("添加成功"),z.value=!1,v(i)):r.error("添加失败: "+JSON.stringify(e.data))):(e=await p.$api.portalUpdate(s),e.status===200?(r.success("更新成功"),z.value=!1,v(i)):r.error("更新失败: "+JSON.stringify(e.data)))}catch(e){r.error("操作失败: "+e.message)}else r.error("请填写正确的表单信息")})},De=o=>{K.confirm(`确定要删除门户 "${o.name}" 吗？`,"确认删除",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{(await p.$api.portalDel(o.id)).status===204?(r.success("删除成功"),v(i)):r.error("删除失败")}catch(e){r.error("删除失败: "+e.message)}}).catch(()=>{r.info("已取消删除")})},Te=()=>{if(P.value.length===0){r.warning("请至少选择一项");return}K.confirm(`确定要删除选中的 ${P.value.length} 项吗？`,"确认删除",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const o=P.value.map(n=>n.id);(await p.$api.portalMuldel({pks:o})).status===204?(r.success("删除成功"),v(i)):r.error("删除失败")}catch(o){r.error("删除失败: "+o.message)}}).catch(()=>{r.info("已取消删除")})},Pe=()=>{Q.value=!0},Be=()=>{U.value=!0,J.value="add",S.group=""},Fe=o=>{U.value=!0,J.value="edit",p.$nextTick(()=>{Object.assign(S,o)})},Me=()=>{p.$refs.pgroupForm.validate(async o=>{if(o)try{let e;J.value==="add"?(e=await p.$api.pgroupAdd(S),e.status===201?(r.success("添加成功"),U.value=!1,B()):r.error("添加失败: "+JSON.stringify(e.data))):(e=await p.$api.pgroupUpdate(S),e.status===200?(r.success("更新成功"),U.value=!1,B()):r.error("更新失败: "+JSON.stringify(e.data)))}catch(e){r.error("操作失败: "+e.message)}else r.error("请输入正确的分组名称")})},Oe=o=>{K.confirm(`确定要删除分组 "${o.group}" 吗？`,"确认删除",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{(await p.$api.pgroupDel(o.id)).status===204?(r.success("删除成功"),B()):r.error("删除失败")}catch(e){r.error("删除失败: "+e.message)}}).catch(()=>{r.info("已取消删除")})},Ne=()=>{if(j.value.length===0){r.warning("请至少选择一项");return}K.confirm(`确定要删除选中的 ${j.value.length} 个分组吗？`,"确认删除",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{const o=j.value.map(n=>n.id);(await p.$api.pgroupMuldel({pks:o})).status===204?(r.success("删除成功"),B()):r.error("删除失败")}catch(o){r.error("删除失败: "+o.message)}}).catch(()=>{r.info("已取消删除")})},je=async o=>{try{(await p.$api.portalUpdate({status:o.status,id:o.id})).status===200?r.success("状态更新成功"):r.error("状态更新失败")}catch(e){r.error("状态更新失败: "+e.message)}},Ee=async()=>{try{const o=await p.$api.portalDataExport()}catch(o){r.error("导出失败: "+o.message)}},se=async()=>{try{const o=await p.$api.portalTemplateExport()}catch(o){r.error("模板导出失败: "+o.message)}},qe=o=>{const e=["xlsx"],n=o.name;if(o.type!==""||o.type!==null||o.type!==void 0){const _=o.name.replace(/.+\./,"").toLowerCase();return o.size/1024/1024<5?e.includes(_)?re.value.find(y=>y.name===n&&y.lastModified===o.lastModified)?(r.error("该文件已上传！"),!1):!0:(r.error(`不能上传${_}类型的文件`),!1):(r.error("上传文件大小不能超过 5MB!"),!1)}},Ae=async o=>{const e=new FormData;e.append("file",o.file);try{const n=await p.$api.importPortalData(e,ne,12e4);n.status===200?(r.success(`导入成功: ${JSON.stringify(n.data)}`),v(i),B()):r.error(`导入异常: ${JSON.stringify(n.data)}`)}catch(n){r.error(`导入失败: ${n.message}`)}};return el(async()=>{await Promise.all([B(),v(i)])}),(o,e)=>{var ce,fe,ge;const n=u("el-button"),_=u("el-dropdown-item"),ue=u("el-dropdown-menu"),ie=u("el-dropdown"),y=u("el-input"),F=u("el-option"),I=u("el-select"),g=u("el-table-column"),de=u("el-tag"),Le=u("el-space"),Z=u("el-switch"),pe=u("el-table"),Je=u("el-pagination"),f=u("el-form-item"),C=u("el-row"),me=u("el-form"),G=u("el-dialog"),w=u("el-col"),Ie=u("el-input-number"),Ge=u("upload-filled"),Re=u("el-icon"),Ke=u("el-upload"),D=ve("permission"),He=ve("loading");return c(),M(R,null,[h("div",rl,[h("div",nl,[h("div",sl,[$((c(),x(n,{type:"primary",size:"small",onClick:ke},{default:t(()=>[...e[23]||(e[23]=[d("新增",-1)])]),_:1})),[[D,`${(ce=V(k).name)==null?void 0:ce.replace("_info","")}:add`]]),$((c(),x(n,{type:"primary",size:"small",onClick:Pe},{default:t(()=>[...e[24]||(e[24]=[d("新增分组",-1)])]),_:1})),[[D,`${(fe=V(k).name)==null?void 0:fe.replace("_info","")}:add`]]),$((c(),x(n,{disabled:P.value.length===0,type:"danger",size:"small",onClick:Te},{default:t(()=>[...e[25]||(e[25]=[d("批量删除",-1)])]),_:1},8,["disabled"])),[[D,`${(ge=V(k).name)==null?void 0:ge.replace("_info","")}:delete`]]),l(ie,{size:"small","split-button":"",type:"primary",style:{"margin-left":"15px","margin-right":"15px"}},{dropdown:t(()=>[l(ue,null,{default:t(()=>[l(_,{onClick:Ee},{default:t(()=>[...e[26]||(e[26]=[d("全部导出",-1)])]),_:1}),l(_,{onClick:e[0]||(e[0]=a=>W.value=!0)},{default:t(()=>[...e[27]||(e[27]=[d("批量导入",-1)])]),_:1}),l(_,{onClick:se},{default:t(()=>[...e[28]||(e[28]=[d("模版下载",-1)])]),_:1})]),_:1})]),default:t(()=>[e[29]||(e[29]=d(" 更多操作 ",-1))]),_:1})]),h("div",ul,[l(y,{modelValue:q.value,"onUpdate:modelValue":e[1]||(e[1]=a=>q.value=a),placeholder:"输入名称、链接或描述",clearable:"",onClear:X,onKeyup:tl(X,["enter"]),style:{width:"200px","margin-right":"10px"}},{append:t(()=>[l(n,{icon:V(ll),onClick:X},null,8,["icon"])]),_:1},8,["modelValue"]),l(I,{modelValue:O.value,"onUpdate:modelValue":e[2]||(e[2]=a=>O.value=a),placeholder:"选择分组",clearable:"",onChange:Y,style:{width:"150px","margin-right":"10px"}},{default:t(()=>[(c(!0),M(R,null,le(A.value,a=>(c(),x(F,{key:a.id,label:a.group,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),l(I,{modelValue:N.value,"onUpdate:modelValue":e[3]||(e[3]=a=>N.value=a),placeholder:"共享类型",clearable:"",onChange:Y,style:{width:"120px","margin-right":"10px"}},{default:t(()=>[l(F,{label:"公共",value:"public"}),l(F,{label:"私人",value:"private"})]),_:1},8,["modelValue"]),l(n,{onClick:he},{default:t(()=>[...e[30]||(e[30]=[d("重置",-1)])]),_:1})])]),$((c(),x(pe,{border:"",data:ae.value,style:{width:"100%",flex:"1"},"max-height":"100%",onSelectionChange:Ce},{default:t(()=>[l(g,{type:"selection",width:"55"}),l(g,{prop:"name",label:"名称","min-width":"120"}),l(g,{prop:"url",label:"链接地址","min-width":"180"}),l(g,{prop:"group_name",label:"分组","min-width":"100"},{default:t(a=>[l(Le,null,{default:t(()=>[(c(!0),M(R,null,le(a.row.groups,(b,T)=>(c(),x(de,{key:T},{default:t(()=>[d(te(b.group),1)]),_:2},1024))),128))]),_:2},1024)]),_:1}),l(g,{prop:"sharing_type",label:"共享类型","min-width":"80"},{default:t(a=>[l(de,{type:a.row.sharing_type==="public"?"success":"warning"},{default:t(()=>[d(te(a.row.sharing_type==="public"?"公共":"私人"),1)]),_:2},1032,["type"])]),_:1}),l(g,{prop:"owner_name",label:"所有者","min-width":"100"},{default:t(a=>[a.row.owner_name?(c(),M("span",il,te(a.row.owner_name),1)):(c(),M("span",dl,"-"))]),_:1}),l(g,{prop:"status",label:"状态",width:"80"},{default:t(a=>[l(Z,{modelValue:a.row.status,"onUpdate:modelValue":b=>a.row.status=b,class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},onChange:b=>je(a.row)},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),l(g,{prop:"sort",label:"排序",width:"80"}),l(g,{fixed:"right",label:"操作",width:"150"},{default:t(a=>{var b,T;return[$((c(),x(n,{type:"primary",size:"small",onClick:ee=>Ue(a.row)},{default:t(()=>[...e[31]||(e[31]=[d(" 编辑 ",-1)])]),_:1},8,["onClick"])),[[D,`${(b=V(k).name)==null?void 0:b.replace("_info","")}:edit`]]),$((c(),x(n,{type:"danger",size:"small",onClick:ee=>De(a.row)},{default:t(()=>[...e[32]||(e[32]=[d(" 删除 ",-1)])]),_:1},8,["onClick"])),[[D,`${(T=V(k).name)==null?void 0:T.replace("_info","")}:delete`]])]}),_:1})]),_:1},8,["data"])),[[He,H.value]]),l(Je,{"current-page":i.page,"onUpdate:currentPage":e[4]||(e[4]=a=>i.page=a),"page-size":i.page_size,"onUpdate:pageSize":e[5]||(e[5]=a=>i.page_size=a),"page-sizes":[10,20,50,100],layout:"total, sizes, prev, pager, next, jumper",total:oe.value,style:{"margin-top":"15px","justify-content":"flex-end"},onSizeChange:Ve,onCurrentChange:xe},null,8,["current-page","page-size","total"])]),l(G,{modelValue:Q.value,"onUpdate:modelValue":e[9]||(e[9]=a=>Q.value=a),title:"编辑分组",width:"50%"},{footer:t(()=>[l(G,{modelValue:U.value,"onUpdate:modelValue":e[8]||(e[8]=a=>U.value=a),width:"30%",title:J.value==="add"?"新增分组":"编辑分组","append-to-body":""},{default:t(()=>[l(me,{inline:!0,model:S,class:"demo-form-inline","label-position":"right","label-width":"80px",ref:"pgroupForm","status-icon":""},{default:t(()=>[l(f,{label:"分组名称",prop:"group",rules:[{required:!0,message:"请输入分组名称",trigger:"blur"}]},{default:t(()=>[l(y,{modelValue:S.group,"onUpdate:modelValue":e[6]||(e[6]=a=>S.group=a),placeholder:"请输入分组名称",clearable:""},null,8,["modelValue"])]),_:1}),l(C,{style:{"justify-content":"space-around"}},{default:t(()=>[l(f,null,{default:t(()=>[l(n,{onClick:e[7]||(e[7]=a=>U.value=!1)},{default:t(()=>[...e[33]||(e[33]=[d("取消",-1)])]),_:1}),l(n,{type:"primary",onClick:Me},{default:t(()=>[...e[34]||(e[34]=[d(" 确定",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])]),default:t(()=>[h("div",pl,[h("div",ml,[l(n,{type:"primary",size:"small",onClick:Be},{default:t(()=>[...e[35]||(e[35]=[d("新增",-1)])]),_:1}),l(n,{disabled:j.value.length===0,type:"danger",size:"small",onClick:Ne},{default:t(()=>[...e[36]||(e[36]=[d("批量删除",-1)])]),_:1},8,["disabled"])]),l(pe,{data:A.value,"default-sort":{prop:"id",order:"ascending"},onSelectionChange:$e,border:""},{default:t(()=>[l(g,{type:"selection",width:"55"}),l(g,{prop:"group",label:"分组名",sortable:""}),l(g,{fixed:"right",label:"操作",width:"120"},{default:t(a=>{var b,T;return[$(l(n,{type:"primary",size:"small",link:"",icon:V(al),onClick:ee=>Fe(a.row)},null,8,["icon","onClick"]),[[D,`${(b=V(k).name)==null?void 0:b.replace("_info","")}:edit`]]),$(l(n,{type:"danger",link:"",size:"small",icon:V(ol),onClick:ee=>Oe(a.row)},null,8,["icon","onClick"]),[[D,`${(T=V(k).name)==null?void 0:T.replace("_info","")}:delete`]])]}),_:1})]),_:1},8,["data"])])]),_:1},8,["modelValue"]),l(G,{modelValue:z.value,"onUpdate:modelValue":e[20]||(e[20]=a=>z.value=a),title:L.value=="add"?"新增链接":"编辑链接",width:"600px"},{default:t(()=>[l(me,{model:s,class:"portal-form","label-position":"right","label-width":"80px",ref:"portalForm","status-icon":""},{default:t(()=>[l(C,{gutter:20},{default:t(()=>[l(w,{span:12},{default:t(()=>[l(f,{label:"名称",prop:"name",rules:[{required:!0,message:"请输入名称",trigger:"blur"}]},{default:t(()=>[l(y,{modelValue:s.name,"onUpdate:modelValue":e[10]||(e[10]=a=>s.name=a),placeholder:"请输入名称",clearable:""},null,8,["modelValue"])]),_:1})]),_:1}),l(w,{span:12},{default:t(()=>[l(f,{label:"链接地址",prop:"url",rules:[{required:!0,message:"请输入链接地址",trigger:"blur"}]},{default:t(()=>[l(y,{modelValue:s.url,"onUpdate:modelValue":e[11]||(e[11]=a=>s.url=a),placeholder:"请输入链接地址",clearable:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(C,{gutter:20},{default:t(()=>[l(w,{span:12},{default:t(()=>[l(f,{label:"分组",prop:"group",rules:[{required:!0,message:"请选择分组",trigger:"change"}]},{default:t(()=>[l(I,{modelValue:s.group,"onUpdate:modelValue":e[12]||(e[12]=a=>s.group=a),filterable:"",placeholder:"请选择分组",style:{width:"100%"}},{default:t(()=>[(c(!0),M(R,null,le(A.value,a=>(c(),x(F,{key:a.id,label:a.group,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1}),l(w,{span:12},{default:t(()=>[l(f,{label:"共享类型",prop:"sharing_type",rules:[{required:!0,message:"请选择共享类型",trigger:"change"}]},{default:t(()=>[l(I,{modelValue:s.sharing_type,"onUpdate:modelValue":e[13]||(e[13]=a=>s.sharing_type=a),placeholder:"请选择共享类型",style:{width:"100%"}},{default:t(()=>[l(F,{label:"公共",value:"public"}),l(F,{label:"私人",value:"private"})]),_:1},8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(C,{gutter:20},{default:t(()=>[l(w,{span:12},{default:t(()=>[l(f,{label:"用户名",prop:"username"},{default:t(()=>[l(y,{modelValue:s.username,"onUpdate:modelValue":e[14]||(e[14]=a=>s.username=a),placeholder:"请输入用户名",clearable:""},null,8,["modelValue"])]),_:1})]),_:1}),l(w,{span:12},{default:t(()=>[l(f,{label:"密码",prop:"password"},{default:t(()=>[l(y,{modelValue:s.password,"onUpdate:modelValue":e[15]||(e[15]=a=>s.password=a),placeholder:"请输入密码",clearable:"","show-password":""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(C,{gutter:20},{default:t(()=>[l(w,{span:12},{default:t(()=>[l(f,{label:"排序",prop:"sort"},{default:t(()=>[l(Ie,{modelValue:s.sort,"onUpdate:modelValue":e[16]||(e[16]=a=>s.sort=a),"controls-position":"right",min:0,style:{width:"100%"}},null,8,["modelValue"])]),_:1})]),_:1}),l(w,{span:12},{default:t(()=>[l(f,{label:"跳转方式",prop:"target"},{default:t(()=>[l(Z,{modelValue:s.target,"onUpdate:modelValue":e[17]||(e[17]=a=>s.target=a),class:"ml-2","inline-prompt":"",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},"active-text":"新窗口","inactive-text":"当前窗口"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(C,{gutter:20},{default:t(()=>[l(w,{span:24},{default:t(()=>[l(f,{label:"描述",prop:"describe"},{default:t(()=>[l(y,{modelValue:s.describe,"onUpdate:modelValue":e[18]||(e[18]=a=>s.describe=a),placeholder:"请输入描述",clearable:"",type:"textarea",autosize:{minRows:2,maxRows:4}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(C,{gutter:20},{default:t(()=>[l(w,{span:12},{default:t(()=>[l(f,{label:"状态",prop:"status"},{default:t(()=>[l(Z,{modelValue:s.status,"onUpdate:modelValue":e[19]||(e[19]=a=>s.status=a),class:"ml-2","inline-prompt":"",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},"active-text":"启用","inactive-text":"禁用"},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),l(C,{style:{"justify-content":"flex-end","margin-top":"20px"}},{default:t(()=>[l(f,null,{default:t(()=>[l(n,{onClick:ze},{default:t(()=>[...e[37]||(e[37]=[d("取消",-1)])]),_:1}),l(n,{type:"primary",onClick:Se},{default:t(()=>[...e[38]||(e[38]=[d(" 确定",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"]),l(G,{modelValue:W.value,"onUpdate:modelValue":e[22]||(e[22]=a=>W.value=a),title:"导入",width:"600px"},{default:t(()=>[l(Ke,{class:"upload-demo",drag:"",action:"",ref_key:"refUpload",ref:we,headers:ne,"http-request":Ae,"file-list":re.value,"before-upload":qe,limit:be.value,"show-file-list":""},{tip:t(()=>[h("div",cl,[e[40]||(e[40]=h("div",null,"只支持从此系统下载的模板导入，请按下方按钮下载模板!",-1)),l(n,{link:"",type:"primary",onClick:e[21]||(e[21]=a=>se())},{default:t(()=>[...e[39]||(e[39]=[d(" 下载模板 ",-1)])]),_:1})])]),default:t(()=>[l(Re,{class:"el-icon--upload"},{default:t(()=>[l(Ge)]),_:1}),e[41]||(e[41]=h("div",{class:"el-upload__text"},[d("拖拽文件到此或者 "),h("em",null,"点击上传文件")],-1))]),_:1},8,["headers","file-list","limit"])]),_:1},8,["modelValue"])],64)}}}),vl=Qe(fl,[["__scopeId","data-v-21f77ddc"]]);export{vl as default};
