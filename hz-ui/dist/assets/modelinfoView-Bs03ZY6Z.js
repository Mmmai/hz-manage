import{d as he,g as Re,u as qe,h as Ee,ap as al,r as m,A as oe,a as be,e as d,ag as Se,c as N,o as b,a7 as W,i as U,b as e,w as t,a8 as te,D as L,v as q,aA as sl,k as y,t as H,aa as M,F as Ge,as as We,ah as He,ai as Pe,ab as ne,al as v,I as pe,s as $e,_ as Ke,an as nl,f as dl,q as il,am as ul,aW as rl,a9 as ml}from"./index-Gch8CQn_.js";import{i as pl}from"./iconSelectCom-DSFb2qQ2.js";import{u as cl}from"./tabs-DpYZ4B-Q.js";import{l as Qe}from"./vue-draggable-plus-DEv7jPz0.js";import{u as fl}from"./ci-e_cgVoUj.js";const vl={class:"operation_show"},_l={class:"dialog-footer"},bl={class:"demo-drawer__content"},gl={style:{float:"left"}},yl={style:{float:"right",color:"var(--el-text-color-secondary)","font-size":"13px"}},wl={class:"demo-drawer__footer"},Cl=he({__name:"ciModelField",props:{ciModelInfo:{},ciModelInfoModifiers:{}},emits:["update:ciModelInfo"],setup(ge,{expose:B}){const{proxy:k}=Re(),I=qe(),F=Ee(),x=al(ge,"ciModelInfo"),O=m([]),ae=m([]),de=m([]),E=oe(()=>{let o=[];return O.value.forEach(l=>{l.fields.forEach(p=>{p.type==="model_ref"&&o.push(p.ref_model)})}),o}),h=oe(()=>{var l;let o=[];return(l=de.value)==null||l.forEach(p=>{p.id!==x.value.id&&(E.value.indexOf(p.id)===-1?o.push({value:p.id,label:p.verbose_name,disabled:!1}):o.push({value:p.id,label:p.verbose_name,disabled:!0}))}),o}),D=()=>{s.default="",s.validation_rule="",s.type=="boolean"?s.default=!0:s.type=="enum"?w.value=!0:s.type=="string"&&(w.value=!1)},z=m([]),$=o=>{let l=JSON.parse(ie.value[o].rule),p=[];Object.keys(l).forEach(g=>{p.push({value:g,label:l[g]})}),z.value=p},P=o=>{let l=JSON.parse(ie.value[o].rule),p=[];Object.keys(l).forEach(g=>{p.push({value:g,label:l[g]})}),z.value=p,s.default!=z.value[0].value&&(s.default=z.value[0].value)},w=m(!1),_=oe(()=>s.type==="fromModel"),K=m([]),Y=async(o=null)=>{let l=await k.$api.getValidationRules({page:1,page_size:1e4,...o});K.value=l.data.results,l.data.results.forEach(p=>{ie.value[p.id]=p})},ie=m({}),se=oe(()=>{let o=[];return K.value.forEach(l=>{l.field_type==s.type&&o.push({value:l.id,label:l.verbose_name})}),o}),c=async()=>{let o=await k.$api.getCiModel(F.query,F.query.id);x.value=o.data.model,O.value=o.data.field_groups,ae.value=o.data.field_groups.map(l=>l.name)},i=m([]),n=m([]);B({getModelField:c,getCiModelList:async()=>{let o=await k.$api.getCiModel();de.value=o.data.results},getRules:Y,getModelFieldType:async()=>{let o=await k.$api.getCiModelFieldType(),l=o.data.field_types;Object.keys(l).forEach(p=>{i.value.push({value:p,label:l[p]})}),n.value=o.data.limit_fields}});const S=be({name:"",verbose_name:""}),ye=(o,l,p)=>{console.log(l),n.value.includes(l)?p(new Error(`${n.value.join(",")}不能用!`)):p()},ce=be({name:[{required:!0,message:"请输入唯一标识",trigger:"blur"},{pattern:/^[a-z][\w\d]{4,20}$/,trigger:"blur",message:"以英文字符开头,可以使用英文,数字,下划线,长度4-20 "}],verbose_name:[{required:!0,message:"请输入组名称",trigger:"blur"}]}),re=m(),Q=m(!1),fe=o=>{Q.value=!1,le(o)},r=m(!1),u=m(""),me=async o=>{o&&await o.validate(async(l,p)=>{if(l)if(r.value){console.log(S);let g=await k.$api.addCiModelFieldGroup({model:x.value.id,create_user:I.state.username,update_user:I.state.username,...S});console.log(g),g.status=="201"?(v({type:"success",message:"添加成功"}),Q.value=!1,le(o),c()):v({showClose:!0,message:"添加失败:"+JSON.stringify(g.data),type:"error"})}else{let g=await k.$api.updateCiModelFieldGroup({id:u.value,update_user:I.state.username,...S});console.log(g),g.status=="200"?(v({type:"success",message:"更新成功"}),Q.value=!1,le(o),c()):v({showClose:!0,message:"更新失败:"+JSON.stringify(g.data),type:"error"})}else console.log("error submit!",p)})},R=o=>{pe.confirm("是否确认关闭?").then(()=>{o(),le(re.value)}).catch(()=>{})},f=m("新增"),J=o=>{f.value="新增",$e(()=>{}),Q.value=!0,r.value=!0},ue=o=>{f.value="修改",Q.value=!0,$e(()=>{r.value=!1,S.name=o.name,S.verbose_name=o.verbose_name,u.value=o.id})},Ue=o=>{pe.confirm("是否确认删除?","删除组",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{let l=await k.$api.deleteCiModelFieldGroup(o);l.status==204||l.status==200?(v({type:"success",message:"删除成功"}),await c()):v({type:"error",message:"删除失败"})}).catch(()=>{v({type:"info",message:"取消删除"})})},Z=m(!1),s=be({name:"",verbose_name:"",type:"string",required:!1,editable:!0,validation_rule:"",ref_model:"",description:"",default:"",unit:""}),Ne=be({name:[{required:!0,message:"请输入唯一标识",trigger:"blur"},{pattern:/^[a-z][\w\d]{1,20}$/,trigger:"blur",message:"以英文字符开头,可以使用英文,数字,下划线,长度2-20 ",required:!0},{validator:ye,trigger:"blur"}],verbose_name:[{required:!0,message:"请输入字段显示名称",trigger:"blur"}],type:[{required:!0,message:"字段类型",trigger:"blur"}],model_name:[{required:_,message:"请选择模型",trigger:"blur"}],validation_rule:[{required:w,message:"选择校验规则",trigger:""}]}),ve=m();m(!1);const ee=m(!1),X=m({}),Ve=m(!0),Te=o=>{Z.value=!0,f.value="修改",ee.value=!0,X.value=o,Ve.value=!1,$e(()=>{Object.keys(o).forEach(l=>{s.hasOwnProperty(l)&&(s[l]=o[l])}),s.validation_rule===null?w.value=!1:w.value=!0})},je=o=>{le(o),console.log(s),Z.value=!1},Le=o=>{f.value="新增",X.value={},Z.value=!0,Ve.value=!0,ee.value=!1,w.value=!1,$e(()=>{u.value=o.id})},Ie=async o=>{o&&await o.validate(async(l,p)=>{if(l)if(Ve.value){let g=await k.$api.addCiModelField({model:x.value.id,model_field_group:u.value,create_user:I.state.username,update_user:I.state.username,...s});console.log(g),g.status=="201"?(v({type:"success",message:"添加成功"}),Z.value=!1,le(o),c()):v({showClose:!0,message:"添加失败:"+JSON.stringify(g.data),type:"error"})}else{w.value||(s.validation_rule="");let g=await k.$api.updateCiModelField({id:X.value.id,update_user:I.state.username,...s});console.log(g),g.status=="200"?(v({type:"success",message:"更新成功"}),Z.value=!1,le(o),c()):v({showClose:!0,message:"更新失败:"+JSON.stringify(g.data),type:"error"})}else console.log("error submit!",p)})},V=o=>{pe.confirm("是否确认关闭?").then(()=>{o(),le(ve.value),Z.value=!1}).catch(()=>{})},we=o=>{pe.confirm("是否确认删除?","删除组",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await k.$api.deleteCiModelField(X.value.id)).status==204?(v({type:"success",message:"删除成功"}),await c(),le(ve.value),Z.value=!1):v({type:"error",message:"删除失败"})}).catch(()=>{v({type:"info",message:"取消删除"})})},le=o=>{o&&o.resetFields()},Xe=async(o,l)=>{if(o.oldIndex==o.newIndex)return;if(o.pullMode){console.log("跨组移动，在onAdd中触发");return}let p=await k.$api.updateCiModelField({id:o.data.id,order:o.newIndex+1});p.status=="200"?v({type:"success",message:"更新排序成功"}):v({showClose:!0,message:"更新排序失败:"+JSON.stringify(p.data),type:"error"}),c()},Ye=async(o,l)=>{let p=await k.$api.updateCiModelField({id:o.data.id,order:o.newIndex+1,model_field_group:l.id});p.status=="200"?v({type:"success",message:"更新排序成功"}):v({showClose:!0,message:"更新排序失败:"+JSON.stringify(p.data),type:"error"}),c()};return(o,l)=>{const p=d("el-text"),g=d("el-button"),Fe=d("el-tooltip"),Ze=d("el-space"),Ae=d("el-col"),De=d("el-row"),ze=d("el-card"),el=d("el-collapse-item"),ll=d("el-collapse"),Ce=d("el-input"),G=d("el-form-item"),Je=d("el-form"),tl=d("el-dialog"),Oe=d("el-switch"),Me=d("el-option"),ke=d("el-select"),ol=d("el-drawer"),_e=Se("permission");return b(),N(W,null,[U("div",null,[e(ll,{modelValue:ae.value,"onUpdate:modelValue":l[0]||(l[0]=C=>ae.value=C)},{default:t(()=>[(b(!0),N(W,null,te(O.value,(C,xe)=>(b(),L(el,{name:C.name,key:xe},{title:t(()=>[e(p,{tag:"b",size:"large"},{default:t(()=>[y(H(C.verbose_name),1)]),_:2},1024),U("div",vl,[C.built_in?Ge("",!0):(b(),L(Ze,{key:0},{default:t(()=>{var a;return[M((b(),L(Fe,{class:"box-item",effect:"dark",content:"编辑",placement:"top"},{default:t(()=>{var j;return[M(e(g,{size:"small",onClick:We(Be=>ue(C),["stop"]),icon:q(He),circle:""},null,8,["onClick","icon"]),[[_e,`${(j=q(F).name)==null?void 0:j.replace("_info","")}:edit`]])]}),_:2},1024)),[[_e,`${(a=q(F).name)==null?void 0:a.replace("_info","")}:edit`]]),e(Fe,{class:"box-item",effect:"dark",content:"删除",placement:"top"},{default:t(()=>{var j;return[M(e(g,{size:"small",onClick:We(Be=>Ue(C.id),["stop"]),icon:q(Pe),circle:""},null,8,["onClick","icon"]),[[_e,`${(j=q(F).name)==null?void 0:j.replace("_info","")}:delete`]])]}),_:2},1024)]}),_:2},1024))])]),default:t(()=>[U("div",null,[e(q(Qe),{"force-fallback":!0,"scroll-sensitivity":200,ref_for:!0,ref:"el",group:"modelField",modelValue:C.fields,"onUpdate:modelValue":a=>C.fields=a,onEnd:a=>Xe(a,C),onAdd:a=>Ye(a,C),style:{width:"100%","flex-wrap":"wrap",display:"flex",gap:"10px","justify-items":"flex-start"}},{default:t(()=>{var a;return[(b(!0),N(W,null,te(C.fields,(j,Be)=>(b(),N("div",{key:Be},[e(Fe,{effect:"light",content:"点击编辑字段",placement:"top"},{default:t(()=>[e(ze,{shadow:"hover",class:sl(["modelFieldCard",j.built_in?"isBuiltClass":""]),onClick:Nl=>Te(j)},{default:t(()=>[e(p,{tag:"b"},{default:t(()=>[y(H(j.verbose_name),1)]),_:2},1024),e(De,{justify:"space-between"},{default:t(()=>[e(Fe,{class:"box-item",effect:"light",content:j.name,placement:"bottom"},{default:t(()=>[e(Ae,{span:13,class:"describe-class"},{default:t(()=>[e(p,null,{default:t(()=>[y(H(j.name),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["content"]),e(Fe,{class:"box-item",effect:"light",content:j.type,placement:"bottom"},{default:t(()=>[e(Ae,{span:10,class:"describe-class"},{default:t(()=>[e(p,null,{default:t(()=>[y(H(j.type),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["content"])]),_:2},1024)]),_:2},1032,["class","onClick"])]),_:2},1024)]))),128)),U("div",null,[M((b(),L(ze,{class:"modelFieldCard",style:{"align-items":"center","justify-content":"center"},onClick:j=>Le(C)},{default:t(()=>[e(p,{type:"primary"},{default:t(()=>l[26]||(l[26]=[y("+ 添加字段")])),_:1})]),_:2},1032,["onClick"])),[[_e,`${(a=q(F).name)==null?void 0:a.replace("_info","")}:add`]])])]}),_:2},1032,["modelValue","onUpdate:modelValue","onEnd","onAdd"])])]),_:2},1032,["name"]))),128))]),_:1},8,["modelValue"]),e(De,{style:{"margin-top":"10px"}},{default:t(()=>[e(Ae,null,{default:t(()=>{var C;return[M((b(),L(g,{bg:"",text:"",onClick:l[1]||(l[1]=xe=>J(x.value))},{default:t(()=>l[27]||(l[27]=[y("添加分组")])),_:1})),[[_e,`${(C=q(F).name)==null?void 0:C.replace("_info","")}:add`]])]}),_:1})]),_:1})]),e(tl,{modelValue:Q.value,"onUpdate:modelValue":l[6]||(l[6]=C=>Q.value=C),title:f.value+"字段分组",width:"500","before-close":R},{footer:t(()=>[U("div",_l,[e(g,{onClick:l[4]||(l[4]=C=>fe(re.value))},{default:t(()=>l[28]||(l[28]=[y("取消")])),_:1}),e(g,{type:"primary",onClick:l[5]||(l[5]=C=>me(re.value))},{default:t(()=>l[29]||(l[29]=[y(" 确认 ")])),_:1})])]),default:t(()=>[e(Je,{ref_key:"groupFormRef",ref:re,style:{"max-width":"600px"},model:S,rules:ce,"label-width":"auto",class:"demo-modelForm","status-icon":""},{default:t(()=>[e(G,{label:"字段组标识",prop:"name"},{default:t(()=>[e(Ce,{modelValue:S.name,"onUpdate:modelValue":l[2]||(l[2]=C=>S.name=C),disabled:!r.value},null,8,["modelValue","disabled"])]),_:1}),e(G,{label:"字段分组名称",prop:"verbose_name"},{default:t(()=>[e(Ce,{modelValue:S.verbose_name,"onUpdate:modelValue":l[3]||(l[3]=C=>S.verbose_name=C)},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"]),e(ol,{modelValue:Z.value,"onUpdate:modelValue":l[25]||(l[25]=C=>Z.value=C),title:"模型字段","before-close":V,direction:"rtl",class:"demo-drawer"},{default:t(()=>{var C,xe;return[U("div",bl,[e(Je,{model:s,ref_key:"modelFieldFormRef",ref:ve,"label-width":"auto","label-position":"right",rules:Ne},{default:t(()=>[e(G,{label:"唯一标识",prop:"name"},{default:t(()=>[e(Ce,{modelValue:s.name,"onUpdate:modelValue":l[7]||(l[7]=a=>s.name=a),autocomplete:"off",disabled:!!(X.value.built_in||ee.value)},null,8,["modelValue","disabled"])]),_:1}),e(G,{label:"显示名称",prop:"verbose_name"},{default:t(()=>[e(Ce,{modelValue:s.verbose_name,"onUpdate:modelValue":l[8]||(l[8]=a=>s.verbose_name=a),autocomplete:"off"},null,8,["modelValue"])]),_:1}),e(G,{label:"可编辑",prop:"editable"},{default:t(()=>[e(Oe,{modelValue:s.editable,"onUpdate:modelValue":l[9]||(l[9]=a=>s.editable=a),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},disabled:X.value.built_in},null,8,["modelValue","disabled"])]),_:1}),e(G,{label:"必填",prop:"required"},{default:t(()=>[e(Oe,{modelValue:s.required,"onUpdate:modelValue":l[10]||(l[10]=a=>s.required=a),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"}},null,8,["modelValue"])]),_:1}),e(G,{label:"字段类型",prop:"type"},{default:t(()=>[e(ke,{modelValue:s.type,"onUpdate:modelValue":l[11]||(l[11]=a=>s.type=a),placeholder:"Select",style:{width:"240px"},onChange:D,disabled:!!(X.value.built_in||ee.value)},{default:t(()=>[(b(!0),N(W,null,te(i.value,a=>(b(),L(Me,{key:a.value,label:a.label,value:a.value},{default:t(()=>[U("span",gl,H(a.label),1),U("span",yl,H(a.value),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),M(e(G,{label:"校验规则",prop:"validation_rule"},{default:t(()=>[e(Oe,{modelValue:w.value,"onUpdate:modelValue":l[12]||(l[12]=a=>w.value=a),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949","margin-right":"10px"}},null,8,["modelValue"]),M(e(ke,{modelValue:s.validation_rule,"onUpdate:modelValue":l[13]||(l[13]=a=>s.validation_rule=a),placeholder:"选择校验规则",style:{width:"240px"}},{default:t(()=>[(b(!0),N(W,null,te(se.value,a=>(b(),L(Me,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),[[ne,w.value]])]),_:1},512),[[ne,s.type==="string"]]),M(e(G,{label:"枚举值",prop:"validation_rule"},{default:t(()=>[e(ke,{modelValue:s.validation_rule,"onUpdate:modelValue":l[14]||(l[14]=a=>s.validation_rule=a),placeholder:"选择校验规则",style:{width:"240px"},onChange:l[15]||(l[15]=a=>P(s.validation_rule))},{default:t(()=>[(b(!0),N(W,null,te(se.value,a=>(b(),L(Me,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},512),[[ne,s.type==="enum"]]),M(e(G,{label:"默认值",prop:"default"},{default:t(()=>[e(ke,{modelValue:s.default,"onUpdate:modelValue":l[16]||(l[16]=a=>s.default=a),placeholder:"选择默认值",size:"large",onVisibleChange:l[17]||(l[17]=a=>$(s.validation_rule))},{default:t(()=>[(b(!0),N(W,null,te(z.value,(a,j)=>(b(),L(Me,{key:j,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},512),[[ne,s.type==="enum"]]),M(e(G,{label:"模型引用",prop:"ref_model"},{default:t(()=>[e(ke,{modelValue:s.ref_model,"onUpdate:modelValue":l[18]||(l[18]=a=>s.ref_model=a),placeholder:"选择CI模型",disabled:!!(X.value.built_in||ee.value)},{default:t(()=>[(b(!0),N(W,null,te(h.value,a=>(b(),L(Me,{key:a.value,label:a.label,disabled:a.disabled,value:a.value},null,8,["label","disabled","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1},512),[[ne,s.type==="model_ref"]]),M(e(G,{label:"默认值",prop:"default"},{default:t(()=>[e(Oe,{modelValue:s.default,"onUpdate:modelValue":l[19]||(l[19]=a=>s.default=a),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"}},null,8,["modelValue"])]),_:1},512),[[ne,s.type==="boolean"]]),M(e(G,{label:"单位",prop:"unit"},{default:t(()=>[e(Ce,{modelValue:s.unit,"onUpdate:modelValue":l[20]||(l[20]=a=>s.unit=a),style:{width:"120px"}},null,8,["modelValue"])]),_:1},512),[[ne,s.type==="integer"||s.type==="float"]]),e(G,{label:"描述",prop:"description"},{default:t(()=>[e(Ce,{modelValue:s.description,"onUpdate:modelValue":l[21]||(l[21]=a=>s.description=a),type:"textarea"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),U("div",wl,[e(g,{onClick:l[22]||(l[22]=a=>je(ve.value))},{default:t(()=>l[30]||(l[30]=[y("取消")])),_:1}),ee.value&&!X.value.built_in?M((b(),L(g,{key:0,type:"danger",onClick:l[23]||(l[23]=a=>we())},{default:t(()=>l[31]||(l[31]=[y("删除")])),_:1})),[[_e,`${(C=q(F).name)==null?void 0:C.replace("_info","")}:delete`]]):Ge("",!0),M((b(),L(g,{type:"primary",onClick:l[24]||(l[24]=a=>Ie(ve.value))},{default:t(()=>l[32]||(l[32]=[y(" 确定 ")])),_:1})),[[_e,`${(xe=q(F).name)==null?void 0:xe.replace("_info","")}:edit`]])])])]}),_:1},8,["modelValue"])],64)}}}),Vl=Ke(Cl,[["__scopeId","data-v-9d0d5824"]]),Fl={style:{width:"100%"}},Ml={class:"table-header"},kl={class:"header-button-lf"},xl={class:"dialog-footer"},$l=he({__name:"ciModelUnique",props:["modelId","modelFieldLists"],setup(ge,{expose:B}){const k=Ee(),{proxy:I}=Re(),F=qe(),x=m([]),O=ge,ae=()=>{D.value=!0,$.value=!0};oe(()=>{let i={};return O.modelFieldLists.forEach(n=>{i[n.name]=n.verbose_name}),i});const de=oe(()=>{let i={};return O.modelFieldLists.forEach(n=>{i[n.id]=n.verbose_name}),i}),E=m(""),h=be({fields:[],validate_null:!1,description:null}),D=m(!1),z=()=>{D.value=!1,_(E.value)},$=m(!0),P=m({}),w=i=>{P.value=i,D.value=!0,$.value=!1,$e(()=>{Object.keys(i).forEach(n=>{n!=="id"&&Object.keys(h).indexOf(n)!==-1&&(h[n]=i[n])})})},_=i=>{i&&(i.resetFields(),P.value={})},K=async i=>{await i.validate(async(n,A)=>{if(n)if($.value){let T=await I.$api.addCiModelUnique({create_user:F.state.username,update_user:F.state.username,...h,model:O.modelId});T.status=="201"?(v({type:"success",message:"添加成功"}),D.value=!1,_(i),c({model:O.modelId})):v({showClose:!0,message:"添加失败:"+JSON.stringify(T.data),type:"error"})}else{let T=await I.$api.updateCiModelUnique({id:P.value.id,update_user:F.state.username,...h});T.status=="200"?(v({type:"success",message:"更新成功"}),D.value=!1,_(i),c({model:O.modelId})):v({showClose:!0,message:"更新失败:"+JSON.stringify(T.data),type:"error"})}})},Y=async i=>{let n=await I.$api.updateCiModelUnique({update_user:F.state.username,...i});n.status=="200"?(v({type:"success",message:"更新成功"}),_(E.value),c({model:O.modelId})):v({showClose:!0,message:"更新失败:"+JSON.stringify(n.data),type:"error"})},ie=i=>{pe.confirm("是否确认删除?","删除",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await I.$api.deleteCiModelUnique(i)).status==204?(v({type:"success",message:"删除成功"}),c({model:O.modelId}),_(E.value),D.value=!1):v({type:"error",message:"删除失败"})}).catch(()=>{v({type:"info",message:"取消删除"})})},se=oe(()=>{let i={};return x.value.forEach(n=>{var T;let A=n.fields.map(S=>de.value[S]);i[(T=n.fields)==null?void 0:T.join("+")]=A.join("+")}),i}),c=async i=>{let n=await I.$api.getCiModelUnique(i);x.value=n.data.results};return B({getTableData:c}),(i,n)=>{const A=d("el-button"),T=d("el-table-column"),S=d("el-switch"),ye=d("el-tooltip"),ce=d("el-table"),re=d("el-option"),Q=d("el-select"),fe=d("el-form-item"),r=d("el-input"),u=d("el-form"),me=d("el-dialog"),R=Se("permission");return b(),N("div",Fl,[U("div",Ml,[U("div",kl,[e(A,{type:"primary",onClick:ae},{default:t(()=>n[5]||(n[5]=[y("添加")])),_:1})])]),e(ce,{ref:"multipleTableRef",data:x.value,style:{width:"100%"},border:""},{default:t(()=>[e(T,{prop:"fields",label:"校验规则"},{default:t(f=>[U("span",null,H(se.value[f.row.fields.join("+")]),1)]),_:1}),e(T,{prop:"validate_null",label:"空值校验"},{default:t(f=>{var J;return[M(e(S,{modelValue:f.row.validate_null,"onUpdate:modelValue":ue=>f.row.validate_null=ue,class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},onChange:ue=>Y({id:f.row.id,validate_null:f.row.validate_null}),disabled:f.row.built_in},null,8,["modelValue","onUpdate:modelValue","onChange","disabled"]),[[R,{id:`${(J=q(k).name)==null?void 0:J.replace("_info","")}:edit`,action:"disabled"}]])]}),_:1}),e(T,{prop:"description",label:"描述"}),e(T,{fixed:"right",width:"100",label:"操作"},{default:t(f=>[e(ye,{class:"box-item",effect:"dark",content:"编辑",placement:"top"},{default:t(()=>{var J;return[M(e(A,{link:"",type:"primary",icon:q(He),onClick:ue=>w(f.row)},null,8,["icon","onClick"]),[[R,`${(J=q(k).name)==null?void 0:J.replace("_info","")}:edit`]])]}),_:2},1024),e(ye,{class:"box-item",effect:"dark",content:"删除",placement:"top"},{default:t(()=>{var J;return[M(e(A,{link:"",type:"danger",icon:q(Pe),disabled:f.row.built_in,onClick:ue=>ie(f.row.id)},null,8,["icon","disabled","onClick"]),[[R,`${(J=q(k).name)==null?void 0:J.replace("_info","")}:delete`]])]}),_:2},1024)]),_:1})]),_:1},8,["data"]),e(me,{modelValue:D.value,"onUpdate:modelValue":n[4]||(n[4]=f=>D.value=f),title:"唯一校验配置",width:"500","before-close":z},{footer:t(()=>[U("div",xl,[e(A,{onClick:z},{default:t(()=>n[6]||(n[6]=[y("取消")])),_:1}),e(A,{type:"primary",onClick:n[3]||(n[3]=f=>K(E.value))},{default:t(()=>n[7]||(n[7]=[y(" 提交 ")])),_:1})])]),default:t(()=>[e(u,{inline:!0,"label-position":"right",model:h,"label-width":"auto",ref_key:"formRef",ref:E},{default:t(()=>[e(fe,{label:"唯一校验组合",prop:"fields"},{default:t(()=>[e(Q,{modelValue:h.fields,"onUpdate:modelValue":n[0]||(n[0]=f=>h.fields=f),fields:"选择字段组合",multiple:"","multiple-limit":5,clearable:"",filterable:"",style:{width:"240px"},disabled:!!P.value.built_in},{default:t(()=>[(b(!0),N(W,null,te(O.modelFieldLists,(f,J)=>(b(),L(re,{label:f.verbose_name,value:f.id,key:J},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),e(fe,{label:"空置校验",prop:"validate_null"},{default:t(()=>[e(S,{modelValue:h.validate_null,"onUpdate:modelValue":n[1]||(n[1]=f=>h.validate_null=f),class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},disabled:P.value.built_in},null,8,["modelValue","disabled"])]),_:1}),e(fe,{label:"描述",prop:"description"},{default:t(()=>[e(r,{modelValue:h.description,"onUpdate:modelValue":n[2]||(n[2]=f=>h.description=f),style:{width:"240px"},autosize:{minRows:2,maxRows:4},type:"textarea"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Ul={class:"card"},Il={class:"listItem"},Ol={style:{display:"flex","flex-direction":"row","justify-content":"center","align-items":"center"}},hl=he({__name:"ciModelTemplateName",props:["modelId","modelFieldLists","ciModelInfo"],setup(ge,{expose:B}){const{proxy:k}=Re();qe();const I=ge,F=m(!1),x=m([]),O=w=>{},ae=oe(()=>I.modelFieldLists.filter(w=>["string","enum","model_ref"].includes(w.type))),de=oe(()=>{let w=new Object;return I.modelFieldLists.forEach(_=>{w[_.id]=_}),w}),E=()=>{},h=()=>{F.value=!0},D=()=>{F.value=!1},z=async()=>{let w=await k.$api.updateInstanceName(I.modelId);console.log(w),nl({title:"Success",message:"更新任务提交成功",type:"success"})};m(0);const $=async()=>{let w=await k.$api.updateCiModel({id:I.modelId,instance_name_template:x.value});w.status=="200"?(v({type:"success",message:"更新成功"}),pe.confirm("更新成功，是否自动更新实例唯一标识?","Warning",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{z()}).catch(()=>{v({type:"info",message:"Delete canceled"})}),F.value=!1,P()):v({showClose:!0,message:"更新失败:"+JSON.stringify(w.data),type:"error"})},P=async()=>{let w=await k.$api.getCiModel(null,I.modelId);x.value=w.data.model.instance_name_template};return B({getModel:P}),(w,_)=>{const K=d("el-button"),Y=d("el-divider"),ie=d("el-checkbox"),se=d("el-checkbox-group"),c=Se("throttle");return b(),N(W,null,[_[9]||(_[9]=U("div",null,null,-1)),U("div",Ul,[M(e(K,{type:"primary",onClick:h},{default:t(()=>_[2]||(_[2]=[y("编辑")])),_:1},512),[[ne,!F.value]]),M((b(),L(K,{type:"primary",onClick:z},{default:t(()=>_[3]||(_[3]=[y("更新唯一标识")])),_:1})),[[c]]),M(e(K,{onClick:D},{default:t(()=>_[4]||(_[4]=[y("取消")])),_:1},512),[[ne,F.value]]),M(e(K,{type:"primary",onClick:$},{default:t(()=>_[5]||(_[5]=[y("保存")])),_:1},512),[[ne,F.value]]),e(Y,null,{default:t(()=>_[6]||(_[6]=[y("可选择指标")])),_:1}),e(se,{modelValue:x.value,"onUpdate:modelValue":_[0]||(_[0]=i=>x.value=i),onChange:O,max:5,disabled:!F.value},{default:t(()=>[(b(!0),N(W,null,te(ae.value,(i,n)=>(b(),L(ie,{key:n,label:i.verbose_name,value:i.id},{default:t(()=>[y(H(i.verbose_name),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),e(Y,null,{default:t(()=>_[7]||(_[7]=[y("拖拽调整顺序")])),_:1}),e(q(Qe),{disabled:!F.value,modelValue:x.value,"onUpdate:modelValue":_[1]||(_[1]=i=>x.value=i),"force-fallback":!0,"scroll-sensitivity":200,ref:"el",onEnd:E,style:{width:"100%",overflow:"auto"}},{default:t(()=>[(b(!0),N(W,null,te(x.value,(i,n)=>(b(),N("div",{key:n},[U("div",Il,[U("span",null,H(de.value[i].verbose_name),1)])]))),128))]),_:1},8,["disabled","modelValue"]),e(Y,null,{default:t(()=>_[8]||(_[8]=[y("效果预览")])),_:1}),U("div",Ol,[U("h3",null,H(x.value.map(i=>de.value[i].verbose_name).join(" - ")),1)])])],64)}}}),Rl={class:"card"},ql={class:"dialog-footer"},Sl=he({__name:"modelinfoView",setup(ge){const B=Ee(),k=cl(),I=fl(),F=()=>(I.setCiLastModel($.id),"/#/cmdb/cidata/"),x=m(""),O=m(""),ae=m("");dl();const de=qe(),{proxy:E}=Re();m("");const h=m([]),D=async()=>{let r=await E.$api.getCiModelGroup();console.log(r),h.value=r.data.results,console.log(h.value)},z=m({}),$=m({}),P=async()=>{let r=await E.$api.getCiModel(B.query,B.query.id);$.value=r.data.model,z.value=r.data,console.log($.value)},w=oe(()=>{var u;let r=new Array;return(u=z.value.field_groups)==null||u.forEach(me=>{me.fields.forEach(R=>{r.push(R)})}),r}),_=(r,u)=>{r.props.name==="verification"?x.value.getTableData({model:se.value}):r.props.name==="field"||r.props.name==="instance_name_temp"&&ae.value.getModel()},K=m("field");console.log(B);const Y=m(!1),ie=()=>{Y.value=!0};m("ElemeFilled");const se=oe(()=>{var r;return(r=$.value)==null?void 0:r.id}),c=be({name:"",verbose_name:"",model_group:"",icon:"ElemeFilled",built_in:!1,update_user:"admin"}),i=m(),n=be({name:[{required:!0,message:"请输入模型标识",trigger:"blur"},{pattern:/^[a-z][a-z_]{3,20}$/,trigger:"blur",message:"以英文字符开头,可以使用英文,下划线,长度3-20 ",required:!0}],verbose_name:[{required:!0,message:"请输入模型名称",trigger:"blur"}],model_group:[{required:!0,message:"请选择分组",trigger:"blur"}]});m(!1);const A=m(!1),T=r=>{A.value=!1,ce(r)},S=async r=>{r&&await r.validate(async(u,me)=>{if(u){let R=await E.$api.updateCiModel({id:Q.value,...c});console.log(R),R.status=="200"?(v({type:"success",message:"更新成功"}),A.value=!1,ce(r),getCiModelInfo(B.query,B.query.id)):v({showClose:!0,message:"添加失败:"+JSON.stringify(R.data),type:"error"})}})},ye=r=>{pe.confirm("是否确认关闭?").then(()=>{r(),ce(i.value)}).catch(()=>{})},ce=r=>{r&&r.resetFields()},re=r=>{pe.confirm("是否确认删除?","删除组",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await E.$api.deleteCiModel(r)).status==204?(v({type:"success",message:"删除成功"}),k.removeTabs(B.path,!0)):v({type:"error",message:"删除失败"})}).catch(()=>{v({type:"info",message:"取消删除"})})},Q=m(""),fe=r=>{console.log(r),c.icon=r.icon,c.verbose_name=r.verbose_name,c.name=r.name,c.model_group=r.model_group,c.update_user=de.state.username,console.log(c),A.value=!0,Q.value=r.id,D()};return il(async()=>{console.log("onMount"),await P(),await O.value.getModelField(),await O.value.getCiModelList(),await O.value.getRules(),await O.value.getModelFieldType()}),ul(()=>{console.log("onUnmounted")}),rl(()=>{console.log("onBeforeMount")}),(r,u)=>{const me=ml,R=d("el-button"),f=d("el-text"),J=d("el-link"),ue=d("el-space"),Ue=d("el-col"),Z=d("el-row"),s=d("el-tab-pane"),Ne=d("el-tabs"),ve=d("el-scrollbar"),ee=d("el-form-item"),X=d("el-input"),Ve=d("el-option"),Te=d("el-select"),je=d("el-form"),Le=d("el-dialog"),Ie=Se("permission");return b(),N(W,null,[U("div",Rl,[e(ve,null,{default:t(()=>[e(Z,{class:"cimodelinfo",justify:"space-between"},{default:t(()=>[e(Ue,{span:20},{default:t(()=>[e(ue,{size:30},{default:t(()=>[e(R,{size:"large",circle:"",disabled:"",style:{margin:"10px"}},{default:t(()=>{var V;return[e(me,{icon:(V=$.value)==null?void 0:V.icon},null,8,["icon"])]}),_:1}),e(f,null,{default:t(()=>[u[11]||(u[11]=y("唯一标识:   ")),e(f,{tag:"b"},{default:t(()=>[y(H($.value.name),1)]),_:1})]),_:1}),e(f,null,{default:t(()=>[u[12]||(u[12]=y("名称:   ")),e(f,{tag:"b"},{default:t(()=>[y(H($.value.verbose_name),1)]),_:1})]),_:1}),e(f,{style:{display:"flex"}},{default:t(()=>[u[13]||(u[13]=y("实例数:   ")),e(J,{type:"primary",tag:"b",href:F()},{default:t(()=>[y(H($.value.instance_count),1)]),_:1},8,["href"])]),_:1})]),_:1})]),_:1}),e(Ue,{span:2,style:{display:"flex","align-items":"center","justify-content":"center"}},{default:t(()=>[e(ue,{alignment:"flex-end"},{default:t(()=>{var V,we;return[M(e(R,{disabled:$.value.built_in,icon:"Delete",onClick:u[0]||(u[0]=le=>re($.value.id)),circle:""},null,8,["disabled"]),[[Ie,`${(V=q(B).name)==null?void 0:V.replace("_info","")}:delete`]]),M(e(R,{disabled:$.value.built_in,icon:"Edit",onClick:u[1]||(u[1]=le=>fe($.value)),circle:""},null,8,["disabled"]),[[Ie,`${(we=q(B).name)==null?void 0:we.replace("_info","")}:edit`]])]}),_:1})]),_:1})]),_:1}),e(Ne,{modelValue:K.value,"onUpdate:modelValue":u[2]||(u[2]=V=>K.value=V),type:"card",class:"demo-tabs",onTabClick:_},{default:t(()=>[e(s,{label:"模型字段",name:"field"},{default:t(()=>[e(Vl,{ref_key:"ciModelFieldRef",ref:O},null,512)]),_:1}),e(s,{label:"唯一校验",name:"verification"},{default:t(()=>[e($l,{modelId:se.value,modelFieldLists:w.value,ref_key:"ciModelUniqueRef",ref:x},null,8,["modelId","modelFieldLists"])]),_:1}),e(s,{label:"唯一标识命名",name:"instance_name_temp"},{default:t(()=>[e(hl,{modelId:se.value,ciModelInfo:$.value,modelFieldLists:w.value,ref_key:"ciModelTemplateRef",ref:ae},null,8,["modelId","ciModelInfo","modelFieldLists"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),e(Le,{modelValue:A.value,"onUpdate:modelValue":u[10]||(u[10]=V=>A.value=V),title:"编辑模型",width:"500","before-close":ye},{footer:t(()=>[U("div",ql,[e(R,{onClick:u[8]||(u[8]=V=>T(i.value))},{default:t(()=>u[14]||(u[14]=[y("取消")])),_:1}),e(R,{type:"primary",onClick:u[9]||(u[9]=V=>S(i.value))},{default:t(()=>u[15]||(u[15]=[y(" 确认 ")])),_:1})])]),default:t(()=>[e(je,{ref_key:"modelFormRef",ref:i,style:{"max-width":"600px"},model:c,rules:n,"label-width":"auto",class:"demo-modelForm","status-icon":""},{default:t(()=>[e(ee,{label:"模型图标",prop:"icon"},{default:t(()=>[e(R,{onClick:ie,icon:c.icon},null,8,["icon"]),e(pl,{isShow:Y.value,"onUpdate:isShow":u[3]||(u[3]=V=>Y.value=V),iconName:c.icon,"onUpdate:iconName":u[4]||(u[4]=V=>c.icon=V)},null,8,["isShow","iconName"])]),_:1}),e(ee,{label:"唯一标识",prop:"name"},{default:t(()=>[e(X,{modelValue:c.name,"onUpdate:modelValue":u[5]||(u[5]=V=>c.name=V),placeholder:"请输入模型的唯一标识",disabled:""},null,8,["modelValue"])]),_:1}),e(ee,{label:"模型名称",prop:"verbose_name"},{default:t(()=>[e(X,{modelValue:c.verbose_name,"onUpdate:modelValue":u[6]||(u[6]=V=>c.verbose_name=V)},null,8,["modelValue"])]),_:1}),e(ee,{label:"所属分组",prop:"model_group"},{default:t(()=>[e(Te,{modelValue:c.model_group,"onUpdate:modelValue":u[7]||(u[7]=V=>c.model_group=V),placeholder:"选择分组"},{default:t(()=>[(b(!0),N(W,null,te(h.value,(V,we)=>(b(),L(Ve,{label:V.verbose_name,value:V.id,key:we},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])],64)}}}),El=Ke(Sl,[["__scopeId","data-v-3c0ec0d0"]]);export{El as default};
