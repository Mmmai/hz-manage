import{d as ue,h as ce,r as s,g as me,a as D,q as pe,A as fe,z as _e,e as i,ak as P,c as L,o as y,i as p,b as t,ab as x,v as f,D as F,w as n,k as R,a7 as A,a8 as ve,al as ge,am as ye,aJ as be,aE as he,t as we,I,ap as d,s as K,_ as ke}from"./index-BGjJrjF8.js";const Ce={class:"card"},xe={class:"user-header"},Ve={style:{border:"1px solid var(--el-border-color)",width:"90%"}},$e=ue({__name:"roleView",setup(Fe){const V=ce(),M=s({}),{proxy:r}=me(),O=({tree_type:l},e)=>l==="menu"?"is-menu":l==="button"?"is-button":"";D({search:""});const J=s(!1),_=s([]),U=s("auto"),j=s([{prop:"role",label:"角色名"},{prop:"role_name",label:"角色名称"},{prop:"user_count",label:"用户数量"}]);s(0);const q=s({});pe(async()=>{await b(),te()});const b=async()=>{let l=await r.$api.getRole();_.value=l.data.results.map(e=>(e.userinfo_set=e.userinfo_set.length,e));for(let e in _.value){let c=_.value[e].role,g=_.value[e].id;q.value[g]=c}},z=l=>{M.value=l},u=s(!1),o=D({role:"",role_name:"",rolePermission:[]}),h=s("add"),W=()=>{h.value="add",u.value=!0},G=()=>{u.value=!1,r.$refs.userFrom.resetFields(),v([])},H=l=>{I.confirm("是否确认关闭?").then(()=>{r.$refs.userFrom.resetFields(),v([]),l()}).catch(()=>{})},Q=fe(()=>{let l=new Array;return m.value.getCheckedNodes().forEach(e=>{e.tree_type==="button"&&l.push(e.id)}),l}),X=()=>{o.rolePermission=Q.value,console.log(JSON.stringify(o)),r.$refs.userFrom.validate(async l=>{if(l)if(h.value=="add"){let e=await r.$api.roleadd(o);e.status==201?(u.value=!1,d({type:"success",message:"添加成功"}),r.$refs.userFrom.resetFields(),v([]),b(),console.log(m.value.getCheckedKeys())):d({showClose:!0,message:"添加失败:"+JSON.stringify(e.data),type:"error"})}else{let e=await r.$api.roleupdate({id:S.value.id,...o});console.log(e),e.status==200?(u.value=!1,r.$refs.userFrom.resetFields(),v([]),console.log(m.value.getCheckedKeys()),b(),d({type:"success",message:"更新成功"})):d({showClose:!0,message:"更新失败:"+JSON.stringify(e.data),type:"error"})}else d({showClose:!0,message:"请输入正确内容.",type:"error"})})},S=s({}),Y=l=>{console.log(l),h.value="edit",S.value=l,u.value=!0,K(()=>{Object.keys(o).forEach(e=>{o[e]=l[e]})}),v(l.rolePermission)},Z=l=>{I.confirm("是否确认删除?","Warning",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await r.$api.roledel(l.id)).status==204?(d({type:"success",message:"删除成功"}),await b(pageConfig)):d({type:"error",message:"删除失败"})}).catch(()=>{d({type:"info",message:"取消删除"})})},ee=s([]),le=(l,e)=>l.role!="sysadmin",ae=l=>{ee.value=l},m=s(),E=s([]),te=async()=>{let l=await r.$api.getPermissionToRole();console.log(l),E.value=l.data.results},v=l=>{K().then(()=>{m.value.setCheckedKeys(l,!1),console.log(m.value.getCheckedKeys())})},w=s(!1);return _e(()=>o.role,l=>{l=="sysadmin"?w.value=!0:w.value=!1}),(l,e)=>{var T;const c=i("el-button"),g=i("el-table-column"),oe=i("el-table"),N=i("el-input"),k=i("el-form-item"),se=i("el-row"),ne=i("el-form"),re=i("el-dialog"),$=P("permission"),ie=P("loading");return y(),L(A,null,[p("div",Ce,[p("div",xe,[p("div",null,[x((y(),F(c,{type:"primary",size:"small",onClick:W},{default:n(()=>e[4]||(e[4]=[R("新增")])),_:1})),[[$,`${(T=f(V).name)==null?void 0:T.replace("_info","")}:add`]])])]),p("div",null,[x((y(),F(oe,{border:"",data:_.value,style:{width:"100%"},"max-height":"500px","highlight-current-row":"","table-layout":U.value,onSelectionChange:ae,onRowClick:z},{default:n(()=>[t(g,{type:"selection",width:"55",selectable:le}),(y(!0),L(A,null,ve(j.value,a=>(y(),F(g,{key:a.prop,label:a.label,prop:a.prop},null,8,["label","prop"]))),128)),t(g,{fixed:"right",label:"操作",width:"150"},{default:n(a=>{var C,B;return[x(t(c,{link:"",type:"primary",icon:f(ge),disabled:a.row.role=="sysadmin",onClick:de=>Y(a.row)},null,8,["icon","disabled","onClick"]),[[$,`${(C=f(V).name)==null?void 0:C.replace("_info","")}:edit`]]),x(t(c,{disabled:a.row.role=="sysadmin",link:"",type:"danger",icon:f(ye),onClick:de=>Z(a.row)},null,8,["disabled","icon","onClick"]),[[$,`${(B=f(V).name)==null?void 0:B.replace("_info","")}:delete`]])]}),_:1})]),_:1},8,["data","table-layout"])),[[ie,J.value]])])]),t(re,{modelValue:u.value,"onUpdate:modelValue":e[3]||(e[3]=a=>u.value=a),title:h.value=="add"?"新增角色":"编辑角色",width:"50%","before-close":H},{default:n(()=>[t(ne,{model:o,class:"demo-form-inline","label-position":"right","label-width":"80px",ref:"userFrom","status-icon":""},{default:n(()=>[t(k,{label:"角色",prop:"role",rules:[{required:!0}]},{default:n(()=>[t(N,{modelValue:o.role,"onUpdate:modelValue":e[0]||(e[0]=a=>o.role=a),placeholder:"请输入英文",clearable:"",style:{width:"30%"},disabled:w.value},null,8,["modelValue","disabled"])]),_:1}),t(k,{label:"角色名称",prop:"role_name",rules:[{required:!0}]},{default:n(()=>[t(N,{modelValue:o.role_name,"onUpdate:modelValue":e[1]||(e[1]=a=>o.role_name=a),placeholder:"中文名称",style:{width:"30%"},clearable:"",disabled:w.value},null,8,["modelValue","disabled"])]),_:1}),t(k,{label:"菜单授权",prop:"rolePermission"},{default:n(()=>[p("div",Ve,[t(f(be),{ref_key:"menuTreeRef",ref:m,modelValue:o.rolePermission,"onUpdate:modelValue":e[2]||(e[2]=a=>o.rolePermission=a),data:E.value,"show-checkbox":"","node-key":"id","default-expand-all":"","expand-on-click-node":!1,props:{class:O}},{default:n(({node:a,data:C})=>[p("span",{class:he({buttonList:C.tree_type==="button"})},we(a.label),3)]),_:1},8,["modelValue","data","props"])])]),_:1}),t(se,{style:{"justify-content":"space-around"}},{default:n(()=>[t(k,null,{default:n(()=>[t(c,{onClick:G},{default:n(()=>e[5]||(e[5]=[R("取消")])),_:1}),t(c,{type:"primary",onClick:X},{default:n(()=>e[6]||(e[6]=[R(" 确定")])),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])],64)}}}),Se=ke($e,[["__scopeId","data-v-014ce22e"]]);export{Se as default};
