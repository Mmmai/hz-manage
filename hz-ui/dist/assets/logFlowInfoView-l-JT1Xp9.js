import{d as Ee,g as Ie,r as i,h as $e,f as Ae,A as ee,q as De,aq as Ue,e as s,ak as Ve,c as E,o as v,i as f,b as t,ab as te,D as m,w as l,k as u,t as _,aK as h,ac as Me,a7 as le,a8 as Be,F as We,_ as ze}from"./index-BGjJrjF8.js";import{n as Ke}from"./nearLogCom-NmWnBoDC.js";import{u as je}from"./tabs-feTaSe4L.js";const Ge={class:"card"},Pe={class:"cell-item"},He={class:"cell-item"},Je={class:"cell-item"},Qe={class:"cell-item"},Xe={class:"cell-item"},Ye={class:"cell-item"},Ze={class:"cell-item"},et={key:0,style:{position:"absolute",top:"50%",left:"50%"}},tt={style:{display:"inline-flex","align-items":"center"}},lt={style:{display:"inline-flex","align-items":"center"}},ot=["innerHTML"],at={class:"operation_show"},nt=Ee({__name:"logFlowInfoView",setup(st){const{proxy:g}=Ie(),oe=je();i(!0),i([1,2,3,4,5]);const I=$e(),ae=Ae(),N=i(!0),ne=i("default"),se=()=>{ae.push({name:"logFlowMission"}),console.log(I.fullPath),oe.removeTabs(I.fullPath,!1)},$=i(!1),F=i(""),W=i(""),ue=async o=>{$.value=!0;let e=await g.$api.dataSourceGet(G.value);F.value=e.data.url,W.value.showNearLog(F.value,o)},z=i(""),c=i({}),A=i([]),C=i([]),S=i(""),K=i(""),j=i(""),G=i(""),P=i(""),d=i({level:"info",status:"运行中",isLoading:!0}),y=ee(()=>{const o={large:"8px",default:"6px",small:"4px"};return{marginRight:o[ne.value]||o.default}}),L=i({}),ie=ee(()=>{var e;let o=[];return(e=A.value)==null||e.forEach(n=>{if(c.value[n].status&&c.value[n].queryResult.length>>>0)var p=!1;else var p=!0;o.push({label:L.value[n].module_name,value:n,disabled:p})}),o}),re=async()=>{let o=await g.$api.getLogModule();o==null||o.data.results.forEach(e=>{L.value[e.id]=e}),console.log(L.value)},de=(o,e)=>{let n=L.value[o].module_name,p=[];e.queryResult.forEach(r=>{p.push(`${r.logTime},${r.level},${r.logLine}
`)});let x=g.$commonFunc.getCurrentTimeString("-","-","_",":",":");g.$commonFunc.downloadArray(`${n}-export-log-${x}`,p)},ce=(o,e)=>{U.value=!0,O.value=o},T=i([]),pe=o=>{console.log(o.stream),T.value=[],Object.keys(o.stream).forEach(e=>{let n={};n.label=e,n.value=o.stream[e],T.value.push(n)}),console.log(T.value)},D=i(null),fe=o=>{D.value=new EventSource(`/api/v1/log/logFlowMission/get_lokiAnalysis_status/${o}/`),D.value.onmessage=e=>{console.log(JSON.parse(e.data).is_finish),JSON.parse(e.data).is_finish&&(H(),J())}},H=()=>{var o;console.log("SSE 关闭"),(o=D.value)==null||o.close()},J=async()=>{let o=I.path.split("/").filter(V=>V!=""),e=o[o.length-1],n=await g.$api.getLogFlowMission(e);console.log(n);let p=n.data.mission_query;n.data.status=="Success"?(d.value.level="success",d.value.status="成功",d.value.isLoading=!1):n.data.status=="Failed"?(d.value.level="danger",d.value.status="失败",d.value.isLoading=!1):n.data.status=="Pending"?(d.value.level="info",d.value.status="运行中",d.value.isLoading=!0,fe(n.data.task_id)):(d.value.level="info",d.value.status="未知",d.value.isLoading=!1);let x=g.$commonFunc.timestampToDate(p.dateValue[0]),r=g.$commonFunc.timestampToDate(p.dateValue[1]);C.value.push(x),C.value.push(r),S.value=n.data.search_key,z.value=n.data.username,P.value=n.data.mission_id,K.value=n.data.dataSource_name,j.value=n.data.flow_name,G.value=n.data.dataSource_id,c.value=n.data.results.info,A.value=n.data.results.sort,console.log(c.value)};De(async()=>{re(),J()}),Ue(()=>{H()});const ve=o=>o.status?o.queryInfo.errorCount==0&&o.queryResult.length>>0?"日志正常":o.queryInfo.errorCount>>0&&o.queryResult.length>>0?"存在报错":"无请求信息":"请求错误",_e=o=>o.status?o.queryInfo.errorCount==0&&o.queryResult.length>>0?"success":o.queryInfo.errorCount>>0&&o.queryResult.length>>0?"warning":"error":"error",U=i(!1),O=i(""),me=(o,e)=>{if(e){const n=new RegExp(e,"gi");return o.replace(n,'<span style="background-color: #FFFF00;">$&</span>')}else return o},ge=[{text:"DEBUG",value:"DEBUG"},{text:"INFO",value:"INFO"},{text:"WARN",value:"WARN"},{text:"ERROR",value:"ERROR"},{text:"FATAL",value:"FATAL"},{text:"UNKNOWN",value:"UNKNOWN"}],ye=(o,e)=>e.level===o;return(o,e)=>{const n=s("el-button"),p=s("el-tooltip"),x=s("Back"),r=s("el-icon"),V=s("user"),b=s("el-descriptions-item"),be=s("iphone"),we=s("location"),M=s("tickets"),ke=s("Loading"),w=s("el-tag"),he=s("office-building"),Re=s("el-descriptions"),Se=s("el-divider"),Le=s("el-result"),Q=s("Warning"),X=s("el-statistic"),q=s("el-space"),B=s("el-link"),xe=s("el-card"),Ne=s("Right"),Fe=s("el-segmented"),k=s("el-table-column"),Y=s("el-table"),Ce=s("el-drawer"),Te=s("Top"),Oe=s("el-backtop"),qe=Ve("loading");return v(),E(le,null,[f("div",Ge,[t(Re,{class:"margin-top",title:"查询条件",column:4,border:""},{extra:l(()=>[t(p,{content:"切换流程是否换行显示",placement:"top"},{default:l(()=>[t(n,{type:"primary",onClick:e[0]||(e[0]=a=>N.value?N.value=!1:N.value=!0)},{default:l(()=>e[6]||(e[6]=[u("切换")])),_:1})]),_:1}),t(p,{content:"返回任务列表",placement:"top"},{default:l(()=>[t(n,{type:"primary",onClick:se},{default:l(()=>[t(r,null,{default:l(()=>[t(x)]),_:1})]),_:1})]),_:1})]),default:l(()=>[t(b,null,{label:l(()=>[f("div",Pe,[t(r,{style:h(y.value)},{default:l(()=>[t(V)]),_:1},8,["style"]),e[7]||(e[7]=u(" 查询用户 "))])]),default:l(()=>[u(" "+_(z.value),1)]),_:1}),t(b,null,{label:l(()=>[f("div",He,[t(r,{style:h(y.value)},{default:l(()=>[t(be)]),_:1},8,["style"]),e[8]||(e[8]=u(" 请求ID "))])]),default:l(()=>[u(" "+_(P.value),1)]),_:1}),t(b,null,{label:l(()=>[f("div",Je,[t(r,{style:h(y.value)},{default:l(()=>[t(we)]),_:1},8,["style"]),e[9]||(e[9]=u(" 时间范围 "))])]),default:l(()=>[u(" "+_(C.value[0])+" - "+_(C.value[1]),1)]),_:1}),t(b,null,{label:l(()=>[f("div",Qe,[t(r,{style:h(y.value)},{default:l(()=>[t(M)]),_:1},8,["style"]),e[10]||(e[10]=u(" 任务状态 "))])]),default:l(()=>[t(w,{type:d.value.level},{default:l(()=>[u(_(d.value.status)+" ",1),te(t(r,{class:"is-loading"},{default:l(()=>[t(ke)]),_:1},512),[[Me,d.value.isLoading]])]),_:1},8,["type"])]),_:1}),t(b,null,{label:l(()=>[f("div",Xe,[t(r,{style:h(y.value)},{default:l(()=>[t(M)]),_:1},8,["style"]),e[11]||(e[11]=u(" 数据源 "))])]),default:l(()=>[u(" "+_(K.value),1)]),_:1}),t(b,null,{label:l(()=>[f("div",Ye,[t(r,{style:h(y.value)},{default:l(()=>[t(M)]),_:1},8,["style"]),e[12]||(e[12]=u(" 业务流 "))])]),default:l(()=>[u(" "+_(j.value),1)]),_:1}),t(b,null,{label:l(()=>[f("div",Ze,[t(r,{style:h(y.value)},{default:l(()=>[t(he)]),_:1},8,["style"]),e[13]||(e[13]=u(" 分析ID "))])]),default:l(()=>[u(" "+_(S.value),1)]),_:1})]),_:1}),t(Se,null,{default:l(()=>e[14]||(e[14]=[u(" 分析结果 ")])),_:1}),d.value.isLoading?te((v(),E("div",et,null,512)),[[qe,d.value.isLoading]]):(v(),m(q,{key:1,wrap:N.value,size:10},{default:l(()=>[(v(!0),E(le,null,Be(A.value,(a,R)=>(v(),E("div",{key:R,style:{width:"100%",heigth:"320px",display:"flex","align-items":"center"}},[t(xe,{class:"result-card"},{header:l(()=>[f("span",null,"环节"+_(R+1)+": "+_(L.value[a].module_name),1)]),footer:l(()=>[t(q,{style:{width:"100%",justifyContent:"flex-end"}},{default:l(()=>[t(B,{type:"primary",onClick:Z=>de(a,c.value[a]),disabled:c.value[a].queryResult.length===0},{default:l(()=>e[17]||(e[17]=[u("下载日志")])),_:2},1032,["onClick","disabled"]),t(B,{type:"primary",onClick:Z=>ce(a,c.value[a]),disabled:c.value[a].queryResult.length===0},{default:l(()=>e[18]||(e[18]=[u("查看日志")])),_:2},1032,["onClick","disabled"])]),_:2},1024)]),default:l(()=>[t(q,{wrap:"",size:50},{default:l(()=>[t(Le,{icon:_e(c.value[a]),title:ve(c.value[a])},null,8,["icon","title"]),t(q,{direction:"vertical"},{default:l(()=>[t(X,{value:c.value[a].queryResult.length},{title:l(()=>[f("div",tt,[e[15]||(e[15]=u(" 匹配数 ")),t(p,{effect:"dark",content:"分析ID返回的日志条数",placement:"top"},{default:l(()=>[t(r,{style:{"margin-left":"4px"},size:12},{default:l(()=>[t(Q)]),_:1})]),_:1})])]),_:2},1032,["value"]),t(X,{value:c.value[a].queryInfo.errorCount},{title:l(()=>[f("div",lt,[e[16]||(e[16]=u(" 错误数 ")),t(p,{effect:"dark",content:"匹配到的日志中,日志等级为ERROR及以上的数量",placement:"top"},{default:l(()=>[t(r,{style:{"margin-left":"4px"},size:12},{default:l(()=>[t(Q)]),_:1})]),_:1})])]),_:2},1032,["value"])]),_:2},1024)]),_:2},1024)]),_:2},1024),Object.keys(c.value).length!==R+1?(v(),m(r,{key:0},{default:l(()=>[t(Ne)]),_:1})):We("",!0)]))),128))]),_:1},8,["wrap"]))]),t(Ce,{modelValue:U.value,"onUpdate:modelValue":e[2]||(e[2]=a=>U.value=a),size:"80%",class:"drawer"},{header:l(()=>[t(Fe,{modelValue:O.value,"onUpdate:modelValue":e[1]||(e[1]=a=>O.value=a),options:ie.value},null,8,["modelValue","options"])]),default:l(()=>[t(Y,{data:c.value[O.value].queryResult,style:{width:"98%"},onExpandChange:pe,"default-sort":{prop:"logTime",order:"descending"}},{default:l(()=>[t(k,{type:"expand"},{default:l(a=>[t(Y,{data:T.value,border:"","show-header":!1},{default:l(()=>[t(k,{fixed:"left",label:"Operations",width:"45"},{default:l(R=>[t(n,{icon:o.Filter,link:"",type:"primary",size:"small",onClick:Z=>o.addLabelToFilter(R.row)},null,8,["icon","onClick"])]),_:1}),t(k,{label:"label",prop:"label",width:"120px"}),t(k,{label:"value",prop:"value"})]),_:1},8,["data"])]),_:1}),t(k,{label:"日志时间",prop:"logTime",sortable:"",width:"200px"}),t(k,{label:"日志等级",prop:"level",width:"100px",filters:ge,"filter-method":ye,"filter-placement":"bottom-end"},{default:l(a=>[a.row.level=="DEBUG"?(v(),m(w,{key:0,type:"primary",effect:"light"},{default:l(()=>e[19]||(e[19]=[u("DEBUG")])),_:1})):a.row.level=="INFO"?(v(),m(w,{key:1,type:"success",effect:"light"},{default:l(()=>e[20]||(e[20]=[u("INFO")])),_:1})):a.row.level=="WARN"?(v(),m(w,{key:2,type:"warning",effect:"light"},{default:l(()=>e[21]||(e[21]=[u("WARN")])),_:1})):a.row.level=="ERROR"?(v(),m(w,{key:3,type:"danger",effect:"light"},{default:l(()=>e[22]||(e[22]=[u("ERROR")])),_:1})):a.row.level=="FATAL"?(v(),m(w,{key:4,type:"danger",effect:"light"},{default:l(()=>e[23]||(e[23]=[u("FATAL")])),_:1})):(v(),m(w,{key:5,type:"info",effect:"light"},{default:l(()=>e[24]||(e[24]=[u("UNKNOWN")])),_:1}))]),_:1}),t(k,{label:"日志内容",prop:"logLine"},{default:l(({row:a})=>[f("span",{innerHTML:me(a.logLine,S.value)},null,8,ot),f("div",at,[t(B,{type:"primary",onClick:R=>ue(a)},{default:l(()=>e[25]||(e[25]=[u("查看上下文 ")])),_:2},1032,["onClick"])])]),_:1})]),_:1},8,["data"])]),footer:l(()=>e[26]||(e[26]=[f("div",{style:{flex:"auto"}},null,-1)])),_:1},8,["modelValue"]),t(Oe,{bottom:50},{default:l(()=>[t(r,null,{default:l(()=>[t(Te)]),_:1})]),_:1}),t(Ke,{isShow:$.value,"onUpdate:isShow":e[3]||(e[3]=a=>$.value=a),highlightKey:S.value,"onUpdate:highlightKey":e[4]||(e[4]=a=>S.value=a),url:F.value,"onUpdate:url":e[5]||(e[5]=a=>F.value=a),ref_key:"childRef",ref:W},null,8,["isShow","highlightKey","url"])],64)}}}),dt=ze(nt,[["__scopeId","data-v-b7e90143"]]);export{dt as default};
