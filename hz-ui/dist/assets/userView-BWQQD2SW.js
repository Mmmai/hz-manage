import{d as Be,x as Ne,g as qe,a as J,r,bO as Ee,z as Je,h as u,bb as ae,c as S,o as d,b as x,f as s,bU as C,m as k,B as y,w as t,q as V,F as U,i as O,a9 as Ae,t as se,cb as Ie,cc as Le,bL as Te,c3 as j,bZ as m,aO as je,_ as Me}from"./index-x4baBB9A.js";const Re={class:"card"},Ge={class:"user-header"},We={class:"flexJstart gap-5"},Ye={class:"flexJstart gap-5"},Ze={class:"demo-pagination-block"},He=Be({name:"user",__name:"userView",setup(Ke){const P=Ne(),{proxy:i}=qe(),B=J({search:""}),A=r(!1),M=r([]),te=r("auto"),oe=r([{prop:"username",label:"用户名称"},{prop:"real_name",label:"真实姓名"},{prop:"status",label:"状态"},{prop:"groups",label:"用户组列表"},{prop:"roles",label:"角色列表"},{prop:"expire_time",label:"到期时间"}]),ne=J({password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:5,message:"密码长度不能低于5",trigger:"blur"}],confirmPassword:[{validator:(l,e,n)=>{(c.value==="add"||f.value)&&e===""?n(new Error("请再次输入密码")):(c.value==="add"||f.value)&&e!==o.password?n(new Error("两次输入的密码不一致")):n()},trigger:"blur"}]}),I=r(1),L=r(10),re=r(!1),de=r(!1),ue=r(!1),R=r(0),p=J({page:I.value,size:L.value,search:"",ordering:"id"}),ie=r(!1),G=r([]),pe=async l=>{let e=await i.$api.getRole(l);G.value=e.data.results},W=r([]),ce=async()=>{let l=await i.$api.getUserGroup();W.value=l.data.results},w=async l=>{A.value=!0;let e=await i.$api.user(l);M.value=e.data.results,R.value=e.data.count,A.value=!1},me=l=>{p.size=l,w(p)},fe=l=>{p.page=l,w(p)},h=r(!1),o=J({username:"",real_name:null,password:"",confirmPassword:"",status:!0,role_ids:[],group_ids:[],expire_time:new Date(2999,1,1)}),c=r("add"),F=r({}),ge=()=>{c.value="add",h.value=!0,f.value=!0},_e=()=>{h.value=!1,i.$refs.userFrom.resetFields()},ve=l=>{j.confirm("是否确认关闭?").then(()=>{l(),i.$refs.userFrom.resetFields()}).catch(()=>{})},be=(l,e)=>{if(Array.isArray(l)&&Array.isArray(e)){if(l.length!==e.length)return!1;const n=[...l].sort(),g=[...e].sort();return JSON.stringify(n)===JSON.stringify(g)}return l===e},ye=()=>{const l={};for(const e in o)if(e!=="confirmPassword"){if(c.value==="add"){l[e]=o[e];continue}be(o[e],F.value[e])||(console.log("key",e),l[e]=o[e])}return console.log("changedData",f.value),c.value==="edit"&&f.value&&(console.log(123),l.password=o.password),console.log("123333",l),l},we=()=>{i.$refs.userFrom.validate(async l=>{if(l)if(c.value=="add"){let e=await i.$api.useradd(o);console.log(e),e.status==201?(h.value=!1,i.$refs.userFrom.resetFields(),w(p)):m({showClose:!0,message:"添加失败:"+JSON.stringify(e.data),type:"error"})}else{const e=ye();if(console.log("changedData",e),Object.keys(e).length===0){h.value=!1,m({showClose:!0,message:"没有变更任何数据",type:"info"});return}console.log("变更的数据:",JSON.stringify(e));let n=await i.$api.userupdate({id:Y.value.id,...e});console.log(n),n.status==200?(h.value=!1,i.$refs.userFrom.resetFields(),w(p)):(console.log(),m({showClose:!0,message:"更新失败:"+JSON.stringify(n.data),type:"error"}))}else m({showClose:!0,message:"请输入正确内容.",type:"error"});console.log(o)})},he=async l=>{let e=await i.$api.userupdate({status:l.status,id:l.id});e.status==200?(m({type:"success",message:"更新成功"}),w(p)):m({showClose:!0,message:"更新失败:"+JSON.stringify(e.data),type:"error"})},Y=r({}),Ve=l=>{c.value="edit",f.value=!1,h.value=!0,Y.value=l,F.value={username:l.username,real_name:l.real_name,status:l.status,role_ids:l.roles?l.roles.map(e=>e.id):[],group_ids:l.groups?l.groups.map(e=>e.id):[],password:l.password},je(()=>{Object.keys(o).forEach(e=>{if(["group_ids"].includes(e)){const n=l.groups?l.groups.map(g=>g.id):[];o[e]=n,F.value[e]=[...n]}else if(["role_ids"].includes(e)){const n=l.roles?l.roles.map(g=>g.id):[];o[e]=n,F.value[e]=[...n]}else o[e]=l[e],F.value[e]=l[e]}),o.confirmPassword=""}),console.log(o)},xe=l=>{j.confirm("是否确认删除?","Warning",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await i.$api.userdel(l.id)).status==204?m({type:"success",message:"删除成功"}):m({type:"error",message:"删除失败"}),w(p)}).catch(()=>{m({type:"info",message:"Delete canceled"})})},N=r([]),Ce=(l,e)=>l.username!="admin",ke=l=>{N.value=l},$e=()=>{j.confirm("是否确认删除?","Warning",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{let l=[];for(let n in N.value)l.push(N.value[n].id);console.log(l),(await i.$api.usermuldel({pks:l})).status==204?m({type:"success",message:"删除成功"}):m({type:"error",message:"删除失败"}),w(p)}).catch(()=>{m({type:"info",message:"Delete canceled"})})},De=async()=>{p.search=B.search,w(p)},$=r(!1);Ee(()=>o.username,l=>{l=="admin"?$.value=!0:$.value=!1});const f=r(!1),Se=()=>{f.value=!0,o.password="",o.confirmPassword=""};return Je(()=>{pe(p),ce(),w(p)}),(l,e)=>{var ee,le;const n=u("el-button"),g=u("el-input"),_=u("el-form-item"),Z=u("el-form"),T=u("el-table-column"),H=u("el-switch"),K=u("el-tag"),Ue=u("el-table"),Pe=u("el-pagination"),D=u("el-col"),q=u("el-row"),Q=u("el-option"),X=u("el-select"),Fe=u("el-date-picker"),ze=u("el-dialog"),z=ae("permission"),Oe=ae("loading");return d(),S(U,null,[x("div",Re,[x("div",Ge,[x("div",null,[C((d(),y(n,{type:"primary",onClick:ge},{default:t(()=>[...e[12]||(e[12]=[V("新增",-1)])]),_:1})),[[z,`${(ee=k(P).name)==null?void 0:ee.replace("_info","")}:add`]]),C((d(),y(n,{disabled:N.value.length==0,type:"danger",onClick:$e},{default:t(()=>[...e[13]||(e[13]=[V("批量删除",-1)])]),_:1},8,["disabled"])),[[z,`${(le=k(P).name)==null?void 0:le.replace("_info","")}:delete`]])]),s(Z,{inline:!0,model:B,class:"demo-form-inline"},{default:t(()=>[s(_,{label:"用户名检索"},{default:t(()=>[s(g,{modelValue:B.search,"onUpdate:modelValue":e[0]||(e[0]=a=>B.search=a),placeholder:"请输入用户名",clearable:""},null,8,["modelValue"])]),_:1}),s(_,null,{default:t(()=>[s(n,{type:"primary",size:"small",onClick:De},{default:t(()=>[...e[14]||(e[14]=[V("查询",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),x("div",null,[C((d(),y(Ue,{border:"",data:M.value,style:{width:"100%"},"max-height":"500px","table-layout":te.value,onSelectionChange:ke},{default:t(()=>[s(T,{type:"selection",width:"50",selectable:Ce}),(d(!0),S(U,null,O(oe.value,a=>(d(),y(T,{key:a.prop,label:a.label,prop:a.prop},Ae({_:2},[a.prop==="status"?{name:"default",fn:t(v=>{var b;return[C(s(H,{modelValue:v.row.status,"onUpdate:modelValue":E=>v.row.status=E,disabled:v.row.username=="admin",class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},onChange:E=>he(v.row)},null,8,["modelValue","onUpdate:modelValue","disabled","onChange"]),[[z,{id:`${(b=k(P).name)==null?void 0:b.replace("_info","")}:edit`,action:"disabled"}]])]}),key:"0"}:void 0,a.prop==="groups"?{name:"default",fn:t(v=>[x("div",We,[(d(!0),S(U,null,O(v.row.groups,b=>(d(),y(K,{key:b},{default:t(()=>[V(se(b.group_name),1)]),_:2},1024))),128))])]),key:"1"}:void 0,a.prop==="roles"?{name:"default",fn:t(v=>[x("div",Ye,[(d(!0),S(U,null,O(v.row.roles,b=>(d(),y(K,{key:b,type:"warning"},{default:t(()=>[V(se(b.role_name),1)]),_:2},1024))),128))])]),key:"2"}:void 0]),1032,["label","prop"]))),128)),s(T,{fixed:"right",label:"操作",width:"150"},{default:t(a=>{var v,b;return[C(s(n,{link:"",type:"primary",icon:k(Ie),onClick:E=>Ve(a.row)},null,8,["icon","onClick"]),[[z,`${(v=k(P).name)==null?void 0:v.replace("_info","")}:edit`]]),C(s(n,{disabled:a.row.username=="admin",link:"",type:"danger",icon:k(Le),onClick:E=>xe(a.row)},null,8,["disabled","icon","onClick"]),[[z,`${(b=k(P).name)==null?void 0:b.replace("_info","")}:delete`]])]}),_:1})]),_:1},8,["data","table-layout"])),[[Oe,A.value]])]),x("div",Ze,[s(Pe,{"current-page":I.value,"onUpdate:currentPage":e[1]||(e[1]=a=>I.value=a),"page-size":L.value,"onUpdate:pageSize":e[2]||(e[2]=a=>L.value=a),"page-sizes":[10,20,30,40],small:re.value,disabled:ue.value,background:de.value,layout:"total, sizes, prev, pager, next, jumper",total:R.value,"hide-on-single-page":ie.value,onSizeChange:me,onCurrentChange:fe},null,8,["current-page","page-size","small","disabled","background","total","hide-on-single-page"])])]),s(ze,{modelValue:h.value,"onUpdate:modelValue":e[11]||(e[11]=a=>h.value=a),title:c.value=="add"?"新增用户":"编辑用户",width:"40%","before-close":ve},{default:t(()=>[s(Z,{inline:!0,model:o,class:"demo-form-inline",ref:"userFrom","label-position":"right","label-width":"auto","status-icon":"",rules:ne},{default:t(()=>[s(q,null,{default:t(()=>[s(D,{span:12},{default:t(()=>[s(_,{label:"用户名称",prop:"username",rules:[{required:!0}]},{default:t(()=>[s(g,{modelValue:o.username,"onUpdate:modelValue":e[3]||(e[3]=a=>o.username=a),placeholder:"",clearable:"",disabled:c.value!="add",style:{width:"200px"}},null,8,["modelValue","disabled"])]),_:1})]),_:1}),s(D,{span:12},{default:t(()=>[s(_,{label:"真实名称",prop:"real_name"},{default:t(()=>[s(g,{modelValue:o.real_name,"onUpdate:modelValue":e[4]||(e[4]=a=>o.real_name=a),placeholder:"",clearable:"",style:{width:"200px"}},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),s(q,null,{default:t(()=>[s(D,{span:12},{default:t(()=>[s(_,{label:"用户组",prop:"group_ids",required:""},{default:t(()=>[s(X,{modelValue:o.group_ids,"onUpdate:modelValue":e[5]||(e[5]=a=>o.group_ids=a),placeholder:"",clearable:"",multiple:"","collapse-tags":"","collapse-tags-tooltip":"","max-collapse-tags":3,disabled:$.value,style:{width:"200px"}},{default:t(()=>[(d(!0),S(U,null,O(W.value,a=>(d(),y(Q,{key:a.id,label:a.group_name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1}),s(D,{span:12},{default:t(()=>[s(_,{label:"角色",prop:"role_ids"},{default:t(()=>[s(X,{modelValue:o.role_ids,"onUpdate:modelValue":e[6]||(e[6]=a=>o.role_ids=a),placeholder:"",clearable:"",multiple:"","collapse-tags":"","collapse-tags-tooltip":"","max-collapse-tags":3,disabled:$.value,style:{width:"200px"}},{default:t(()=>[(d(!0),S(U,null,O(G.value,a=>(d(),y(Q,{key:a.id,label:a.role_name,value:a.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}),s(q,null,{default:t(()=>[s(D,{span:12,style:{display:"flex","flex-direction":"column"}},{default:t(()=>[s(_,{label:"有效期",prop:"expire_time"},{default:t(()=>[s(Fe,{modelValue:o.expire_time,"onUpdate:modelValue":e[7]||(e[7]=a=>o.expire_time=a),type:"date",placeholder:"选择日期",disabled:$.value,style:{width:"200px"}},null,8,["modelValue","disabled"])]),_:1}),s(_,{label:"状态",prop:"status"},{default:t(()=>[s(H,{modelValue:o.status,"onUpdate:modelValue":e[8]||(e[8]=a=>o.status=a),class:"ml-2","inline-prompt":"",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},"active-text":"Y","inactive-text":"N",disabled:$.value},null,8,["modelValue","disabled"])]),_:1})]),_:1}),s(D,{span:12},{default:t(()=>[s(_,{label:"密码",prop:"password",required:c.value==="add"||f.value},{default:t(()=>[f.value?(d(),y(g,{key:0,modelValue:o.password,"onUpdate:modelValue":e[9]||(e[9]=a=>o.password=a),type:"password",autocomplete:"off","show-password":!0},null,8,["modelValue"])):(d(),y(n,{key:1,link:"",type:"primary",onClick:Se},{default:t(()=>[...e[15]||(e[15]=[V("重置密码",-1)])]),_:1}))]),_:1},8,["required"]),C(s(_,{label:"确认密码",prop:"confirmPassword",required:c.value==="add"||f.value},{default:t(()=>[s(g,{modelValue:o.confirmPassword,"onUpdate:modelValue":e[10]||(e[10]=a=>o.confirmPassword=a),type:"password",autocomplete:"off","show-password":""},null,8,["modelValue"])]),_:1},8,["required"]),[[Te,c.value==="add"||f.value]])]),_:1})]),_:1}),s(q,{style:{"justify-content":"flex-end"}},{default:t(()=>[s(_,null,{default:t(()=>[s(n,{onClick:_e},{default:t(()=>[...e[16]||(e[16]=[V("取消",-1)])]),_:1}),s(n,{type:"primary",onClick:we},{default:t(()=>[...e[17]||(e[17]=[V(" 确定",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])],64)}}}),el=Me(He,[["__scopeId","data-v-230ff783"]]);export{el as default};
