import{d as me,b as fe,r,c as J,bc as _e,M as P,bI as be,aN as ve,e as u,b3 as ge,o as n,f as E,h as R,g as t,w as o,bO as L,O as i,j as g,bo as $,P as ye,F as A,b1 as j,c4 as c,bV as W,k as we,_ as Ve}from"./index-C9OpqlOS.js";const ke={class:"card"},he={class:"dialog-footer"},xe=me({__name:"logModuleView",setup(Ce){const{proxy:d}=we(),y=fe(),H=r(),K=J({module_name:[{required:!0,message:"请填写名称",trigger:"blur"}],label_name:[{required:!0,message:"请添加匹配标签",trigger:"blur"}],label_value:[{required:!0,message:"请填写标签值",trigger:"blur"}]}),Q=async a=>{let e=await d.$api.updateLogModule(a);console.log(e),e.status==200?(c({type:"success",message:"更新成功"}),f(),p.value=!1,k()):c({type:"error",message:"更新失败"})},p=r(!1),M=r(!1);_e("");const f=()=>{Object.keys(s).forEach(a=>{s[a]=Y[a]})},X=a=>{W.confirm("是否关闭?").then(()=>{f(),console.log(s),a()}).catch(()=>{})},w=r({}),Y={data_source:w.value,label_name:"",label_value:"",label_match:"=~",group:"",status:!0},s=J({data_source:w.value,label_name:"",label_value:"",label_match:"=~",group:"",status:!0}),Z=()=>{p.value=!0,M.value=!0},I=a=>{U.value=a.id,q()},B=r([]),ee=async()=>{let a=await d.$api.dataSourceGet();a==null||a.data.results.forEach(e=>{e.source_type=="loki"&&(e.isUsed?B.value.push({label:e.source_name,value:e.id,disabled:!1}):B.value.push({label:e.source_name,value:e.id,disabled:!0}),e.isDefault&&(w.value=e))})},F=r([]),le=async()=>{console.log(w.value);let a=await d.$api.lokiLabelGet({url:w.value.url});F.value=a.data.data},ae=()=>{d.$refs.formRef.validate(async a=>{if(console.log(a),a){let e=await d.$api.addLogModule(s);console.log(e),e.status=="201"?(c({type:"success",message:"添加成功"}),f(),p.value=!1,k()):c({showClose:!0,message:"添加失败:"+JSON.stringify(e.data),type:"error"})}})};r([]);const V=r([]);r([]);const k=async()=>{let a=await d.$api.getLogModule();V.value=a.data.results,O.value=a.data.results},te=P(()=>{let a=[];return V.value.forEach(e=>{a.includes({value:e.group,label:e.group})||a.push({value:e.group,label:e.group})}),a}),oe=P(()=>{var e;let a=["所有"];return(e=V.value)==null||e.forEach(m=>{a.includes(m.group)||a.push(m.group)}),a}),D=r("所有");be(()=>D.value,a=>{a==="所有"?O.value=V.value:O.value=V.value.filter(e=>e.group===a)});const U=r(""),se=a=>{p.value=!0,M.value=!1,U.value=a.id;let e=["id","update_time","create_time"];Object.keys(a).forEach(m=>{e.indexOf(m)===-1&&(s[m]=a[m])})},ue=()=>{d.$refs.formRef.validate(async a=>{if(a){let e=await d.$api.updateLogModule({id:U.value,...s});console.log(e),e.status==200?(c({type:"success",message:"更新成功"}),f(),p.value=!1,k()):c({type:"error",message:"更新失败"}),f()}})},q=()=>{W.confirm("是否确认删除?","Warning",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await d.$api.delLogModule(U.value)).status==204?(c({type:"success",message:"删除成功"}),f(),p.value=!1,k()):c({type:"error",message:"删除失败"})}).catch(()=>{c({type:"info",message:"Delete canceled"})})};ve(async()=>{await ee(),await k()});const O=r([]);return(a,e)=>{const m=u("el-segmented"),z=u("el-col"),_=u("el-button"),ne=u("el-row"),re=u("el-divider"),b=u("el-table-column"),T=u("el-switch"),de=u("el-table"),S=u("el-option"),N=u("el-select"),v=u("el-form-item"),G=u("el-input"),ie=u("el-form"),ce=u("el-dialog"),h=ge("permission");return n(),E(A,null,[R("div",ke,[t(ne,{class:"row-bg",justify:"space-between"},{default:o(()=>[t(z,{span:23},{default:o(()=>[e[8]||(e[8]=R("span",{style:{display:"flex","align-items":"center","margin-right":"10px"}},"分组",-1)),t(m,{modelValue:D.value,"onUpdate:modelValue":e[0]||(e[0]=l=>D.value=l),options:oe.value,size:"large"},null,8,["modelValue","options"])]),_:1}),t(z,{span:1},{default:o(()=>{var l;return[L((n(),i(_,{type:"primary",onClick:Z},{default:o(()=>e[9]||(e[9]=[g("添加")])),_:1})),[[h,`${(l=$(y).name)==null?void 0:l.replace("_info","")}:add`]])]}),_:1})]),_:1}),t(re),t(de,{data:O.value,style:{width:"100%"},"table-layout":"auto"},{default:o(()=>[t(b,{prop:"module_name",label:"环节名称"}),t(b,{prop:"label_name",label:"标签名称"}),t(b,{prop:"label_match",label:"匹配方式"}),t(b,{prop:"label_value",label:"标签值"}),t(b,{prop:"status",label:"状态"},{default:o(l=>{var x;return[L(t(T,{modelValue:l.row.status,"onUpdate:modelValue":C=>l.row.status=C,class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},onChange:C=>Q(l.row)},null,8,["modelValue","onUpdate:modelValue","onChange"]),[[h,{id:`${(x=$(y).name)==null?void 0:x.replace("_info","")}:edit`,action:"disabled"}]])]}),_:1}),t(b,{fixed:"right",label:"操作"},{default:o(l=>{var x,C;return[L((n(),i(_,{link:"",type:"primary",size:"small",onClick:pe=>se(l.row)},{default:o(()=>e[10]||(e[10]=[g(" 编辑 ")])),_:2},1032,["onClick"])),[[h,`${(x=$(y).name)==null?void 0:x.replace("_info","")}:edit`]]),L((n(),i(_,{link:"",type:"primary",size:"small",onClick:pe=>I(l.row)},{default:o(()=>e[11]||(e[11]=[g(" 删除 ")])),_:2},1032,["onClick"])),[[h,`${(C=$(y).name)==null?void 0:C.replace("_info","")}:delete`]])]}),_:1})]),_:1},8,["data"])]),t(ce,{modelValue:p.value,"onUpdate:modelValue":e[7]||(e[7]=l=>p.value=l),title:"环节配置",width:"500","before-close":X,draggable:"",overflow:""},{footer:o(()=>{var l;return[R("div",he,[M.value==!1?L((n(),i(_,{key:0,type:"danger",onClick:q},{default:o(()=>e[12]||(e[12]=[g("删除")])),_:1})),[[h,`${(l=$(y).name)==null?void 0:l.replace("_info","")}:delete`]]):ye("",!0),M.value==!1?(n(),i(_,{key:1,type:"primary",onClick:ue},{default:o(()=>e[13]||(e[13]=[g("更新")])),_:1})):(n(),i(_,{key:2,type:"primary",onClick:ae},{default:o(()=>e[14]||(e[14]=[g("添加")])),_:1}))])]}),default:o(()=>[t(ie,{"label-position":"right",model:s,"label-width":"auto",style:{"max-width":"400px"},ref_key:"formRef",ref:H,rules:K},{default:o(()=>[t(v,{label:"数据源",prop:"datasource"},{default:o(()=>[t(N,{modelValue:s.data_source,"onUpdate:modelValue":e[1]||(e[1]=l=>s.data_source=l),filterable:"",clearable:"","allow-create":"",placeholder:"标签",style:{width:"180px"}},{default:o(()=>[(n(!0),E(A,null,j(B.value,l=>(n(),i(S,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(v,{label:"环节名称",prop:"module_name"},{default:o(()=>[t(G,{modelValue:s.module_name,"onUpdate:modelValue":e[2]||(e[2]=l=>s.module_name=l),style:{width:"220px"}},null,8,["modelValue"])]),_:1}),t(v,{label:"标签",prop:"label_name"},{default:o(()=>[t(N,{modelValue:s.label_name,"onUpdate:modelValue":e[3]||(e[3]=l=>s.label_name=l),filterable:"",clearable:"","allow-create":"",placeholder:"标签",style:{width:"180px"},onClick:le},{default:o(()=>[(n(!0),E(A,null,j(F.value,l=>(n(),i(S,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(v,{label:"标签值",prop:"label_value"},{default:o(()=>[t(G,{modelValue:s.label_value,"onUpdate:modelValue":e[4]||(e[4]=l=>s.label_value=l),placeholder:"支持模糊匹配"},null,8,["modelValue"])]),_:1}),t(v,{label:"分组"},{default:o(()=>[t(N,{modelValue:s.group,"onUpdate:modelValue":e[5]||(e[5]=l=>s.group=l),filterable:"",clearable:"","allow-create":"",placeholder:"所属分组，支持新增",style:{width:"180px"}},{default:o(()=>[(n(!0),E(A,null,j(te.value,l=>(n(),i(S,{key:l.value,label:l.label,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),t(v,{label:"是否启用"},{default:o(()=>[t(T,{modelValue:s.status,"onUpdate:modelValue":e[6]||(e[6]=l=>s.status=l),class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])],64)}}}),$e=Ve(xe,[["__scopeId","data-v-d6c10fd7"]]);export{$e as default};
