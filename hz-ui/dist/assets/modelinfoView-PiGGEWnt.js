import{d as Ne,u as je,b as Te,bu as ol,r as m,M as de,c as fe,e as d,b3 as Le,o as b,f as L,h as S,g as e,w as t,F as P,b1 as oe,O as T,j as w,t as X,bO as $,bQ as Ee,bo as O,c0 as Ge,c1 as Pe,P as Je,aE as al,bF as pe,c4 as f,bV as ce,aD as ke,k as Be,_ as He,a as sl,aN as nl,aS as dl,aI as il,bZ as ul}from"./index-CCI8Hn2n.js";import{i as rl}from"./iconSelectCom-lfi48O_-.js";import{u as ml}from"./tabs-Csr0dV9r.js";import{l as pl}from"./vue-draggable-plus-D46h4PET.js";const fl={class:"operation_show"},cl={class:"dialog-footer"},_l={class:"demo-drawer__content"},vl={style:{float:"left"}},bl={style:{float:"right",color:"var(--el-text-color-secondary)","font-size":"13px"}},gl={class:"demo-drawer__footer"},yl=Ne({__name:"ciModelField",props:{ciModelInfo:{},ciModelInfoModifiers:{}},emits:["update:ciModelInfo"],setup(xe,{expose:B}){const{proxy:k}=Be(),h=je(),F=Te(),D=ol(xe,"ciModelInfo"),R=m([]),Y=m([]),_e=m([]),H=de(()=>{let o=[];return R.value.forEach(l=>{l.fields.forEach(r=>{r.type==="model_ref"&&o.push(r.ref_model)})}),o}),y=de(()=>{var l;let o=[];return(l=_e.value)==null||l.forEach(r=>{r.id!==D.value.id&&(H.value.indexOf(r.id)===-1?o.push({value:r.id,label:r.verbose_name,disabled:!1}):o.push({value:r.id,label:r.verbose_name,disabled:!0}))}),o}),z=()=>{s.default="",s.validation_rule="",s.type=="boolean"?s.default=!0:s.type=="enum"?q.value=!0:s.type=="string"&&(q.value=!1)},Q=m([]),ae=o=>{let l=JSON.parse(K.value[o].rule),r=[];Object.keys(l).forEach(c=>{r.push({value:c,label:l[c]})}),Q.value=r},Z=o=>{let l=JSON.parse(K.value[o].rule),r=[];Object.keys(l).forEach(c=>{r.push({value:c,label:l[c]})}),Q.value=r,s.default!=Q.value[0].value&&(s.default=Q.value[0].value)},q=m(!1),ee=de(()=>s.type==="fromModel"),ie=m([]),V=async(o=null)=>{let l=await k.$api.getValidationRules({page:1,page_size:1e4,...o});ie.value=l.data.results,l.data.results.forEach(r=>{K.value[r.id]=r})},K=m({}),ve=de(()=>{let o=[];return ie.value.forEach(l=>{l.field_type==s.type&&o.push({value:l.id,label:l.verbose_name})}),o}),C=async()=>{let o=await k.$api.getCiModel(F.query,F.query.id);D.value=o.data.model,R.value=o.data.field_groups,Y.value=o.data.field_groups.map(l=>l.name)},v=m([]),u=m([]);B({getModelField:C,getCiModelList:async()=>{let o=await k.$api.getCiModel();_e.value=o.data.results},getRules:V,getModelFieldType:async()=>{let o=await k.$api.getCiModelFieldType(),l=o.data.field_types;Object.keys(l).forEach(r=>{v.value.push({value:r,label:l[r]})}),u.value=o.data.limit_fields}});const U=fe({name:"",verbose_name:""}),ue=(o,l,r)=>{console.log(l),u.value.includes(l)?r(new Error(`${u.value.join(",")}不能用!`)):r()},ye=fe({name:[{required:!0,message:"请输入唯一标识",trigger:"blur"},{pattern:/^[a-z][\w\d]{4,20}$/,trigger:"blur",message:"以英文字符开头,可以使用英文,数字,下划线,长度4-20 "}],verbose_name:[{required:!0,message:"请输入组名称",trigger:"blur"}]}),i=m(),n=m(!1),W=o=>{n.value=!1,te(o)},M=m(!1),A=m(""),we=async o=>{o&&await o.validate(async(l,r)=>{if(l)if(M.value){console.log(U);let c=await k.$api.addCiModelFieldGroup({model:D.value.id,create_user:h.state.username,update_user:h.state.username,...U});console.log(c),c.status=="201"?(f({type:"success",message:"添加成功"}),n.value=!1,te(o),C()):f({showClose:!0,message:"添加失败:"+JSON.stringify(c.data),type:"error"})}else{let c=await k.$api.updateCiModelFieldGroup({id:A.value,update_user:h.state.username,...U});console.log(c),c.status=="200"?(f({type:"success",message:"更新成功"}),n.value=!1,te(o),C()):f({showClose:!0,message:"更新失败:"+JSON.stringify(c.data),type:"error"})}else console.log("error submit!",r)})},se=o=>{ce.confirm("是否确认关闭?").then(()=>{o(),te(i.value)}).catch(()=>{})},p=m("新增"),N=o=>{p.value="新增",ke(()=>{}),n.value=!0,M.value=!0},le=o=>{p.value="修改",n.value=!0,ke(()=>{M.value=!1,U.name=o.name,U.verbose_name=o.verbose_name,A.value=o.id})},qe=o=>{ce.confirm("是否确认删除?","删除组",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{let l=await k.$api.deleteCiModelFieldGroup(o);l.status==204||l.status==200?(f({type:"success",message:"删除成功"}),await C()):f({type:"error",message:"删除失败"})}).catch(()=>{f({type:"info",message:"取消删除"})})},J=m(!1),s=fe({name:"",verbose_name:"",type:"string",required:!1,editable:!0,validation_rule:"",ref_model:"",description:"",default:"",unit:""}),Ue=fe({name:[{required:!0,message:"请输入唯一标识",trigger:"blur"},{pattern:/^[a-z][\w\d]{1,20}$/,trigger:"blur",message:"以英文字符开头,可以使用英文,数字,下划线,长度2-20 ",required:!0},{validator:ue,trigger:"blur"}],verbose_name:[{required:!0,message:"请输入字段显示名称",trigger:"blur"}],type:[{required:!0,message:"字段类型",trigger:"blur"}],model_name:[{required:ee,message:"请选择模型",trigger:"blur"}],validation_rule:[{required:q,message:"选择校验规则",trigger:""}]}),re=m();m(!1);const ne=m(!1),G=m({}),Ve=m(!0),Oe=o=>{J.value=!0,p.value="修改",ne.value=!0,G.value=o,Ve.value=!1,ke(()=>{Object.keys(o).forEach(l=>{s.hasOwnProperty(l)&&(s[l]=o[l])}),s.validation_rule===null?q.value=!1:q.value=!0})},g=o=>{te(o),console.log(s),J.value=!1},be=o=>{p.value="新增",G.value={},J.value=!0,Ve.value=!0,ne.value=!1,q.value=!1,ke(()=>{A.value=o.id})},Ie=async o=>{o&&await o.validate(async(l,r)=>{if(l)if(Ve.value){let c=await k.$api.addCiModelField({model:D.value.id,model_field_group:A.value,create_user:h.state.username,update_user:h.state.username,...s});console.log(c),c.status=="201"?(f({type:"success",message:"添加成功"}),J.value=!1,te(o),C()):f({showClose:!0,message:"添加失败:"+JSON.stringify(c.data),type:"error"})}else{q.value||(s.validation_rule="");let c=await k.$api.updateCiModelField({id:G.value.id,update_user:h.state.username,...s});console.log(c),c.status=="200"?(f({type:"success",message:"更新成功"}),J.value=!1,te(o),C()):f({showClose:!0,message:"更新失败:"+JSON.stringify(c.data),type:"error"})}else console.log("error submit!",r)})},Qe=o=>{ce.confirm("是否确认关闭?").then(()=>{o(),te(re.value),J.value=!1}).catch(()=>{})},Ze=o=>{ce.confirm("是否确认删除?","删除组",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await k.$api.deleteCiModelField(G.value.id)).status==204?(f({type:"success",message:"删除成功"}),await C(),te(re.value),J.value=!1):f({type:"error",message:"删除失败"})}).catch(()=>{f({type:"info",message:"取消删除"})})},te=o=>{o&&o.resetFields()},Ke=async(o,l)=>{if(o.oldIndex==o.newIndex)return;if(o.pullMode){console.log("跨组移动，在onAdd中触发");return}let r=await k.$api.updateCiModelField({id:o.data.id,order:o.newIndex+1});r.status=="200"?f({type:"success",message:"更新排序成功"}):f({showClose:!0,message:"更新排序失败:"+JSON.stringify(r.data),type:"error"}),C()},We=async(o,l)=>{let r=await k.$api.updateCiModelField({id:o.data.id,order:o.newIndex+1,model_field_group:l.id});r.status=="200"?f({type:"success",message:"更新排序成功"}):f({showClose:!0,message:"更新排序失败:"+JSON.stringify(r.data),type:"error"}),C()};return(o,l)=>{const r=d("el-text"),c=d("el-button"),Ce=d("el-tooltip"),Xe=d("el-space"),he=d("el-col"),ze=d("el-row"),Ae=d("el-card"),Ye=d("el-collapse-item"),el=d("el-collapse"),ge=d("el-input"),j=d("el-form-item"),De=d("el-form"),ll=d("el-dialog"),Re=d("el-switch"),Fe=d("el-option"),Me=d("el-select"),tl=d("el-drawer"),me=Le("permission");return b(),L(P,null,[S("div",null,[e(el,{modelValue:Y.value,"onUpdate:modelValue":l[0]||(l[0]=_=>Y.value=_)},{default:t(()=>[(b(!0),L(P,null,oe(R.value,(_,$e)=>(b(),T(Ye,{name:_.name,key:$e},{title:t(()=>[e(r,{tag:"b",size:"large"},{default:t(()=>[w(X(_.verbose_name),1)]),_:2},1024),S("div",fl,[_.built_in?Je("",!0):(b(),T(Xe,{key:0},{default:t(()=>{var a;return[$((b(),T(Ce,{class:"box-item",effect:"dark",content:"编辑",placement:"top"},{default:t(()=>{var I;return[$(e(c,{size:"small",onClick:Ee(Se=>le(_),["stop"]),icon:O(Ge),circle:""},null,8,["onClick","icon"]),[[me,`${(I=O(F).name)==null?void 0:I.replace("_info","")}:edit`]])]}),_:2},1024)),[[me,`${(a=O(F).name)==null?void 0:a.replace("_info","")}:edit`]]),e(Ce,{class:"box-item",effect:"dark",content:"删除",placement:"top"},{default:t(()=>{var I;return[$(e(c,{size:"small",onClick:Ee(Se=>qe(_.id),["stop"]),icon:O(Pe),circle:""},null,8,["onClick","icon"]),[[me,`${(I=O(F).name)==null?void 0:I.replace("_info","")}:delete`]])]}),_:2},1024)]}),_:2},1024))])]),default:t(()=>[S("div",null,[e(O(pl),{"force-fallback":!0,"scroll-sensitivity":200,ref_for:!0,ref:"el",group:"modelField",modelValue:_.fields,"onUpdate:modelValue":a=>_.fields=a,onEnd:a=>Ke(a,_),onAdd:a=>We(a,_),style:{width:"100%","flex-wrap":"wrap",display:"flex",gap:"10px","justify-items":"flex-start"}},{default:t(()=>{var a;return[(b(!0),L(P,null,oe(_.fields,(I,Se)=>(b(),L("div",{key:Se},[e(Ce,{effect:"light",content:"点击编辑字段",placement:"top"},{default:t(()=>[e(Ae,{shadow:"hover",class:al(["modelFieldCard",I.built_in?"isBuiltClass":""]),onClick:Ol=>Oe(I)},{default:t(()=>[e(r,{tag:"b"},{default:t(()=>[w(X(I.verbose_name),1)]),_:2},1024),e(ze,{justify:"space-between"},{default:t(()=>[e(Ce,{class:"box-item",effect:"light",content:I.name,placement:"bottom"},{default:t(()=>[e(he,{span:13,class:"describe-class"},{default:t(()=>[e(r,null,{default:t(()=>[w(X(I.name),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["content"]),e(Ce,{class:"box-item",effect:"light",content:I.type,placement:"bottom"},{default:t(()=>[e(he,{span:10,class:"describe-class"},{default:t(()=>[e(r,null,{default:t(()=>[w(X(I.type),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["content"])]),_:2},1024)]),_:2},1032,["class","onClick"])]),_:2},1024)]))),128)),S("div",null,[$((b(),T(Ae,{class:"modelFieldCard",style:{"align-items":"center","justify-content":"center"},onClick:I=>be(_)},{default:t(()=>[e(r,{type:"primary"},{default:t(()=>l[26]||(l[26]=[w("+ 添加字段")])),_:1})]),_:2},1032,["onClick"])),[[me,`${(a=O(F).name)==null?void 0:a.replace("_info","")}:add`]])])]}),_:2},1032,["modelValue","onUpdate:modelValue","onEnd","onAdd"])])]),_:2},1032,["name"]))),128))]),_:1},8,["modelValue"]),e(ze,{style:{"margin-top":"10px"}},{default:t(()=>[e(he,null,{default:t(()=>{var _;return[$((b(),T(c,{bg:"",text:"",onClick:l[1]||(l[1]=$e=>N(D.value))},{default:t(()=>l[27]||(l[27]=[w("添加分组")])),_:1})),[[me,`${(_=O(F).name)==null?void 0:_.replace("_info","")}:add`]])]}),_:1})]),_:1})]),e(ll,{modelValue:n.value,"onUpdate:modelValue":l[6]||(l[6]=_=>n.value=_),title:p.value+"字段分组",width:"500","before-close":se},{footer:t(()=>[S("div",cl,[e(c,{onClick:l[4]||(l[4]=_=>W(i.value))},{default:t(()=>l[28]||(l[28]=[w("取消")])),_:1}),e(c,{type:"primary",onClick:l[5]||(l[5]=_=>we(i.value))},{default:t(()=>l[29]||(l[29]=[w(" 确认 ")])),_:1})])]),default:t(()=>[e(De,{ref_key:"groupFormRef",ref:i,style:{"max-width":"600px"},model:U,rules:ye,"label-width":"auto",class:"demo-modelForm","status-icon":""},{default:t(()=>[e(j,{label:"字段组标识",prop:"name"},{default:t(()=>[e(ge,{modelValue:U.name,"onUpdate:modelValue":l[2]||(l[2]=_=>U.name=_),disabled:!M.value},null,8,["modelValue","disabled"])]),_:1}),e(j,{label:"字段分组名称",prop:"verbose_name"},{default:t(()=>[e(ge,{modelValue:U.verbose_name,"onUpdate:modelValue":l[3]||(l[3]=_=>U.verbose_name=_)},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"]),e(tl,{modelValue:J.value,"onUpdate:modelValue":l[25]||(l[25]=_=>J.value=_),title:"模型字段","before-close":Qe,direction:"rtl",class:"demo-drawer"},{default:t(()=>{var _,$e;return[S("div",_l,[e(De,{model:s,ref_key:"modelFieldFormRef",ref:re,"label-width":"auto","label-position":"right",rules:Ue},{default:t(()=>[e(j,{label:"唯一标识",prop:"name"},{default:t(()=>[e(ge,{modelValue:s.name,"onUpdate:modelValue":l[7]||(l[7]=a=>s.name=a),autocomplete:"off",disabled:!!(G.value.built_in||ne.value)},null,8,["modelValue","disabled"])]),_:1}),e(j,{label:"显示名称",prop:"verbose_name"},{default:t(()=>[e(ge,{modelValue:s.verbose_name,"onUpdate:modelValue":l[8]||(l[8]=a=>s.verbose_name=a),autocomplete:"off"},null,8,["modelValue"])]),_:1}),e(j,{label:"可编辑",prop:"editable"},{default:t(()=>[e(Re,{modelValue:s.editable,"onUpdate:modelValue":l[9]||(l[9]=a=>s.editable=a),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},disabled:G.value.built_in},null,8,["modelValue","disabled"])]),_:1}),e(j,{label:"必填",prop:"required"},{default:t(()=>[e(Re,{modelValue:s.required,"onUpdate:modelValue":l[10]||(l[10]=a=>s.required=a),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"}},null,8,["modelValue"])]),_:1}),e(j,{label:"字段类型",prop:"type"},{default:t(()=>[e(Me,{modelValue:s.type,"onUpdate:modelValue":l[11]||(l[11]=a=>s.type=a),placeholder:"Select",style:{width:"240px"},onChange:z,disabled:!!(G.value.built_in||ne.value)},{default:t(()=>[(b(!0),L(P,null,oe(v.value,a=>(b(),T(Fe,{key:a.value,label:a.label,value:a.value},{default:t(()=>[S("span",vl,X(a.label),1),S("span",bl,X(a.value),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),$(e(j,{label:"校验规则",prop:"validation_rule"},{default:t(()=>[e(Re,{modelValue:q.value,"onUpdate:modelValue":l[12]||(l[12]=a=>q.value=a),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949","margin-right":"10px"}},null,8,["modelValue"]),$(e(Me,{modelValue:s.validation_rule,"onUpdate:modelValue":l[13]||(l[13]=a=>s.validation_rule=a),placeholder:"选择校验规则",style:{width:"240px"}},{default:t(()=>[(b(!0),L(P,null,oe(ve.value,a=>(b(),T(Fe,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),[[pe,q.value]])]),_:1},512),[[pe,s.type==="string"]]),$(e(j,{label:"枚举值",prop:"validation_rule"},{default:t(()=>[e(Me,{modelValue:s.validation_rule,"onUpdate:modelValue":l[14]||(l[14]=a=>s.validation_rule=a),placeholder:"选择校验规则",style:{width:"240px"},onChange:l[15]||(l[15]=a=>Z(s.validation_rule))},{default:t(()=>[(b(!0),L(P,null,oe(ve.value,a=>(b(),T(Fe,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},512),[[pe,s.type==="enum"]]),$(e(j,{label:"默认值",prop:"default"},{default:t(()=>[e(Me,{modelValue:s.default,"onUpdate:modelValue":l[16]||(l[16]=a=>s.default=a),placeholder:"选择默认值",size:"large",onVisibleChange:l[17]||(l[17]=a=>ae(s.validation_rule))},{default:t(()=>[(b(!0),L(P,null,oe(Q.value,(a,I)=>(b(),T(Fe,{key:I,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},512),[[pe,s.type==="enum"]]),$(e(j,{label:"模型引用",prop:"ref_model"},{default:t(()=>[e(Me,{modelValue:s.ref_model,"onUpdate:modelValue":l[18]||(l[18]=a=>s.ref_model=a),placeholder:"选择CI模型",disabled:!!(G.value.built_in||ne.value)},{default:t(()=>[(b(!0),L(P,null,oe(y.value,a=>(b(),T(Fe,{key:a.value,label:a.label,disabled:a.disabled,value:a.value},null,8,["label","disabled","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1},512),[[pe,s.type==="model_ref"]]),$(e(j,{label:"默认值",prop:"default"},{default:t(()=>[e(Re,{modelValue:s.default,"onUpdate:modelValue":l[19]||(l[19]=a=>s.default=a),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"}},null,8,["modelValue"])]),_:1},512),[[pe,s.type==="boolean"]]),$(e(j,{label:"单位",prop:"unit"},{default:t(()=>[e(ge,{modelValue:s.unit,"onUpdate:modelValue":l[20]||(l[20]=a=>s.unit=a),style:{width:"120px"}},null,8,["modelValue"])]),_:1},512),[[pe,s.type==="integer"||s.type==="float"]]),e(j,{label:"描述",prop:"description"},{default:t(()=>[e(ge,{modelValue:s.description,"onUpdate:modelValue":l[21]||(l[21]=a=>s.description=a),type:"textarea"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),S("div",gl,[e(c,{onClick:l[22]||(l[22]=a=>g(re.value))},{default:t(()=>l[30]||(l[30]=[w("取消")])),_:1}),ne.value&&!G.value.built_in?$((b(),T(c,{key:0,type:"danger",onClick:l[23]||(l[23]=a=>Ze())},{default:t(()=>l[31]||(l[31]=[w("删除")])),_:1})),[[me,`${(_=O(F).name)==null?void 0:_.replace("_info","")}:delete`]]):Je("",!0),$((b(),T(c,{type:"primary",onClick:l[24]||(l[24]=a=>Ie(re.value))},{default:t(()=>l[32]||(l[32]=[w(" 确定 ")])),_:1})),[[me,`${($e=O(F).name)==null?void 0:$e.replace("_info","")}:edit`]])])])]}),_:1},8,["modelValue"])],64)}}}),wl=He(yl,[["__scopeId","data-v-9d0d5824"]]),Vl={style:{width:"100%"}},Cl={class:"table-header"},Fl={class:"header-button-lf"},Ml={class:"dialog-footer"},$l=Ne({__name:"ciModelUnique",props:["modelId","modelFieldLists"],setup(xe,{expose:B}){const k=Te(),{proxy:h}=Be(),F=je(),D=m([]),R=xe,Y=()=>{z.value=!0,ae.value=!0},_e=de(()=>{let v={};return R.modelFieldLists.forEach(u=>{v[u.name]=u.verbose_name}),v}),H=m(""),y=fe({fields:[],validate_null:!1,description:null}),z=m(!1),Q=()=>{z.value=!1,ee(H.value)},ae=m(!0),Z=m({}),q=v=>{Z.value=v,z.value=!0,ae.value=!1,ke(()=>{Object.keys(v).forEach(u=>{u!=="id"&&Object.keys(y).indexOf(u)!==-1&&(y[u]=v[u])})})},ee=v=>{v&&(v.resetFields(),Z.value={})},ie=async v=>{await v.validate(async(u,E)=>{if(u)if(ae.value){let x=await h.$api.addCiModelUnique({create_user:F.state.username,update_user:F.state.username,...y,model:R.modelId});x.status=="201"?(f({type:"success",message:"添加成功"}),z.value=!1,ee(v),C({model:R.modelId})):f({showClose:!0,message:"添加失败:"+JSON.stringify(x.data),type:"error"})}else{let x=await h.$api.updateCiModelUnique({id:Z.value.id,update_user:F.state.username,...y});x.status=="200"?(f({type:"success",message:"更新成功"}),z.value=!1,ee(v),C({model:R.modelId})):f({showClose:!0,message:"更新失败:"+JSON.stringify(x.data),type:"error"})}})},V=async v=>{let u=await h.$api.updateCiModelUnique({update_user:F.state.username,...v});u.status=="200"?(f({type:"success",message:"更新成功"}),ee(H.value),C({model:R.modelId})):f({showClose:!0,message:"更新失败:"+JSON.stringify(u.data),type:"error"})},K=v=>{ce.confirm("是否确认删除?","删除",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await h.$api.deleteCiModelUnique(v)).status==204?(f({type:"success",message:"删除成功"}),C({model:R.modelId}),ee(H.value),z.value=!1):f({type:"error",message:"删除失败"})}).catch(()=>{f({type:"info",message:"取消删除"})})},ve=de(()=>{let v={};return D.value.forEach(u=>{var x;let E=u.fields.map(U=>_e.value[U]);v[(x=u.fields)==null?void 0:x.join("+")]=E.join("+")}),v}),C=async v=>{let u=await h.$api.getCiModelUnique(v);D.value=u.data.results};return B({getTableData:C}),(v,u)=>{const E=d("el-button"),x=d("el-table-column"),U=d("el-switch"),ue=d("el-tooltip"),ye=d("el-table"),i=d("el-option"),n=d("el-select"),W=d("el-form-item"),M=d("el-input"),A=d("el-form"),we=d("el-dialog"),se=Le("permission");return b(),L("div",Vl,[S("div",Cl,[S("div",Fl,[e(E,{type:"primary",onClick:Y},{default:t(()=>u[5]||(u[5]=[w("添加")])),_:1})])]),e(ye,{ref:"multipleTableRef",data:D.value,style:{width:"100%"},border:""},{default:t(()=>[e(x,{prop:"fields",label:"校验规则"},{default:t(p=>[S("span",null,X(ve.value[p.row.fields.join("+")]),1)]),_:1}),e(x,{prop:"validate_null",label:"空值校验"},{default:t(p=>{var N;return[$(e(U,{modelValue:p.row.validate_null,"onUpdate:modelValue":le=>p.row.validate_null=le,class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},onChange:le=>V({id:p.row.id,validate_null:p.row.validate_null}),disabled:p.row.built_in},null,8,["modelValue","onUpdate:modelValue","onChange","disabled"]),[[se,{id:`${(N=O(k).name)==null?void 0:N.replace("_info","")}:edit`,action:"disabled"}]])]}),_:1}),e(x,{prop:"description",label:"描述"}),e(x,{fixed:"right",width:"100",label:"操作"},{default:t(p=>[e(ue,{class:"box-item",effect:"dark",content:"编辑",placement:"top"},{default:t(()=>{var N;return[$(e(E,{link:"",type:"primary",icon:O(Ge),onClick:le=>q(p.row)},null,8,["icon","onClick"]),[[se,`${(N=O(k).name)==null?void 0:N.replace("_info","")}:edit`]])]}),_:2},1024),e(ue,{class:"box-item",effect:"dark",content:"删除",placement:"top"},{default:t(()=>{var N;return[$(e(E,{link:"",type:"danger",icon:O(Pe),disabled:p.row.built_in,onClick:le=>K(p.row.id)},null,8,["icon","disabled","onClick"]),[[se,`${(N=O(k).name)==null?void 0:N.replace("_info","")}:delete`]])]}),_:2},1024)]),_:1})]),_:1},8,["data"]),e(we,{modelValue:z.value,"onUpdate:modelValue":u[4]||(u[4]=p=>z.value=p),title:"唯一校验配置",width:"500","before-close":Q},{footer:t(()=>[S("div",Ml,[e(E,{onClick:Q},{default:t(()=>u[6]||(u[6]=[w("取消")])),_:1}),e(E,{type:"primary",onClick:u[3]||(u[3]=p=>ie(H.value))},{default:t(()=>u[7]||(u[7]=[w(" 提交 ")])),_:1})])]),default:t(()=>[e(A,{inline:!0,"label-position":"right",model:y,"label-width":"auto",ref_key:"formRef",ref:H},{default:t(()=>[e(W,{label:"唯一校验组合",prop:"fields"},{default:t(()=>[e(n,{modelValue:y.fields,"onUpdate:modelValue":u[0]||(u[0]=p=>y.fields=p),fields:"选择字段组合",multiple:"","multiple-limit":5,clearable:"",filterable:"",style:{width:"240px"},disabled:!!(Z.value.built_in||!ae.value)},{default:t(()=>[(b(!0),L(P,null,oe(R.modelFieldLists,(p,N)=>(b(),T(i,{label:p.verbose_name,value:p.name,key:N},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),e(W,{label:"空置校验",prop:"validate_null"},{default:t(()=>[e(U,{modelValue:y.validate_null,"onUpdate:modelValue":u[1]||(u[1]=p=>y.validate_null=p),class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},disabled:Z.value.built_in},null,8,["modelValue","disabled"])]),_:1}),e(W,{label:"描述",prop:"description"},{default:t(()=>[e(M,{modelValue:y.description,"onUpdate:modelValue":u[2]||(u[2]=p=>y.description=p),style:{width:"240px"},autosize:{minRows:2,maxRows:4},type:"textarea"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),kl={class:"card"},xl={class:"dialog-footer"},Ul=Ne({__name:"modelinfoView",setup(xe){const B=Te(),k=ml(),h=m(""),F=m("");sl();const D=je(),{proxy:R}=Be();m("");const Y=m([]),_e=async()=>{let i=await R.$api.getCiModelGroup();console.log(i),Y.value=i.data.results,console.log(Y.value)},H=m({}),y=m({}),z=async()=>{let i=await R.$api.getCiModel(B.query,B.query.id);y.value=i.data.model,H.value=i.data},Q=de(()=>{var n;let i=new Array;return(n=H.value.field_groups)==null||n.forEach(W=>{W.fields.forEach(M=>{i.push(M)})}),i}),ae=(i,n)=>{i.props.name==="verification"?h.value.getTableData({model:ie.value}):i.props.name},Z=m("field");console.log(B);const q=m(!1),ee=()=>{q.value=!0};m("ElemeFilled");const ie=de(()=>{var i;return(i=y.value)==null?void 0:i.id}),V=fe({name:"",verbose_name:"",model_group:"",icon:"ElemeFilled",built_in:!1,update_user:"admin"}),K=m(),ve=fe({name:[{required:!0,message:"请输入模型标识",trigger:"blur"},{pattern:/^[a-z][a-z_]{3,20}$/,trigger:"blur",message:"以英文字符开头,可以使用英文,下划线,长度3-20 ",required:!0}],verbose_name:[{required:!0,message:"请输入模型名称",trigger:"blur"}],model_group:[{required:!0,message:"请选择分组",trigger:"blur"}]});m(!1);const C=m(!1),v=i=>{C.value=!1,x(i)},u=async i=>{i&&await i.validate(async(n,W)=>{if(n){let M=await R.$api.updateCiModel({id:ue.value,...V});console.log(M),M.status=="200"?(f({type:"success",message:"更新成功"}),C.value=!1,x(i),getCiModelInfo(B.query,B.query.id)):f({showClose:!0,message:"添加失败:"+JSON.stringify(M.data),type:"error"})}})},E=i=>{ce.confirm("是否确认关闭?").then(()=>{i(),x(K.value)}).catch(()=>{})},x=i=>{i&&i.resetFields()},U=i=>{ce.confirm("是否确认删除?","删除组",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await R.$api.deleteCiModel(i)).status==204?(f({type:"success",message:"删除成功"}),k.removeTabs(B.path,!0)):f({type:"error",message:"删除失败"})}).catch(()=>{f({type:"info",message:"取消删除"})})},ue=m(""),ye=i=>{console.log(i),V.icon=i.icon,V.verbose_name=i.verbose_name,V.name=i.name,V.model_group=i.model_group,V.update_user=D.state.username,console.log(V),C.value=!0,ue.value=i.id,_e()};return nl(async()=>{console.log("onMount"),await z(),await F.value.getModelField(),await F.value.getCiModelList(),await F.value.getRules(),await F.value.getModelFieldType()}),dl(()=>{console.log("onUnmounted")}),il(()=>{console.log("onBeforeMount")}),(i,n)=>{const W=ul,M=d("el-button"),A=d("el-text"),we=d("el-link"),se=d("el-space"),p=d("el-col"),N=d("el-row"),le=d("el-tab-pane"),qe=d("el-tabs"),J=d("el-scrollbar"),s=d("el-form-item"),Ue=d("el-input"),re=d("el-option"),ne=d("el-select"),G=d("el-form"),Ve=d("el-dialog"),Oe=Le("permission");return b(),L(P,null,[S("div",kl,[e(J,null,{default:t(()=>[e(N,{class:"cimodelinfo",justify:"space-between"},{default:t(()=>[e(p,{span:20},{default:t(()=>[e(se,{size:30,style:{width:"40%"}},{default:t(()=>[e(M,{size:"large",circle:"",disabled:"",style:{margin:"10px"}},{default:t(()=>{var g;return[e(W,{icon:(g=y.value)==null?void 0:g.icon},null,8,["icon"])]}),_:1}),e(A,null,{default:t(()=>[n[11]||(n[11]=w("唯一标识:   ")),e(A,{tag:"b"},{default:t(()=>[w(X(y.value.name),1)]),_:1})]),_:1}),e(A,null,{default:t(()=>[n[12]||(n[12]=w("名称:   ")),e(A,{tag:"b"},{default:t(()=>[w(X(y.value.verbose_name),1)]),_:1})]),_:1}),e(A,null,{default:t(()=>[n[13]||(n[13]=w("实例数:   ")),e(we,{type:"primary",tag:"b",disabled:"",href:"/#/cmdb/cidata"},{default:t(()=>[w(X(y.value.instance_count),1)]),_:1})]),_:1})]),_:1})]),_:1}),e(p,{span:2,style:{display:"flex","align-items":"center","justify-content":"center"}},{default:t(()=>[e(se,{alignment:"flex-end"},{default:t(()=>{var g,be;return[$(e(M,{disabled:y.value.built_in,icon:"Delete",onClick:n[0]||(n[0]=Ie=>U(y.value.id)),circle:""},null,8,["disabled"]),[[Oe,`${(g=O(B).name)==null?void 0:g.replace("_info","")}:delete`]]),$(e(M,{disabled:y.value.built_in,icon:"Edit",onClick:n[1]||(n[1]=Ie=>ye(y.value)),circle:""},null,8,["disabled"]),[[Oe,`${(be=O(B).name)==null?void 0:be.replace("_info","")}:edit`]])]}),_:1})]),_:1})]),_:1}),e(qe,{modelValue:Z.value,"onUpdate:modelValue":n[2]||(n[2]=g=>Z.value=g),type:"card",class:"demo-tabs",onTabClick:ae},{default:t(()=>[e(le,{label:"模型字段",name:"field"},{default:t(()=>[e(wl,{ref_key:"ciModelFieldRef",ref:F},null,512)]),_:1}),e(le,{label:"唯一校验",name:"verification"},{default:t(()=>[e($l,{modelId:ie.value,modelFieldLists:Q.value,ref_key:"ciModelUniqueRef",ref:h},null,8,["modelId","modelFieldLists"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),e(Ve,{modelValue:C.value,"onUpdate:modelValue":n[10]||(n[10]=g=>C.value=g),title:"编辑模型",width:"500","before-close":E},{footer:t(()=>[S("div",xl,[e(M,{onClick:n[8]||(n[8]=g=>v(K.value))},{default:t(()=>n[14]||(n[14]=[w("取消")])),_:1}),e(M,{type:"primary",onClick:n[9]||(n[9]=g=>u(K.value))},{default:t(()=>n[15]||(n[15]=[w(" 确认 ")])),_:1})])]),default:t(()=>[e(G,{ref_key:"modelFormRef",ref:K,style:{"max-width":"600px"},model:V,rules:ve,"label-width":"auto",class:"demo-modelForm","status-icon":""},{default:t(()=>[e(s,{label:"模型图标",prop:"icon"},{default:t(()=>[e(M,{onClick:ee,icon:V.icon},null,8,["icon"]),e(rl,{isShow:q.value,"onUpdate:isShow":n[3]||(n[3]=g=>q.value=g),iconName:V.icon,"onUpdate:iconName":n[4]||(n[4]=g=>V.icon=g)},null,8,["isShow","iconName"])]),_:1}),e(s,{label:"唯一标识",prop:"name"},{default:t(()=>[e(Ue,{modelValue:V.name,"onUpdate:modelValue":n[5]||(n[5]=g=>V.name=g),placeholder:"请输入模型的唯一标识",disabled:""},null,8,["modelValue"])]),_:1}),e(s,{label:"模型名称",prop:"verbose_name"},{default:t(()=>[e(Ue,{modelValue:V.verbose_name,"onUpdate:modelValue":n[6]||(n[6]=g=>V.verbose_name=g)},null,8,["modelValue"])]),_:1}),e(s,{label:"所属分组",prop:"model_group"},{default:t(()=>[e(ne,{modelValue:V.model_group,"onUpdate:modelValue":n[7]||(n[7]=g=>V.model_group=g),placeholder:"选择分组"},{default:t(()=>[(b(!0),L(P,null,oe(Y.value,(g,be)=>(b(),T(re,{label:g.verbose_name,value:g.id,key:be},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])],64)}}}),Sl=He(Ul,[["__scopeId","data-v-005e3710"]]);export{Sl as default};
