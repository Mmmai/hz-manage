import{d as Ue,g as je,j as Be,v as ee,r as l,x as De,bP as te,z as Ke,aP as $,A as Le,h as i,bc as ae,c as U,o as r,f as s,b as f,w as n,F as Oe,i as Pe,B as d,bV as w,q as b,t as v,m as g,k as m,l as Ae,ca as Re,aa as Ze,cx as Ie,cy as qe,c8 as Ee,b_ as h}from"./index-D37lWo2y.js";import{m as Fe}from"./model-q4opNTTD.js";const He={class:"card",style:{display:"flex","flex-direction":"column"}},Je={class:"card",style:{display:"flex"}},Ge={class:"ci_data_tree card",style:{height:"100%"}},Qe={class:"flexJbetween"},We={style:{flex:"1",height:"100%"}},Xe={class:"card table-main",style:{width:"100%"}},Ye={class:"table-header"},et={class:"header-button-lf"},tt={class:"header-button-ri"},at={key:0},lt={key:0},rt=Ue({name:"ciSyncZabbix",__name:"nodeManageView",setup(nt){const{proxy:y}=je(),le=Be(),ne=Fe(),se=ee(()=>ne.modelObjectByName),oe=a=>{le.push({path:x.path+"/"+a.id})},u=l("hosts"),x=De(),P=l([]),A=l(!0);l(""),l(!0),l(!1),l({}),l({});const j=l(1),B=l(10),re=l("default"),ie=l(!1),R=l(0),D=l(""),ue=l("model_instance_name"),de=l(""),V=l({}),ce=l([{value:"model_instance_name",label:"唯一标识",sort:!0,filter:!0,type:"string",required:!0},{value:"ip_address",label:"ip地址",sort:!1,filter:!0,type:"string",required:!0}]),K=l([]);l([]),l([]);const Z=l([]),me=l(null);ee(()=>{let a=[];return ce.value.forEach(e=>{e.filter&&a.push({name:e.label,value:e.value})}),a}),te(de,a=>{V.value={[ue.value]:a}});const pe=async()=>{let a=await y.$api.getModelConfig({ordering:"create_time"});a.status==200&&(Z.value=a.data.results.filter(e=>e.is_manage===!0).map(e=>({label:e.model_verbose_name||e.model_name,name:e.model_name})))},p=async()=>{let a=await y.$api.getNodes({model_instance_group_id:k.value,model_name:u.value,page:j.value,page_size:B.value,search:D.value,...V.value,...T.value});P.value=a.data.results,R.value=a.data.count,A.value=!1},_e=async(a,e)=>{let _={};_[e]=a[e],(await y.$api.updateNodes({id:a.id,..._})).status==200?(h({type:"success",message:"更新成功"}),p()):h({type:"error",message:"更新失败"})},fe=async()=>{await y.$api.syncZabbixHost({model_name:u.value}),h({type:"success",message:"触发主机同步~"})},ve=async a=>{await y.$api.syncZabbixHost({node_id:a.id}),h({type:"success",message:"触发主机同步~"})},I=async a=>{let e=await y.$api.installAgent(a);e.status==200?h({type:"success",message:"触发成功"}):h({type:"error",message:`触发失败:${e.data.message}`})},ge=async a=>{let e=await y.$api.get_inventory(a);e.status==200?h({type:"success",message:"触发成功"}):h({type:"error",message:`触发失败:${e.data.message}`})},ye=(a,e)=>{k.value,$(()=>{J(),p()})},q=()=>{p()},T=l({ordering:"-model_instance_name"}),be=a=>{a.order==="ascending"?T.value.ordering=a.prop:a.order==="descending"?T.value.ordering="-"+a.prop:T.value={ordering:"-model_instance_name"},p()},E=a=>a===1?"success":a===0?"danger":"info",F=a=>a===1?"正常":a===0?"异常":"未知",he=a=>{K.value=a.map(e=>e.id)},ke=a=>{const e=Object.keys(a)[0],_=Object.values(a)[0];_.length===1?V.value[e]=_[0]:_.length>1?V.value[`${e}`]=_.join(","):V.value[e]=null,$(()=>{}),$(()=>{p()})},we=()=>{var a;(a=me.value)==null||a.close()},H=l([]),N=l(null),k=l(null),L=l(!0),O=l("");te(O,a=>{N.value.filter(a)});const xe=(a,e)=>a?e.label.toLowerCase().includes(a.toLowerCase()):!0,J=async()=>{var e;L.value=!0;let a=await y.$api.getCiModelTree({model:(e=se.value[u.value])==null?void 0:e.id});H.value=[a.data],$(()=>{k.value===null&&(console.log("treeData.value",a.data.id),N.value.setCurrentKey(a.data.id),k.value=N.value.getCurrentKey(),console.log("currentNodeId.value",k.value))}),L.value=!1},Ce=a=>{k.value=N.value.getCurrentKey(),$(()=>{p()})};return Ke(async()=>{await J(),await pe(),$(async()=>{await p()})}),Le(()=>{we()}),(a,e)=>{const _=i("el-tab-pane"),G=i("el-tabs"),Q=i("el-input"),$e=i("el-text"),M=i("el-tag"),Ve=i("el-tree"),W=i("el-splitter-panel"),S=i("el-button"),C=i("el-tooltip"),c=i("el-table-column"),Ne=i("el-link"),Se=i("el-switch"),ze=i("el-table"),Te=i("el-pagination"),Me=i("el-splitter"),X=ae("loading"),z=ae("permission");return r(),U("div",He,[s(G,{modelValue:u.value,"onUpdate:modelValue":e[0]||(e[0]=t=>u.value=t),type:"card",class:"demo-tabs",onTabClick:ye},{default:n(()=>[(r(!0),U(Oe,null,Pe(Z.value,(t,o)=>(r(),d(_,{label:t.label,name:t.name,key:o},null,8,["label","name"]))),128))]),_:1},8,["modelValue"]),f("div",Je,[s(Me,null,{default:n(()=>[s(W,{size:300,max:500,min:200},{default:n(()=>[f("div",Ge,[s(Q,{modelValue:O.value,"onUpdate:modelValue":e[1]||(e[1]=t=>O.value=t),clearable:"",style:{"max-width":"280px","margin-bottom":"10px"},size:"small",placeholder:"检索节点"},null,8,["modelValue"]),w((r(),d(Ve,{ref_key:"treeRef",ref:N,data:H.value,"node-key":"id","expand-on-click-node":!1,"highlight-current":!0,"default-expand-all":"","filter-node-method":xe,onNodeClick:Ce,"current-node-key":k.value},{default:n(({node:t,data:o})=>[f("div",Qe,[s($e,{size:"default"},{default:n(()=>[b(v(t.label),1)]),_:2},1024),s(M,{size:"small",type:o.instance_count>>0?"success":"info"},{default:n(()=>[b(v(o.instance_count),1)]),_:2},1032,["type"])])]),_:1},8,["data","current-node-key"])),[[X,L.value]])])]),_:1}),s(W,{min:200},{default:n(()=>[f("div",We,[f("div",Xe,[f("div",Ye,[f("div",et,[s(C,{class:"box-item",effect:"dark",content:"触发主机信息同步到zabbix",placement:"top"},{default:n(()=>{var t;return[w((r(),d(S,{type:"primary",onClick:e[2]||(e[2]=o=>fe())},{default:n(()=>[...e[11]||(e[11]=[b("触发同步",-1)])]),_:1})),[[z,`${(t=g(x).name)==null?void 0:t.replace("_info","")}:add`]])]}),_:1}),s(C,{class:"box-item",effect:"dark",content:"触发重装已勾选的主机",placement:"top"},{default:n(()=>{var t;return[u.value==="hosts"?w((r(),d(S,{key:0,type:"primary",disabled:!(K.value.length>>>0),onClick:e[3]||(e[3]=o=>I({id:K.value}))},{default:n(()=>[...e[12]||(e[12]=[b("批量安装",-1)])]),_:1},8,["disabled"])),[[z,`${(t=g(x).name)==null?void 0:t.replace("_info","")}:add`]]):m("",!0)]}),_:1})]),f("div",tt,[s(Q,{modelValue:D.value,"onUpdate:modelValue":e[4]||(e[4]=t=>D.value=t),style:{width:"240px"},placeholder:"回车查询",clearable:"","prefix-icon":g(Re),onClear:e[5]||(e[5]=t=>p()),onKeyup:e[6]||(e[6]=Ae(t=>p(),["enter","native"]))},null,8,["modelValue","prefix-icon"])])]),w((r(),d(ze,{ref:"multipleTableRef",data:P.value,style:{width:"100%"},height:"100%",border:"","row-key":t=>t.id,onSortChange:be,onSelectionChange:he,onFilterChange:ke},{default:n(()=>[s(c,{type:"selection","reserve-selection":!0,width:"55"}),s(c,{property:"model_instance_name",label:"唯一标识",sortable:"custom"},Ze({_:2},[u.value==="hosts"?{name:"default",fn:n(t=>[s(C,{content:"查看详情",placement:"right",effect:"dark"},{default:n(()=>[s(Ne,{type:"primary",onClick:o=>oe(t.row)},{default:n(()=>[b(v(t.row.model_instance_name),1)]),_:2},1032,["onClick"])]),_:2},1024)]),key:"0"}:{name:"default",fn:n(t=>[f("span",null,v(t.row.model_instance_name),1)]),key:"1"}]),1024),s(c,{property:"ip_address",sortable:"custom",label:"ip地址"}),s(c,{property:"proxy_name",label:"代理",sortable:"custom",width:"120"},{default:n(t=>[t.row.proxy_name?(r(),d(M,{key:0},{default:n(()=>[b(v(t.row.proxy_name),1)]),_:2},1024)):m("",!0)]),_:1}),u.value==="hosts"?(r(),d(c,{key:0,"column-key":"manage_status",property:"manage_status",label:"管理状态",sortable:"custom",width:"140",filters:[{text:"正常",value:1},{text:"异常",value:0},{text:"未知",value:2}]},{default:n(t=>[s(M,{type:E(t.row.manage_status),effect:"dark"},{default:n(()=>[b(v(F(t.row.manage_status)),1)]),_:2},1032,["type"])]),_:1})):m("",!0),s(c,{"column-key":"enable_sync",property:"enable_sync",label:"是否同步",sortable:"custom",width:"140",filters:[{text:"启用",value:!0},{text:"禁用",value:!1}]},{default:n(t=>[s(Se,{modelValue:t.row.enable_sync,"onUpdate:modelValue":o=>t.row.enable_sync=o,class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},onChange:o=>_e(t.row,"enable_sync")},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),u.value==="hosts"?(r(),d(c,{key:1,"column-key":"agent_status",property:"agent_status",label:"agent状态",sortable:"custom",width:"140",filters:[{text:"正常",value:1},{text:"异常",value:0},{text:"未知",value:2}]},{default:n(t=>[s(M,{type:E(t.row.agent_status),effect:"dark"},{default:n(()=>[b(v(F(t.row.agent_status)),1)]),_:2},1032,["type"])]),_:1})):m("",!0),u.value==="hosts"?(r(),d(c,{key:2,property:"manage_error_message",label:"管理错误信息",width:"500"},{default:n(t=>[t.row.manage_error_message?(r(),U("span",at,v(JSON.stringify(t.row.manage_error_message)),1)):m("",!0)]),_:1})):m("",!0),u.value==="hosts"?(r(),d(c,{key:3,property:"agent_error_message",label:"agent错误信息",width:"500"},{default:n(t=>[t.row.agent_error_message?(r(),U("span",lt,v(JSON.stringify(t.row.agent_error_message)),1)):m("",!0)]),_:1})):m("",!0),s(c,{fixed:"right",width:"120",label:"操作"},{default:n(t=>[s(C,{class:"box-item",effect:"dark",content:"触发同步",placement:"top"},{default:n(()=>{var o;return[w(s(S,{link:"",type:"primary",icon:g(Ie),onClick:Y=>ve({id:t.row.id})},null,8,["icon","onClick"]),[[z,`${(o=g(x).name)==null?void 0:o.replace("_info","")}:edit`]])]}),_:2},1024),u.value==="hosts"?(r(),d(C,{key:0,class:"box-item",effect:"dark",content:"管理状态更新",placement:"top"},{default:n(()=>{var o;return[w(s(S,{link:"",type:"primary",icon:g(qe),onClick:Y=>ge({id:t.row.id})},null,8,["icon","onClick"]),[[z,`${(o=g(x).name)==null?void 0:o.replace("_info","")}:edit`]])]}),_:2},1024)):m("",!0),u.value==="hosts"?(r(),d(C,{key:1,class:"box-item",effect:"dark",content:"触发agent安装",placement:"top"},{default:n(()=>{var o;return[w(s(S,{link:"",type:"primary",icon:g(Ee),onClick:Y=>I({id:t.row.id})},null,8,["icon","onClick"]),[[z,`${(o=g(x).name)==null?void 0:o.replace("_info","")}:edit`]])]}),_:2},1024)):m("",!0)]),_:1})]),_:1},8,["data","row-key"])),[[X,A.value]]),s(Te,{"current-page":j.value,"onUpdate:currentPage":[e[7]||(e[7]=t=>j.value=t),e[9]||(e[9]=t=>q())],"page-size":B.value,"onUpdate:pageSize":[e[8]||(e[8]=t=>B.value=t),e[10]||(e[10]=t=>q())],"page-sizes":[10,20,50,100,200],size:re.value,disabled:ie.value,layout:"total, sizes, prev, pager, next, jumper",total:R.value,style:{"margin-top":"5px","justify-content":"flex-end"}},null,8,["current-page","page-size","size","disabled","total"])])])]),_:1})]),_:1})])])}}});export{rt as default};
