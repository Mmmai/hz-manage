import{d as ze,g as Re,u as $e,r as u,h as Fe,A as $,a as Ne,z as ue,q as Je,e as i,aj as qe,c,o as s,i as F,b as n,aa as Z,v as x,D as p,w as r,k as M,a7 as N,a8 as J,j as De,ak as Te,al as Ae,F as re,am as Be,an as Ee,s as ie,ao as y,I as Me}from"./index-iGnbKzkN.js";const Pe={class:"card"},Ke={class:"table-header"},Le={class:"header-button-lf"},We={class:"header-button-ri"},Ge={key:0},He={key:0},Qe={key:4},Xe={key:0,class:"flexJstart"},Ye={class:"dialog-footer"},el=ze({__name:"ciConfigView",setup(Ze){const{proxy:k}=Re(),P=$e(),I=u([]),K=Fe(),L=u("verbose_name"),W=u(""),de=$(()=>({[L.value]:W.value})),q=u(null),pe=$(()=>{if(q.value===null)return!0;var l=RegExp(t.rule);return!!l.test(q.value)}),V=u([{name:"",value:""}]),D=$(()=>{let l={};return V.value.forEach(e=>{e.name!==""&&e.value!==""&&(l[e.name]=e.value)}),l}),ee=$(()=>k.$commonFunc.hasDuplicates(Object.keys(D.value))||k.$commonFunc.hasDuplicates(Object.values(D.value)));ue(()=>D.value,l=>{Object.keys(l).length!==0&&(t.rule=JSON.stringify(D.value))});const ce=l=>{V.value.splice(l+1,0,{name:"",value:""})},ve=l=>{V.value.splice(l,1),console.log(V.value)},le=u([{value:"name",label:"规则名",sort:!0,filter:!0,type:"string",required:!0},{value:"verbose_name",label:"规则名称",sort:!1,filter:!0,type:"string",required:!0},{value:"field_type",label:"字段类型",sort:!0,filter:!0,type:"object",required:!0},{value:"type",label:"规则类型",sort:!0,filter:!0,type:"object"},{value:"rule",label:"规则内容",sort:!1,filter:!0,type:"string"},{value:"description",label:"描述",sort:!1,filter:!1,type:"text"}]),fe=$(()=>{let l=[];return le.value.forEach(e=>{e.filter&&l.push({name:e.label,value:e.value})}),l}),T=u(""),t=Ne({name:null,verbose_name:null,field_type:"string",type:"regex",rule:null,description:null});ue(()=>t.field_type,l=>{t.type=Q.value[l][0].type},{deep:!0});const G=u(1),H=u(10),me=u("default"),ye=u(!1),ae=u(0),_e=()=>{_()},be=()=>{_()},U=u({ordering:"-update_time"}),ge=l=>{U.value={ordering:"-update_time"},l.order==="ascending"?U.value.ordering=l.prop:l.order==="descending"?U.value.ordering="-"+l.prop:U.value={ordering:"-update_time"},_()},v=u(!1),te=()=>{v.value=!1,O(T.value),h.value={}},C=u(!0),Ve=()=>{C.value=!0,ie(()=>{v.value=!0})},h=u({}),A=u({}),ke=l=>{h.value=l,v.value=!0,C.value=!1,ie(()=>{if(Object.keys(l).forEach(e=>{e!=="id"&&(t[e]=l[e])}),l.field_type==="enum"){let e=[];Object.keys(JSON.parse(l.rule)).forEach(d=>{e.push({name:d,value:JSON.parse(l.rule)[d]})}),V.value=e}A.value=JSON.parse(JSON.stringify(t)),console.log(A.value)})},O=l=>{l&&(l.resetFields(),V.value=[{name:"",value:""}])},oe=u([]),Q=u([]),_=async(l=null)=>{let e=await k.$api.getValidationRules({page:G.value,page_size:H.value,...de.value,...U.value,...l});I.value=e.data.results,ae.value=e.data.count},he=async()=>{let l=await k.$api.getCiModelFieldType();Q.value=l.data.field_validations;let e=l.data.field_types;Object.keys(e).forEach(d=>{oe.value.push({value:d,label:e[d]})})},B=u({}),we=async l=>{await l.validate(async(e,d)=>{if(e){if(console.log(ee.value),ee.value){y({type:"error",message:"有重复值！"});return}if(C.value){let f=await k.$api.addValidationRules({create_user:P.state.username,update_user:P.state.username,...t});f.status=="201"?(y({type:"success",message:"添加成功"}),v.value=!1,O(l),await _()):y({showClose:!0,message:"添加失败:"+JSON.stringify(f.data),type:"error"})}else{if(JSON.stringify(A.value)===JSON.stringify(t)){v.value=!1,O(l),y({showClose:!0,message:"无更新,关闭窗口",type:"info"});return}else{const S=Object.entries(A.value),m=Object.entries(t),b=S.concat(m).map(g=>JSON.stringify(g)),j=Array.from(new Set(b)).map(g=>JSON.parse(g));j.splice(0,S.length);const z=Object.fromEntries(j);let E={};if(Object.keys(z).forEach(g=>{z[g]!=""&&(E[g]=z[g])}),B.value=E,Object.keys(B.value).length===0){v.value=!1,O(l),y({showClose:!0,message:"无更新,关闭窗口",type:"info"});return}}console.log(B.value),console.log(t);let f=await k.$api.updateValidationRules({id:h.value.id,update_user:P.state.username,...B.value});console.log(f),f.status=="200"?(y({type:"success",message:"更新成功"}),v.value=!1,O(l),_()):y({showClose:!0,message:"更新失败:"+JSON.stringify(f.data),type:"error"})}}})},xe=l=>{Me.confirm("是否确认删除?","删除",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await k.$api.deleteValidationRules(l)).status==204?(y({type:"success",message:"删除成功"}),await _(),O(T.value),v.value=!1):y({type:"error",message:"删除失败"})}).catch(()=>{y({type:"info",message:"取消删除"})})};return Je(()=>{_(),he()}),(l,e)=>{var se;const d=i("el-button"),f=i("el-option"),S=i("el-select"),m=i("el-input"),b=i("el-table-column"),j=i("el-tooltip"),z=i("el-table"),E=i("el-pagination"),g=i("el-form-item"),Ce=i("el-text"),Oe=i("SuccessFilled"),ne=i("el-icon"),Se=i("WarningFilled"),Ue=i("el-form"),je=i("el-dialog"),X=qe("permission");return s(),c("div",Pe,[F("div",Ke,[F("div",Le,[Z((s(),p(d,{type:"primary",onClick:Ve},{default:r(()=>e[11]||(e[11]=[M("添加")])),_:1})),[[X,`${(se=x(K).name)==null?void 0:se.replace("_info","")}:add`]])]),F("div",We,[n(S,{modelValue:L.value,"onUpdate:modelValue":e[0]||(e[0]=a=>L.value=a),placeholder:"Select",style:{width:"120px"}},{default:r(()=>[(s(!0),c(N,null,J(fe.value,a=>(s(),p(f,{key:a.value,label:a.name,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),n(m,{modelValue:W.value,"onUpdate:modelValue":e[1]||(e[1]=a=>W.value=a),style:{width:"240px"},placeholder:"回车查询",clearable:"",onClear:e[2]||(e[2]=a=>_()),onKeyup:e[3]||(e[3]=De(a=>_(),["enter","native"]))},null,8,["modelValue"])])]),n(z,{ref:"multipleTableRef",data:I.value,style:{width:"100%"},border:"",onSortChange:ge},{default:r(()=>[n(b,{property:"name",label:"规则名",sortable:"custom"}),n(b,{property:"verbose_name",label:"规则名称"}),n(b,{property:"field_type",label:"字段类型",sortable:"custom"}),n(b,{property:"type",label:"规则类型",sortable:"custom"}),n(b,{property:"rule",label:"规则内容","show-overflow-tooltip":""}),n(b,{property:"description",label:"描述"}),n(b,{fixed:"right",width:"100",label:"操作"},{default:r(a=>[n(j,{class:"box-item",effect:"dark",content:"编辑",placement:"top"},{default:r(()=>{var w;return[Z(n(d,{link:"",type:"primary",icon:x(Te),onClick:o=>ke(a.row)},null,8,["icon","onClick"]),[[X,`${(w=x(K).name)==null?void 0:w.replace("_info","")}:edit`]])]}),_:2},1024),n(j,{class:"box-item",effect:"dark",content:"删除",placement:"top"},{default:r(()=>{var w;return[Z(n(d,{link:"",type:"danger",icon:x(Ae),disabled:a.row.built_in,onClick:o=>xe(a.row.id)},null,8,["icon","disabled","onClick"]),[[X,`${(w=x(K).name)==null?void 0:w.replace("_info","")}:delete`]])]}),_:2},1024)]),_:1})]),_:1},8,["data"]),n(E,{"current-page":G.value,"onUpdate:currentPage":e[4]||(e[4]=a=>G.value=a),"page-size":H.value,"onUpdate:pageSize":e[5]||(e[5]=a=>H.value=a),"page-sizes":[10,20,50,100,200],size:me.value,disabled:ye.value,layout:"total, sizes, prev, pager, next, jumper",total:ae.value,onSizeChange:_e,onCurrentChange:be,style:{"margin-top":"5px","justify-content":"flex-end"}},null,8,["current-page","page-size","size","disabled","total"]),n(je,{modelValue:v.value,"onUpdate:modelValue":e[10]||(e[10]=a=>v.value=a),title:"规则配置",width:"500","before-close":te},{footer:r(()=>[F("div",Ye,[n(d,{onClick:te},{default:r(()=>e[13]||(e[13]=[M("取消")])),_:1}),n(d,{type:"primary",onClick:e[9]||(e[9]=a=>we(T.value))},{default:r(()=>e[14]||(e[14]=[M(" 提交 ")])),_:1})])]),default:r(()=>[n(Ue,{inline:!0,"label-position":"right",model:t,"label-width":"auto",ref_key:"formRef",ref:T},{default:r(()=>[(s(!0),c(N,null,J(le.value,(a,w)=>(s(),p(g,{label:a.label,key:w,required:a.required,prop:a.value},{default:r(()=>[a.value==="rule"?(s(),c("div",Ge,[t.field_type==="enum"?(s(),c("div",He,[(s(!0),c(N,null,J(V.value,(o,Y)=>(s(),c("div",{key:Y},[F("li",null,[n(m,{modelValue:o.name,"onUpdate:modelValue":R=>o.name=R,style:{width:"90px","margin-right":"10px"}},null,8,["modelValue","onUpdate:modelValue"]),n(m,{modelValue:o.value,"onUpdate:modelValue":R=>o.value=R,style:{width:"160px","margin-right":"10px"}},null,8,["modelValue","onUpdate:modelValue"]),V.value.length!==1?(s(),p(d,{key:0,circle:"",type:"danger",size:"small",icon:x(Be),onClick:R=>ve(Y)},null,8,["icon","onClick"])):re("",!0),n(d,{circle:"",type:"primary",size:"small",icon:x(Ee),onClick:R=>ce(Y)},null,8,["icon","onClick"])])]))),128))])):(s(),p(m,{key:1,modelValue:t[a.value],"onUpdate:modelValue":o=>t[a.value]=o,type:"textarea",clearable:"",style:{width:"300px"},disabled:h.value.built_in},null,8,["modelValue","onUpdate:modelValue","disabled"]))])):a.value==="description"?(s(),p(m,{key:1,modelValue:t[a.value],"onUpdate:modelValue":o=>t[a.value]=o,type:"textarea",clearable:"",style:{width:"300px"}},null,8,["modelValue","onUpdate:modelValue"])):a.value==="name"?(s(),p(m,{key:2,modelValue:t[a.value],"onUpdate:modelValue":o=>t[a.value]=o,clearable:"",disabled:!!(h.value.built_in||!C.value)},null,8,["modelValue","onUpdate:modelValue","disabled"])):a.value==="verbose_name"?(s(),p(m,{key:3,modelValue:t[a.value],"onUpdate:modelValue":o=>t[a.value]=o,clearable:""},null,8,["modelValue","onUpdate:modelValue"])):(s(),c("div",Qe,[a.value==="field_type"?(s(),p(S,{key:0,modelValue:t.field_type,"onUpdate:modelValue":e[6]||(e[6]=o=>t.field_type=o),placeholder:"Select",style:{width:"120px"},disabled:!!(h.value.built_in||!C.value)},{default:r(()=>[(s(!0),c(N,null,J(oe.value,o=>(s(),p(f,{key:o.value,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])):(s(),p(S,{key:1,modelValue:t.type,"onUpdate:modelValue":e[7]||(e[7]=o=>t.type=o),placeholder:"Select",style:{width:"120px"},disabled:!!(h.value.built_in||!C.value)},{default:r(()=>[(s(!0),c(N,null,J(Q.value[t.field_type],o=>(s(),p(f,{key:o.type,label:o.description,value:o.type},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]))]))]),_:2},1032,["label","required","prop"]))),128)),t.type==="regex"?(s(),c("div",Xe,[n(Ce,null,{default:r(()=>e[12]||(e[12]=[M("测试正则")])),_:1}),n(m,{modelValue:q.value,"onUpdate:modelValue":e[8]||(e[8]=a=>q.value=a),clearable:"",style:{width:"200px",margin:"0 10px"}},null,8,["modelValue"]),pe.value?(s(),p(ne,{key:0,style:{color:"var(--el-color-success)"},size:20},{default:r(()=>[n(Oe)]),_:1})):(s(),p(ne,{key:1,style:{color:"var(--el-color-danger)"},size:20},{default:r(()=>[n(Se)]),_:1}))])):re("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}});export{el as default};
