import{d as Oe,g as he,y as Le,x as Je,bB as sl,r,v as Z,a as ve,h as n,bc as je,c as T,o as p,F as G,b as q,f as e,w as l,i as le,B as L,m as z,aQ as nl,q as y,t as W,bV as N,k as Ue,bX as Qe,cc as Xe,cd as Ge,bM as de,b_ as _,c4 as be,aP as xe,_ as Ke,E as We,cf as il,j as dl,z as ul,A as rl,aU as ml,C as pl}from"./index-BSX4TNZE.js";import{i as cl}from"./iconSelectCom-KzLoVSPK.js";import{u as fl}from"./tabs-BTQMxKQU.js";import{l as Ye}from"./vue-draggable-plus-CxDq7V_C.js";import{u as _l}from"./ci-BxSXcdsR.js";import{m as vl}from"./model-Ds6Q2RXn.js";import"./keepAlive-C2W7CCRc.js";const bl={class:"operation_show"},gl={class:"dialog-footer"},yl={class:"demo-drawer__content"},wl={style:{float:"left"}},Cl={style:{float:"right",color:"var(--el-text-color-secondary)","font-size":"13px"}},Vl={class:"demo-drawer__footer"},xl=Oe({__name:"ciModelField",props:{ciModelInfo:{},ciModelInfoModifiers:{}},emits:["update:ciModelInfo"],setup(me,{expose:P}){const{proxy:M}=he(),O=Le(),h=Je(),x=sl(me,"ciModelInfo"),B=r([]),ee=r([]),k=r([]),X=Z(()=>{let o=[];return B.value.forEach(t=>{t.fields.forEach(c=>{c.type==="model_ref"&&o.push(c.ref_model)})}),o}),j=Z(()=>{var t;let o=[];return(t=k.value)==null||t.forEach(c=>{c.id!==x.value.id&&(X.value.indexOf(c.id)===-1?o.push({value:c.id,label:c.verbose_name,disabled:!1}):o.push({value:c.id,label:c.verbose_name,disabled:!0}))}),o}),E=()=>{i.default="",i.validation_rule="",i.type=="boolean"?i.default=!0:i.type=="enum"?w.value=!0:i.type=="string"&&(w.value=!1)},H=r([]),K=o=>{let t=JSON.parse(C.value[o].rule),c=[];Object.keys(t).forEach(g=>{c.push({value:g,label:t[g]})}),H.value=c},D=o=>{let t=JSON.parse(C.value[o].rule),c=[];Object.keys(t).forEach(g=>{c.push({value:g,label:t[g]})}),H.value=c,i.default!=H.value[0].value&&(i.default=H.value[0].value)},w=r(!1),f=Z(()=>i.type==="fromModel"),I=r([]),oe=async(o=null)=>{let t=await M.$api.getValidationRules({page:1,page_size:1e4,...o});I.value=t.data.results,t.data.results.forEach(c=>{C.value[c.id]=c})},C=r({}),v=Z(()=>{let o=[];return I.value.forEach(t=>{t.field_type==i.type&&o.push({value:t.id,label:t.verbose_name})}),o}),V=async o=>{var t,c;if(o!=null)x.value=o.model,B.value=o.field_groups,ee.value=(t=o.field_groups)==null?void 0:t.map(g=>g.name);else{let g=await M.$api.getCiModel({},x.value.id);x.value=g.data.model,B.value=g.data.field_groups,ee.value=(c=g.data.field_groups)==null?void 0:c.map(Ce=>Ce.name)}},m=r([]),d=r([]),A=async()=>{let o=await M.$api.getCiModelFieldType(),t=o.data.field_types;Object.keys(t).forEach(c=>{m.value.push({value:c,label:t[c]})}),d.value=o.data.limit_fields},b=async()=>{let o=await M.$api.getCiModel();k.value=o.data.results},U=ve({name:"",verbose_name:""}),pe=(o,t,c)=>{console.log(t),d.value.includes(t)?c(new Error(`${d.value.join(",")}不能用!`)):c()},ae=ve({name:[{required:!0,message:"请输入唯一标识",trigger:"blur"},{pattern:/^[a-z][\w\d]{4,20}$/,trigger:"blur",message:"以英文字符开头,可以使用英文,数字,下划线,长度4-20 "}],verbose_name:[{required:!0,message:"请输入组名称",trigger:"blur"}]}),R=r(),S=r(!1),ge=o=>{S.value=!1,ne(o)},ie=r(!1),ce=r(""),fe=async o=>{o&&await o.validate(async(t,c)=>{if(t)if(ie.value){console.log(U);let g=await M.$api.addCiModelFieldGroup({model:x.value.id,create_user:O.state.username,update_user:O.state.username,...U});console.log(g),g.status=="201"?(_({type:"success",message:"添加成功"}),S.value=!1,ne(o),V()):_({showClose:!0,message:"添加失败:"+JSON.stringify(g.data),type:"error"})}else{let g=await M.$api.updateCiModelFieldGroup({id:ce.value,update_user:O.state.username,...U});console.log(g),g.status=="200"?(_({type:"success",message:"更新成功"}),S.value=!1,ne(o),V()):_({showClose:!0,message:"更新失败:"+JSON.stringify(g.data),type:"error"})}else console.log("error submit!",c)})},ye=o=>{be.confirm("是否确认关闭?").then(()=>{o(),ne(R.value)}).catch(()=>{})},a=r("新增"),u=o=>{a.value="新增",xe(()=>{}),S.value=!0,ie.value=!0},ue=o=>{a.value="修改",S.value=!0,xe(()=>{ie.value=!1,U.name=o.name,U.verbose_name=o.verbose_name,ce.value=o.id})},te=o=>{be.confirm("是否确认删除?","删除组",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{let t=await M.$api.deleteCiModelFieldGroup(o);t.status==204||t.status==200?(_({type:"success",message:"删除成功"}),await V()):_({type:"error",message:"删除失败"})}).catch(()=>{_({type:"info",message:"取消删除"})})},Q=r(!1),i=ve({name:"",verbose_name:"",type:"string",required:!1,editable:!0,validation_rule:"",ref_model:"",description:"",default:"",unit:""}),Se=ve({name:[{required:!0,message:"请输入唯一标识",trigger:"blur"},{pattern:/^[a-z][\w\d]{1,20}$/,trigger:"blur",message:"以英文字符开头,可以使用英文,数字,下划线,长度2-20 ",required:!0},{validator:pe,trigger:"blur"}],verbose_name:[{required:!0,message:"请输入字段显示名称",trigger:"blur"}],type:[{required:!0,message:"字段类型",trigger:"blur"}],model_name:[{required:f,message:"请选择模型",trigger:"blur"}],validation_rule:[{required:w,message:"选择校验规则",trigger:""}]}),we=r();r(!1);const re=r(!1),se=r({}),_e=r(!0),qe=o=>{Q.value=!0,a.value="修改",re.value=!0,se.value=o,_e.value=!1,xe(()=>{Object.keys(o).forEach(t=>{i.hasOwnProperty(t)&&(i[t]=o[t])}),i.validation_rule===null?w.value=!1:w.value=!0})},ke=o=>{ne(o),console.log(i),Q.value=!1},Re=o=>{a.value="新增",se.value={},Q.value=!0,_e.value=!0,re.value=!1,w.value=!1,xe(()=>{ce.value=o.id})},ze=async o=>{o&&await o.validate(async(t,c)=>{if(t)if(_e.value){let g=await M.$api.addCiModelField({model:x.value.id,model_field_group:ce.value,create_user:O.state.username,update_user:O.state.username,...i});console.log(g),g.status=="201"?(_({type:"success",message:"添加成功"}),Q.value=!1,ne(o),V()):_({showClose:!0,message:"添加失败:"+JSON.stringify(g.data),type:"error"})}else{w.value||(i.validation_rule="");let g=await M.$api.updateCiModelField({id:se.value.id,update_user:O.state.username,...i});console.log(g),g.status=="200"?(_({type:"success",message:"更新成功"}),Q.value=!1,ne(o),V()):_({showClose:!0,message:"更新失败:"+JSON.stringify(g.data),type:"error"})}else console.log("error submit!",c)})},Be=o=>{be.confirm("是否确认关闭?").then(()=>{o(),ne(we.value),Q.value=!1}).catch(()=>{})},Ee=o=>{be.confirm("是否确认删除?","删除组",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await M.$api.deleteCiModelField(se.value.id)).status==204?(_({type:"success",message:"删除成功"}),await V(),ne(we.value),Q.value=!1):_({type:"error",message:"删除失败"})}).catch(()=>{_({type:"info",message:"取消删除"})})},ne=o=>{o&&o.resetFields()},Te=async(o,t)=>{if(o.oldIndex==o.newIndex)return;if(o.pullMode){console.log("跨组移动，在onAdd中触发");return}let c=await M.$api.updateCiModelField({id:o.data.id,order:o.newIndex+1});c.status=="200"?_({type:"success",message:"更新排序成功"}):_({showClose:!0,message:"更新排序失败:"+JSON.stringify(c.data),type:"error"}),V()},F=async(o,t)=>{let c=await M.$api.updateCiModelField({id:o.data.id,order:o.newIndex+1,model_field_group:t.id});c.status=="200"?_({type:"success",message:"更新排序成功"}):_({showClose:!0,message:"更新排序失败:"+JSON.stringify(c.data),type:"error"}),V()};return P({getModelField:V,getCiModelList:b,getRules:oe,getModelFieldType:A}),(o,t)=>{const c=n("el-text"),g=n("el-button"),Ce=n("el-tooltip"),el=n("el-space"),Ae=n("el-col"),Ze=n("el-row"),Pe=n("el-card"),ll=n("el-collapse-item"),tl=n("el-collapse"),$e=n("el-input"),Y=n("el-form-item"),He=n("el-form"),ol=n("el-dialog"),Ne=n("el-switch"),Fe=n("el-option"),Me=n("el-select"),al=n("el-drawer"),Ve=je("permission");return p(),T(G,null,[q("div",null,[e(tl,{modelValue:ee.value,"onUpdate:modelValue":t[0]||(t[0]=$=>ee.value=$)},{default:l(()=>[(p(!0),T(G,null,le(B.value,($,Ie)=>(p(),L(ll,{name:$.name,key:Ie},{title:l(()=>[e(c,{tag:"b",size:"large"},{default:l(()=>[y(W($.verbose_name),1)]),_:2},1024),q("div",bl,[$.built_in?Ue("",!0):(p(),L(el,{key:0},{default:l(()=>{var s;return[N((p(),L(Ce,{class:"box-item",effect:"dark",content:"编辑",placement:"top"},{default:l(()=>{var J;return[N(e(g,{size:"small",onClick:Qe(De=>ue($),["stop"]),icon:z(Xe),circle:""},null,8,["onClick","icon"]),[[Ve,`${(J=z(h).name)==null?void 0:J.replace("_info","")}:edit`]])]}),_:2},1024)),[[Ve,`${(s=z(h).name)==null?void 0:s.replace("_info","")}:edit`]]),e(Ce,{class:"box-item",effect:"dark",content:"删除",placement:"top"},{default:l(()=>{var J;return[N(e(g,{size:"small",onClick:Qe(De=>te($.id),["stop"]),icon:z(Ge),circle:""},null,8,["onClick","icon"]),[[Ve,`${(J=z(h).name)==null?void 0:J.replace("_info","")}:delete`]])]}),_:2},1024)]}),_:2},1024))])]),default:l(()=>[q("div",null,[e(z(Ye),{"force-fallback":!0,"scroll-sensitivity":200,ref_for:!0,ref:"el",group:"modelField",modelValue:$.fields,"onUpdate:modelValue":s=>$.fields=s,onEnd:s=>Te(s,$),onAdd:s=>F(s,$),style:{width:"100%","flex-wrap":"wrap",display:"flex",gap:"10px","justify-items":"flex-start"}},{default:l(()=>{var s;return[(p(!0),T(G,null,le($.fields,(J,De)=>(p(),T("div",{key:De},[e(Ce,{effect:"light",content:"点击编辑字段",placement:"top"},{default:l(()=>[e(Pe,{shadow:"hover",class:nl(["modelFieldCard",J.built_in?"isBuiltClass":""]),onClick:Dl=>qe(J)},{default:l(()=>[e(c,{tag:"b"},{default:l(()=>[y(W(J.verbose_name),1)]),_:2},1024),e(Ze,{justify:"space-between"},{default:l(()=>[e(Ce,{class:"box-item",effect:"light",content:J.name,placement:"bottom"},{default:l(()=>[e(Ae,{span:13,class:"describe-class"},{default:l(()=>[e(c,null,{default:l(()=>[y(W(J.name),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["content"]),e(Ce,{class:"box-item",effect:"light",content:J.type,placement:"bottom"},{default:l(()=>[e(Ae,{span:10,class:"describe-class"},{default:l(()=>[e(c,null,{default:l(()=>[y(W(J.type),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["content"])]),_:2},1024)]),_:2},1032,["class","onClick"])]),_:2},1024)]))),128)),q("div",null,[N((p(),L(Pe,{class:"modelFieldCard",style:{"align-items":"center","justify-content":"center"},onClick:J=>Re($)},{default:l(()=>[e(c,{type:"primary"},{default:l(()=>[...t[26]||(t[26]=[y("+ 添加字段",-1)])]),_:1})]),_:1},8,["onClick"])),[[Ve,`${(s=z(h).name)==null?void 0:s.replace("_info","")}:add`]])])]}),_:2},1032,["modelValue","onUpdate:modelValue","onEnd","onAdd"])])]),_:2},1032,["name"]))),128))]),_:1},8,["modelValue"]),e(Ze,{style:{"margin-top":"10px"}},{default:l(()=>[e(Ae,null,{default:l(()=>{var $;return[N((p(),L(g,{bg:"",text:"",onClick:t[1]||(t[1]=Ie=>u(x.value))},{default:l(()=>[...t[27]||(t[27]=[y("添加分组",-1)])]),_:1})),[[Ve,`${($=z(h).name)==null?void 0:$.replace("_info","")}:add`]])]}),_:1})]),_:1})]),e(ol,{modelValue:S.value,"onUpdate:modelValue":t[6]||(t[6]=$=>S.value=$),title:a.value+"字段分组",width:"500","before-close":ye},{footer:l(()=>[q("div",gl,[e(g,{onClick:t[4]||(t[4]=$=>ge(R.value))},{default:l(()=>[...t[28]||(t[28]=[y("取消",-1)])]),_:1}),e(g,{type:"primary",onClick:t[5]||(t[5]=$=>fe(R.value))},{default:l(()=>[...t[29]||(t[29]=[y(" 确认 ",-1)])]),_:1})])]),default:l(()=>[e(He,{ref_key:"groupFormRef",ref:R,style:{"max-width":"600px"},model:U,rules:ae,"label-width":"auto",class:"demo-modelForm","status-icon":""},{default:l(()=>[e(Y,{label:"字段组标识",prop:"name"},{default:l(()=>[e($e,{modelValue:U.name,"onUpdate:modelValue":t[2]||(t[2]=$=>U.name=$),disabled:!ie.value},null,8,["modelValue","disabled"])]),_:1}),e(Y,{label:"字段分组名称",prop:"verbose_name"},{default:l(()=>[e($e,{modelValue:U.verbose_name,"onUpdate:modelValue":t[3]||(t[3]=$=>U.verbose_name=$)},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"]),e(al,{modelValue:Q.value,"onUpdate:modelValue":t[25]||(t[25]=$=>Q.value=$),title:"模型字段","before-close":Be,direction:"rtl",class:"demo-drawer"},{default:l(()=>{var $,Ie;return[q("div",yl,[e(He,{model:i,ref_key:"modelFieldFormRef",ref:we,"label-width":"auto","label-position":"right",rules:Se},{default:l(()=>[e(Y,{label:"唯一标识",prop:"name"},{default:l(()=>[e($e,{modelValue:i.name,"onUpdate:modelValue":t[7]||(t[7]=s=>i.name=s),autocomplete:"off",disabled:!!(se.value.built_in||re.value)},null,8,["modelValue","disabled"])]),_:1}),e(Y,{label:"显示名称",prop:"verbose_name"},{default:l(()=>[e($e,{modelValue:i.verbose_name,"onUpdate:modelValue":t[8]||(t[8]=s=>i.verbose_name=s),autocomplete:"off"},null,8,["modelValue"])]),_:1}),e(Y,{label:"可编辑",prop:"editable"},{default:l(()=>[e(Ne,{modelValue:i.editable,"onUpdate:modelValue":t[9]||(t[9]=s=>i.editable=s),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},disabled:se.value.built_in},null,8,["modelValue","disabled"])]),_:1}),e(Y,{label:"必填",prop:"required"},{default:l(()=>[e(Ne,{modelValue:i.required,"onUpdate:modelValue":t[10]||(t[10]=s=>i.required=s),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"}},null,8,["modelValue"])]),_:1}),e(Y,{label:"字段类型",prop:"type"},{default:l(()=>[e(Me,{modelValue:i.type,"onUpdate:modelValue":t[11]||(t[11]=s=>i.type=s),placeholder:"Select",style:{width:"240px"},onChange:E,disabled:!!(se.value.built_in||re.value)},{default:l(()=>[(p(!0),T(G,null,le(m.value,s=>(p(),L(Fe,{key:s.value,label:s.label,value:s.value},{default:l(()=>[q("span",wl,W(s.label),1),q("span",Cl,W(s.value),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),N(e(Y,{label:"校验规则",prop:"validation_rule"},{default:l(()=>[e(Ne,{modelValue:w.value,"onUpdate:modelValue":t[12]||(t[12]=s=>w.value=s),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949","margin-right":"10px"}},null,8,["modelValue"]),N(e(Me,{modelValue:i.validation_rule,"onUpdate:modelValue":t[13]||(t[13]=s=>i.validation_rule=s),placeholder:"选择校验规则",style:{width:"240px"}},{default:l(()=>[(p(!0),T(G,null,le(v.value,s=>(p(),L(Fe,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),[[de,w.value]])]),_:1},512),[[de,i.type==="string"]]),N(e(Y,{label:"枚举值",prop:"validation_rule"},{default:l(()=>[e(Me,{modelValue:i.validation_rule,"onUpdate:modelValue":t[14]||(t[14]=s=>i.validation_rule=s),placeholder:"选择校验规则",style:{width:"240px"},onChange:t[15]||(t[15]=s=>D(i.validation_rule))},{default:l(()=>[(p(!0),T(G,null,le(v.value,s=>(p(),L(Fe,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},512),[[de,i.type==="enum"]]),N(e(Y,{label:"默认值",prop:"default"},{default:l(()=>[e(Me,{modelValue:i.default,"onUpdate:modelValue":t[16]||(t[16]=s=>i.default=s),placeholder:"选择默认值",size:"large",onVisibleChange:t[17]||(t[17]=s=>K(i.validation_rule))},{default:l(()=>[(p(!0),T(G,null,le(H.value,(s,J)=>(p(),L(Fe,{key:J,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},512),[[de,i.type==="enum"]]),N(e(Y,{label:"模型引用",prop:"ref_model"},{default:l(()=>[e(Me,{modelValue:i.ref_model,"onUpdate:modelValue":t[18]||(t[18]=s=>i.ref_model=s),placeholder:"选择CI模型",disabled:!!(se.value.built_in||re.value)},{default:l(()=>[(p(!0),T(G,null,le(j.value,s=>(p(),L(Fe,{key:s.value,label:s.label,disabled:s.disabled,value:s.value},null,8,["label","disabled","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1},512),[[de,i.type==="model_ref"]]),N(e(Y,{label:"默认值",prop:"default"},{default:l(()=>[e(Ne,{modelValue:i.default,"onUpdate:modelValue":t[19]||(t[19]=s=>i.default=s),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"}},null,8,["modelValue"])]),_:1},512),[[de,i.type==="boolean"]]),N(e(Y,{label:"单位",prop:"unit"},{default:l(()=>[e($e,{modelValue:i.unit,"onUpdate:modelValue":t[20]||(t[20]=s=>i.unit=s),style:{width:"120px"}},null,8,["modelValue"])]),_:1},512),[[de,i.type==="integer"||i.type==="float"]]),e(Y,{label:"描述",prop:"description"},{default:l(()=>[e($e,{modelValue:i.description,"onUpdate:modelValue":t[21]||(t[21]=s=>i.description=s),type:"textarea"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),q("div",Vl,[e(g,{onClick:t[22]||(t[22]=s=>ke(we.value))},{default:l(()=>[...t[30]||(t[30]=[y("取消",-1)])]),_:1}),re.value&&!se.value.built_in?N((p(),L(g,{key:0,type:"danger",onClick:t[23]||(t[23]=s=>Ee())},{default:l(()=>[...t[31]||(t[31]=[y("删除",-1)])]),_:1})),[[Ve,`${($=z(h).name)==null?void 0:$.replace("_info","")}:delete`]]):Ue("",!0),N((p(),L(g,{type:"primary",onClick:t[24]||(t[24]=s=>ze(we.value))},{default:l(()=>[...t[32]||(t[32]=[y(" 确定 ",-1)])]),_:1})),[[Ve,`${(Ie=z(h).name)==null?void 0:Ie.replace("_info","")}:edit`]])])])]}),_:1},8,["modelValue"])],64)}}}),kl=Ke(xl,[["__scopeId","data-v-c6e5779e"]]),$l={style:{width:"100%"}},Fl={class:"table-header"},Ml={class:"header-button-lf"},Il={class:"dialog-footer"},Ul=Oe({__name:"ciModelUnique",props:["modelId","modelFieldLists"],setup(me,{expose:P}){const M=Je(),{proxy:O}=he(),h=Le(),x=r([]),B=me,ee=()=>{E.value=!0,K.value=!0};Z(()=>{let m={};return B.modelFieldLists.forEach(d=>{m[d.name]=d.verbose_name}),m});const k=Z(()=>{let m={};return B.modelFieldLists.forEach(d=>{m[d.id]=d.verbose_name}),m}),X=r(""),j=ve({fields:[],validate_null:!1,description:null}),E=r(!1),H=()=>{E.value=!1,f(X.value)},K=r(!0),D=r({}),w=m=>{D.value=m,E.value=!0,K.value=!1,xe(()=>{Object.keys(m).forEach(d=>{d!=="id"&&Object.keys(j).indexOf(d)!==-1&&(j[d]=m[d])})})},f=m=>{m&&(m.resetFields(),D.value={})},I=async m=>{await m.validate(async(d,A)=>{if(d)if(K.value){let b=await O.$api.addCiModelUnique({create_user:h.state.username,update_user:h.state.username,...j,model:B.modelId});b.status=="201"?(_({type:"success",message:"添加成功"}),E.value=!1,f(m),V({model:B.modelId})):_({showClose:!0,message:"添加失败:"+JSON.stringify(b.data),type:"error"})}else{let b=await O.$api.updateCiModelUnique({id:D.value.id,update_user:h.state.username,...j});b.status=="200"?(_({type:"success",message:"更新成功"}),E.value=!1,f(m),V({model:B.modelId})):_({showClose:!0,message:"更新失败:"+JSON.stringify(b.data),type:"error"})}})},oe=async m=>{let d=await O.$api.updateCiModelUnique({update_user:h.state.username,...m});d.status=="200"?(_({type:"success",message:"更新成功"}),f(X.value),V({model:B.modelId})):_({showClose:!0,message:"更新失败:"+JSON.stringify(d.data),type:"error"})},C=m=>{be.confirm("是否确认删除?","删除",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await O.$api.deleteCiModelUnique(m)).status==204?(_({type:"success",message:"删除成功"}),V({model:B.modelId}),f(X.value),E.value=!1):_({type:"error",message:"删除失败"})}).catch(()=>{_({type:"info",message:"取消删除"})})},v=Z(()=>{let m={};return x.value.forEach(d=>{var b;let A=d.fields.map(U=>k.value[U]);m[(b=d.fields)==null?void 0:b.join("+")]=A.join("+")}),m}),V=async m=>{let d=await O.$api.getCiModelUnique(m);x.value=d.data.results};return P({getTableData:V}),(m,d)=>{const A=n("el-button"),b=n("el-table-column"),U=n("el-switch"),pe=n("el-tooltip"),ae=n("el-table"),R=n("el-option"),S=n("el-select"),ge=n("el-form-item"),ie=n("el-input"),ce=n("el-form"),fe=n("el-dialog"),ye=je("permission");return p(),T("div",$l,[q("div",Fl,[q("div",Ml,[e(A,{type:"primary",onClick:ee},{default:l(()=>[...d[5]||(d[5]=[y("添加",-1)])]),_:1})])]),e(ae,{ref:"multipleTableRef",data:x.value,style:{width:"100%"},border:""},{default:l(()=>[e(b,{prop:"fields",label:"校验规则"},{default:l(a=>[q("span",null,W(v.value[a.row.fields.join("+")]),1)]),_:1}),e(b,{prop:"validate_null",label:"空值校验"},{default:l(a=>{var u;return[N(e(U,{modelValue:a.row.validate_null,"onUpdate:modelValue":ue=>a.row.validate_null=ue,class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},onChange:ue=>oe({id:a.row.id,validate_null:a.row.validate_null}),disabled:a.row.built_in},null,8,["modelValue","onUpdate:modelValue","onChange","disabled"]),[[ye,{id:`${(u=z(M).name)==null?void 0:u.replace("_info","")}:edit`,action:"disabled"}]])]}),_:1}),e(b,{prop:"description",label:"描述"}),e(b,{fixed:"right",width:"100",label:"操作"},{default:l(a=>[e(pe,{class:"box-item",effect:"dark",content:"编辑",placement:"top"},{default:l(()=>{var u;return[N(e(A,{link:"",type:"primary",icon:z(Xe),onClick:ue=>w(a.row)},null,8,["icon","onClick"]),[[ye,`${(u=z(M).name)==null?void 0:u.replace("_info","")}:edit`]])]}),_:2},1024),e(pe,{class:"box-item",effect:"dark",content:"删除",placement:"top"},{default:l(()=>{var u;return[N(e(A,{link:"",type:"danger",icon:z(Ge),disabled:a.row.built_in,onClick:ue=>C(a.row.id)},null,8,["icon","disabled","onClick"]),[[ye,`${(u=z(M).name)==null?void 0:u.replace("_info","")}:delete`]])]}),_:2},1024)]),_:1})]),_:1},8,["data"]),e(fe,{modelValue:E.value,"onUpdate:modelValue":d[4]||(d[4]=a=>E.value=a),title:"唯一校验配置",width:"500","before-close":H},{footer:l(()=>[q("div",Il,[e(A,{onClick:H},{default:l(()=>[...d[6]||(d[6]=[y("取消",-1)])]),_:1}),e(A,{type:"primary",onClick:d[3]||(d[3]=a=>I(X.value))},{default:l(()=>[...d[7]||(d[7]=[y(" 提交 ",-1)])]),_:1})])]),default:l(()=>[e(ce,{inline:!0,"label-position":"right",model:j,"label-width":"auto",ref_key:"formRef",ref:X},{default:l(()=>[e(ge,{label:"唯一校验组合",prop:"fields"},{default:l(()=>[e(S,{modelValue:j.fields,"onUpdate:modelValue":d[0]||(d[0]=a=>j.fields=a),fields:"选择字段组合",multiple:"","multiple-limit":5,clearable:"",filterable:"",style:{width:"240px"},disabled:!!D.value.built_in},{default:l(()=>[(p(!0),T(G,null,le(B.modelFieldLists,(a,u)=>(p(),L(R,{label:a.verbose_name,value:a.id,key:u},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),e(ge,{label:"空置校验",prop:"validate_null"},{default:l(()=>[e(U,{modelValue:j.validate_null,"onUpdate:modelValue":d[1]||(d[1]=a=>j.validate_null=a),class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},disabled:D.value.built_in},null,8,["modelValue","disabled"])]),_:1}),e(ge,{label:"描述",prop:"description"},{default:l(()=>[e(ie,{modelValue:j.description,"onUpdate:modelValue":d[2]||(d[2]=a=>j.description=a),style:{width:"240px"},autosize:{minRows:2,maxRows:4},type:"textarea",disabled:!!D.value.built_in},null,8,["modelValue","disabled"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Ol={class:"card"},hl={class:"listItem"},Sl={style:{display:"flex","flex-direction":"row","justify-content":"center","align-items":"center"}},Rl=Oe({__name:"ciModelTemplateName",props:["modelId","modelFieldLists","ciModelInfo"],setup(me,{expose:P}){const{proxy:M}=he();Le();const O=me,h=r(!1),x=r([]),B=w=>{},ee=Z(()=>O.modelFieldLists.filter(w=>["string","enum","model_ref"].includes(w.type))),k=Z(()=>{let w=new Object;return O.modelFieldLists.forEach(f=>{w[f.id]=f}),w}),X=()=>{},j=()=>{h.value=!0},E=()=>{h.value=!1},H=async()=>{let w=await M.$api.updateInstanceName(O.modelId);console.log(w),w.status=="200"?We({title:"Success",message:"更新任务提交成功",type:"success"}):We({title:"Error",message:`更新任务提交失败${JSON.stringify(w.data)}`,type:"error"})};r(0);const K=async()=>{let w=await M.$api.updateCiModel({id:O.modelId,instance_name_template:x.value});w.status=="200"?(_({type:"success",message:"更新成功"}),be.confirm("更新成功，是否自动更新实例唯一标识?","Warning",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{H()}).catch(()=>{_({type:"info",message:"Delete canceled"})}),h.value=!1,D()):_({showClose:!0,message:"更新失败:"+JSON.stringify(w.data),type:"error"})},D=async()=>{let w=await M.$api.getCiModel(null,O.modelId);x.value=w.data.model.instance_name_template};return P({getModel:D}),(w,f)=>{const I=n("el-button"),oe=n("el-divider"),C=n("el-checkbox"),v=n("el-checkbox-group"),V=je("throttle");return p(),T(G,null,[f[9]||(f[9]=q("div",null,null,-1)),q("div",Ol,[N(e(I,{type:"primary",onClick:j},{default:l(()=>[...f[2]||(f[2]=[y("编辑",-1)])]),_:1},512),[[de,!h.value]]),N((p(),L(I,{type:"primary",onClick:H},{default:l(()=>[...f[3]||(f[3]=[y("更新唯一标识",-1)])]),_:1})),[[V]]),N(e(I,{onClick:E},{default:l(()=>[...f[4]||(f[4]=[y("取消",-1)])]),_:1},512),[[de,h.value]]),N(e(I,{type:"primary",onClick:K},{default:l(()=>[...f[5]||(f[5]=[y("保存",-1)])]),_:1},512),[[de,h.value]]),e(oe,null,{default:l(()=>[...f[6]||(f[6]=[y("可选择指标",-1)])]),_:1}),e(v,{modelValue:x.value,"onUpdate:modelValue":f[0]||(f[0]=m=>x.value=m),onChange:B,max:5,disabled:!h.value},{default:l(()=>[(p(!0),T(G,null,le(ee.value,(m,d)=>(p(),L(C,{key:d,label:m.verbose_name,value:m.id},{default:l(()=>[y(W(m.verbose_name),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),e(oe,null,{default:l(()=>[...f[7]||(f[7]=[y("拖拽调整顺序",-1)])]),_:1}),e(z(Ye),{disabled:!h.value,modelValue:x.value,"onUpdate:modelValue":f[1]||(f[1]=m=>x.value=m),"force-fallback":!0,"scroll-sensitivity":200,ref:"el",onEnd:X,style:{width:"100%",overflow:"auto"}},{default:l(()=>[(p(!0),T(G,null,le(x.value,(m,d)=>(p(),T("div",{key:d},[q("div",hl,[q("span",null,W(k.value[m].verbose_name),1)])]))),128))]),_:1},8,["disabled","modelValue"]),e(oe,null,{default:l(()=>[...f[8]||(f[8]=[y("效果预览",-1)])]),_:1}),q("div",Sl,[q("h3",null,W(x.value.map(m=>k.value[m].verbose_name).join(" - ")),1)])])],64)}}}),Tl={class:"card"},Nl={key:1},Ll={key:1},jl={key:0,class:"flexCenter",style:{width:"50%","margin-top":"10px"}},ql={key:1,class:"flexCenter",style:{width:"50%","margin-top":"10px"}},zl=Oe({__name:"ciModelConfig",props:["modelId","modelFieldLists","ciModelInfo"],setup(me,{expose:P}){const{proxy:M}=he(),O=me,h=r({}),x=r(!1),B=()=>{x.value=!0};Z(()=>k.zabbix_sync_info.some(C=>C.isEditing));const ee=Z(()=>O.modelFieldLists.some(C=>C.name==="ip"));r(!1);const k=ve({zabbix_sync_info:[],is_manage:!1,built_in:!1}),X=r([{value:"agent",label:"agent"},{value:"ipmi",label:"ipmi"},{value:"snmp",label:"snmp"}]),j=r([]),E=C=>{const v=k.zabbix_sync_info.map(V=>V.type).filter(V=>V);return X.value.map(V=>({...V,disabled:v.includes(V.value)}))},H=()=>{if(E().filter(v=>!v.disabled).length===0){_({type:"warning",message:"所有接口类型都已配置，无法添加更多配置"});return}k.zabbix_sync_info.push({type:"",template:""})},K=C=>{k.zabbix_sync_info.splice(C,1)},D=()=>{x.value=!1,xe(()=>{f()})},w=r(null),f=async()=>{const C=await M.$api.getModelConfig({model:O.modelId});if(C.status==200&&(h.value=C.data.results,C.data.results&&C.data.results.length>0)){const v=C.data.results[0];w.value=v.id,k.is_manage=v.is_manage,k.built_in=v.built_in,k.zabbix_sync_info=v.zabbix_sync_info.map(V=>({...V}))}},I=async()=>{let C=await M.$api.getZabbixTemplate();console.log(C),C.status==200?j.value=C.data.data:_({type:"error",message:`添加失败: ${JSON.stringify(C.data)}`})},oe=async()=>{if(!ee.value){_({type:"error",message:"模型不存在名称为IP的模型字段，请先配置IP字段"});return}const C={...k,zabbix_sync_info:k.zabbix_sync_info.filter(V=>V.type)};let v=await M.$api.updateModelConfig({id:w.value,...C});v.status==200?(_({type:"success",message:"保存成功"}),x.value=!1,f()):_({type:"error",message:`保存失败: ${JSON.stringify(v.data)}`})};return P({getConfigData:f,getZabbixTemplates:I}),(C,v)=>{const V=n("el-switch"),m=n("el-form-item"),d=n("el-option"),A=n("el-select"),b=n("el-table-column"),U=n("el-button"),pe=n("el-table"),ae=n("el-form");return p(),T("div",Tl,[e(ae,{model:k},{default:l(()=>[e(m,{label:"启用管理"},{default:l(()=>[e(V,{disabled:!x.value,modelValue:k.is_manage,"onUpdate:modelValue":v[0]||(v[0]=R=>k.is_manage=R),class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"}},null,8,["disabled","modelValue"])]),_:1}),k.is_manage?(p(),L(pe,{key:0,data:k.zabbix_sync_info,style:{width:"50%"},border:""},{default:l(()=>[e(b,{label:"接口类型",width:"150"},{default:l(R=>[x.value?(p(),L(A,{key:0,modelValue:R.row.type,"onUpdate:modelValue":S=>R.row.type=S,filterable:"",placeholder:"接口类型",style:{width:"120px"}},{default:l(()=>[(p(!0),T(G,null,le(E(R.$index),S=>(p(),L(d,{key:S.value,label:S.label,value:S.value,disabled:S.disabled},null,8,["label","value","disabled"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):(p(),T("span",Nl,W(R.row.type),1))]),_:1}),e(b,{label:"接口模板"},{default:l(R=>[x.value?(p(),L(A,{key:0,modelValue:R.row.template,"onUpdate:modelValue":S=>R.row.template=S,filterable:"",placeholder:"模板",style:{width:"400px"}},{default:l(()=>[(p(!0),T(G,null,le(j.value,S=>(p(),L(d,{key:S.value,label:S.label,value:S.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"])):(p(),T("span",Ll,W(R.row.template),1))]),_:1}),x.value?(p(),L(b,{key:0,label:"操作",width:"100"},{header:l(()=>[e(U,{onClick:H,icon:z(il)},{default:l(()=>[...v[4]||(v[4]=[y("添加",-1)])]),_:1},8,["icon"])]),default:l(R=>[e(U,{type:"danger",icon:z(Ge),link:"",onClick:S=>K(R.$index),disabled:k.built_in},{default:l(()=>[...v[5]||(v[5]=[y("删除",-1)])]),_:1},8,["icon","onClick","disabled"])]),_:1})):Ue("",!0)]),_:1},8,["data"])):Ue("",!0)]),_:1},8,["model"]),x.value?(p(),T("div",jl,[e(U,{onClick:v[1]||(v[1]=R=>D())},{default:l(()=>[...v[6]||(v[6]=[y("取消",-1)])]),_:1}),e(U,{type:"primary",onClick:v[2]||(v[2]=R=>oe())},{default:l(()=>[...v[7]||(v[7]=[y("保存",-1)])]),_:1})])):(p(),T("div",ql,[e(U,{onClick:v[3]||(v[3]=R=>B())},{default:l(()=>[...v[8]||(v[8]=[y("编辑",-1)])]),_:1})]))])}}}),Bl={class:"card"},El={class:"dialog-footer"},Al=Oe({__name:"modelinfoView",setup(me){const P=Je(),M=fl(),O=vl();Z(()=>O.modelOptions),Z(()=>O.modelObjectById),Z(()=>O.validationRulesEnumOptionsObject);const h=_l(),x=()=>{E.push({path:"/cmdb/cimodelManage/model"})},B=()=>{h.setCiLastModel(I.value.id),xe(()=>{E.push({path:"/cmdb/cidata"})})},ee=r(""),k=r(""),X=r(""),j=r(""),E=dl(),H=Le(),{proxy:K}=he();r("");const D=r([]),w=async()=>{let a=await K.$api.getCiModelGroup();console.log(a),D.value=a.data.results,console.log(D.value)},f=r({}),I=r({}),oe=async()=>{let a=await K.$api.getCiModel({},fe.value);I.value=a.data.model,f.value=a.data,console.log(I.value)},C=Z(()=>!f.value||!f.value.field_groups?[]:f.value.field_groups.flatMap(a=>a.fields||[])),v=(a,u)=>{a.props.name==="verification"?ee.value.getTableData({model:A.value}):a.props.name==="field"||(a.props.name==="instance_name_temp"?X.value.getModel():a.props.name==="model_node_sync"&&(j.value.getConfigData(),j.value.getZabbixTemplates()))},V=r("field");console.log(P);const m=r(!1),d=()=>{m.value=!0};r("ElemeFilled");const A=Z(()=>{var a;return(a=I.value)==null?void 0:a.id}),b=ve({name:"",verbose_name:"",model_group:"",icon:"ElemeFilled",built_in:!1,update_user:"admin"}),U=r(),pe=ve({name:[{required:!0,message:"请输入模型标识",trigger:"blur"},{pattern:/^[a-z][a-z_]{3,20}$/,trigger:"blur",message:"以英文字符开头,可以使用英文,下划线,长度3-20 ",required:!0}],verbose_name:[{required:!0,message:"请输入模型名称",trigger:"blur"}],model_group:[{required:!0,message:"请选择分组",trigger:"blur"}]});r(!1);const ae=r(!1),R=a=>{ae.value=!1,ie(a)},S=async a=>{a&&await a.validate(async(u,ue)=>{if(u){let te=await K.$api.updateCiModel({id:fe.value,...b});console.log(te),te.status=="200"?(_({type:"success",message:"更新成功"}),ae.value=!1,ie(a),getCiModelInfo(P.query,P.query.id)):_({showClose:!0,message:"添加失败:"+JSON.stringify(te.data),type:"error"})}})},ge=a=>{be.confirm("是否确认关闭?").then(()=>{a(),ie(U.value)}).catch(()=>{})},ie=a=>{a&&a.resetFields()},ce=a=>{be.confirm("是否确认删除?","删除组",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await K.$api.deleteCiModel(a)).status==204?(_({type:"success",message:"删除成功"}),M.removeTabs(P.path,!0)):_({type:"error",message:"删除失败"})}).catch(()=>{_({type:"info",message:"取消删除"})})},fe=r(""),ye=a=>{console.log(a),b.icon=a.icon,b.verbose_name=a.verbose_name,b.name=a.name,b.model_group=a.model_group,b.update_user=H.state.username,console.log(b),ae.value=!0,fe.value=a.id,w()};return ul(async()=>{fe.value=P.path.split("/").at(-1),await oe(),await k.value.getModelField(f.value),await k.value.getCiModelList(),await k.value.getRules(),await k.value.getModelFieldType()}),rl(()=>{console.log("onUnmounted")}),ml(()=>{console.log("onBeforeMount")}),(a,u)=>{const ue=pl,te=n("el-button"),Q=n("el-text"),i=n("el-link"),Se=n("el-space"),we=n("el-page-header"),re=n("el-col"),se=n("el-row"),_e=n("el-tab-pane"),qe=n("el-tabs"),ke=n("el-form-item"),Re=n("el-input"),ze=n("el-option"),Be=n("el-select"),Ee=n("el-form"),ne=n("el-dialog"),Te=je("permission");return p(),T(G,null,[q("div",Bl,[e(se,{class:"cimodelinfo",justify:"space-between"},{default:l(()=>[e(re,{span:20},{default:l(()=>[e(we,{onBack:x},{content:l(()=>[e(Se,{size:30},{default:l(()=>[e(te,{size:"large",circle:"",disabled:"",style:{margin:"10px"}},{default:l(()=>{var F,o;return[(F=I.value)!=null&&F.icon?(p(),L(ue,{key:0,icon:(o=I.value)==null?void 0:o.icon},null,8,["icon"])):Ue("",!0)]}),_:1}),e(Q,null,{default:l(()=>[u[12]||(u[12]=y("唯一标识:   ",-1)),e(Q,{tag:"b"},{default:l(()=>[y(W(I.value.name),1)]),_:1})]),_:1}),e(Q,null,{default:l(()=>[u[13]||(u[13]=y("名称:   ",-1)),e(Q,{tag:"b"},{default:l(()=>[y(W(I.value.verbose_name),1)]),_:1})]),_:1}),e(Q,{style:{display:"flex"}},{default:l(()=>[u[14]||(u[14]=y("实例数:   ",-1)),e(i,{type:"primary",tag:"b",onClick:u[0]||(u[0]=F=>B())},{default:l(()=>[y(W(I.value.instance_count),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(re,{span:2,style:{display:"flex","align-items":"center","justify-content":"center"}},{default:l(()=>[e(Se,{alignment:"flex-end"},{default:l(()=>{var F,o;return[N(e(te,{disabled:I.value.built_in,icon:"Delete",onClick:u[1]||(u[1]=t=>ce(I.value.id)),circle:""},null,8,["disabled"]),[[Te,`${(F=z(P).name)==null?void 0:F.replace("_info","")}:delete`]]),N(e(te,{disabled:I.value.built_in,icon:"Edit",onClick:u[2]||(u[2]=t=>ye(I.value)),circle:""},null,8,["disabled"]),[[Te,`${(o=z(P).name)==null?void 0:o.replace("_info","")}:edit`]])]}),_:1})]),_:1})]),_:1}),e(qe,{modelValue:V.value,"onUpdate:modelValue":u[3]||(u[3]=F=>V.value=F),type:"card",class:"demo-tabs",onTabClick:v},{default:l(()=>[e(_e,{label:"模型字段",name:"field"},{default:l(()=>[e(kl,{ref_key:"ciModelFieldRef",ref:k},null,512)]),_:1}),e(_e,{label:"唯一校验",name:"verification"},{default:l(()=>[e(Ul,{modelId:A.value,modelFieldLists:C.value,ref_key:"ciModelUniqueRef",ref:ee},null,8,["modelId","modelFieldLists"])]),_:1}),e(_e,{label:"唯一标识命名",name:"instance_name_temp"},{default:l(()=>[e(Rl,{modelId:A.value,ciModelInfo:I.value,modelFieldLists:C.value,ref_key:"ciModelTemplateRef",ref:X},null,8,["modelId","ciModelInfo","modelFieldLists"])]),_:1}),e(_e,{label:"同步管理",name:"model_node_sync"},{default:l(()=>[e(zl,{modelId:A.value,modelFieldLists:C.value,ref_key:"ciModelConfigRef",ref:j},null,8,["modelId","modelFieldLists"])]),_:1})]),_:1},8,["modelValue"])]),e(ne,{modelValue:ae.value,"onUpdate:modelValue":u[11]||(u[11]=F=>ae.value=F),title:"编辑模型",width:"500","before-close":ge},{footer:l(()=>[q("div",El,[e(te,{onClick:u[9]||(u[9]=F=>R(U.value))},{default:l(()=>[...u[15]||(u[15]=[y("取消",-1)])]),_:1}),e(te,{type:"primary",onClick:u[10]||(u[10]=F=>S(U.value))},{default:l(()=>[...u[16]||(u[16]=[y(" 确认 ",-1)])]),_:1})])]),default:l(()=>[e(Ee,{ref_key:"modelFormRef",ref:U,style:{"max-width":"600px"},model:b,rules:pe,"label-width":"auto",class:"demo-modelForm","status-icon":""},{default:l(()=>[e(ke,{label:"模型图标",prop:"icon"},{default:l(()=>[e(te,{onClick:d,icon:b.icon},null,8,["icon"]),e(cl,{isShow:m.value,"onUpdate:isShow":u[4]||(u[4]=F=>m.value=F),iconName:b.icon,"onUpdate:iconName":u[5]||(u[5]=F=>b.icon=F)},null,8,["isShow","iconName"])]),_:1}),e(ke,{label:"唯一标识",prop:"name"},{default:l(()=>[e(Re,{modelValue:b.name,"onUpdate:modelValue":u[6]||(u[6]=F=>b.name=F),placeholder:"请输入模型的唯一标识",disabled:""},null,8,["modelValue"])]),_:1}),e(ke,{label:"模型名称",prop:"verbose_name"},{default:l(()=>[e(Re,{modelValue:b.verbose_name,"onUpdate:modelValue":u[7]||(u[7]=F=>b.verbose_name=F)},null,8,["modelValue"])]),_:1}),e(ke,{label:"所属分组",prop:"model_group"},{default:l(()=>[e(Be,{modelValue:b.model_group,"onUpdate:modelValue":u[8]||(u[8]=F=>b.model_group=F),placeholder:"选择分组"},{default:l(()=>[(p(!0),T(G,null,le(D.value,(F,o)=>(p(),L(ze,{label:F.verbose_name,value:F.id,key:o},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])],64)}}}),Xl=Ke(Al,[["__scopeId","data-v-8eedf9f6"]]);export{Xl as default};
