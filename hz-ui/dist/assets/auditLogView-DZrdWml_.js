import{d as re,g as ie,l as J,r as c,m as ue,e as v,c as w,o as p,i as s,b as o,F as P,p as A,w as i,k as y,t as b,q as z,y as L,c4 as ce,j as de,z as U,c5 as pe,_ as me}from"./index-BuQNgUX_.js";import{Q as ve}from"./vue3-json-viewer-CkXyoLi1.js";import{d as _e}from"./gmCrypto-CBKAM5YR.js";import{u as ge}from"./config-DKGeRbNI.js";const fe={class:"divVertical"},we={class:"card filter-card"},ye={class:"filter-container"},be={class:"filter-row"},he={class:"filter-item"},Te={class:"filter-row filter-row-flex"},De={class:"filter-item"},Ve={class:"filter-item"},ke={class:"filter-item"},Ce={class:"filter-item"},Ee={class:"card table-container table-main",style:{width:"100%"}},xe=["onClick"],Se={class:"change-content"},je={key:0,class:"old-value"},$e={key:3,class:"new-value"},Me={class:"drawer-content"},Oe=re({__name:"auditLogView",setup(Pe){const{proxy:N}=ie(),R=ge(),H=J(()=>R.gmCry);c([{value:"host",label:"主机"},{value:"switch",label:"交换机"}]);const Q=c([{value:"CREATE",label:"创建"},{value:"DELETE",label:"删除"},{value:"UPDATE",label:"修改"}]),_=c([]),g=c([]),d=c([]),G=[{text:"最近1天",value:()=>{const t=new Date,e=new Date;return e.setTime(t.getTime()-3600*1e3*24*1),[e,t]}},{text:"最近3天",value:()=>{const t=new Date,e=new Date;return e.setTime(t.getTime()-3600*1e3*24*3),[e,t]}},{text:"最近5天",value:()=>{const t=new Date,e=new Date;return e.setTime(t.getTime()-3600*1e3*24*5),[e,t]}},{text:"最近7天",value:()=>{const t=new Date,e=new Date;return e.setTime(t.getTime()-3600*1e3*24*7),[e,t]}},{text:"最近1周",value:()=>{const t=new Date,e=new Date;return e.setTime(t.getTime()-3600*1e3*24*7),[e,t]}},{text:"最近1个月",value:()=>{const t=new Date,e=new Date;return e.setTime(t.getTime()-3600*1e3*24*30),[e,t]}},{text:"最近3个月",value:()=>{const t=new Date,e=new Date;return e.setTime(t.getTime()-3600*1e3*24*90),[e,t]}}],Y=()=>{const t=new Date,e=new Date;e.setHours(23,59,59,999),t.setTime(e.getTime()-3600*1e3*24*30),t.setHours(0,0,0,0);const n=l=>{const u=l.getFullYear(),S=String(l.getMonth()+1).padStart(2,"0"),j=String(l.getDate()).padStart(2,"0"),m=String(l.getHours()).padStart(2,"0"),h=String(l.getMinutes()).padStart(2,"0"),$=String(l.getSeconds()).padStart(2,"0"),M=String(l.getMilliseconds()).padStart(3,"0");return`${u}-${S}-${j}T${m}:${h}:${$}.${M}`};d.value=[n(t),n(e)]},T=c(""),W=t=>{const e=_.value.indexOf(t);e===-1?_.value.push(t):_.value.splice(e,1),f()},X=t=>{const e=g.value.indexOf(t);e===-1?g.value.push(t):g.value.splice(e,1),f()},Z=t=>{d.value=t,console.log("时间范围:",t),f()},B=()=>{f()},F=c([]),k=c(1),C=c(10),I=c(0),K=()=>{f()},E=c(!1),x=c({});J(()=>JSON.stringify(x.value,null,2));const ee=t=>{x.value=t,E.value=!0},q={model:"模型",model_field:"字段",model_instance:"实例",model_group:"模型组",unique_constraint:"唯一约束",model_field_group:"模型字段组",validation_rule:"校验规则",model_instance_group:"实例组"},te=t=>q[t]||t,ne={CREATE:"创建",UPDATE:"修改",DELETE:"删除"},ae=t=>ne[t]||t,le=t=>({CREATE:"success",UPDATE:"warning",DELETE:"danger"})[t]||"",D={groups:"实例组",instance_name:"实例名称",order:"排序",verbose_name:"字段名称",model_field_group:"字段分组",instance_name_template:"实例名称模板",fields:"字段组合"},oe=t=>{const e=[];return t.changed_fields&&Object.keys(t.changed_fields).forEach(n=>{const l=t.changed_fields[n];n!=="update_user"&&(n==="groups"?e.push({field:D[n],oldValue:l[0].map(u=>u.path).join(","),newValue:l[1].map(u=>u.path).join(",")}):n==="instance_name_template"?e.push({field:D[n],oldValue:l[0].length>>0?l[0].map(u=>u.verbose_name).join("-"):null,newValue:l[1].length>>0?l[1].map(u=>u.verbose_name).join("-"):null}):e.push({field:D.hasOwnProperty(n)?D[n]:n,oldValue:V(l[0]),newValue:V(l[1])}))}),t.details&&t.details.forEach(n=>{e.push({field:n.verbose_name||n.name,oldValue:V(n.old_value),newValue:V(n.new_value)})}),e},V=t=>{const e=n=>{if(typeof n=="object"&&n!==null){if(n.hasOwnProperty("label")&&n.label!==void 0)return n.label;if(n.hasOwnProperty("instance_name")&&n.instance_name!==void 0)return n.instance_name;if(n.hasOwnProperty("verbose_name")&&n.verbose_name!==void 0)return n.verbose_name;if(n.hasOwnProperty("password")&&n.password!==void 0)return R.isShowPass?_e(H.value.key,H.value.mode,n.password):"******";if(typeof n=="object")return n.map(l=>l.verbose_name).join("-")}};if(t===null)return t;if(typeof t=="object")return e(t);if(typeof t=="string")try{const n=JSON.parse(t);return e(n)}catch{return t}return t},f=async()=>{try{const t={page:k.value,page_size:C.value,target_type:_.value.length?_.value.join(","):void 0,action:g.value.length?g.value.join(","):void 0,time_after:d.value&&d.value[0]?d.value[0]:void 0,time_before:d.value&&d.value[1]?d.value[1]:void 0,search:T.value||void 0},e=await N.$api.getAuditLog(t);F.value=e.data.results,I.value=e.data.count}catch(t){console.error("获取审计日志失败:",t),N.$message.error("获取审计日志失败")}},se=()=>{_.value=[],g.value=[],d.value=[],T.value="",Y(),f()};return ue(()=>{Y(),f()}),(t,e)=>{const n=v("el-tag"),l=v("el-date-picker"),u=v("el-button"),S=v("el-input"),j=v("el-tooltip"),m=v("el-table-column"),h=v("el-text"),$=v("el-table"),M=v("el-pagination");return p(),w("div",fe,[s("div",we,[s("div",ye,[s("div",be,[s("div",he,[e[7]||(e[7]=s("span",{class:"filter-label"},"操作对象：",-1)),(p(),w(P,null,A(q,(a,r,O)=>o(n,{key:O,type:_.value.includes(r)?"primary":"info",onClick:Ae=>W(r),class:"filter-tag"},{default:i(()=>[y(b(a),1)]),_:2},1032,["type","onClick"])),64))])]),s("div",Te,[s("div",De,[e[8]||(e[8]=s("span",{class:"filter-label"},"操作类型：",-1)),(p(!0),w(P,null,A(Q.value,a=>(p(),z(n,{key:a.value,type:g.value.includes(a.value)?"primary":"info",onClick:r=>X(a.value),class:"filter-tag"},{default:i(()=>[y(b(a.label),1)]),_:2},1032,["type","onClick"]))),128))]),s("div",Ve,[e[9]||(e[9]=s("span",{class:"filter-label"},"时间范围：",-1)),o(l,{modelValue:d.value,"onUpdate:modelValue":e[0]||(e[0]=a=>d.value=a),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间","value-format":"YYYY-MM-DDTHH:mm:ss",shortcuts:G,onChange:Z},null,8,["modelValue"])]),s("div",ke,[o(S,{modelValue:T.value,"onUpdate:modelValue":e[1]||(e[1]=a=>T.value=a),placeholder:"请输入搜索关键词",clearable:"",style:{width:"200px"},onKeyup:de(B,["enter"])},{append:i(()=>[o(u,{icon:L(ce),onClick:B},null,8,["icon"])]),_:1},8,["modelValue"])]),s("div",Ce,[o(u,{onClick:se},{default:i(()=>[...e[10]||(e[10]=[y("重置",-1)])]),_:1})])])])]),s("div",Ee,[o($,{data:F.value,style:{flex:"1"},border:"","table-layout":"fixed","highlight-current-row":""},{default:i(()=>[o(m,{prop:"target_type",label:"操作对象",width:"120"},{default:i(a=>[o(j,{content:"查看详情",placement:"right",effect:"dark"},{default:i(()=>[s("span",{class:"target-type-link",onClick:r=>ee(a.row)},b(te(a.row.target_type)),9,xe)]),_:2},1024)]),_:1}),o(m,{label:"操作类型",width:"120"},{default:i(a=>[o(n,{type:le(a.row.action)},{default:i(()=>[y(b(ae(a.row.action)),1)]),_:2},1032,["type"])]),_:1}),o(m,{prop:"operator",label:"操作人",width:"120"}),o(m,{prop:"operator_ip",label:"操作人IP",width:"120"}),o(m,{prop:"comment",label:"操作描述","show-overflow-tooltip":""}),o(m,{label:"变更内容"},{default:i(a=>[s("div",Se,[a.row.action=="UPDATE"?(p(!0),w(P,{key:0},A(oe(a.row),(r,O)=>(p(),w("div",{key:O,class:"change-item"},[o(h,{tag:"b"},{default:i(()=>[y(b(r.field)+": ",1)]),_:2},1024),r.oldValue!==void 0?(p(),w("span",je,b(r.oldValue!==null?r.oldValue:"null"),1)):(p(),z(h,{key:1},{default:i(()=>[...e[11]||(e[11]=[y("null",-1)])]),_:1})),r.oldValue!==void 0&&r.newValue!==void 0?(p(),z(h,{key:2,tag:"b",type:"warning"},{default:i(()=>[...e[12]||(e[12]=[y(" → ",-1)])]),_:1})):U("",!0),r.newValue!==void 0?(p(),w("span",$e,b(r.newValue!==null?r.newValue:"null"),1)):U("",!0)]))),128)):U("",!0)])]),_:1}),o(m,{prop:"timestamp",label:"操作时间",width:"300"})]),_:1},8,["data"]),o(M,{"current-page":k.value,"onUpdate:currentPage":[e[2]||(e[2]=a=>k.value=a),e[4]||(e[4]=a=>K())],"page-size":C.value,"onUpdate:pageSize":[e[3]||(e[3]=a=>C.value=a),e[5]||(e[5]=a=>K())],"page-sizes":[10,20,50,100,200],layout:"total, sizes, prev, pager, next, jumper",total:I.value,style:{"margin-top":"20px","justify-content":"flex-end",display:"flex"}},null,8,["current-page","page-size","total"])]),o(L(pe),{modelValue:E.value,"onUpdate:modelValue":e[6]||(e[6]=a=>E.value=a),title:"详细信息",direction:"rtl",size:"50%"},{default:i(()=>[s("div",Me,[o(L(ve),{value:x.value,"expand-depth":5,copyable:"",boxed:"",sort:""},null,8,["value"])])]),_:1},8,["modelValue"])])}}}),Re=me(Oe,[["__scopeId","data-v-e8d637d4"]]);export{Re as default};
