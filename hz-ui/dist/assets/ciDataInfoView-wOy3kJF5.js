import{d as Me,g as je,x as Se,j as Ee,v as J,r as q,a as Ue,bP as Ye,z as Ne,h as g,bc as ze,c as h,o as n,b as H,bV as ce,f as l,m as ae,B as o,w as t,q as s,t as c,F as j,i as E,cc as Pe,cd as Fe,k as w,b_ as M,aP as Be,c4 as De,_ as Te,u as Le,cq as Je}from"./index-CWdEKdsq.js";import{e as He,d as We}from"./gmCrypto-CqnZf592.js";import{m as Ae}from"./model-doa-3kv_.js";import{c as Ge}from"./ciDataAudit-BVSdeYkD.js";import"./vue3-json-viewer-DHXfab_Y.js";const Qe={class:"relations-card"},Xe={class:"card-header"},Ze={key:0},Ke={key:1},et={key:0},tt={key:1},at=["innerHTML"],lt={style:{float:"left"}},nt={style:{float:"right",color:"var(--el-text-color-secondary)","font-size":"13px"}},ot={key:3,style:{"font-size":"12px",color:"#999","margin-top":"3px"}},rt={class:"dialog-footer"},ut=Me({__name:"ciDataRelation",props:{instanceId:{type:String,required:!0},modelId:{type:String,required:!0}},setup(re){const N=re,{proxy:Z}=je(),b=Se();Ee();const le=Ae(),F=J(()=>le.modelOptions),ve=J(()=>le.modelObjectById),be=J(()=>le.validationRulesEnumOptionsObject),ne=q(!1),oe=q(!1),ue=q([]),W=q([]),V=q([]),B=Ue({currentPage:1,pageSize:10,total:0}),G=q(!1),u=q(),C=q(!1),se=q(null),v=Ue({relation:null,source_instance:N.instanceId,target_instance:null,source_attributes:{},target_attributes:{},relation_attributes:{}}),ge={relation:[{required:!0,message:"请选择关系类型",trigger:"change"}],target_instance:[{required:!0,message:"请选择目标实例",trigger:"change"}],source_attributes:{},target_attributes:{},relation_attributes:{}},de=async()=>{ne.value=!0;try{const a=await Z.$api.getModelInstanceRelation({instances:N.instanceId,page:B.currentPage,page_size:B.pageSize});ue.value=a.data.results,B.total=a.data.count}catch(a){M.error("获取关联关系数据失败"),console.error(a)}finally{ne.value=!1}},Y=J(()=>{const a={};return W.value.forEach(r=>{a[r.id]=r}),a}),L=q(null),T=q([]),Q=q(!1);Ye(()=>v.relation,()=>{if(!v.relation)return;let a=Y.value[v.relation].source_model,r=Y.value[v.relation].target_model;(a==null?void 0:a.indexOf(N.modelId))!==-1?(r==null?void 0:r.indexOf(N.modelId))!==-1?T.value=F.value.filter(p=>r.indexOf(p.value)!==-1||a.indexOf(p.value)!==-1):(T.value=F.value.filter(p=>r.indexOf(p.value)!==-1),Q.value=!1):(T.value=F.value.filter(p=>a.indexOf(p.value)!==-1),Q.value=!0),L.value=T.value[0].value},{deep:!0});const ye=()=>{C.value||(v.target_instance=null)},_e=async()=>{try{const a=await Z.$api.getModelRelationDefine({any_model:N.modelId});W.value=a.data.results}catch(a){M.error("获取关系类型失败"),console.error(a)}},he=async a=>{if(!v.relation){V.value=[];return}oe.value=!0;try{if(L.value){const r=await Z.$api.getCiModelInstance({model:L.value,search:a,page_size:20});V.value=r.data.results,V.value=V.value.filter(p=>p.id!==N.instanceId)}}catch(r){M.error("搜索目标实例失败"),console.error(r)}finally{oe.value=!1}},$e=()=>{v.target_instance=null,he("")},qe=()=>{C.value=!1,se.value=null,G.value=!0,_e()},Ie=async a=>{C.value=!0,se.value=a.id,G.value=!0,W.value.length===0&&await _e(),v.relation=a.relation.id,v.source_attributes=a.source_attributes||{},v.target_attributes=a.target_attributes||{},v.relation_attributes=a.relation_attributes||{},Q.value=a.source_instance.id!==N.instanceId,Be(()=>{L.value=a.target_instance.model,V.value=[{id:a.source_instance.id,instance_name:a.source_instance.instance_name},{id:a.target_instance.id,instance_name:a.target_instance.instance_name}],v.target_instance=Q.value?a.source_instance.id:a.target_instance.id})},pe=()=>{var a;(a=u.value)==null||a.resetFields(),v.relation=null,v.target_instance=null,v.source_attributes={},v.target_attributes={},v.relation_attributes={},V.value=[],C.value=!1,Q.value=!1,se.value=null,T.value=[],L.value=null},ke=async()=>{var a;await((a=u.value)==null?void 0:a.validate(async r=>{if(r)try{let p,y={...v};Q.value&&(y.target_instance=v.source_instance,y.source_instance=v.target_instance),C.value?p=await Z.$api.updateModelInstanceRelation({id:se.value,...y}):p=await Z.$api.addModelInstanceRelation({source_instance:N.instanceId,...y}),p.status===201&&!C.value||p.status===200&&C.value?(M.success(C.value?"编辑关联关系成功":"添加关联关系成功"),G.value=!1,pe(),de()):M.error(C.value?`编辑关联关系失败,${JSON.stringify(p.data)}`:`添加关联关系失败,${JSON.stringify(p.data)}}`)}catch(p){M.error((C.value?"编辑关联关系失败: ":"添加关联关系失败: ")+p.message),console.error(p)}}))},Ce=a=>{De.confirm("确定要删除这个关联关系吗？","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{(await Z.$api.deleteModelInstanceRelation(a)).status===204?(M.success("删除成功"),de()):M.error("删除失败")}catch(r){M.error("删除失败: "+r.message),console.error(r)}}).catch(()=>{})},i=a=>{B.pageSize=a,de()},_=a=>{B.currentPage=a,de()},x=a=>a?a.source_instance.id===N.instanceId?a.relation.forward_verb:a.relation.reverse_verb:"",$=a=>{var K,ee;if(!a)return"";const r=a.source_instance.instance_name,p=a.target_instance.instance_name,y=x(a),U=(K=ve.value[a.source_instance.model])==null?void 0:K.verbose_name,S=(ee=ve.value[a.target_instance.model])==null?void 0:ee.verbose_name;let A,X;if(a.source_instance.id===N.instanceId){A=Object.keys(a.source_attributes).map(O=>`${P(a.relation,O)}: ${I(a.relation,O,a.source_attributes[O])}`).join(", "),X=Object.keys(a.target_attributes).map(O=>`${R(a.relation,O)}: ${I(a.relation,O,a.target_attributes[O])}`).join(", ");let z=`<span class="source-name">${r}</span>(${U})`;return A&&(z+=`的[${A}]`),z+=` - <span class="relation-name">${y}</span> - <span class="target-name">${p}</span>(${S})`,X&&(z+=`的[${X}]`),z}else{X=Object.keys(a.target_attributes).map(O=>`${R(a.relation,O)}: ${I(a.relation,O,a.target_attributes[O])}`).join(", "),A=Object.keys(a.source_attributes).map(O=>`${P(a.relation,O)}: ${I(a.relation,O,a.source_attributes[O])}`).join(", ");let z=`<span class="source-name">${p}</span>(${S})`;return X&&(z+=`的[${X}]`),z+=` - <span class="relation-name">${y}</span> - <span class="target-name">${r}</span>(${U})`,A&&(z+=`的[${A}]`),z}},P=(a,r)=>{if(!a||!a.attribute_schema||!a.attribute_schema.source)return r;const p=a.attribute_schema.source[r];return p?p.verbose_name:r},k=(a,r)=>{if(!a||!a.attribute_schema||!a.attribute_schema.relation)return r;const p=a.attribute_schema.relation[r];return p?p.verbose_name:r},R=(a,r)=>{if(!a||!a.attribute_schema||!a.attribute_schema.target)return r;const p=a.attribute_schema.target[r];return p?p.verbose_name:r},I=(a,r,p)=>{if(!a||!a.attribute_schema||!a.attribute_schema.relation)return p;const y=a.attribute_schema.relation[r];if(!y)return p;if(y.type==="enum"&&y.validation_rule){const U=be.value[y.validation_rule];if(U){const S=U.find(A=>A.value===p);if(S)return S.label}}return y.unit?`${p} ${y.unit}`:p};return Ne(()=>{de(),_e()}),(a,r)=>{var D;const p=g("el-button"),y=g("el-tag"),U=g("el-table-column"),S=g("el-text"),A=g("el-table"),X=g("el-pagination"),K=g("el-option"),ee=g("el-select"),z=g("el-form-item"),O=g("el-radio-button"),Ve=g("el-radio-group"),xe=g("el-radio"),me=g("el-input"),Oe=g("el-input-number"),Re=g("el-form"),ie=g("el-dialog"),fe=ze("permission"),we=ze("loading");return n(),h("div",Qe,[H("div",Xe,[H("div",null,[ce((n(),o(p,{type:"primary",onClick:qe},{default:t(()=>[...r[8]||(r[8]=[s(" 添加关联 ",-1)])]),_:1})),[[fe,`${(D=ae(b).name)==null?void 0:D.replace("_info","")}:add`]])])]),ce((n(),o(A,{data:ue.value,style:{width:"100%"},border:""},{default:t(()=>[l(U,{prop:"source_instance",label:"源实例"},{default:t(d=>[d.row.source_instance.id!==re.instanceId?(n(),o(y,{key:0},{default:t(()=>[s(c(d.row.target_instance.instance_name),1)]),_:2},1024)):(n(),o(y,{key:1},{default:t(()=>[s(c(d.row.source_instance.instance_name),1)]),_:2},1024))]),_:1}),l(U,{prop:"source_attributes",label:"源属性",width:"150"},{default:t(d=>[d.row.source_instance.id===re.instanceId?(n(),h("div",Ze,[(n(!0),h(j,null,E(d.row.source_attributes,(e,f)=>(n(),h("div",{key:f,style:{"font-size":"12px"}},[l(S,{tag:"b"},{default:t(()=>[s(c(P(d.row.relation,f))+":",1)]),_:2},1024),s(" "+c(e),1)]))),128))])):(n(),h("div",Ke,[(n(!0),h(j,null,E(d.row.target_attributes,(e,f)=>(n(),h("div",{key:f,style:{"font-size":"12px"}},[l(S,{tag:"b"},{default:t(()=>[s(c(R(d.row.relation,f))+":",1)]),_:2},1024),s(" "+c(e),1)]))),128))]))]),_:1}),l(U,{prop:"relation",label:"关联动作",width:"100"},{default:t(d=>[l(y,{type:"success"},{default:t(()=>[s(c(x(d.row)),1)]),_:2},1024)]),_:1}),l(U,{prop:"source_instance",label:"目标实例"},{default:t(d=>[d.row.source_instance.id!==re.instanceId?(n(),o(y,{key:0},{default:t(()=>[s(c(d.row.source_instance.instance_name),1)]),_:2},1024)):(n(),o(y,{key:1},{default:t(()=>[s(c(d.row.target_instance.instance_name),1)]),_:2},1024))]),_:1}),l(U,{prop:"target_attributes",label:"目标属性",width:"150"},{default:t(d=>[d.row.source_instance.id!==re.instanceId?(n(),h("div",et,[(n(!0),h(j,null,E(d.row.source_attributes,(e,f)=>(n(),h("div",{key:f,style:{"font-size":"12px"}},[l(S,{tag:"b"},{default:t(()=>[s(c(P(d.row.relation,f))+":",1)]),_:2},1024),s(" "+c(e),1)]))),128))])):(n(),h("div",tt,[(n(!0),h(j,null,E(d.row.target_attributes,(e,f)=>(n(),h("div",{key:f,style:{"font-size":"12px"}},[l(S,{tag:"b"},{default:t(()=>[s(c(R(d.row.relation,f))+":",1)]),_:2},1024),s(" "+c(e),1)]))),128))]))]),_:1}),l(U,{prop:"relation_attributes",label:"关系属性",width:"150"},{default:t(d=>[(n(!0),h(j,null,E(d.row.relation_attributes,(e,f)=>(n(),h("div",{key:f,style:{"font-size":"12px"}},[l(S,{tag:"b"},{default:t(()=>[s(c(k(d.row.relation,f))+":",1)]),_:2},1024),s(" "+c(I(d.row.relation,f,e)),1)]))),128))]),_:1}),l(U,{prop:"relation",label:"关系类型",width:"150"},{default:t(d=>[l(y,{type:"info"},{default:t(()=>[s(c(d.row.relation.name),1)]),_:2},1024)]),_:1}),l(U,{prop:"id",label:"关联动作描述"},{default:t(d=>[H("div",{class:"relation-description",innerHTML:$(d.row)},null,8,at)]),_:1}),l(U,{label:"操作",width:"120",fixed:"right"},{default:t(d=>{var e,f;return[ce(l(p,{onClick:m=>Ie(d.row),type:"primary",icon:ae(Pe),link:""},null,8,["onClick","icon"]),[[fe,`${(e=ae(b).name)==null?void 0:e.replace("_info","")}:edit`]]),ce(l(p,{type:"danger",link:"",icon:ae(Fe),onClick:m=>Ce(d.row.id)},null,8,["icon","onClick"]),[[fe,`${(f=ae(b).name)==null?void 0:f.replace("_info","")}:delete`]])]}),_:1})]),_:1},8,["data"])),[[we,ne.value]]),l(X,{"current-page":B.currentPage,"onUpdate:currentPage":r[0]||(r[0]=d=>B.currentPage=d),"page-size":B.pageSize,"onUpdate:pageSize":r[1]||(r[1]=d=>B.pageSize=d),"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",total:B.total,onSizeChange:i,onCurrentChange:_,style:{"margin-top":"20px","justify-content":"flex-end"}},null,8,["current-page","page-size","total"]),l(ie,{modelValue:G.value,"onUpdate:modelValue":r[7]||(r[7]=d=>G.value=d),title:C.value?"编辑关联关系":"添加关联关系",width:"600px",onClose:pe},{footer:t(()=>[H("div",rt,[l(p,{onClick:r[6]||(r[6]=d=>G.value=!1)},{default:t(()=>[...r[9]||(r[9]=[s("取消",-1)])]),_:1}),l(p,{type:"primary",onClick:ke},{default:t(()=>[s(c(C.value?"保存":"添加"),1)]),_:1})])]),default:t(()=>[l(Re,{ref_key:"addRelationFormRef",ref:u,model:v,rules:ge,"label-width":"120px"},{default:t(()=>{var d;return[l(z,{label:"关系类型",prop:"relation"},{default:t(()=>[l(ee,{modelValue:v.relation,"onUpdate:modelValue":r[2]||(r[2]=e=>v.relation=e),placeholder:"请选择关系类型",style:{width:"100%"},onChange:$e,disabled:C.value},{default:t(()=>[(n(!0),h(j,null,E(W.value,e=>(n(),o(K,{key:e.id,label:e.name,value:e.id},{default:t(()=>{var f;return[H("span",lt,c(e.name),1),H("span",nt,c(((f=e.source_model)==null?void 0:f.indexOf(N.modelId))>>>-1?"目标实例":"源实例"),1)]}),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),l(z,{label:"目标实例",prop:"target_instance"},{default:t(()=>[l(Ve,{modelValue:L.value,"onUpdate:modelValue":r[3]||(r[3]=e=>L.value=e),size:"default",onChange:ye},{default:t(()=>[(n(!0),h(j,null,E(T.value,(e,f)=>(n(),o(O,{disabled:C.value,label:e.label,value:e.value,key:f},null,8,["disabled","label","value"]))),128))]),_:1},8,["modelValue"]),l(ee,{modelValue:v.target_instance,"onUpdate:modelValue":r[4]||(r[4]=e=>v.target_instance=e),placeholder:"请选择关联实例",style:{width:"100%","margin-top":"5px"},filterable:"",remote:"","remote-method":he,loading:oe.value,disabled:C.value},{default:t(()=>[(n(!0),h(j,null,E(V.value,e=>(n(),o(K,{key:e.id,label:e.instance_name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading","disabled"])]),_:1}),L.value===re.modelId?(n(),o(z,{key:0,label:"关联动作"},{default:t(()=>[l(Ve,{modelValue:Q.value,"onUpdate:modelValue":r[5]||(r[5]=e=>Q.value=e),disabled:C.value},{default:t(()=>[l(xe,{value:!1,size:"large"},{default:t(()=>{var e;return[s(c((e=Y.value[v.relation])==null?void 0:e.forward_verb),1)]}),_:1}),l(xe,{value:!0,size:"large"},{default:t(()=>{var e;return[s(c((e=Y.value[v.relation])==null?void 0:e.reverse_verb),1)]}),_:1})]),_:1},8,["modelValue","disabled"])]),_:1})):w("",!0),(d=Y.value[v.relation])!=null&&d.attribute_schema?(n(),h(j,{key:1},[(n(!0),h(j,null,E(Y.value[v.relation].attribute_schema.source,(e,f)=>(n(),o(z,{key:"source_"+f,label:e.verbose_name,prop:"source_attributes."+f,required:e.required},{default:t(()=>[l(me,{modelValue:v.source_attributes[f],"onUpdate:modelValue":m=>v.source_attributes[f]=m,placeholder:"请输入"+e.verbose_name,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),_:2},1032,["label","prop","required"]))),128)),(n(!0),h(j,null,E(Y.value[v.relation].attribute_schema.target,(e,f)=>(n(),o(z,{key:"target_"+f,label:e.verbose_name,prop:"target_attributes."+f,required:e.required},{default:t(()=>[l(me,{modelValue:v.target_attributes[f],"onUpdate:modelValue":m=>v.target_attributes[f]=m,placeholder:"请输入"+e.verbose_name,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),_:2},1032,["label","prop","required"]))),128)),(n(!0),h(j,null,E(Y.value[v.relation].attribute_schema.relation,(e,f)=>(n(),o(z,{key:"relation_"+f,label:e.verbose_name,prop:"relation_attributes."+f,required:e.required},{default:t(()=>[e.type==="enum"?(n(),o(ee,{key:0,modelValue:v.relation_attributes[f],"onUpdate:modelValue":m=>v.relation_attributes[f]=m,placeholder:"请选择"+e.verbose_name,style:{width:"100%"}},{default:t(()=>[(n(!0),h(j,null,E(be.value[e.validation_rule],m=>(n(),o(K,{key:m.value,label:m.label,value:m.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder"])):["integer","float"].includes(e.type)?(n(),o(Oe,{key:1,modelValue:v.relation_attributes[f],"onUpdate:modelValue":m=>v.relation_attributes[f]=m,placeholder:"请输入"+e.verbose_name,style:{width:"100%"},"controls-position":"right"},null,8,["modelValue","onUpdate:modelValue","placeholder"])):(n(),o(me,{key:2,modelValue:v.relation_attributes[f],"onUpdate:modelValue":m=>v.relation_attributes[f]=m,placeholder:"请输入"+e.verbose_name,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue","placeholder"])),e.unit?(n(),h("div",ot," 单位: "+c(e.unit),1)):w("",!0)]),_:2},1032,["label","prop","required"]))),128))],64)):w("",!0)]}),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),st=Te(ut,[["__scopeId","data-v-61e5761f"]]),dt={class:"divVertical gap-5"},it={class:"header card"},ct={class:"content card"},_t={style:{width:"200px",display:"flex","justify-content":"flex-end","margin-right":"20px"}},pt={key:0},mt={key:1},ft={key:1},vt={key:1},bt=Me({__name:"ciDataInfoView",setup(re,{expose:N}){const Z=q(null),b=q({}),le=Ae(),F=q({}),ve=J(()=>le.validationRulesEnumOptionsObject),be=J(()=>le.allModelCiDataTreeObj),{proxy:ne}=je(),oe=Se(),ue=Ee(),W=Le(),V=q(!1),B=J(()=>W.gmCry),G=q(),u=Ue({id:null,instance_name:null,using_template:!0}),C=q(null),se=q("modelField"),v=(i,_)=>{i.props.name=="changelog"&&C.value.getData()},ge=q([0]),de=q({}),Y=()=>{u.id=b.value.id,u.instance_name=b.value.instance_name,u.using_template=b.value.using_template,Object.keys(b.value.fields).forEach(i=>{T.value.enum.includes(i)?b.value.fields[i]!==null?u[i]=b.value.fields[i].value:u[i]=null:T.value.model_ref.includes(i)?b.value.fields[i]!==null?(de.value[i]=[b.value.fields[i]],u[i]=b.value.fields[i].id):u[i]=null:u[i]=b.value.fields[i]}),console.log(u)},L=J(()=>{var i,_;return(_=(i=b.value)==null?void 0:i.instance_group)==null?void 0:_.some(x=>x.group_path.includes("空闲池"))}),T=J(()=>{let i={enum:[],boolean:[],model_ref:[],password:[]};return F.value.field_groups&&F.value.field_groups.forEach(_=>{_.fields.forEach(x=>{x.type==="enum"?i.enum.push(x.name):x.type==="boolean"?i.boolean.push(x.name):x.type==="model_ref"?i.model_ref.push(x.name):x.type==="password"&&i.password.push(x.name)})}),i}),Q=i=>{if(!(i==""||i==null))return[{pattern:new RegExp(".*"),message:"不符合正则表达式",trigger:"blur"}]},ye=J(()=>{let i={};for(let[_,x]of Object.entries(u)){if(["id","instance_name","using_template"].includes(_))continue;let $=b.value.fields[_];T.value.enum.includes(_)?$=b.value.fields[_]===null?null:b.value.fields[_].value:T.value.model_ref.includes(_)?$=b.value.fields[_]===null?null:b.value.fields[_].id:T.value.password.includes(_)&&(W.showAllPass||($=b.value.fields[_])),(x!==$||x===null&&$!==null&&$!==void 0||x===""&&$!==""&&$!==null&&$!==void 0)&&(T.value.password.includes(_)&&x!==null&&x!==""?i[_]=He(W.gmCry.key,W.gmCry.mode,x):i[_]=x)}return i}),_e=J(()=>{var i;return(((i=F.value)==null?void 0:i.field_groups)||[]).reduce((_,x)=>((x.fields||[]).forEach($=>{_[$.name]=$}),_),{})}),he=()=>{V.value=!0},$e=()=>{V.value=!1,Be(()=>{Y()})},qe=async()=>{G.value&&await G.value.validate(async(i,_)=>{if(i){if(Object.keys(ye.value).length===0&&u.instance_name===b.value.instance_name&&u.using_template===b.value.using_template){M({showClose:!0,message:"没有数据发生变更",type:"warning"}),V.value=!1;return}const x=Je.service({lock:!0,text:"保存中...",background:"rgba(0, 0, 0, 0.7)"});let $={id:b.value.id,model:F.value.id,fields:ye.value};u.using_template!==b.value.using_template&&($.using_template=u.using_template),u.instance_name!==b.value.instance_name&&($.instance_name=u.instance_name);try{let P=await ne.$api.updateCiModelInstance($);P.status=="200"?(M({type:"success",message:"保存成功"}),V.value=!1,ke()):(console.log(P),M({showClose:!0,message:"保存失败:"+JSON.stringify(P.data),type:"error"}))}catch(P){console.log(P),M({showClose:!0,message:"保存失败，请稍后重试",type:"error"})}finally{x.close()}}else M({showClose:!0,message:"表单填写有误，请检查",type:"error"})})},Ie=()=>{De.confirm("确定要删除该实例吗？此操作不可恢复","删除实例",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{let i=await ne.$api.deleteCiModelInstance(b.value.id);i.status==204?(M.success("删除成功"),pe()):M.error(`删除失败,${JSON.stringify(i.data)}`)}catch{M.error("删除失败，error")}}).catch(()=>{})},pe=()=>{if(oe.name.includes("cmdb_only")){ue.push({path:"/cmdb_only/cmdb/cidata"});return}if(!V.value){ue.push({path:"/cmdb/cidata"});return}De.confirm("确定要离开页面吗？未保存的数据将会丢失","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{ue.push({path:"/cmdb/cidata"})}).catch(()=>{})},ke=async()=>{const i=await ne.$api.getCiModelInstanceInfo(Z.value);i.status===200&&(b.value=i.data)},Ce=async()=>{const i=await ne.$api.getCiModel({},b.value.model);i.status===200&&(F.value=i.data)};return Ne(async()=>{try{Z.value=oe.path.split("/").at(-1),await ke(),await Ce(),le.getModel(),le.getValidationRules(),Y()}catch(i){console.log(i),M.error("数据加载失败",i),ue.back()}}),N({initEditForm:Y}),(i,_)=>{const x=g("el-page-header"),$=g("el-descriptions-item"),P=g("el-descriptions"),k=g("el-text"),R=g("Warning"),I=g("el-icon"),a=g("el-tooltip"),r=g("el-space"),p=g("el-input"),y=g("el-form-item"),U=g("el-switch"),S=g("el-button"),A=g("el-row"),X=g("InfoFilled"),K=g("el-input-number"),ee=g("el-date-picker"),z=g("el-option"),O=g("el-select"),Ve=g("el-select-v2"),xe=g("el-col"),me=g("el-collapse-item"),Oe=g("el-collapse"),Re=g("el-form"),ie=g("el-tab-pane"),fe=g("el-tabs"),we=ze("permission");return n(),h("div",dt,[H("div",it,[l(x,{onBack:pe},{content:t(()=>{var D;return[H("span",null,c(`${(D=F.value.model)==null?void 0:D.verbose_name}【${b.value.instance_name}】`),1)]}),_:1})]),H("div",ct,[l(P,{border:"",column:2,style:{width:"40%","margin-bottom":"10px"},"label-width":"100px"},{default:t(()=>[l($,{label:"唯一标识"},{default:t(()=>[s(c(b.value.instance_name),1)]),_:1}),l($,{label:"所属分组",width:"55%"},{default:t(()=>{var D;return[(n(!0),h(j,null,E((D=b.value)==null?void 0:D.instance_group,(d,e)=>(n(),h("div",{key:e,class:"group-item"},c(d.group_path),1))),128))]}),_:1})]),_:1}),l(fe,{modelValue:se.value,"onUpdate:modelValue":_[3]||(_[3]=D=>se.value=D),type:"card",class:"demo-tabs",onTabClick:v},{default:t(()=>[l(ie,{label:"资产信息",name:"modelField"},{default:t(()=>[l(Re,{ref_key:"editFormRef",ref:G,style:{"max-width":"100%"},model:u,"label-width":"auto","status-icon":"","label-position":"top","require-asterisk-position":"right"},{default:t(()=>[l(A,{gutter:20,justify:"space-between"},{default:t(()=>{var D;return[l(y,{prop:"instance_name",required:"",style:{"margin-left":"30px"}},{label:t(()=>[l(r,{size:2},{default:t(()=>[l(k,{tag:"b"},{default:t(()=>[..._[4]||(_[4]=[s("唯一标识",-1)])]),_:1}),l(a,{content:"唯一命名标识",placement:"right",effect:"dark"},{default:t(()=>[l(I,null,{default:t(()=>[l(R)]),_:1})]),_:1})]),_:1})]),default:t(()=>[V.value?(n(),o(p,{key:0,modelValue:u.instance_name,"onUpdate:modelValue":_[0]||(_[0]=d=>u.instance_name=d),style:{"min-width":"400px"}},null,8,["modelValue"])):(n(),o(k,{key:1},{default:t(()=>[s(c(u.instance_name),1)]),_:1}))]),_:1}),l(y,{prop:"using_template",required:"",style:{"margin-left":"30px"}},{label:t(()=>[l(r,{size:2},{default:t(()=>[l(k,{tag:"b"},{default:t(()=>[..._[5]||(_[5]=[s("自动命名",-1)])]),_:1}),l(a,{content:"是否根据模型的唯一命名规则，自动生成唯一标识",placement:"right",effect:"dark"},{default:t(()=>[l(I,null,{default:t(()=>[l(R)]),_:1})]),_:1})]),_:1})]),default:t(()=>[l(U,{modelValue:u.using_template,"onUpdate:modelValue":_[1]||(_[1]=d=>u.using_template=d),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},disabled:!V.value},null,8,["modelValue","disabled"])]),_:1}),H("div",_t,[V.value?(n(),h("div",mt,[l(S,{onClick:$e},{default:t(()=>[..._[8]||(_[8]=[s("取消",-1)])]),_:1}),l(S,{type:"primary",onClick:qe},{default:t(()=>[..._[9]||(_[9]=[s("保存",-1)])]),_:1})])):(n(),h("div",pt,[ce((n(),o(S,{type:"primary",onClick:he},{default:t(()=>[..._[6]||(_[6]=[s("编辑",-1)])]),_:1})),[[we,`${(D=ae(oe).name)==null?void 0:D.replace("_info","")}:edit`]]),l(a,{content:L.value?"删除实例":"实例不在空闲池，无法删除!",placement:"top",effect:"dark"},{default:t(()=>{var d;return[ce((n(),o(S,{type:"danger",onClick:Ie,disabled:!L.value},{default:t(()=>[..._[7]||(_[7]=[s("删除",-1)])]),_:1},8,["disabled"])),[[we,`${(d=ae(oe).name)==null?void 0:d.replace("_info","")}:delete`]])]}),_:1},8,["content"])]))])]}),_:1}),l(Oe,{modelValue:ge.value,"onUpdate:modelValue":_[2]||(_[2]=D=>ge.value=D)},{default:t(()=>[(n(!0),h(j,null,E(F.value.field_groups,(D,d)=>(n(),o(me,{name:d,key:d},{title:t(()=>[l(k,{tag:"b",size:"large"},{default:t(()=>[s(c(D.verbose_name),1)]),_:2},1024)]),default:t(()=>[l(A,{gutter:20,style:{"margin-left":"30px"}},{default:t(()=>[(n(!0),h(j,null,E(D.fields,(e,f)=>(n(),o(xe,{key:f,xs:24,sm:24,md:12,lg:8,xl:6},{default:t(()=>[e.type==="string"?(n(),o(y,{key:0,label:e.verbose_name,prop:e.name,required:e.required,rules:Q(e.validation_rule)},{label:t(()=>[l(r,{size:2},{default:t(()=>[l(k,{tag:"b"},{default:t(()=>[s(c(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(n(),o(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(I,null,{default:t(()=>[l(R)]),_:1})]),_:1},8,["content"])):w("",!0)]),_:2},1024)]),default:t(()=>[V.value?(n(),o(p,{key:0,modelValue:u[e.name],"onUpdate:modelValue":m=>u[e.name]=m,style:{width:"240px"},disabled:!e.editable},null,8,["modelValue","onUpdate:modelValue","disabled"])):(n(),o(k,{key:1},{default:t(()=>[s(c(u[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required","rules"])):w("",!0),e.type==="json"?(n(),o(y,{key:1,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[l(r,{size:2},{default:t(()=>[l(k,{tag:"b"},{default:t(()=>[s(c(e.verbose_name),1)]),_:2},1024),l(a,{placement:"right",effect:"dark"},{content:t(()=>[..._[10]||(_[10]=[s(" json类型字段",-1),H("br",null,null,-1),s("请输入json格式数据! ",-1)])]),default:t(()=>[l(I,null,{default:t(()=>[l(X)]),_:1})]),_:1}),e.description.length!=0?(n(),o(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(I,null,{default:t(()=>[l(R)]),_:1})]),_:1},8,["content"])):w("",!0)]),_:2},1024)]),default:t(()=>[V.value?(n(),o(p,{key:0,modelValue:u[e.name],"onUpdate:modelValue":m=>u[e.name]=m,style:{width:"240px"},autosize:"",type:"textarea"},null,8,["modelValue","onUpdate:modelValue"])):(n(),o(k,{key:1},{default:t(()=>[s(c(u[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])):w("",!0),["text"].indexOf(e.type)>>>-1?w("",!0):(n(),o(y,{key:2,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[l(r,{size:2},{default:t(()=>[l(k,{tag:"b"},{default:t(()=>[s(c(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(n(),o(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(I,null,{default:t(()=>[l(R)]),_:1})]),_:1},8,["content"])):w("",!0)]),_:2},1024)]),default:t(()=>[V.value?(n(),o(p,{key:0,modelValue:u[e.name],"onUpdate:modelValue":m=>u[e.name]=m,style:{width:"240px"},autosize:"",type:"textarea"},null,8,["modelValue","onUpdate:modelValue"])):(n(),o(k,{key:1},{default:t(()=>[s(c(u[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])),e.type==="boolean"?(n(),o(y,{key:3,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[l(r,{size:2},{default:t(()=>[l(k,{tag:"b"},{default:t(()=>[s(c(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(n(),o(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(I,null,{default:t(()=>[l(R)]),_:1})]),_:1},8,["content"])):w("",!0)]),_:2},1024)]),default:t(()=>[l(U,{modelValue:u[e.name],"onUpdate:modelValue":m=>u[e.name]=m,style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},disabled:!V.value},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1032,["label","prop","required"])):w("",!0),["float"].indexOf(e.type)>>>-1?w("",!0):(n(),o(y,{key:4,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[l(r,{size:2},{default:t(()=>[e.unit!==null?(n(),o(k,{key:0,tag:"b"},{default:t(()=>[s(c(e.verbose_name+"("+e.unit+")"),1)]),_:2},1024)):(n(),o(k,{key:1,tag:"b"},{default:t(()=>[s(c(e.verbose_name),1)]),_:2},1024)),e.description.length!=0?(n(),o(a,{key:2,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(I,null,{default:t(()=>[l(R)]),_:1})]),_:1},8,["content"])):w("",!0)]),_:2},1024)]),default:t(()=>[V.value?(n(),o(K,{key:0,modelValue:u[e.name],"onUpdate:modelValue":m=>u[e.name]=m,precision:2,step:1},null,8,["modelValue","onUpdate:modelValue"])):(n(),o(k,{key:1},{default:t(()=>[s(c(u[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])),["password"].indexOf(e.type)>>>-1?w("",!0):(n(),o(y,{key:5,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[l(r,{size:2},{default:t(()=>[l(k,{tag:"b"},{default:t(()=>[s(c(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(n(),o(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(I,null,{default:t(()=>[l(R)]),_:1})]),_:1},8,["content"])):w("",!0)]),_:2},1024)]),default:t(()=>{var m;return[V.value?(n(),o(p,{key:0,modelValue:u[e.name],"onUpdate:modelValue":te=>u[e.name]=te,style:{width:"240px"},type:"password","auto-complete":"new-password","show-password":"",clearable:""},null,8,["modelValue","onUpdate:modelValue"])):(n(),h("div",ft,[ae(W).showAllPass?(n(),o(k,{key:0},{default:t(()=>[s(c(ae(We)(B.value.key,B.value.mode,u[e.name])),1)]),_:2},1024)):(n(),h("div",vt,[((m=u[e.name])==null?void 0:m.length)>>0?(n(),o(k,{key:0},{default:t(()=>{var te;return[s(c("*".repeat((te=u[e.name])==null?void 0:te.length)),1)]}),_:2},1024)):(n(),o(k,{key:1}))]))]))]}),_:2},1032,["label","prop","required"])),["integer"].indexOf(e.type)>>>-1?w("",!0):(n(),o(y,{key:6,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[l(r,{size:2},{default:t(()=>[e.unit!==null?(n(),o(k,{key:0,tag:"b"},{default:t(()=>[s(c(e.verbose_name+"("+e.unit+")"),1)]),_:2},1024)):(n(),o(k,{key:1,tag:"b"},{default:t(()=>[s(c(e.verbose_name),1)]),_:2},1024)),e.description.length!=0?(n(),o(a,{key:2,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(I,null,{default:t(()=>[l(R)]),_:1})]),_:1},8,["content"])):w("",!0)]),_:2},1024)]),default:t(()=>[V.value?(n(),o(K,{key:0,modelValue:u[e.name],"onUpdate:modelValue":m=>u[e.name]=m,step:1},null,8,["modelValue","onUpdate:modelValue"])):(n(),o(k,{key:1},{default:t(()=>[s(c(u[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])),["date"].indexOf(e.type)>>>-1?w("",!0):(n(),o(y,{key:7,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[l(r,{size:2},{default:t(()=>[l(k,{tag:"b"},{default:t(()=>[s(c(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(n(),o(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(I,null,{default:t(()=>[l(R)]),_:1})]),_:1},8,["content"])):w("",!0)]),_:2},1024)]),default:t(()=>[V.value?(n(),o(ee,{key:0,modelValue:u[e.name],"onUpdate:modelValue":m=>u[e.name]=m,type:"date",placeholder:"Pick a Date",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue","onUpdate:modelValue"])):(n(),o(k,{key:1},{default:t(()=>[s(c(u[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])),["datetime"].indexOf(e.type)>>>-1?w("",!0):(n(),o(y,{key:8,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[l(r,{size:2},{default:t(()=>[l(k,{tag:"b"},{default:t(()=>[s(c(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(n(),o(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(I,null,{default:t(()=>[l(R)]),_:1})]),_:1},8,["content"])):w("",!0)]),_:2},1024)]),default:t(()=>[V.value?(n(),o(ee,{key:0,modelValue:u[e.name],"onUpdate:modelValue":m=>u[e.name]=m,type:"datetime",placeholder:"Pick a Date",format:"YYYY/MM/DD hh:mm:ss","value-format":"YYYY-MM-DD hh:mm:ss"},null,8,["modelValue","onUpdate:modelValue"])):(n(),o(k,{key:1},{default:t(()=>[s(c(u[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])),["enum"].indexOf(e.type)>>>-1?w("",!0):(n(),o(y,{key:9,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[l(r,{size:2},{default:t(()=>[l(k,{tag:"b"},{default:t(()=>[s(c(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(n(),o(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(I,null,{default:t(()=>[l(R)]),_:1})]),_:1},8,["content"])):w("",!0)]),_:2},1024)]),default:t(()=>[V.value?(n(),o(O,{key:0,clearable:"",filterable:"",modelValue:u[e.name],"onUpdate:modelValue":m=>u[e.name]=m,placeholder:"请选择",style:{width:"240px"}},{default:t(()=>[(n(!0),h(j,null,E(ve.value[e.validation_rule],m=>(n(),o(z,{key:m.value,label:m.label,value:m.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):(n(),o(k,{key:1},{default:t(()=>{var m;return[s(c((m=b.value.fields[e.name])==null?void 0:m.label),1)]}),_:2},1024))]),_:2},1032,["label","prop","required"])),["model_ref"].indexOf(e.type)>>>-1?w("",!0):(n(),o(y,{key:10,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[l(r,{size:2},{default:t(()=>[l(k,{tag:"b"},{default:t(()=>[s(c(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(n(),o(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(I,null,{default:t(()=>[l(R)]),_:1})]),_:1},8,["content"])):w("",!0)]),_:2},1024)]),default:t(()=>{var m;return[V.value?(n(),o(Ve,{key:0,modelValue:u[e.name],"onUpdate:modelValue":te=>u[e.name]=te,clearable:"",placeholder:"请选择",style:{width:"240px"},filterable:"",options:be.value[(m=_e.value[e.name])==null?void 0:m.ref_model]},null,8,["modelValue","onUpdate:modelValue","options"])):(n(),o(k,{key:1},{default:t(()=>{var te;return[s(c((te=b.value.fields[e.name])==null?void 0:te.instance_name),1)]}),_:2},1024))]}),_:2},1032,["label","prop","required"]))]),_:2},1024))),128))]),_:2},1024)]),_:2},1032,["name"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["model"])]),_:1}),l(ie,{label:"监控信息",name:"monitor",disabled:""},{default:t(()=>[..._[11]||(_[11]=[s("111",-1)])]),_:1}),l(ie,{label:"关联关系",name:"relations"},{default:t(()=>[b.value&&b.value.id?(n(),o(st,{key:0,ref:"ciDataRelationRef",instanceId:b.value.id,modelId:b.value.model},null,8,["instanceId","modelId"])):w("",!0)]),_:1}),l(ie,{label:"变更记录",name:"changelog"},{default:t(()=>[b.value&&b.value.id?(n(),o(Ge,{key:0,ref_key:"ciDataAuditRef",ref:C,instanceId:b.value.id},null,8,["instanceId"])):w("",!0)]),_:1})]),_:1},8,["modelValue"])])])}}}),xt=Te(bt,[["__scopeId","data-v-59a6c629"]]);export{xt as default};
