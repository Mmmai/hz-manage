import{d as re,g as ue,u as de,r as a,h as pe,A as ce,a as ve,z as P,q as be,am as ge,e as o,ag as q,c as H,o as i,i as Z,aa as p,b as n,w as s,D as c,k as v,v as b,a7 as fe,a8 as me,j as ye,t as L,ad as _e,an as xe,al as F,s as I}from"./index-Gch8CQn_.js";const ke={class:"card"},we={class:"table-header"},$e={class:"header-button-lf"},Se={class:"header-button-ri"},Oe=re({__name:"ciSyncZabbixView",setup(Ce){const{proxy:x}=ue();de();const h=a([]),g=pe(),w=a("name"),$=a(""),S=a(!0),J=a([{value:"name",label:"唯一标识",sort:!0,filter:!0,type:"string",required:!0},{value:"ip",label:"主机ip",sort:!1,filter:!0,type:"string",required:!0}]),K=ce(()=>{let t=[];return J.value.forEach(e=>{e.filter&&t.push({name:e.label,value:e.value})}),t});a("");const N=ve({name:null,verbose_name:null,field_type:"string",type:"regex",rule:null,description:null});P(()=>N.field_type,t=>{N.type=W.value[t][0].type},{deep:!0});const C=a(1),j=a(10),R=a("default"),G=a(!1),A=a(0),E=()=>{r()},f=a({ordering:"-update_time"}),Q=t=>{f.value={ordering:"-update_time"},t.order==="ascending"?f.value.ordering=t.prop:t.order==="descending"?f.value.ordering="-"+t.prop:f.value={ordering:"-update_time"},r()};a(!1),a(!0),a({}),a({}),a([]);const W=a([]),r=async(t=null)=>{let e=await x.$api.getZabbixSync({page:C.value,page_size:j.value,...d.value,...f.value,...t});h.value=e.data.results,A.value=e.data.count,S.value=!1};be(()=>{r()});const z=a([]),X=t=>{z.value=t.map(e=>e.id)},T={0:{level:"info",label:"未知"},1:{level:"success",label:"可用"},2:{level:"danger",label:"不可用"}},d=a({});P($,t=>{d.value[w.value]=t});const Y=t=>{Object.keys(t)[0]==="agent_installed"?Object.values(t)[0].length>1?d.value[`${Object.keys(t)[0]}`]=null:d.value[Object.keys(t)[0]]=Object.values(t)[0][0]:(console.log(t),Object.values(t)[0].length>0?d.value[`${Object.keys(t)[0]}__in`]=Object.values(t)[0].join(","):d.value[Object.keys(t)[0]]=null),I(()=>{r()})},ee=async()=>{let t=await x.$api.updateZabbixAvailability();console.log(t)},te=async()=>{let t=await x.$api.syncZabbixHost();console.log(t),xe({title:"Success",message:"触发主机同步~",type:"success"})},O=a(null),U=t=>{O.value=new EventSource(t),O.value.onmessage=e=>{console.log(e),JSON.parse(e.data).status==="completed"&&(B(),I(()=>{r()}))}},B=()=>{O.value.close()},V=async t=>{let e=await x.$api.installAgent(t);console.log(e),e.status==200?(F({type:"success",message:"触发成功"}),S.value=!0,t.all?U("/api/v1/agent_status_sse/?all=true"):U(`/api/v1/agent_status_sse/?ids=${JSON.stringify(t.ids)}`)):F({type:"error",message:"触发失败"})};return ge(()=>{B()}),(t,e)=>{var M;const m=o("el-button"),k=o("el-tooltip"),le=o("el-option"),ae=o("el-select"),ne=o("el-input"),u=o("el-table-column"),D=o("el-tag"),se=o("el-table"),oe=o("el-pagination"),y=q("permission"),ie=q("loading");return i(),H("div",ke,[Z("div",we,[Z("div",$e,[n(k,{class:"box-item",effect:"dark",content:"触发主机信息同步到zabbix",placement:"top"},{default:s(()=>{var l;return[p((i(),c(m,{type:"primary",onClick:e[0]||(e[0]=_=>te())},{default:s(()=>e[12]||(e[12]=[v("触发同步")])),_:1})),[[y,`${(l=b(g).name)==null?void 0:l.replace("_info","")}:add`]])]}),_:1}),n(k,{class:"box-item",effect:"dark",content:"更新Zabbix接口可用性的状态信息",placement:"top"},{default:s(()=>{var l;return[p((i(),c(m,{type:"primary",onClick:e[1]||(e[1]=_=>ee())},{default:s(()=>e[13]||(e[13]=[v("可用性更新")])),_:1})),[[y,`${(l=b(g).name)==null?void 0:l.replace("_info","")}:add`]])]}),_:1}),n(k,{class:"box-item",effect:"dark",content:"触发重装已勾选的主机",placement:"top"},{default:s(()=>{var l;return[p((i(),c(m,{type:"primary",disabled:!(z.value.length>>>0),onClick:e[2]||(e[2]=_=>V({ids:z.value}))},{default:s(()=>e[14]||(e[14]=[v("批量安装")])),_:1},8,["disabled"])),[[y,`${(l=b(g).name)==null?void 0:l.replace("_info","")}:add`]])]}),_:1}),p((i(),c(m,{type:"primary",onClick:e[3]||(e[3]=l=>V({all:!0}))},{default:s(()=>e[15]||(e[15]=[v("触发失败重装")])),_:1})),[[y,`${(M=b(g).name)==null?void 0:M.replace("_info","")}:add`]])]),Z("div",Se,[n(ae,{modelValue:w.value,"onUpdate:modelValue":e[4]||(e[4]=l=>w.value=l),placeholder:"Select",style:{width:"120px"}},{default:s(()=>[(i(!0),H(fe,null,me(K.value,l=>(i(),c(le,{key:l.value,label:l.name,value:l.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),n(ne,{modelValue:$.value,"onUpdate:modelValue":e[5]||(e[5]=l=>$.value=l),style:{width:"240px"},placeholder:"回车查询",clearable:"",onClear:e[6]||(e[6]=l=>r()),onKeyup:e[7]||(e[7]=ye(l=>r(),["enter","native"]))},null,8,["modelValue"])])]),p((i(),c(se,{ref:"multipleTableRef",data:h.value,style:{width:"100%"},border:"","row-key":l=>l.id,onSortChange:Q,onSelectionChange:X,onFilterChange:Y},{default:s(()=>[n(u,{type:"selection","reserve-selection":!0,width:"55"}),n(u,{property:"name",label:"唯一标识",sortable:"custom"}),n(u,{property:"ip",label:"ip地址"}),n(u,{"column-key":"interface_available",property:"interface_available",label:"接口可用性",sortable:"custom",width:"140",filters:[{text:"未知",value:0},{text:"可用",value:1},{text:"不可用",value:2}]},{default:s(l=>[n(D,{type:T[l.row.interface_available].level},{default:s(()=>[v(L(T[l.row.interface_available].label),1)]),_:2},1032,["type"])]),_:1}),n(u,{"column-key":"agent_installed",property:"agent_installed",label:"agent状态",sortable:"custom",width:"140",filters:[{text:"已安装",value:!0},{text:"未安装",value:!1}]},{default:s(l=>[n(D,{type:l.row.agent_installed?"success":"danger",effect:"dark"},{default:s(()=>[v(L(l.row.agent_installed?"已安装":"未安装"),1)]),_:2},1032,["type"])]),_:1}),n(u,{property:"installation_error",label:"报错信息",width:"400"}),n(u,{fixed:"right",width:"80",label:"操作"},{default:s(l=>[n(k,{class:"box-item",effect:"dark",content:"触发安装",placement:"top"},{default:s(()=>{var _;return[p(n(m,{link:"",type:"primary",icon:b(_e),onClick:je=>V({ids:[l.row.id]})},null,8,["icon","onClick"]),[[y,`${(_=b(g).name)==null?void 0:_.replace("_info","")}:edit`]])]}),_:2},1024)]),_:1})]),_:1},8,["data","row-key"])),[[ie,S.value]]),n(oe,{"current-page":C.value,"onUpdate:currentPage":[e[8]||(e[8]=l=>C.value=l),e[10]||(e[10]=l=>E())],"page-size":j.value,"onUpdate:pageSize":[e[9]||(e[9]=l=>j.value=l),e[11]||(e[11]=l=>E())],"page-sizes":[10,20,50,100,200],size:R.value,disabled:G.value,layout:"total, sizes, prev, pager, next, jumper",total:A.value,style:{"margin-top":"5px","justify-content":"flex-end"}},null,8,["current-page","page-size","size","disabled","total"])])}}});export{Oe as default};
