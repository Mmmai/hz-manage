import{d as me,g as _e,y as fe,r as l,x as ve,v as ye,bP as ge,z as be,A as xe,h as d,bc as L,c as I,o as r,f as s,b as z,w as n,F as we,i as ke,B as u,bV as g,q as b,m,k as _,l as he,ca as Ce,t as S,cv as $e,cw as Ve,c8 as ze,b_ as v,aP as Z}from"./index-BSX4TNZE.js";const Se={class:"card",style:{display:"flex","flex-direction":"column"}},Te={class:"table-header"},Me={class:"header-button-lf"},Ne={class:"header-button-ri"},Ue={class:"card table-main",style:{width:"100%"}},Ze=me({name:"ciSyncZabbix",__name:"nodeManageView",setup(Be){const{proxy:y}=_e();fe();const i=l("hosts"),x=ve(),j=l([]),A=l(!0);l(""),l(!0),l(!1),l({}),l({});const T=l(1),M=l(10),O=l("default"),R=l(!1),D=l(0),N=l(""),X=l("model_instance_name"),G=l(""),w=l({}),J=l([{value:"model_instance_name",label:"唯一标识",sort:!0,filter:!0,type:"string",required:!0},{value:"ip_address",label:"ip地址",sort:!1,filter:!0,type:"string",required:!0}]),U=l([]);l([]),l([]);const q=l([]),Q=l(null);ye(()=>{let a=[];return J.value.forEach(e=>{e.filter&&a.push({name:e.label,value:e.value})}),a}),ge(G,a=>{w.value={[X.value]:a}});const W=async()=>{let a=await y.$api.getModelConfig({ordering:"create_time"});a.status==200&&(q.value=a.data.results.filter(e=>e.is_manage===!0).map(e=>({label:e.model_verbose_name||e.model_name,name:e.model_name})))},f=async()=>{let a=await y.$api.getNodes({model_name:i.value,page:T.value,page_size:M.value,search:N.value,...w.value,...$.value});j.value=a.data.results,D.value=a.data.count,A.value=!1},Y=async(a,e)=>{let p={};p[e]=a[e],(await y.$api.updateNodes({id:a.id,...p})).status==200?(v({type:"success",message:"更新成功"}),f()):v({type:"error",message:"更新失败"})},ee=async()=>{await y.$api.syncZabbixHost({model_name:i.value}),v({type:"success",message:"触发主机同步~"})},te=async a=>{await y.$api.syncZabbixHost({node_id:a.id}),v({type:"success",message:"触发主机同步~"})},E=async a=>{let e=await y.$api.installAgent(a);e.status==200?v({type:"success",message:"触发成功"}):v({type:"error",message:`触发失败:${e.data.message}`})},ae=async a=>{let e=await y.$api.get_inventory(a);e.status==200?v({type:"success",message:"触发成功"}):v({type:"error",message:`触发失败:${e.data.message}`})},le=(a,e)=>{Z(()=>{f()})},F=()=>{f()},$=l({ordering:"-model_instance_name"}),se=a=>{a.order==="ascending"?$.value.ordering=a.prop:a.order==="descending"?$.value.ordering="-"+a.prop:$.value={ordering:"-model_instance_name"},f()},B=a=>a===1?"success":a===0?"danger":"info",P=a=>a===1?"正常":a===0?"异常":"未知",ne=a=>{U.value=a.map(e=>e.id)},oe=a=>{const e=Object.keys(a)[0],p=Object.values(a)[0];p.length===1?w.value[e]=p[0]:p.length>1?w.value[`${e}`]=p.join(","):w.value[e]=null,Z(()=>{}),Z(()=>{f()})},re=()=>{var a;(a=Q.value)==null||a.close()};return be(()=>{f(),W()}),xe(()=>{re()}),(a,e)=>{const p=d("el-tab-pane"),H=d("el-tabs"),k=d("el-button"),h=d("el-tooltip"),ie=d("el-input"),c=d("el-table-column"),V=d("el-tag"),ue=d("el-switch"),ce=d("el-table"),de=d("el-pagination"),C=L("permission"),pe=L("loading");return r(),I("div",Se,[s(H,{modelValue:i.value,"onUpdate:modelValue":e[0]||(e[0]=t=>i.value=t),type:"card",class:"demo-tabs",onTabClick:le},{default:n(()=>[(r(!0),I(we,null,ke(q.value,(t,o)=>(r(),u(p,{label:t.label,name:t.name,key:o},null,8,["label","name"]))),128))]),_:1},8,["modelValue"]),z("div",Te,[z("div",Me,[s(h,{class:"box-item",effect:"dark",content:"触发主机信息同步到zabbix",placement:"top"},{default:n(()=>{var t;return[g((r(),u(k,{type:"primary",onClick:e[1]||(e[1]=o=>ee())},{default:n(()=>[...e[10]||(e[10]=[b("触发同步",-1)])]),_:1})),[[C,`${(t=m(x).name)==null?void 0:t.replace("_info","")}:add`]])]}),_:1}),s(h,{class:"box-item",effect:"dark",content:"触发重装已勾选的主机",placement:"top"},{default:n(()=>{var t;return[i.value==="hosts"?g((r(),u(k,{key:0,type:"primary",disabled:!(U.value.length>>>0),onClick:e[2]||(e[2]=o=>E({id:U.value}))},{default:n(()=>[...e[11]||(e[11]=[b("批量安装",-1)])]),_:1},8,["disabled"])),[[C,`${(t=m(x).name)==null?void 0:t.replace("_info","")}:add`]]):_("",!0)]}),_:1})]),z("div",Ne,[s(ie,{modelValue:N.value,"onUpdate:modelValue":e[3]||(e[3]=t=>N.value=t),style:{width:"240px"},placeholder:"回车查询",clearable:"","prefix-icon":m(Ce),onClear:e[4]||(e[4]=t=>f()),onKeyup:e[5]||(e[5]=he(t=>f(),["enter","native"]))},null,8,["modelValue","prefix-icon"])])]),z("div",Ue,[g((r(),u(ce,{ref:"multipleTableRef",data:j.value,style:{width:"100%"},height:"100%",border:"","row-key":t=>t.id,onSortChange:se,onSelectionChange:ne,onFilterChange:oe},{default:n(()=>[s(c,{type:"selection","reserve-selection":!0,width:"55"}),s(c,{property:"model_instance_name",label:"唯一标识",sortable:"custom"}),s(c,{property:"ip_address",sortable:"custom",label:"ip地址"}),s(c,{property:"proxy_name",label:"代理",sortable:"custom",width:"120"},{default:n(t=>[t.row.proxy_name?(r(),u(V,{key:0},{default:n(()=>[b(S(t.row.proxy_name),1)]),_:2},1024)):_("",!0)]),_:1}),i.value==="hosts"?(r(),u(c,{key:0,"column-key":"manage_status",property:"manage_status",label:"管理状态",sortable:"custom",width:"140",filters:[{text:"正常",value:1},{text:"异常",value:0},{text:"未知",value:2}]},{default:n(t=>[s(V,{type:B(t.row.manage_status),effect:"dark"},{default:n(()=>[b(S(P(t.row.manage_status)),1)]),_:2},1032,["type"])]),_:1})):_("",!0),s(c,{"column-key":"enable_sync",property:"enable_sync",label:"是否同步",sortable:"custom",width:"140",filters:[{text:"启用",value:!0},{text:"禁用",value:!1}]},{default:n(t=>[s(ue,{modelValue:t.row.enable_sync,"onUpdate:modelValue":o=>t.row.enable_sync=o,class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},onChange:o=>Y(t.row,"enable_sync")},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),i.value==="hosts"?(r(),u(c,{key:1,"column-key":"agent_status",property:"agent_status",label:"agent状态",sortable:"custom",width:"140",filters:[{text:"正常",value:1},{text:"异常",value:0},{text:"未知",value:2}]},{default:n(t=>[s(V,{type:B(t.row.agent_status),effect:"dark"},{default:n(()=>[b(S(P(t.row.agent_status)),1)]),_:2},1032,["type"])]),_:1})):_("",!0),i.value==="hosts"?(r(),u(c,{key:2,"column-key":"zbx_status",property:"zbx_status",label:"ZBX状态",sortable:"custom",width:"140",filters:[{text:"正常",value:1},{text:"异常",value:0},{text:"未知",value:2}]},{default:n(t=>[s(V,{type:B(t.row.zbx_status),effect:"dark"},{default:n(()=>[b(S(P(t.row.zbx_status)),1)]),_:2},1032,["type"])]),_:1})):_("",!0),i.value==="hosts"?(r(),u(c,{key:3,property:"manage_error_message",label:"管理错误信息",width:"500"})):_("",!0),i.value==="hosts"?(r(),u(c,{key:4,property:"agent_error_message",label:"agent错误信息",width:"500"})):_("",!0),s(c,{fixed:"right",width:"120",label:"操作"},{default:n(t=>[s(h,{class:"box-item",effect:"dark",content:"触发同步",placement:"top"},{default:n(()=>{var o;return[g(s(k,{link:"",type:"primary",icon:m($e),onClick:K=>te({id:t.row.id})},null,8,["icon","onClick"]),[[C,`${(o=m(x).name)==null?void 0:o.replace("_info","")}:edit`]])]}),_:2},1024),i.value==="hosts"?(r(),u(h,{key:0,class:"box-item",effect:"dark",content:"管理状态更新",placement:"top"},{default:n(()=>{var o;return[g(s(k,{link:"",type:"primary",icon:m(Ve),onClick:K=>ae({id:t.row.id})},null,8,["icon","onClick"]),[[C,`${(o=m(x).name)==null?void 0:o.replace("_info","")}:edit`]])]}),_:2},1024)):_("",!0),i.value==="hosts"?(r(),u(h,{key:1,class:"box-item",effect:"dark",content:"触发agent安装",placement:"top"},{default:n(()=>{var o;return[g(s(k,{link:"",type:"primary",icon:m(ze),onClick:K=>E({id:t.row.id})},null,8,["icon","onClick"]),[[C,`${(o=m(x).name)==null?void 0:o.replace("_info","")}:edit`]])]}),_:2},1024)):_("",!0)]),_:1})]),_:1},8,["data","row-key"])),[[pe,A.value]]),s(de,{"current-page":T.value,"onUpdate:currentPage":[e[6]||(e[6]=t=>T.value=t),e[8]||(e[8]=t=>F())],"page-size":M.value,"onUpdate:pageSize":[e[7]||(e[7]=t=>M.value=t),e[9]||(e[9]=t=>F())],"page-sizes":[10,20,50,100,200],size:O.value,disabled:R.value,layout:"total, sizes, prev, pager, next, jumper",total:D.value,style:{"margin-top":"5px","justify-content":"flex-end"}},null,8,["current-page","page-size","size","disabled","total"])])])}}});export{Ze as default};
