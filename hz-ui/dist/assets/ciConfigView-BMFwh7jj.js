import{d as Ne,g as Je,u as qe,r as s,h as Me,l as R,a as Te,bK as le,m as Be,e as d,b7 as De,c as f,o as n,i as O,b as o,bQ as te,y as U,q as p,w as r,k as K,F as q,p as M,j as Ae,c6 as Ee,c7 as Pe,z as T,c8 as Ke,c9 as Le,aK as ce,c3 as y,bY as We}from"./index-BuQNgUX_.js";const Qe={class:"card"},Ye={class:"table-header"},Ge={class:"header-button-lf"},He={class:"header-button-ri"},Xe={key:0},Ze={key:0},Ie={key:4},el={style:{display:"flex","align-items":"center"}},ll={key:0,class:"el-form-item__error"},tl={key:0},al={key:1},ol={key:0,class:"flexJstart",style:{"margin-top":"10px"}},nl={class:"dialog-footer"},rl=Ne({name:"ciConfig",__name:"ciConfigView",setup(ul){const{proxy:x}=Je(),L=qe(),ae=s([]),W=Me(),Q=s("verbose_name"),Y=s(""),ve=R(()=>({[Q.value]:Y.value})),B=s(null),fe=R(()=>{if(B.value===null)return!0;var l=RegExp(a.rule);return!!l.test(B.value)}),c=s(),v=s(),ye=R(()=>a.type!=="length"&&a.type!=="range"?!0:c.value===null||c.value===void 0||v.value===null||v.value===void 0?!1:c.value<v.value);le([c,v],([l,e])=>{(a.type==="length"||a.type==="range")&&l!=null&&e!==null&&e!==void 0&&l<=e&&(a.rule=`${l},${e}`)},{deep:!0});const h=s([{name:"",value:""}]),D=R(()=>{let l={};return h.value.forEach(e=>{e.name!==""&&e.value!==""&&(l[e.name]=e.value)}),l}),oe=R(()=>x.$commonFunc.hasDuplicates(Object.keys(D.value))||x.$commonFunc.hasDuplicates(Object.values(D.value)));le(()=>D.value,l=>{Object.keys(l).length!==0&&(a.rule=JSON.stringify(D.value))});const me=l=>{h.value.splice(l+1,0,{name:"",value:""})},ge=l=>{h.value.splice(l,1),console.log(h.value)},ne=s([{value:"name",label:"规则名",sort:!0,filter:!0,type:"string",required:!0},{value:"verbose_name",label:"规则名称",sort:!1,filter:!0,type:"string",required:!0},{value:"field_type",label:"字段类型",sort:!0,filter:!0,type:"object",required:!0},{value:"type",label:"规则类型",sort:!0,filter:!0,type:"object"}]),_e=R(()=>{let l=[];return ne.value.forEach(e=>{e.filter&&l.push({name:e.label,value:e.value})}),l}),A=s(""),a=Te({name:null,verbose_name:null,field_type:"string",type:"regex",rule:null,description:null});le(()=>a.field_type,l=>{a.type=Z.value[l][0].type},{deep:!0});const G=s(1),H=s(10),be=s("default"),Ve=s(!1),ue=s(0),ke=()=>{V()},he=()=>{V()},z=s({ordering:"-update_time"}),xe=l=>{z.value={ordering:"-update_time"},l.order==="ascending"?z.value.ordering=l.prop:l.order==="descending"?z.value.ordering="-"+l.prop:z.value={ordering:"-update_time"},V()},_=s(!1),se=()=>{_.value=!1,j(A.value),w.value={}},S=s(!0),we=()=>{S.value=!0,ce(()=>{_.value=!0})},w=s({}),X=s({}),Ce=l=>{w.value=l,_.value=!0,S.value=!1,ce(()=>{if(Object.keys(l).forEach(e=>{e!=="id"&&(a[e]=l[e])}),l.field_type==="enum"){let e=[];Object.keys(JSON.parse(l.rule)).forEach(i=>{e.push({name:i,value:JSON.parse(l.rule)[i]})}),h.value=e}else if((l.type==="length"||l.type==="range")&&l.rule)try{const e=l.rule.split(",");c.value=e[0]!==void 0?+e[0]:null,v.value=e[1]!==void 0?+e[1]:null}catch(e){console.warn("解析范围值失败:",e)}X.value=JSON.parse(JSON.stringify(a))})},j=l=>{l&&(l.resetFields(),h.value=[{name:"",value:""}],c.value=null,v.value=null)},re=s([]),Z=s([]),V=async(l=null)=>{let e=await x.$api.getValidationRules({page:G.value,page_size:H.value,...ve.value,...z.value,...l});ae.value=e.data.results,ue.value=e.data.count},Oe=async()=>{let l=await x.$api.getCiModelFieldType();Z.value=l.data.field_validations;let e=l.data.field_types;re.value=Object.keys(e).filter(i=>i!=="password"&&i!=="model_ref").map(i=>({value:i,label:e[i]}))},E=s({}),Ue=async l=>{await l.validate(async(e,i)=>{if(e){if(a.type==="length"||a.type==="range"){if(c.value===null||c.value===void 0){y({type:"error",message:"请填写最小值"});return}if(v.value===null||v.value===void 0){y({type:"error",message:"请填写最大值"});return}if(c.value>v.value){y({type:"error",message:"最小值不能大于最大值"});return}}if(console.log(oe.value),oe.value){y({type:"error",message:"有重复值！"});return}if(S.value){let b=await x.$api.addValidationRules({create_user:L.state.username,update_user:L.state.username,...a});b.status=="201"?(y({type:"success",message:"添加成功"}),_.value=!1,j(l),await V()):y({showClose:!0,message:"添加失败:"+JSON.stringify(b.data),type:"error"})}else{if(JSON.stringify(X.value)===JSON.stringify(a)){_.value=!1,j(l),y({showClose:!0,message:"无更新,关闭窗口",type:"info"});return}else{const $=Object.entries(X.value),m=Object.entries(a),k=$.concat(m).map(g=>JSON.stringify(g)),F=Array.from(new Set(k)).map(g=>JSON.parse(g));F.splice(0,$.length);const N=Object.fromEntries(F);let P={};if(Object.keys(N).forEach(g=>{N[g]!=""&&(P[g]=N[g])}),E.value=P,Object.keys(E.value).length===0){_.value=!1,j(l),y({showClose:!0,message:"无更新,关闭窗口",type:"info"});return}}console.log(E.value),console.log(a);let b=await x.$api.updateValidationRules({id:w.value.id,update_user:L.state.username,...E.value});console.log(b),b.status=="200"?(y({type:"success",message:"更新成功"}),_.value=!1,j(l),V()):y({showClose:!0,message:"更新失败:"+JSON.stringify(b.data),type:"error"})}}})},Se=l=>{We.confirm("是否确认删除?","删除",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await x.$api.deleteValidationRules(l)).status==204?(y({type:"success",message:"删除成功"}),await V(),j(A.value),_.value=!1):y({type:"error",message:"删除失败"})}).catch(()=>{y({type:"info",message:"取消删除"})})};return Be(()=>{V(),Oe()}),(l,e)=>{var pe;const i=d("el-button"),b=d("el-option"),$=d("el-select"),m=d("el-input"),k=d("el-table-column"),F=d("el-tooltip"),N=d("el-table"),P=d("el-pagination"),g=d("el-form-item"),ie=d("el-input-number"),je=d("el-text"),$e=d("SuccessFilled"),de=d("el-icon"),Re=d("WarningFilled"),ze=d("el-form"),Fe=d("el-dialog"),I=De("permission");return n(),f("div",Qe,[O("div",Ye,[O("div",Ge,[te((n(),p(i,{type:"primary",onClick:we},{default:r(()=>[...e[15]||(e[15]=[K("添加",-1)])]),_:1})),[[I,`${(pe=U(W).name)==null?void 0:pe.replace("_info","")}:add`]])]),O("div",He,[o($,{modelValue:Q.value,"onUpdate:modelValue":e[0]||(e[0]=t=>Q.value=t),placeholder:"Select",style:{width:"120px"}},{default:r(()=>[(n(!0),f(q,null,M(_e.value,t=>(n(),p(b,{key:t.value,label:t.name,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),o(m,{modelValue:Y.value,"onUpdate:modelValue":e[1]||(e[1]=t=>Y.value=t),style:{width:"240px"},placeholder:"回车查询",clearable:"",onClear:e[2]||(e[2]=t=>V()),onKeyup:e[3]||(e[3]=Ae(t=>V(),["enter","native"]))},null,8,["modelValue"])])]),o(N,{ref:"multipleTableRef",data:ae.value,style:{width:"100%"},border:"",onSortChange:xe},{default:r(()=>[o(k,{property:"name",label:"规则名",sortable:"custom"}),o(k,{property:"verbose_name",label:"规则名称"}),o(k,{property:"field_type",label:"字段类型",sortable:"custom"}),o(k,{property:"type",label:"规则类型",sortable:"custom"}),o(k,{property:"rule",label:"规则内容","show-overflow-tooltip":""}),o(k,{property:"description",label:"描述"}),o(k,{fixed:"right",width:"100",label:"操作"},{default:r(t=>[o(F,{class:"box-item",effect:"dark",content:"编辑",placement:"top"},{default:r(()=>{var C;return[te(o(i,{link:"",type:"primary",icon:U(Ee),onClick:u=>Ce(t.row)},null,8,["icon","onClick"]),[[I,`${(C=U(W).name)==null?void 0:C.replace("_info","")}:edit`]])]}),_:2},1024),o(F,{class:"box-item",effect:"dark",content:"删除",placement:"top"},{default:r(()=>{var C;return[te(o(i,{link:"",type:"danger",icon:U(Pe),disabled:t.row.built_in,onClick:u=>Se(t.row.id)},null,8,["icon","disabled","onClick"]),[[I,`${(C=U(W).name)==null?void 0:C.replace("_info","")}:delete`]])]}),_:2},1024)]),_:1})]),_:1},8,["data"]),o(P,{"current-page":G.value,"onUpdate:currentPage":e[4]||(e[4]=t=>G.value=t),"page-size":H.value,"onUpdate:pageSize":e[5]||(e[5]=t=>H.value=t),"page-sizes":[10,20,50,100,200],size:be.value,disabled:Ve.value,layout:"total, sizes, prev, pager, next, jumper",total:ue.value,onSizeChange:ke,onCurrentChange:he,style:{"margin-top":"5px","justify-content":"flex-end"}},null,8,["current-page","page-size","size","disabled","total"]),o(Fe,{modelValue:_.value,"onUpdate:modelValue":e[14]||(e[14]=t=>_.value=t),title:"规则配置",width:"500","before-close":se},{footer:r(()=>[O("div",nl,[o(i,{onClick:se},{default:r(()=>[...e[18]||(e[18]=[K("取消",-1)])]),_:1}),o(i,{type:"primary",onClick:e[13]||(e[13]=t=>Ue(A.value))},{default:r(()=>[...e[19]||(e[19]=[K(" 提交 ",-1)])]),_:1})])]),default:r(()=>[o(ze,{inline:!0,"label-position":"right",model:a,"label-width":"auto",ref_key:"formRef",ref:A},{default:r(()=>[(n(!0),f(q,null,M(ne.value,(t,C)=>(n(),p(g,{label:t.label,key:C,required:t.required,prop:t.value},{default:r(()=>[t.value==="rule"?(n(),f("div",Xe,[a.field_type==="enum"?(n(),f("div",Ze,[(n(!0),f(q,null,M(h.value,(u,ee)=>(n(),f("div",{key:ee},[O("li",null,[o(m,{modelValue:u.name,"onUpdate:modelValue":J=>u.name=J,style:{width:"90px","margin-right":"10px"}},null,8,["modelValue","onUpdate:modelValue"]),o(m,{modelValue:u.value,"onUpdate:modelValue":J=>u.value=J,style:{width:"160px","margin-right":"10px"}},null,8,["modelValue","onUpdate:modelValue"]),h.value.length!==1?(n(),p(i,{key:0,circle:"",type:"danger",size:"small",icon:U(Ke),onClick:J=>ge(ee)},null,8,["icon","onClick"])):T("",!0),o(i,{circle:"",type:"primary",size:"small",icon:U(Le),onClick:J=>me(ee)},null,8,["icon","onClick"])])]))),128))])):(n(),p(m,{key:1,modelValue:a[t.value],"onUpdate:modelValue":u=>a[t.value]=u,type:"textarea",clearable:"",style:{width:"300px"},disabled:w.value.built_in},null,8,["modelValue","onUpdate:modelValue","disabled"]))])):t.value==="description"?(n(),p(m,{key:1,modelValue:a[t.value],"onUpdate:modelValue":u=>a[t.value]=u,type:"textarea",clearable:"",style:{width:"300px"}},null,8,["modelValue","onUpdate:modelValue"])):t.value==="name"?(n(),p(m,{key:2,modelValue:a[t.value],"onUpdate:modelValue":u=>a[t.value]=u,clearable:"",disabled:!!(w.value.built_in||!S.value)},null,8,["modelValue","onUpdate:modelValue","disabled"])):t.value==="verbose_name"?(n(),p(m,{key:3,modelValue:a[t.value],"onUpdate:modelValue":u=>a[t.value]=u,clearable:""},null,8,["modelValue","onUpdate:modelValue"])):(n(),f("div",Ie,[t.value==="field_type"?(n(),p($,{key:0,modelValue:a.field_type,"onUpdate:modelValue":e[6]||(e[6]=u=>a.field_type=u),placeholder:"Select",style:{width:"120px"},disabled:!!(w.value.built_in||!S.value)},{default:r(()=>[(n(!0),f(q,null,M(re.value,u=>(n(),p(b,{key:u.value,label:u.label,value:u.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])):(n(),p($,{key:1,modelValue:a.type,"onUpdate:modelValue":e[7]||(e[7]=u=>a.type=u),placeholder:"Select",style:{width:"120px"},disabled:!!(w.value.built_in||!S.value)},{default:r(()=>[(n(!0),f(q,null,M(Z.value[a.field_type],u=>(n(),p(b,{key:u.type,label:u.description,value:u.type},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]))]))]),_:2},1032,["label","required","prop"]))),128)),a.type==="length"||a.type==="range"?(n(),p(g,{key:0,label:"数组范围",props:"description"},{default:r(()=>[O("div",el,[o(ie,{modelValue:c.value,"onUpdate:modelValue":e[8]||(e[8]=t=>c.value=t),placeholder:"最小值","controls-position":"right",style:{width:"120px","margin-right":"10px"},precision:a.field_type==="float"?2:0,step:a.field_type==="float"?.1:1},null,8,["modelValue","precision","step"]),e[16]||(e[16]=O("span",{style:{"margin-right":"10px"}},"-",-1)),o(ie,{modelValue:v.value,"onUpdate:modelValue":e[9]||(e[9]=t=>v.value=t),placeholder:"最大值","controls-position":"right",style:{width:"120px"},precision:a.field_type==="float"?2:0,step:a.field_type==="float"?.1:1},null,8,["modelValue","precision","step"])]),ye.value?T("",!0):(n(),f("div",ll,[c.value===null||c.value===void 0||v.value===null||v.value===void 0?(n(),f("span",tl," 请输入完整的范围值 ")):c.value>v.value?(n(),f("span",al," 最小值不能大于最大值 ")):T("",!0)]))]),_:1})):a.type==="regex"?(n(),p(g,{key:1,label:"规则内容",props:"rule",required:!0},{default:r(()=>[o(m,{modelValue:a.rule,"onUpdate:modelValue":e[10]||(e[10]=t=>a.rule=t),type:"textarea",clearable:"",style:{width:"300px"}},null,8,["modelValue"]),a.type==="regex"?(n(),f("div",ol,[o(je,null,{default:r(()=>[...e[17]||(e[17]=[K("测试正则",-1)])]),_:1}),o(m,{modelValue:B.value,"onUpdate:modelValue":e[11]||(e[11]=t=>B.value=t),clearable:"",style:{width:"200px",margin:"0 10px"}},null,8,["modelValue"]),fe.value?(n(),p(de,{key:0,style:{color:"var(--el-color-success)"},size:20},{default:r(()=>[o($e)]),_:1})):(n(),p(de,{key:1,style:{color:"var(--el-color-danger)"},size:20},{default:r(()=>[o(Re)]),_:1}))])):T("",!0)]),_:1})):T("",!0),o(g,{label:"描述",props:"description"},{default:r(()=>[o(m,{modelValue:a.description,"onUpdate:modelValue":e[12]||(e[12]=t=>a.description=t),type:"textarea",clearable:"",style:{width:"300px"}},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}});export{rl as default};
