import{d as Fe,h as De,g as Be,a as T,r as n,m as Ne,bK as Oe,e as d,b7 as ae,c as z,o as u,i as h,b as t,bQ as k,y as b,q as v,w as s,k as y,F as U,p as F,a5 as Je,t as te,c6 as Te,c7 as je,bY as P,c3 as g,aK as qe,_ as Ee}from"./index-DD1IBG_Z.js";const Le={class:"card"},Ie={class:"user-header"},Me={class:"flexJstart gap-5"},Pe={class:"flexJstart gap-5"},Re={class:"demo-pagination-block"},Ge=Fe({name:"user",__name:"userView",setup(Ae){const V=De(),{proxy:i}=Be(),D=T({search:""}),j=n(!1),R=n([]),se=n("auto"),oe=n([{prop:"username",label:"用户名称"},{prop:"real_name",label:"真实姓名"},{prop:"status",label:"状态"},{prop:"groups",label:"用户组列表"},{prop:"roles",label:"角色列表"}]),ne=T({password:[{required:!0,message:"请输入密码",trigger:"blur"},{min:5,message:"密码长度不能低于5",trigger:"blur"}]}),q=n(1),E=n(10),re=n(!1),ue=n(!1),de=n(!1),G=n(0),p=T({page:q.value,size:E.value,search:"",ordering:"id"}),ie=n(!1),C=n([]),pe=n({});Ne(()=>{ce(p),me(),_(p)});const ce=async a=>{let e=await i.$api.getRole(a);C.value=e.data.results,console.log(C.value);for(let r in C.value){let $=C.value[r].role,c=C.value[r].id;pe.value[c]=$}},L=n([]),me=async()=>{let a=await i.$api.getUserGroup();L.value=a.data.results,console.log(L.value)},_=async a=>{j.value=!0;let e=await i.$api.user(a);R.value=e.data.results,G.value=e.data.count,j.value=!1},fe=a=>{console.log(`${a} items per page`),p.size=a,_(p)},ge=a=>{p.page=a,console.log(a),_(p)},w=n(!1),o=T({username:"",real_name:null,password:"",status:!0,role_ids:[],group_ids:[]}),B=n("add"),_e=()=>{B.value="add",w.value=!0},ve=()=>{w.value=!1,i.$refs.userFrom.resetFields()},be=a=>{P.confirm("是否确认关闭?").then(()=>{a(),i.$refs.userFrom.resetFields()}).catch(()=>{})},ye=()=>{i.$refs.userFrom.validate(async a=>{if(a)if(B.value=="add"){let e=await i.$api.useradd(o);console.log(e),e.status==201?(w.value=!1,i.$refs.userFrom.resetFields(),_(p)):g({showClose:!0,message:"添加失败:"+JSON.stringify(e.data),type:"error"})}else{console.log(JSON.stringify(o));let e=await i.$api.userupdate({id:A.value.id,...o});console.log(e),e.status==200?(w.value=!1,i.$refs.userFrom.resetFields(),_(p)):(console.log(),g({showClose:!0,message:"更新失败:"+JSON.stringify(e.data),type:"error"}))}else g({showClose:!0,message:"请输入正确内容.",type:"error"});console.log(o)})},we=async a=>{let e=await i.$api.userupdate({status:a.status,id:a.id});e.status==200?(g({type:"success",message:"更新成功"}),_(p)):g({showClose:!0,message:"更新失败:"+JSON.stringify(e.data),type:"error"})},A=n({}),he=a=>{B.value="edit",w.value=!0,A.value=a,qe(()=>{Object.keys(o).forEach(e=>{["group_ids"].includes(e)?o[e]=a.groups.map(r=>r.id):["role_ids"].includes(e)?o[e]=a.roles.map(r=>r.id):o[e]=a[e]})}),console.log(o)},ke=a=>{P.confirm("是否确认删除?","Warning",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await i.$api.userdel(a.id)).status==204?g({type:"success",message:"删除成功"}):g({type:"error",message:"删除失败"}),_(p)}).catch(()=>{g({type:"info",message:"Delete canceled"})})},N=n([]),Ve=(a,e)=>a.username!="admin",Ce=a=>{N.value=a},K=()=>{P.confirm("是否确认删除?","Warning",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{let a=[];for(let r in N.value)a.push(N.value[r].id);console.log(a),(await i.$api.usermuldel({pks:a})).status==204?g({type:"success",message:"删除成功"}):g({type:"error",message:"删除失败"}),_(p)}).catch(()=>{g({type:"info",message:"Delete canceled"})})},xe=async()=>{p.search=D.search,_(p)},x=n(!1);return Oe(()=>o.username,a=>{a=="admin"?x.value=!0:x.value=!1}),(a,e)=>{var Z,ee,le;const r=d("el-button"),$=d("el-input"),c=d("el-form-item"),W=d("el-form"),I=d("el-table-column"),Y=d("el-switch"),Q=d("el-tag"),$e=d("el-table"),Se=d("el-pagination"),O=d("el-col"),M=d("el-row"),H=d("el-option"),X=d("el-select"),ze=d("el-dialog"),S=ae("permission"),Ue=ae("loading");return u(),z(U,null,[h("div",Le,[h("div",Ie,[h("div",null,[k((u(),v(r,{type:"primary",size:"small",onClick:_e},{default:s(()=>[...e[10]||(e[10]=[y("新增",-1)])]),_:1})),[[S,`${(Z=b(V).name)==null?void 0:Z.replace("_info","")}:add`]]),N.value.length==0?k((u(),v(r,{key:0,disabled:"",type:"danger",size:"small",onClick:K},{default:s(()=>[...e[11]||(e[11]=[y("批量删除",-1)])]),_:1})),[[S,`${(ee=b(V).name)==null?void 0:ee.replace("_info","")}:delete`]]):k((u(),v(r,{key:1,type:"danger",size:"small",onClick:K},{default:s(()=>[...e[12]||(e[12]=[y("批量删除",-1)])]),_:1})),[[S,`${(le=b(V).name)==null?void 0:le.replace("_info","")}:delete`]])]),t(W,{inline:!0,model:D,size:"small",class:"demo-form-inline"},{default:s(()=>[t(c,{label:"用户名检索"},{default:s(()=>[t($,{modelValue:D.search,"onUpdate:modelValue":e[0]||(e[0]=l=>D.search=l),placeholder:"请输入用户名",clearable:""},null,8,["modelValue"])]),_:1}),t(c,null,{default:s(()=>[t(r,{type:"primary",size:"small",onClick:xe},{default:s(()=>[...e[13]||(e[13]=[y("查询",-1)])]),_:1})]),_:1})]),_:1},8,["model"])]),h("div",null,[k((u(),v($e,{border:"",data:R.value,style:{width:"100%"},"max-height":"500px","table-layout":se.value,onSelectionChange:Ce},{default:s(()=>[t(I,{type:"selection",width:"50",selectable:Ve}),(u(!0),z(U,null,F(oe.value,l=>(u(),v(I,{key:l.prop,label:l.label,prop:l.prop},Je({_:2},[l.prop==="status"?{name:"default",fn:s(m=>{var f;return[k(t(Y,{modelValue:m.row.status,"onUpdate:modelValue":J=>m.row.status=J,disabled:m.row.username=="admin",class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},onChange:J=>we(m.row)},null,8,["modelValue","onUpdate:modelValue","disabled","onChange"]),[[S,{id:`${(f=b(V).name)==null?void 0:f.replace("_info","")}:edit`,action:"disabled"}]])]}),key:"0"}:void 0,l.prop==="groups"?{name:"default",fn:s(m=>[h("div",Me,[(u(!0),z(U,null,F(m.row.groups,f=>(u(),v(Q,{key:f},{default:s(()=>[y(te(f.group_name),1)]),_:2},1024))),128))])]),key:"1"}:void 0,l.prop==="roles"?{name:"default",fn:s(m=>[h("div",Pe,[(u(!0),z(U,null,F(m.row.roles,f=>(u(),v(Q,{key:f},{default:s(()=>[y(te(f.role),1)]),_:2},1024))),128))])]),key:"2"}:void 0]),1032,["label","prop"]))),128)),t(I,{fixed:"right",label:"操作",width:"150"},{default:s(l=>{var m,f;return[k(t(r,{link:"",type:"primary",icon:b(Te),onClick:J=>he(l.row)},null,8,["icon","onClick"]),[[S,`${(m=b(V).name)==null?void 0:m.replace("_info","")}:edit`]]),k(t(r,{disabled:l.row.username=="admin",link:"",type:"danger",icon:b(je),onClick:J=>ke(l.row)},null,8,["disabled","icon","onClick"]),[[S,`${(f=b(V).name)==null?void 0:f.replace("_info","")}:delete`]])]}),_:1})]),_:1},8,["data","table-layout"])),[[Ue,j.value]])]),h("div",Re,[t(Se,{"current-page":q.value,"onUpdate:currentPage":e[1]||(e[1]=l=>q.value=l),"page-size":E.value,"onUpdate:pageSize":e[2]||(e[2]=l=>E.value=l),"page-sizes":[10,20,30,40],small:re.value,disabled:de.value,background:ue.value,layout:"total, sizes, prev, pager, next, jumper",total:G.value,"hide-on-single-page":ie.value,onSizeChange:fe,onCurrentChange:ge},null,8,["current-page","page-size","small","disabled","background","total","hide-on-single-page"])])]),t(ze,{modelValue:w.value,"onUpdate:modelValue":e[9]||(e[9]=l=>w.value=l),title:B.value=="add"?"新增用户":"编辑用户",width:"40%","before-close":be},{default:s(()=>[t(W,{inline:!0,model:o,class:"demo-form-inline",ref:"userFrom","label-position":"right","label-width":"auto","status-icon":"",rules:ne},{default:s(()=>[t(M,null,{default:s(()=>[t(O,{span:12},{default:s(()=>[t(c,{label:"用户名称",prop:"username",rules:[{required:!0}]},{default:s(()=>[t($,{modelValue:o.username,"onUpdate:modelValue":e[3]||(e[3]=l=>o.username=l),placeholder:"",clearable:"",disabled:x.value},null,8,["modelValue","disabled"])]),_:1})]),_:1}),t(O,{span:12},{default:s(()=>[t(c,{label:"真实名称",prop:"real_name"},{default:s(()=>[t($,{modelValue:o.real_name,"onUpdate:modelValue":e[4]||(e[4]=l=>o.real_name=l),placeholder:"",clearable:""},null,8,["modelValue"])]),_:1})]),_:1})]),_:1}),t(M,null,{default:s(()=>[t(O,{span:12},{default:s(()=>[t(c,{label:"用户组",prop:"group_ids",required:""},{default:s(()=>[t(X,{modelValue:o.group_ids,"onUpdate:modelValue":e[5]||(e[5]=l=>o.group_ids=l),placeholder:"",clearable:"",multiple:"","collapse-tags":"","collapse-tags-tooltip":"","max-collapse-tags":3,disabled:x.value,style:{width:"220px"}},{default:s(()=>[(u(!0),z(U,null,F(L.value,l=>(u(),v(H,{key:l.id,label:l.group_name,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1}),t(O,{span:12},{default:s(()=>[t(c,{label:"角色",prop:"role_ids"},{default:s(()=>[t(X,{modelValue:o.role_ids,"onUpdate:modelValue":e[6]||(e[6]=l=>o.role_ids=l),placeholder:"",clearable:"",multiple:"","collapse-tags":"","collapse-tags-tooltip":"","max-collapse-tags":3,disabled:x.value,style:{width:"220px"}},{default:s(()=>[(u(!0),z(U,null,F(C.value,l=>(u(),v(H,{key:l.id,label:l.role,value:l.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}),t(c,{label:"Password",prop:"password",required:""},{default:s(()=>[t($,{modelValue:o.password,"onUpdate:modelValue":e[7]||(e[7]=l=>o.password=l),type:"password",autocomplete:"off","show-password":""},null,8,["modelValue"])]),_:1}),t(c,{label:"状态",prop:"status"},{default:s(()=>[t(Y,{modelValue:o.status,"onUpdate:modelValue":e[8]||(e[8]=l=>o.status=l),class:"ml-2","inline-prompt":"",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},"active-text":"Y","inactive-text":"N",disabled:x.value},null,8,["modelValue","disabled"])]),_:1}),t(M,{style:{"justify-content":"flex-end"}},{default:s(()=>[t(c,null,{default:s(()=>[t(r,{onClick:ve},{default:s(()=>[...e[14]||(e[14]=[y("取消",-1)])]),_:1}),t(r,{type:"primary",onClick:ye},{default:s(()=>[...e[15]||(e[15]=[y(" 确定",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"])],64)}}}),We=Ee(Ge,[["__scopeId","data-v-fb049d53"]]);export{We as default};
