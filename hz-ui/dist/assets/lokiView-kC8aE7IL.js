import{d as Ve,c as W,r as d,bI as P,cj as Le,aN as ke,e as p,o as c,f as w,h as m,g as t,w as a,F as x,b1 as V,O as v,t as S,bo as U,b_ as Ce,P as Y,c0 as Te,j as b,ck as Se,k as Ue,c1 as Q,_ as Ne}from"./index-PyXmV4Ip.js";import{n as Fe}from"./nearLogCom-B6FWm7Dw.js";const $e={style:{display:"flex","flex-direction":"column","justify-content":"space-between",width:"100%",gap:"10px"}},Re={class:"card",style:{flex:"0.3"}},Me={style:{float:"left"}},Ee={style:{float:"right",color:"var(--el-text-color-secondary)","font-size":"13px"}},Oe={style:{float:"left"}},je={style:{float:"right",color:"var(--el-text-color-secondary)","font-size":"13px"}},Ae={class:"card"},Ke={style:{display:"flex","justify-content":"space-between","align-items":"center"}},ze=["innerHTML"],Be={class:"operation_show"},He=Ve({__name:"lokiView",setup(Ge){const{proxy:g}=Ue(),n=W({0:{labelName:"",matchMethod:"=",labelValue:"",isMultiple:!1,labelValueList:[],initLabelValueList:[]}}),u=W({dataSourceUrl:"",labelFilters:{},matchKey:"",matchKeyMethod:"|=",limit:200,dateValue:[]}),M=d([]),J=[{value:"=",label:"=",text:"等于"},{value:"=~",label:"=~",text:"包含(支持多个)"},{value:"!=",label:"!=",text:"不等于"},{value:"!~",label:"!~",text:"不包含(支持多个)"}],X=[{value:"|=",label:"=",text:"包含"},{value:"|~",label:"~",text:"正则匹配"},{value:"!=",label:"!=",text:"不包含"},{value:"!~",label:"!~",text:"反向正则"}],N=d({}),E=d(!1),O=d([]),k=d(!1),F=d([]),Z=async()=>{k.value=!0,g.$refs.formRef.validate(async l=>{if(console.log(l),l){console.log(u);let e=await g.$api.lokiQuery(u);console.log(e.data),N.value=e.data,O.value=e.data.queryResult,e.data.queryLogLevel.length>=1&&e.data.queryLogLevel.forEach(r=>{F.value.push({text:r,value:r})}),console.log(F.value),O.value.length>>>1?E.value=!0:Q({showClose:!0,message:"无结果返回",type:"info"}),k.value=!1}else k.value=!1,Q({showClose:!0,message:"请输入正确内容.",type:"error"})})};new Date(new Date().getTime()-1*60*60*1e3),new Date(new Date().getTime()-2*60*60*1e3),new Date(new Date().getTime()-6*60*60*1e3),new Date(new Date().getTime()-12*60*60*1e3),new Date(new Date().getTime()-24*60*60*1e3),new Date(new Date().setHours(0,0,0,0)),new Date(new Date().setHours(23,59,59,999));const I=()=>{j.value=[{text:"Last 1 hours",value:[new Date(new Date().getTime()-1*60*60*1e3),new Date]},{text:"Last 2 hours",value:[new Date(new Date().getTime()-2*60*60*1e3),new Date]},{text:"Last 6 hours",value:[new Date(new Date().getTime()-6*60*60*1e3),new Date]},{text:"Last 12 hours",value:[new Date(new Date().getTime()-12*60*60*1e3),new Date]},{text:"Last 24 hours",value:[new Date(new Date().getTime()-24*60*60*1e3),new Date]},{text:"Today",value:[new Date(new Date().setHours(0,0,0,0)),new Date(new Date().setHours(23,59,59,999))]},{text:"Yesterday",value:()=>[new Date(new Date().getTime()-36e5),new Date]},{text:"A week ago",value:()=>{const l=new Date;return l.setDate(l.getDate()-7),[l.setDate(l.getDate()-7),new Date]}}]},j=d([]),ee=d(["=","!="]),A=l=>{n[l].labelValue=""};P(()=>n,l=>{u.labelFilters=l},{deep:!0});const le=async()=>{let l=await g.$api.lokiLabelGet({url:u.dataSourceUrl});console.log(l),M.value=l.data.data},L=d(""),te=async l=>{L.value=l,n[l].labelValue="";let e=n[l];if(e.labelName!=""){let r=await g.$api.lokiLabelValueGet({url:u.dataSourceUrl,label:e.labelName});n[l].initLabelValueList=r.data.data}},C=d([]),ae=l=>{console.log(l.stream),C.value=[],Object.keys(l.stream).forEach(e=>{let r={};r.label=e,r.value=l.stream[e],C.value.push(r)}),console.log(C.value)},oe=l=>{Object.keys(n).includes(l.label)||(n[l.label]={labelName:l.label,matchMethod:"=",labelValue:l.value,isMultiple:!1,labelValueList:[]})},ne=(l,e)=>{let r=l.replace(/</g,"&lt;").replace(/>/g,"&gt;");if(e){const f=new RegExp(e,"gi");return r.replace(f,'<span style="background-color: #FFFF00;">$&</span>')}else return r},T=d(!1),se=Le.debounce(l=>{T.value=!0,l===""||l===void 0||l instanceof Object?(n[L.value].labelValueList=n[L.value].initLabelValueList,T.value=!1):(n[L.value].labelValueList=n[L.value].initLabelValueList.filter(e=>e.label.includes(l)),T.value=!1)},500),ue=(l,e)=>e.level===l,K=d("");P(()=>u.matchKey,g.$commonFunc.debounceFunc(l=>{K.value=l}),{deep:!0});const re=l=>{Reflect.deleteProperty(n,l)},z=d(1),ie=()=>{z.value+=1,n[z.value]={labelName:"",matchMethod:"=",labelValue:"",isMultiple:!1,labelValueList:[]},console.log(n)},B=d(""),$=d(!1),de=l=>{$.value=!0,console.log(u),B.value.showNearLog(l)},ce=l=>{let e=[];l.forEach(f=>{e.push(`${f.logTime},${f.level},${f.logLine}
`)});let r=g.$commonFunc.getCurrentTimeString("-","-","_",":",":");console.log(r),g.$commonFunc.downloadArray(`export-log-${r}`,e)},pe=d([]),R=d([]),fe=async()=>{let l=await g.$api.dataSourceGet({page:1,page_size:1e3});pe.value=l.data.results,l.data.results.forEach(e=>{e.source_type=="loki"&&(e.isUsed?R.value.push({label:e.source_name,value:e.url,disabled:!1}):R.value.push({label:e.source_name,value:e.url,disabled:!0}),e.isDefault&&(u.dataSourceUrl=e.url))})};d(100),d(!1),d([]);const me=()=>{window.location.reload()};return ke(async()=>{console.log("in loki mounted"),await fe()}),(l,e)=>{const r=p("el-option"),f=p("el-select"),_=p("el-form-item"),h=p("el-button"),ve=p("el-input-number"),be=p("el-input"),H=p("el-col"),ge=p("el-date-picker"),we=p("el-row"),_e=p("el-form"),y=p("el-table-column"),G=p("el-table"),D=p("el-tag"),he=p("el-text"),ye=p("Top"),xe=p("el-icon"),De=p("el-backtop");return c(),w(x,null,[m("div",$e,[m("div",Re,[t(_e,{inline:!0,model:u,class:"demo-form-inline",ref:"formRef"},{default:a(()=>[t(_,{label:"数据源"},{default:a(()=>[t(f,{modelValue:u.dataSourceUrl,"onUpdate:modelValue":e[0]||(e[0]=o=>u.dataSourceUrl=o),placeholder:"Select",size:"large",style:{width:"180px"}},{default:a(()=>[(c(!0),w(x,null,V(R.value,(o,i)=>(c(),v(r,{key:i,label:o.label,value:o.value,disabled:o.disabled},null,8,["label","value","disabled"]))),128))]),_:1},8,["modelValue"])]),_:1}),m("div",null,[t(_,{label:"过滤器",prop:"labelValue"},{default:a(()=>[(c(!0),w(x,null,V(n,(o,i,q)=>(c(),w("div",{key:q},[t(f,{modelValue:n[i].labelName,"onUpdate:modelValue":s=>n[i].labelName=s,filterable:"",clearable:"",placeholder:"标签",style:{width:"120px"},onClick:le,onChange:s=>A(i)},{default:a(()=>[(c(!0),w(x,null,V(M.value,s=>(c(),v(r,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),t(f,{modelValue:n[i].matchMethod,"onUpdate:modelValue":s=>n[i].matchMethod=s,style:{width:"65px"},onChange:s=>A(i)},{default:a(()=>[(c(),w(x,null,V(J,s=>t(r,{key:s.value,label:s.label,value:s.value},{default:a(()=>[m("span",Me,S(s.label),1),m("span",Ee,S(s.text),1)]),_:2},1032,["label","value"])),64))]),_:2},1032,["modelValue","onUpdate:modelValue","onChange"]),t(f,{filterable:"",clearable:"","reserve-keyword":"",loading:T.value,"remote-show-suffix":"",modelValue:n[i].labelValue,"onUpdate:modelValue":s=>n[i].labelValue=s,multiple:!ee.value.includes(n[i].matchMethod),style:{width:"240px"},remote:"",onClick:s=>te(i),"remote-method":U(se)},{default:a(()=>[(c(!0),w(x,null,V(n[i].labelValueList,s=>(c(),v(r,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:2},1032,["loading","modelValue","onUpdate:modelValue","multiple","onClick","remote-method"]),Object.keys(n).length>>1?(c(),v(h,{key:0,size:"small",icon:U(Ce),circle:"",style:{margin:"0 5px 0px 5px"},onClick:s=>re(i)},null,8,["icon","onClick"])):Y("",!0)]))),128)),t(h,{type:"primary",icon:U(Te),circle:"",size:"small",style:{margin:"0 5px 0px 5px"},onClick:ie},null,8,["icon"])]),_:1})]),t(we,{justify:"space-between"},{default:a(()=>[t(H,{span:12},{default:a(()=>[t(_,{label:"条数"},{default:a(()=>[t(ve,{modelValue:u.limit,"onUpdate:modelValue":e[1]||(e[1]=o=>u.limit=o),step:100,min:1,max:5e3,width:"20"},null,8,["modelValue"])]),_:1}),t(_,{label:"关键字"},{default:a(()=>[t(f,{modelValue:u.matchKeyMethod,"onUpdate:modelValue":e[2]||(e[2]=o=>u.matchKeyMethod=o),style:{width:"60px"}},{default:a(()=>[(c(),w(x,null,V(X,o=>t(r,{key:o.value,label:o.label,value:o.value},{default:a(()=>[m("span",Oe,S(o.label),1),m("span",je,S(o.text),1)]),_:2},1032,["label","value"])),64))]),_:1},8,["modelValue"]),t(be,{modelValue:u.matchKey,"onUpdate:modelValue":e[3]||(e[3]=o=>u.matchKey=o),style:{width:"240px"},autosize:"",type:"textarea",placeholder:"请输入关键字"},null,8,["modelValue"])]),_:1})]),_:1}),t(H,{span:12},{default:a(()=>[t(_,{label:"时间范围",prop:"dateValue",rules:[{required:!0}]},{default:a(()=>[t(ge,{modelValue:u.dateValue,"onUpdate:modelValue":e[4]||(e[4]=o=>u.dateValue=o),type:"datetimerange",shortcuts:j.value,"range-separator":"To","start-placeholder":"Start date","end-placeholder":"End date","value-format":"x",onVisibleChange:e[5]||(e[5]=o=>I())},null,8,["modelValue","shortcuts"])]),_:1}),t(_,null,{default:a(()=>[t(h,{type:"primary",loading:k.value,onClick:Z},{default:a(()=>e[8]||(e[8]=[b("检索")])),_:1},8,["loading"]),t(h,{type:"primary",onClick:me},{default:a(()=>e[9]||(e[9]=[b("重置")])),_:1})]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),m("div",Ae,[t(G,{data:N.value.queryResult,style:{width:"98%"},onExpandChange:ae,"default-sort":{prop:"logTime",order:"descending"}},{default:a(()=>[t(y,{type:"expand"},{default:a(o=>[t(G,{data:C.value,border:"","show-header":!1},{default:a(()=>[t(y,{fixed:"left",label:"Operations",width:"45"},{default:a(i=>[t(h,{icon:U(Se),link:"",type:"primary",size:"small",onClick:q=>oe(i.row)},null,8,["icon","onClick"])]),_:1}),t(y,{label:"label",prop:"label",width:"120px"}),t(y,{label:"value",prop:"value"})]),_:1},8,["data"])]),_:1}),t(y,{label:"日志时间",prop:"logTime",sortable:"",width:"200px"}),t(y,{label:"日志等级",prop:"level",width:"100px",filters:F.value,"filter-method":ue,"filter-placement":"bottom-end"},{default:a(o=>[o.row.level=="DEBUG"?(c(),v(D,{key:0,type:"primary",effect:"light"},{default:a(()=>e[10]||(e[10]=[b("DEBUG")])),_:1})):o.row.level=="INFO"?(c(),v(D,{key:1,type:"success",effect:"light"},{default:a(()=>e[11]||(e[11]=[b("INFO")])),_:1})):o.row.level=="WARN"?(c(),v(D,{key:2,type:"warning",effect:"light"},{default:a(()=>e[12]||(e[12]=[b("WARN")])),_:1})):o.row.level=="ERROR"?(c(),v(D,{key:3,type:"danger",effect:"light"},{default:a(()=>e[13]||(e[13]=[b("ERROR")])),_:1})):o.row.level=="FATAL"?(c(),v(D,{key:4,type:"danger",effect:"light"},{default:a(()=>e[14]||(e[14]=[b("FATAL")])),_:1})):(c(),v(D,{key:5,type:"info",effect:"light"},{default:a(()=>e[15]||(e[15]=[b("UNKNOWN")])),_:1}))]),_:1},8,["filters"]),t(y,{label:"日志内容"},{header:a(()=>[m("div",Ke,[t(he,{style:{color:"var(--el-table-header-text-color)"}},{default:a(()=>e[16]||(e[16]=[b("日志内容")])),_:1}),E.value?(c(),v(h,{key:0,type:"primary",plain:"",onClick:e[6]||(e[6]=o=>{var i;return ce((i=N.value)==null?void 0:i.queryResult)})},{default:a(()=>e[17]||(e[17]=[b("下载日志")])),_:1})):Y("",!0)])]),default:a(({row:o})=>[m("span",{innerHTML:ne(o.logLine,K.value)},null,8,ze),m("div",Be,[t(h,{onClick:i=>de(o)},{default:a(()=>e[18]||(e[18]=[b("查看上下文")])),_:2},1032,["onClick"])])]),_:1})]),_:1},8,["data"])])]),t(Fe,{isShow:$.value,"onUpdate:isShow":e[7]||(e[7]=o=>$.value=o),highlightKey:u.matchKey,url:u.dataSourceUrl,ref_key:"childRef",ref:B},null,8,["isShow","highlightKey","url"]),t(De,{bottom:50,target:".el-main"},{default:a(()=>[t(xe,null,{default:a(()=>[t(ye)]),_:1})]),_:1})],64)}}}),Pe=Ne(He,[["__scopeId","data-v-c677efbe"]]);export{Pe as default};
