import{d as Ue,g as je,j as Be,v as ee,r as l,x as De,bP as te,z as Ke,aP as $,A as Le,h as i,bc as ae,c as U,o as r,f as s,b as v,w as n,F as Oe,i as Pe,B as d,bV as k,q as y,t as b,m as f,k as p,l as Ae,ca as Re,cx as Ze,cy as Ie,c8 as qe,b_ as h}from"./index-Ch0lsCs7.js";import{m as Ee}from"./model-4O14FRGq.js";const Fe={class:"card",style:{display:"flex","flex-direction":"column"}},He={class:"card",style:{display:"flex"}},Je={class:"ci_data_tree card",style:{height:"100%"}},Ge={class:"flexJbetween"},Qe={style:{flex:"1",height:"100%"}},We={class:"card table-main",style:{width:"100%"}},Xe={class:"table-header"},Ye={class:"header-button-lf"},et={class:"header-button-ri"},tt={key:0},at={key:0},ot=Ue({name:"ciSyncZabbix",__name:"nodeManageView",setup(lt){const{proxy:g}=je(),le=Be(),ne=Ee(),se=ee(()=>ne.modelObjectByName),oe=t=>{le.push({path:x.path+"/"+t.id})},u=l("hosts"),x=De(),P=l([]),A=l(!0);l(""),l(!0),l(!1),l({}),l({});const j=l(1),B=l(10),re=l("default"),ie=l(!1),R=l(0),D=l(""),ue=l("model_instance_name"),de=l(""),V=l({}),ce=l([{value:"model_instance_name",label:"唯一标识",sort:!0,filter:!0,type:"string",required:!0},{value:"ip_address",label:"ip地址",sort:!1,filter:!0,type:"string",required:!0}]),K=l([]);l([]),l([]);const Z=l([]),pe=l(null);ee(()=>{let t=[];return ce.value.forEach(e=>{e.filter&&t.push({name:e.label,value:e.value})}),t}),te(de,t=>{V.value={[ue.value]:t}});const me=async()=>{let t=await g.$api.getModelConfig({ordering:"create_time"});t.status==200&&(Z.value=t.data.results.filter(e=>e.is_manage===!0).map(e=>({label:e.model_verbose_name||e.model_name,name:e.model_name})))},m=async()=>{let t=await g.$api.getNodes({model_instance_group_id:w.value,model_name:u.value,page:j.value,page_size:B.value,search:D.value,...V.value,...T.value});P.value=t.data.results,R.value=t.data.count,A.value=!1},_e=async(t,e)=>{let _={};_[e]=t[e],(await g.$api.updateNodes({id:t.id,..._})).status==200?(h({type:"success",message:"更新成功"}),m()):h({type:"error",message:"更新失败"})},fe=async()=>{await g.$api.syncZabbixHost({model_name:u.value}),h({type:"success",message:"触发主机同步~"})},ge=async t=>{await g.$api.syncZabbixHost({node_id:t.id}),h({type:"success",message:"触发主机同步~"})},I=async t=>{let e=await g.$api.installAgent(t);e.status==200?h({type:"success",message:"触发成功"}):h({type:"error",message:`触发失败:${e.data.message}`})},ve=async t=>{let e=await g.$api.get_inventory(t);e.status==200?h({type:"success",message:"触发成功"}):h({type:"error",message:`触发失败:${e.data.message}`})},ye=(t,e)=>{w.value,$(()=>{J(),m()})},q=()=>{m()},T=l({ordering:"-model_instance_name"}),be=t=>{t.order==="ascending"?T.value.ordering=t.prop:t.order==="descending"?T.value.ordering="-"+t.prop:T.value={ordering:"-model_instance_name"},m()},E=t=>t===1?"success":t===0?"danger":"info",F=t=>t===1?"正常":t===0?"异常":"未知",he=t=>{K.value=t.map(e=>e.id)},we=t=>{const e=Object.keys(t)[0],_=Object.values(t)[0];_.length===1?V.value[e]=_[0]:_.length>1?V.value[`${e}`]=_.join(","):V.value[e]=null,$(()=>{}),$(()=>{m()})},ke=()=>{var t;(t=pe.value)==null||t.close()},H=l([]),N=l(null),w=l(null),L=l(!0),O=l("");te(O,t=>{N.value.filter(t)});const xe=(t,e)=>t?e.label.toLowerCase().includes(t.toLowerCase()):!0,J=async()=>{var e;L.value=!0;let t=await g.$api.getCiModelTree({model:(e=se.value[u.value])==null?void 0:e.id});H.value=[t.data],$(()=>{w.value===null&&(console.log("treeData.value",t.data.id),N.value.setCurrentKey(t.data.id),w.value=N.value.getCurrentKey(),console.log("currentNodeId.value",w.value))}),L.value=!1},Ce=t=>{w.value=N.value.getCurrentKey(),$(()=>{m()})};return Ke(async()=>{await J(),await me(),$(async()=>{await m()})}),Le(()=>{ke()}),(t,e)=>{const _=i("el-tab-pane"),G=i("el-tabs"),Q=i("el-input"),$e=i("el-text"),M=i("el-tag"),Ve=i("el-tree"),W=i("el-splitter-panel"),z=i("el-button"),C=i("el-tooltip"),c=i("el-table-column"),Ne=i("el-link"),ze=i("el-switch"),Se=i("el-table"),Te=i("el-pagination"),Me=i("el-splitter"),X=ae("loading"),S=ae("permission");return r(),U("div",Fe,[s(G,{modelValue:u.value,"onUpdate:modelValue":e[0]||(e[0]=a=>u.value=a),type:"card",class:"demo-tabs",onTabClick:ye},{default:n(()=>[(r(!0),U(Oe,null,Pe(Z.value,(a,o)=>(r(),d(_,{label:a.label,name:a.name,key:o},null,8,["label","name"]))),128))]),_:1},8,["modelValue"]),v("div",He,[s(Me,null,{default:n(()=>[s(W,{size:300,max:500,min:200},{default:n(()=>[v("div",Je,[s(Q,{modelValue:O.value,"onUpdate:modelValue":e[1]||(e[1]=a=>O.value=a),clearable:"",style:{"max-width":"280px","margin-bottom":"10px"},size:"small",placeholder:"检索节点"},null,8,["modelValue"]),k((r(),d(Ve,{ref_key:"treeRef",ref:N,data:H.value,"node-key":"id","expand-on-click-node":!1,"highlight-current":!0,"default-expand-all":"","filter-node-method":xe,onNodeClick:Ce,"current-node-key":w.value},{default:n(({node:a,data:o})=>[v("div",Ge,[s($e,{size:"default"},{default:n(()=>[y(b(a.label),1)]),_:2},1024),s(M,{size:"small",type:o.instance_count>>0?"success":"info"},{default:n(()=>[y(b(o.instance_count),1)]),_:2},1032,["type"])])]),_:1},8,["data","current-node-key"])),[[X,L.value]])])]),_:1}),s(W,{min:200},{default:n(()=>[v("div",Qe,[v("div",We,[v("div",Xe,[v("div",Ye,[s(C,{class:"box-item",effect:"dark",content:"触发主机信息同步到zabbix",placement:"top"},{default:n(()=>{var a;return[k((r(),d(z,{type:"primary",onClick:e[2]||(e[2]=o=>fe())},{default:n(()=>[...e[11]||(e[11]=[y("触发同步",-1)])]),_:1})),[[S,`${(a=f(x).name)==null?void 0:a.replace("_info","")}:add`]])]}),_:1}),s(C,{class:"box-item",effect:"dark",content:"触发重装已勾选的主机",placement:"top"},{default:n(()=>{var a;return[u.value==="hosts"?k((r(),d(z,{key:0,type:"primary",disabled:!(K.value.length>>>0),onClick:e[3]||(e[3]=o=>I({id:K.value}))},{default:n(()=>[...e[12]||(e[12]=[y("批量安装",-1)])]),_:1},8,["disabled"])),[[S,`${(a=f(x).name)==null?void 0:a.replace("_info","")}:add`]]):p("",!0)]}),_:1})]),v("div",et,[s(Q,{modelValue:D.value,"onUpdate:modelValue":e[4]||(e[4]=a=>D.value=a),style:{width:"240px"},placeholder:"回车查询",clearable:"","prefix-icon":f(Re),onClear:e[5]||(e[5]=a=>m()),onKeyup:e[6]||(e[6]=Ae(a=>m(),["enter","native"]))},null,8,["modelValue","prefix-icon"])])]),k((r(),d(Se,{ref:"multipleTableRef",data:P.value,style:{width:"100%"},height:"100%",border:"","row-key":a=>a.id,onSortChange:be,onSelectionChange:he,onFilterChange:we},{default:n(()=>[s(c,{type:"selection","reserve-selection":!0,width:"55"}),s(c,{property:"model_instance_name",label:"唯一标识",sortable:"custom"},{default:n(a=>[s(C,{content:"查看详情",placement:"right",effect:"dark"},{default:n(()=>[s(Ne,{type:"primary",onClick:o=>oe(a.row)},{default:n(()=>[y(b(a.row.model_instance_name),1)]),_:2},1032,["onClick"])]),_:2},1024)]),_:1}),s(c,{property:"ip_address",sortable:"custom",label:"ip地址"}),s(c,{property:"proxy_name",label:"代理",sortable:"custom",width:"120"},{default:n(a=>[a.row.proxy_name?(r(),d(M,{key:0},{default:n(()=>[y(b(a.row.proxy_name),1)]),_:2},1024)):p("",!0)]),_:1}),u.value==="hosts"?(r(),d(c,{key:0,"column-key":"manage_status",property:"manage_status",label:"管理状态",sortable:"custom",width:"140",filters:[{text:"正常",value:1},{text:"异常",value:0},{text:"未知",value:2}]},{default:n(a=>[s(M,{type:E(a.row.manage_status),effect:"dark"},{default:n(()=>[y(b(F(a.row.manage_status)),1)]),_:2},1032,["type"])]),_:1})):p("",!0),s(c,{"column-key":"enable_sync",property:"enable_sync",label:"是否同步",sortable:"custom",width:"140",filters:[{text:"启用",value:!0},{text:"禁用",value:!1}]},{default:n(a=>[s(ze,{modelValue:a.row.enable_sync,"onUpdate:modelValue":o=>a.row.enable_sync=o,class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},onChange:o=>_e(a.row,"enable_sync")},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),u.value==="hosts"?(r(),d(c,{key:1,"column-key":"agent_status",property:"agent_status",label:"agent状态",sortable:"custom",width:"140",filters:[{text:"正常",value:1},{text:"异常",value:0},{text:"未知",value:2}]},{default:n(a=>[s(M,{type:E(a.row.agent_status),effect:"dark"},{default:n(()=>[y(b(F(a.row.agent_status)),1)]),_:2},1032,["type"])]),_:1})):p("",!0),u.value==="hosts"?(r(),d(c,{key:2,property:"manage_error_message",label:"管理错误信息",width:"500"},{default:n(a=>[a.row.manage_error_message?(r(),U("span",tt,b(JSON.stringify(a.row.manage_error_message)),1)):p("",!0)]),_:1})):p("",!0),u.value==="hosts"?(r(),d(c,{key:3,property:"agent_error_message",label:"agent错误信息",width:"500"},{default:n(a=>[a.row.agent_error_message?(r(),U("span",at,b(JSON.stringify(a.row.agent_error_message)),1)):p("",!0)]),_:1})):p("",!0),s(c,{fixed:"right",width:"120",label:"操作"},{default:n(a=>[s(C,{class:"box-item",effect:"dark",content:"触发同步",placement:"top"},{default:n(()=>{var o;return[k(s(z,{link:"",type:"primary",icon:f(Ze),onClick:Y=>ge({id:a.row.id})},null,8,["icon","onClick"]),[[S,`${(o=f(x).name)==null?void 0:o.replace("_info","")}:edit`]])]}),_:2},1024),u.value==="hosts"?(r(),d(C,{key:0,class:"box-item",effect:"dark",content:"管理状态更新",placement:"top"},{default:n(()=>{var o;return[k(s(z,{link:"",type:"primary",icon:f(Ie),onClick:Y=>ve({id:a.row.id})},null,8,["icon","onClick"]),[[S,`${(o=f(x).name)==null?void 0:o.replace("_info","")}:edit`]])]}),_:2},1024)):p("",!0),u.value==="hosts"?(r(),d(C,{key:1,class:"box-item",effect:"dark",content:"触发agent安装",placement:"top"},{default:n(()=>{var o;return[k(s(z,{link:"",type:"primary",icon:f(qe),onClick:Y=>I({id:a.row.id})},null,8,["icon","onClick"]),[[S,`${(o=f(x).name)==null?void 0:o.replace("_info","")}:edit`]])]}),_:2},1024)):p("",!0)]),_:1})]),_:1},8,["data","row-key"])),[[X,A.value]]),s(Te,{"current-page":j.value,"onUpdate:currentPage":[e[7]||(e[7]=a=>j.value=a),e[9]||(e[9]=a=>q())],"page-size":B.value,"onUpdate:pageSize":[e[8]||(e[8]=a=>B.value=a),e[10]||(e[10]=a=>q())],"page-sizes":[10,20,50,100,200],size:re.value,disabled:ie.value,layout:"total, sizes, prev, pager, next, jumper",total:R.value,style:{"margin-top":"5px","justify-content":"flex-end"}},null,8,["current-page","page-size","size","disabled","total"])])])]),_:1})]),_:1})])])}}});export{ot as default};
