import{d as Se,g as Ee,h as Ye,f as Be,l as W,r as q,a as Oe,bK as De,m as Ne,e as g,b7 as Ue,c as h,o as l,i as F,bQ as ce,b as n,y as Z,q as r,w as t,k as d,t as _,F as z,p as j,c6 as Le,c7 as Fe,z as $,c3 as D,aK as Te,bY as ze,_ as Ae,ck as He}from"./index-DD1IBG_Z.js";import{e as Je,d as Me}from"./gmCrypto-QATNZpB6.js";import{u as je}from"./config-Cz7wJiRA.js";import{m as Pe}from"./model-DLhakzJz.js";import{c as We}from"./ciDataAudit-DHKafWCz.js";import"./vue3-json-viewer-DpuHEP3S.js";const Qe={class:"relations-card"},Ge={class:"card-header"},Xe={key:0},Ze={key:1},Ke={key:0},et={key:1},tt=["innerHTML"],at={style:{float:"left"}},lt={style:{float:"right",color:"var(--el-text-color-secondary)","font-size":"13px"}},nt={key:3,style:{"font-size":"12px",color:"#999","margin-top":"3px"}},ot={class:"dialog-footer"},rt=Se({__name:"ciDataRelation",props:{instanceId:{type:String,required:!0},modelId:{type:String,required:!0}},setup(ne){const B=ne,{proxy:Q}=Ee(),b=Ye();Be();const le=Pe(),T=W(()=>le.modelOptions),ve=W(()=>le.modelObjectById),K=W(()=>le.validationRulesEnumOptionsObject),ee=q(!1),te=q(!1),G=q([]),C=q([]),P=q([]),N=Oe({currentPage:1,pageSize:10,total:0}),u=q(!1),oe=q(),S=q(!1),re=q(null),f=Oe({relation:null,source_instance:B.instanceId,target_instance:null,source_attributes:{},target_attributes:{},relation_attributes:{}}),_e={relation:[{required:!0,message:"请选择关系类型",trigger:"change"}],target_instance:[{required:!0,message:"请选择目标实例",trigger:"change"}],source_attributes:{},target_attributes:{},relation_attributes:{}},X=async()=>{ee.value=!0;try{const a=await Q.$api.getModelInstanceRelation({instances:B.instanceId,page:N.currentPage,page_size:N.pageSize});G.value=a.data.results,N.total=a.data.count}catch(a){D.error("获取关联关系数据失败"),console.error(a)}finally{ee.value=!1}},L=W(()=>{const a={};return C.value.forEach(o=>{a[o.id]=o}),a}),E=q(null),H=q([]),se=q(!1);De(()=>f.relation,()=>{if(!f.relation)return;console.log("关联关系",L.value[f.relation]);let a=L.value[f.relation].source_model,o=L.value[f.relation].target_model;(a==null?void 0:a.indexOf(B.modelId))!==-1?(o==null?void 0:o.indexOf(B.modelId))!==-1?H.value=T.value.filter(m=>o.indexOf(m.value)!==-1):(H.value=T.value.filter(m=>o.indexOf(m.value)!==-1),se.value=!1):(H.value=T.value.filter(m=>a.indexOf(m.value)!==-1),se.value=!0),E.value=H.value[0].value},{deep:!0}),De(()=>E.value,(a,o)=>{console.log(E.value),console.log("新旧",o,a),f.target_instance=null});const pe=async()=>{try{const a=await Q.$api.getModelRelationDefine({any_model:B.modelId});C.value=a.data.results}catch(a){D.error("获取关系类型失败"),console.error(a)}},be=async a=>{if(!f.relation){P.value=[];return}te.value=!0;try{if(E.value){const o=await Q.$api.getCiModelInstance({model:E.value,search:a,page_size:20});P.value=o.data.results,P.value=P.value.filter(m=>m.id!==B.instanceId)}}catch(o){D.error("搜索目标实例失败"),console.error(o)}finally{te.value=!1}},xe=()=>{f.target_instance=null,be("")},we=()=>{S.value=!1,re.value=null,u.value=!0,pe()},$e=async a=>{var m;S.value=!0,re.value=a.id,u.value=!0,console.log("ffff",a),C.value.length===0&&await pe(),f.relation=a.relation.id,f.source_attributes=a.source_attributes||{},f.target_attributes=a.target_attributes||{},f.relation_attributes=a.relation_attributes||{};const o=L.value[a.relation.id];if(o){let y=o.source_model,w=o.target_model;(y==null?void 0:y.indexOf(B.modelId))!==-1?(w==null?void 0:w.indexOf(B.modelId))!==-1||(H.value=T.value.filter(O=>w.indexOf(O.value)!==-1)):H.value=T.value.filter(O=>y.indexOf(O.value)!==-1),E.value=(m=H.value[0])==null?void 0:m.value}Te(()=>{f.target_instance=a.target_instance.id,P.value=[{id:a.target_instance.id,instance_name:a.target_instance.instance_name}]}),console.log("xxx",f),console.log("目标实例",P.value)},ge=()=>{var a;(a=oe.value)==null||a.resetFields(),f.relation=null,f.target_instance=null,f.source_attributes={},f.target_attributes={},f.relation_attributes={},P.value=[],S.value=!1,re.value=null},ye=async()=>{var a;await((a=oe.value)==null?void 0:a.validate(async o=>{if(o)try{let m;if(S.value)m=await Q.$api.updateModelInstanceRelation({id:re.value,...f});else{let y={...f};se.value&&(console.log("reverse"),y.target_instance=f.source_instance,y.source_instance=f.target_instance),m=await Q.$api.addModelInstanceRelation({source_instance:B.instanceId,...y})}m.status===201&&!S.value||m.status===200&&S.value?(D.success(S.value?"编辑关联关系成功":"添加关联关系成功"),u.value=!1,ge(),X()):D.error(S.value?"编辑关联关系失败":"添加关联关系失败")}catch(m){D.error((S.value?"编辑关联关系失败: ":"添加关联关系失败: ")+m.message),console.error(m)}}))},he=a=>{ze.confirm("确定要删除这个关联关系吗？","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{(await Q.$api.deleteModelInstanceRelation(a)).status===204?(D.success("删除成功"),X()):D.error("删除失败")}catch(o){D.error("删除失败: "+o.message),console.error(o)}}).catch(()=>{})},Ce=a=>{N.pageSize=a,X()},s=a=>{N.currentPage=a,X()},p=a=>a?new Date(a).toLocaleString("zh-CN",{year:"numeric",month:"2-digit",day:"2-digit",hour:"2-digit",minute:"2-digit",second:"2-digit"}).replace(/\//g,"-"):"",k=a=>a?a.source_instance.id===B.instanceId?a.relation.forward_verb:a.relation.reverse_verb:"",x=a=>{if(!a)return"";const o=a.source_instance.instance_name,m=a.target_instance.instance_name,y=k(a),w=ve.value[a.source_instance.model].verbose_name,O=ve.value[a.target_instance.model].verbose_name;let A,J;if(a.source_instance.id===B.instanceId){A=Object.keys(a.source_attributes).map(I=>`${ue(a.relation,I)}: ${R(a.relation,I,a.source_attributes[I])}`).join(", "),J=Object.keys(a.target_attributes).map(I=>`${M(a.relation,I)}: ${R(a.relation,I,a.target_attributes[I])}`).join(", ");let Y=`<span class="source-name">${o}</span>(${w})`;return A&&(Y+=`的[${A}]`),Y+=` - <span class="relation-name">${y}</span> - <span class="target-name">${m}</span>(${O})`,J&&(Y+=`的[${J}]`),Y}else{J=Object.keys(a.target_attributes).map(I=>`${M(a.relation,I)}: ${R(a.relation,I,a.target_attributes[I])}`).join(", "),A=Object.keys(a.source_attributes).map(I=>`${ue(a.relation,I)}: ${R(a.relation,I,a.source_attributes[I])}`).join(", ");let Y=`<span class="source-name">${m}</span>(${O})`;return J&&(Y+=`的[${J}]`),Y+=` - <span class="relation-name">${y}</span> - <span class="target-name">${o}</span>(${w})`,A&&(Y+=`的[${A}]`),Y}},ue=(a,o)=>{if(!a||!a.attribute_schema||!a.attribute_schema.source)return o;const m=a.attribute_schema.source[o];return m?m.verbose_name:o},V=(a,o)=>{if(!a||!a.attribute_schema||!a.attribute_schema.relation)return o;const m=a.attribute_schema.relation[o];return m?m.verbose_name:o},M=(a,o)=>{if(!a||!a.attribute_schema||!a.attribute_schema.target)return o;const m=a.attribute_schema.target[o];return m?m.verbose_name:o},R=(a,o,m)=>{if(!a||!a.attribute_schema||!a.attribute_schema.relation)return m;const y=a.attribute_schema.relation[o];if(!y)return m;if(y.type==="enum"&&y.validation_rule){const w=K.value[y.validation_rule];if(w){const O=w.find(A=>A.value===m);if(O)return O.label}}return y.unit?`${m} ${y.unit}`:m};return Ne(()=>{X(),pe()}),(a,o)=>{var U;const m=g("el-button"),y=g("el-tag"),w=g("el-table-column"),O=g("el-text"),A=g("el-table"),J=g("el-pagination"),Y=g("el-option"),I=g("el-select"),ae=g("el-form-item"),ke=g("el-radio-button"),Ie=g("el-radio-group"),me=g("el-input"),qe=g("el-input-number"),Re=g("el-form"),de=g("el-dialog"),fe=Ue("permission"),Ve=Ue("loading");return l(),h("div",Qe,[F("div",Ge,[F("div",null,[ce((l(),r(m,{type:"primary",onClick:we},{default:t(()=>[...o[7]||(o[7]=[d(" 添加关联 ",-1)])]),_:1})),[[fe,`${(U=Z(b).name)==null?void 0:U.replace("_info","")}:add`]])])]),ce((l(),r(A,{data:G.value,style:{width:"100%"},border:""},{default:t(()=>[n(w,{prop:"source_instance",label:"源实例",width:"300"},{default:t(i=>[i.row.source_instance.id!==ne.instanceId?(l(),r(y,{key:0},{default:t(()=>[d(_(i.row.target_instance.instance_name),1)]),_:2},1024)):(l(),r(y,{key:1},{default:t(()=>[d(_(i.row.source_instance.instance_name),1)]),_:2},1024))]),_:1}),n(w,{prop:"source_attributes",label:"源属性",width:"150"},{default:t(i=>[i.row.source_instance.id===ne.instanceId?(l(),h("div",Xe,[(l(!0),h(z,null,j(i.row.source_attributes,(e,v)=>(l(),h("div",{key:v,style:{"font-size":"12px"}},[n(O,{tag:"b"},{default:t(()=>[d(_(ue(i.row.relation,v))+":",1)]),_:2},1024),d(" "+_(e),1)]))),128))])):(l(),h("div",Ze,[(l(!0),h(z,null,j(i.row.target_attributes,(e,v)=>(l(),h("div",{key:v,style:{"font-size":"12px"}},[n(O,{tag:"b"},{default:t(()=>[d(_(M(i.row.relation,v))+":",1)]),_:2},1024),d(" "+_(e),1)]))),128))]))]),_:1}),n(w,{prop:"relation",label:"关联动作",width:"100"},{default:t(i=>[n(y,{type:"success"},{default:t(()=>[d(_(k(i.row)),1)]),_:2},1024)]),_:1}),n(w,{prop:"source_instance",label:"目标实例",width:"300"},{default:t(i=>[i.row.source_instance.id!==ne.instanceId?(l(),r(y,{key:0},{default:t(()=>[d(_(i.row.source_instance.instance_name),1)]),_:2},1024)):(l(),r(y,{key:1},{default:t(()=>[d(_(i.row.target_instance.instance_name),1)]),_:2},1024))]),_:1}),n(w,{prop:"target_attributes",label:"目标属性",width:"150"},{default:t(i=>[i.row.source_instance.id!==ne.instanceId?(l(),h("div",Ke,[(l(!0),h(z,null,j(i.row.source_attributes,(e,v)=>(l(),h("div",{key:v,style:{"font-size":"12px"}},[n(O,{tag:"b"},{default:t(()=>[d(_(ue(i.row.relation,v))+":",1)]),_:2},1024),d(" "+_(e),1)]))),128))])):(l(),h("div",et,[(l(!0),h(z,null,j(i.row.target_attributes,(e,v)=>(l(),h("div",{key:v,style:{"font-size":"12px"}},[n(O,{tag:"b"},{default:t(()=>[d(_(M(i.row.relation,v))+":",1)]),_:2},1024),d(" "+_(e),1)]))),128))]))]),_:1}),n(w,{prop:"relation_attributes",label:"关系属性",width:"250"},{default:t(i=>[(l(!0),h(z,null,j(i.row.relation_attributes,(e,v)=>(l(),h("div",{key:v,style:{"font-size":"12px"}},[n(O,{tag:"b"},{default:t(()=>[d(_(V(i.row.relation,v))+":",1)]),_:2},1024),d(" "+_(R(i.row.relation,v,e)),1)]))),128))]),_:1}),n(w,{prop:"relation",label:"关系类型",width:"150"},{default:t(i=>[n(y,{type:"info"},{default:t(()=>[d(_(i.row.relation.name),1)]),_:2},1024)]),_:1}),n(w,{prop:"id",label:"关联动作描述"},{default:t(i=>[F("div",{class:"relation-description",innerHTML:x(i.row)},null,8,tt)]),_:1}),n(w,{prop:"create_time",label:"创建时间",width:"180"},{default:t(i=>[d(_(p(i.row.create_time)),1)]),_:1}),n(w,{label:"操作",width:"120",fixed:"right"},{default:t(i=>{var e,v;return[ce(n(m,{onClick:c=>$e(i.row),type:"primary",icon:Z(Le),link:""},null,8,["onClick","icon"]),[[fe,`${(e=Z(b).name)==null?void 0:e.replace("_info","")}:edit`]]),ce(n(m,{type:"danger",link:"",icon:Z(Fe),onClick:c=>he(i.row.id)},null,8,["icon","onClick"]),[[fe,`${(v=Z(b).name)==null?void 0:v.replace("_info","")}:delete`]])]}),_:1})]),_:1},8,["data"])),[[Ve,ee.value]]),n(J,{"current-page":N.currentPage,"onUpdate:currentPage":o[0]||(o[0]=i=>N.currentPage=i),"page-size":N.pageSize,"onUpdate:pageSize":o[1]||(o[1]=i=>N.pageSize=i),"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",total:N.total,onSizeChange:Ce,onCurrentChange:s,style:{"margin-top":"20px","justify-content":"flex-end"}},null,8,["current-page","page-size","total"]),n(de,{modelValue:u.value,"onUpdate:modelValue":o[6]||(o[6]=i=>u.value=i),title:S.value?"编辑关联关系":"添加关联关系",width:"600px",onClose:ge},{footer:t(()=>[F("div",ot,[n(m,{onClick:o[5]||(o[5]=i=>u.value=!1)},{default:t(()=>[...o[8]||(o[8]=[d("取消",-1)])]),_:1}),n(m,{type:"primary",onClick:ye},{default:t(()=>[d(_(S.value?"保存":"添加"),1)]),_:1})])]),default:t(()=>[n(Re,{ref_key:"addRelationFormRef",ref:oe,model:f,rules:_e,"label-width":"120px"},{default:t(()=>{var i;return[n(ae,{label:"关系类型",prop:"relation"},{default:t(()=>[n(I,{modelValue:f.relation,"onUpdate:modelValue":o[2]||(o[2]=e=>f.relation=e),placeholder:"请选择关系类型",style:{width:"100%"},onChange:xe,disabled:S.value},{default:t(()=>[(l(!0),h(z,null,j(C.value,e=>(l(),r(Y,{key:e.id,label:e.name,value:e.id},{default:t(()=>{var v;return[F("span",at,_(e.name),1),F("span",lt,_(((v=e.source_model)==null?void 0:v.indexOf(B.modelId))>>>-1?"目标实例":"源实例"),1)]}),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),n(ae,{label:"目标实例",prop:"target_instance"},{default:t(()=>[n(Ie,{modelValue:E.value,"onUpdate:modelValue":o[3]||(o[3]=e=>E.value=e),size:"default"},{default:t(()=>[(l(!0),h(z,null,j(H.value,(e,v)=>(l(),r(ke,{disabled:S.value,label:e.label,value:e.value,key:v},null,8,["disabled","label","value"]))),128))]),_:1},8,["modelValue"]),n(I,{modelValue:f.target_instance,"onUpdate:modelValue":o[4]||(o[4]=e=>f.target_instance=e),placeholder:"请选择关联实例",style:{width:"100%","margin-top":"5px"},filterable:"",remote:"","remote-method":be,loading:te.value},{default:t(()=>[(l(!0),h(z,null,j(P.value,e=>(l(),r(Y,{key:e.id,label:e.instance_name,value:e.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading"])]),_:1}),(i=L.value[f.relation])!=null&&i.attribute_schema?(l(),h(z,{key:0},[(l(!0),h(z,null,j(L.value[f.relation].attribute_schema.source,(e,v)=>(l(),r(ae,{key:"source_"+v,label:e.verbose_name,prop:"source_attributes."+v,required:e.required},{default:t(()=>[n(me,{modelValue:f.source_attributes[v],"onUpdate:modelValue":c=>f.source_attributes[v]=c,placeholder:"请输入"+e.verbose_name,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),_:2},1032,["label","prop","required"]))),128)),(l(!0),h(z,null,j(L.value[f.relation].attribute_schema.target,(e,v)=>(l(),r(ae,{key:"target_"+v,label:e.verbose_name,prop:"target_attributes."+v,required:e.required},{default:t(()=>[n(me,{modelValue:f.target_attributes[v],"onUpdate:modelValue":c=>f.target_attributes[v]=c,placeholder:"请输入"+e.verbose_name,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),_:2},1032,["label","prop","required"]))),128)),(l(!0),h(z,null,j(L.value[f.relation].attribute_schema.relation,(e,v)=>(l(),r(ae,{key:"relation_"+v,label:e.verbose_name,prop:"relation_attributes."+v,required:e.required},{default:t(()=>[e.type==="enum"?(l(),r(I,{key:0,modelValue:f.relation_attributes[v],"onUpdate:modelValue":c=>f.relation_attributes[v]=c,placeholder:"请选择"+e.verbose_name,style:{width:"100%"}},{default:t(()=>[(l(!0),h(z,null,j(K.value[e.validation_rule],c=>(l(),r(Y,{key:c.value,label:c.label,value:c.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder"])):["integer","float"].includes(e.type)?(l(),r(qe,{key:1,modelValue:f.relation_attributes[v],"onUpdate:modelValue":c=>f.relation_attributes[v]=c,placeholder:"请输入"+e.verbose_name,style:{width:"100%"},"controls-position":"right"},null,8,["modelValue","onUpdate:modelValue","placeholder"])):(l(),r(me,{key:2,modelValue:f.relation_attributes[v],"onUpdate:modelValue":c=>f.relation_attributes[v]=c,placeholder:"请输入"+e.verbose_name,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue","placeholder"])),e.unit?(l(),h("div",nt," 单位: "+_(e.unit),1)):$("",!0)]),_:2},1032,["label","prop","required"]))),128))],64)):$("",!0)]}),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),st=Ae(rt,[["__scopeId","data-v-1ffbce4e"]]),ut={class:"divVertical gap-5"},dt={class:"header card"},it={class:"content card"},ct={style:{width:"200px",display:"flex","justify-content":"flex-end","margin-right":"20px"}},_t={key:0},pt={key:1},mt={key:1},ft={key:1},vt=Se({__name:"ciDataInfoView",setup(ne,{expose:B}){const Q=q(null),b=q({}),le=Pe(),T=q({}),ve=W(()=>le.validationRulesEnumOptionsObject),{proxy:K}=Ee(),ee=Ye(),te=Be(),G=je(),C=q(!1),P=W(()=>G.gmCry),N=q(),u=Oe({id:null,instance_name:null}),oe=q(null),S=q("modelField"),re=(s,p)=>{s.props.name=="changelog"&&oe.value.getData()},f=q([0]),_e=q({}),X=()=>{u.id=b.value.id,u.instance_name=b.value.instance_name,Object.keys(b.value.fields).forEach(s=>{E.value.enum.includes(s)?b.value.fields[s]!==null?u[s]=b.value.fields[s].value:u[s]=null:E.value.model_ref.includes(s)?b.value.fields[s]!==null?(_e.value[s]=[b.value.fields[s]],u[s]=b.value.fields[s].id):u[s]=null:E.value.password.includes(s)&&G.showAllPass?u[s]=Me(G.gmCry.key,b.value.fields[s]):u[s]=b.value.fields[s]})},L=W(()=>{var s,p;return(p=(s=b.value)==null?void 0:s.instance_group)==null?void 0:p.some(k=>k.group_path.includes("空闲池"))}),E=W(()=>{let s={enum:[],boolean:[],model_ref:[],password:[]};return T.value.field_groups&&T.value.field_groups.forEach(p=>{p.fields.forEach(k=>{k.type==="enum"?s.enum.push(k.name):k.type==="boolean"?s.boolean.push(k.name):k.type==="model_ref"?s.model_ref.push(k.name):k.type==="password"&&s.password.push(k.name)})}),s}),H=s=>{if(!(s==""||s==null))return[{pattern:new RegExp(".*"),message:"不符合正则表达式",trigger:"blur"}]},se=W(()=>{let s={};for(let[p,k]of Object.entries(u)){if(["id","instance_name"].includes(p))continue;let x=b.value.fields[p];E.value.enum.includes(p)?x=b.value.fields[p]===null?null:b.value.fields[p].value:E.value.model_ref.includes(p)?x=b.value.fields[p]===null?null:b.value.fields[p].id:E.value.password.includes(p)&&(G.showAllPass||(x=b.value.fields[p])),(k!==x||k===null&&x!==null&&x!==void 0||k===""&&x!==""&&x!==null&&x!==void 0)&&(E.value.password.includes(p)&&k!==null&&k!==""?s[p]=Je(G.gmCry.key,G.gmCry.mode,k):s[p]=k)}return s}),pe=W(()=>{var s;return(((s=T.value)==null?void 0:s.field_groups)||[]).reduce((p,k)=>((k.fields||[]).forEach(x=>{p[x.name]=x}),p),{})}),be=async(s,p)=>{const k=pe.value[p];if(!(!k||!k.ref_model))try{let x=await K.$api.getModelRefCi({model:k.ref_model,instance_name:s||void 0,page:1,page_size:s?100:20});_e.value[p]=x.data.results}catch(x){console.error("获取model_ref数据失败:",x)}},xe=()=>{C.value=!0},we=()=>{C.value=!1,Te(()=>{X()})},$e=async()=>{N.value&&await N.value.validate(async(s,p)=>{if(s){if(Object.keys(se.value).length===0&&u.instance_name===b.value.instance_name){D({showClose:!0,message:"没有数据发生变更",type:"warning"}),C.value=!1;return}const k=He.service({lock:!0,text:"保存中...",background:"rgba(0, 0, 0, 0.7)"});try{let x=await K.$api.updateCiModelInstance({id:b.value.id,model:T.value.id,instance_name:u.instance_name===b.value.instance_name?null:u.instance_name,update_user:store.state.username,fields:se.value});x.status=="200"?(D({type:"success",message:"保存成功"}),C.value=!1,he()):(console.log(x),D({showClose:!0,message:"保存失败:"+JSON.stringify(x.data),type:"error"}))}catch(x){console.log(x),D({showClose:!0,message:"保存失败，请稍后重试",type:"error"})}finally{k.close()}}else D({showClose:!0,message:"表单填写有误，请检查",type:"error"})})},ge=()=>{ze.confirm("确定要删除该实例吗？此操作不可恢复","删除实例",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{let s=await K.$api.deleteCiModelInstance(b.value.id);s.status==204?(D.success("删除成功"),ye()):D.error(`删除失败,${JSON.stringify(s.data)}`)}catch{D.error("删除失败，error")}}).catch(()=>{})},ye=()=>{if(ee.name.includes("cmdb_only")){te.push({path:"/cmdb_only/cmdb/cidata"});return}if(!C.value){te.push({path:"/cmdb/cidata"});return}ze.confirm("确定要离开页面吗？未保存的数据将会丢失","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{te.push({path:"/cmdb/cidata"})}).catch(()=>{})},he=async()=>{const s=await K.$api.getCiModelInstanceInfo(Q.value);s.status===200&&(b.value=s.data)},Ce=async()=>{const s=await K.$api.getCiModel({},b.value.model);s.status===200&&(T.value=s.data)};return Ne(async()=>{try{Q.value=ee.path.split("/").at(-1),await he(),await Ce(),le.getModel(),le.getValidationRules(),X()}catch(s){console.log(s),D.error("数据加载失败",s),te.back()}}),B({initEditForm:X}),(s,p)=>{const k=g("el-page-header"),x=g("el-descriptions-item"),ue=g("el-descriptions"),V=g("el-text"),M=g("Warning"),R=g("el-icon"),a=g("el-tooltip"),o=g("el-space"),m=g("el-input"),y=g("el-form-item"),w=g("el-button"),O=g("el-row"),A=g("InfoFilled"),J=g("el-switch"),Y=g("el-input-number"),I=g("el-date-picker"),ae=g("el-option"),ke=g("el-select"),Ie=g("el-col"),me=g("el-collapse-item"),qe=g("el-collapse"),Re=g("el-form"),de=g("el-tab-pane"),fe=g("el-tabs"),Ve=Ue("permission");return l(),h("div",ut,[F("div",dt,[n(k,{onBack:ye},{content:t(()=>{var U;return[F("span",null,_(`${(U=T.value.model)==null?void 0:U.verbose_name}【${b.value.instance_name}】`),1)]}),_:1})]),F("div",it,[n(ue,{border:"",column:2,style:{width:"40%","margin-bottom":"10px"},"label-width":"100px"},{default:t(()=>[n(x,{label:"唯一标识"},{default:t(()=>[d(_(b.value.instance_name),1)]),_:1}),n(x,{label:"所属分组",width:"55%"},{default:t(()=>{var U;return[(l(!0),h(z,null,j((U=b.value)==null?void 0:U.instance_group,(i,e)=>(l(),h("div",{key:e,class:"group-item"},_(i.group_path),1))),128))]}),_:1})]),_:1}),n(fe,{modelValue:S.value,"onUpdate:modelValue":p[2]||(p[2]=U=>S.value=U),type:"card",class:"demo-tabs",onTabClick:re},{default:t(()=>[n(de,{label:"资产信息",name:"modelField"},{default:t(()=>[n(Re,{ref_key:"editFormRef",ref:N,style:{"max-width":"100%"},model:u,"label-width":"auto","status-icon":"","label-position":"top","require-asterisk-position":"right"},{default:t(()=>[n(O,{gutter:20,justify:"space-between"},{default:t(()=>{var U;return[n(y,{prop:"instance_name",required:"",style:{"margin-left":"30px"}},{label:t(()=>[n(o,{size:2},{default:t(()=>[n(V,{tag:"b"},{default:t(()=>[...p[3]||(p[3]=[d("唯一标识",-1)])]),_:1}),n(a,{content:"唯一命名标识",placement:"right",effect:"dark"},{default:t(()=>[n(R,null,{default:t(()=>[n(M)]),_:1})]),_:1})]),_:1})]),default:t(()=>[C.value?(l(),r(m,{key:0,modelValue:u.instance_name,"onUpdate:modelValue":p[0]||(p[0]=i=>u.instance_name=i),style:{"min-width":"400px"}},null,8,["modelValue"])):(l(),r(V,{key:1},{default:t(()=>[d(_(u.instance_name),1)]),_:1}))]),_:1}),F("div",ct,[C.value?(l(),h("div",pt,[n(w,{type:"primary",onClick:we},{default:t(()=>[...p[6]||(p[6]=[d("取消",-1)])]),_:1}),n(w,{type:"primary",onClick:$e},{default:t(()=>[...p[7]||(p[7]=[d("保存",-1)])]),_:1})])):(l(),h("div",_t,[ce((l(),r(w,{type:"primary",onClick:xe},{default:t(()=>[...p[4]||(p[4]=[d("编辑",-1)])]),_:1})),[[Ve,`${(U=Z(ee).name)==null?void 0:U.replace("_info","")}:edit`]]),n(a,{content:L.value?"删除实例":"实例不在空闲池，无法删除!",placement:"top",effect:"dark"},{default:t(()=>{var i;return[ce((l(),r(w,{type:"danger",onClick:ge,disabled:!L.value},{default:t(()=>[...p[5]||(p[5]=[d("删除",-1)])]),_:1},8,["disabled"])),[[Ve,`${(i=Z(ee).name)==null?void 0:i.replace("_info","")}:delete`]])]}),_:1},8,["content"])]))])]}),_:1}),n(qe,{modelValue:f.value,"onUpdate:modelValue":p[1]||(p[1]=U=>f.value=U)},{default:t(()=>[(l(!0),h(z,null,j(T.value.field_groups,(U,i)=>(l(),r(me,{name:i,key:i},{title:t(()=>[n(V,{tag:"b",size:"large"},{default:t(()=>[d(_(U.verbose_name),1)]),_:2},1024)]),default:t(()=>[n(O,{gutter:20,style:{"margin-left":"30px"}},{default:t(()=>[(l(!0),h(z,null,j(U.fields,(e,v)=>(l(),r(Ie,{key:v,xs:24,sm:24,md:12,lg:8,xl:6},{default:t(()=>[e.type==="string"?(l(),r(y,{key:0,label:e.verbose_name,prop:e.name,required:e.required,rules:H(e.validation_rule)},{label:t(()=>[n(o,{size:2},{default:t(()=>[n(V,{tag:"b"},{default:t(()=>[d(_(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(l(),r(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(R,null,{default:t(()=>[n(M)]),_:1})]),_:1},8,["content"])):$("",!0)]),_:2},1024)]),default:t(()=>[C.value?(l(),r(m,{key:0,modelValue:u[e.name],"onUpdate:modelValue":c=>u[e.name]=c,style:{width:"240px"},disabled:!e.editable},null,8,["modelValue","onUpdate:modelValue","disabled"])):(l(),r(V,{key:1},{default:t(()=>[d(_(u[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required","rules"])):$("",!0),e.type==="json"?(l(),r(y,{key:1,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[n(o,{size:2},{default:t(()=>[n(V,{tag:"b"},{default:t(()=>[d(_(e.verbose_name),1)]),_:2},1024),n(a,{placement:"right",effect:"dark"},{content:t(()=>[...p[8]||(p[8]=[d(" json类型字段",-1),F("br",null,null,-1),d("请输入json格式数据! ",-1)])]),default:t(()=>[n(R,null,{default:t(()=>[n(A)]),_:1})]),_:1}),e.description.length!=0?(l(),r(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(R,null,{default:t(()=>[n(M)]),_:1})]),_:1},8,["content"])):$("",!0)]),_:2},1024)]),default:t(()=>[C.value?(l(),r(m,{key:0,modelValue:u[e.name],"onUpdate:modelValue":c=>u[e.name]=c,style:{width:"240px"},autosize:"",type:"textarea"},null,8,["modelValue","onUpdate:modelValue"])):(l(),r(V,{key:1},{default:t(()=>[d(_(u[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])):$("",!0),["text"].indexOf(e.type)>>>-1?$("",!0):(l(),r(y,{key:2,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[n(o,{size:2},{default:t(()=>[n(V,{tag:"b"},{default:t(()=>[d(_(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(l(),r(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(R,null,{default:t(()=>[n(M)]),_:1})]),_:1},8,["content"])):$("",!0)]),_:2},1024)]),default:t(()=>[C.value?(l(),r(m,{key:0,modelValue:u[e.name],"onUpdate:modelValue":c=>u[e.name]=c,style:{width:"240px"},autosize:"",type:"textarea"},null,8,["modelValue","onUpdate:modelValue"])):(l(),r(V,{key:1},{default:t(()=>[d(_(u[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])),e.type==="boolean"?(l(),r(y,{key:3,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[n(o,{size:2},{default:t(()=>[n(V,{tag:"b"},{default:t(()=>[d(_(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(l(),r(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(R,null,{default:t(()=>[n(M)]),_:1})]),_:1},8,["content"])):$("",!0)]),_:2},1024)]),default:t(()=>[n(J,{modelValue:u[e.name],"onUpdate:modelValue":c=>u[e.name]=c,style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},disabled:!C.value},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1032,["label","prop","required"])):$("",!0),["float"].indexOf(e.type)>>>-1?$("",!0):(l(),r(y,{key:4,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[n(o,{size:2},{default:t(()=>[e.unit!==null?(l(),r(V,{key:0,tag:"b"},{default:t(()=>[d(_(e.verbose_name+"("+e.unit+")"),1)]),_:2},1024)):(l(),r(V,{key:1,tag:"b"},{default:t(()=>[d(_(e.verbose_name),1)]),_:2},1024)),e.description.length!=0?(l(),r(a,{key:2,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(R,null,{default:t(()=>[n(M)]),_:1})]),_:1},8,["content"])):$("",!0)]),_:2},1024)]),default:t(()=>[C.value?(l(),r(Y,{key:0,modelValue:u[e.name],"onUpdate:modelValue":c=>u[e.name]=c,precision:2,step:1},null,8,["modelValue","onUpdate:modelValue"])):(l(),r(V,{key:1},{default:t(()=>[d(_(u[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])),["password"].indexOf(e.type)>>>-1?$("",!0):(l(),r(y,{key:5,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[n(o,{size:2},{default:t(()=>[n(V,{tag:"b"},{default:t(()=>[d(_(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(l(),r(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(R,null,{default:t(()=>[n(M)]),_:1})]),_:1},8,["content"])):$("",!0)]),_:2},1024)]),default:t(()=>{var c;return[C.value?(l(),r(m,{key:0,modelValue:u[e.name],"onUpdate:modelValue":ie=>u[e.name]=ie,style:{width:"240px"},type:"password","auto-complete":"new-password","show-password":"",clearable:""},null,8,["modelValue","onUpdate:modelValue"])):(l(),h("div",mt,[Z(je).isShowPass?(l(),r(V,{key:0},{default:t(()=>[d(_(Z(Me)(P.value.key,P.value.mode,u[e.name])),1)]),_:2},1024)):(l(),h("div",ft,[((c=u[e.name])==null?void 0:c.length)>>0?(l(),r(V,{key:0},{default:t(()=>{var ie;return[d(_("*".repeat((ie=u[e.name])==null?void 0:ie.length)),1)]}),_:2},1024)):(l(),r(V,{key:1}))]))]))]}),_:2},1032,["label","prop","required"])),["integer"].indexOf(e.type)>>>-1?$("",!0):(l(),r(y,{key:6,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[n(o,{size:2},{default:t(()=>[e.unit!==null?(l(),r(V,{key:0,tag:"b"},{default:t(()=>[d(_(e.verbose_name+"("+e.unit+")"),1)]),_:2},1024)):(l(),r(V,{key:1,tag:"b"},{default:t(()=>[d(_(e.verbose_name),1)]),_:2},1024)),e.description.length!=0?(l(),r(a,{key:2,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(R,null,{default:t(()=>[n(M)]),_:1})]),_:1},8,["content"])):$("",!0)]),_:2},1024)]),default:t(()=>[C.value?(l(),r(Y,{key:0,modelValue:u[e.name],"onUpdate:modelValue":c=>u[e.name]=c,step:1},null,8,["modelValue","onUpdate:modelValue"])):(l(),r(V,{key:1},{default:t(()=>[d(_(u[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])),["date"].indexOf(e.type)>>>-1?$("",!0):(l(),r(y,{key:7,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[n(o,{size:2},{default:t(()=>[n(V,{tag:"b"},{default:t(()=>[d(_(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(l(),r(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(R,null,{default:t(()=>[n(M)]),_:1})]),_:1},8,["content"])):$("",!0)]),_:2},1024)]),default:t(()=>[C.value?(l(),r(I,{key:0,modelValue:u[e.name],"onUpdate:modelValue":c=>u[e.name]=c,type:"date",placeholder:"Pick a Date",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue","onUpdate:modelValue"])):(l(),r(V,{key:1},{default:t(()=>[d(_(u[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])),["datetime"].indexOf(e.type)>>>-1?$("",!0):(l(),r(y,{key:8,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[n(o,{size:2},{default:t(()=>[n(V,{tag:"b"},{default:t(()=>[d(_(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(l(),r(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(R,null,{default:t(()=>[n(M)]),_:1})]),_:1},8,["content"])):$("",!0)]),_:2},1024)]),default:t(()=>[C.value?(l(),r(I,{key:0,modelValue:u[e.name],"onUpdate:modelValue":c=>u[e.name]=c,type:"datetime",placeholder:"Pick a Date",format:"YYYY/MM/DD hh:mm:ss","value-format":"YYYY-MM-DD hh:mm:ss"},null,8,["modelValue","onUpdate:modelValue"])):(l(),r(V,{key:1},{default:t(()=>[d(_(u[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])),["enum"].indexOf(e.type)>>>-1?$("",!0):(l(),r(y,{key:9,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[n(o,{size:2},{default:t(()=>[n(V,{tag:"b"},{default:t(()=>[d(_(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(l(),r(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(R,null,{default:t(()=>[n(M)]),_:1})]),_:1},8,["content"])):$("",!0)]),_:2},1024)]),default:t(()=>[C.value?(l(),r(ke,{key:0,clearable:"",filterable:"",modelValue:u[e.name],"onUpdate:modelValue":c=>u[e.name]=c,placeholder:"请选择",style:{width:"240px"}},{default:t(()=>[(l(!0),h(z,null,j(ve.value[e.validation_rule],c=>(l(),r(ae,{key:c.value,label:c.label,value:c.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):(l(),r(V,{key:1},{default:t(()=>{var c;return[d(_((c=b.value.fields[e.name])==null?void 0:c.label),1)]}),_:2},1024))]),_:2},1032,["label","prop","required"])),["model_ref"].indexOf(e.type)>>>-1?$("",!0):(l(),r(y,{key:10,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[n(o,{size:2},{default:t(()=>[n(V,{tag:"b"},{default:t(()=>[d(_(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(l(),r(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(R,null,{default:t(()=>[n(M)]),_:1})]),_:1},8,["content"])):$("",!0)]),_:2},1024)]),default:t(()=>[C.value?(l(),r(ke,{key:0,modelValue:u[e.name],"onUpdate:modelValue":c=>u[e.name]=c,clearable:"",placeholder:"请选择",style:{width:"240px"},filterable:"",remote:"","remote-method":c=>be(c,e.name)},{default:t(()=>[(l(!0),h(z,null,j(_e.value[e.name],(c,ie)=>(l(),r(ae,{key:ie,label:c.instance_name,value:c.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","remote-method"])):(l(),r(V,{key:1},{default:t(()=>{var c;return[d(_((c=b.value.fields[e.name])==null?void 0:c.instance_name),1)]}),_:2},1024))]),_:2},1032,["label","prop","required"]))]),_:2},1024))),128))]),_:2},1024)]),_:2},1032,["name"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["model"])]),_:1}),n(de,{label:"监控信息",name:"monitor",disabled:""},{default:t(()=>[...p[9]||(p[9]=[d("111",-1)])]),_:1}),n(de,{label:"关联关系",name:"relations"},{default:t(()=>[b.value&&b.value.id?(l(),r(st,{key:0,ref:"ciDataRelationRef",instanceId:b.value.id,modelId:b.value.model},null,8,["instanceId","modelId"])):$("",!0)]),_:1}),n(de,{label:"变更记录",name:"changelog"},{default:t(()=>[b.value&&b.value.id?(l(),r(We,{key:0,ref_key:"ciDataAuditRef",ref:oe,instanceId:b.value.id},null,8,["instanceId"])):$("",!0)]),_:1})]),_:1},8,["modelValue"])])])}}}),xt=Ae(vt,[["__scopeId","data-v-0f2daf72"]]);export{xt as default};
