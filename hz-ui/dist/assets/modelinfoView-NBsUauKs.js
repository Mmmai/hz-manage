import{d as Oe,g as he,u as Le,h as Je,bw as sl,r,l as ee,a as _e,e as n,b7 as Ne,c as R,o as m,F as Z,i as q,b as e,w as l,p as oe,q as N,y as B,aL as nl,k as y,t as W,bQ as L,z as Te,bS as Ke,c6 as We,c7 as Ge,bH as ue,c3 as v,bY as ve,aK as Ce,_ as Ye,cc as Qe,c9 as il,f as dl,m as ul,n as rl,aP as ml,A as pl}from"./index-DD1IBG_Z.js";import{i as cl}from"./iconSelectCom-DEo1y1Ac.js";import{u as fl}from"./tabs-BSZuQCWf.js";import{l as Xe}from"./vue-draggable-plus-DvNx90ik.js";import{u as _l}from"./ci-CYlL_rRx.js";import"./keepAlive-xr462Oi2.js";const vl={class:"operation_show"},bl={class:"dialog-footer"},gl={class:"demo-drawer__content"},yl={style:{float:"left"}},wl={style:{float:"right",color:"var(--el-text-color-secondary)","font-size":"13px"}},Cl={class:"demo-drawer__footer"},Vl=Oe({__name:"ciModelField",props:{ciModelInfo:{},ciModelInfoModifiers:{}},emits:["update:ciModelInfo"],setup(me,{expose:P}){const{proxy:F}=he(),O=Le(),I=Je(),C=sl(me,"ciModelInfo"),z=r([]),J=r([]),M=r([]),H=ee(()=>{let a=[];return z.value.forEach(t=>{t.fields.forEach(c=>{c.type==="model_ref"&&a.push(c.ref_model)})}),a}),j=ee(()=>{var t;let a=[];return(t=M.value)==null||t.forEach(c=>{c.id!==C.value.id&&(H.value.indexOf(c.id)===-1?a.push({value:c.id,label:c.verbose_name,disabled:!1}):a.push({value:c.id,label:c.verbose_name,disabled:!0}))}),a}),D=()=>{d.default="",d.validation_rule="",d.type=="boolean"?d.default=!0:d.type=="enum"?b.value=!0:d.type=="string"&&(b.value=!1)},A=r([]),le=a=>{let t=JSON.parse(V.value[a].rule),c=[];Object.keys(t).forEach(g=>{c.push({value:g,label:t[g]})}),A.value=c},K=a=>{let t=JSON.parse(V.value[a].rule),c=[];Object.keys(t).forEach(g=>{c.push({value:g,label:t[g]})}),A.value=c,d.default!=A.value[0].value&&(d.default=A.value[0].value)},b=r(!1),u=ee(()=>d.type==="fromModel"),te=r([]),ae=async(a=null)=>{let t=await F.$api.getValidationRules({page:1,page_size:1e4,...a});te.value=t.data.results,t.data.results.forEach(c=>{V.value[c.id]=c})},V=r({}),_=ee(()=>{let a=[];return te.value.forEach(t=>{t.field_type==d.type&&a.push({value:t.id,label:t.verbose_name})}),a}),w=async a=>{var t,c;if(a!=null)C.value=a.model,z.value=a.field_groups,J.value=(t=a.field_groups)==null?void 0:t.map(g=>g.name);else{let g=await F.$api.getCiModel({},C.value.id);C.value=g.data.model,z.value=g.data.field_groups,J.value=(c=g.data.field_groups)==null?void 0:c.map(ye=>ye.name)}},p=r([]),i=r([]),x=async()=>{let a=await F.$api.getCiModelFieldType(),t=a.data.field_types;Object.keys(t).forEach(c=>{p.value.push({value:c,label:t[c]})}),i.value=a.data.limit_fields},h=async()=>{let a=await F.$api.getCiModel();M.value=a.data.results},T=_e({name:"",verbose_name:""}),se=(a,t,c)=>{console.log(t),i.value.includes(t)?c(new Error(`${i.value.join(",")}不能用!`)):c()},be=_e({name:[{required:!0,message:"请输入唯一标识",trigger:"blur"},{pattern:/^[a-z][\w\d]{4,20}$/,trigger:"blur",message:"以英文字符开头,可以使用英文,数字,下划线,长度4-20 "}],verbose_name:[{required:!0,message:"请输入组名称",trigger:"blur"}]}),S=r(),U=r(!1),re=a=>{U.value=!1,ne(a)},pe=r(!1),ie=r(""),$e=async a=>{a&&await a.validate(async(t,c)=>{if(t)if(pe.value){console.log(T);let g=await F.$api.addCiModelFieldGroup({model:C.value.id,create_user:O.state.username,update_user:O.state.username,...T});console.log(g),g.status=="201"?(v({type:"success",message:"添加成功"}),U.value=!1,ne(a),w()):v({showClose:!0,message:"添加失败:"+JSON.stringify(g.data),type:"error"})}else{let g=await F.$api.updateCiModelFieldGroup({id:ie.value,update_user:O.state.username,...T});console.log(g),g.status=="200"?(v({type:"success",message:"更新成功"}),U.value=!1,ne(a),w()):v({showClose:!0,message:"更新失败:"+JSON.stringify(g.data),type:"error"})}else console.log("error submit!",c)})},f=a=>{ve.confirm("是否确认关闭?").then(()=>{a(),ne(S.value)}).catch(()=>{})},o=r("新增"),Q=a=>{o.value="新增",Ce(()=>{}),U.value=!0,pe.value=!0},E=a=>{o.value="修改",U.value=!0,Ce(()=>{pe.value=!1,T.name=a.name,T.verbose_name=a.verbose_name,ie.value=a.id})},ge=a=>{ve.confirm("是否确认删除?","删除组",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{let t=await F.$api.deleteCiModelFieldGroup(a);t.status==204||t.status==200?(v({type:"success",message:"删除成功"}),await w()):v({type:"error",message:"删除失败"})}).catch(()=>{v({type:"info",message:"取消删除"})})},de=r(!1),d=_e({name:"",verbose_name:"",type:"string",required:!1,editable:!0,validation_rule:"",ref_model:"",description:"",default:"",unit:""}),je=_e({name:[{required:!0,message:"请输入唯一标识",trigger:"blur"},{pattern:/^[a-z][\w\d]{1,20}$/,trigger:"blur",message:"以英文字符开头,可以使用英文,数字,下划线,长度2-20 ",required:!0},{validator:se,trigger:"blur"}],verbose_name:[{required:!0,message:"请输入字段显示名称",trigger:"blur"}],type:[{required:!0,message:"字段类型",trigger:"blur"}],model_name:[{required:u,message:"请选择模型",trigger:"blur"}],validation_rule:[{required:b,message:"选择校验规则",trigger:""}]}),ce=r();r(!1);const fe=r(!1),Y=r({}),Fe=r(!0),Ve=a=>{de.value=!0,o.value="修改",fe.value=!0,Y.value=a,Fe.value=!1,Ce(()=>{Object.keys(a).forEach(t=>{d.hasOwnProperty(t)&&(d[t]=a[t])}),d.validation_rule===null?b.value=!1:b.value=!0})},Se=a=>{ne(a),console.log(d),de.value=!1},qe=a=>{o.value="新增",Y.value={},de.value=!0,Fe.value=!0,fe.value=!1,b.value=!1,Ce(()=>{ie.value=a.id})},ze=async a=>{a&&await a.validate(async(t,c)=>{if(t)if(Fe.value){let g=await F.$api.addCiModelField({model:C.value.id,model_field_group:ie.value,create_user:O.state.username,update_user:O.state.username,...d});console.log(g),g.status=="201"?(v({type:"success",message:"添加成功"}),de.value=!1,ne(a),w()):v({showClose:!0,message:"添加失败:"+JSON.stringify(g.data),type:"error"})}else{b.value||(d.validation_rule="");let g=await F.$api.updateCiModelField({id:Y.value.id,update_user:O.state.username,...d});console.log(g),g.status=="200"?(v({type:"success",message:"更新成功"}),de.value=!1,ne(a),w()):v({showClose:!0,message:"更新失败:"+JSON.stringify(g.data),type:"error"})}else console.log("error submit!",c)})},Be=a=>{ve.confirm("是否确认关闭?").then(()=>{a(),ne(ce.value),de.value=!1}).catch(()=>{})},Ae=a=>{ve.confirm("是否确认删除?","删除组",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await F.$api.deleteCiModelField(Y.value.id)).status==204?(v({type:"success",message:"删除成功"}),await w(),ne(ce.value),de.value=!1):v({type:"error",message:"删除失败"})}).catch(()=>{v({type:"info",message:"取消删除"})})},ne=a=>{a&&a.resetFields()},$=async(a,t)=>{if(a.oldIndex==a.newIndex)return;if(a.pullMode){console.log("跨组移动，在onAdd中触发");return}let c=await F.$api.updateCiModelField({id:a.data.id,order:a.newIndex+1});c.status=="200"?v({type:"success",message:"更新排序成功"}):v({showClose:!0,message:"更新排序失败:"+JSON.stringify(c.data),type:"error"}),w()},xe=async(a,t)=>{let c=await F.$api.updateCiModelField({id:a.data.id,order:a.newIndex+1,model_field_group:t.id});c.status=="200"?v({type:"success",message:"更新排序成功"}):v({showClose:!0,message:"更新排序失败:"+JSON.stringify(c.data),type:"error"}),w()};return P({getModelField:w,getCiModelList:h,getRules:ae,getModelFieldType:x}),(a,t)=>{const c=n("el-text"),g=n("el-button"),ye=n("el-tooltip"),el=n("el-space"),De=n("el-col"),Ze=n("el-row"),Pe=n("el-card"),ll=n("el-collapse-item"),tl=n("el-collapse"),ke=n("el-input"),X=n("el-form-item"),He=n("el-form"),al=n("el-dialog"),Re=n("el-switch"),Me=n("el-option"),Ie=n("el-select"),ol=n("el-drawer"),we=Ne("permission");return m(),R(Z,null,[q("div",null,[e(tl,{modelValue:J.value,"onUpdate:modelValue":t[0]||(t[0]=k=>J.value=k)},{default:l(()=>[(m(!0),R(Z,null,oe(z.value,(k,Ue)=>(m(),N(ll,{name:k.name,key:Ue},{title:l(()=>[e(c,{tag:"b",size:"large"},{default:l(()=>[y(W(k.verbose_name),1)]),_:2},1024),q("div",vl,[k.built_in?Te("",!0):(m(),N(el,{key:0},{default:l(()=>{var s;return[L((m(),N(ye,{class:"box-item",effect:"dark",content:"编辑",placement:"top"},{default:l(()=>{var G;return[L(e(g,{size:"small",onClick:Ke(Ee=>E(k),["stop"]),icon:B(We),circle:""},null,8,["onClick","icon"]),[[we,`${(G=B(I).name)==null?void 0:G.replace("_info","")}:edit`]])]}),_:2},1024)),[[we,`${(s=B(I).name)==null?void 0:s.replace("_info","")}:edit`]]),e(ye,{class:"box-item",effect:"dark",content:"删除",placement:"top"},{default:l(()=>{var G;return[L(e(g,{size:"small",onClick:Ke(Ee=>ge(k.id),["stop"]),icon:B(Ge),circle:""},null,8,["onClick","icon"]),[[we,`${(G=B(I).name)==null?void 0:G.replace("_info","")}:delete`]])]}),_:2},1024)]}),_:2},1024))])]),default:l(()=>[q("div",null,[e(B(Xe),{"force-fallback":!0,"scroll-sensitivity":200,ref_for:!0,ref:"el",group:"modelField",modelValue:k.fields,"onUpdate:modelValue":s=>k.fields=s,onEnd:s=>$(s,k),onAdd:s=>xe(s,k),style:{width:"100%","flex-wrap":"wrap",display:"flex",gap:"10px","justify-items":"flex-start"}},{default:l(()=>{var s;return[(m(!0),R(Z,null,oe(k.fields,(G,Ee)=>(m(),R("div",{key:Ee},[e(ye,{effect:"light",content:"点击编辑字段",placement:"top"},{default:l(()=>[e(Pe,{shadow:"hover",class:nl(["modelFieldCard",G.built_in?"isBuiltClass":""]),onClick:Dl=>Ve(G)},{default:l(()=>[e(c,{tag:"b"},{default:l(()=>[y(W(G.verbose_name),1)]),_:2},1024),e(Ze,{justify:"space-between"},{default:l(()=>[e(ye,{class:"box-item",effect:"light",content:G.name,placement:"bottom"},{default:l(()=>[e(De,{span:13,class:"describe-class"},{default:l(()=>[e(c,null,{default:l(()=>[y(W(G.name),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["content"]),e(ye,{class:"box-item",effect:"light",content:G.type,placement:"bottom"},{default:l(()=>[e(De,{span:10,class:"describe-class"},{default:l(()=>[e(c,null,{default:l(()=>[y(W(G.type),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["content"])]),_:2},1024)]),_:2},1032,["class","onClick"])]),_:2},1024)]))),128)),q("div",null,[L((m(),N(Pe,{class:"modelFieldCard",style:{"align-items":"center","justify-content":"center"},onClick:G=>qe(k)},{default:l(()=>[e(c,{type:"primary"},{default:l(()=>[...t[26]||(t[26]=[y("+ 添加字段",-1)])]),_:1})]),_:1},8,["onClick"])),[[we,`${(s=B(I).name)==null?void 0:s.replace("_info","")}:add`]])])]}),_:2},1032,["modelValue","onUpdate:modelValue","onEnd","onAdd"])])]),_:2},1032,["name"]))),128))]),_:1},8,["modelValue"]),e(Ze,{style:{"margin-top":"10px"}},{default:l(()=>[e(De,null,{default:l(()=>{var k;return[L((m(),N(g,{bg:"",text:"",onClick:t[1]||(t[1]=Ue=>Q(C.value))},{default:l(()=>[...t[27]||(t[27]=[y("添加分组",-1)])]),_:1})),[[we,`${(k=B(I).name)==null?void 0:k.replace("_info","")}:add`]])]}),_:1})]),_:1})]),e(al,{modelValue:U.value,"onUpdate:modelValue":t[6]||(t[6]=k=>U.value=k),title:o.value+"字段分组",width:"500","before-close":f},{footer:l(()=>[q("div",bl,[e(g,{onClick:t[4]||(t[4]=k=>re(S.value))},{default:l(()=>[...t[28]||(t[28]=[y("取消",-1)])]),_:1}),e(g,{type:"primary",onClick:t[5]||(t[5]=k=>$e(S.value))},{default:l(()=>[...t[29]||(t[29]=[y(" 确认 ",-1)])]),_:1})])]),default:l(()=>[e(He,{ref_key:"groupFormRef",ref:S,style:{"max-width":"600px"},model:T,rules:be,"label-width":"auto",class:"demo-modelForm","status-icon":""},{default:l(()=>[e(X,{label:"字段组标识",prop:"name"},{default:l(()=>[e(ke,{modelValue:T.name,"onUpdate:modelValue":t[2]||(t[2]=k=>T.name=k),disabled:!pe.value},null,8,["modelValue","disabled"])]),_:1}),e(X,{label:"字段分组名称",prop:"verbose_name"},{default:l(()=>[e(ke,{modelValue:T.verbose_name,"onUpdate:modelValue":t[3]||(t[3]=k=>T.verbose_name=k)},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"]),e(ol,{modelValue:de.value,"onUpdate:modelValue":t[25]||(t[25]=k=>de.value=k),title:"模型字段","before-close":Be,direction:"rtl",class:"demo-drawer"},{default:l(()=>{var k,Ue;return[q("div",gl,[e(He,{model:d,ref_key:"modelFieldFormRef",ref:ce,"label-width":"auto","label-position":"right",rules:je},{default:l(()=>[e(X,{label:"唯一标识",prop:"name"},{default:l(()=>[e(ke,{modelValue:d.name,"onUpdate:modelValue":t[7]||(t[7]=s=>d.name=s),autocomplete:"off",disabled:!!(Y.value.built_in||fe.value)},null,8,["modelValue","disabled"])]),_:1}),e(X,{label:"显示名称",prop:"verbose_name"},{default:l(()=>[e(ke,{modelValue:d.verbose_name,"onUpdate:modelValue":t[8]||(t[8]=s=>d.verbose_name=s),autocomplete:"off"},null,8,["modelValue"])]),_:1}),e(X,{label:"可编辑",prop:"editable"},{default:l(()=>[e(Re,{modelValue:d.editable,"onUpdate:modelValue":t[9]||(t[9]=s=>d.editable=s),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},disabled:Y.value.built_in},null,8,["modelValue","disabled"])]),_:1}),e(X,{label:"必填",prop:"required"},{default:l(()=>[e(Re,{modelValue:d.required,"onUpdate:modelValue":t[10]||(t[10]=s=>d.required=s),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"}},null,8,["modelValue"])]),_:1}),e(X,{label:"字段类型",prop:"type"},{default:l(()=>[e(Ie,{modelValue:d.type,"onUpdate:modelValue":t[11]||(t[11]=s=>d.type=s),placeholder:"Select",style:{width:"240px"},onChange:D,disabled:!!(Y.value.built_in||fe.value)},{default:l(()=>[(m(!0),R(Z,null,oe(p.value,s=>(m(),N(Me,{key:s.value,label:s.label,value:s.value},{default:l(()=>[q("span",yl,W(s.label),1),q("span",wl,W(s.value),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),L(e(X,{label:"校验规则",prop:"validation_rule"},{default:l(()=>[e(Re,{modelValue:b.value,"onUpdate:modelValue":t[12]||(t[12]=s=>b.value=s),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949","margin-right":"10px"}},null,8,["modelValue"]),L(e(Ie,{modelValue:d.validation_rule,"onUpdate:modelValue":t[13]||(t[13]=s=>d.validation_rule=s),placeholder:"选择校验规则",style:{width:"240px"}},{default:l(()=>[(m(!0),R(Z,null,oe(_.value,s=>(m(),N(Me,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),[[ue,b.value]])]),_:1},512),[[ue,d.type==="string"]]),L(e(X,{label:"枚举值",prop:"validation_rule"},{default:l(()=>[e(Ie,{modelValue:d.validation_rule,"onUpdate:modelValue":t[14]||(t[14]=s=>d.validation_rule=s),placeholder:"选择校验规则",style:{width:"240px"},onChange:t[15]||(t[15]=s=>K(d.validation_rule))},{default:l(()=>[(m(!0),R(Z,null,oe(_.value,s=>(m(),N(Me,{key:s.value,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},512),[[ue,d.type==="enum"]]),L(e(X,{label:"默认值",prop:"default"},{default:l(()=>[e(Ie,{modelValue:d.default,"onUpdate:modelValue":t[16]||(t[16]=s=>d.default=s),placeholder:"选择默认值",size:"large",onVisibleChange:t[17]||(t[17]=s=>le(d.validation_rule))},{default:l(()=>[(m(!0),R(Z,null,oe(A.value,(s,G)=>(m(),N(Me,{key:G,label:s.label,value:s.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},512),[[ue,d.type==="enum"]]),L(e(X,{label:"模型引用",prop:"ref_model"},{default:l(()=>[e(Ie,{modelValue:d.ref_model,"onUpdate:modelValue":t[18]||(t[18]=s=>d.ref_model=s),placeholder:"选择CI模型",disabled:!!(Y.value.built_in||fe.value)},{default:l(()=>[(m(!0),R(Z,null,oe(j.value,s=>(m(),N(Me,{key:s.value,label:s.label,disabled:s.disabled,value:s.value},null,8,["label","disabled","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1},512),[[ue,d.type==="model_ref"]]),L(e(X,{label:"默认值",prop:"default"},{default:l(()=>[e(Re,{modelValue:d.default,"onUpdate:modelValue":t[19]||(t[19]=s=>d.default=s),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"}},null,8,["modelValue"])]),_:1},512),[[ue,d.type==="boolean"]]),L(e(X,{label:"单位",prop:"unit"},{default:l(()=>[e(ke,{modelValue:d.unit,"onUpdate:modelValue":t[20]||(t[20]=s=>d.unit=s),style:{width:"120px"}},null,8,["modelValue"])]),_:1},512),[[ue,d.type==="integer"||d.type==="float"]]),e(X,{label:"描述",prop:"description"},{default:l(()=>[e(ke,{modelValue:d.description,"onUpdate:modelValue":t[21]||(t[21]=s=>d.description=s),type:"textarea"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),q("div",Cl,[e(g,{onClick:t[22]||(t[22]=s=>Se(ce.value))},{default:l(()=>[...t[30]||(t[30]=[y("取消",-1)])]),_:1}),fe.value&&!Y.value.built_in?L((m(),N(g,{key:0,type:"danger",onClick:t[23]||(t[23]=s=>Ae())},{default:l(()=>[...t[31]||(t[31]=[y("删除",-1)])]),_:1})),[[we,`${(k=B(I).name)==null?void 0:k.replace("_info","")}:delete`]]):Te("",!0),L((m(),N(g,{type:"primary",onClick:t[24]||(t[24]=s=>ze(ce.value))},{default:l(()=>[...t[32]||(t[32]=[y(" 确定 ",-1)])]),_:1})),[[we,`${(Ue=B(I).name)==null?void 0:Ue.replace("_info","")}:edit`]])])])]}),_:1},8,["modelValue"])],64)}}}),xl=Ye(Vl,[["__scopeId","data-v-dd914ec8"]]),kl={style:{width:"100%"}},$l={class:"table-header"},Fl={class:"header-button-lf"},Ml={class:"dialog-footer"},Il=Oe({__name:"ciModelUnique",props:["modelId","modelFieldLists"],setup(me,{expose:P}){const F=Je(),{proxy:O}=he(),I=Le(),C=r([]),z=me,J=()=>{D.value=!0,le.value=!0};ee(()=>{let p={};return z.modelFieldLists.forEach(i=>{p[i.name]=i.verbose_name}),p});const M=ee(()=>{let p={};return z.modelFieldLists.forEach(i=>{p[i.id]=i.verbose_name}),p}),H=r(""),j=_e({fields:[],validate_null:!1,description:null}),D=r(!1),A=()=>{D.value=!1,u(H.value)},le=r(!0),K=r({}),b=p=>{K.value=p,D.value=!0,le.value=!1,Ce(()=>{Object.keys(p).forEach(i=>{i!=="id"&&Object.keys(j).indexOf(i)!==-1&&(j[i]=p[i])})})},u=p=>{p&&(p.resetFields(),K.value={})},te=async p=>{await p.validate(async(i,x)=>{if(i)if(le.value){let h=await O.$api.addCiModelUnique({create_user:I.state.username,update_user:I.state.username,...j,model:z.modelId});h.status=="201"?(v({type:"success",message:"添加成功"}),D.value=!1,u(p),w({model:z.modelId})):v({showClose:!0,message:"添加失败:"+JSON.stringify(h.data),type:"error"})}else{let h=await O.$api.updateCiModelUnique({id:K.value.id,update_user:I.state.username,...j});h.status=="200"?(v({type:"success",message:"更新成功"}),D.value=!1,u(p),w({model:z.modelId})):v({showClose:!0,message:"更新失败:"+JSON.stringify(h.data),type:"error"})}})},ae=async p=>{let i=await O.$api.updateCiModelUnique({update_user:I.state.username,...p});i.status=="200"?(v({type:"success",message:"更新成功"}),u(H.value),w({model:z.modelId})):v({showClose:!0,message:"更新失败:"+JSON.stringify(i.data),type:"error"})},V=p=>{ve.confirm("是否确认删除?","删除",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await O.$api.deleteCiModelUnique(p)).status==204?(v({type:"success",message:"删除成功"}),w({model:z.modelId}),u(H.value),D.value=!1):v({type:"error",message:"删除失败"})}).catch(()=>{v({type:"info",message:"取消删除"})})},_=ee(()=>{let p={};return C.value.forEach(i=>{var h;let x=i.fields.map(T=>M.value[T]);p[(h=i.fields)==null?void 0:h.join("+")]=x.join("+")}),p}),w=async p=>{let i=await O.$api.getCiModelUnique(p);C.value=i.data.results};return P({getTableData:w}),(p,i)=>{const x=n("el-button"),h=n("el-table-column"),T=n("el-switch"),se=n("el-tooltip"),be=n("el-table"),S=n("el-option"),U=n("el-select"),re=n("el-form-item"),pe=n("el-input"),ie=n("el-form"),$e=n("el-dialog"),f=Ne("permission");return m(),R("div",kl,[q("div",$l,[q("div",Fl,[e(x,{type:"primary",onClick:J},{default:l(()=>[...i[5]||(i[5]=[y("添加",-1)])]),_:1})])]),e(be,{ref:"multipleTableRef",data:C.value,style:{width:"100%"},border:""},{default:l(()=>[e(h,{prop:"fields",label:"校验规则"},{default:l(o=>[q("span",null,W(_.value[o.row.fields.join("+")]),1)]),_:1}),e(h,{prop:"validate_null",label:"空值校验"},{default:l(o=>{var Q;return[L(e(T,{modelValue:o.row.validate_null,"onUpdate:modelValue":E=>o.row.validate_null=E,class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},onChange:E=>ae({id:o.row.id,validate_null:o.row.validate_null}),disabled:o.row.built_in},null,8,["modelValue","onUpdate:modelValue","onChange","disabled"]),[[f,{id:`${(Q=B(F).name)==null?void 0:Q.replace("_info","")}:edit`,action:"disabled"}]])]}),_:1}),e(h,{prop:"description",label:"描述"}),e(h,{fixed:"right",width:"100",label:"操作"},{default:l(o=>[e(se,{class:"box-item",effect:"dark",content:"编辑",placement:"top"},{default:l(()=>{var Q;return[L(e(x,{link:"",type:"primary",icon:B(We),onClick:E=>b(o.row)},null,8,["icon","onClick"]),[[f,`${(Q=B(F).name)==null?void 0:Q.replace("_info","")}:edit`]])]}),_:2},1024),e(se,{class:"box-item",effect:"dark",content:"删除",placement:"top"},{default:l(()=>{var Q;return[L(e(x,{link:"",type:"danger",icon:B(Ge),disabled:o.row.built_in,onClick:E=>V(o.row.id)},null,8,["icon","disabled","onClick"]),[[f,`${(Q=B(F).name)==null?void 0:Q.replace("_info","")}:delete`]])]}),_:2},1024)]),_:1})]),_:1},8,["data"]),e($e,{modelValue:D.value,"onUpdate:modelValue":i[4]||(i[4]=o=>D.value=o),title:"唯一校验配置",width:"500","before-close":A},{footer:l(()=>[q("div",Ml,[e(x,{onClick:A},{default:l(()=>[...i[6]||(i[6]=[y("取消",-1)])]),_:1}),e(x,{type:"primary",onClick:i[3]||(i[3]=o=>te(H.value))},{default:l(()=>[...i[7]||(i[7]=[y(" 提交 ",-1)])]),_:1})])]),default:l(()=>[e(ie,{inline:!0,"label-position":"right",model:j,"label-width":"auto",ref_key:"formRef",ref:H},{default:l(()=>[e(re,{label:"唯一校验组合",prop:"fields"},{default:l(()=>[e(U,{modelValue:j.fields,"onUpdate:modelValue":i[0]||(i[0]=o=>j.fields=o),fields:"选择字段组合",multiple:"","multiple-limit":5,clearable:"",filterable:"",style:{width:"240px"},disabled:!!K.value.built_in},{default:l(()=>[(m(!0),R(Z,null,oe(z.modelFieldLists,(o,Q)=>(m(),N(S,{label:o.verbose_name,value:o.id,key:Q},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),e(re,{label:"空置校验",prop:"validate_null"},{default:l(()=>[e(T,{modelValue:j.validate_null,"onUpdate:modelValue":i[1]||(i[1]=o=>j.validate_null=o),class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},disabled:K.value.built_in},null,8,["modelValue","disabled"])]),_:1}),e(re,{label:"描述",prop:"description"},{default:l(()=>[e(pe,{modelValue:j.description,"onUpdate:modelValue":i[2]||(i[2]=o=>j.description=o),style:{width:"240px"},autosize:{minRows:2,maxRows:4},type:"textarea",disabled:!!K.value.built_in},null,8,["modelValue","disabled"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Ul={class:"card"},Ol={class:"listItem"},hl={style:{display:"flex","flex-direction":"row","justify-content":"center","align-items":"center"}},Sl=Oe({__name:"ciModelTemplateName",props:["modelId","modelFieldLists","ciModelInfo"],setup(me,{expose:P}){const{proxy:F}=he();Le();const O=me,I=r(!1),C=r([]),z=b=>{},J=ee(()=>O.modelFieldLists.filter(b=>["string","enum","model_ref"].includes(b.type))),M=ee(()=>{let b=new Object;return O.modelFieldLists.forEach(u=>{b[u.id]=u}),b}),H=()=>{},j=()=>{I.value=!0},D=()=>{I.value=!1},A=async()=>{let b=await F.$api.updateInstanceName(O.modelId);console.log(b),b.status=="200"?Qe({title:"Success",message:"更新任务提交成功",type:"success"}):Qe({title:"Error",message:`更新任务提交失败${JSON.stringify(b.data)}`,type:"error"})};r(0);const le=async()=>{let b=await F.$api.updateCiModel({id:O.modelId,instance_name_template:C.value});b.status=="200"?(v({type:"success",message:"更新成功"}),ve.confirm("更新成功，是否自动更新实例唯一标识?","Warning",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{A()}).catch(()=>{v({type:"info",message:"Delete canceled"})}),I.value=!1,K()):v({showClose:!0,message:"更新失败:"+JSON.stringify(b.data),type:"error"})},K=async()=>{let b=await F.$api.getCiModel(null,O.modelId);C.value=b.data.model.instance_name_template};return P({getModel:K}),(b,u)=>{const te=n("el-button"),ae=n("el-divider"),V=n("el-checkbox"),_=n("el-checkbox-group"),w=Ne("throttle");return m(),R(Z,null,[u[9]||(u[9]=q("div",null,null,-1)),q("div",Ul,[L(e(te,{type:"primary",onClick:j},{default:l(()=>[...u[2]||(u[2]=[y("编辑",-1)])]),_:1},512),[[ue,!I.value]]),L((m(),N(te,{type:"primary",onClick:A},{default:l(()=>[...u[3]||(u[3]=[y("更新唯一标识",-1)])]),_:1})),[[w]]),L(e(te,{onClick:D},{default:l(()=>[...u[4]||(u[4]=[y("取消",-1)])]),_:1},512),[[ue,I.value]]),L(e(te,{type:"primary",onClick:le},{default:l(()=>[...u[5]||(u[5]=[y("保存",-1)])]),_:1},512),[[ue,I.value]]),e(ae,null,{default:l(()=>[...u[6]||(u[6]=[y("可选择指标",-1)])]),_:1}),e(_,{modelValue:C.value,"onUpdate:modelValue":u[0]||(u[0]=p=>C.value=p),onChange:z,max:5,disabled:!I.value},{default:l(()=>[(m(!0),R(Z,null,oe(J.value,(p,i)=>(m(),N(V,{key:i,label:p.verbose_name,value:p.id},{default:l(()=>[y(W(p.verbose_name),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),e(ae,null,{default:l(()=>[...u[7]||(u[7]=[y("拖拽调整顺序",-1)])]),_:1}),e(B(Xe),{disabled:!I.value,modelValue:C.value,"onUpdate:modelValue":u[1]||(u[1]=p=>C.value=p),"force-fallback":!0,"scroll-sensitivity":200,ref:"el",onEnd:H,style:{width:"100%",overflow:"auto"}},{default:l(()=>[(m(!0),R(Z,null,oe(C.value,(p,i)=>(m(),R("div",{key:i},[q("div",Ol,[q("span",null,W(M.value[p].verbose_name),1)])]))),128))]),_:1},8,["disabled","modelValue"]),e(ae,null,{default:l(()=>[...u[8]||(u[8]=[y("效果预览",-1)])]),_:1}),q("div",hl,[q("h3",null,W(C.value.map(p=>M.value[p].verbose_name).join(" - ")),1)])])],64)}}}),Rl={class:"card"},Tl={key:1},Ll={key:1},Nl={key:0,class:"flexCenter",style:{width:"50%","margin-top":"10px"}},jl={key:1,class:"flexCenter",style:{width:"50%","margin-top":"10px"}},ql=Oe({__name:"ciModelConfig",props:["modelId","modelFieldLists","ciModelInfo"],setup(me,{expose:P}){const{proxy:F}=he(),O=me,I=r({}),C=r(!1),z=()=>{C.value=!0};ee(()=>M.zabbix_sync_info.some(V=>V.isEditing));const J=ee(()=>O.modelFieldLists.some(V=>V.name==="ip"));r(!1);const M=_e({zabbix_sync_info:[],is_manage:!1,built_in:!1}),H=r([{value:"agent",label:"agent"},{value:"ipmi",label:"ipmi"},{value:"snmp",label:"snmp"}]),j=r([]),D=V=>{const _=M.zabbix_sync_info.map(w=>w.type).filter(w=>w);return H.value.map(w=>({...w,disabled:_.includes(w.value)}))},A=()=>{if(D().filter(_=>!_.disabled).length===0){v({type:"warning",message:"所有接口类型都已配置，无法添加更多配置"});return}M.zabbix_sync_info.push({type:"",template:""})},le=V=>{M.zabbix_sync_info.splice(V,1)},K=()=>{C.value=!1,Ce(()=>{u()})},b=r(null),u=async()=>{const V=await F.$api.getModelConfig({model:O.modelId});if(V.status==200&&(I.value=V.data.results,V.data.results&&V.data.results.length>0)){const _=V.data.results[0];b.value=_.id,M.is_manage=_.is_manage,M.built_in=_.built_in,M.zabbix_sync_info=_.zabbix_sync_info.map(w=>({...w}))}},te=async()=>{let V=await F.$api.getZabbixTemplate();console.log(V),V.status==200?j.value=V.data.data:v({type:"error",message:`添加失败: ${JSON.stringify(V.data)}`})},ae=async()=>{if(!J.value){v({type:"error",message:"模型不存在名称为IP的模型字段，请先配置IP字段"});return}const V={...M,zabbix_sync_info:M.zabbix_sync_info.filter(w=>w.type)};let _=await F.$api.updateModelConfig({id:b.value,...V});_.status==200?(v({type:"success",message:"保存成功"}),C.value=!1,u()):v({type:"error",message:`保存失败: ${JSON.stringify(_.data)}`})};return P({getConfigData:u,getZabbixTemplates:te}),(V,_)=>{const w=n("el-switch"),p=n("el-form-item"),i=n("el-option"),x=n("el-select"),h=n("el-table-column"),T=n("el-button"),se=n("el-table"),be=n("el-form");return m(),R("div",Rl,[e(be,{model:M},{default:l(()=>[e(p,{label:"启用管理"},{default:l(()=>[e(w,{disabled:!C.value,modelValue:M.is_manage,"onUpdate:modelValue":_[0]||(_[0]=S=>M.is_manage=S),class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"}},null,8,["disabled","modelValue"])]),_:1}),M.is_manage?(m(),N(se,{key:0,data:M.zabbix_sync_info,style:{width:"50%"},border:""},{default:l(()=>[e(h,{label:"接口类型",width:"150"},{default:l(S=>[C.value?(m(),N(x,{key:0,modelValue:S.row.type,"onUpdate:modelValue":U=>S.row.type=U,filterable:"",placeholder:"接口类型",style:{width:"120px"}},{default:l(()=>[(m(!0),R(Z,null,oe(D(S.$index),U=>(m(),N(i,{key:U.value,label:U.label,value:U.value,disabled:U.disabled},null,8,["label","value","disabled"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):(m(),R("span",Tl,W(S.row.type),1))]),_:1}),e(h,{label:"接口模板"},{default:l(S=>[C.value?(m(),N(x,{key:0,modelValue:S.row.template,"onUpdate:modelValue":U=>S.row.template=U,filterable:"",placeholder:"模板",style:{width:"400px"}},{default:l(()=>[(m(!0),R(Z,null,oe(j.value,U=>(m(),N(i,{key:U.value,label:U.label,value:U.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"])):(m(),R("span",Ll,W(S.row.template),1))]),_:1}),C.value?(m(),N(h,{key:0,label:"操作",width:"100"},{header:l(()=>[e(T,{onClick:A,icon:B(il)},{default:l(()=>[..._[4]||(_[4]=[y("添加",-1)])]),_:1},8,["icon"])]),default:l(S=>[e(T,{type:"danger",icon:B(Ge),link:"",onClick:U=>le(S.$index),disabled:M.built_in},{default:l(()=>[..._[5]||(_[5]=[y("删除",-1)])]),_:1},8,["icon","onClick","disabled"])]),_:1})):Te("",!0)]),_:1},8,["data"])):Te("",!0)]),_:1},8,["model"]),C.value?(m(),R("div",Nl,[e(T,{onClick:_[1]||(_[1]=S=>K())},{default:l(()=>[..._[6]||(_[6]=[y("取消",-1)])]),_:1}),e(T,{type:"primary",onClick:_[2]||(_[2]=S=>ae())},{default:l(()=>[..._[7]||(_[7]=[y("保存",-1)])]),_:1})])):(m(),R("div",jl,[e(T,{onClick:_[3]||(_[3]=S=>z())},{default:l(()=>[..._[8]||(_[8]=[y("编辑",-1)])]),_:1})]))])}}}),zl={class:"card"},Bl={class:"dialog-footer"},Al=Oe({__name:"modelinfoView",setup(me){const P=Je(),F=fl(),O=_l(),I=()=>{j.push({path:"/cmdb/cimodelManage/model"})},C=()=>{O.setCiLastModel(u.value.id),console.log(ee(()=>O.ciLastModel).value),Ce(()=>{j.push({path:"/cmdb/cidata"})})},z=r(""),J=r(""),M=r(""),H=r(""),j=dl(),D=Le(),{proxy:A}=he();r("");const le=r([]),K=async()=>{let f=await A.$api.getCiModelGroup();console.log(f),le.value=f.data.results,console.log(le.value)},b=r({}),u=r({}),te=async()=>{let f=await A.$api.getCiModel({},ie.value);u.value=f.data.model,b.value=f.data,console.log(u.value)},ae=ee(()=>!b.value||!b.value.field_groups?[]:b.value.field_groups.flatMap(f=>f.fields||[])),V=(f,o)=>{f.props.name==="verification"?z.value.getTableData({model:i.value}):f.props.name==="field"||(f.props.name==="instance_name_temp"?M.value.getModel():f.props.name==="model_node_sync"&&(H.value.getConfigData(),H.value.getZabbixTemplates()))},_=r("field");console.log(P);const w=r(!1),p=()=>{w.value=!0};r("ElemeFilled");const i=ee(()=>{var f;return(f=u.value)==null?void 0:f.id}),x=_e({name:"",verbose_name:"",model_group:"",icon:"ElemeFilled",built_in:!1,update_user:"admin"}),h=r(),T=_e({name:[{required:!0,message:"请输入模型标识",trigger:"blur"},{pattern:/^[a-z][a-z_]{3,20}$/,trigger:"blur",message:"以英文字符开头,可以使用英文,下划线,长度3-20 ",required:!0}],verbose_name:[{required:!0,message:"请输入模型名称",trigger:"blur"}],model_group:[{required:!0,message:"请选择分组",trigger:"blur"}]});r(!1);const se=r(!1),be=f=>{se.value=!1,re(f)},S=async f=>{f&&await f.validate(async(o,Q)=>{if(o){let E=await A.$api.updateCiModel({id:ie.value,...x});console.log(E),E.status=="200"?(v({type:"success",message:"更新成功"}),se.value=!1,re(f),getCiModelInfo(P.query,P.query.id)):v({showClose:!0,message:"添加失败:"+JSON.stringify(E.data),type:"error"})}})},U=f=>{ve.confirm("是否确认关闭?").then(()=>{f(),re(h.value)}).catch(()=>{})},re=f=>{f&&f.resetFields()},pe=f=>{ve.confirm("是否确认删除?","删除组",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await A.$api.deleteCiModel(f)).status==204?(v({type:"success",message:"删除成功"}),F.removeTabs(P.path,!0)):v({type:"error",message:"删除失败"})}).catch(()=>{v({type:"info",message:"取消删除"})})},ie=r(""),$e=f=>{console.log(f),x.icon=f.icon,x.verbose_name=f.verbose_name,x.name=f.name,x.model_group=f.model_group,x.update_user=D.state.username,console.log(x),se.value=!0,ie.value=f.id,K()};return ul(async()=>{ie.value=P.path.split("/").at(-1),await te(),await J.value.getModelField(b.value),await J.value.getCiModelList(),await J.value.getRules(),await J.value.getModelFieldType()}),rl(()=>{console.log("onUnmounted")}),ml(()=>{console.log("onBeforeMount")}),(f,o)=>{const Q=pl,E=n("el-button"),ge=n("el-text"),de=n("el-link"),d=n("el-space"),je=n("el-page-header"),ce=n("el-col"),fe=n("el-row"),Y=n("el-tab-pane"),Fe=n("el-tabs"),Ve=n("el-form-item"),Se=n("el-input"),qe=n("el-option"),ze=n("el-select"),Be=n("el-form"),Ae=n("el-dialog"),ne=Ne("permission");return m(),R(Z,null,[q("div",zl,[e(fe,{class:"cimodelinfo",justify:"space-between"},{default:l(()=>[e(ce,{span:20},{default:l(()=>[e(je,{onBack:I},{content:l(()=>[e(d,{size:30},{default:l(()=>[e(E,{size:"large",circle:"",disabled:"",style:{margin:"10px"}},{default:l(()=>{var $;return[e(Q,{icon:($=u.value)==null?void 0:$.icon},null,8,["icon"])]}),_:1}),e(ge,null,{default:l(()=>[o[12]||(o[12]=y("唯一标识:   ",-1)),e(ge,{tag:"b"},{default:l(()=>[y(W(u.value.name),1)]),_:1})]),_:1}),e(ge,null,{default:l(()=>[o[13]||(o[13]=y("名称:   ",-1)),e(ge,{tag:"b"},{default:l(()=>[y(W(u.value.verbose_name),1)]),_:1})]),_:1}),e(ge,{style:{display:"flex"}},{default:l(()=>[o[14]||(o[14]=y("实例数:   ",-1)),e(de,{type:"primary",tag:"b",onClick:o[0]||(o[0]=$=>C())},{default:l(()=>[y(W(u.value.instance_count),1)]),_:1})]),_:1})]),_:1})]),_:1})]),_:1}),e(ce,{span:2,style:{display:"flex","align-items":"center","justify-content":"center"}},{default:l(()=>[e(d,{alignment:"flex-end"},{default:l(()=>{var $,xe;return[L(e(E,{disabled:u.value.built_in,icon:"Delete",onClick:o[1]||(o[1]=a=>pe(u.value.id)),circle:""},null,8,["disabled"]),[[ne,`${($=B(P).name)==null?void 0:$.replace("_info","")}:delete`]]),L(e(E,{disabled:u.value.built_in,icon:"Edit",onClick:o[2]||(o[2]=a=>$e(u.value)),circle:""},null,8,["disabled"]),[[ne,`${(xe=B(P).name)==null?void 0:xe.replace("_info","")}:edit`]])]}),_:1})]),_:1})]),_:1}),e(Fe,{modelValue:_.value,"onUpdate:modelValue":o[3]||(o[3]=$=>_.value=$),type:"card",class:"demo-tabs",onTabClick:V},{default:l(()=>[e(Y,{label:"模型字段",name:"field"},{default:l(()=>[e(xl,{ref_key:"ciModelFieldRef",ref:J},null,512)]),_:1}),e(Y,{label:"唯一校验",name:"verification"},{default:l(()=>[e(Il,{modelId:i.value,modelFieldLists:ae.value,ref_key:"ciModelUniqueRef",ref:z},null,8,["modelId","modelFieldLists"])]),_:1}),e(Y,{label:"唯一标识命名",name:"instance_name_temp"},{default:l(()=>[e(Sl,{modelId:i.value,ciModelInfo:u.value,modelFieldLists:ae.value,ref_key:"ciModelTemplateRef",ref:M},null,8,["modelId","ciModelInfo","modelFieldLists"])]),_:1}),e(Y,{label:"同步管理",name:"model_node_sync"},{default:l(()=>[e(ql,{modelId:i.value,modelFieldLists:ae.value,ref_key:"ciModelConfigRef",ref:H},null,8,["modelId","modelFieldLists"])]),_:1})]),_:1},8,["modelValue"])]),e(Ae,{modelValue:se.value,"onUpdate:modelValue":o[11]||(o[11]=$=>se.value=$),title:"编辑模型",width:"500","before-close":U},{footer:l(()=>[q("div",Bl,[e(E,{onClick:o[9]||(o[9]=$=>be(h.value))},{default:l(()=>[...o[15]||(o[15]=[y("取消",-1)])]),_:1}),e(E,{type:"primary",onClick:o[10]||(o[10]=$=>S(h.value))},{default:l(()=>[...o[16]||(o[16]=[y(" 确认 ",-1)])]),_:1})])]),default:l(()=>[e(Be,{ref_key:"modelFormRef",ref:h,style:{"max-width":"600px"},model:x,rules:T,"label-width":"auto",class:"demo-modelForm","status-icon":""},{default:l(()=>[e(Ve,{label:"模型图标",prop:"icon"},{default:l(()=>[e(E,{onClick:p,icon:x.icon},null,8,["icon"]),e(cl,{isShow:w.value,"onUpdate:isShow":o[4]||(o[4]=$=>w.value=$),iconName:x.icon,"onUpdate:iconName":o[5]||(o[5]=$=>x.icon=$)},null,8,["isShow","iconName"])]),_:1}),e(Ve,{label:"唯一标识",prop:"name"},{default:l(()=>[e(Se,{modelValue:x.name,"onUpdate:modelValue":o[6]||(o[6]=$=>x.name=$),placeholder:"请输入模型的唯一标识",disabled:""},null,8,["modelValue"])]),_:1}),e(Ve,{label:"模型名称",prop:"verbose_name"},{default:l(()=>[e(Se,{modelValue:x.verbose_name,"onUpdate:modelValue":o[7]||(o[7]=$=>x.verbose_name=$)},null,8,["modelValue"])]),_:1}),e(Ve,{label:"所属分组",prop:"model_group"},{default:l(()=>[e(ze,{modelValue:x.model_group,"onUpdate:modelValue":o[8]||(o[8]=$=>x.model_group=$),placeholder:"选择分组"},{default:l(()=>[(m(!0),R(Z,null,oe(le.value,($,xe)=>(m(),N(qe,{label:$.verbose_name,value:$.id,key:xe},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])],64)}}}),Kl=Ye(Al,[["__scopeId","data-v-e364b8a2"]]);export{Kl as default};
