import{d as Re,u as $e,r as u,b as ze,M as z,bI as ue,c as Fe,aN as Ne,e as i,b3 as Je,o as s,f as c,h as F,bO as Z,bo as x,O as p,w as r,j as A,g as n,F as N,b1 as J,i as De,c0 as Te,c1 as qe,c2 as Be,P as re,c3 as Ee,k as Me,aD as ie,c4 as y,bV as Ae}from"./index-D4V34ywu.js";const Pe={class:"card"},Ke={class:"table-header"},Le={class:"header-button-lf"},We={class:"header-button-ri"},Ge={key:0},He={key:0},Qe={key:4},Xe={key:0,class:"flexJstart"},Ye={class:"dialog-footer"},el=Re({__name:"ciConfigView",setup(Ze){const{proxy:k}=Me(),P=$e(),I=u([]),K=ze(),L=u("verbose_name"),W=u(""),de=z(()=>({[L.value]:W.value})),D=u(null),pe=z(()=>{if(D.value===null)return!0;var l=RegExp(a.rule);return!!l.test(D.value)}),V=u([{name:"",value:""}]),T=z(()=>{let l={};return V.value.forEach(e=>{e.name!==""&&e.value!==""&&(l[e.name]=e.value)}),l}),ee=z(()=>k.$commonFunc.hasDuplicates(Object.keys(T.value))||k.$commonFunc.hasDuplicates(Object.values(T.value)));ue(()=>T.value,l=>{Object.keys(l).length!==0&&(a.rule=JSON.stringify(T.value))});const ce=l=>{V.value.splice(l+1,0,{name:"",value:""})},ve=l=>{V.value.splice(l,1),console.log(V.value)},le=u([{value:"name",label:"规则名",sort:!0,filter:!0,type:"string",required:!0},{value:"verbose_name",label:"规则名称",sort:!1,filter:!0,type:"string",required:!0},{value:"field_type",label:"字段类型",sort:!0,filter:!0,type:"object",required:!0},{value:"type",label:"规则类型",sort:!0,filter:!0,type:"object"},{value:"rule",label:"规则内容",sort:!1,filter:!0,type:"string"},{value:"description",label:"描述",sort:!1,filter:!1,type:"text"}]),fe=z(()=>{let l=[];return le.value.forEach(e=>{e.filter&&l.push({name:e.label,value:e.value})}),l}),q=u(""),a=Fe({name:null,verbose_name:null,field_type:"string",type:"regex",rule:null,description:null});ue(()=>a.field_type,l=>{a.type=Q.value[l][0].type},{deep:!0});const G=u(1),H=u(10),me=u("default"),ye=u(!1),te=u(0),be=()=>{b()},_e=()=>{b()},U=u({ordering:"-update_time"}),ge=l=>{U.value={ordering:"-update_time"},l.order==="ascending"?U.value.ordering=l.prop:l.order==="descending"?U.value.ordering="-"+l.prop:U.value={ordering:"-update_time"},b()},v=u(!1),ae=()=>{v.value=!1,O(q.value),h.value={}},C=u(!0),Ve=()=>{C.value=!0,ie(()=>{v.value=!0})},h=u({}),B=u({}),ke=l=>{h.value=l,v.value=!0,C.value=!1,ie(()=>{if(Object.keys(l).forEach(e=>{e!=="id"&&(a[e]=l[e])}),l.field_type==="enum"){let e=[];Object.keys(JSON.parse(l.rule)).forEach(d=>{e.push({name:d,value:JSON.parse(l.rule)[d]})}),V.value=e}B.value=JSON.parse(JSON.stringify(a)),console.log(B.value)})},O=l=>{l&&(l.resetFields(),V.value=[{name:"",value:""}])},oe=u([]),Q=u([]),b=async(l=null)=>{let e=await k.$api.getValidationRules({page:G.value,page_size:H.value,...de.value,...U.value,...l});I.value=e.data.results,te.value=e.data.count},he=async()=>{let l=await k.$api.getCiModelFieldType();Q.value=l.data.field_validations;let e=l.data.field_types;Object.keys(e).forEach(d=>{oe.value.push({value:d,label:e[d]})})},E=u({}),we=async l=>{await l.validate(async(e,d)=>{if(e){if(console.log(ee.value),ee.value){y({type:"error",message:"有重复值！"});return}if(C.value){let f=await k.$api.addValidationRules({create_user:P.state.username,update_user:P.state.username,...a});f.status=="201"?(y({type:"success",message:"添加成功"}),v.value=!1,O(l),await b()):y({showClose:!0,message:"添加失败:"+JSON.stringify(f.data),type:"error"})}else{if(JSON.stringify(B.value)===JSON.stringify(a)){v.value=!1,O(l),y({showClose:!0,message:"无更新,关闭窗口",type:"info"});return}else{const S=Object.entries(B.value),m=Object.entries(a),_=S.concat(m).map(g=>JSON.stringify(g)),j=Array.from(new Set(_)).map(g=>JSON.parse(g));j.splice(0,S.length);const R=Object.fromEntries(j);let M={};if(Object.keys(R).forEach(g=>{R[g]!=""&&(M[g]=R[g])}),E.value=M,Object.keys(E.value).length===0){v.value=!1,O(l),y({showClose:!0,message:"无更新,关闭窗口",type:"info"});return}}console.log(E.value),console.log(a);let f=await k.$api.updateValidationRules({id:h.value.id,update_user:P.state.username,...E.value});console.log(f),f.status=="200"?(y({type:"success",message:"更新成功"}),v.value=!1,O(l),b()):y({showClose:!0,message:"更新失败:"+JSON.stringify(f.data),type:"error"})}}})},xe=l=>{Ae.confirm("是否确认删除?","删除",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await k.$api.deleteValidationRules(l)).status==204?(y({type:"success",message:"删除成功"}),await b(),O(q.value),v.value=!1):y({type:"error",message:"删除失败"})}).catch(()=>{y({type:"info",message:"取消删除"})})};return Ne(()=>{b(),he()}),(l,e)=>{var se;const d=i("el-button"),f=i("el-option"),S=i("el-select"),m=i("el-input"),_=i("el-table-column"),j=i("el-tooltip"),R=i("el-table"),M=i("el-pagination"),g=i("el-form-item"),Ce=i("el-text"),Oe=i("SuccessFilled"),ne=i("el-icon"),Se=i("WarningFilled"),Ue=i("el-form"),je=i("el-dialog"),X=Je("permission");return s(),c("div",Pe,[F("div",Ke,[F("div",Le,[Z((s(),p(d,{type:"primary",onClick:Ve},{default:r(()=>e[11]||(e[11]=[A("添加")])),_:1})),[[X,`${(se=x(K).name)==null?void 0:se.replace("_info","")}:add`]])]),F("div",We,[n(S,{modelValue:L.value,"onUpdate:modelValue":e[0]||(e[0]=t=>L.value=t),placeholder:"Select",style:{width:"120px"}},{default:r(()=>[(s(!0),c(N,null,J(fe.value,t=>(s(),p(f,{key:t.value,label:t.name,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),n(m,{modelValue:W.value,"onUpdate:modelValue":e[1]||(e[1]=t=>W.value=t),style:{width:"240px"},placeholder:"回车查询",clearable:"",onClear:e[2]||(e[2]=t=>b()),onKeyup:e[3]||(e[3]=De(t=>b(),["enter","native"]))},null,8,["modelValue"])])]),n(R,{ref:"multipleTableRef",data:I.value,style:{width:"100%"},border:"",onSortChange:ge},{default:r(()=>[n(_,{property:"name",label:"规则名",sortable:"custom"}),n(_,{property:"verbose_name",label:"规则名称"}),n(_,{property:"field_type",label:"字段类型",sortable:"custom"}),n(_,{property:"type",label:"规则类型",sortable:"custom"}),n(_,{property:"rule",label:"规则内容","show-overflow-tooltip":""}),n(_,{property:"description",label:"描述"}),n(_,{fixed:"right",width:"100",label:"操作"},{default:r(t=>[n(j,{class:"box-item",effect:"dark",content:"编辑",placement:"top"},{default:r(()=>{var w;return[Z(n(d,{link:"",type:"primary",icon:x(Te),onClick:o=>ke(t.row)},null,8,["icon","onClick"]),[[X,`${(w=x(K).name)==null?void 0:w.replace("_info","")}:edit`]])]}),_:2},1024),n(j,{class:"box-item",effect:"dark",content:"删除",placement:"top"},{default:r(()=>{var w;return[Z(n(d,{link:"",type:"danger",icon:x(qe),disabled:t.row.built_in,onClick:o=>xe(t.row.id)},null,8,["icon","disabled","onClick"]),[[X,`${(w=x(K).name)==null?void 0:w.replace("_info","")}:delete`]])]}),_:2},1024)]),_:1})]),_:1},8,["data"]),n(M,{"current-page":G.value,"onUpdate:currentPage":e[4]||(e[4]=t=>G.value=t),"page-size":H.value,"onUpdate:pageSize":e[5]||(e[5]=t=>H.value=t),"page-sizes":[10,20,50,100,200],size:me.value,disabled:ye.value,layout:"total, sizes, prev, pager, next, jumper",total:te.value,onSizeChange:be,onCurrentChange:_e,style:{"margin-top":"5px","justify-content":"flex-end"}},null,8,["current-page","page-size","size","disabled","total"]),n(je,{modelValue:v.value,"onUpdate:modelValue":e[10]||(e[10]=t=>v.value=t),title:"规则配置",width:"500","before-close":ae},{footer:r(()=>[F("div",Ye,[n(d,{onClick:ae},{default:r(()=>e[13]||(e[13]=[A("取消")])),_:1}),n(d,{type:"primary",onClick:e[9]||(e[9]=t=>we(q.value))},{default:r(()=>e[14]||(e[14]=[A(" 提交 ")])),_:1})])]),default:r(()=>[n(Ue,{inline:!0,"label-position":"right",model:a,"label-width":"auto",ref_key:"formRef",ref:q},{default:r(()=>[(s(!0),c(N,null,J(le.value,(t,w)=>(s(),p(g,{label:t.label,key:w,required:t.required,prop:t.value},{default:r(()=>[t.value==="rule"?(s(),c("div",Ge,[a.field_type==="enum"?(s(),c("div",He,[(s(!0),c(N,null,J(V.value,(o,Y)=>(s(),c("div",{key:Y},[F("li",null,[n(m,{modelValue:o.name,"onUpdate:modelValue":$=>o.name=$,style:{width:"90px","margin-right":"10px"}},null,8,["modelValue","onUpdate:modelValue"]),n(m,{modelValue:o.value,"onUpdate:modelValue":$=>o.value=$,style:{width:"160px","margin-right":"10px"}},null,8,["modelValue","onUpdate:modelValue"]),V.value.length!==1?(s(),p(d,{key:0,circle:"",type:"danger",size:"small",icon:x(Be),onClick:$=>ve(Y)},null,8,["icon","onClick"])):re("",!0),n(d,{circle:"",type:"primary",size:"small",icon:x(Ee),onClick:$=>ce(Y)},null,8,["icon","onClick"])])]))),128))])):(s(),p(m,{key:1,modelValue:a[t.value],"onUpdate:modelValue":o=>a[t.value]=o,type:"textarea",clearable:"",style:{width:"300px"},disabled:h.value.built_in},null,8,["modelValue","onUpdate:modelValue","disabled"]))])):t.value==="description"?(s(),p(m,{key:1,modelValue:a[t.value],"onUpdate:modelValue":o=>a[t.value]=o,type:"textarea",clearable:"",style:{width:"300px"}},null,8,["modelValue","onUpdate:modelValue"])):t.value==="name"?(s(),p(m,{key:2,modelValue:a[t.value],"onUpdate:modelValue":o=>a[t.value]=o,clearable:"",disabled:!!(h.value.built_in||!C.value)},null,8,["modelValue","onUpdate:modelValue","disabled"])):t.value==="verbose_name"?(s(),p(m,{key:3,modelValue:a[t.value],"onUpdate:modelValue":o=>a[t.value]=o,clearable:""},null,8,["modelValue","onUpdate:modelValue"])):(s(),c("div",Qe,[t.value==="field_type"?(s(),p(S,{key:0,modelValue:a.field_type,"onUpdate:modelValue":e[6]||(e[6]=o=>a.field_type=o),placeholder:"Select",style:{width:"120px"},disabled:!!(h.value.built_in||!C.value)},{default:r(()=>[(s(!0),c(N,null,J(oe.value,o=>(s(),p(f,{key:o.value,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])):(s(),p(S,{key:1,modelValue:a.type,"onUpdate:modelValue":e[7]||(e[7]=o=>a.type=o),placeholder:"Select",style:{width:"120px"},disabled:!!(h.value.built_in||!C.value)},{default:r(()=>[(s(!0),c(N,null,J(Q.value[a.field_type],o=>(s(),p(f,{key:o.type,label:o.description,value:o.type},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]))]))]),_:2},1032,["label","required","prop"]))),128)),a.type==="regex"?(s(),c("div",Xe,[n(Ce,null,{default:r(()=>e[12]||(e[12]=[A("测试正则")])),_:1}),n(m,{modelValue:D.value,"onUpdate:modelValue":e[8]||(e[8]=t=>D.value=t),clearable:"",style:{width:"200px",margin:"0 10px"}},null,8,["modelValue"]),pe.value?(s(),p(ne,{key:0,style:{color:"var(--el-color-success)"},size:20},{default:r(()=>[n(Oe)]),_:1})):(s(),p(ne,{key:1,style:{color:"var(--el-color-danger)"},size:20},{default:r(()=>[n(Se)]),_:1}))])):re("",!0)]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}});export{el as default};
