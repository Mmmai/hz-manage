import{d as Se,g as Te,x as Ue,a as ee,bP as j,r as m,v as K,z as Ee,y as Ae,j as Oe,aX as Ie,aT as Me,aP as Ne,h as d,bc as ze,c as b,o as u,b as _,f as a,w as s,bV as H,B as g,q as S,m as x,F as h,i as k,t as P,bX as le,cc as Be,cd as te,k as X,cf as Re,b_ as D,c4 as G,E as qe,_ as je}from"./index-CWdEKdsq.js";const Ke={class:"card"},He={class:"card-header"},Pe={style:{display:"flex","justify-content":"space-between"}},Xe={class:"dialog-footer"},Ge={class:"dialog-footer"},Je=Se({name:"logAnalysis",__name:"logAnalysisView",setup(We){const{proxy:p}=Te(),N=Ue(),ae={name:"",group:"",describe:"",status:!0,stepList:[{step:""}],steps:[]},o=ee({name:"",group:"",describe:"",status:!0,stepList:[{step:""}],steps:[]}),z=()=>{Object.keys(o).forEach(e=>{o[e]=ae[e]});let l=[];L.value.forEach(e=>{e.disabled=!1,l.push(e)}),L.value=l},se=l=>{o.stepList.splice(l,1)},oe=()=>{o.stepList.push({step:""})};j(()=>o.stepList,l=>{if(l.length==0)return 111;o.steps=[];let e=[],n=[];l.forEach(i=>{o.steps.indexOf(i.step)===-1&&i.step!=""&&o.steps.push(i.step),i.step!=""&&n.push(i.step)}),L.value.forEach(i=>{n.includes(i.value)?i.disabled=!0:i.disabled=!1,e.push(i)}),L.value=e},{deep:!0});const C=m([]),J=m([]),F=m([]),$=async()=>{let l=await p.$api.getLogFlow();console.log(l.data),C.value=l.data.data,F.value=l.data.data,console.log(F.value),l.data.data.forEach(e=>{J.value.push({label:e.name,value:e.id,disabled:!e.status})})},ne=K(()=>{let l=[];return C.value.forEach(e=>{l.includes({value:e.group,label:e.group})||l.push({value:e.group,label:e.group})}),l}),ue=K(()=>{let l=["所有"];return C.value.forEach(e=>{l.includes(e.group)||l.push(e.group)}),l}),B=m("所有");j(()=>B.value,l=>{l==="所有"?(console.log(l),F.value=C.value):F.value=C.value.filter(e=>e.group===l)});const L=m([]),W=m({}),re=async()=>{var e;(e=(await p.$api.getLogModule()).data.results)==null||e.forEach(n=>{n.status&&(L.value.push({label:n.module_name,value:n.id}),W.value[n.id]=n)})},V=m(!1),T=m(!0),de=()=>{V.value=!0,T.value=!0},ie=async()=>{p.$refs.formRef.validate(async l=>{if(l){let e=await p.$api.addLogFlow(o);e.status=="201"?(D({type:"success",message:"添加成功"}),p.$refs.formRef.resetFields(),V.value=!1,$()):D({showClose:!0,message:"添加失败:"+JSON.stringify(e.data),type:"error"})}else return})},U=m(""),ce=l=>{console.log(l),V.value=!0,T.value=!1,U.value=l.id;let e=[];l.steps.forEach(n=>{e.push({step:n})}),p.$nextTick(()=>{Object.assign(o,l)}),o.stepList=e,console.log(o)},pe=()=>{p.$refs.formRef.validate(async l=>{if(l){console.log(U.value);let e=await p.$api.updateLogFlow({id:U.value,...o});console.log(e),e.status==200?(D({type:"success",message:"更新成功"}),z(),V.value=!1,$()):D({type:"error",message:"更新失败"}),$()}})},Y=l=>{G.confirm("是否确认删除?","Warning",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await p.$api.delLogFlow(l.id)).status==204?(D({type:"success",message:"删除成功"}),z(),V.value=!1,$()):D({type:"error",message:"删除失败"})}).catch(()=>{D({type:"info",message:"Delete canceled"})})};Ee(async()=>{await re(),await $(),await be()});const me=l=>{G.confirm("是否关闭?").then(()=>{z(),l()}).catch(()=>{})};let fe=Ae();const ge=K(()=>fe.state.username),y=m(!1),R=m([]),r=ee({dataSourceId:"",dataSourceName:"",matchKey:"",dateValue:[],username:ge,flowName:"",missionId:null}),ve=[{text:"Last 1 hours",value:[new Date(new Date().getTime()-1*60*60*1e3),new Date]},{text:"Last 2 hours",value:[new Date(new Date().getTime()-2*60*60*1e3),new Date]},{text:"Last 6 hours",value:[new Date(new Date().getTime()-6*60*60*1e3),new Date]},{text:"Last 12 hours",value:[new Date(new Date().getTime()-12*60*60*1e3),new Date]},{text:"Last 24 hours",value:[new Date(new Date().getTime()-24*60*60*1e3),new Date]},{text:"Today",value:[new Date(new Date().setHours(0,0,0,0)),new Date(new Date().setHours(23,59,59,999))]},{text:"Yesterday",value:()=>[new Date(new Date().getTime()-36e5),new Date]},{text:"A week ago",value:()=>{const l=new Date;return l.setDate(l.getDate()-7),[l.setDate(l.getDate()-7),new Date]}}],be=async()=>{var e;let l=await p.$api.dataSourceGet();console.log(l),(e=l==null?void 0:l.data)==null||e.results.forEach(n=>{n.source_type=="loki"&&(n.isUsed?R.value.push({label:n.source_name,value:n.id,disabled:!1}):R.value.push({label:n.source_name,value:n.id,disabled:!0}),n.isDefault&&(r.dataSourceId=n.id,r.dataSourceName=n.source_name))})},E=m(""),we=l=>{console.log("in before search close"),G.confirm("是否关闭?").then(()=>{E.value.resetFields(),l()}).catch(()=>{})},ye=l=>{y.value=!0,r.flowId=l.id,console.log(l),r.flowName=l.name,r.missionId=p.$commonFunc.getUuid()},_e=Oe(),he=async()=>{console.log(r),E.value.validate(async l=>{if(l){let e=await p.$api.getFlowLokiLog(r);qe({title:"日志分析任务",message:"任务已成功提交",type:"success"}),console.log(e);let n=e.data.task_id;console.log(n),y.value=!1,setTimeout(()=>{_e.push({path:"/log/logFlowMission/"+e.data.missionId,query:{taskId:n}})}),E.value.resetFields()}})};return Ie(()=>{console.log("onDeactivated!"),y.value=!1}),Me(()=>{console.log("onActivated",y.value),Ne(()=>{console.log("onActivated nextTick",y.value)})}),j(()=>y.value,l=>{console.log(1111,l)}),(l,e)=>{const n=d("el-segmented"),i=d("el-col"),w=d("el-button"),Ve=d("el-row"),xe=d("el-divider"),ke=d("el-scrollbar"),De=d("el-card"),Le=d("el-space"),A=d("el-input"),v=d("el-form-item"),O=d("el-option"),I=d("el-select"),Ce=d("el-switch"),Q=d("el-form"),Z=d("el-dialog"),Fe=d("el-date-picker"),q=ze("permission");return u(),b(h,null,[_("div",Ke,[a(Ve,{class:"row-bg",justify:"space-between"},{default:s(()=>[a(i,{span:23},{default:s(()=>[e[13]||(e[13]=_("span",{style:{display:"flex","align-items":"center","margin-right":"10px"}},"分组",-1)),a(n,{modelValue:B.value,"onUpdate:modelValue":e[0]||(e[0]=t=>B.value=t),options:ue.value,size:"large"},null,8,["modelValue","options"])]),_:1}),a(i,{span:1},{default:s(()=>{var t;return[H((u(),g(w,{type:"primary",onClick:de},{default:s(()=>[...e[14]||(e[14]=[S("添加",-1)])]),_:1})),[[q,`${(t=x(N).name)==null?void 0:t.replace("_info","")}:add`]])]}),_:1})]),_:1}),a(xe),a(Le,{wrap:""},{default:s(()=>[(u(!0),b(h,null,k(F.value,(t,f)=>(u(),g(De,{key:f,class:"box-card",style:{width:"300px",height:"250px"},shadow:"hover",onClick:c=>ye(t)},{header:s(()=>{var c,M;return[_("div",He,[_("span",null,P(t.group)+": "+P(t.name),1),_("div",Pe,[H(a(w,{type:"primary",size:"small",icon:x(Be),circle:"",onClick:le($e=>ce(t),["stop"])},null,8,["icon","onClick"]),[[q,`${(c=x(N).name)==null?void 0:c.replace("_info","")}:edit`]]),H(a(w,{type:"danger",size:"small",icon:x(te),circle:"",onClick:le($e=>Y(t),["stop"])},null,8,["icon","onClick"]),[[q,`${(M=x(N).name)==null?void 0:M.replace("_info","")}:delete`]])])])]}),default:s(()=>[a(ke,{height:"120px"},{default:s(()=>[(u(!0),b(h,null,k(t.steps,(c,M)=>(u(),b("div",{key:M,class:"text item"},[_("li",null,P(W.value[c].module_name),1)]))),128))]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})]),a(Z,{modelValue:V.value,"onUpdate:modelValue":e[6]||(e[6]=t=>V.value=t),title:"业务流程",width:"500","before-close":me,draggable:"",overflow:""},{footer:s(()=>[_("div",Xe,[T.value==!1?(u(),g(w,{key:0,type:"danger",onClick:e[5]||(e[5]=t=>Y({id:U.value}))},{default:s(()=>[...e[15]||(e[15]=[S("删除",-1)])]),_:1})):X("",!0),T.value==!1?(u(),g(w,{key:1,type:"primary",onClick:pe},{default:s(()=>[...e[16]||(e[16]=[S("更新",-1)])]),_:1})):(u(),g(w,{key:2,type:"primary",onClick:ie},{default:s(()=>[...e[17]||(e[17]=[S("添加",-1)])]),_:1}))])]),default:s(()=>[a(Q,{"label-position":"right",model:o,"label-width":"auto",style:{"max-width":"400px"},ref:"formRef"},{default:s(()=>[a(v,{label:"流程名称",prop:"name",rules:[{required:!0,message:"请输入流程名称",trigger:"blur"}]},{default:s(()=>[a(A,{modelValue:o.name,"onUpdate:modelValue":e[1]||(e[1]=t=>o.name=t),style:{width:"220px"}},null,8,["modelValue"])]),_:1}),a(v,{label:"分组"},{default:s(()=>[a(I,{modelValue:o.group,"onUpdate:modelValue":e[2]||(e[2]=t=>o.group=t),filterable:"",clearable:"","allow-create":"",placeholder:"所属分组，支持新增",style:{width:"180px"}},{default:s(()=>[(u(!0),b(h,null,k(ne.value,t=>(u(),g(O,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(v,{label:"是否启用"},{default:s(()=>[a(Ce,{modelValue:o.status,"onUpdate:modelValue":e[3]||(e[3]=t=>o.status=t),class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"}},null,8,["modelValue"])]),_:1}),(u(!0),b(h,null,k(o.stepList,(t,f)=>(u(),b("div",{key:f},[a(v,{label:"环节"+(f+1),prop:"stepList."+f+".step",rules:[{required:!0,message:"请选择环节",trigger:"blur"}]},{default:s(()=>[a(I,{modelValue:t.step,"onUpdate:modelValue":c=>t.step=c,filterable:"",clearable:"",placeholder:"选择流程",style:{width:"180px"}},{default:s(()=>[(u(!0),b(h,null,k(L.value,c=>(u(),g(O,{key:c.value,label:c.label,value:c.value,disabled:c.disabled},null,8,["label","value","disabled"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"]),o.stepList.length>>1?(u(),g(w,{key:0,size:"small",icon:x(te),circle:"",style:{margin:"0 5px 0px 5px"},onClick:c=>se(f)},null,8,["icon","onClick"])):X("",!0),f==o.stepList.length-1?(u(),g(w,{key:1,type:"primary",icon:x(Re),circle:"",size:"small",style:{margin:"0 5px 0px 5px"},onClick:oe},null,8,["icon"])):X("",!0)]),_:2},1032,["label","prop"])]))),128)),a(v,{label:"描述",prop:"describe"},{default:s(()=>[a(A,{modelValue:o.describe,"onUpdate:modelValue":e[4]||(e[4]=t=>o.describe=t),type:"textarea"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),a(Z,{modelValue:y.value,"onUpdate:modelValue":e[12]||(e[12]=t=>y.value=t),title:"查询条件",width:"500",appendToBody:"","before-close":we,draggable:"",overflow:""},{footer:s(()=>[_("div",Ge,[a(w,{type:"primary",onClick:he},{default:s(()=>[...e[18]||(e[18]=[S("检索",-1)])]),_:1})])]),default:s(()=>[a(Q,{"label-position":"right","label-width":"auto",model:r,style:{"max-width":"600px"},ref_key:"searchFormRef",ref:E},{default:s(()=>[a(v,{label:"数据源"},{default:s(()=>[a(I,{modelValue:r.dataSourceId,"onUpdate:modelValue":e[7]||(e[7]=t=>r.dataSourceId=t),placeholder:"Select",size:"large",style:{width:"180px"}},{default:s(()=>[(u(!0),b(h,null,k(R.value,(t,f)=>(u(),g(O,{key:f,label:t.label,value:t.value,disabled:t.disabled},null,8,["label","value","disabled"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(v,{label:"业务流ID",prop:"flowId",rules:[{required:!0,message:"请选择业务流ID",trigger:"blur"}]},{default:s(()=>[a(I,{modelValue:r.flowId,"onUpdate:modelValue":e[8]||(e[8]=t=>r.flowId=t),placeholder:"Select",size:"large",style:{width:"180px"}},{default:s(()=>[(u(!0),b(h,null,k(J.value,(t,f)=>(u(),g(O,{key:f,label:t.label,value:t.value,disabled:t.disabled},null,8,["label","value","disabled"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(v,{label:"关键字",prop:"matchKey",rules:[{required:!0,message:"需要提供关键字!!!",trigger:"blur"}]},{default:s(()=>[a(A,{modelValue:r.matchKey,"onUpdate:modelValue":e[9]||(e[9]=t=>r.matchKey=t),autosize:"",type:"textarea",placeholder:"请输入关键字"},null,8,["modelValue"])]),_:1}),a(v,{label:"时间范围",prop:"dateValue",rules:[{required:!0,message:"选择时间范围",trigger:"blur"}]},{default:s(()=>[a(Fe,{modelValue:r.dateValue,"onUpdate:modelValue":e[10]||(e[10]=t=>r.dateValue=t),type:"datetimerange",shortcuts:ve,"range-separator":"To","start-placeholder":"Start date","end-placeholder":"End date","value-format":"x"},null,8,["modelValue"])]),_:1}),a(v,{label:"分析ID",prop:"uuid"},{default:s(()=>[a(A,{modelValue:r.missionId,"onUpdate:modelValue":e[11]||(e[11]=t=>r.missionId=t),disabled:""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])],64)}}}),Qe=je(Je,[["__scopeId","data-v-c2904618"]]);export{Qe as default};
