import{d as Z,g as ee,r as p,l as te,e as d,c as g,o as _,i as r,b as n,j as ae,w as i,y as A,c4 as ne,k as h,t as f,F as oe,p as se,z as M,q as le,c5 as re,_ as ie}from"./index-BuQNgUX_.js";import{Q as ue}from"./vue3-json-viewer-CkXyoLi1.js";const ce={class:"divVertical"},de={class:"card filter-card"},pe={class:"filter-container"},me={class:"filter-row filter-row-flex"},_e={class:"filter-item"},ve={class:"filter-item"},ge={class:"filter-item"},fe={class:"card table-container table-main",style:{width:"100%"}},we=["onClick"],ye={class:"change-content"},he={key:0,class:"old-value"},be={key:2,class:"new-value"},De={class:"drawer-content"},Te=Z({__name:"ciDataAudit",props:{instanceId:{type:String,default:""}},setup(N,{expose:H}){const{proxy:P}=ee(),I=N,l=p([]),R=[{text:"最近1天",value:()=>{const e=new Date,t=new Date;return t.setTime(e.getTime()-3600*1e3*24*1),[t,e]}},{text:"最近3天",value:()=>{const e=new Date,t=new Date;return t.setTime(e.getTime()-3600*1e3*24*3),[t,e]}},{text:"最近5天",value:()=>{const e=new Date,t=new Date;return t.setTime(e.getTime()-3600*1e3*24*5),[t,e]}},{text:"最近7天",value:()=>{const e=new Date,t=new Date;return t.setTime(e.getTime()-3600*1e3*24*7),[t,e]}},{text:"最近1周",value:()=>{const e=new Date,t=new Date;return t.setTime(e.getTime()-3600*1e3*24*7),[t,e]}},{text:"最近1个月",value:()=>{const e=new Date,t=new Date;return t.setTime(e.getTime()-3600*1e3*24*30),[t,e]}},{text:"最近3个月",value:()=>{const e=new Date,t=new Date;return t.setTime(e.getTime()-3600*1e3*24*90),[t,e]}}],j=()=>{const e=new Date,t=new Date;t.setHours(23,59,59,999),e.setTime(t.getTime()-3600*1e3*24*30),e.setHours(0,0,0,0);const s=o=>{const m=o.getFullYear(),k=String(o.getMonth()+1).padStart(2,"0"),c=String(o.getDate()).padStart(2,"0"),C=String(o.getHours()).padStart(2,"0"),y=String(o.getMinutes()).padStart(2,"0"),E=String(o.getSeconds()).padStart(2,"0"),$=String(o.getMilliseconds()).padStart(3,"0");return`${m}-${k}-${c}T${C}:${y}:${E}.${$}`};l.value=[s(e),s(t)]},w=p(""),Y=e=>{l.value=e,v()},z=()=>{v()},x=p([]),b=p(1),D=p(10),O=p(0),U=()=>{v()},T={groups:"实例组",instance_name:"实例名称",order:"排序",verbose_name:"字段名称",model_field_group:"字段组"},B=e=>{const t=[];return e.changed_fields&&Object.keys(e.changed_fields).forEach(s=>{const o=e.changed_fields[s];s==="groups"?t.push({field:T[s],oldValue:o[0].map(m=>m.path).join(","),newValue:o[1].map(m=>m.path).join(",")}):s==="model_field_group"?t.push({field:T[s],oldValue:o[0].verbose_name,newValue:o[1].verbose_name}):t.push({field:T[s],oldValue:o[0],newValue:o[1]})}),e.details&&e.details.forEach(s=>{t.push({field:s.verbose_name||s.name,oldValue:L(s.old_value),newValue:L(s.new_value)})}),t},L=e=>{if(e===null)return e;if(typeof e=="object")return e.hasOwnProperty("label")&&e.label!==void 0?e.label:e.hasOwnProperty("instance_name")&&e.instance_name!==void 0?e.instance_name:(e.hasOwnProperty("verbose_name")&&e.verbose_name!==void 0,e);if(typeof e=="string"){try{const t=JSON.parse(e);if(typeof t=="object"&&t!==null){if(t.hasOwnProperty("label")&&t.label!==void 0)return t.label;if(t.hasOwnProperty("instance_name")&&t.instance_name!==void 0)return t.instance_name}}catch{}return e}return e},V=p(!1),S=p({});te(()=>JSON.stringify(S.value,null,2));const F=e=>{S.value=e,V.value=!0},K={model:"模型",model_field:"字段",model_instance:"实例",model_group:"模型组",unique_constraint:"唯一约束",model_field_group:"模型字段组",validation_rule:"校验规则",model_instance_group:"实例组"},q=e=>K[e]||e,J={CREATE:"创建",UPDATE:"修改",DELETE:"删除"},Q=e=>J[e]||e,G=e=>({CREATE:"success",UPDATE:"warning",DELETE:"danger"})[e]||"",v=async()=>{try{const e={page:b.value,page_size:D.value,target_type:"model_instance",object_id:I.instanceId,time_after:l.value&&l.value[0]?l.value[0]:void 0,time_before:l.value&&l.value[1]?l.value[1]:void 0,search:w.value||void 0},t=await P.$api.getCiAuditLog(e);x.value=t.data.results,O.value=t.data.count}catch(e){console.error("获取审计日志失败:",e),P.$message.error("获取审计日志失败")}},W=()=>{l.value=[],w.value="",j(),v()};return H({getData:()=>{j(),v()}}),(e,t)=>{const s=d("el-date-picker"),o=d("el-button"),m=d("el-input"),k=d("el-tooltip"),c=d("el-table-column"),C=d("el-tag"),y=d("el-text"),E=d("el-table"),$=d("el-pagination");return _(),g("div",ce,[r("div",de,[r("div",pe,[r("div",me,[r("div",_e,[t[7]||(t[7]=r("span",{class:"filter-label"},"时间范围：",-1)),n(s,{modelValue:l.value,"onUpdate:modelValue":t[0]||(t[0]=a=>l.value=a),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间","value-format":"YYYY-MM-DDTHH:mm:ss",shortcuts:R,onChange:Y},null,8,["modelValue"])]),r("div",ve,[n(m,{modelValue:w.value,"onUpdate:modelValue":t[1]||(t[1]=a=>w.value=a),placeholder:"请输入搜索关键词",clearable:"",style:{width:"200px"},onKeyup:ae(z,["enter"])},{append:i(()=>[n(o,{icon:A(ne),onClick:z},null,8,["icon"])]),_:1},8,["modelValue"])]),r("div",ge,[n(o,{onClick:W},{default:i(()=>[...t[8]||(t[8]=[h("重置",-1)])]),_:1})])])])]),r("div",fe,[n(E,{data:x.value,style:{width:"100%"},border:"",height:"900"},{default:i(()=>[n(c,{prop:"target_type",label:"操作对象",width:"120"},{default:i(a=>[n(k,{content:"查看详情",placement:"right",effect:"dark"},{default:i(()=>[r("span",{class:"target-type-link",onClick:u=>F(a.row)},f(q(a.row.target_type)),9,we)]),_:2},1024)]),_:1}),n(c,{label:"操作类型",width:"120"},{default:i(a=>[n(C,{type:G(a.row.action)},{default:i(()=>[h(f(Q(a.row.action)),1)]),_:2},1032,["type"])]),_:1}),n(c,{prop:"operator",label:"操作人",width:"120"}),n(c,{prop:"operator_ip",label:"操作人IP",width:"150"}),n(c,{prop:"comment",label:"操作描述","show-overflow-tooltip":""}),n(c,{label:"变更内容"},{default:i(a=>[r("div",ye,[(_(!0),g(oe,null,se(B(a.row),(u,X)=>(_(),g("div",{key:X,class:"change-item"},[n(y,{tag:"b"},{default:i(()=>[h(f(u.field)+": ",1)]),_:2},1024),u.oldValue!==void 0?(_(),g("span",he,f(u.oldValue!==null?u.oldValue:"null"),1)):M("",!0),u.oldValue!==void 0&&u.newValue!==void 0?(_(),le(y,{key:1,tag:"b",type:"warning"},{default:i(()=>[...t[9]||(t[9]=[h(" → ",-1)])]),_:1})):M("",!0),u.newValue!==void 0?(_(),g("span",be,f(u.newValue!==null?u.newValue:"null"),1)):M("",!0)]))),128))])]),_:1}),n(c,{prop:"timestamp",label:"操作时间",width:"300"})]),_:1},8,["data"]),n($,{"current-page":b.value,"onUpdate:currentPage":[t[2]||(t[2]=a=>b.value=a),t[4]||(t[4]=a=>U())],"page-size":D.value,"onUpdate:pageSize":[t[3]||(t[3]=a=>D.value=a),t[5]||(t[5]=a=>U())],"page-sizes":[10,20,50,100,200],layout:"total, sizes, prev, pager, next, jumper",total:O.value,style:{"margin-top":"20px","justify-content":"flex-end",display:"flex"}},null,8,["current-page","page-size","total"])]),n(A(re),{modelValue:V.value,"onUpdate:modelValue":t[6]||(t[6]=a=>V.value=a),title:"详细信息",direction:"rtl",size:"50%"},{default:i(()=>[r("div",De,[n(A(ue),{value:S.value,"expand-depth":5,copyable:"",boxed:"",sort:""},null,8,["value"])])]),_:1},8,["modelValue"])])}}}),Ce=ie(Te,[["__scopeId","data-v-3129e7cf"]]);export{Ce as c};
