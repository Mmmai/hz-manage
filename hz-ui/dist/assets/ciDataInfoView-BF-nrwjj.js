import{d as je,g as Se,x as Ee,j as Be,v as Q,r as C,a as Ue,bP as Pe,z as Ne,h as b,bc as ze,c as y,o as l,b as H,bV as pe,f as n,m as ae,B as r,w as t,q as c,t as p,F as D,i as S,cc as Fe,cd as Le,k as V,b_ as M,aP as Ae,c4 as Oe,_ as Ye,u as De,cp as Je}from"./index-BSX4TNZE.js";import{e as He,d as Me}from"./gmCrypto-Be7PV8B3.js";import{m as Te}from"./model-Ds6Q2RXn.js";import{c as We}from"./ciDataAudit-BFeUd0FI.js";import"./vue3-json-viewer-CUIQsf7-.js";const Ge={class:"relations-card"},Qe={class:"card-header"},Xe={key:0},Ze={key:1},Ke={key:0},et={key:1},tt=["innerHTML"],at={style:{float:"left"}},lt={style:{float:"right",color:"var(--el-text-color-secondary)","font-size":"13px"}},nt={key:3,style:{"font-size":"12px",color:"#999","margin-top":"3px"}},ot={class:"dialog-footer"},rt=je({__name:"ciDataRelation",props:{instanceId:{type:String,required:!0},modelId:{type:String,required:!0}},setup(ue){const Y=ue,{proxy:X}=Se(),v=Ee();Be();const se=Te(),F=Q(()=>se.modelOptions),ge=Q(()=>se.modelObjectById),le=Q(()=>se.validationRulesEnumOptionsObject),ne=C(!1),oe=C(!1),Z=C([]),w=C([]),W=C([]),N=Ue({currentPage:1,pageSize:10,total:0}),s=C(!1),de=C(),R=C(!1),ie=C(null),f=Ue({relation:null,source_instance:Y.instanceId,target_instance:null,source_attributes:{},target_attributes:{},relation_attributes:{}}),me={relation:[{required:!0,message:"请选择关系类型",trigger:"change"}],target_instance:[{required:!0,message:"请选择目标实例",trigger:"change"}],source_attributes:{},target_attributes:{},relation_attributes:{}},K=async()=>{ne.value=!0;try{const a=await X.$api.getModelInstanceRelation({instances:Y.instanceId,page:N.currentPage,page_size:N.pageSize});Z.value=a.data.results,N.total=a.data.count}catch(a){M.error("获取关联关系数据失败"),console.error(a)}finally{ne.value=!1}},L=Q(()=>{const a={};return w.value.forEach(u=>{a[u.id]=u}),a}),E=C(null),re=C([]),J=C(!1);Pe(()=>f.relation,()=>{if(!f.relation)return;let a=L.value[f.relation].source_model,u=L.value[f.relation].target_model;(a==null?void 0:a.indexOf(Y.modelId))!==-1?(u==null?void 0:u.indexOf(Y.modelId))!==-1?re.value=F.value.filter(m=>u.indexOf(m.value)!==-1||a.indexOf(m.value)!==-1):(re.value=F.value.filter(m=>u.indexOf(m.value)!==-1),J.value=!1):(re.value=F.value.filter(m=>a.indexOf(m.value)!==-1),J.value=!0),E.value=re.value[0].value},{deep:!0});const xe=()=>{R.value||(f.target_instance=null)},fe=async()=>{try{const a=await X.$api.getModelRelationDefine({any_model:Y.modelId});w.value=a.data.results}catch(a){M.error("获取关系类型失败"),console.error(a)}},ye=async a=>{if(!f.relation){W.value=[];return}oe.value=!0;try{if(E.value){const u=await X.$api.getCiModelInstance({model:E.value,search:a,page_size:20});W.value=u.data.results,W.value=W.value.filter(m=>m.id!==Y.instanceId)}}catch(u){M.error("搜索目标实例失败"),console.error(u)}finally{oe.value=!1}},we=()=>{f.target_instance=null,ye("")},$e=()=>{R.value=!1,ie.value=null,s.value=!0,fe()},Ce=async a=>{R.value=!0,ie.value=a.id,s.value=!0,w.value.length===0&&await fe(),f.relation=a.relation.id,f.source_attributes=a.source_attributes||{},f.target_attributes=a.target_attributes||{},f.relation_attributes=a.relation_attributes||{},J.value=a.source_instance.id!==Y.instanceId,Ae(()=>{E.value=a.target_instance.model,W.value=[{id:a.source_instance.id,instance_name:a.source_instance.instance_name},{id:a.target_instance.id,instance_name:a.target_instance.instance_name}],f.target_instance=J.value?a.source_instance.id:a.target_instance.id})},ve=()=>{var a;(a=de.value)==null||a.resetFields(),f.relation=null,f.target_instance=null,f.source_attributes={},f.target_attributes={},f.relation_attributes={},W.value=[],R.value=!1,J.value=!1,ie.value=null,re.value=[],E.value=null},he=async()=>{var a;await((a=de.value)==null?void 0:a.validate(async u=>{if(u)try{let m,g={...f};J.value&&(g.target_instance=f.source_instance,g.source_instance=f.target_instance),R.value?m=await X.$api.updateModelInstanceRelation({id:ie.value,...g}):m=await X.$api.addModelInstanceRelation({source_instance:Y.instanceId,...g}),m.status===201&&!R.value||m.status===200&&R.value?(M.success(R.value?"编辑关联关系成功":"添加关联关系成功"),s.value=!1,ve(),K()):M.error(R.value?`编辑关联关系失败,${JSON.stringify(m.data)}`:`添加关联关系失败,${JSON.stringify(m.data)}}`)}catch(m){M.error((R.value?"编辑关联关系失败: ":"添加关联关系失败: ")+m.message),console.error(m)}}))},Ie=a=>{Oe.confirm("确定要删除这个关联关系吗？","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{(await X.$api.deleteModelInstanceRelation(a)).status===204?(M.success("删除成功"),K()):M.error("删除失败")}catch(u){M.error("删除失败: "+u.message),console.error(u)}}).catch(()=>{})},d=a=>{N.pageSize=a,K()},_=a=>{N.currentPage=a,K()},h=a=>a?a.source_instance.id===Y.instanceId?a.relation.forward_verb:a.relation.reverse_verb:"",x=a=>{var ee,te;if(!a)return"";const u=a.source_instance.instance_name,m=a.target_instance.instance_name,g=h(a),O=(ee=ge.value[a.source_instance.model])==null?void 0:ee.verbose_name,B=(te=ge.value[a.target_instance.model])==null?void 0:te.verbose_name;let T,G;if(a.source_instance.id===Y.instanceId){T=Object.keys(a.source_attributes).map(q=>`${P(a.relation,q)}: ${I(a.relation,q,a.source_attributes[q])}`).join(", "),G=Object.keys(a.target_attributes).map(q=>`${z(a.relation,q)}: ${I(a.relation,q,a.target_attributes[q])}`).join(", ");let U=`<span class="source-name">${u}</span>(${O})`;return T&&(U+=`的[${T}]`),U+=` - <span class="relation-name">${g}</span> - <span class="target-name">${m}</span>(${B})`,G&&(U+=`的[${G}]`),U}else{G=Object.keys(a.target_attributes).map(q=>`${z(a.relation,q)}: ${I(a.relation,q,a.target_attributes[q])}`).join(", "),T=Object.keys(a.source_attributes).map(q=>`${P(a.relation,q)}: ${I(a.relation,q,a.source_attributes[q])}`).join(", ");let U=`<span class="source-name">${m}</span>(${B})`;return G&&(U+=`的[${G}]`),U+=` - <span class="relation-name">${g}</span> - <span class="target-name">${u}</span>(${O})`,T&&(U+=`的[${T}]`),U}},P=(a,u)=>{if(!a||!a.attribute_schema||!a.attribute_schema.source)return u;const m=a.attribute_schema.source[u];return m?m.verbose_name:u},k=(a,u)=>{if(!a||!a.attribute_schema||!a.attribute_schema.relation)return u;const m=a.attribute_schema.relation[u];return m?m.verbose_name:u},z=(a,u)=>{if(!a||!a.attribute_schema||!a.attribute_schema.target)return u;const m=a.attribute_schema.target[u];return m?m.verbose_name:u},I=(a,u,m)=>{if(!a||!a.attribute_schema||!a.attribute_schema.relation)return m;const g=a.attribute_schema.relation[u];if(!g)return m;if(g.type==="enum"&&g.validation_rule){const O=le.value[g.validation_rule];if(O){const B=O.find(T=>T.value===m);if(B)return B.label}}return g.unit?`${m} ${g.unit}`:m};return Ne(()=>{K(),fe()}),(a,u)=>{var A;const m=b("el-button"),g=b("el-tag"),O=b("el-table-column"),B=b("el-text"),T=b("el-table"),G=b("el-pagination"),ee=b("el-option"),te=b("el-select"),U=b("el-form-item"),q=b("el-radio-button"),ke=b("el-radio-group"),Ve=b("el-radio"),be=b("el-input"),qe=b("el-input-number"),ce=b("el-form"),Re=b("el-dialog"),_e=ze("permission"),j=ze("loading");return l(),y("div",Ge,[H("div",Qe,[H("div",null,[pe((l(),r(m,{type:"primary",onClick:$e},{default:t(()=>[...u[8]||(u[8]=[c(" 添加关联 ",-1)])]),_:1})),[[_e,`${(A=ae(v).name)==null?void 0:A.replace("_info","")}:add`]])])]),pe((l(),r(T,{data:Z.value,style:{width:"100%"},border:""},{default:t(()=>[n(O,{prop:"source_instance",label:"源实例"},{default:t(e=>[e.row.source_instance.id!==ue.instanceId?(l(),r(g,{key:0},{default:t(()=>[c(p(e.row.target_instance.instance_name),1)]),_:2},1024)):(l(),r(g,{key:1},{default:t(()=>[c(p(e.row.source_instance.instance_name),1)]),_:2},1024))]),_:1}),n(O,{prop:"source_attributes",label:"源属性",width:"150"},{default:t(e=>[e.row.source_instance.id===ue.instanceId?(l(),y("div",Xe,[(l(!0),y(D,null,S(e.row.source_attributes,(i,o)=>(l(),y("div",{key:o,style:{"font-size":"12px"}},[n(B,{tag:"b"},{default:t(()=>[c(p(P(e.row.relation,o))+":",1)]),_:2},1024),c(" "+p(i),1)]))),128))])):(l(),y("div",Ze,[(l(!0),y(D,null,S(e.row.target_attributes,(i,o)=>(l(),y("div",{key:o,style:{"font-size":"12px"}},[n(B,{tag:"b"},{default:t(()=>[c(p(z(e.row.relation,o))+":",1)]),_:2},1024),c(" "+p(i),1)]))),128))]))]),_:1}),n(O,{prop:"relation",label:"关联动作",width:"100"},{default:t(e=>[n(g,{type:"success"},{default:t(()=>[c(p(h(e.row)),1)]),_:2},1024)]),_:1}),n(O,{prop:"source_instance",label:"目标实例"},{default:t(e=>[e.row.source_instance.id!==ue.instanceId?(l(),r(g,{key:0},{default:t(()=>[c(p(e.row.source_instance.instance_name),1)]),_:2},1024)):(l(),r(g,{key:1},{default:t(()=>[c(p(e.row.target_instance.instance_name),1)]),_:2},1024))]),_:1}),n(O,{prop:"target_attributes",label:"目标属性",width:"150"},{default:t(e=>[e.row.source_instance.id!==ue.instanceId?(l(),y("div",Ke,[(l(!0),y(D,null,S(e.row.source_attributes,(i,o)=>(l(),y("div",{key:o,style:{"font-size":"12px"}},[n(B,{tag:"b"},{default:t(()=>[c(p(P(e.row.relation,o))+":",1)]),_:2},1024),c(" "+p(i),1)]))),128))])):(l(),y("div",et,[(l(!0),y(D,null,S(e.row.target_attributes,(i,o)=>(l(),y("div",{key:o,style:{"font-size":"12px"}},[n(B,{tag:"b"},{default:t(()=>[c(p(z(e.row.relation,o))+":",1)]),_:2},1024),c(" "+p(i),1)]))),128))]))]),_:1}),n(O,{prop:"relation_attributes",label:"关系属性",width:"150"},{default:t(e=>[(l(!0),y(D,null,S(e.row.relation_attributes,(i,o)=>(l(),y("div",{key:o,style:{"font-size":"12px"}},[n(B,{tag:"b"},{default:t(()=>[c(p(k(e.row.relation,o))+":",1)]),_:2},1024),c(" "+p(I(e.row.relation,o,i)),1)]))),128))]),_:1}),n(O,{prop:"relation",label:"关系类型",width:"150"},{default:t(e=>[n(g,{type:"info"},{default:t(()=>[c(p(e.row.relation.name),1)]),_:2},1024)]),_:1}),n(O,{prop:"id",label:"关联动作描述"},{default:t(e=>[H("div",{class:"relation-description",innerHTML:x(e.row)},null,8,tt)]),_:1}),n(O,{label:"操作",width:"120",fixed:"right"},{default:t(e=>{var i,o;return[pe(n(m,{onClick:$=>Ce(e.row),type:"primary",icon:ae(Fe),link:""},null,8,["onClick","icon"]),[[_e,`${(i=ae(v).name)==null?void 0:i.replace("_info","")}:edit`]]),pe(n(m,{type:"danger",link:"",icon:ae(Le),onClick:$=>Ie(e.row.id)},null,8,["icon","onClick"]),[[_e,`${(o=ae(v).name)==null?void 0:o.replace("_info","")}:delete`]])]}),_:1})]),_:1},8,["data"])),[[j,ne.value]]),n(G,{"current-page":N.currentPage,"onUpdate:currentPage":u[0]||(u[0]=e=>N.currentPage=e),"page-size":N.pageSize,"onUpdate:pageSize":u[1]||(u[1]=e=>N.pageSize=e),"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",total:N.total,onSizeChange:d,onCurrentChange:_,style:{"margin-top":"20px","justify-content":"flex-end"}},null,8,["current-page","page-size","total"]),n(Re,{modelValue:s.value,"onUpdate:modelValue":u[7]||(u[7]=e=>s.value=e),title:R.value?"编辑关联关系":"添加关联关系",width:"600px",onClose:ve},{footer:t(()=>[H("div",ot,[n(m,{onClick:u[6]||(u[6]=e=>s.value=!1)},{default:t(()=>[...u[9]||(u[9]=[c("取消",-1)])]),_:1}),n(m,{type:"primary",onClick:he},{default:t(()=>[c(p(R.value?"保存":"添加"),1)]),_:1})])]),default:t(()=>[n(ce,{ref_key:"addRelationFormRef",ref:de,model:f,rules:me,"label-width":"120px"},{default:t(()=>{var e;return[n(U,{label:"关系类型",prop:"relation"},{default:t(()=>[n(te,{modelValue:f.relation,"onUpdate:modelValue":u[2]||(u[2]=i=>f.relation=i),placeholder:"请选择关系类型",style:{width:"100%"},onChange:we,disabled:R.value},{default:t(()=>[(l(!0),y(D,null,S(w.value,i=>(l(),r(ee,{key:i.id,label:i.name,value:i.id},{default:t(()=>{var o;return[H("span",at,p(i.name),1),H("span",lt,p(((o=i.source_model)==null?void 0:o.indexOf(Y.modelId))>>>-1?"目标实例":"源实例"),1)]}),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),n(U,{label:"目标实例",prop:"target_instance"},{default:t(()=>[n(ke,{modelValue:E.value,"onUpdate:modelValue":u[3]||(u[3]=i=>E.value=i),size:"default",onChange:xe},{default:t(()=>[(l(!0),y(D,null,S(re.value,(i,o)=>(l(),r(q,{disabled:R.value,label:i.label,value:i.value,key:o},null,8,["disabled","label","value"]))),128))]),_:1},8,["modelValue"]),n(te,{modelValue:f.target_instance,"onUpdate:modelValue":u[4]||(u[4]=i=>f.target_instance=i),placeholder:"请选择关联实例",style:{width:"100%","margin-top":"5px"},filterable:"",remote:"","remote-method":ye,loading:oe.value,disabled:R.value},{default:t(()=>[(l(!0),y(D,null,S(W.value,i=>(l(),r(ee,{key:i.id,label:i.instance_name,value:i.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading","disabled"])]),_:1}),E.value===ue.modelId?(l(),r(U,{key:0,label:"关联动作"},{default:t(()=>[n(ke,{modelValue:J.value,"onUpdate:modelValue":u[5]||(u[5]=i=>J.value=i),disabled:R.value},{default:t(()=>[n(Ve,{value:!1,size:"large"},{default:t(()=>{var i;return[c(p((i=L.value[f.relation])==null?void 0:i.forward_verb),1)]}),_:1}),n(Ve,{value:!0,size:"large"},{default:t(()=>{var i;return[c(p((i=L.value[f.relation])==null?void 0:i.reverse_verb),1)]}),_:1})]),_:1},8,["modelValue","disabled"])]),_:1})):V("",!0),(e=L.value[f.relation])!=null&&e.attribute_schema?(l(),y(D,{key:1},[(l(!0),y(D,null,S(L.value[f.relation].attribute_schema.source,(i,o)=>(l(),r(U,{key:"source_"+o,label:i.verbose_name,prop:"source_attributes."+o,required:i.required},{default:t(()=>[n(be,{modelValue:f.source_attributes[o],"onUpdate:modelValue":$=>f.source_attributes[o]=$,placeholder:"请输入"+i.verbose_name,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),_:2},1032,["label","prop","required"]))),128)),(l(!0),y(D,null,S(L.value[f.relation].attribute_schema.target,(i,o)=>(l(),r(U,{key:"target_"+o,label:i.verbose_name,prop:"target_attributes."+o,required:i.required},{default:t(()=>[n(be,{modelValue:f.target_attributes[o],"onUpdate:modelValue":$=>f.target_attributes[o]=$,placeholder:"请输入"+i.verbose_name,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),_:2},1032,["label","prop","required"]))),128)),(l(!0),y(D,null,S(L.value[f.relation].attribute_schema.relation,(i,o)=>(l(),r(U,{key:"relation_"+o,label:i.verbose_name,prop:"relation_attributes."+o,required:i.required},{default:t(()=>[i.type==="enum"?(l(),r(te,{key:0,modelValue:f.relation_attributes[o],"onUpdate:modelValue":$=>f.relation_attributes[o]=$,placeholder:"请选择"+i.verbose_name,style:{width:"100%"}},{default:t(()=>[(l(!0),y(D,null,S(le.value[i.validation_rule],$=>(l(),r(ee,{key:$.value,label:$.label,value:$.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder"])):["integer","float"].includes(i.type)?(l(),r(qe,{key:1,modelValue:f.relation_attributes[o],"onUpdate:modelValue":$=>f.relation_attributes[o]=$,placeholder:"请输入"+i.verbose_name,style:{width:"100%"},"controls-position":"right"},null,8,["modelValue","onUpdate:modelValue","placeholder"])):(l(),r(be,{key:2,modelValue:f.relation_attributes[o],"onUpdate:modelValue":$=>f.relation_attributes[o]=$,placeholder:"请输入"+i.verbose_name,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue","placeholder"])),i.unit?(l(),y("div",nt," 单位: "+p(i.unit),1)):V("",!0)]),_:2},1032,["label","prop","required"]))),128))],64)):V("",!0)]}),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),ut=Ye(rt,[["__scopeId","data-v-61e5761f"]]),st={class:"divVertical gap-5"},dt={class:"header card"},it={class:"content card"},ct={style:{width:"200px",display:"flex","justify-content":"flex-end","margin-right":"20px"}},_t={key:0},pt={key:1},mt={key:1},ft={key:1},vt=je({__name:"ciDataInfoView",setup(ue,{expose:Y}){const X=C(null),v=C({}),se=Te(),F=C({}),ge=Q(()=>se.validationRulesEnumOptionsObject),{proxy:le}=Se(),ne=Ee(),oe=Be(),Z=De(),w=C(!1),W=Q(()=>Z.gmCry),N=C(),s=Ue({id:null,instance_name:null,using_template:!0}),de=C(null),R=C("modelField"),ie=(d,_)=>{d.props.name=="changelog"&&de.value.getData()},f=C([0]),me=C({}),K=()=>{s.id=v.value.id,s.instance_name=v.value.instance_name,s.using_template=v.value.using_template,Object.keys(v.value.fields).forEach(d=>{E.value.enum.includes(d)?v.value.fields[d]!==null?s[d]=v.value.fields[d].value:s[d]=null:E.value.model_ref.includes(d)?v.value.fields[d]!==null?(me.value[d]=[v.value.fields[d]],s[d]=v.value.fields[d].id):s[d]=null:E.value.password.includes(d)&&Z.showAllPass?s[d]=Me(Z.gmCry.key,v.value.fields[d]):s[d]=v.value.fields[d]})},L=Q(()=>{var d,_;return(_=(d=v.value)==null?void 0:d.instance_group)==null?void 0:_.some(h=>h.group_path.includes("空闲池"))}),E=Q(()=>{let d={enum:[],boolean:[],model_ref:[],password:[]};return F.value.field_groups&&F.value.field_groups.forEach(_=>{_.fields.forEach(h=>{h.type==="enum"?d.enum.push(h.name):h.type==="boolean"?d.boolean.push(h.name):h.type==="model_ref"?d.model_ref.push(h.name):h.type==="password"&&d.password.push(h.name)})}),d}),re=d=>{if(!(d==""||d==null))return[{pattern:new RegExp(".*"),message:"不符合正则表达式",trigger:"blur"}]},J=Q(()=>{let d={};for(let[_,h]of Object.entries(s)){if(["id","instance_name","using_template"].includes(_))continue;let x=v.value.fields[_];E.value.enum.includes(_)?x=v.value.fields[_]===null?null:v.value.fields[_].value:E.value.model_ref.includes(_)?x=v.value.fields[_]===null?null:v.value.fields[_].id:E.value.password.includes(_)&&(Z.showAllPass||(x=v.value.fields[_])),(h!==x||h===null&&x!==null&&x!==void 0||h===""&&x!==""&&x!==null&&x!==void 0)&&(E.value.password.includes(_)&&h!==null&&h!==""?d[_]=He(Z.gmCry.key,Z.gmCry.mode,h):d[_]=h)}return d}),xe=Q(()=>{var d;return(((d=F.value)==null?void 0:d.field_groups)||[]).reduce((_,h)=>((h.fields||[]).forEach(x=>{_[x.name]=x}),_),{})}),fe=async(d,_)=>{const h=xe.value[_];if(!(!h||!h.ref_model))try{let x=await le.$api.getModelRefCi({model:h.ref_model,instance_name:d||void 0,page:1,page_size:d?100:20});me.value[_]=x.data.results}catch(x){console.error("获取model_ref数据失败:",x)}},ye=()=>{w.value=!0},we=()=>{w.value=!1,Ae(()=>{K()})},$e=async()=>{N.value&&await N.value.validate(async(d,_)=>{if(d){if(Object.keys(J.value).length===0&&s.instance_name===v.value.instance_name&&s.using_template===v.value.using_template){M({showClose:!0,message:"没有数据发生变更",type:"warning"}),w.value=!1;return}const h=Je.service({lock:!0,text:"保存中...",background:"rgba(0, 0, 0, 0.7)"});let x={id:v.value.id,model:F.value.id,fields:J.value};s.using_template!==v.value.using_template&&(x.using_template=s.using_template),s.instance_name!==v.value.instance_name&&(x.instance_name=s.instance_name);try{let P=await le.$api.updateCiModelInstance(x);P.status=="200"?(M({type:"success",message:"保存成功"}),w.value=!1,he()):(console.log(P),M({showClose:!0,message:"保存失败:"+JSON.stringify(P.data),type:"error"}))}catch(P){console.log(P),M({showClose:!0,message:"保存失败，请稍后重试",type:"error"})}finally{h.close()}}else M({showClose:!0,message:"表单填写有误，请检查",type:"error"})})},Ce=()=>{Oe.confirm("确定要删除该实例吗？此操作不可恢复","删除实例",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{let d=await le.$api.deleteCiModelInstance(v.value.id);d.status==204?(M.success("删除成功"),ve()):M.error(`删除失败,${JSON.stringify(d.data)}`)}catch{M.error("删除失败，error")}}).catch(()=>{})},ve=()=>{if(ne.name.includes("cmdb_only")){oe.push({path:"/cmdb_only/cmdb/cidata"});return}if(!w.value){oe.push({path:"/cmdb/cidata"});return}Oe.confirm("确定要离开页面吗？未保存的数据将会丢失","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{oe.push({path:"/cmdb/cidata"})}).catch(()=>{})},he=async()=>{const d=await le.$api.getCiModelInstanceInfo(X.value);d.status===200&&(v.value=d.data)},Ie=async()=>{const d=await le.$api.getCiModel({},v.value.model);d.status===200&&(F.value=d.data)};return Ne(async()=>{try{X.value=ne.path.split("/").at(-1),await he(),await Ie(),se.getModel(),se.getValidationRules(),K()}catch(d){console.log(d),M.error("数据加载失败",d),oe.back()}}),Y({initEditForm:K}),(d,_)=>{const h=b("el-page-header"),x=b("el-descriptions-item"),P=b("el-descriptions"),k=b("el-text"),z=b("Warning"),I=b("el-icon"),a=b("el-tooltip"),u=b("el-space"),m=b("el-input"),g=b("el-form-item"),O=b("el-switch"),B=b("el-button"),T=b("el-row"),G=b("InfoFilled"),ee=b("el-input-number"),te=b("el-date-picker"),U=b("el-option"),q=b("el-select"),ke=b("el-col"),Ve=b("el-collapse-item"),be=b("el-collapse"),qe=b("el-form"),ce=b("el-tab-pane"),Re=b("el-tabs"),_e=ze("permission");return l(),y("div",st,[H("div",dt,[n(h,{onBack:ve},{content:t(()=>{var j;return[H("span",null,p(`${(j=F.value.model)==null?void 0:j.verbose_name}【${v.value.instance_name}】`),1)]}),_:1})]),H("div",it,[n(P,{border:"",column:2,style:{width:"40%","margin-bottom":"10px"},"label-width":"100px"},{default:t(()=>[n(x,{label:"唯一标识"},{default:t(()=>[c(p(v.value.instance_name),1)]),_:1}),n(x,{label:"所属分组",width:"55%"},{default:t(()=>{var j;return[(l(!0),y(D,null,S((j=v.value)==null?void 0:j.instance_group,(A,e)=>(l(),y("div",{key:e,class:"group-item"},p(A.group_path),1))),128))]}),_:1})]),_:1}),n(Re,{modelValue:R.value,"onUpdate:modelValue":_[3]||(_[3]=j=>R.value=j),type:"card",class:"demo-tabs",onTabClick:ie},{default:t(()=>[n(ce,{label:"资产信息",name:"modelField"},{default:t(()=>[n(qe,{ref_key:"editFormRef",ref:N,style:{"max-width":"100%"},model:s,"label-width":"auto","status-icon":"","label-position":"top","require-asterisk-position":"right"},{default:t(()=>[n(T,{gutter:20,justify:"space-between"},{default:t(()=>{var j;return[n(g,{prop:"instance_name",required:"",style:{"margin-left":"30px"}},{label:t(()=>[n(u,{size:2},{default:t(()=>[n(k,{tag:"b"},{default:t(()=>[..._[4]||(_[4]=[c("唯一标识",-1)])]),_:1}),n(a,{content:"唯一命名标识",placement:"right",effect:"dark"},{default:t(()=>[n(I,null,{default:t(()=>[n(z)]),_:1})]),_:1})]),_:1})]),default:t(()=>[w.value?(l(),r(m,{key:0,modelValue:s.instance_name,"onUpdate:modelValue":_[0]||(_[0]=A=>s.instance_name=A),style:{"min-width":"400px"}},null,8,["modelValue"])):(l(),r(k,{key:1},{default:t(()=>[c(p(s.instance_name),1)]),_:1}))]),_:1}),n(g,{prop:"using_template",required:"",style:{"margin-left":"30px"}},{label:t(()=>[n(u,{size:2},{default:t(()=>[n(k,{tag:"b"},{default:t(()=>[..._[5]||(_[5]=[c("自动命名",-1)])]),_:1}),n(a,{content:"是否根据模型的唯一命名规则，自动生成唯一标识",placement:"right",effect:"dark"},{default:t(()=>[n(I,null,{default:t(()=>[n(z)]),_:1})]),_:1})]),_:1})]),default:t(()=>[n(O,{modelValue:s.using_template,"onUpdate:modelValue":_[1]||(_[1]=A=>s.using_template=A),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},disabled:!w.value},null,8,["modelValue","disabled"])]),_:1}),H("div",ct,[w.value?(l(),y("div",pt,[n(B,{onClick:we},{default:t(()=>[..._[8]||(_[8]=[c("取消",-1)])]),_:1}),n(B,{type:"primary",onClick:$e},{default:t(()=>[..._[9]||(_[9]=[c("保存",-1)])]),_:1})])):(l(),y("div",_t,[pe((l(),r(B,{type:"primary",onClick:ye},{default:t(()=>[..._[6]||(_[6]=[c("编辑",-1)])]),_:1})),[[_e,`${(j=ae(ne).name)==null?void 0:j.replace("_info","")}:edit`]]),n(a,{content:L.value?"删除实例":"实例不在空闲池，无法删除!",placement:"top",effect:"dark"},{default:t(()=>{var A;return[pe((l(),r(B,{type:"danger",onClick:Ce,disabled:!L.value},{default:t(()=>[..._[7]||(_[7]=[c("删除",-1)])]),_:1},8,["disabled"])),[[_e,`${(A=ae(ne).name)==null?void 0:A.replace("_info","")}:delete`]])]}),_:1},8,["content"])]))])]}),_:1}),n(be,{modelValue:f.value,"onUpdate:modelValue":_[2]||(_[2]=j=>f.value=j)},{default:t(()=>[(l(!0),y(D,null,S(F.value.field_groups,(j,A)=>(l(),r(Ve,{name:A,key:A},{title:t(()=>[n(k,{tag:"b",size:"large"},{default:t(()=>[c(p(j.verbose_name),1)]),_:2},1024)]),default:t(()=>[n(T,{gutter:20,style:{"margin-left":"30px"}},{default:t(()=>[(l(!0),y(D,null,S(j.fields,(e,i)=>(l(),r(ke,{key:i,xs:24,sm:24,md:12,lg:8,xl:6},{default:t(()=>[e.type==="string"?(l(),r(g,{key:0,label:e.verbose_name,prop:e.name,required:e.required,rules:re(e.validation_rule)},{label:t(()=>[n(u,{size:2},{default:t(()=>[n(k,{tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(l(),r(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(I,null,{default:t(()=>[n(z)]),_:1})]),_:1},8,["content"])):V("",!0)]),_:2},1024)]),default:t(()=>[w.value?(l(),r(m,{key:0,modelValue:s[e.name],"onUpdate:modelValue":o=>s[e.name]=o,style:{width:"240px"},disabled:!e.editable},null,8,["modelValue","onUpdate:modelValue","disabled"])):(l(),r(k,{key:1},{default:t(()=>[c(p(s[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required","rules"])):V("",!0),e.type==="json"?(l(),r(g,{key:1,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[n(u,{size:2},{default:t(()=>[n(k,{tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024),n(a,{placement:"right",effect:"dark"},{content:t(()=>[..._[10]||(_[10]=[c(" json类型字段",-1),H("br",null,null,-1),c("请输入json格式数据! ",-1)])]),default:t(()=>[n(I,null,{default:t(()=>[n(G)]),_:1})]),_:1}),e.description.length!=0?(l(),r(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(I,null,{default:t(()=>[n(z)]),_:1})]),_:1},8,["content"])):V("",!0)]),_:2},1024)]),default:t(()=>[w.value?(l(),r(m,{key:0,modelValue:s[e.name],"onUpdate:modelValue":o=>s[e.name]=o,style:{width:"240px"},autosize:"",type:"textarea"},null,8,["modelValue","onUpdate:modelValue"])):(l(),r(k,{key:1},{default:t(()=>[c(p(s[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])):V("",!0),["text"].indexOf(e.type)>>>-1?V("",!0):(l(),r(g,{key:2,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[n(u,{size:2},{default:t(()=>[n(k,{tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(l(),r(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(I,null,{default:t(()=>[n(z)]),_:1})]),_:1},8,["content"])):V("",!0)]),_:2},1024)]),default:t(()=>[w.value?(l(),r(m,{key:0,modelValue:s[e.name],"onUpdate:modelValue":o=>s[e.name]=o,style:{width:"240px"},autosize:"",type:"textarea"},null,8,["modelValue","onUpdate:modelValue"])):(l(),r(k,{key:1},{default:t(()=>[c(p(s[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])),e.type==="boolean"?(l(),r(g,{key:3,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[n(u,{size:2},{default:t(()=>[n(k,{tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(l(),r(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(I,null,{default:t(()=>[n(z)]),_:1})]),_:1},8,["content"])):V("",!0)]),_:2},1024)]),default:t(()=>[n(O,{modelValue:s[e.name],"onUpdate:modelValue":o=>s[e.name]=o,style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},disabled:!w.value},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1032,["label","prop","required"])):V("",!0),["float"].indexOf(e.type)>>>-1?V("",!0):(l(),r(g,{key:4,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[n(u,{size:2},{default:t(()=>[e.unit!==null?(l(),r(k,{key:0,tag:"b"},{default:t(()=>[c(p(e.verbose_name+"("+e.unit+")"),1)]),_:2},1024)):(l(),r(k,{key:1,tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024)),e.description.length!=0?(l(),r(a,{key:2,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(I,null,{default:t(()=>[n(z)]),_:1})]),_:1},8,["content"])):V("",!0)]),_:2},1024)]),default:t(()=>[w.value?(l(),r(ee,{key:0,modelValue:s[e.name],"onUpdate:modelValue":o=>s[e.name]=o,precision:2,step:1},null,8,["modelValue","onUpdate:modelValue"])):(l(),r(k,{key:1},{default:t(()=>[c(p(s[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])),["password"].indexOf(e.type)>>>-1?V("",!0):(l(),r(g,{key:5,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[n(u,{size:2},{default:t(()=>[n(k,{tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(l(),r(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(I,null,{default:t(()=>[n(z)]),_:1})]),_:1},8,["content"])):V("",!0)]),_:2},1024)]),default:t(()=>{var o;return[w.value?(l(),r(m,{key:0,modelValue:s[e.name],"onUpdate:modelValue":$=>s[e.name]=$,style:{width:"240px"},type:"password","auto-complete":"new-password","show-password":"",clearable:""},null,8,["modelValue","onUpdate:modelValue"])):(l(),y("div",mt,[ae(De).isShowPass?(l(),r(k,{key:0},{default:t(()=>[c(p(ae(Me)(W.value.key,W.value.mode,s[e.name])),1)]),_:2},1024)):(l(),y("div",ft,[((o=s[e.name])==null?void 0:o.length)>>0?(l(),r(k,{key:0},{default:t(()=>{var $;return[c(p("*".repeat(($=s[e.name])==null?void 0:$.length)),1)]}),_:2},1024)):(l(),r(k,{key:1}))]))]))]}),_:2},1032,["label","prop","required"])),["integer"].indexOf(e.type)>>>-1?V("",!0):(l(),r(g,{key:6,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[n(u,{size:2},{default:t(()=>[e.unit!==null?(l(),r(k,{key:0,tag:"b"},{default:t(()=>[c(p(e.verbose_name+"("+e.unit+")"),1)]),_:2},1024)):(l(),r(k,{key:1,tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024)),e.description.length!=0?(l(),r(a,{key:2,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(I,null,{default:t(()=>[n(z)]),_:1})]),_:1},8,["content"])):V("",!0)]),_:2},1024)]),default:t(()=>[w.value?(l(),r(ee,{key:0,modelValue:s[e.name],"onUpdate:modelValue":o=>s[e.name]=o,step:1},null,8,["modelValue","onUpdate:modelValue"])):(l(),r(k,{key:1},{default:t(()=>[c(p(s[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])),["date"].indexOf(e.type)>>>-1?V("",!0):(l(),r(g,{key:7,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[n(u,{size:2},{default:t(()=>[n(k,{tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(l(),r(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(I,null,{default:t(()=>[n(z)]),_:1})]),_:1},8,["content"])):V("",!0)]),_:2},1024)]),default:t(()=>[w.value?(l(),r(te,{key:0,modelValue:s[e.name],"onUpdate:modelValue":o=>s[e.name]=o,type:"date",placeholder:"Pick a Date",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue","onUpdate:modelValue"])):(l(),r(k,{key:1},{default:t(()=>[c(p(s[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])),["datetime"].indexOf(e.type)>>>-1?V("",!0):(l(),r(g,{key:8,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[n(u,{size:2},{default:t(()=>[n(k,{tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(l(),r(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(I,null,{default:t(()=>[n(z)]),_:1})]),_:1},8,["content"])):V("",!0)]),_:2},1024)]),default:t(()=>[w.value?(l(),r(te,{key:0,modelValue:s[e.name],"onUpdate:modelValue":o=>s[e.name]=o,type:"datetime",placeholder:"Pick a Date",format:"YYYY/MM/DD hh:mm:ss","value-format":"YYYY-MM-DD hh:mm:ss"},null,8,["modelValue","onUpdate:modelValue"])):(l(),r(k,{key:1},{default:t(()=>[c(p(s[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])),["enum"].indexOf(e.type)>>>-1?V("",!0):(l(),r(g,{key:9,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[n(u,{size:2},{default:t(()=>[n(k,{tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(l(),r(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(I,null,{default:t(()=>[n(z)]),_:1})]),_:1},8,["content"])):V("",!0)]),_:2},1024)]),default:t(()=>[w.value?(l(),r(q,{key:0,clearable:"",filterable:"",modelValue:s[e.name],"onUpdate:modelValue":o=>s[e.name]=o,placeholder:"请选择",style:{width:"240px"}},{default:t(()=>[(l(!0),y(D,null,S(ge.value[e.validation_rule],o=>(l(),r(U,{key:o.value,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):(l(),r(k,{key:1},{default:t(()=>{var o;return[c(p((o=v.value.fields[e.name])==null?void 0:o.label),1)]}),_:2},1024))]),_:2},1032,["label","prop","required"])),["model_ref"].indexOf(e.type)>>>-1?V("",!0):(l(),r(g,{key:10,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[n(u,{size:2},{default:t(()=>[n(k,{tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(l(),r(a,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[n(I,null,{default:t(()=>[n(z)]),_:1})]),_:1},8,["content"])):V("",!0)]),_:2},1024)]),default:t(()=>[w.value?(l(),r(q,{key:0,modelValue:s[e.name],"onUpdate:modelValue":o=>s[e.name]=o,clearable:"",placeholder:"请选择",style:{width:"240px"},filterable:"",remote:"","remote-method":o=>fe(o,e.name)},{default:t(()=>[(l(!0),y(D,null,S(me.value[e.name],(o,$)=>(l(),r(U,{key:$,label:o.instance_name,value:o.id},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","remote-method"])):(l(),r(k,{key:1},{default:t(()=>{var o;return[c(p((o=v.value.fields[e.name])==null?void 0:o.instance_name),1)]}),_:2},1024))]),_:2},1032,["label","prop","required"]))]),_:2},1024))),128))]),_:2},1024)]),_:2},1032,["name"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["model"])]),_:1}),n(ce,{label:"监控信息",name:"monitor",disabled:""},{default:t(()=>[..._[11]||(_[11]=[c("111",-1)])]),_:1}),n(ce,{label:"关联关系",name:"relations"},{default:t(()=>[v.value&&v.value.id?(l(),r(ut,{key:0,ref:"ciDataRelationRef",instanceId:v.value.id,modelId:v.value.model},null,8,["instanceId","modelId"])):V("",!0)]),_:1}),n(ce,{label:"变更记录",name:"changelog"},{default:t(()=>[v.value&&v.value.id?(l(),r(We,{key:0,ref_key:"ciDataAuditRef",ref:de,instanceId:v.value.id},null,8,["instanceId"])):V("",!0)]),_:1})]),_:1},8,["modelValue"])])])}}}),Vt=Ye(vt,[["__scopeId","data-v-7d8c9ba0"]]);export{Vt as default};
