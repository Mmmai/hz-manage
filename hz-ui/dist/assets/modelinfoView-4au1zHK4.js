import{d as Re,g as qe,u as he,h as De,as as al,r as c,A as W,a as _e,e as i,ak as Se,c as L,o as _,a7 as J,i as I,b as e,w as t,a8 as ee,D as B,v as S,aE as sl,k as g,t as H,ab as M,F as He,aw as Pe,al as We,am as Ze,ac as ne,ap as f,I as ce,s as Ce,_ as Ke,av as nl,f as dl,q as il,aq as ul,aZ as rl,a9 as ml}from"./index-BGjJrjF8.js";import{i as pl}from"./iconSelectCom-BVB7gxh7.js";import{u as cl}from"./tabs-feTaSe4L.js";import{l as Qe}from"./vue-draggable-plus-DPcMHoS1.js";import{u as fl}from"./ci-xSeTk7wp.js";const vl={class:"operation_show"},_l={class:"dialog-footer"},bl={class:"demo-drawer__content"},gl={style:{float:"left"}},yl={style:{float:"right",color:"var(--el-text-color-secondary)","font-size":"13px"}},wl={class:"demo-drawer__footer"},Cl=Re({__name:"ciModelField",props:{ciModelInfo:{},ciModelInfoModifiers:{}},emits:["update:ciModelInfo"],setup(be,{expose:A}){const{proxy:k}=qe(),x=he(),V=De(),$=al(be,"ciModelInfo"),O=c([]),le=c([]),de=c([]),Z=W(()=>{let o=[];return O.value.forEach(l=>{l.fields.forEach(p=>{p.type==="model_ref"&&o.push(p.ref_model)})}),o}),R=W(()=>{var l;let o=[];return(l=de.value)==null||l.forEach(p=>{p.id!==$.value.id&&(Z.value.indexOf(p.id)===-1?o.push({value:p.id,label:p.verbose_name,disabled:!1}):o.push({value:p.id,label:p.verbose_name,disabled:!0}))}),o}),T=()=>{n.default="",n.validation_rule="",n.type=="boolean"?n.default=!0:n.type=="enum"?w.value=!0:n.type=="string"&&(w.value=!1)},G=c([]),te=o=>{let l=JSON.parse(Q.value[o].rule),p=[];Object.keys(l).forEach(b=>{p.push({value:b,label:l[b]})}),G.value=p},F=o=>{let l=JSON.parse(Q.value[o].rule),p=[];Object.keys(l).forEach(b=>{p.push({value:b,label:l[b]})}),G.value=p,n.default!=G.value[0].value&&(n.default=G.value[0].value)},w=c(!1),v=W(()=>n.type==="fromModel"),K=c([]),oe=async(o=null)=>{let l=await k.$api.getValidationRules({page:1,page_size:1e4,...o});K.value=l.data.results,l.data.results.forEach(p=>{Q.value[p.id]=p})},Q=c({}),ie=W(()=>{let o=[];return K.value.forEach(l=>{l.field_type==n.type&&o.push({value:l.id,label:l.verbose_name})}),o}),U=async()=>{var l;let o=await k.$api.getCiModel(V.query,V.query.id);$.value=o.data.model,O.value=o.data.field_groups,le.value=(l=o.data.field_groups)==null?void 0:l.map(p=>p.name)},s=c([]),d=c([]);A({getModelField:U,getCiModelList:async()=>{let o=await k.$api.getCiModel();de.value=o.data.results},getRules:oe,getModelFieldType:async()=>{let o=await k.$api.getCiModelFieldType(),l=o.data.field_types;Object.keys(l).forEach(p=>{s.value.push({value:p,label:l[p]})}),d.value=o.data.limit_fields}});const N=_e({name:"",verbose_name:""}),ge=(o,l,p)=>{console.log(l),d.value.includes(l)?p(new Error(`${d.value.join(",")}不能用!`)):p()},Ve=_e({name:[{required:!0,message:"请输入唯一标识",trigger:"blur"},{pattern:/^[a-z][\w\d]{4,20}$/,trigger:"blur",message:"以英文字符开头,可以使用英文,数字,下划线,长度4-20 "}],verbose_name:[{required:!0,message:"请输入组名称",trigger:"blur"}]}),ae=c(),Y=c(!1),ue=o=>{Y.value=!1,D(o)},re=c(!1),r=c(""),u=async o=>{o&&await o.validate(async(l,p)=>{if(l)if(re.value){console.log(N);let b=await k.$api.addCiModelFieldGroup({model:$.value.id,create_user:x.state.username,update_user:x.state.username,...N});console.log(b),b.status=="201"?(f({type:"success",message:"添加成功"}),Y.value=!1,D(o),U()):f({showClose:!0,message:"添加失败:"+JSON.stringify(b.data),type:"error"})}else{let b=await k.$api.updateCiModelFieldGroup({id:r.value,update_user:x.state.username,...N});console.log(b),b.status=="200"?(f({type:"success",message:"更新成功"}),Y.value=!1,D(o),U()):f({showClose:!0,message:"更新失败:"+JSON.stringify(b.data),type:"error"})}else console.log("error submit!",p)})},se=o=>{ce.confirm("是否确认关闭?").then(()=>{o(),D(ae.value)}).catch(()=>{})},m=c("新增"),h=o=>{m.value="新增",Ce(()=>{}),Y.value=!0,re.value=!0},me=o=>{m.value="修改",Y.value=!0,Ce(()=>{re.value=!1,N.name=o.name,N.verbose_name=o.verbose_name,r.value=o.id})},Ue=o=>{ce.confirm("是否确认删除?","删除组",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{let l=await k.$api.deleteCiModelFieldGroup(o);l.status==204||l.status==200?(f({type:"success",message:"删除成功"}),await U()):f({type:"error",message:"删除失败"})}).catch(()=>{f({type:"info",message:"取消删除"})})},P=c(!1),n=_e({name:"",verbose_name:"",type:"string",required:!1,editable:!0,validation_rule:"",ref_model:"",description:"",default:"",unit:""}),Fe=_e({name:[{required:!0,message:"请输入唯一标识",trigger:"blur"},{pattern:/^[a-z][\w\d]{1,20}$/,trigger:"blur",message:"以英文字符开头,可以使用英文,数字,下划线,长度2-20 ",required:!0},{validator:ge,trigger:"blur"}],verbose_name:[{required:!0,message:"请输入字段显示名称",trigger:"blur"}],type:[{required:!0,message:"字段类型",trigger:"blur"}],model_name:[{required:v,message:"请选择模型",trigger:"blur"}],validation_rule:[{required:w,message:"选择校验规则",trigger:""}]}),fe=c();c(!1);const pe=c(!1),E=c({}),ye=c(!0),Ne=o=>{P.value=!0,m.value="修改",pe.value=!0,E.value=o,ye.value=!1,Ce(()=>{Object.keys(o).forEach(l=>{n.hasOwnProperty(l)&&(n[l]=o[l])}),n.validation_rule===null?w.value=!1:w.value=!0})},Le=o=>{D(o),console.log(n),P.value=!1},Te=o=>{m.value="新增",E.value={},P.value=!0,ye.value=!0,pe.value=!1,w.value=!1,Ce(()=>{r.value=o.id})},je=async o=>{o&&await o.validate(async(l,p)=>{if(l)if(ye.value){let b=await k.$api.addCiModelField({model:$.value.id,model_field_group:r.value,create_user:x.state.username,update_user:x.state.username,...n});console.log(b),b.status=="201"?(f({type:"success",message:"添加成功"}),P.value=!1,D(o),U()):f({showClose:!0,message:"添加失败:"+JSON.stringify(b.data),type:"error"})}else{w.value||(n.validation_rule="");let b=await k.$api.updateCiModelField({id:E.value.id,update_user:x.state.username,...n});console.log(b),b.status=="200"?(f({type:"success",message:"更新成功"}),P.value=!1,D(o),U()):f({showClose:!0,message:"更新失败:"+JSON.stringify(b.data),type:"error"})}else console.log("error submit!",p)})},Ie=o=>{ce.confirm("是否确认关闭?").then(()=>{o(),D(fe.value),P.value=!1}).catch(()=>{})},C=o=>{ce.confirm("是否确认删除?","删除组",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await k.$api.deleteCiModelField(E.value.id)).status==204?(f({type:"success",message:"删除成功"}),await U(),D(fe.value),P.value=!1):f({type:"error",message:"删除失败"})}).catch(()=>{f({type:"info",message:"取消删除"})})},D=o=>{o&&o.resetFields()},Be=async(o,l)=>{if(o.oldIndex==o.newIndex)return;if(o.pullMode){console.log("跨组移动，在onAdd中触发");return}let p=await k.$api.updateCiModelField({id:o.data.id,order:o.newIndex+1});p.status=="200"?f({type:"success",message:"更新排序成功"}):f({showClose:!0,message:"更新排序失败:"+JSON.stringify(p.data),type:"error"}),U()},Xe=async(o,l)=>{let p=await k.$api.updateCiModelField({id:o.data.id,order:o.newIndex+1,model_field_group:l.id});p.status=="200"?f({type:"success",message:"更新排序成功"}):f({showClose:!0,message:"更新排序失败:"+JSON.stringify(p.data),type:"error"}),U()};return(o,l)=>{const p=i("el-text"),b=i("el-button"),Me=i("el-tooltip"),Ye=i("el-space"),Ae=i("el-col"),ze=i("el-row"),Je=i("el-card"),el=i("el-collapse-item"),ll=i("el-collapse"),we=i("el-input"),z=i("el-form-item"),Ge=i("el-form"),tl=i("el-dialog"),Oe=i("el-switch"),ke=i("el-option"),xe=i("el-select"),ol=i("el-drawer"),ve=Se("permission");return _(),L(J,null,[I("div",null,[e(ll,{modelValue:le.value,"onUpdate:modelValue":l[0]||(l[0]=y=>le.value=y)},{default:t(()=>[(_(!0),L(J,null,ee(O.value,(y,$e)=>(_(),B(el,{name:y.name,key:$e},{title:t(()=>[e(p,{tag:"b",size:"large"},{default:t(()=>[g(H(y.verbose_name),1)]),_:2},1024),I("div",vl,[y.built_in?He("",!0):(_(),B(Ye,{key:0},{default:t(()=>{var a;return[M((_(),B(Me,{class:"box-item",effect:"dark",content:"编辑",placement:"top"},{default:t(()=>{var j;return[M(e(b,{size:"small",onClick:Pe(Ee=>me(y),["stop"]),icon:S(We),circle:""},null,8,["onClick","icon"]),[[ve,`${(j=S(V).name)==null?void 0:j.replace("_info","")}:edit`]])]}),_:2},1024)),[[ve,`${(a=S(V).name)==null?void 0:a.replace("_info","")}:edit`]]),e(Me,{class:"box-item",effect:"dark",content:"删除",placement:"top"},{default:t(()=>{var j;return[M(e(b,{size:"small",onClick:Pe(Ee=>Ue(y.id),["stop"]),icon:S(Ze),circle:""},null,8,["onClick","icon"]),[[ve,`${(j=S(V).name)==null?void 0:j.replace("_info","")}:delete`]])]}),_:2},1024)]}),_:2},1024))])]),default:t(()=>[I("div",null,[e(S(Qe),{"force-fallback":!0,"scroll-sensitivity":200,ref_for:!0,ref:"el",group:"modelField",modelValue:y.fields,"onUpdate:modelValue":a=>y.fields=a,onEnd:a=>Be(a,y),onAdd:a=>Xe(a,y),style:{width:"100%","flex-wrap":"wrap",display:"flex",gap:"10px","justify-items":"flex-start"}},{default:t(()=>{var a;return[(_(!0),L(J,null,ee(y.fields,(j,Ee)=>(_(),L("div",{key:Ee},[e(Me,{effect:"light",content:"点击编辑字段",placement:"top"},{default:t(()=>[e(Je,{shadow:"hover",class:sl(["modelFieldCard",j.built_in?"isBuiltClass":""]),onClick:Nl=>Ne(j)},{default:t(()=>[e(p,{tag:"b"},{default:t(()=>[g(H(j.verbose_name),1)]),_:2},1024),e(ze,{justify:"space-between"},{default:t(()=>[e(Me,{class:"box-item",effect:"light",content:j.name,placement:"bottom"},{default:t(()=>[e(Ae,{span:13,class:"describe-class"},{default:t(()=>[e(p,null,{default:t(()=>[g(H(j.name),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["content"]),e(Me,{class:"box-item",effect:"light",content:j.type,placement:"bottom"},{default:t(()=>[e(Ae,{span:10,class:"describe-class"},{default:t(()=>[e(p,null,{default:t(()=>[g(H(j.type),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["content"])]),_:2},1024)]),_:2},1032,["class","onClick"])]),_:2},1024)]))),128)),I("div",null,[M((_(),B(Je,{class:"modelFieldCard",style:{"align-items":"center","justify-content":"center"},onClick:j=>Te(y)},{default:t(()=>[e(p,{type:"primary"},{default:t(()=>l[26]||(l[26]=[g("+ 添加字段")])),_:1})]),_:2},1032,["onClick"])),[[ve,`${(a=S(V).name)==null?void 0:a.replace("_info","")}:add`]])])]}),_:2},1032,["modelValue","onUpdate:modelValue","onEnd","onAdd"])])]),_:2},1032,["name"]))),128))]),_:1},8,["modelValue"]),e(ze,{style:{"margin-top":"10px"}},{default:t(()=>[e(Ae,null,{default:t(()=>{var y;return[M((_(),B(b,{bg:"",text:"",onClick:l[1]||(l[1]=$e=>h($.value))},{default:t(()=>l[27]||(l[27]=[g("添加分组")])),_:1})),[[ve,`${(y=S(V).name)==null?void 0:y.replace("_info","")}:add`]])]}),_:1})]),_:1})]),e(tl,{modelValue:Y.value,"onUpdate:modelValue":l[6]||(l[6]=y=>Y.value=y),title:m.value+"字段分组",width:"500","before-close":se},{footer:t(()=>[I("div",_l,[e(b,{onClick:l[4]||(l[4]=y=>ue(ae.value))},{default:t(()=>l[28]||(l[28]=[g("取消")])),_:1}),e(b,{type:"primary",onClick:l[5]||(l[5]=y=>u(ae.value))},{default:t(()=>l[29]||(l[29]=[g(" 确认 ")])),_:1})])]),default:t(()=>[e(Ge,{ref_key:"groupFormRef",ref:ae,style:{"max-width":"600px"},model:N,rules:Ve,"label-width":"auto",class:"demo-modelForm","status-icon":""},{default:t(()=>[e(z,{label:"字段组标识",prop:"name"},{default:t(()=>[e(we,{modelValue:N.name,"onUpdate:modelValue":l[2]||(l[2]=y=>N.name=y),disabled:!re.value},null,8,["modelValue","disabled"])]),_:1}),e(z,{label:"字段分组名称",prop:"verbose_name"},{default:t(()=>[e(we,{modelValue:N.verbose_name,"onUpdate:modelValue":l[3]||(l[3]=y=>N.verbose_name=y)},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"]),e(ol,{modelValue:P.value,"onUpdate:modelValue":l[25]||(l[25]=y=>P.value=y),title:"模型字段","before-close":Ie,direction:"rtl",class:"demo-drawer"},{default:t(()=>{var y,$e;return[I("div",bl,[e(Ge,{model:n,ref_key:"modelFieldFormRef",ref:fe,"label-width":"auto","label-position":"right",rules:Fe},{default:t(()=>[e(z,{label:"唯一标识",prop:"name"},{default:t(()=>[e(we,{modelValue:n.name,"onUpdate:modelValue":l[7]||(l[7]=a=>n.name=a),autocomplete:"off",disabled:!!(E.value.built_in||pe.value)},null,8,["modelValue","disabled"])]),_:1}),e(z,{label:"显示名称",prop:"verbose_name"},{default:t(()=>[e(we,{modelValue:n.verbose_name,"onUpdate:modelValue":l[8]||(l[8]=a=>n.verbose_name=a),autocomplete:"off"},null,8,["modelValue"])]),_:1}),e(z,{label:"可编辑",prop:"editable"},{default:t(()=>[e(Oe,{modelValue:n.editable,"onUpdate:modelValue":l[9]||(l[9]=a=>n.editable=a),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},disabled:E.value.built_in},null,8,["modelValue","disabled"])]),_:1}),e(z,{label:"必填",prop:"required"},{default:t(()=>[e(Oe,{modelValue:n.required,"onUpdate:modelValue":l[10]||(l[10]=a=>n.required=a),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"}},null,8,["modelValue"])]),_:1}),e(z,{label:"字段类型",prop:"type"},{default:t(()=>[e(xe,{modelValue:n.type,"onUpdate:modelValue":l[11]||(l[11]=a=>n.type=a),placeholder:"Select",style:{width:"240px"},onChange:T,disabled:!!(E.value.built_in||pe.value)},{default:t(()=>[(_(!0),L(J,null,ee(s.value,a=>(_(),B(ke,{key:a.value,label:a.label,value:a.value},{default:t(()=>[I("span",gl,H(a.label),1),I("span",yl,H(a.value),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),M(e(z,{label:"校验规则",prop:"validation_rule"},{default:t(()=>[e(Oe,{modelValue:w.value,"onUpdate:modelValue":l[12]||(l[12]=a=>w.value=a),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949","margin-right":"10px"}},null,8,["modelValue"]),M(e(xe,{modelValue:n.validation_rule,"onUpdate:modelValue":l[13]||(l[13]=a=>n.validation_rule=a),placeholder:"选择校验规则",style:{width:"240px"}},{default:t(()=>[(_(!0),L(J,null,ee(ie.value,a=>(_(),B(ke,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),[[ne,w.value]])]),_:1},512),[[ne,n.type==="string"]]),M(e(z,{label:"枚举值",prop:"validation_rule"},{default:t(()=>[e(xe,{modelValue:n.validation_rule,"onUpdate:modelValue":l[14]||(l[14]=a=>n.validation_rule=a),placeholder:"选择校验规则",style:{width:"240px"},onChange:l[15]||(l[15]=a=>F(n.validation_rule))},{default:t(()=>[(_(!0),L(J,null,ee(ie.value,a=>(_(),B(ke,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},512),[[ne,n.type==="enum"]]),M(e(z,{label:"默认值",prop:"default"},{default:t(()=>[e(xe,{modelValue:n.default,"onUpdate:modelValue":l[16]||(l[16]=a=>n.default=a),placeholder:"选择默认值",size:"large",onVisibleChange:l[17]||(l[17]=a=>te(n.validation_rule))},{default:t(()=>[(_(!0),L(J,null,ee(G.value,(a,j)=>(_(),B(ke,{key:j,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},512),[[ne,n.type==="enum"]]),M(e(z,{label:"模型引用",prop:"ref_model"},{default:t(()=>[e(xe,{modelValue:n.ref_model,"onUpdate:modelValue":l[18]||(l[18]=a=>n.ref_model=a),placeholder:"选择CI模型",disabled:!!(E.value.built_in||pe.value)},{default:t(()=>[(_(!0),L(J,null,ee(R.value,a=>(_(),B(ke,{key:a.value,label:a.label,disabled:a.disabled,value:a.value},null,8,["label","disabled","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1},512),[[ne,n.type==="model_ref"]]),M(e(z,{label:"默认值",prop:"default"},{default:t(()=>[e(Oe,{modelValue:n.default,"onUpdate:modelValue":l[19]||(l[19]=a=>n.default=a),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"}},null,8,["modelValue"])]),_:1},512),[[ne,n.type==="boolean"]]),M(e(z,{label:"单位",prop:"unit"},{default:t(()=>[e(we,{modelValue:n.unit,"onUpdate:modelValue":l[20]||(l[20]=a=>n.unit=a),style:{width:"120px"}},null,8,["modelValue"])]),_:1},512),[[ne,n.type==="integer"||n.type==="float"]]),e(z,{label:"描述",prop:"description"},{default:t(()=>[e(we,{modelValue:n.description,"onUpdate:modelValue":l[21]||(l[21]=a=>n.description=a),type:"textarea"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),I("div",wl,[e(b,{onClick:l[22]||(l[22]=a=>Le(fe.value))},{default:t(()=>l[30]||(l[30]=[g("取消")])),_:1}),pe.value&&!E.value.built_in?M((_(),B(b,{key:0,type:"danger",onClick:l[23]||(l[23]=a=>C())},{default:t(()=>l[31]||(l[31]=[g("删除")])),_:1})),[[ve,`${(y=S(V).name)==null?void 0:y.replace("_info","")}:delete`]]):He("",!0),M((_(),B(b,{type:"primary",onClick:l[24]||(l[24]=a=>je(fe.value))},{default:t(()=>l[32]||(l[32]=[g(" 确定 ")])),_:1})),[[ve,`${($e=S(V).name)==null?void 0:$e.replace("_info","")}:edit`]])])])]}),_:1},8,["modelValue"])],64)}}}),Vl=Ke(Cl,[["__scopeId","data-v-f36105c5"]]),Fl={style:{width:"100%"}},Ml={class:"table-header"},kl={class:"header-button-lf"},xl={class:"dialog-footer"},$l=Re({__name:"ciModelUnique",props:["modelId","modelFieldLists"],setup(be,{expose:A}){const k=De(),{proxy:x}=qe(),V=he(),$=c([]),O=be,le=()=>{T.value=!0,te.value=!0};W(()=>{let s={};return O.modelFieldLists.forEach(d=>{s[d.name]=d.verbose_name}),s});const de=W(()=>{let s={};return O.modelFieldLists.forEach(d=>{s[d.id]=d.verbose_name}),s}),Z=c(""),R=_e({fields:[],validate_null:!1,description:null}),T=c(!1),G=()=>{T.value=!1,v(Z.value)},te=c(!0),F=c({}),w=s=>{F.value=s,T.value=!0,te.value=!1,Ce(()=>{Object.keys(s).forEach(d=>{d!=="id"&&Object.keys(R).indexOf(d)!==-1&&(R[d]=s[d])})})},v=s=>{s&&(s.resetFields(),F.value={})},K=async s=>{await s.validate(async(d,X)=>{if(d)if(te.value){let q=await x.$api.addCiModelUnique({create_user:V.state.username,update_user:V.state.username,...R,model:O.modelId});q.status=="201"?(f({type:"success",message:"添加成功"}),T.value=!1,v(s),U({model:O.modelId})):f({showClose:!0,message:"添加失败:"+JSON.stringify(q.data),type:"error"})}else{let q=await x.$api.updateCiModelUnique({id:F.value.id,update_user:V.state.username,...R});q.status=="200"?(f({type:"success",message:"更新成功"}),T.value=!1,v(s),U({model:O.modelId})):f({showClose:!0,message:"更新失败:"+JSON.stringify(q.data),type:"error"})}})},oe=async s=>{let d=await x.$api.updateCiModelUnique({update_user:V.state.username,...s});d.status=="200"?(f({type:"success",message:"更新成功"}),v(Z.value),U({model:O.modelId})):f({showClose:!0,message:"更新失败:"+JSON.stringify(d.data),type:"error"})},Q=s=>{ce.confirm("是否确认删除?","删除",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await x.$api.deleteCiModelUnique(s)).status==204?(f({type:"success",message:"删除成功"}),U({model:O.modelId}),v(Z.value),T.value=!1):f({type:"error",message:"删除失败"})}).catch(()=>{f({type:"info",message:"取消删除"})})},ie=W(()=>{let s={};return $.value.forEach(d=>{var q;let X=d.fields.map(N=>de.value[N]);s[(q=d.fields)==null?void 0:q.join("+")]=X.join("+")}),s}),U=async s=>{let d=await x.$api.getCiModelUnique(s);$.value=d.data.results};return A({getTableData:U}),(s,d)=>{const X=i("el-button"),q=i("el-table-column"),N=i("el-switch"),ge=i("el-tooltip"),Ve=i("el-table"),ae=i("el-option"),Y=i("el-select"),ue=i("el-form-item"),re=i("el-input"),r=i("el-form"),u=i("el-dialog"),se=Se("permission");return _(),L("div",Fl,[I("div",Ml,[I("div",kl,[e(X,{type:"primary",onClick:le},{default:t(()=>d[5]||(d[5]=[g("添加")])),_:1})])]),e(Ve,{ref:"multipleTableRef",data:$.value,style:{width:"100%"},border:""},{default:t(()=>[e(q,{prop:"fields",label:"校验规则"},{default:t(m=>[I("span",null,H(ie.value[m.row.fields.join("+")]),1)]),_:1}),e(q,{prop:"validate_null",label:"空值校验"},{default:t(m=>{var h;return[M(e(N,{modelValue:m.row.validate_null,"onUpdate:modelValue":me=>m.row.validate_null=me,class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},onChange:me=>oe({id:m.row.id,validate_null:m.row.validate_null}),disabled:m.row.built_in},null,8,["modelValue","onUpdate:modelValue","onChange","disabled"]),[[se,{id:`${(h=S(k).name)==null?void 0:h.replace("_info","")}:edit`,action:"disabled"}]])]}),_:1}),e(q,{prop:"description",label:"描述"}),e(q,{fixed:"right",width:"100",label:"操作"},{default:t(m=>[e(ge,{class:"box-item",effect:"dark",content:"编辑",placement:"top"},{default:t(()=>{var h;return[M(e(X,{link:"",type:"primary",icon:S(We),onClick:me=>w(m.row)},null,8,["icon","onClick"]),[[se,`${(h=S(k).name)==null?void 0:h.replace("_info","")}:edit`]])]}),_:2},1024),e(ge,{class:"box-item",effect:"dark",content:"删除",placement:"top"},{default:t(()=>{var h;return[M(e(X,{link:"",type:"danger",icon:S(Ze),disabled:m.row.built_in,onClick:me=>Q(m.row.id)},null,8,["icon","disabled","onClick"]),[[se,`${(h=S(k).name)==null?void 0:h.replace("_info","")}:delete`]])]}),_:2},1024)]),_:1})]),_:1},8,["data"]),e(u,{modelValue:T.value,"onUpdate:modelValue":d[4]||(d[4]=m=>T.value=m),title:"唯一校验配置",width:"500","before-close":G},{footer:t(()=>[I("div",xl,[e(X,{onClick:G},{default:t(()=>d[6]||(d[6]=[g("取消")])),_:1}),e(X,{type:"primary",onClick:d[3]||(d[3]=m=>K(Z.value))},{default:t(()=>d[7]||(d[7]=[g(" 提交 ")])),_:1})])]),default:t(()=>[e(r,{inline:!0,"label-position":"right",model:R,"label-width":"auto",ref_key:"formRef",ref:Z},{default:t(()=>[e(ue,{label:"唯一校验组合",prop:"fields"},{default:t(()=>[e(Y,{modelValue:R.fields,"onUpdate:modelValue":d[0]||(d[0]=m=>R.fields=m),fields:"选择字段组合",multiple:"","multiple-limit":5,clearable:"",filterable:"",style:{width:"240px"},disabled:!!F.value.built_in},{default:t(()=>[(_(!0),L(J,null,ee(O.modelFieldLists,(m,h)=>(_(),B(ae,{label:m.verbose_name,value:m.id,key:h},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),e(ue,{label:"空置校验",prop:"validate_null"},{default:t(()=>[e(N,{modelValue:R.validate_null,"onUpdate:modelValue":d[1]||(d[1]=m=>R.validate_null=m),class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},disabled:F.value.built_in},null,8,["modelValue","disabled"])]),_:1}),e(ue,{label:"描述",prop:"description"},{default:t(()=>[e(re,{modelValue:R.description,"onUpdate:modelValue":d[2]||(d[2]=m=>R.description=m),style:{width:"240px"},autosize:{minRows:2,maxRows:4},type:"textarea"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),Ul={class:"card"},Il={class:"listItem"},Ol={style:{display:"flex","flex-direction":"row","justify-content":"center","align-items":"center"}},Rl=Re({__name:"ciModelTemplateName",props:["modelId","modelFieldLists","ciModelInfo"],setup(be,{expose:A}){const{proxy:k}=qe();he();const x=be,V=c(!1),$=c([]),O=w=>{},le=W(()=>x.modelFieldLists.filter(w=>["string","enum","model_ref"].includes(w.type))),de=W(()=>{let w=new Object;return x.modelFieldLists.forEach(v=>{w[v.id]=v}),w}),Z=()=>{},R=()=>{V.value=!0},T=()=>{V.value=!1},G=async()=>{let w=await k.$api.updateInstanceName(x.modelId);console.log(w),nl({title:"Success",message:"更新任务提交成功",type:"success"})};c(0);const te=async()=>{let w=await k.$api.updateCiModel({id:x.modelId,instance_name_template:$.value});w.status=="200"?(f({type:"success",message:"更新成功"}),ce.confirm("更新成功，是否自动更新实例唯一标识?","Warning",{confirmButtonText:"确认",cancelButtonText:"取消",type:"warning"}).then(()=>{G()}).catch(()=>{f({type:"info",message:"Delete canceled"})}),V.value=!1,F()):f({showClose:!0,message:"更新失败:"+JSON.stringify(w.data),type:"error"})},F=async()=>{let w=await k.$api.getCiModel(null,x.modelId);$.value=w.data.model.instance_name_template};return A({getModel:F}),(w,v)=>{const K=i("el-button"),oe=i("el-divider"),Q=i("el-checkbox"),ie=i("el-checkbox-group"),U=Se("throttle");return _(),L(J,null,[v[9]||(v[9]=I("div",null,null,-1)),I("div",Ul,[M(e(K,{type:"primary",onClick:R},{default:t(()=>v[2]||(v[2]=[g("编辑")])),_:1},512),[[ne,!V.value]]),M((_(),B(K,{type:"primary",onClick:G},{default:t(()=>v[3]||(v[3]=[g("更新唯一标识")])),_:1})),[[U]]),M(e(K,{onClick:T},{default:t(()=>v[4]||(v[4]=[g("取消")])),_:1},512),[[ne,V.value]]),M(e(K,{type:"primary",onClick:te},{default:t(()=>v[5]||(v[5]=[g("保存")])),_:1},512),[[ne,V.value]]),e(oe,null,{default:t(()=>v[6]||(v[6]=[g("可选择指标")])),_:1}),e(ie,{modelValue:$.value,"onUpdate:modelValue":v[0]||(v[0]=s=>$.value=s),onChange:O,max:5,disabled:!V.value},{default:t(()=>[(_(!0),L(J,null,ee(le.value,(s,d)=>(_(),B(Q,{key:d,label:s.verbose_name,value:s.id},{default:t(()=>[g(H(s.verbose_name),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),e(oe,null,{default:t(()=>v[7]||(v[7]=[g("拖拽调整顺序")])),_:1}),e(S(Qe),{disabled:!V.value,modelValue:$.value,"onUpdate:modelValue":v[1]||(v[1]=s=>$.value=s),"force-fallback":!0,"scroll-sensitivity":200,ref:"el",onEnd:Z,style:{width:"100%",overflow:"auto"}},{default:t(()=>[(_(!0),L(J,null,ee($.value,(s,d)=>(_(),L("div",{key:d},[I("div",Il,[I("span",null,H(de.value[s].verbose_name),1)])]))),128))]),_:1},8,["disabled","modelValue"]),e(oe,null,{default:t(()=>v[8]||(v[8]=[g("效果预览")])),_:1}),I("div",Ol,[I("h3",null,H($.value.map(s=>de.value[s].verbose_name).join(" - ")),1)])])],64)}}}),ql={class:"card"},hl={class:"dialog-footer"},Sl=Re({__name:"modelinfoView",setup(be){const A=De(),k=cl(),x=fl(),V=()=>{x.setCiLastModel(F.value.id),console.log(W(()=>x.ciLastModel).value),Ce(()=>{de.push({path:"/cmdb/cidata"})})},$=c(""),O=c(""),le=c(""),de=dl(),Z=he(),{proxy:R}=qe();c("");const T=c([]),G=async()=>{let r=await R.$api.getCiModelGroup();console.log(r),T.value=r.data.results,console.log(T.value)},te=c({}),F=c({}),w=async()=>{let r=await R.$api.getCiModel(A.query,A.query.id);F.value=r.data.model,te.value=r.data,console.log(F.value)},v=W(()=>{var u;let r=new Array;return(u=te.value.field_groups)==null||u.forEach(se=>{se.fields.forEach(m=>{r.push(m)})}),r}),K=(r,u)=>{r.props.name==="verification"?$.value.getTableData({model:U.value}):r.props.name==="field"||r.props.name==="instance_name_temp"&&le.value.getModel()},oe=c("field");console.log(A);const Q=c(!1),ie=()=>{Q.value=!0};c("ElemeFilled");const U=W(()=>{var r;return(r=F.value)==null?void 0:r.id}),s=_e({name:"",verbose_name:"",model_group:"",icon:"ElemeFilled",built_in:!1,update_user:"admin"}),d=c(),X=_e({name:[{required:!0,message:"请输入模型标识",trigger:"blur"},{pattern:/^[a-z][a-z_]{3,20}$/,trigger:"blur",message:"以英文字符开头,可以使用英文,下划线,长度3-20 ",required:!0}],verbose_name:[{required:!0,message:"请输入模型名称",trigger:"blur"}],model_group:[{required:!0,message:"请选择分组",trigger:"blur"}]});c(!1);const q=c(!1),N=r=>{q.value=!1,ae(r)},ge=async r=>{r&&await r.validate(async(u,se)=>{if(u){let m=await R.$api.updateCiModel({id:ue.value,...s});console.log(m),m.status=="200"?(f({type:"success",message:"更新成功"}),q.value=!1,ae(r),getCiModelInfo(A.query,A.query.id)):f({showClose:!0,message:"添加失败:"+JSON.stringify(m.data),type:"error"})}})},Ve=r=>{ce.confirm("是否确认关闭?").then(()=>{r(),ae(d.value)}).catch(()=>{})},ae=r=>{r&&r.resetFields()},Y=r=>{ce.confirm("是否确认删除?","删除组",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await R.$api.deleteCiModel(r)).status==204?(f({type:"success",message:"删除成功"}),k.removeTabs(A.path,!0)):f({type:"error",message:"删除失败"})}).catch(()=>{f({type:"info",message:"取消删除"})})},ue=c(""),re=r=>{console.log(r),s.icon=r.icon,s.verbose_name=r.verbose_name,s.name=r.name,s.model_group=r.model_group,s.update_user=Z.state.username,console.log(s),q.value=!0,ue.value=r.id,G()};return il(async()=>{console.log("onMount"),await w(),await O.value.getModelField(),await O.value.getCiModelList(),await O.value.getRules(),await O.value.getModelFieldType()}),ul(()=>{console.log("onUnmounted")}),rl(()=>{console.log("onBeforeMount")}),(r,u)=>{const se=ml,m=i("el-button"),h=i("el-text"),me=i("el-link"),Ue=i("el-space"),P=i("el-col"),n=i("el-row"),Fe=i("el-tab-pane"),fe=i("el-tabs"),pe=i("el-scrollbar"),E=i("el-form-item"),ye=i("el-input"),Ne=i("el-option"),Le=i("el-select"),Te=i("el-form"),je=i("el-dialog"),Ie=Se("permission");return _(),L(J,null,[I("div",ql,[e(pe,null,{default:t(()=>[e(n,{class:"cimodelinfo",justify:"space-between"},{default:t(()=>[e(P,{span:20},{default:t(()=>[e(Ue,{size:30},{default:t(()=>[e(m,{size:"large",circle:"",disabled:"",style:{margin:"10px"}},{default:t(()=>{var C;return[e(se,{icon:(C=F.value)==null?void 0:C.icon},null,8,["icon"])]}),_:1}),e(h,null,{default:t(()=>[u[12]||(u[12]=g("唯一标识:   ")),e(h,{tag:"b"},{default:t(()=>[g(H(F.value.name),1)]),_:1})]),_:1}),e(h,null,{default:t(()=>[u[13]||(u[13]=g("名称:   ")),e(h,{tag:"b"},{default:t(()=>[g(H(F.value.verbose_name),1)]),_:1})]),_:1}),e(h,{style:{display:"flex"}},{default:t(()=>[u[14]||(u[14]=g("实例数:   ")),e(me,{type:"primary",tag:"b",onClick:u[0]||(u[0]=C=>V())},{default:t(()=>[g(H(F.value.instance_count),1)]),_:1})]),_:1})]),_:1})]),_:1}),e(P,{span:2,style:{display:"flex","align-items":"center","justify-content":"center"}},{default:t(()=>[e(Ue,{alignment:"flex-end"},{default:t(()=>{var C,D;return[M(e(m,{disabled:F.value.built_in,icon:"Delete",onClick:u[1]||(u[1]=Be=>Y(F.value.id)),circle:""},null,8,["disabled"]),[[Ie,`${(C=S(A).name)==null?void 0:C.replace("_info","")}:delete`]]),M(e(m,{disabled:F.value.built_in,icon:"Edit",onClick:u[2]||(u[2]=Be=>re(F.value)),circle:""},null,8,["disabled"]),[[Ie,`${(D=S(A).name)==null?void 0:D.replace("_info","")}:edit`]])]}),_:1})]),_:1})]),_:1}),e(fe,{modelValue:oe.value,"onUpdate:modelValue":u[3]||(u[3]=C=>oe.value=C),type:"card",class:"demo-tabs",onTabClick:K},{default:t(()=>[e(Fe,{label:"模型字段",name:"field"},{default:t(()=>[e(Vl,{ref_key:"ciModelFieldRef",ref:O},null,512)]),_:1}),e(Fe,{label:"唯一校验",name:"verification"},{default:t(()=>[e($l,{modelId:U.value,modelFieldLists:v.value,ref_key:"ciModelUniqueRef",ref:$},null,8,["modelId","modelFieldLists"])]),_:1}),e(Fe,{label:"唯一标识命名",name:"instance_name_temp"},{default:t(()=>[e(Rl,{modelId:U.value,ciModelInfo:F.value,modelFieldLists:v.value,ref_key:"ciModelTemplateRef",ref:le},null,8,["modelId","ciModelInfo","modelFieldLists"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),e(je,{modelValue:q.value,"onUpdate:modelValue":u[11]||(u[11]=C=>q.value=C),title:"编辑模型",width:"500","before-close":Ve},{footer:t(()=>[I("div",hl,[e(m,{onClick:u[9]||(u[9]=C=>N(d.value))},{default:t(()=>u[15]||(u[15]=[g("取消")])),_:1}),e(m,{type:"primary",onClick:u[10]||(u[10]=C=>ge(d.value))},{default:t(()=>u[16]||(u[16]=[g(" 确认 ")])),_:1})])]),default:t(()=>[e(Te,{ref_key:"modelFormRef",ref:d,style:{"max-width":"600px"},model:s,rules:X,"label-width":"auto",class:"demo-modelForm","status-icon":""},{default:t(()=>[e(E,{label:"模型图标",prop:"icon"},{default:t(()=>[e(m,{onClick:ie,icon:s.icon},null,8,["icon"]),e(pl,{isShow:Q.value,"onUpdate:isShow":u[4]||(u[4]=C=>Q.value=C),iconName:s.icon,"onUpdate:iconName":u[5]||(u[5]=C=>s.icon=C)},null,8,["isShow","iconName"])]),_:1}),e(E,{label:"唯一标识",prop:"name"},{default:t(()=>[e(ye,{modelValue:s.name,"onUpdate:modelValue":u[6]||(u[6]=C=>s.name=C),placeholder:"请输入模型的唯一标识",disabled:""},null,8,["modelValue"])]),_:1}),e(E,{label:"模型名称",prop:"verbose_name"},{default:t(()=>[e(ye,{modelValue:s.verbose_name,"onUpdate:modelValue":u[7]||(u[7]=C=>s.verbose_name=C)},null,8,["modelValue"])]),_:1}),e(E,{label:"所属分组",prop:"model_group"},{default:t(()=>[e(Le,{modelValue:s.model_group,"onUpdate:modelValue":u[8]||(u[8]=C=>s.model_group=C),placeholder:"选择分组"},{default:t(()=>[(_(!0),L(J,null,ee(T.value,(C,D)=>(_(),B(Ne,{label:C.verbose_name,value:C.id,key:D},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])],64)}}}),El=Ke(Sl,[["__scopeId","data-v-843b419b"]]);export{El as default};
