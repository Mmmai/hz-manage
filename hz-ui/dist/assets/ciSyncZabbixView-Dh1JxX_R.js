import{d as re,g as ue,u as de,r as l,h as pe,A as ce,a as ve,z as N,q as be,aq as me,e as o,ak as P,c as H,o as i,i as Z,ab as p,b as n,w as s,D as c,k as v,v as b,a7 as fe,a8 as ge,j as ye,t as L,ae as _e,ap as x,s as F}from"./index-CuRggFqw.js";const xe={class:"card"},ke={class:"table-header"},we={class:"header-button-lf"},$e={class:"header-button-ri"},ze=re({name:"ciSyncZabbix",__name:"ciSyncZabbixView",setup(Se){const{proxy:k}=ue();de();const A=l([]),m=pe(),$=l("name"),S=l(""),C=l(!0),I=l([{value:"name",label:"唯一标识",sort:!0,filter:!0,type:"string",required:!0},{value:"ip",label:"主机ip",sort:!1,filter:!0,type:"string",required:!0}]),K=ce(()=>{let t=[];return I.value.forEach(e=>{e.filter&&t.push({name:e.label,value:e.value})}),t});l("");const T=ve({name:null,verbose_name:null,field_type:"string",type:"regex",rule:null,description:null});N(()=>T.field_type,t=>{T.type=Q.value[t][0].type},{deep:!0});const j=l(1),z=l(10),R=l("default"),J=l(!1),U=l(0),q=()=>{r()},f=l({ordering:"-update_time"}),G=t=>{f.value={ordering:"-update_time"},t.order==="ascending"?f.value.ordering=t.prop:t.order==="descending"?f.value.ordering="-"+t.prop:f.value={ordering:"-update_time"},r()};l(!1),l(!0),l({}),l({}),l([]);const Q=l([]),r=async(t=null)=>{let e=await k.$api.getZabbixSync({page:j.value,page_size:z.value,...d.value,...f.value,...t});A.value=e.data.results,U.value=e.data.count,C.value=!1};be(()=>{r()});const V=l([]),W=t=>{V.value=t.map(e=>e.id)},B={0:{level:"info",label:"未知"},1:{level:"success",label:"可用"},2:{level:"danger",label:"不可用"}},d=l({});N(S,t=>{d.value[$.value]=t});const X=t=>{Object.keys(t)[0]==="agent_installed"?Object.values(t)[0].length>1?d.value[`${Object.keys(t)[0]}`]=null:d.value[Object.keys(t)[0]]=Object.values(t)[0][0]:(console.log(t),Object.values(t)[0].length>0?d.value[`${Object.keys(t)[0]}__in`]=Object.values(t)[0].join(","):d.value[Object.keys(t)[0]]=null),F(()=>{r()})},Y=async()=>{(await k.$api.updateZabbixAvailability()).status==200&&x({type:"success",message:"触发成功"})},ee=async()=>{await k.$api.syncZabbixHost(),x({type:"success",message:"触发主机同步~"})},O=l(null),te=t=>{O.value=new EventSource(t),O.value.onmessage=e=>{console.log(e),JSON.parse(e.data).status==="completed"&&(D(),F(()=>{r()}))}},D=()=>{var t;(t=O.value)==null||t.close()},h=async t=>{let e=await k.$api.installAgent(t);e.status==200?e.data.cache_key?(x({type:"success",message:"触发成功"}),C.value=!0,te(`/api/v1/agent_status_sse/?cache_key=${e.data.cache_key}`)):x({type:"error",message:`触发失败:${e.data.message}`}):x({type:"error",message:"触发失败"})};return me(()=>{D()}),(t,e)=>{var M;const g=o("el-button"),w=o("el-tooltip"),ae=o("el-option"),le=o("el-select"),ne=o("el-input"),u=o("el-table-column"),E=o("el-tag"),se=o("el-table"),oe=o("el-pagination"),y=P("permission"),ie=P("loading");return i(),H("div",xe,[Z("div",ke,[Z("div",we,[n(w,{class:"box-item",effect:"dark",content:"触发主机信息同步到zabbix",placement:"top"},{default:s(()=>{var a;return[p((i(),c(g,{type:"primary",onClick:e[0]||(e[0]=_=>ee())},{default:s(()=>e[12]||(e[12]=[v("触发同步")])),_:1})),[[y,`${(a=b(m).name)==null?void 0:a.replace("_info","")}:add`]])]}),_:1}),n(w,{class:"box-item",effect:"dark",content:"更新Zabbix接口可用性的状态信息",placement:"top"},{default:s(()=>{var a;return[p((i(),c(g,{type:"primary",onClick:e[1]||(e[1]=_=>Y())},{default:s(()=>e[13]||(e[13]=[v("可用性更新")])),_:1})),[[y,`${(a=b(m).name)==null?void 0:a.replace("_info","")}:add`]])]}),_:1}),n(w,{class:"box-item",effect:"dark",content:"触发重装已勾选的主机",placement:"top"},{default:s(()=>{var a;return[p((i(),c(g,{type:"primary",disabled:!(V.value.length>>>0),onClick:e[2]||(e[2]=_=>h({ids:V.value}))},{default:s(()=>e[14]||(e[14]=[v("批量安装")])),_:1},8,["disabled"])),[[y,`${(a=b(m).name)==null?void 0:a.replace("_info","")}:add`]])]}),_:1}),p((i(),c(g,{type:"primary",onClick:e[3]||(e[3]=a=>h({all:!0}))},{default:s(()=>e[15]||(e[15]=[v("触发失败重装")])),_:1})),[[y,`${(M=b(m).name)==null?void 0:M.replace("_info","")}:add`]])]),Z("div",$e,[n(le,{modelValue:$.value,"onUpdate:modelValue":e[4]||(e[4]=a=>$.value=a),placeholder:"Select",style:{width:"120px"}},{default:s(()=>[(i(!0),H(fe,null,ge(K.value,a=>(i(),c(ae,{key:a.value,label:a.name,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),n(ne,{modelValue:S.value,"onUpdate:modelValue":e[5]||(e[5]=a=>S.value=a),style:{width:"240px"},placeholder:"回车查询",clearable:"",onClear:e[6]||(e[6]=a=>r()),onKeyup:e[7]||(e[7]=ye(a=>r(),["enter","native"]))},null,8,["modelValue"])])]),p((i(),c(se,{ref:"multipleTableRef",data:A.value,style:{width:"100%"},border:"","row-key":a=>a.id,onSortChange:G,onSelectionChange:W,onFilterChange:X},{default:s(()=>[n(u,{type:"selection","reserve-selection":!0,width:"55"}),n(u,{property:"name",label:"唯一标识",sortable:"custom"}),n(u,{property:"ip",label:"ip地址"}),n(u,{"column-key":"interface_available",property:"interface_available",label:"接口可用性",sortable:"custom",width:"140",filters:[{text:"未知",value:0},{text:"可用",value:1},{text:"不可用",value:2}]},{default:s(a=>[n(E,{type:B[a.row.interface_available].level},{default:s(()=>[v(L(B[a.row.interface_available].label),1)]),_:2},1032,["type"])]),_:1}),n(u,{"column-key":"agent_installed",property:"agent_installed",label:"agent状态",sortable:"custom",width:"140",filters:[{text:"已安装",value:!0},{text:"未安装",value:!1}]},{default:s(a=>[n(E,{type:a.row.agent_installed?"success":"danger",effect:"dark"},{default:s(()=>[v(L(a.row.agent_installed?"已安装":"未安装"),1)]),_:2},1032,["type"])]),_:1}),n(u,{property:"installation_error",label:"报错信息",width:"400"}),n(u,{fixed:"right",width:"80",label:"操作"},{default:s(a=>[n(w,{class:"box-item",effect:"dark",content:"触发安装",placement:"top"},{default:s(()=>{var _;return[p(n(g,{link:"",type:"primary",icon:b(_e),onClick:Ce=>h({ids:[a.row.id]})},null,8,["icon","onClick"]),[[y,`${(_=b(m).name)==null?void 0:_.replace("_info","")}:edit`]])]}),_:2},1024)]),_:1})]),_:1},8,["data","row-key"])),[[ie,C.value]]),n(oe,{"current-page":j.value,"onUpdate:currentPage":[e[8]||(e[8]=a=>j.value=a),e[10]||(e[10]=a=>q())],"page-size":z.value,"onUpdate:pageSize":[e[9]||(e[9]=a=>z.value=a),e[11]||(e[11]=a=>q())],"page-sizes":[10,20,50,100,200],size:R.value,disabled:J.value,layout:"total, sizes, prev, pager, next, jumper",total:U.value,style:{"margin-top":"5px","justify-content":"flex-end"}},null,8,["current-page","page-size","size","disabled","total"])])}}});export{ze as default};
