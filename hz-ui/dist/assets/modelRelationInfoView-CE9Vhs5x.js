import{_ as ee,aN as ue,bB as ne,r as f,bP as Z,h as i,c as y,o as s,B as m,k as w,w as l,f as e,F as q,i as T,m as de,cd as se,q as R,t as Q,g as re,x as ie,j as me,v as A,a as pe,z as ve,b as C,aP as W,b_ as N}from"./index-Cm0tF2Sj.js";import{m as ce}from"./model-BRqCW4T7.js";const _e={class:"attribute-schema-editor"},be={key:0},fe={key:1},ye={key:2,style:{"margin-top":"20px"}},we={__name:"AttributeSchemaEditor",props:ue({editable:{type:Boolean,default:!1},relation:{type:Boolean,default:!1},validationRulesOptions:{type:Array,default:()=>[]},validationRulesEnumOptionsObject:{type:Object,default:()=>{}},validationRulesObjectById:{type:Object,default:()=>{}}},{schema:{},schemaModifiers:{}}),emits:["update:schema"],setup(b,{expose:k}){const v=ne(b,"schema"),_=b,c=f([]),V=n=>{var t;return n===void 0?"":(t=_.validationRulesOptions.filter(p=>p.label===n)[0])==null?void 0:t.value},F=n=>{try{const t=n.value.validation_rule,p=_.validationRulesObjectById[t];return!p||!p.rule?void 0:JSON.parse(p.rule)[n.value.default]}catch(t){console.warn("Failed to parse validation rule:",t);return}},J=()=>{v.value===void 0&&!v||(c.value=Object.keys(v.value).map(n=>{if(_.relation&&v.value[n].type=="enum"){const t=V(v.value[n].verbose_name);return{key:n,value:{...v.value[n],validation_rule:t}}}else return{key:n,value:{...v.value[n]}}}))},L=()=>{const n={};return c.value.forEach(t=>{t.key&&(n[t.key]={...t.value})}),n},S=()=>{_.relation?c.value.push({key:"",value:{type:"string",required:!1,verbose_name:"",default:""}}):c.value.push({key:"",value:{type:"string",required:!1,verbose_name:""}})},E=n=>{c.value.splice(n,1)},M=n=>({string:"字符串"})[n]||n;return Z(()=>v.value,(n,t)=>{J()},{deep:!0,immediate:!0}),Z(()=>_.validationRulesOptions,(n,t)=>{_.relation&&n&&n.length>0&&(c.value=c.value.map(p=>{if(p.value.type==="enum"){const a=V(p.value.verbose_name);return{...p,value:{...p.value,validation_rule:a}}}return p}))},{deep:!0}),k({updateSchema:()=>{_.relation&&(c.value=c.value.map(n=>{if(n.value.type==="enum"&&!n.value.validation_rule){const t=V(n.value.verbose_name);return{...n,value:{...n.value,validation_rule:t}}}return n})),v.value=L()}}),(n,t)=>{const p=i("el-input"),a=i("el-table-column"),h=i("el-option"),j=i("el-select"),x=i("el-checkbox"),O=i("el-button"),B=i("el-table"),$=i("el-tag");return s(),y("div",_e,[b.editable?(s(),m(B,{key:0,data:c.value,style:{width:"100%"}},{default:l(()=>[e(a,{label:"属性名",width:"150"},{default:l(u=>[e(p,{modelValue:u.row.key,"onUpdate:modelValue":o=>u.row.key=o,placeholder:"属性名"},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),e(a,{label:"类型",width:"120"},{default:l(u=>[e(j,{modelValue:u.row.value.type,"onUpdate:modelValue":o=>u.row.value.type=o,placeholder:"类型"},{default:l(()=>[e(h,{label:"字符串",value:"string"}),e(h,{label:"浮点数",value:"float"}),e(h,{label:"整数",value:"integer"}),b.relation?(s(),m(h,{key:0,label:"枚举类",value:"enum"})):w("",!0)]),_:1},8,["modelValue","onUpdate:modelValue"])]),_:1}),e(a,{label:"显示名称",width:"200"},{default:l(u=>[u.row.value.type!=="enum"?(s(),m(p,{key:0,modelValue:u.row.value.verbose_name,"onUpdate:modelValue":o=>u.row.value.verbose_name=o,placeholder:"显示名称"},null,8,["modelValue","onUpdate:modelValue"])):(s(),m(j,{key:1,modelValue:u.row.value.verbose_name,"onUpdate:modelValue":o=>u.row.value.verbose_name=o,placeholder:"选择枚举规则"},{default:l(()=>[(s(!0),y(q,null,T(_.validationRulesOptions,(o,d)=>(s(),m(h,{key:o.index,label:o.label,value:o.label},null,8,["label","value"]))),128))]),_:1},8,["modelValue","onUpdate:modelValue"]))]),_:1}),b.relation?(s(),m(a,{key:0,prop:"value.unit",label:"单位",width:"100"},{default:l(u=>[e(p,{modelValue:u.row.value.unit,"onUpdate:modelValue":o=>u.row.value.unit=o,placeholder:"单位"},null,8,["modelValue","onUpdate:modelValue"])]),_:1})):w("",!0),b.relation?(s(),m(a,{key:1,prop:"value.default",label:"默认值",width:"150"},{default:l(u=>[u.row.value.type!=="enum"?(s(),m(p,{key:0,modelValue:u.row.value.default,"onUpdate:modelValue":o=>u.row.value.default=o,placeholder:"默认值"},null,8,["modelValue","onUpdate:modelValue"])):(s(),m(j,{key:1,modelValue:u.row.value.default,"onUpdate:modelValue":o=>u.row.value.default=o,placeholder:"默认值"},{default:l(()=>[(s(!0),y(q,null,T(_.validationRulesEnumOptionsObject[V(u.row.value.verbose_name)],(o,d)=>(s(),m(h,{key:o.index,label:o.label,value:o.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"]))]),_:1})):w("",!0),e(a,{label:"必填",width:"80"},{default:l(u=>[e(x,{modelValue:u.row.value.required,"onUpdate:modelValue":o=>u.row.value.required=o},null,8,["modelValue","onUpdate:modelValue"])]),_:1}),e(a,{label:"操作",width:"80"},{default:l(u=>[e(O,{type:"danger",icon:de(se),link:"",onClick:o=>E(u.$index)},null,8,["icon","onClick"])]),_:1})]),_:1},8,["data"])):(s(),m(B,{key:1,data:c.value,style:{width:"100%"}},{default:l(()=>[e(a,{prop:"key",label:"属性名",width:"150"}),e(a,{label:"类型",width:"120"},{default:l(u=>[R(Q(M(u.row.value.type)),1)]),_:1}),e(a,{prop:"value.verbose_name",label:"显示名称",width:"150"}),b.relation?(s(),m(a,{key:0,prop:"value.unit",label:"单位",width:"100"})):w("",!0),b.relation?(s(),m(a,{key:1,prop:"value.default",label:"默认值",width:"120"},{default:l(u=>[u.row.value.type!=="enum"?(s(),y("span",be,Q(u.row.value.default),1)):(s(),y("span",fe,Q(F(u.row)),1))]),_:1})):w("",!0),e(a,{label:"必填",width:"80"},{default:l(u=>[u.row.value.required?(s(),m($,{key:0,type:"success"},{default:l(()=>[...t[0]||(t[0]=[R("是",-1)])]),_:1})):(s(),m($,{key:1},{default:l(()=>[...t[1]||(t[1]=[R("否",-1)])]),_:1}))]),_:1})]),_:1},8,["data"])),b.editable?(s(),y("div",ye,[e(O,{type:"primary",onClick:S},{default:l(()=>[...t[2]||(t[2]=[R("添加属性",-1)])]),_:1})])):w("",!0)])}}},X=ee(we,[["__scopeId","data-v-422a414d"]]),he={class:"relation-type-view"},Ve={class:"card-header"},ge={__name:"modelRelationInfoView",setup(b){const k=ce(),{proxy:v}=re(),_=ie(),c=me(),V=A(()=>k.modelOptions),F=A(()=>k.validationRulesOptions.filter(o=>o.type==="enum")),J=A(()=>k.validationRulesEnumOptionsObject),L=A(()=>k.validationRulesObjectById),S=()=>{c.push({path:"/cmdb/cimodelManage/modelRelation"})},E=f(null),M=f(null),P=f(null),n=f(null),t=f(!1),p=f({}),a=pe({name:"",topology_type:"directed",forward_verb:"",reverse_verb:"",attribute_schema:{source:{},target:{},relation:{}},description:null,source_model:"",target_model:""}),h=()=>{M.value.updateSchema(),P.value.updateSchema(),n.value.updateSchema(),W(()=>{O.value?u():$()})},j=()=>{t.value=!1,Object.assign(a,p.value),S()},x=f(""),O=f(!1),B=async()=>{const o=await v.$api.getModelRelationDefineInfo(x.value);o.status===200&&(p.value=o.data,a.name=o.data.name,a.topology_type=o.data.topology_type,a.forward_verb=o.data.forward_verb,a.reverse_verb=o.data.reverse_verb,a.attribute_schema=o.data.attribute_schema,a.description=o.data.description,a.source_model=o.data.source_model,a.target_model=o.data.target_model)},$=async()=>{const o=await v.$api.updateModelRelationDefine({id:x.value,...a});o.status==200?(N({type:"success",message:"更新成功"}),t.value=!1,W(()=>{B()})):N({type:"error",message:`更新失败:  ${JSON.stringify(o.data)}`})},u=async()=>{const o=await v.$api.addModelRelationDefine(a);o.status==201?(N.success("添加成功"),t.value=!1,E.value.resetFields(),W(()=>{S()})):N({type:"error",message:`添加失败: ${JSON.stringify(o.data)}`})};return ve(()=>{x.value=_.path.split("/").at(-1),x.value.includes("new")?(O.value=!0,t.value=!0):B()}),(o,d)=>{const le=i("el-page-header"),z=i("el-button"),ae=i("el-tooltip"),D=i("el-input"),g=i("el-form-item"),U=i("el-col"),I=i("el-option"),G=i("el-select"),H=i("el-row"),te=i("el-form"),Y=i("el-card"),K=i("el-tab-pane"),oe=i("el-tabs");return s(),y("div",he,[e(Y,{class:"relation-card"},{header:l(()=>[C("div",Ve,[e(le,{onBack:S},{content:l(()=>[...d[11]||(d[11]=[C("span",null,"关系类型详情",-1)])]),_:1}),C("div",null,[e(ae,{content:`
                  
                  编辑关联关系
              `,placement:"top"},{default:l(()=>[t.value?w("",!0):(s(),m(z,{key:0,type:"primary",onClick:d[0]||(d[0]=r=>t.value=!0)},{default:l(()=>[...d[12]||(d[12]=[R("编辑",-1)])]),_:1}))]),_:1}),t.value?(s(),m(z,{key:0,type:"success",onClick:h},{default:l(()=>[...d[13]||(d[13]=[R("保存",-1)])]),_:1})):w("",!0),t.value?(s(),m(z,{key:1,onClick:j},{default:l(()=>[...d[14]||(d[14]=[R("取消",-1)])]),_:1})):w("",!0)])])]),default:l(()=>[e(te,{model:a,"label-width":"120px",disabled:!t.value,ref_key:"formRef",ref:E},{default:l(()=>[e(H,{gutter:20},{default:l(()=>[e(U,{span:6},{default:l(()=>[e(g,{label:"名称"},{default:l(()=>[e(D,{modelValue:a.name,"onUpdate:modelValue":d[1]||(d[1]=r=>a.name=r),disabled:!t.value||!O.value,style:{"max-width":"300px"}},null,8,["modelValue","disabled"])]),_:1})]),_:1}),e(U,{span:6},{default:l(()=>[e(g,{label:"拓扑关系"},{default:l(()=>[e(G,{modelValue:a.topology_type,"onUpdate:modelValue":d[2]||(d[2]=r=>a.topology_type=r),disabled:!t.value,style:{"max-width":"300px"}},{default:l(()=>[e(I,{label:"有向",value:"directed"}),e(I,{label:"无向",value:"undirected"}),e(I,{label:"有向无环",value:"daggered"})]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}),e(H,{gutter:20},{default:l(()=>[e(U,{span:6},{default:l(()=>[e(g,{label:"源模型"},{default:l(()=>[e(G,{modelValue:a.source_model,"onUpdate:modelValue":d[3]||(d[3]=r=>a.source_model=r),disabled:!t.value,clearable:"",multiple:"","collapse-tags":"","collapse-tags-tooltip":"","max-collapse-tags":3,style:{"max-width":"300px"}},{default:l(()=>[(s(!0),y(q,null,T(V.value,r=>(s(),m(I,{key:r.value,label:r.label,value:r.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1}),e(U,{span:6},{default:l(()=>[e(g,{label:"目标模型"},{default:l(()=>[e(G,{modelValue:a.target_model,"onUpdate:modelValue":d[4]||(d[4]=r=>a.target_model=r),disabled:!t.value,clearable:"",multiple:"","collapse-tags":"","collapse-tags-tooltip":"","max-collapse-tags":3,style:{"max-width":"300px"}},{default:l(()=>[(s(!0),y(q,null,T(V.value,r=>(s(),m(I,{key:r.value,label:r.label,value:r.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}),e(H,{gutter:20},{default:l(()=>[e(U,{span:6},{default:l(()=>[e(g,{label:"正向动词"},{default:l(()=>[e(D,{modelValue:a.forward_verb,"onUpdate:modelValue":d[5]||(d[5]=r=>a.forward_verb=r),disabled:!t.value,style:{"max-width":"300px"}},null,8,["modelValue","disabled"])]),_:1})]),_:1}),e(U,{span:6},{default:l(()=>[e(g,{label:"反向动词"},{default:l(()=>[e(D,{modelValue:a.reverse_verb,"onUpdate:modelValue":d[6]||(d[6]=r=>a.reverse_verb=r),disabled:!t.value,style:{"max-width":"300px"}},null,8,["modelValue","disabled"])]),_:1})]),_:1})]),_:1}),e(g,{label:"描述"},{default:l(()=>[e(D,{modelValue:a.description,"onUpdate:modelValue":d[7]||(d[7]=r=>a.description=r),type:"textarea",disabled:!t.value,style:{"max-width":"1000px"}},null,8,["modelValue","disabled"])]),_:1})]),_:1},8,["model","disabled"])]),_:1}),e(Y,{class:"attribute-card"},{header:l(()=>[...d[15]||(d[15]=[C("div",{class:"card-header"},[C("span",null,"属性模式")],-1)])]),default:l(()=>[e(oe,{type:"card"},{default:l(()=>[e(K,{label:"源属性"},{default:l(()=>[e(X,{ref_key:"sourceSchemaRef",ref:M,schema:a.attribute_schema.source,"onUpdate:schema":d[8]||(d[8]=r=>a.attribute_schema.source=r),editable:t.value},null,8,["schema","editable"])]),_:1}),e(K,{label:"目标属性"},{default:l(()=>[e(X,{ref_key:"targetSchemaRef",ref:P,schema:a.attribute_schema.target,"onUpdate:schema":d[9]||(d[9]=r=>a.attribute_schema.target=r),editable:t.value},null,8,["schema","editable"])]),_:1}),e(K,{label:"关系属性"},{default:l(()=>[e(X,{ref_key:"relationSchemaRef",ref:n,schema:a.attribute_schema.relation,"onUpdate:schema":d[10]||(d[10]=r=>a.attribute_schema.relation=r),editable:t.value,relation:!0,validationRulesOptions:F.value,validationRulesEnumOptionsObject:J.value,validationRulesObjectById:L.value},null,8,["schema","editable","validationRulesOptions","validationRulesEnumOptionsObject","validationRulesObjectById"])]),_:1})]),_:1})]),_:1})])}}},xe=ee(ge,[["__scopeId","data-v-c792e64a"]]);export{xe as default};
