import{d as be,g as he,r as c,v as A,bP as Q,z as ve,aP as X,A as _e,h as p,c as i,o as a,b as t,f as o,m as Y,ca as ge,w as r,c8 as ye,B as h,k,aQ as we,t as x,q as C,F as w,i as q,l as qe,b_ as Z,_ as ke}from"./index-Cm0tF2Sj.js";import{A as xe}from"./ansi_up-SVqyao32.js";import{m as Ce}from"./model-BRqCW4T7.js";const Ve={class:"ansible-cli-container"},Ne={class:"host-tree-panel"},Me={class:"tree-filter"},Te={class:"custom-tree-node"},je={key:1,class:"custom-tree-node"},$e={class:"command-result-panel"},De={class:"result-display-area"},Ae={class:"result-header"},ze={key:0,class:"no-result"},Ie=["innerHTML"],Oe={class:"command-input-area"},Pe={class:"command-header"},Ue={class:"module-selection"},Be={class:"module-docs-header"},Se={key:0,class:"module-docs-content"},He={class:"module-description"},Re={key:0,class:"module-parameters"},Fe={key:0},Le={key:1},Ke={key:1,class:"module-examples"},Ee={key:1,class:"no-docs"},We={key:0,class:"command-input"},Ge=be({name:"ansibleCli",__name:"ansibleCliView",setup(Je){const{proxy:Qe}=he(),U=c(),z=c(),V=Ce(),ee=A(()=>{var s;return(s=V.modelObjectByName)==null?void 0:s.hosts.id}),B=A(()=>V.allModelCiDataObj[ee.value]),S=c("");Q(S,s=>{U.value.filter(s)});const le=(s,e)=>e.label.includes(s),I=c([]),d=c("shell"),N=c(""),m=c(!1),g=c([]),v=c(null),H=c(!1),M=c(""),se=new xe,ae={children:"children",label:"label"},F=c([{label:"常用模块",options:[{value:"shell",label:"shell - 执行 shell 命令"},{value:"command",label:"command - 执行命令"},{value:"ping",label:"ping - 测试主机连通性"},{value:"copy",label:"copy - 复制文件"},{value:"file",label:"file - 管理文件属性"},{value:"yum",label:"yum - 包管理"},{value:"service",label:"service - 管理服务"}]},{label:"系统模块",options:[{value:"user",label:"user - 管理用户"},{value:"group",label:"group - 管理用户组"},{value:"cron",label:"cron - 管理定时任务"},{value:"hostname",label:"hostname - 管理主机名"},{value:"iptables",label:"iptables - 管理防火墙规则"}]},{label:"文件模块",options:[{value:"template",label:"template - 模板文件"},{value:"lineinfile",label:"lineinfile - 管理文件行"},{value:"replace",label:"replace - 替换文件内容"},{value:"stat",label:"stat - 获取文件状态"},{value:"fetch",label:"fetch - 从远程节点获取文件"},{value:"synchronize",label:"synchronize - 同步文件"}]},{label:"网络模块",options:[{value:"uri",label:"uri - 发起 HTTP 请求"},{value:"get_url",label:"get_url - 下载文件"}]},{label:"软件包管理模块",options:[{value:"pip",label:"pip - Python 包管理"},{value:"npm",label:"npm - Node.js 包管理"}]}]),L=c({shell:{description:"在目标主机上执行 shell 命令，支持 shell 特性如管道、重定向等。",parameters:{_raw_params:{required:!1,description:"要执行的命令（作为字符串传递）",default:null,choices:null},chdir:{required:!1,description:"执行命令前切换到的目录",default:null,choices:null},creates:{required:!1,description:"如果指定文件存在，则不执行命令",default:null,choices:null},removes:{required:!1,description:"如果指定文件不存在，则不执行命令",default:null,choices:null},executable:{required:!1,description:"用于执行命令的可执行文件",default:null,choices:null},stdin:{required:!1,description:"传递给命令的标准输入",default:null,choices:null},warn:{required:!1,description:"是否显示警告信息",default:!0,choices:[!0,!1]}},examples:[`# 执行简单的命令
ansible webservers -m shell -a 'ls -l /tmp'`,`# 切换目录后执行命令
ansible webservers -m shell -a 'chdir=/tmp ls -l'`,`# 使用管道
ansible webservers -m shell -a 'ps aux | grep nginx'`,`# 只有当文件不存在时才执行
ansible webservers -m shell -a 'creates=/tmp/app.pid /usr/local/bin/app &'`]},command:{description:"在目标主机上执行命令，不支持 shell 特性如管道、重定向等。",parameters:{_raw_params:{required:!1,description:"要执行的命令（作为字符串传递）",default:null,choices:null},chdir:{required:!1,description:"执行命令前切换到的目录",default:null,choices:null},creates:{required:!1,description:"如果指定文件存在，则不执行命令",default:null,choices:null},removes:{required:!1,description:"如果指定文件不存在，则不执行命令",default:null,choices:null},stdin:{required:!1,description:"传递给命令的标准输入",default:null,choices:null},warn:{required:!1,description:"是否显示警告信息",default:!0,choices:[!0,!1]}},examples:[`# 执行简单的命令
ansible webservers -m command -a 'uptime'`,`# 切换目录后执行命令
ansible webservers -m command -a 'chdir=/tmp pwd'`,`# 只有当文件存在时才执行
ansible webservers -m command -a 'removes=/tmp/app.pid cat /tmp/app.pid'`]},ping:{description:"测试目标主机的连通性，如果主机可达则返回 pong。",parameters:{data:{required:!1,description:"返回给调用者的数据",default:"pong",choices:null}},examples:[`# 测试所有主机连通性
ansible all -m ping`,`# 测试并返回自定义数据
ansible all -m ping -a 'data=hello'`]},copy:{description:"将文件从控制节点复制到目标主机。",parameters:{src:{required:!1,description:"源文件路径（在控制节点上）",default:null,choices:null},content:{required:!1,description:"直接指定文件内容",default:null,choices:null},dest:{required:!0,description:"目标文件路径（在远程主机上）",default:null,choices:null},backup:{required:!1,description:"在覆盖前创建备份",default:!1,choices:[!0,!1]},force:{required:!1,description:"即使文件内容相同也强制复制",default:!0,choices:[!0,!1]},mode:{required:!1,description:"目标文件权限",default:null,choices:null},owner:{required:!1,description:"目标文件所有者",default:null,choices:null},group:{required:!1,description:"目标文件所属组",default:null,choices:null},directory_mode:{required:!1,description:"递归设置目录权限时使用的模式",default:null,choices:null}},examples:[`# 复制文件
ansible webservers -m copy -a 'src=/etc/hosts dest=/tmp/hosts'`,`# 直接指定文件内容
ansible webservers -m copy -a "content='Hello World' dest=/tmp/test.txt"`,`# 复制文件并设置权限
ansible webservers -m copy -a 'src=/etc/hosts dest=/tmp/hosts mode=0644 owner=root group=root'`]},file:{description:"管理目标主机上的文件属性，如创建目录、修改权限等。",parameters:{path:{required:!0,description:"文件或目录路径",default:null,choices:null},state:{required:!1,description:"文件状态",default:"file",choices:["file","directory","link","hard","touch","absent"]},mode:{required:!1,description:"文件权限",default:null,choices:null},owner:{required:!1,description:"文件所有者",default:null,choices:null},group:{required:!1,description:"文件所属组",default:null,choices:null},recurse:{required:!1,description:"递归设置目录属性",default:!1,choices:[!0,!1]},src:{required:!1,description:"符号链接指向的路径",default:null,choices:null}},examples:[`# 创建目录
ansible webservers -m file -a 'path=/tmp/myapp state=directory mode=0755'`,`# 修改文件权限
ansible webservers -m file -a 'path=/etc/foo.conf owner=foo group=foo mode=0644'`,`# 创建符号链接
ansible webservers -m file -a 'src=/tmp/foo dest=/tmp/bar state=link'`,`# 删除文件
ansible webservers -m file -a 'path=/tmp/foo state=absent'`]},yum:{description:"使用 yum 包管理器管理软件包。",parameters:{name:{required:!0,description:"软件包名称（可以是列表）",default:null,choices:null},state:{required:!1,description:"软件包状态",default:"present",choices:["present","installed","latest","absent","removed"]},enablerepo:{required:!1,description:"启用额外的仓库",default:null,choices:null},disablerepo:{required:!1,description:"禁用指定的仓库",default:null,choices:null},conf_file:{required:!1,description:"yum 配置文件路径",default:null,choices:null},disable_gpg_check:{required:!1,description:"禁用 GPG 检查",default:!1,choices:[!0,!1]}},examples:[`# 安装软件包
ansible webservers -m yum -a 'name=nginx state=present'`,`# 更新软件包到最新版本
ansible webservers -m yum -a 'name=nginx state=latest'`,`# 删除软件包
ansible webservers -m yum -a 'name=nginx state=absent'`,`# 安装多个软件包
ansible webservers -m yum -a 'name=["nginx", "mysql-server"] state=present'`]},service:{description:"管理服务（启动、停止、重启等）。",parameters:{name:{required:!0,description:"服务名称",default:null,choices:null},state:{required:!1,description:"服务状态",default:null,choices:["started","stopped","restarted","reloaded"]},enabled:{required:!1,description:"是否开机自启",default:null,choices:[!0,!1]},pattern:{required:!1,description:"用于查找进程的模式",default:null,choices:null},sleep:{required:!1,description:"执行操作前等待的秒数",default:null,choices:null}},examples:[`# 启动服务
ansible webservers -m service -a 'name=nginx state=started'`,`# 停止服务
ansible webservers -m service -a 'name=nginx state=stopped'`,`# 重启服务
ansible webservers -m service -a 'name=nginx state=restarted'`,`# 设置服务开机自启
ansible webservers -m service -a 'name=nginx enabled=yes'`,`# 重载服务配置
ansible webservers -m service -a 'name=nginx state=reloaded'`]},user:{description:"管理用户账户。",parameters:{name:{required:!0,description:"用户名",default:null,choices:null},state:{required:!1,description:"用户状态",default:"present",choices:["present","absent"]},uid:{required:!1,description:"用户ID",default:null,choices:null},group:{required:!1,description:"用户主组",default:null,choices:null},groups:{required:!1,description:"用户附加组",default:null,choices:null},home:{required:!1,description:"用户家目录",default:null,choices:null},shell:{required:!1,description:"用户登录shell",default:null,choices:null},password:{required:!1,description:"用户密码（加密后的）",default:null,choices:null},system:{required:!1,description:"是否创建系统用户",default:!1,choices:[!0,!1]}},examples:[`# 创建用户
ansible webservers -m user -a 'name=john'`,`# 创建系统用户
ansible webservers -m user -a 'name=app system=yes'`,`# 创建用户并设置家目录和shell
ansible webservers -m user -a 'name=john home=/home/john shell=/bin/bash'`,`# 删除用户
ansible webservers -m user -a 'name=john state=absent'`,`# 创建用户并设置密码
ansible webservers -m user -a 'name=john password=$6$....'`]},group:{description:"管理用户组。",parameters:{name:{required:!0,description:"组名",default:null,choices:null},state:{required:!1,description:"组状态",default:"present",choices:["present","absent"]},gid:{required:!1,description:"组ID",default:null,choices:null},system:{required:!1,description:"是否创建系统组",default:!1,choices:[!0,!1]}},examples:[`# 创建用户组
ansible webservers -m group -a 'name=developers'`,`# 创建系统组
ansible webservers -m group -a 'name=app system=yes'`,`# 删除用户组
ansible webservers -m group -a 'name=developers state=absent'`]},cron:{description:"管理定时任务（crontab条目）。",parameters:{name:{required:!0,description:"定时任务描述",default:null,choices:null},state:{required:!1,description:"定时任务状态",default:"present",choices:["present","absent"]},minute:{required:!1,description:"分钟（0-59）",default:"*",choices:null},hour:{required:!1,description:"小时（0-23）",default:"*",choices:null},day:{required:!1,description:"日期（1-31）",default:"*",choices:null},month:{required:!1,description:"月份（1-12）",default:"*",choices:null},weekday:{required:!1,description:"星期（0-7，0和7都表示星期日）",default:"*",choices:null},job:{required:!1,description:"要执行的命令",default:null,choices:null},user:{required:!1,description:"拥有定时任务的用户",default:"root",choices:null}},examples:[`# 创建定时任务
ansible webservers -m cron -a 'name="check dirs" minute=0 hour=5 job="ls -alh > /dev/null"'`,`# 删除定时任务
ansible webservers -m cron -a 'name="check dirs" state=absent'`,`# 创建每天执行的定时任务
ansible webservers -m cron -a 'name="daily backup" minute=30 hour=2 job="/usr/local/bin/backup.sh"'`]},hostname:{description:"管理系统主机名。",parameters:{name:{required:!0,description:"主机名",default:null,choices:null}},examples:[`# 设置主机名
ansible webservers -m hostname -a 'name=webserver01'`,`# 设置主机名为特定值
ansible webservers -m hostname -a 'name=database01'`]}}),K=s=>{const e=n=>{const _={id:n.id,label:n.label};let j=[];n.children&&n.children.length>0&&(j=n.children.map(e).filter(y=>y!==null));let $=[];n.instances&&n.instances.length>0&&($=n.instances.map(y=>({id:y.id,label:y.instance_name})));const P=[...j,...$];if(P.length>0)_.children=P;else if((!n.instances||n.instances.length===0)&&(!n.children||n.children.length===0))return null;return _};return s.map(e).filter(n=>n!==null)},O=c([]),te=(s,e,b)=>{const n=U.value.getCheckedKeys();I.value=ne.value.filter(_=>n.includes(_.id)).map(_=>_.id)},ne=A(()=>E(O.value)),E=s=>{let e=[];return s.forEach(b=>{b.children&&b.children.length>0?e=e.concat(E(b.children)):e.push(b)}),e},re=()=>{N.value=""},f=A(()=>L.value[M.value]||null),ie=A(()=>!f.value||!f.value.parameters?[]:Object.keys(f.value.parameters).map(s=>({name:s,...f.value.parameters[s]}))),oe=()=>{d.value&&(M.value=d.value),H.value=!0},ue=()=>{if(!d.value)return"请先选择 Ansible 模块";if(d.value==="ping")return"无需输入参数";const s=L.value[d.value];return s&&s.examples&&s.examples.length>0?`请输入 ${d.value} 模块的参数，例如: ${s.examples[0].split("-a ")[1]||"参数"}`:`请输入 ${d.value} 模块的参数`},W=async()=>{if(!I.value.length){Z.warning("请至少选择一个主机");return}if(!d.value){Z.warning("请选择要执行的 Ansible 模块");return}m.value=!0,g.value=[];try{v.value=new WebSocket(`${window.location.protocol==="https:"?"wss":"ws"}://${window.location.host}/jobflow/ws/ansible/`),v.value.onopen=()=>{v.value.send(JSON.stringify({module:d.value,module_args:N.value,hosts:I.value}))},v.value.onmessage=s=>{const e=JSON.parse(s.data);e.type==="output"?T(e.message):e.type==="complete"?(m.value=!1,T(`
命令执行完成，返回码: ${e.returncode}，执行时长: ${e.execution_time}s`),v.value.close()):e.type==="error"&&(m.value=!1,T(`错误: ${e.message}`,"error"))},v.value.onerror=s=>{m.value=!1,T(`WebSocket 错误: ${s.message}`,"error")},v.value.onclose=()=>{console.log("命令执行已结束","warning"),m.value=!1}}catch(s){console.error("执行命令时出错:",s),m.value=!1,T(`错误: ${s.message}`,"error")}},T=(s,e="")=>{if(s===""||s===null||s===void 0)return;const b=se.ansi_to_html(s);g.value.push(b),g.value.length>1e3&&g.value.shift(),de()},de=()=>{X(()=>{z.value&&(z.value.scrollTop=z.value.scrollHeight)})},ce=()=>{g.value=[]};c(null);const pe=async()=>{await V.getAllModelTreeInstances(!0)};return Q(B,s=>{O.value=K([B.value])}),ve(async()=>{await V.getModel(),await V.getAllModelTreeInstances(),X(()=>{O.value=K([B.value])})}),_e(()=>{v.value&&v.value.close()}),(s,e)=>{const b=p("el-input"),n=p("el-button"),_=p("el-tooltip"),j=p("Folder"),$=p("el-icon"),P=p("el-tree-v2"),y=p("el-option"),G=p("el-option-group"),J=p("el-select"),D=p("el-table-column"),R=p("el-tag"),me=p("el-table"),fe=p("el-dialog");return a(),i("div",Ve,[t("div",Ne,[t("div",Me,[o(b,{modelValue:S.value,"onUpdate:modelValue":e[0]||(e[0]=l=>S.value=l),placeholder:"输入关键字过滤节点",clearable:"",size:"default","prefix-icon":Y(ge)},null,8,["modelValue","prefix-icon"]),o(_,{content:"刷新资产树",placement:"top"},{default:r(()=>[o(n,{type:"primary",icon:Y(ye),size:"large",link:"",onClick:e[1]||(e[1]=l=>pe())},null,8,["icon"])]),_:1})]),o(P,{ref_key:"treeRef",ref:U,data:O.value,"show-checkbox":"","default-expand-all":"","node-key":"id","highlight-current":"",props:ae,"filter-method":le,onCheckChange:te,height:900},{default:r(({node:l,data:u})=>[u.disabled?(a(),h(_,{key:0,content:u.disabledTooltip||"无法移除",placement:"top"},{default:r(()=>[t("span",Te,[l.childNodes&&l.childNodes.length>0?(a(),h($,{key:0,class:"node-icon"},{default:r(()=>[o(j)]),_:1})):k("",!0),t("span",{class:we({"node-disabled":u.disabled})},x(l.label),3)])]),_:2},1032,["content"])):(a(),i("span",je,[l.childNodes&&l.childNodes.length>0?(a(),h($,{key:0,class:"node-icon"},{default:r(()=>[o(j)]),_:1})):k("",!0),t("span",null,x(l.label),1)]))]),_:1},8,["data"])]),t("div",$e,[t("div",De,[t("div",Ae,[e[7]||(e[7]=t("span",null,"执行结果",-1)),o(n,{type:"danger",size:"small",onClick:ce,disabled:m.value},{default:r(()=>[...e[6]||(e[6]=[C(" 清空 ",-1)])]),_:1},8,["disabled"])]),t("div",{class:"result-content",ref_key:"resultContentRef",ref:z},[g.value.length?k("",!0):(a(),i("div",ze," 执行结果将在此处显示 ")),(a(!0),i(w,null,q(g.value,(l,u)=>(a(),i("div",{key:u,innerHTML:l,class:"result-line"},null,8,Ie))),128))],512)]),t("div",Oe,[t("div",Pe,[e[9]||(e[9]=t("span",null,"Ansible 命令执行",-1)),o(n,{type:"primary",size:"small",onClick:W,loading:m.value,disabled:!I.value.length||!d.value||m.value||d.value!=="ping"&&!N.value.length},{default:r(()=>[...e[8]||(e[8]=[C(" 执行 ",-1)])]),_:1},8,["loading","disabled"])]),t("div",Ue,[o(J,{modelValue:d.value,"onUpdate:modelValue":e[2]||(e[2]=l=>d.value=l),placeholder:"请选择 Ansible 模块",filterable:"",disabled:m.value,onChange:re,style:{width:"200px"}},{default:r(()=>[(a(!0),i(w,null,q(F.value,l=>(a(),h(G,{key:l.label,label:l.label},{default:r(()=>[(a(!0),i(w,null,q(l.options,u=>(a(),h(y,{key:u.value,label:u.label,value:u.value},null,8,["label","value"]))),128))]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue","disabled"]),o(n,{type:"primary",link:"",onClick:oe},{default:r(()=>[...e[10]||(e[10]=[C(" 查看文档 ",-1)])]),_:1})]),o(fe,{modelValue:H.value,"onUpdate:modelValue":e[4]||(e[4]=l=>H.value=l),title:`${M.value} 模块文档`,width:"70%",class:"module-docs-dialog"},{default:r(()=>[t("div",Be,[o(J,{modelValue:M.value,"onUpdate:modelValue":e[3]||(e[3]=l=>M.value=l),placeholder:"请选择模块",filterable:"",clearable:"",style:{width:"250px","margin-bottom":"20px"}},{default:r(()=>[(a(!0),i(w,null,q(F.value,l=>(a(),h(G,{key:l.label,label:l.label},{default:r(()=>[(a(!0),i(w,null,q(l.options,u=>(a(),h(y,{key:u.value,label:u.label,value:u.value},null,8,["label","value"]))),128))]),_:2},1032,["label"]))),128))]),_:1},8,["modelValue"])]),f.value?(a(),i("div",Se,[t("div",He,[e[11]||(e[11]=t("h3",null,"描述",-1)),t("p",null,x(f.value.description),1)]),f.value.parameters&&Object.keys(f.value.parameters).length>0?(a(),i("div",Re,[e[14]||(e[14]=t("h3",null,"参数",-1)),o(me,{data:ie.value,border:""},{default:r(()=>[o(D,{prop:"name",label:"参数名",width:"200"}),o(D,{prop:"required",label:"必需",width:"80"},{default:r(l=>[l.row.required?(a(),h(R,{key:0,type:"danger"},{default:r(()=>[...e[12]||(e[12]=[C("是",-1)])]),_:1})):(a(),h(R,{key:1,type:"info"},{default:r(()=>[...e[13]||(e[13]=[C("否",-1)])]),_:1}))]),_:1}),o(D,{prop:"default",label:"默认值",width:"120"},{default:r(l=>[l.row.default!==null&&l.row.default!==void 0?(a(),i("span",Fe,x(l.row.default),1)):(a(),i("span",Le,"-"))]),_:1}),o(D,{prop:"choices",label:"可选值",width:"200"},{default:r(l=>[(a(!0),i(w,null,q(l.row.choices,u=>(a(),h(R,{key:u,size:"small",style:{margin:"2px"}},{default:r(()=>[C(x(u),1)]),_:2},1024))),128))]),_:1}),o(D,{prop:"description",label:"描述"})]),_:1},8,["data"])])):k("",!0),f.value.examples&&f.value.examples.length>0?(a(),i("div",Ke,[e[15]||(e[15]=t("h3",null,"示例",-1)),(a(!0),i(w,null,q(f.value.examples,(l,u)=>(a(),i("div",{key:u,class:"example-item"},[t("pre",null,[t("code",null,x(l),1)])]))),128))])):k("",!0)])):(a(),i("div",Ee,[...e[16]||(e[16]=[t("p",null,"请选择一个模块查看文档",-1)])]))]),_:1},8,["modelValue","title"]),d.value?(a(),i("div",We,[o(b,{modelValue:N.value,"onUpdate:modelValue":e[5]||(e[5]=l=>N.value=l),placeholder:ue(),disabled:m.value||d.value==="ping",onKeyup:qe(W,["enter"])},null,8,["modelValue","placeholder","disabled"])])):k("",!0)])])])}}}),el=ke(Ge,[["__scopeId","data-v-b9bf5ebb"]]);export{el as default};
