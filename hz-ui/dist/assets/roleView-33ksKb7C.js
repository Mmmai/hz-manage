import{d as ue,b as ce,r as s,c as D,aN as me,M as pe,bI as fe,e as i,b3 as O,o as v,f as P,h as p,bO as x,bo as f,O as F,w as n,j as N,g as o,F as L,b1 as _e,b$ as be,c0 as ge,ci as ve,aE as ye,t as he,k as we,bV as M,c3 as d,aD as I,_ as Ce}from"./index-8aBZIOBx.js";const ke={class:"card"},xe={class:"user-header"},Ve={style:{border:"1px solid var(--el-border-color)",width:"90%"}},$e=ue({__name:"roleView",setup(Fe){const V=ce(),K=s({}),{proxy:r}=we(),j=({tree_type:l},e)=>l==="menu"?"is-menu":l==="button"?"is-button":"";D({search:""});const A=s(!1),_=s([]),U=s("auto"),J=s([{prop:"role",label:"角色名"},{prop:"role_name",label:"角色名称"},{prop:"user_count",label:"用户数量"}]);s(0);const q=s({});me(async()=>{await y(),oe()});const y=async()=>{let l=await r.$api.getRole();_.value=l.data.results.map(e=>(e.userinfo_set=e.userinfo_set.length,e));for(let e in _.value){let c=_.value[e].role,g=_.value[e].id;q.value[g]=c}},z=l=>{K.value=l},u=s(!1),a=D({role:"",role_name:"",rolePermission:[]}),h=s("add"),W=()=>{h.value="add",u.value=!0},G=()=>{u.value=!1,r.$refs.userFrom.resetFields(),b([])},H=l=>{M.confirm("是否确认关闭?").then(()=>{r.$refs.userFrom.resetFields(),b([]),l()}).catch(()=>{})},Q=pe(()=>{let l=new Array;return m.value.getCheckedNodes().forEach(e=>{e.tree_type==="button"&&l.push(e.id)}),l}),X=()=>{a.rolePermission=Q.value,console.log(JSON.stringify(a)),r.$refs.userFrom.validate(async l=>{if(l)if(h.value=="add"){let e=await r.$api.roleadd(a);e.status==201?(u.value=!1,d({type:"success",message:"添加成功"}),r.$refs.userFrom.resetFields(),b([]),y(),console.log(m.value.getCheckedKeys())):d({showClose:!0,message:"添加失败:"+JSON.stringify(e.data),type:"error"})}else{let e=await r.$api.roleupdate({id:R.value.id,...a});console.log(e),e.status==200?(u.value=!1,r.$refs.userFrom.resetFields(),b([]),console.log(m.value.getCheckedKeys()),y(),d({type:"success",message:"更新成功"})):d({showClose:!0,message:"更新失败:"+JSON.stringify(e.data),type:"error"})}else d({showClose:!0,message:"请输入正确内容.",type:"error"})})},R=s({}),Y=l=>{console.log(l),h.value="edit",R.value=l,u.value=!0,I(()=>{Object.keys(a).forEach(e=>{a[e]=l[e]})}),b(l.rolePermission)},Z=l=>{M.confirm("是否确认删除?","Warning",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await r.$api.roledel(l.id)).status==204?(d({type:"success",message:"删除成功"}),await y(pageConfig)):d({type:"error",message:"删除失败"})}).catch(()=>{d({type:"info",message:"取消删除"})})},ee=s([]),le=(l,e)=>l.role!="sysadmin",te=l=>{ee.value=l},m=s(),S=s([]),oe=async()=>{let l=await r.$api.getPermissionToRole();console.log(l),S.value=l.data.results},b=l=>{I().then(()=>{m.value.setCheckedKeys(l,!1),console.log(m.value.getCheckedKeys())})},w=s(!1);return fe(()=>a.role,l=>{l=="sysadmin"?w.value=!0:w.value=!1}),(l,e)=>{var T;const c=i("el-button"),g=i("el-table-column"),ae=i("el-table"),E=i("el-input"),C=i("el-form-item"),se=i("el-row"),ne=i("el-form"),re=i("el-dialog"),$=O("permission"),ie=O("loading");return v(),P(L,null,[p("div",ke,[p("div",xe,[p("div",null,[x((v(),F(c,{type:"primary",size:"small",onClick:W},{default:n(()=>e[4]||(e[4]=[N("新增")])),_:1})),[[$,`${(T=f(V).name)==null?void 0:T.replace("_info","")}:add`]])])]),p("div",null,[x((v(),F(ae,{border:"",data:_.value,style:{width:"100%"},"max-height":"500px","highlight-current-row":"","table-layout":U.value,onSelectionChange:te,onRowClick:z},{default:n(()=>[o(g,{type:"selection",width:"55",selectable:le}),(v(!0),P(L,null,_e(J.value,t=>(v(),F(g,{key:t.prop,label:t.label,prop:t.prop},null,8,["label","prop"]))),128)),o(g,{fixed:"right",label:"操作",width:"150"},{default:n(t=>{var k,B;return[x(o(c,{link:"",type:"primary",icon:f(be),disabled:t.row.role=="sysadmin",onClick:de=>Y(t.row)},null,8,["icon","disabled","onClick"]),[[$,`${(k=f(V).name)==null?void 0:k.replace("_info","")}:edit`]]),x(o(c,{disabled:t.row.role=="sysadmin",link:"",type:"danger",icon:f(ge),onClick:de=>Z(t.row)},null,8,["disabled","icon","onClick"]),[[$,`${(B=f(V).name)==null?void 0:B.replace("_info","")}:delete`]])]}),_:1})]),_:1},8,["data","table-layout"])),[[ie,A.value]])])]),o(re,{modelValue:u.value,"onUpdate:modelValue":e[3]||(e[3]=t=>u.value=t),title:h.value=="add"?"新增角色":"编辑角色",width:"50%","before-close":H},{default:n(()=>[o(ne,{model:a,class:"demo-form-inline","label-position":"right","label-width":"80px",ref:"userFrom","status-icon":""},{default:n(()=>[o(C,{label:"角色",prop:"role",rules:[{required:!0}]},{default:n(()=>[o(E,{modelValue:a.role,"onUpdate:modelValue":e[0]||(e[0]=t=>a.role=t),placeholder:"请输入英文",clearable:"",style:{width:"30%"},disabled:w.value},null,8,["modelValue","disabled"])]),_:1}),o(C,{label:"角色名称",prop:"role_name",rules:[{required:!0}]},{default:n(()=>[o(E,{modelValue:a.role_name,"onUpdate:modelValue":e[1]||(e[1]=t=>a.role_name=t),placeholder:"中文名称",style:{width:"30%"},clearable:"",disabled:w.value},null,8,["modelValue","disabled"])]),_:1}),o(C,{label:"菜单授权",prop:"rolePermission"},{default:n(()=>[p("div",Ve,[o(f(ve),{ref_key:"menuTreeRef",ref:m,modelValue:a.rolePermission,"onUpdate:modelValue":e[2]||(e[2]=t=>a.rolePermission=t),data:S.value,"show-checkbox":"","node-key":"id","default-expand-all":"","expand-on-click-node":!1,props:{class:j}},{default:n(({node:t,data:k})=>[p("span",{class:ye({buttonList:k.tree_type==="button"})},he(t.label),3)]),_:1},8,["modelValue","data","props"])])]),_:1}),o(se,{style:{"justify-content":"space-around"}},{default:n(()=>[o(C,null,{default:n(()=>[o(c,{onClick:G},{default:n(()=>e[5]||(e[5]=[N("取消")])),_:1}),o(c,{type:"primary",onClick:X},{default:n(()=>e[6]||(e[6]=[N(" 确定")])),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])],64)}}}),Re=Ce($e,[["__scopeId","data-v-014ce22e"]]);export{Re as default};
