import{d as Me,g as Se,x as Be,j as Ee,v as T,r as q,a as ze,bP as Pe,z as Ne,h as b,bc as De,c as y,o as n,b as F,bV as ie,f as l,m as te,B as o,w as t,q as c,t as p,F as j,i as M,cc as Fe,cd as Le,k as I,b_ as z,aP as Te,c4 as je,_ as Ae,u as Je,cq as He}from"./index-Cm0tF2Sj.js";import{e as We,d as Ge}from"./gmCrypto-DdGZyDwn.js";import{m as Ye}from"./model-BRqCW4T7.js";import{c as Qe}from"./ciDataAudit-BeXhz0sf.js";import"./vue3-json-viewer-zS_6goZ0.js";const Xe={class:"relations-card"},Ze={class:"card-header"},Ke={key:0},et={key:1},tt={key:0},at={key:1},lt=["innerHTML"],nt={style:{float:"left"}},ot={style:{float:"right",color:"var(--el-text-color-secondary)","font-size":"13px"}},rt={key:3,style:{"font-size":"12px",color:"#999","margin-top":"3px"}},ut={class:"dialog-footer"},st=Me({__name:"ciDataRelation",props:{instanceId:{type:String,required:!0},modelId:{type:String,required:!0}},setup(ne){const E=ne,{proxy:W}=Se(),v=Be();Ee();const G=Ye(),ce=T(()=>G.modelOptions),L=T(()=>G.modelObjectById),be=T(()=>G.validationRulesEnumOptionsObject),_e=q(!1),oe=q(!1),re=q([]),Q=q([]),N=q([]),h=ze({currentPage:1,pageSize:10,total:0}),X=q(!1),de=q(),C=q(!1),s=q(null),f=ze({relation:null,source_instance:E.instanceId,target_instance:null,source_attributes:{},target_attributes:{},relation_attributes:{}}),ge={relation:[{required:!0,message:"请选择关系类型",trigger:"change"}],target_instance:[{required:!0,message:"请选择目标实例",trigger:"change"}],source_attributes:{},target_attributes:{},relation_attributes:{}},ue=async()=>{_e.value=!0;try{const a=await W.$api.getModelInstanceRelation({instances:E.instanceId,page:h.currentPage,page_size:h.pageSize});re.value=a.data.results,h.total=a.data.count}catch(a){z.error("获取关联关系数据失败"),console.error(a)}finally{_e.value=!1}},A=T(()=>{const a={};return Q.value.forEach(r=>{a[r.id]=r}),a}),J=q(null),H=q([]),Y=q(!1);Pe(()=>f.relation,()=>{if(!f.relation)return;let a=A.value[f.relation].source_model,r=A.value[f.relation].target_model;(a==null?void 0:a.indexOf(E.modelId))!==-1?(r==null?void 0:r.indexOf(E.modelId))!==-1?H.value=ce.value.filter(i=>r.indexOf(i.value)!==-1||a.indexOf(i.value)!==-1):(H.value=ce.value.filter(i=>r.indexOf(i.value)!==-1),Y.value=!1):(H.value=ce.value.filter(i=>a.indexOf(i.value)!==-1),Y.value=!0),J.value=H.value[0].value},{deep:!0});const ae=()=>{C.value||(f.target_instance=null)},pe=async()=>{try{const a=await W.$api.getModelRelationDefine({any_model:E.modelId});Q.value=a.data.results}catch(a){z.error("获取关系类型失败"),console.error(a)}},me=async a=>{if(!f.relation){N.value=[];return}oe.value=!0;try{if(J.value){const r=await W.$api.getCiModelInstance({model:J.value,search:a,page_size:20});N.value=r.data.results,N.value=N.value.filter(i=>i.id!==E.instanceId)}}catch(r){z.error("搜索目标实例失败"),console.error(r)}finally{oe.value=!1}},we=()=>{f.target_instance=null,me("")},$e=()=>{C.value=!1,s.value=null,X.value=!0,pe()},Ie=async a=>{C.value=!0,s.value=a.id,X.value=!0,Q.value.length===0&&await pe(),f.relation=a.relation.id,f.source_attributes=a.source_attributes||{},f.target_attributes=a.target_attributes||{},f.relation_attributes=a.relation_attributes||{},Y.value=a.source_instance.id!==E.instanceId,Te(()=>{J.value=a.target_instance.model,N.value=[{id:a.source_instance.id,instance_name:a.source_instance.instance_name},{id:a.target_instance.id,instance_name:a.target_instance.instance_name}],f.target_instance=Y.value?a.source_instance.id:a.target_instance.id})},ye=()=>{var a;(a=de.value)==null||a.resetFields(),f.relation=null,f.target_instance=null,f.source_attributes={},f.target_attributes={},f.relation_attributes={},N.value=[],C.value=!1,Y.value=!1,s.value=null,H.value=[],J.value=null},qe=async()=>{var a;await((a=de.value)==null?void 0:a.validate(async r=>{if(r)try{let i,$={...f};Y.value&&($.target_instance=f.source_instance,$.source_instance=f.target_instance),C.value?i=await W.$api.updateModelInstanceRelation({id:s.value,...$}):i=await W.$api.addModelInstanceRelation({source_instance:E.instanceId,...$}),i.status===201&&!C.value||i.status===200&&C.value?(z.success(C.value?"编辑关联关系成功":"添加关联关系成功"),X.value=!1,ye(),ue()):z.error(C.value?`编辑关联关系失败,${JSON.stringify(i.data)}`:`添加关联关系失败,${JSON.stringify(i.data)}}`)}catch(i){z.error((C.value?"编辑关联关系失败: ":"添加关联关系失败: ")+i.message),console.error(i)}}))},he=a=>{je.confirm("确定要删除这个关联关系吗？","确认删除",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{(await W.$api.deleteModelInstanceRelation(a)).status===204?(z.success("删除成功"),ue()):z.error("删除失败")}catch(r){z.error("删除失败: "+r.message),console.error(r)}}).catch(()=>{})},ke=a=>{h.pageSize=a,ue()},m=a=>{h.currentPage=a,ue()},_=a=>a?a.source_instance.id===E.instanceId?a.relation.forward_verb:a.relation.reverse_verb:"",V=a=>{var le,K;if(!a)return"";const r=a.source_instance.instance_name,i=a.target_instance.instance_name,$=_(a),x=(le=L.value[a.source_instance.model])==null?void 0:le.verbose_name,B=(K=L.value[a.target_instance.model])==null?void 0:K.verbose_name;let S,P;if(a.source_instance.id===E.instanceId){S=Object.keys(a.source_attributes).map(U=>`${w(a.relation,U)}: ${O(a.relation,U,a.source_attributes[U])}`).join(", "),P=Object.keys(a.target_attributes).map(U=>`${g(a.relation,U)}: ${O(a.relation,U,a.target_attributes[U])}`).join(", ");let R=`<span class="source-name">${r}</span>(${x})`;return S&&(R+=`的[${S}]`),R+=` - <span class="relation-name">${$}</span> - <span class="target-name">${i}</span>(${B})`,P&&(R+=`的[${P}]`),R}else{P=Object.keys(a.target_attributes).map(U=>`${g(a.relation,U)}: ${O(a.relation,U,a.target_attributes[U])}`).join(", "),S=Object.keys(a.source_attributes).map(U=>`${w(a.relation,U)}: ${O(a.relation,U,a.source_attributes[U])}`).join(", ");let R=`<span class="source-name">${i}</span>(${B})`;return P&&(R+=`的[${P}]`),R+=` - <span class="relation-name">${$}</span> - <span class="target-name">${r}</span>(${x})`,S&&(R+=`的[${S}]`),R}},w=(a,r)=>{if(!a||!a.attribute_schema||!a.attribute_schema.source)return r;const i=a.attribute_schema.source[r];return i?i.verbose_name:r},Z=(a,r)=>{if(!a||!a.attribute_schema||!a.attribute_schema.relation)return r;const i=a.attribute_schema.relation[r];return i?i.verbose_name:r},g=(a,r)=>{if(!a||!a.attribute_schema||!a.attribute_schema.target)return r;const i=a.attribute_schema.target[r];return i?i.verbose_name:r},O=(a,r,i)=>{if(!a||!a.attribute_schema||!a.attribute_schema.relation)return i;const $=a.attribute_schema.relation[r];if(!$)return i;if($.type==="enum"&&$.validation_rule){const x=be.value[$.validation_rule];if(x){const B=x.find(S=>S.value===i);if(B)return B.label}}return $.unit?`${i} ${$.unit}`:i};return Ne(()=>{ue(),pe()}),(a,r)=>{var ve;const i=b("el-button"),$=b("el-tag"),x=b("el-table-column"),B=b("el-text"),S=b("el-table"),P=b("el-pagination"),le=b("el-option"),K=b("el-select"),R=b("el-form-item"),U=b("el-radio-button"),Ve=b("el-radio-group"),xe=b("el-radio"),fe=b("el-input"),Ce=b("el-input-number"),Oe=b("el-form"),Re=b("el-dialog"),se=De("permission"),Ue=De("loading");return n(),y("div",Xe,[F("div",Ze,[F("div",null,[ie((n(),o(i,{type:"primary",onClick:$e},{default:t(()=>[...r[8]||(r[8]=[c(" 添加关联 ",-1)])]),_:1})),[[se,`${(ve=te(v).name)==null?void 0:ve.replace("_info","")}:add`]])])]),ie((n(),o(S,{data:re.value,style:{width:"100%"},border:""},{default:t(()=>[l(x,{prop:"source_instance",label:"源实例"},{default:t(d=>[d.row.source_instance.id!==ne.instanceId?(n(),o($,{key:0},{default:t(()=>[c(p(d.row.target_instance.instance_name),1)]),_:2},1024)):(n(),o($,{key:1},{default:t(()=>[c(p(d.row.source_instance.instance_name),1)]),_:2},1024))]),_:1}),l(x,{prop:"source_attributes",label:"源属性",width:"150"},{default:t(d=>[d.row.source_instance.id===ne.instanceId?(n(),y("div",Ke,[(n(!0),y(j,null,M(d.row.source_attributes,(u,e)=>(n(),y("div",{key:e,style:{"font-size":"12px"}},[l(B,{tag:"b"},{default:t(()=>[c(p(w(d.row.relation,e))+":",1)]),_:2},1024),c(" "+p(u),1)]))),128))])):(n(),y("div",et,[(n(!0),y(j,null,M(d.row.target_attributes,(u,e)=>(n(),y("div",{key:e,style:{"font-size":"12px"}},[l(B,{tag:"b"},{default:t(()=>[c(p(g(d.row.relation,e))+":",1)]),_:2},1024),c(" "+p(u),1)]))),128))]))]),_:1}),l(x,{prop:"relation",label:"关联动作",width:"100"},{default:t(d=>[l($,{type:"success"},{default:t(()=>[c(p(_(d.row)),1)]),_:2},1024)]),_:1}),l(x,{prop:"source_instance",label:"目标实例"},{default:t(d=>[d.row.source_instance.id!==ne.instanceId?(n(),o($,{key:0},{default:t(()=>[c(p(d.row.source_instance.instance_name),1)]),_:2},1024)):(n(),o($,{key:1},{default:t(()=>[c(p(d.row.target_instance.instance_name),1)]),_:2},1024))]),_:1}),l(x,{prop:"target_attributes",label:"目标属性",width:"150"},{default:t(d=>[d.row.source_instance.id!==ne.instanceId?(n(),y("div",tt,[(n(!0),y(j,null,M(d.row.source_attributes,(u,e)=>(n(),y("div",{key:e,style:{"font-size":"12px"}},[l(B,{tag:"b"},{default:t(()=>[c(p(w(d.row.relation,e))+":",1)]),_:2},1024),c(" "+p(u),1)]))),128))])):(n(),y("div",at,[(n(!0),y(j,null,M(d.row.target_attributes,(u,e)=>(n(),y("div",{key:e,style:{"font-size":"12px"}},[l(B,{tag:"b"},{default:t(()=>[c(p(g(d.row.relation,e))+":",1)]),_:2},1024),c(" "+p(u),1)]))),128))]))]),_:1}),l(x,{prop:"relation_attributes",label:"关系属性",width:"150"},{default:t(d=>[(n(!0),y(j,null,M(d.row.relation_attributes,(u,e)=>(n(),y("div",{key:e,style:{"font-size":"12px"}},[l(B,{tag:"b"},{default:t(()=>[c(p(Z(d.row.relation,e))+":",1)]),_:2},1024),c(" "+p(O(d.row.relation,e,u)),1)]))),128))]),_:1}),l(x,{prop:"relation",label:"关系类型",width:"150"},{default:t(d=>[l($,{type:"info"},{default:t(()=>[c(p(d.row.relation.name),1)]),_:2},1024)]),_:1}),l(x,{prop:"id",label:"关联动作描述"},{default:t(d=>[F("div",{class:"relation-description",innerHTML:V(d.row)},null,8,lt)]),_:1}),l(x,{label:"操作",width:"120",fixed:"right"},{default:t(d=>{var u,e;return[ie(l(i,{onClick:D=>Ie(d.row),type:"primary",icon:te(Fe),link:""},null,8,["onClick","icon"]),[[se,`${(u=te(v).name)==null?void 0:u.replace("_info","")}:edit`]]),ie(l(i,{type:"danger",link:"",icon:te(Le),onClick:D=>he(d.row.id)},null,8,["icon","onClick"]),[[se,`${(e=te(v).name)==null?void 0:e.replace("_info","")}:delete`]])]}),_:1})]),_:1},8,["data"])),[[Ue,_e.value]]),l(P,{"current-page":h.currentPage,"onUpdate:currentPage":r[0]||(r[0]=d=>h.currentPage=d),"page-size":h.pageSize,"onUpdate:pageSize":r[1]||(r[1]=d=>h.pageSize=d),"page-sizes":[10,20,50],layout:"total, sizes, prev, pager, next, jumper",total:h.total,onSizeChange:ke,onCurrentChange:m,style:{"margin-top":"20px","justify-content":"flex-end"}},null,8,["current-page","page-size","total"]),l(Re,{modelValue:X.value,"onUpdate:modelValue":r[7]||(r[7]=d=>X.value=d),title:C.value?"编辑关联关系":"添加关联关系",width:"600px",onClose:ye},{footer:t(()=>[F("div",ut,[l(i,{onClick:r[6]||(r[6]=d=>X.value=!1)},{default:t(()=>[...r[9]||(r[9]=[c("取消",-1)])]),_:1}),l(i,{type:"primary",onClick:qe},{default:t(()=>[c(p(C.value?"保存":"添加"),1)]),_:1})])]),default:t(()=>[l(Oe,{ref_key:"addRelationFormRef",ref:de,model:f,rules:ge,"label-width":"120px"},{default:t(()=>{var d;return[l(R,{label:"关系类型",prop:"relation"},{default:t(()=>[l(K,{modelValue:f.relation,"onUpdate:modelValue":r[2]||(r[2]=u=>f.relation=u),placeholder:"请选择关系类型",style:{width:"100%"},onChange:we,disabled:C.value},{default:t(()=>[(n(!0),y(j,null,M(Q.value,u=>(n(),o(le,{key:u.id,label:u.name,value:u.id},{default:t(()=>{var e;return[F("span",nt,p(u.name),1),F("span",ot,p(((e=u.source_model)==null?void 0:e.indexOf(E.modelId))>>>-1?"目标实例":"源实例"),1)]}),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),l(R,{label:"目标实例",prop:"target_instance"},{default:t(()=>[l(Ve,{modelValue:J.value,"onUpdate:modelValue":r[3]||(r[3]=u=>J.value=u),size:"default",onChange:ae},{default:t(()=>[(n(!0),y(j,null,M(H.value,(u,e)=>(n(),o(U,{disabled:C.value,label:u.label,value:u.value,key:e},null,8,["disabled","label","value"]))),128))]),_:1},8,["modelValue"]),l(K,{modelValue:f.target_instance,"onUpdate:modelValue":r[4]||(r[4]=u=>f.target_instance=u),placeholder:"请选择关联实例",style:{width:"100%","margin-top":"5px"},filterable:"",remote:"","remote-method":me,loading:oe.value,disabled:C.value},{default:t(()=>[(n(!0),y(j,null,M(N.value,u=>(n(),o(le,{key:u.id,label:u.instance_name,value:u.id},null,8,["label","value"]))),128))]),_:1},8,["modelValue","loading","disabled"])]),_:1}),J.value===ne.modelId?(n(),o(R,{key:0,label:"关联动作"},{default:t(()=>[l(Ve,{modelValue:Y.value,"onUpdate:modelValue":r[5]||(r[5]=u=>Y.value=u),disabled:C.value},{default:t(()=>[l(xe,{value:!1,size:"large"},{default:t(()=>{var u;return[c(p((u=A.value[f.relation])==null?void 0:u.forward_verb),1)]}),_:1}),l(xe,{value:!0,size:"large"},{default:t(()=>{var u;return[c(p((u=A.value[f.relation])==null?void 0:u.reverse_verb),1)]}),_:1})]),_:1},8,["modelValue","disabled"])]),_:1})):I("",!0),(d=A.value[f.relation])!=null&&d.attribute_schema?(n(),y(j,{key:1},[(n(!0),y(j,null,M(A.value[f.relation].attribute_schema.source,(u,e)=>(n(),o(R,{key:"source_"+e,label:u.verbose_name,prop:"source_attributes."+e,required:u.required},{default:t(()=>[l(fe,{modelValue:f.source_attributes[e],"onUpdate:modelValue":D=>f.source_attributes[e]=D,placeholder:"请输入"+u.verbose_name,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),_:2},1032,["label","prop","required"]))),128)),(n(!0),y(j,null,M(A.value[f.relation].attribute_schema.target,(u,e)=>(n(),o(R,{key:"target_"+e,label:u.verbose_name,prop:"target_attributes."+e,required:u.required},{default:t(()=>[l(fe,{modelValue:f.target_attributes[e],"onUpdate:modelValue":D=>f.target_attributes[e]=D,placeholder:"请输入"+u.verbose_name,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue","placeholder"])]),_:2},1032,["label","prop","required"]))),128)),(n(!0),y(j,null,M(A.value[f.relation].attribute_schema.relation,(u,e)=>(n(),o(R,{key:"relation_"+e,label:u.verbose_name,prop:"relation_attributes."+e,required:u.required},{default:t(()=>[u.type==="enum"?(n(),o(K,{key:0,modelValue:f.relation_attributes[e],"onUpdate:modelValue":D=>f.relation_attributes[e]=D,placeholder:"请选择"+u.verbose_name,style:{width:"100%"}},{default:t(()=>[(n(!0),y(j,null,M(be.value[u.validation_rule],D=>(n(),o(le,{key:D.value,label:D.label,value:D.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue","placeholder"])):["integer","float"].includes(u.type)?(n(),o(Ce,{key:1,modelValue:f.relation_attributes[e],"onUpdate:modelValue":D=>f.relation_attributes[e]=D,placeholder:"请输入"+u.verbose_name,style:{width:"100%"},"controls-position":"right"},null,8,["modelValue","onUpdate:modelValue","placeholder"])):(n(),o(fe,{key:2,modelValue:f.relation_attributes[e],"onUpdate:modelValue":D=>f.relation_attributes[e]=D,placeholder:"请输入"+u.verbose_name,style:{width:"100%"}},null,8,["modelValue","onUpdate:modelValue","placeholder"])),u.unit?(n(),y("div",rt," 单位: "+p(u.unit),1)):I("",!0)]),_:2},1032,["label","prop","required"]))),128))],64)):I("",!0)]}),_:1},8,["model"])]),_:1},8,["modelValue","title"])])}}}),dt=Ae(st,[["__scopeId","data-v-61e5761f"]]),it={class:"divVertical gap-5"},ct={class:"header card"},_t={class:"content card"},pt={style:{width:"200px",display:"flex","justify-content":"flex-end","margin-right":"20px"}},mt={key:0},ft={key:1},vt={key:1},bt={key:1},gt=Me({__name:"ciDataInfoView",setup(ne,{expose:E}){const W=q(null),v=q({}),G=Ye(),ce=T(()=>G.modelObjectById),L=q({}),be=T(()=>G.validationRulesEnumOptionsObject),_e=T(()=>G.allModelCiDataTreeObj),{proxy:oe}=Se(),re=Be(),Q=Ee(),N=Je(),h=q(!1),X=T(()=>N.gmCry),de=q(null),C=q(),s=ze({id:null,instance_name:null,using_template:!0}),f=q(null),ge=q("modelField"),ue=(m,_)=>{m.props.name=="changelog"&&f.value.getData()},A=q([0]),J=q({}),H=()=>{s.id=v.value.id,s.instance_name=v.value.instance_name,s.using_template=v.value.using_template,Object.keys(v.value.fields).forEach(m=>{ae.value.enum.includes(m)?v.value.fields[m]!==null?s[m]=v.value.fields[m].value:s[m]=null:ae.value.model_ref.includes(m)?v.value.fields[m]!==null?(J.value[m]=[v.value.fields[m]],s[m]=v.value.fields[m].id):s[m]=null:s[m]=v.value.fields[m]}),console.log(s)},Y=T(()=>{var m,_;return(_=(m=v.value)==null?void 0:m.instance_group)==null?void 0:_.some(V=>V.group_path.includes("空闲池"))}),ae=T(()=>{let m={enum:[],boolean:[],model_ref:[],password:[]};return L.value.field_groups&&L.value.field_groups.forEach(_=>{_.fields.forEach(V=>{V.type==="enum"?m.enum.push(V.name):V.type==="boolean"?m.boolean.push(V.name):V.type==="model_ref"?m.model_ref.push(V.name):V.type==="password"&&m.password.push(V.name)})}),m}),pe=m=>{if(!(m==""||m==null))return[{pattern:new RegExp(".*"),message:"不符合正则表达式",trigger:"blur"}]},me=T(()=>{let m={};for(let[_,V]of Object.entries(s)){if(["id","instance_name","using_template"].includes(_))continue;let w=v.value.fields[_];ae.value.enum.includes(_)?w=v.value.fields[_]===null?null:v.value.fields[_].value:ae.value.model_ref.includes(_)?w=v.value.fields[_]===null?null:v.value.fields[_].id:ae.value.password.includes(_)&&(N.showAllPass||(w=v.value.fields[_])),(V!==w||V===null&&w!==null&&w!==void 0||V===""&&w!==""&&w!==null&&w!==void 0)&&(ae.value.password.includes(_)&&V!==null&&V!==""?m[_]=We(N.gmCry.key,N.gmCry.mode,V):m[_]=V)}return m}),we=T(()=>{var m;return(((m=L.value)==null?void 0:m.field_groups)||[]).reduce((_,V)=>((V.fields||[]).forEach(w=>{_[w.name]=w}),_),{})}),$e=()=>{h.value=!0},Ie=()=>{h.value=!1,Te(()=>{H()})},ye=async()=>{C.value&&await C.value.validate(async(m,_)=>{if(m){if(Object.keys(me.value).length===0&&s.instance_name===v.value.instance_name&&s.using_template===v.value.using_template){z({showClose:!0,message:"没有数据发生变更",type:"warning"}),h.value=!1;return}const V=He.service({lock:!0,text:"保存中...",background:"rgba(0, 0, 0, 0.7)"});let w={id:v.value.id,model:L.value.id,fields:me.value};s.using_template!==v.value.using_template&&(w.using_template=s.using_template),s.instance_name!==v.value.instance_name&&(w.instance_name=s.instance_name);try{let Z=await oe.$api.updateCiModelInstance(w);Z.status=="200"?(z({type:"success",message:"保存成功"}),h.value=!1,ke()):(console.log(Z),z({showClose:!0,message:"保存失败:"+JSON.stringify(Z.data),type:"error"}))}catch(Z){console.log(Z),z({showClose:!0,message:"保存失败，请稍后重试",type:"error"})}finally{V.close()}}else z({showClose:!0,message:"表单填写有误，请检查",type:"error"})})},qe=()=>{je.confirm("确定要删除该实例吗？此操作不可恢复","删除实例",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(async()=>{try{let m=await oe.$api.deleteCiModelInstance(v.value.id);m.status==204?(z.success("删除成功"),he()):z.error(`删除失败,${JSON.stringify(m.data)}`)}catch{z.error("删除失败，error")}}).catch(()=>{})},he=()=>{if(re.name.includes("cmdb_only")){Q.push({path:"/cmdb_only/cmdb/cidata"});return}if(!h.value){Q.push({path:"/cmdb/cidata"});return}je.confirm("确定要离开页面吗？未保存的数据将会丢失","提示",{confirmButtonText:"确定",cancelButtonText:"取消",type:"warning"}).then(()=>{Q.push({path:"/cmdb/cidata"})}).catch(()=>{})},ke=async()=>{var _,V,w;const m=await oe.$api.getCiModelInstanceInfo(W.value);m.status===200&&(v.value=m.data,de.value=(V=(_=v.value)==null?void 0:_.fields)==null?void 0:V.ip,console.log(de.value),L.value=ce.value[(w=v.value)==null?void 0:w.model])};return Ne(async()=>{try{W.value=re.path.split("/").at(-1),await ke(),G.getModel(),G.getValidationRules(),H()}catch(m){console.log(m),z.error("数据加载失败",m),Q.back()}}),E({initEditForm:H}),(m,_)=>{const V=b("el-page-header"),w=b("el-descriptions-item"),Z=b("el-descriptions"),g=b("el-text"),O=b("Warning"),a=b("el-icon"),r=b("el-tooltip"),i=b("el-space"),$=b("el-input"),x=b("el-form-item"),B=b("el-switch"),S=b("el-button"),P=b("el-row"),le=b("InfoFilled"),K=b("el-input-number"),R=b("el-date-picker"),U=b("el-option"),Ve=b("el-select"),xe=b("el-select-v2"),fe=b("el-col"),Ce=b("el-collapse-item"),Oe=b("el-collapse"),Re=b("el-form"),se=b("el-tab-pane"),Ue=b("el-tabs"),ve=De("permission");return n(),y("div",it,[F("div",ct,[l(V,{onBack:he},{content:t(()=>{var d;return[F("span",null,p(`${(d=L.value)==null?void 0:d.verbose_name}【${v.value.instance_name}】`),1)]}),_:1})]),F("div",_t,[l(Z,{border:"",column:2,style:{width:"40%","margin-bottom":"10px"},"label-width":"100px"},{default:t(()=>[l(w,{label:"唯一标识"},{default:t(()=>[c(p(v.value.instance_name),1)]),_:1}),l(w,{label:"所属分组",width:"55%"},{default:t(()=>{var d;return[(n(!0),y(j,null,M((d=v.value)==null?void 0:d.instance_group,(u,e)=>(n(),y("div",{key:e,class:"group-item"},p(u.group_path),1))),128))]}),_:1})]),_:1}),l(Ue,{modelValue:ge.value,"onUpdate:modelValue":_[3]||(_[3]=d=>ge.value=d),type:"card",class:"demo-tabs",onTabClick:ue},{default:t(()=>[l(se,{label:"资产信息",name:"modelField"},{default:t(()=>[l(Re,{ref_key:"editFormRef",ref:C,style:{"max-width":"100%"},model:s,"label-width":"auto","status-icon":"","label-position":"top","require-asterisk-position":"right"},{default:t(()=>[l(P,{gutter:20,justify:"space-between"},{default:t(()=>{var d;return[l(x,{prop:"instance_name",required:"",style:{"margin-left":"30px"}},{label:t(()=>[l(i,{size:2},{default:t(()=>[l(g,{tag:"b"},{default:t(()=>[..._[4]||(_[4]=[c("唯一标识",-1)])]),_:1}),l(r,{content:"唯一命名标识",placement:"right",effect:"dark"},{default:t(()=>[l(a,null,{default:t(()=>[l(O)]),_:1})]),_:1})]),_:1})]),default:t(()=>[h.value?(n(),o($,{key:0,modelValue:s.instance_name,"onUpdate:modelValue":_[0]||(_[0]=u=>s.instance_name=u),style:{"min-width":"400px"}},null,8,["modelValue"])):(n(),o(g,{key:1},{default:t(()=>[c(p(s.instance_name),1)]),_:1}))]),_:1}),l(x,{prop:"using_template",required:"",style:{"margin-left":"30px"}},{label:t(()=>[l(i,{size:2},{default:t(()=>[l(g,{tag:"b"},{default:t(()=>[..._[5]||(_[5]=[c("自动命名",-1)])]),_:1}),l(r,{content:"是否根据模型的唯一命名规则，自动生成唯一标识",placement:"right",effect:"dark"},{default:t(()=>[l(a,null,{default:t(()=>[l(O)]),_:1})]),_:1})]),_:1})]),default:t(()=>[l(B,{modelValue:s.using_template,"onUpdate:modelValue":_[1]||(_[1]=u=>s.using_template=u),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},disabled:!h.value},null,8,["modelValue","disabled"])]),_:1}),F("div",pt,[h.value?(n(),y("div",ft,[l(S,{onClick:Ie},{default:t(()=>[..._[8]||(_[8]=[c("取消",-1)])]),_:1}),l(S,{type:"primary",onClick:ye},{default:t(()=>[..._[9]||(_[9]=[c("保存",-1)])]),_:1})])):(n(),y("div",mt,[ie((n(),o(S,{type:"primary",onClick:$e},{default:t(()=>[..._[6]||(_[6]=[c("编辑",-1)])]),_:1})),[[ve,`${(d=te(re).name)==null?void 0:d.replace("_info","")}:edit`]]),l(r,{content:Y.value?"删除实例":"实例不在空闲池，无法删除!",placement:"top",effect:"dark"},{default:t(()=>{var u;return[ie((n(),o(S,{type:"danger",onClick:qe,disabled:!Y.value},{default:t(()=>[..._[7]||(_[7]=[c("删除",-1)])]),_:1},8,["disabled"])),[[ve,`${(u=te(re).name)==null?void 0:u.replace("_info","")}:delete`]])]}),_:1},8,["content"])]))])]}),_:1}),l(Oe,{modelValue:A.value,"onUpdate:modelValue":_[2]||(_[2]=d=>A.value=d)},{default:t(()=>[(n(!0),y(j,null,M(L.value.field_groups,(d,u)=>(n(),o(Ce,{name:u,key:u},{title:t(()=>[l(g,{tag:"b",size:"large"},{default:t(()=>[c(p(d.verbose_name),1)]),_:2},1024)]),default:t(()=>[l(P,{gutter:20,style:{"margin-left":"30px"}},{default:t(()=>[(n(!0),y(j,null,M(d.fields,(e,D)=>(n(),o(fe,{key:D,xs:24,sm:24,md:12,lg:8,xl:6},{default:t(()=>[e.type==="string"?(n(),o(x,{key:0,label:e.verbose_name,prop:e.name,required:e.required,rules:pe(e.validation_rule)},{label:t(()=>[l(i,{size:2},{default:t(()=>[l(g,{tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(n(),o(r,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(a,null,{default:t(()=>[l(O)]),_:1})]),_:1},8,["content"])):I("",!0)]),_:2},1024)]),default:t(()=>[h.value?(n(),o($,{key:0,modelValue:s[e.name],"onUpdate:modelValue":k=>s[e.name]=k,style:{width:"240px"},disabled:!e.editable},null,8,["modelValue","onUpdate:modelValue","disabled"])):(n(),o(g,{key:1},{default:t(()=>[c(p(s[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required","rules"])):I("",!0),e.type==="json"?(n(),o(x,{key:1,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[l(i,{size:2},{default:t(()=>[l(g,{tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024),l(r,{placement:"right",effect:"dark"},{content:t(()=>[..._[10]||(_[10]=[c(" json类型字段",-1),F("br",null,null,-1),c("请输入json格式数据! ",-1)])]),default:t(()=>[l(a,null,{default:t(()=>[l(le)]),_:1})]),_:1}),e.description.length!=0?(n(),o(r,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(a,null,{default:t(()=>[l(O)]),_:1})]),_:1},8,["content"])):I("",!0)]),_:2},1024)]),default:t(()=>[h.value?(n(),o($,{key:0,modelValue:s[e.name],"onUpdate:modelValue":k=>s[e.name]=k,style:{width:"240px"},autosize:"",type:"textarea"},null,8,["modelValue","onUpdate:modelValue"])):(n(),o(g,{key:1},{default:t(()=>[c(p(s[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])):I("",!0),["text"].indexOf(e.type)>>>-1?I("",!0):(n(),o(x,{key:2,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[l(i,{size:2},{default:t(()=>[l(g,{tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(n(),o(r,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(a,null,{default:t(()=>[l(O)]),_:1})]),_:1},8,["content"])):I("",!0)]),_:2},1024)]),default:t(()=>[h.value?(n(),o($,{key:0,modelValue:s[e.name],"onUpdate:modelValue":k=>s[e.name]=k,style:{width:"240px"},autosize:"",type:"textarea"},null,8,["modelValue","onUpdate:modelValue"])):(n(),o(g,{key:1},{default:t(()=>[c(p(s[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])),e.type==="boolean"?(n(),o(x,{key:3,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[l(i,{size:2},{default:t(()=>[l(g,{tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(n(),o(r,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(a,null,{default:t(()=>[l(O)]),_:1})]),_:1},8,["content"])):I("",!0)]),_:2},1024)]),default:t(()=>[l(B,{modelValue:s[e.name],"onUpdate:modelValue":k=>s[e.name]=k,style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},disabled:!h.value},null,8,["modelValue","onUpdate:modelValue","disabled"])]),_:2},1032,["label","prop","required"])):I("",!0),["float"].indexOf(e.type)>>>-1?I("",!0):(n(),o(x,{key:4,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[l(i,{size:2},{default:t(()=>[e.unit!==null?(n(),o(g,{key:0,tag:"b"},{default:t(()=>[c(p(e.verbose_name+"("+e.unit+")"),1)]),_:2},1024)):(n(),o(g,{key:1,tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024)),e.description.length!=0?(n(),o(r,{key:2,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(a,null,{default:t(()=>[l(O)]),_:1})]),_:1},8,["content"])):I("",!0)]),_:2},1024)]),default:t(()=>[h.value?(n(),o(K,{key:0,modelValue:s[e.name],"onUpdate:modelValue":k=>s[e.name]=k,precision:2,step:1},null,8,["modelValue","onUpdate:modelValue"])):(n(),o(g,{key:1},{default:t(()=>[c(p(s[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])),["password"].indexOf(e.type)>>>-1?I("",!0):(n(),o(x,{key:5,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[l(i,{size:2},{default:t(()=>[l(g,{tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(n(),o(r,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(a,null,{default:t(()=>[l(O)]),_:1})]),_:1},8,["content"])):I("",!0)]),_:2},1024)]),default:t(()=>{var k;return[h.value?(n(),o($,{key:0,modelValue:s[e.name],"onUpdate:modelValue":ee=>s[e.name]=ee,style:{width:"240px"},type:"password","auto-complete":"new-password","show-password":"",clearable:""},null,8,["modelValue","onUpdate:modelValue"])):(n(),y("div",vt,[te(N).showAllPass?(n(),o(g,{key:0},{default:t(()=>[c(p(te(Ge)(X.value.key,X.value.mode,s[e.name])),1)]),_:2},1024)):(n(),y("div",bt,[((k=s[e.name])==null?void 0:k.length)>>0?(n(),o(g,{key:0},{default:t(()=>{var ee;return[c(p("*".repeat((ee=s[e.name])==null?void 0:ee.length)),1)]}),_:2},1024)):(n(),o(g,{key:1}))]))]))]}),_:2},1032,["label","prop","required"])),["integer"].indexOf(e.type)>>>-1?I("",!0):(n(),o(x,{key:6,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[l(i,{size:2},{default:t(()=>[e.unit!==null?(n(),o(g,{key:0,tag:"b"},{default:t(()=>[c(p(e.verbose_name+"("+e.unit+")"),1)]),_:2},1024)):(n(),o(g,{key:1,tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024)),e.description.length!=0?(n(),o(r,{key:2,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(a,null,{default:t(()=>[l(O)]),_:1})]),_:1},8,["content"])):I("",!0)]),_:2},1024)]),default:t(()=>[h.value?(n(),o(K,{key:0,modelValue:s[e.name],"onUpdate:modelValue":k=>s[e.name]=k,step:1},null,8,["modelValue","onUpdate:modelValue"])):(n(),o(g,{key:1},{default:t(()=>[c(p(s[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])),["date"].indexOf(e.type)>>>-1?I("",!0):(n(),o(x,{key:7,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[l(i,{size:2},{default:t(()=>[l(g,{tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(n(),o(r,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(a,null,{default:t(()=>[l(O)]),_:1})]),_:1},8,["content"])):I("",!0)]),_:2},1024)]),default:t(()=>[h.value?(n(),o(R,{key:0,modelValue:s[e.name],"onUpdate:modelValue":k=>s[e.name]=k,type:"date",placeholder:"Pick a Date",format:"YYYY-MM-DD","value-format":"YYYY-MM-DD"},null,8,["modelValue","onUpdate:modelValue"])):(n(),o(g,{key:1},{default:t(()=>[c(p(s[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])),["datetime"].indexOf(e.type)>>>-1?I("",!0):(n(),o(x,{key:8,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[l(i,{size:2},{default:t(()=>[l(g,{tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(n(),o(r,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(a,null,{default:t(()=>[l(O)]),_:1})]),_:1},8,["content"])):I("",!0)]),_:2},1024)]),default:t(()=>[h.value?(n(),o(R,{key:0,modelValue:s[e.name],"onUpdate:modelValue":k=>s[e.name]=k,type:"datetime",placeholder:"Pick a Date",format:"YYYY/MM/DD hh:mm:ss","value-format":"YYYY-MM-DD hh:mm:ss"},null,8,["modelValue","onUpdate:modelValue"])):(n(),o(g,{key:1},{default:t(()=>[c(p(s[e.name]),1)]),_:2},1024))]),_:2},1032,["label","prop","required"])),["enum"].indexOf(e.type)>>>-1?I("",!0):(n(),o(x,{key:9,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[l(i,{size:2},{default:t(()=>[l(g,{tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(n(),o(r,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(a,null,{default:t(()=>[l(O)]),_:1})]),_:1},8,["content"])):I("",!0)]),_:2},1024)]),default:t(()=>[h.value?(n(),o(Ve,{key:0,clearable:"",filterable:"",modelValue:s[e.name],"onUpdate:modelValue":k=>s[e.name]=k,placeholder:"请选择",style:{width:"240px"}},{default:t(()=>[(n(!0),y(j,null,M(be.value[e.validation_rule],k=>(n(),o(U,{key:k.value,label:k.label,value:k.value},null,8,["label","value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"])):(n(),o(g,{key:1},{default:t(()=>{var k;return[c(p((k=v.value.fields[e.name])==null?void 0:k.label),1)]}),_:2},1024))]),_:2},1032,["label","prop","required"])),["model_ref"].indexOf(e.type)>>>-1?I("",!0):(n(),o(x,{key:10,label:e.verbose_name,prop:e.name,required:e.required},{label:t(()=>[l(i,{size:2},{default:t(()=>[l(g,{tag:"b"},{default:t(()=>[c(p(e.verbose_name),1)]),_:2},1024),e.description.length!=0?(n(),o(r,{key:0,content:e.description,placement:"right",effect:"dark"},{default:t(()=>[l(a,null,{default:t(()=>[l(O)]),_:1})]),_:1},8,["content"])):I("",!0)]),_:2},1024)]),default:t(()=>{var k;return[h.value?(n(),o(xe,{key:0,modelValue:s[e.name],"onUpdate:modelValue":ee=>s[e.name]=ee,clearable:"",placeholder:"请选择",style:{width:"240px"},filterable:"",options:_e.value[(k=we.value[e.name])==null?void 0:k.ref_model]},null,8,["modelValue","onUpdate:modelValue","options"])):(n(),o(g,{key:1},{default:t(()=>{var ee;return[c(p((ee=v.value.fields[e.name])==null?void 0:ee.instance_name),1)]}),_:2},1024))]}),_:2},1032,["label","prop","required"]))]),_:2},1024))),128))]),_:2},1024)]),_:2},1032,["name"]))),128))]),_:1},8,["modelValue"])]),_:1},8,["model"])]),_:1}),l(se,{label:"关联关系",name:"relations"},{default:t(()=>[v.value&&v.value.id?(n(),o(dt,{key:0,ref:"ciDataRelationRef",instanceId:v.value.id,modelId:v.value.model},null,8,["instanceId","modelId"])):I("",!0)]),_:1}),l(se,{label:"变更记录",name:"changelog"},{default:t(()=>[v.value&&v.value.id?(n(),o(Qe,{key:0,ref_key:"ciDataAuditRef",ref:f,instanceId:v.value.id},null,8,["instanceId"])):I("",!0)]),_:1})]),_:1},8,["modelValue"])])])}}}),wt=Ae(gt,[["__scopeId","data-v-2ad443ee"]]);export{wt as default};
