import{d as $e,b as Se,c as X,bI as j,r as f,M as q,aN as Te,u as Ue,a as Oe,aL as Ee,aH as Ae,aD as Me,e as d,b3 as Ie,o as n,f as b,h as y,g as a,w as s,bO as K,O as g,j as S,bo as x,F as h,b1 as D,t as H,bZ as Ne,bQ as ee,b_ as le,P as G,c0 as Re,k as ze,c1 as k,bV as J,_ as Be}from"./index-IeLxcNDT.js";const je={class:"card"},qe={class:"card-header"},Ke={style:{display:"flex","justify-content":"space-between"}},He={class:"dialog-footer"},Ge={class:"dialog-footer"},Je=$e({__name:"logAnalysisView",setup(Pe){const{proxy:i}=ze(),I=Se(),te={name:"",group:"",describe:"",status:!0,stepList:[{step:""}],steps:[]},o=X({name:"",group:"",describe:"",status:!0,stepList:[{step:""}],steps:[]}),N=()=>{Object.keys(o).forEach(e=>{o[e]=te[e]});let l=[];L.value.forEach(e=>{e.disabled=!1,l.push(e)}),L.value=l},ae=l=>{o.stepList.splice(l,1)},se=()=>{o.stepList.push({step:""})};j(()=>o.stepList,l=>{if(l.length==0)return 111;o.steps=[];let e=[],u=[];l.forEach(p=>{o.steps.indexOf(p.step)===-1&&p.step!=""&&o.steps.push(p.step),p.step!=""&&u.push(p.step)}),L.value.forEach(p=>{u.includes(p.value)?p.disabled=!0:p.disabled=!1,e.push(p)}),L.value=e},{deep:!0});const C=f([]),P=f([]),F=f([]),$=async()=>{let l=await i.$api.getLogFlow();console.log(l.data),C.value=l.data.data,F.value=l.data.data,console.log(F.value),l.data.data.forEach(e=>{P.value.push({label:e.name,value:e.id,disabled:!e.status})})},oe=q(()=>{let l=[];return C.value.forEach(e=>{l.includes({value:e.group,label:e.group})||l.push({value:e.group,label:e.group})}),l}),ue=q(()=>{let l=["所有"];return C.value.forEach(e=>{l.includes(e.group)||l.push(e.group)}),l}),R=f("所有");j(()=>R.value,l=>{l==="所有"?(console.log(l),F.value=C.value):F.value=C.value.filter(e=>e.group===l)});const L=f([]),Q=f({}),ne=async()=>{var e;(e=(await i.$api.getLogModule()).data.results)==null||e.forEach(u=>{u.status&&(L.value.push({label:u.module_name,value:u.id}),Q.value[u.id]=u)})},V=f(!1),T=f(!0),re=()=>{V.value=!0,T.value=!0},de=async()=>{i.$refs.formRef.validate(async l=>{if(l){let e=await i.$api.addLogFlow(o);e.status=="201"?(k({type:"success",message:"添加成功"}),i.$refs.formRef.resetFields(),V.value=!1,$()):k({showClose:!0,message:"添加失败:"+JSON.stringify(e.data),type:"error"})}else return})},U=f(""),ie=l=>{console.log(l),V.value=!0,T.value=!1,U.value=l.id;let e=[];l.steps.forEach(u=>{e.push({step:u})}),i.$nextTick(()=>{Object.assign(o,l)}),o.stepList=e,console.log(o)},pe=()=>{i.$refs.formRef.validate(async l=>{if(l){console.log(U.value);let e=await i.$api.updateLogFlow({id:U.value,...o});console.log(e),e.status==200?(k({type:"success",message:"更新成功"}),N(),V.value=!1,$()):k({type:"error",message:"更新失败"}),$()}})},W=l=>{J.confirm("是否确认删除?","Warning",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await i.$api.delLogFlow(l.id)).status==204?(k({type:"success",message:"删除成功"}),N(),V.value=!1,$()):k({type:"error",message:"删除失败"})}).catch(()=>{k({type:"info",message:"Delete canceled"})})};Te(async()=>{await ne(),await $(),await ve()});const ce=l=>{J.confirm("是否关闭?").then(()=>{N(),l()}).catch(()=>{})};let me=Ue();const fe=q(()=>me.state.username),_=f(!1),z=f([]),r=X({dataSourceId:"",dataSourceName:"",matchKey:"",dateValue:[],username:fe,flowName:""}),ge=[{text:"Last 1 hours",value:[new Date(new Date().getTime()-1*60*60*1e3),new Date]},{text:"Last 2 hours",value:[new Date(new Date().getTime()-2*60*60*1e3),new Date]},{text:"Last 6 hours",value:[new Date(new Date().getTime()-6*60*60*1e3),new Date]},{text:"Last 12 hours",value:[new Date(new Date().getTime()-12*60*60*1e3),new Date]},{text:"Last 24 hours",value:[new Date(new Date().getTime()-24*60*60*1e3),new Date]},{text:"Today",value:[new Date(new Date().setHours(0,0,0,0)),new Date(new Date().setHours(23,59,59,999))]},{text:"Yesterday",value:()=>[new Date(new Date().getTime()-36e5),new Date]},{text:"A week ago",value:()=>{const l=new Date;return l.setDate(l.getDate()-7),[l.setDate(l.getDate()-7),new Date]}}],ve=async()=>{var e;let l=await i.$api.dataSourceGet();console.log(l),(e=l==null?void 0:l.data)==null||e.results.forEach(u=>{u.source_type=="loki"&&(u.isUsed?z.value.push({label:u.source_name,value:u.id,disabled:!1}):z.value.push({label:u.source_name,value:u.id,disabled:!0}),u.isDefault&&(r.dataSourceId=u.id,r.dataSourceName=u.source_name))})},be=l=>{console.log("in before search close"),J.confirm("是否关闭?").then(()=>{i.$refs.searchFormRef.resetFields(),l()}).catch(()=>{})},we=l=>{_.value=!0,r.flowId=l.id,console.log(l),r.flowName=l.name,r.missionId=i.$commonFunc.getUuid()},_e=Oe(),ye=async()=>{i.$refs.searchFormRef.validate(l=>{l&&(i.$refs.searchFormRef.resetFields(),_.value=!1,setTimeout(()=>{_e.push({path:"/log/logFlowMission/"+r.uuid,query:r})}))})};return Ee(()=>{console.log("onDeactivated!"),_.value=!1}),Ae(()=>{console.log("onActivated",_.value),Me(()=>{console.log("onActivated nextTick",_.value)})}),j(()=>_.value,l=>{console.log(1111,l)}),(l,e)=>{const u=d("el-segmented"),p=d("el-col"),w=d("el-button"),he=d("el-row"),Ve=d("el-divider"),xe=d("el-scrollbar"),De=d("el-card"),ke=d("el-space"),O=d("el-input"),v=d("el-form-item"),E=d("el-option"),A=d("el-select"),Le=d("el-switch"),Y=d("el-form"),Z=d("el-dialog"),Ce=d("el-date-picker"),B=Ie("permission");return n(),b(h,null,[y("div",je,[a(he,{class:"row-bg",justify:"space-between"},{default:s(()=>[a(p,{span:23},{default:s(()=>[e[13]||(e[13]=y("span",{style:{display:"flex","align-items":"center","margin-right":"10px"}},"分组",-1)),a(u,{modelValue:R.value,"onUpdate:modelValue":e[0]||(e[0]=t=>R.value=t),options:ue.value,size:"large"},null,8,["modelValue","options"])]),_:1}),a(p,{span:1},{default:s(()=>{var t;return[K((n(),g(w,{type:"primary",onClick:re},{default:s(()=>e[14]||(e[14]=[S("添加")])),_:1})),[[B,`${(t=x(I).name)==null?void 0:t.replace("_info","")}:add`]])]}),_:1})]),_:1}),a(Ve),a(ke,{wrap:""},{default:s(()=>[(n(!0),b(h,null,D(F.value,(t,m)=>(n(),g(De,{key:m,class:"box-card",style:{width:"300px",height:"250px"},shadow:"hover",onClick:c=>we(t)},{header:s(()=>{var c,M;return[y("div",qe,[y("span",null,H(t.group)+": "+H(t.name),1),y("div",Ke,[K(a(w,{type:"primary",size:"small",icon:x(Ne),circle:"",onClick:ee(Fe=>ie(t),["stop"])},null,8,["icon","onClick"]),[[B,`${(c=x(I).name)==null?void 0:c.replace("_info","")}:edit`]]),K(a(w,{type:"danger",size:"small",icon:x(le),circle:"",onClick:ee(Fe=>W(t),["stop"])},null,8,["icon","onClick"]),[[B,`${(M=x(I).name)==null?void 0:M.replace("_info","")}:delete`]])])])]}),default:s(()=>[a(xe,{height:"120px"},{default:s(()=>[(n(!0),b(h,null,D(t.steps,(c,M)=>(n(),b("div",{key:M,class:"text item"},[y("li",null,H(Q.value[c].module_name),1)]))),128))]),_:2},1024)]),_:2},1032,["onClick"]))),128))]),_:1})]),a(Z,{modelValue:V.value,"onUpdate:modelValue":e[6]||(e[6]=t=>V.value=t),title:"业务流程",width:"500","before-close":ce,draggable:"",overflow:""},{footer:s(()=>[y("div",He,[T.value==!1?(n(),g(w,{key:0,type:"danger",onClick:e[5]||(e[5]=t=>W({id:U.value}))},{default:s(()=>e[15]||(e[15]=[S("删除")])),_:1})):G("",!0),T.value==!1?(n(),g(w,{key:1,type:"primary",onClick:pe},{default:s(()=>e[16]||(e[16]=[S("更新")])),_:1})):(n(),g(w,{key:2,type:"primary",onClick:de},{default:s(()=>e[17]||(e[17]=[S("添加")])),_:1}))])]),default:s(()=>[a(Y,{"label-position":"right",model:o,"label-width":"auto",style:{"max-width":"400px"},ref:"formRef"},{default:s(()=>[a(v,{label:"流程名称",prop:"name",rules:[{required:!0,message:"请输入流程名称",trigger:"blur"}]},{default:s(()=>[a(O,{modelValue:o.name,"onUpdate:modelValue":e[1]||(e[1]=t=>o.name=t),style:{width:"220px"}},null,8,["modelValue"])]),_:1}),a(v,{label:"分组"},{default:s(()=>[a(A,{modelValue:o.group,"onUpdate:modelValue":e[2]||(e[2]=t=>o.group=t),filterable:"",clearable:"","allow-create":"",placeholder:"所属分组，支持新增",style:{width:"180px"}},{default:s(()=>[(n(!0),b(h,null,D(oe.value,t=>(n(),g(E,{key:t.value,label:t.label,value:t.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(v,{label:"是否启用"},{default:s(()=>[a(Le,{modelValue:o.status,"onUpdate:modelValue":e[3]||(e[3]=t=>o.status=t),class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"}},null,8,["modelValue"])]),_:1}),(n(!0),b(h,null,D(o.stepList,(t,m)=>(n(),b("div",{key:m},[a(v,{label:"环节"+(m+1),prop:"stepList."+m+".step",rules:[{required:!0,message:"请选择环节",trigger:"blur"}]},{default:s(()=>[a(A,{modelValue:t.step,"onUpdate:modelValue":c=>t.step=c,filterable:"",clearable:"",placeholder:"选择流程",style:{width:"180px"}},{default:s(()=>[(n(!0),b(h,null,D(L.value,c=>(n(),g(E,{key:c.value,label:c.label,value:c.value,disabled:c.disabled},null,8,["label","value","disabled"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"]),o.stepList.length>>1?(n(),g(w,{key:0,size:"small",icon:x(le),circle:"",style:{margin:"0 5px 0px 5px"},onClick:c=>ae(m)},null,8,["icon","onClick"])):G("",!0),m==o.stepList.length-1?(n(),g(w,{key:1,type:"primary",icon:x(Re),circle:"",size:"small",style:{margin:"0 5px 0px 5px"},onClick:se},null,8,["icon"])):G("",!0)]),_:2},1032,["label","prop"])]))),128)),a(v,{label:"描述",prop:"describe"},{default:s(()=>[a(O,{modelValue:o.describe,"onUpdate:modelValue":e[4]||(e[4]=t=>o.describe=t),type:"textarea"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"]),a(Z,{modelValue:_.value,"onUpdate:modelValue":e[12]||(e[12]=t=>_.value=t),title:"查询条件",width:"500",appendToBody:"","before-close":be,draggable:"",overflow:""},{footer:s(()=>[y("div",Ge,[a(w,{type:"primary",onClick:ye},{default:s(()=>e[18]||(e[18]=[S("检索")])),_:1})])]),default:s(()=>[a(Y,{"label-position":"right","label-width":"auto",model:r,style:{"max-width":"600px"},ref:"searchFormRef"},{default:s(()=>[a(v,{label:"数据源"},{default:s(()=>[a(A,{modelValue:r.dataSourceId,"onUpdate:modelValue":e[7]||(e[7]=t=>r.dataSourceId=t),placeholder:"Select",size:"large",style:{width:"180px"}},{default:s(()=>[(n(!0),b(h,null,D(z.value,(t,m)=>(n(),g(E,{key:m,label:t.label,value:t.value,disabled:t.disabled},null,8,["label","value","disabled"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(v,{label:"业务流ID",prop:"flowId",rules:[{required:!0,message:"请选择业务流ID",trigger:"blur"}]},{default:s(()=>[a(A,{modelValue:r.flowId,"onUpdate:modelValue":e[8]||(e[8]=t=>r.flowId=t),placeholder:"Select",size:"large",style:{width:"180px"}},{default:s(()=>[(n(!0),b(h,null,D(P.value,(t,m)=>(n(),g(E,{key:m,label:t.label,value:t.value,disabled:t.disabled},null,8,["label","value","disabled"]))),128))]),_:1},8,["modelValue"])]),_:1}),a(v,{label:"关键字",prop:"matchKey",rules:[{required:!0,message:"需要提供关键字!!!",trigger:"blur"}]},{default:s(()=>[a(O,{modelValue:r.matchKey,"onUpdate:modelValue":e[9]||(e[9]=t=>r.matchKey=t),autosize:"",type:"textarea",placeholder:"请输入关键字"},null,8,["modelValue"])]),_:1}),a(v,{label:"时间范围",prop:"dateValue",rules:[{required:!0,message:"选择时间范围",trigger:"blur"}]},{default:s(()=>[a(Ce,{modelValue:r.dateValue,"onUpdate:modelValue":e[10]||(e[10]=t=>r.dateValue=t),type:"datetimerange",shortcuts:ge,"range-separator":"To","start-placeholder":"Start date","end-placeholder":"End date","value-format":"x"},null,8,["modelValue"])]),_:1}),a(v,{label:"分析ID",prop:"uuid"},{default:s(()=>[a(O,{modelValue:r.missionId,"onUpdate:modelValue":e[11]||(e[11]=t=>r.missionId=t),disabled:""},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])],64)}}}),We=Be(Je,[["__scopeId","data-v-ab3861a3"]]);export{We as default};
