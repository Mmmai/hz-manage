import{d as ce,g as pe,u as me,r as s,h as ve,A as _e,a as fe,z as L,q as ye,aq as be,e as r,ak as F,c as H,o as c,i as T,ab as _,b as l,w as n,D as f,k as p,v as y,a7 as ge,a8 as xe,j as we,t as A,ae as ke,ap as m,s as I}from"./index-Cz_bWT0-.js";const $e={class:"card"},he={class:"table-header"},Ce={class:"header-button-lf"},Se={class:"header-button-ri"},Oe=ce({name:"ciSyncZabbix",__name:"nodeManageView",setup(ze){const{proxy:b}=pe();me();const B=s([]),g=ve(),$=s("model_instance_name"),h=s(""),C=s(!0),K=s([{value:"model_instance_name",label:"唯一标识",sort:!0,filter:!0,type:"string",required:!0},{value:"ip_address",label:"主机ip",sort:!1,filter:!0,type:"string",required:!0}]),R=_e(()=>{let t=[];return K.value.forEach(e=>{e.filter&&t.push({name:e.label,value:e.value})}),t});s("");const D=fe({name:null,verbose_name:null,field_type:"string",type:"regex",rule:null,description:null}),S=t=>t===1?"success":t===0?"danger":"info",z=t=>t===1?"正常":t===0?"异常":"未知";L(()=>D.field_type,t=>{D.type=Q.value[t][0].type},{deep:!0});const V=s(1),j=s(10),J=s("default"),X=s(!1),M=s(0),q=()=>{u()},k=s({ordering:"-model_instance_name"}),G=t=>{t.order==="ascending"?k.value.ordering=t.prop:t.order==="descending"?k.value.ordering="-"+t.prop:k.value={ordering:"-model_instance_name"},u()};s(!1),s(!0),s({}),s({}),s([]);const Q=s([]),u=async(t=null)=>{let e=await b.$api.getNodes({page:V.value,page_size:j.value,...v.value,...k.value,...t});B.value=e.data.results,M.value=e.data.count,C.value=!1},W=async(t,e)=>{let i={};i[e]=t[e],(await b.$api.updateNodes({id:t.id,...i})).status==200?(m({type:"success",message:"更新成功"}),u()):m({type:"error",message:"更新失败"})};ye(()=>{u()});const O=s([]),Y=t=>{O.value=t.map(e=>e.id)},v=s({});L(h,t=>{v.value={[$.value]:t}});const ee=t=>{console.log(t),Object.keys(t)[0]==="status"?Object.values(t)[0].length>1?v.value[`${Object.keys(t)[0]}`]=null:v.value[Object.keys(t)[0]]=Object.values(t)[0][0]:(console.log(t),Object.values(t)[0].length>0?v.value[`${Object.keys(t)[0]}__in`]=Object.values(t)[0].join(","):v.value[Object.keys(t)[0]]=null),I(()=>{u()})},te=async()=>{(await b.$api.updateZabbixAvailability()).status==200&&m({type:"success",message:"触发成功"})},ae=async()=>{await b.$api.syncZabbixHost(),m({type:"success",message:"触发主机同步~"})},U=s(null),le=t=>{U.value=new EventSource(t),U.value.onmessage=e=>{console.log(e),JSON.parse(e.data).status==="completed"&&(E(),I(()=>{u()}))}},E=()=>{var t;(t=U.value)==null||t.close()},N=async t=>{let e=await b.$api.installAgent(t);e.status==200?e.data.cache_key?(m({type:"success",message:"触发成功"}),C.value=!0,le(`/api/v1/agent_status_sse/?cache_key=${e.data.cache_key}`)):m({type:"error",message:`触发失败:${e.data.message}`}):m({type:"error",message:"触发失败"})};return be(()=>{E()}),(t,e)=>{var P;const i=r("el-button"),x=r("el-tooltip"),se=r("el-option"),ne=r("el-select"),oe=r("el-input"),o=r("el-table-column"),Z=r("el-tag"),re=r("el-switch"),ue=r("el-table"),ie=r("el-pagination"),w=F("permission"),de=F("loading");return c(),H("div",$e,[T("div",he,[T("div",Ce,[l(x,{class:"box-item",effect:"dark",content:"触发主机信息同步到zabbix",placement:"top"},{default:n(()=>{var a;return[_((c(),f(i,{type:"primary",onClick:e[0]||(e[0]=d=>ae())},{default:n(()=>e[12]||(e[12]=[p("触发同步")])),_:1})),[[w,`${(a=y(g).name)==null?void 0:a.replace("_info","")}:add`]])]}),_:1}),l(x,{class:"box-item",effect:"dark",content:"更新Zabbix接口可用性的状态信息",placement:"top"},{default:n(()=>{var a;return[_((c(),f(i,{type:"primary",onClick:e[1]||(e[1]=d=>te())},{default:n(()=>e[13]||(e[13]=[p("可用性更新")])),_:1})),[[w,`${(a=y(g).name)==null?void 0:a.replace("_info","")}:add`]])]}),_:1}),l(x,{class:"box-item",effect:"dark",content:"触发重装已勾选的主机",placement:"top"},{default:n(()=>{var a;return[_((c(),f(i,{type:"primary",disabled:!(O.value.length>>>0),onClick:e[2]||(e[2]=d=>N({ids:O.value}))},{default:n(()=>e[14]||(e[14]=[p("批量安装")])),_:1},8,["disabled"])),[[w,`${(a=y(g).name)==null?void 0:a.replace("_info","")}:add`]])]}),_:1}),_((c(),f(i,{type:"primary",onClick:e[3]||(e[3]=a=>N({all:!0}))},{default:n(()=>e[15]||(e[15]=[p("触发失败重装")])),_:1})),[[w,`${(P=y(g).name)==null?void 0:P.replace("_info","")}:add`]])]),T("div",Se,[l(ne,{modelValue:$.value,"onUpdate:modelValue":e[4]||(e[4]=a=>$.value=a),placeholder:"Select",style:{width:"120px"}},{default:n(()=>[(c(!0),H(ge,null,xe(R.value,a=>(c(),f(se,{key:a.value,label:a.name,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),l(oe,{modelValue:h.value,"onUpdate:modelValue":e[5]||(e[5]=a=>h.value=a),style:{width:"240px"},placeholder:"回车查询",clearable:"",onClear:e[6]||(e[6]=a=>u()),onKeyup:e[7]||(e[7]=we(a=>u(),["enter","native"]))},null,8,["modelValue"])])]),_((c(),f(ue,{ref:"multipleTableRef",data:B.value,style:{width:"100%"},border:"","row-key":a=>a.id,onSortChange:G,onSelectionChange:Y,onFilterChange:ee},{default:n(()=>[l(o,{type:"selection","reserve-selection":!0,width:"55"}),l(o,{property:"model_instance_name",label:"唯一标识",sortable:"custom"}),l(o,{property:"ip_address",sortable:"custom",label:"ip地址"}),l(o,{property:"proxy_name",label:"代理",sortable:"custom",width:"140"}),l(o,{"column-key":"manage_status",property:"manage_status",label:"管理状态",sortable:"custom",width:"140",filters:[{text:"正常",value:1},{text:"异常",value:0},{text:"未知",value:2}]},{default:n(a=>[l(Z,{type:S(a.row.manage_status),effect:"dark"},{default:n(()=>[p(A(z(a.row.manage_status)),1)]),_:2},1032,["type"])]),_:1}),l(o,{"column-key":"enable_sync",property:"enable_sync",label:"是否同步",sortable:"custom",width:"140",filters:[{text:"启用",value:!0},{text:"禁用",value:!1}]},{default:n(a=>[l(re,{modelValue:a.row.enable_sync,"onUpdate:modelValue":d=>a.row.enable_sync=d,class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},onChange:d=>W(a.row,"enable_sync")},null,8,["modelValue","onUpdate:modelValue","onChange"])]),_:1}),l(o,{"column-key":"agent_status",property:"agent_status",label:"agent状态",sortable:"custom",width:"140",filters:[{text:"正常",value:1},{text:"异常",value:0},{text:"未知",value:2}]},{default:n(a=>[l(Z,{type:S(a.row.agent_status),effect:"dark"},{default:n(()=>[p(A(z(a.row.agent_status)),1)]),_:2},1032,["type"])]),_:1}),l(o,{"column-key":"zbx_status",property:"zbx_status",label:"ZBX状态",sortable:"custom",width:"140",filters:[{text:"正常",value:1},{text:"异常",value:0},{text:"未知",value:2}]},{default:n(a=>[l(Z,{type:S(a.row.zbx_status),effect:"dark"},{default:n(()=>[p(A(z(a.row.zbx_status)),1)]),_:2},1032,["type"])]),_:1}),l(o,{property:"installation_error",label:"报错信息",width:"400"}),l(o,{fixed:"right",width:"80",label:"操作"},{default:n(a=>[l(x,{class:"box-item",effect:"dark",content:"触发安装",placement:"top"},{default:n(()=>{var d;return[_(l(i,{link:"",type:"primary",icon:y(ke),onClick:Ve=>N({ids:[a.row.id]})},null,8,["icon","onClick"]),[[w,`${(d=y(g).name)==null?void 0:d.replace("_info","")}:edit`]])]}),_:2},1024)]),_:1})]),_:1},8,["data","row-key"])),[[de,C.value]]),l(ie,{"current-page":V.value,"onUpdate:currentPage":[e[8]||(e[8]=a=>V.value=a),e[10]||(e[10]=a=>q())],"page-size":j.value,"onUpdate:pageSize":[e[9]||(e[9]=a=>j.value=a),e[11]||(e[11]=a=>q())],"page-sizes":[10,20,50,100,200],size:J.value,disabled:X.value,layout:"total, sizes, prev, pager, next, jumper",total:M.value,style:{"margin-top":"5px","justify-content":"flex-end"}},null,8,["current-page","page-size","size","disabled","total"])])}}});export{Oe as default};
