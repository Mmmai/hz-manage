import{d as ue,h as ce,r as s,g as pe,a as K,m as me,l as fe,bK as _e,e as i,b7 as L,c as P,o as y,i as m,b as o,bQ as x,y as f,q as F,w as n,k as R,F as D,p as ge,c6 as ve,c7 as ye,cn as be,aL as he,t as we,bY as M,c3 as d,aK as O,_ as Ce}from"./index-BuQNgUX_.js";const ke={class:"card"},xe={class:"user-header"},Ve={style:{border:"1px solid var(--el-border-color)",width:"90%"}},$e=ue({__name:"roleView",setup(Fe){const V=ce(),A=s({}),{proxy:r}=pe(),I=({tree_type:l},e)=>l==="menu"?"is-menu":l==="button"?"is-button":"";K({search:""});const U=s(!1),_=s([]),j=s("auto"),q=s([{prop:"role",label:"角色名"},{prop:"role_name",label:"角色名称"},{prop:"user_count",label:"用户数量"}]);s(0);const J=s({});me(async()=>{await b(),oe()});const b=async()=>{let l=await r.$api.getRole();_.value=l.data.results.map(e=>(e.userinfo_set=e.userinfo_set.length,e));for(let e in _.value){let c=_.value[e].role,v=_.value[e].id;J.value[v]=c}},z=l=>{A.value=l},u=s(!1),a=K({role:"",role_name:"",rolePermission:[]}),h=s("add"),Q=()=>{h.value="add",u.value=!0},W=()=>{u.value=!1,r.$refs.userFrom.resetFields(),g([])},Y=l=>{M.confirm("是否确认关闭?").then(()=>{r.$refs.userFrom.resetFields(),g([]),l()}).catch(()=>{})},G=fe(()=>{let l=new Array;return p.value.getCheckedNodes().forEach(e=>{e.tree_type==="button"&&l.push(e.id)}),l}),H=()=>{a.rolePermission=G.value,console.log(JSON.stringify(a)),r.$refs.userFrom.validate(async l=>{if(l)if(h.value=="add"){let e=await r.$api.roleadd(a);e.status==201?(u.value=!1,d({type:"success",message:"添加成功"}),r.$refs.userFrom.resetFields(),g([]),b(),console.log(p.value.getCheckedKeys())):d({showClose:!0,message:"添加失败:"+JSON.stringify(e.data),type:"error"})}else{let e=await r.$api.roleupdate({id:S.value.id,...a});console.log(e),e.status==200?(u.value=!1,r.$refs.userFrom.resetFields(),g([]),console.log(p.value.getCheckedKeys()),b(),d({type:"success",message:"更新成功"})):d({showClose:!0,message:"更新失败:"+JSON.stringify(e.data),type:"error"})}else d({showClose:!0,message:"请输入正确内容.",type:"error"})})},S=s({}),X=l=>{console.log(l),h.value="edit",S.value=l,u.value=!0,O(()=>{Object.keys(a).forEach(e=>{a[e]=l[e]})}),g(l.rolePermission)},Z=l=>{M.confirm("是否确认删除?","Warning",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await r.$api.roledel(l.id)).status==204?(d({type:"success",message:"删除成功"}),await b(pageConfig)):d({type:"error",message:"删除失败"})}).catch(()=>{d({type:"info",message:"取消删除"})})},ee=s([]),le=(l,e)=>l.role!="sysadmin",te=l=>{ee.value=l},p=s(),N=s([]),oe=async()=>{let l=await r.$api.getPermissionToRole();console.log(l),N.value=l.data.results},g=l=>{O().then(()=>{p.value.setCheckedKeys(l,!1),console.log(p.value.getCheckedKeys())})},w=s(!1);return _e(()=>a.role,l=>{l=="sysadmin"?w.value=!0:w.value=!1}),(l,e)=>{var B;const c=i("el-button"),v=i("el-table-column"),ae=i("el-table"),T=i("el-input"),C=i("el-form-item"),se=i("el-row"),ne=i("el-form"),re=i("el-dialog"),$=L("permission"),ie=L("loading");return y(),P(D,null,[m("div",ke,[m("div",xe,[m("div",null,[x((y(),F(c,{type:"primary",size:"small",onClick:Q},{default:n(()=>[...e[4]||(e[4]=[R("新增",-1)])]),_:1})),[[$,`${(B=f(V).name)==null?void 0:B.replace("_info","")}:add`]])])]),m("div",null,[x((y(),F(ae,{border:"",data:_.value,style:{width:"100%"},"max-height":"500px","highlight-current-row":"","table-layout":j.value,onSelectionChange:te,onRowClick:z},{default:n(()=>[o(v,{type:"selection",width:"55",selectable:le}),(y(!0),P(D,null,ge(q.value,t=>(y(),F(v,{key:t.prop,label:t.label,prop:t.prop},null,8,["label","prop"]))),128)),o(v,{fixed:"right",label:"操作",width:"150"},{default:n(t=>{var k,E;return[x(o(c,{link:"",type:"primary",icon:f(ve),onClick:de=>X(t.row)},null,8,["icon","onClick"]),[[$,`${(k=f(V).name)==null?void 0:k.replace("_info","")}:edit`]]),x(o(c,{disabled:t.row.role=="sysadmin",link:"",type:"danger",icon:f(ye),onClick:de=>Z(t.row)},null,8,["disabled","icon","onClick"]),[[$,`${(E=f(V).name)==null?void 0:E.replace("_info","")}:delete`]])]}),_:1})]),_:1},8,["data","table-layout"])),[[ie,U.value]])])]),o(re,{modelValue:u.value,"onUpdate:modelValue":e[3]||(e[3]=t=>u.value=t),title:h.value=="add"?"新增角色":"编辑角色",width:"50%","before-close":Y},{default:n(()=>[o(ne,{model:a,class:"demo-form-inline","label-position":"right","label-width":"80px",ref:"userFrom","status-icon":""},{default:n(()=>[o(C,{label:"角色",prop:"role",rules:[{required:!0}]},{default:n(()=>[o(T,{modelValue:a.role,"onUpdate:modelValue":e[0]||(e[0]=t=>a.role=t),placeholder:"请输入英文",clearable:"",style:{width:"30%"},disabled:w.value},null,8,["modelValue","disabled"])]),_:1}),o(C,{label:"角色名称",prop:"role_name",rules:[{required:!0}]},{default:n(()=>[o(T,{modelValue:a.role_name,"onUpdate:modelValue":e[1]||(e[1]=t=>a.role_name=t),placeholder:"中文名称",style:{width:"30%"},clearable:"",disabled:w.value},null,8,["modelValue","disabled"])]),_:1}),o(C,{label:"菜单授权",prop:"rolePermission"},{default:n(()=>[m("div",Ve,[o(f(be),{ref_key:"menuTreeRef",ref:p,modelValue:a.rolePermission,"onUpdate:modelValue":e[2]||(e[2]=t=>a.rolePermission=t),data:N.value,"show-checkbox":"","node-key":"id","default-expand-all":"","expand-on-click-node":!1,props:{class:I}},{default:n(({node:t,data:k})=>[m("span",{class:he({buttonList:k.tree_type==="button"})},we(t.label),3)]),_:1},8,["modelValue","data","props"])])]),_:1}),o(se,{style:{"justify-content":"space-around"}},{default:n(()=>[o(C,null,{default:n(()=>[o(c,{onClick:W},{default:n(()=>[...e[5]||(e[5]=[R("取消",-1)])]),_:1}),o(c,{type:"primary",onClick:H},{default:n(()=>[...e[6]||(e[6]=[R(" 确定",-1)])]),_:1})]),_:1})]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue","title"])],64)}}}),Se=Ce($e,[["__scopeId","data-v-23033295"]]);export{Se as default};
