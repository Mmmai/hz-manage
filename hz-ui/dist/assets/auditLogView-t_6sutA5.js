import{d as re,g as ie,u as ue,v as q,r as c,z as ce,h as v,c as b,o as m,b as s,f as o,F as j,i as A,w as i,q as h,t as T,B as z,m as L,ca as de,l as pe,k as U,cb as me,_ as ve}from"./index-Ch0lsCs7.js";import{Q as _e}from"./vue3-json-viewer-DNOlocEX.js";import{d as ge}from"./gmCrypto-BRJy4PEP.js";const fe={class:"divVertical"},we={class:"card filter-card"},ye={class:"filter-container"},be={class:"filter-row"},he={class:"filter-item"},Te={class:"filter-row filter-row-flex"},Ve={class:"filter-item"},De={class:"filter-item"},ke={class:"filter-item"},Ee={class:"filter-item"},Ce={class:"card table-main",style:{width:"100%"}},Se=["onClick"],xe={class:"change-content"},Oe={key:0,class:"changeValue"},$e={key:3,class:"changeValue"},Me={class:"drawer-content"},Pe=re({__name:"auditLogView",setup(je){const{proxy:N}=ie(),R=ue(),B=q(()=>R.gmCry);c([{value:"host",label:"主机"},{value:"switch",label:"交换机"}]);const Q=c([{value:"CREATE",label:"创建"},{value:"DELETE",label:"删除"},{value:"UPDATE",label:"修改"}]),g=c([]),f=c([]),d=c([]),G=[{text:"最近1天",value:()=>{const t=new Date,e=new Date;return e.setTime(t.getTime()-3600*1e3*24*1),[e,t]}},{text:"最近3天",value:()=>{const t=new Date,e=new Date;return e.setTime(t.getTime()-3600*1e3*24*3),[e,t]}},{text:"最近5天",value:()=>{const t=new Date,e=new Date;return e.setTime(t.getTime()-3600*1e3*24*5),[e,t]}},{text:"最近7天",value:()=>{const t=new Date,e=new Date;return e.setTime(t.getTime()-3600*1e3*24*7),[e,t]}},{text:"最近1周",value:()=>{const t=new Date,e=new Date;return e.setTime(t.getTime()-3600*1e3*24*7),[e,t]}},{text:"最近1个月",value:()=>{const t=new Date,e=new Date;return e.setTime(t.getTime()-3600*1e3*24*30),[e,t]}},{text:"最近3个月",value:()=>{const t=new Date,e=new Date;return e.setTime(t.getTime()-3600*1e3*24*90),[e,t]}}],H=()=>{const t=new Date,e=new Date;e.setHours(23,59,59,999),t.setTime(e.getTime()-3600*1e3*24*30),t.setHours(0,0,0,0);const a=l=>{const y=l.getFullYear(),V=String(l.getMonth()+1).padStart(2,"0"),D=String(l.getDate()).padStart(2,"0"),u=String(l.getHours()).padStart(2,"0"),_=String(l.getMinutes()).padStart(2,"0"),k=String(l.getSeconds()).padStart(2,"0"),p=String(l.getMilliseconds()).padStart(3,"0");return`${y}-${V}-${D}T${u}:${_}:${k}.${p}`};d.value=[a(t),a(e)]},E=c(""),W=t=>{const e=g.value.indexOf(t);e===-1?g.value.push(t):g.value.splice(e,1),w()},X=t=>{const e=f.value.indexOf(t);e===-1?f.value.push(t):f.value.splice(e,1),w()},Z=t=>{d.value=t,console.log("时间范围:",t),w()},Y=()=>{w()},F=c([]),x=c(1),O=c(10),I=c(0),J=()=>{w()},$=c(!1),M=c({});q(()=>JSON.stringify(M.value,null,2));const ee=t=>{M.value=t,$.value=!0},K={model:"模型",model_field:"字段",model_instance:"实例",model_group:"模型组",unique_constraint:"唯一约束",model_field_group:"模型字段组",validation_rule:"校验规则",model_instance_group:"实例组",relation_definition:"关系定义",relation:"关系关联"},C={groups:"实例组",path:"路径",label:"标签",level:"层级",parent:"父级",built_in:"内置",instance_name:"实例名称",order:"排序",verbose_name:"字段名称",model_field_group:"字段分组",instance_name_template:"实例名称模板",fields:"字段组合",using_template:"自动命名",model:"模型",input_mode:"录入方式",relation_attributes:"关系属性",source_attributes:"源属性",target_attributes:"目标属性",relation:"关联关系",attribute_schema:"关系属性",description:"描述",source_instance:"源实例",target_instance:"目标实例",source_model:"源模型",target_model:"目标模型",name:"名称",forward_verb:"正向名称",reverse_verb:"反向名称",topology_type:"拓扑类型"},te=t=>K[t]||t,ae={CREATE:"创建",UPDATE:"修改",DELETE:"删除"},ne=t=>ae[t]||t,le=t=>({CREATE:"success",UPDATE:"warning",DELETE:"danger"})[t]||"",oe=t=>{const e=[];return t.changed_fields&&Object.keys(t.changed_fields).forEach(a=>{var y,V,D,u,_,k;const l=t.changed_fields[a];a!=="update_user"&&(a==="groups"?e.push({field:C[a],oldValue:(y=l[0])==null?void 0:y.map(p=>p.path).join(`
`),newValue:(V=l[1])==null?void 0:V.map(p=>p.path).join(`
`)}):a==="instance_name_template"?e.push({field:C[a],oldValue:((D=l[0])==null?void 0:D.length)>>0?(u=l[0])==null?void 0:u.map(p=>p.verbose_name).join("-"):null,newValue:((_=l[1])==null?void 0:_.length)>>0?(k=l[1])==null?void 0:k.map(p=>p.verbose_name).join("-"):null}):e.push({field:C.hasOwnProperty(a)?C[a]:a,oldValue:S(l[0]),newValue:S(l[1])}))}),t.details&&t.details.forEach(a=>{e.push({field:a.verbose_name||a.name,oldValue:S(a.old_value),newValue:S(a.new_value)})}),e},S=t=>{const e=a=>{if(typeof a=="object"&&a!==null)return a.hasOwnProperty("label")&&a.label!==void 0?a.label:a.hasOwnProperty("instance_name")&&a.instance_name!==void 0?a.instance_name:a.hasOwnProperty("verbose_name")&&a.verbose_name!==void 0?a.verbose_name:a.hasOwnProperty("password")&&a.password!==void 0?R.isShowPass?ge(B.value.key,B.value.mode,a.password):"******":JSON.stringify(a)};if(t===null)return t;if(typeof t=="object")return e(t);if(typeof t=="string")try{const a=JSON.parse(t);return e(a)}catch{return t}return t},w=async()=>{var t,e;try{const a={page:x.value,page_size:O.value,target_type:(t=g.value)!=null&&t.length?g.value.join(","):void 0,action:(e=f.value)!=null&&e.length?f.value.join(","):void 0,time_after:d.value&&d.value[0]?d.value[0]:void 0,time_before:d.value&&d.value[1]?d.value[1]:void 0,search:E.value||void 0},l=await N.$api.getAuditLog(a);F.value=l.data.results,I.value=l.data.count}catch(a){console.error("获取审计日志失败:",a),N.$message.error("获取审计日志失败")}},se=()=>{g.value=[],f.value=[],d.value=[],E.value="",H(),w()};return ce(()=>{H(),w()}),(t,e)=>{const a=v("el-tag"),l=v("el-date-picker"),y=v("el-button"),V=v("el-input"),D=v("el-tooltip"),u=v("el-table-column"),_=v("el-text"),k=v("el-table"),p=v("el-pagination");return m(),b("div",fe,[s("div",we,[s("div",ye,[s("div",be,[s("div",he,[e[7]||(e[7]=s("span",{class:"filter-label"},"操作对象：",-1)),(m(),b(j,null,A(K,(n,r,P)=>o(a,{key:P,type:g.value.includes(r)?"primary":"info",onClick:Ae=>W(r),class:"filter-tag"},{default:i(()=>[h(T(n),1)]),_:2},1032,["type","onClick"])),64))])]),s("div",Te,[s("div",Ve,[e[8]||(e[8]=s("span",{class:"filter-label"},"操作类型：",-1)),(m(!0),b(j,null,A(Q.value,n=>(m(),z(a,{key:n.value,type:f.value.includes(n.value)?"primary":"info",onClick:r=>X(n.value),class:"filter-tag"},{default:i(()=>[h(T(n.label),1)]),_:2},1032,["type","onClick"]))),128))]),s("div",De,[e[9]||(e[9]=s("span",{class:"filter-label"},"时间范围：",-1)),o(l,{modelValue:d.value,"onUpdate:modelValue":e[0]||(e[0]=n=>d.value=n),type:"datetimerange","range-separator":"至","start-placeholder":"开始时间","end-placeholder":"结束时间","value-format":"YYYY-MM-DDTHH:mm:ss",shortcuts:G,onChange:Z},null,8,["modelValue"])]),s("div",ke,[o(V,{modelValue:E.value,"onUpdate:modelValue":e[1]||(e[1]=n=>E.value=n),placeholder:"请输入搜索关键词",clearable:"",style:{width:"200px"},onKeyup:pe(Y,["enter"])},{append:i(()=>[o(y,{icon:L(de),onClick:Y},null,8,["icon"])]),_:1},8,["modelValue"])]),s("div",Ee,[o(y,{onClick:se},{default:i(()=>[...e[10]||(e[10]=[h("重置",-1)])]),_:1})])])])]),s("div",Ce,[o(k,{data:F.value,border:"","table-layout":"fixed",height:"100%","highlight-current-row":""},{default:i(()=>[o(u,{prop:"target_type",label:"操作对象",width:"120"},{default:i(n=>[o(D,{content:"查看详情",placement:"right",effect:"dark"},{default:i(()=>[s("span",{class:"target-type-link",onClick:r=>ee(n.row)},T(te(n.row.target_type)),9,Se)]),_:2},1024)]),_:1}),o(u,{label:"操作类型",width:"120"},{default:i(n=>[o(a,{type:le(n.row.action)},{default:i(()=>[h(T(ne(n.row.action)),1)]),_:2},1032,["type"])]),_:1}),o(u,{prop:"operator",label:"操作人",width:"120"}),o(u,{prop:"operator_ip",label:"操作人IP",width:"120"}),o(u,{prop:"comment",label:"操作描述","show-overflow-tooltip":""}),o(u,{label:"变更内容","show-overflow-tooltip":""},{default:i(n=>[s("div",xe,[n.row.action=="UPDATE"||n.row.action=="CREATE"?(m(!0),b(j,{key:0},A(oe(n.row),(r,P)=>(m(),b("div",{key:P,class:"change-item"},[o(_,{tag:"b"},{default:i(()=>[h(T(r.field)+": ",1)]),_:2},1024),r.oldValue!==void 0?(m(),b("span",Oe,T(r.oldValue!==null?r.oldValue:"null"),1)):(m(),z(_,{key:1},{default:i(()=>[...e[11]||(e[11]=[h("null",-1)])]),_:1})),r.oldValue!==void 0&&r.newValue!==void 0?(m(),z(_,{key:2,tag:"b",type:"warning"},{default:i(()=>[...e[12]||(e[12]=[h(" → ",-1)])]),_:1})):U("",!0),r.newValue!==void 0?(m(),b("span",$e,T(r.newValue!==null?r.newValue:"null"),1)):U("",!0)]))),128)):U("",!0)])]),_:1}),o(u,{prop:"timestamp",label:"操作时间",width:"300"})]),_:1},8,["data"]),o(p,{"current-page":x.value,"onUpdate:currentPage":[e[2]||(e[2]=n=>x.value=n),e[4]||(e[4]=n=>J())],"page-size":O.value,"onUpdate:pageSize":[e[3]||(e[3]=n=>O.value=n),e[5]||(e[5]=n=>J())],"page-sizes":[10,20,50,100,200],layout:"total, sizes, prev, pager, next, jumper",total:I.value,style:{"margin-top":"20px","justify-content":"flex-end",display:"flex"}},null,8,["current-page","page-size","total"])]),o(L(me),{modelValue:$.value,"onUpdate:modelValue":e[6]||(e[6]=n=>$.value=n),title:"详细信息",direction:"rtl",size:"50%"},{default:i(()=>[s("div",Me,[o(L(_e),{value:M.value,"expand-depth":10,copyable:"",boxed:"",sort:"",expanded:""},null,8,["value"])])]),_:1},8,["modelValue"])])}}}),Ne=ve(Pe,[["__scopeId","data-v-48d94bb2"]]);export{Ne as default};
