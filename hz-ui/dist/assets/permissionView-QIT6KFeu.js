import{d as ce,g as ue,bB as le,r as _,v as q,B as oe,o as K,b_ as G,aP as H,z as me,h as f,bc as ve,c as ee,b as r,f as t,w as n,bV as pe,q as L,t as z,m as B,ca as de,k as _e,cy as be,cz as re,_ as fe,j as he,x as ge,aV as ye,bP as ke,n as Ce,C as we,cA as Ne,p as Oe}from"./index-BSX4TNZE.js";import{T as je}from"./treeTransfer-CTQgiIQ0.js";import{m as Te}from"./model-Ds6Q2RXn.js";const Pe=ce({__name:"menuPermission",props:{nowNodeObject:{},nowNodeObjectModifiers:{},permissionObject:{},permissionObjectModifiers:{}},emits:["update:nowNodeObject","update:permissionObject"],setup(J,{expose:A}){const{proxy:d}=ue(),b=le(J,"nowNodeObject"),T=le(J,"permissionObject"),O=_([]),v=_([]),C=_([]),Q=q(()=>{const l=JSON.parse(JSON.stringify(O.value));if(!C.value||!T.value)return console.log("没有权限数据或没有选中的对象",T.value),l;const c=new Map;C.value.forEach(S=>{c.set(S.button_id,S)});const h=S=>S.map(X=>{const P={...X},U=c.get(P.id);return U&&U.source_type!==T.value&&(P.disabled=!0,P.disabledTooltip=`权限来源于${I(U.source_type)}:${U.source_name}，无法在此处修改`),P.children&&P.children.length>0&&(P.children=h(P.children)),P});return h(l)}),I=l=>{switch(l){case"user":return"用户";case"role":return"角色";case"user_group":return"用户组";default:return"未知"}},x=async()=>{let l=await d.$api.getMenuTree();O.value=l.data.results},w=async()=>{let l=await d.$api.getPermissionHas(b.value);C.value=l.data.results,v.value=l.data.results.map(c=>c.button_id)},R=(l,c,h)=>{c=="right"?E(h):W(h)},E=async l=>{const c={...b.value,button_ids:l};let h=await d.$api.addObjectPermissions(c);h.status==200?(G({type:"success",message:"权限添加成功"}),H(()=>{w()})):G({type:"error",message:`权限添加失败: ${JSON.stringify(h.data)}`})},W=async l=>{const c={...b.value,button_ids:l};let h=await d.$api.removeObjectPermissions(c);h.status==200?(G({type:"success",message:"权限删除成功"}),H(()=>{w()})):G({type:"error",message:`权限删除失败: ${JSON.stringify(h.data)}`})};return A({getPermissionTreeData:x,getPermissionOnRight:w}),(l,c)=>(K(),oe(je,{modelValue:v.value,"onUpdate:modelValue":c[0]||(c[0]=h=>v.value=h),data:Q.value,"leaf-only":!0,"hide-fully-assigned-parents":!0,titles:["可选权限","已选权限"],"check-strictly":!1,onChange:R},null,8,["modelValue","data"]))}}),$e={class:"permission-container"},Ve={class:"permission-content"},xe={class:"panel-header"},Re={class:"panel-actions"},Me={class:"tree-container"},Ie={class:"custom-tree-node"},De={class:"node-label"},qe={class:"panel-header"},Ke={class:"panel-actions"},Ue={class:"tree-container"},ze={class:"custom-tree-node"},Se={class:"node-label"},Ee={key:0,class:"instance-count"},Fe={class:"footer-actions"},Ge=ce({__name:"cmdbPermission",props:{nowNodeObject:{},nowNodeObjectModifiers:{},permissionObject:{},permissionObjectModifiers:{}},emits:["update:nowNodeObject","update:permissionObject"],setup(J){const{proxy:A}=ue(),d=Te(),b=le(J,"nowNodeObject");le(J,"permissionObject");const T=_("");_("");const O=_(),v=_(),C=q(()=>d.allModels),Q=q(()=>d.allModelCiDataObj),I=_([]),x=_([]),w=_([]),R=_([]),E={label:"verbose_name",children:"children"},W={modelgroups:"模型分组",models:"模型",modelfieldgroups:"字段组",modelfields:"字段",modelinstancegroup:"实例树",modelinstance:"实例"},l={modelgroups:"primary",models:"success",modelfieldgroups:"warning",modelfields:"info",modelinstancegroup:"warning",modelinstance:"info"},c=q(()=>{const o=I.value.length!==w.value.length||I.value.some(p=>!w.value.includes(p))||w.value.some(p=>!I.value.includes(p)),s=x.value.length!==R.value.length||x.value.some(p=>!R.value.includes(p))||R.value.some(p=>!x.value.includes(p));return o||s}),h=q(()=>{const o=Y.value.map(s=>({id:s.id,name:s.name,verbose_name:s.verbose_name,description:s.description,type:"modelgroups",parent_id:null,children:[]}));return C.value.forEach(s=>{const p=o.find(m=>m.id===s.model_group);if(p){const m={id:s.id,name:s.name,verbose_name:s.verbose_name,description:s.description,type:"models",parent_id:p.id,children:[]};s.field_groups&&s.field_groups.length>0&&(m.children=s.field_groups.map(g=>{const u={id:g.id,name:g.name,verbose_name:g.verbose_name,description:g.description,type:"modelfieldgroups",parent_id:m.id,children:[]};return g.fields&&g.fields.length>0&&(u.children=g.fields.map(N=>({id:N.id,name:N.name,verbose_name:N.verbose_name,description:N.description,type:"modelfields",parent_id:u.id}))),u})),p.children.push(m)}}),o}),S=q(()=>{const o=Y.value.map(s=>({id:s.id,name:s.name,verbose_name:s.verbose_name,description:s.description,type:"modelgroups",parent_id:null,children:[]}));return C.value.forEach(s=>{const p=o.find(m=>m.id===s.model_group);if(p){const m={id:s.id,name:s.name,verbose_name:s.verbose_name,description:s.description,type:"models",parent_id:p.id,children:[]};if(Q.value[s.id]){const g=(u,N)=>{const M={id:u.id,name:u.label,verbose_name:u.label,instance_count:u.instances?u.instances.length:0,built_in:u.built_in,level:u.level,type:"modelinstancegroup",parent_id:N,children:[]};return u.children&&u.children.length>0&&(M.children=u.children.map(V=>g(V,M.id))),u.instances&&u.instances.length>0&&u.instances.forEach(V=>{M.children.push({id:V.id,name:V.instance_name,verbose_name:V.instance_name,type:"modelinstance",parent_id:M.id})}),M};m.children.push(g(Q.value[s.id],m.id))}p.children.push(m)}}),o}),X=()=>{var o,s;w.value=((o=O.value)==null?void 0:o.getCheckedKeys())||[],R.value=((s=v.value)==null?void 0:s.getCheckedKeys())||[]},P=o=>{O.value.filter(o)},U=(o,s)=>s.verbose_name.includes(o),Y=_([]),se=async()=>{let o=await re.getCiModelGroup();Y.value=o.data.results},te=async()=>{d.getAllModelTreeInstances(!0)},ie=()=>{var j,ne,ae,y;let o=[];const s=(j=O.value)==null?void 0:j.getCheckedNodes(!1),m=((ne=O.value)==null?void 0:ne.getHalfCheckedNodes()).filter(i=>i.type==="modelfieldgroups").map(i=>i.id),g=s.filter(i=>i.type==="modelfieldgroups").map(i=>i.id),u=s.filter(i=>m.includes(i.parent_id)).map(i=>i.id);g.length>0&&o.push({app_label:"cmdb",model:"modelfieldgroups",object_ids:g}),u.length>0&&o.push({app_label:"cmdb",model:"modelfields",object_ids:u});const N=(ae=v.value)==null?void 0:ae.getCheckedNodes(!1),V=((y=v.value)==null?void 0:y.getHalfCheckedNodes()).filter(i=>i.type==="modelinstancegroup").map(i=>i.id),F=N.filter(i=>i.type==="modelinstancegroup"?!!(v.value.getNode(i.parent_id).data.type==="models"||V.includes(i.parent_id)):!1).map(i=>i.id),$=N.filter(i=>V.includes(i.parent_id)&&i.type==="modelinstance").map(i=>i.id);return F.length>0&&o.push({app_label:"cmdb",model:"modelinstancegroup",object_ids:F}),$.length>0&&o.push({app_label:"cmdb",model:"modelinstance",object_ids:$}),o},a=async()=>{if(!c.value){G.info("权限设置未发生变化，无需保存");return}let o=ie();console.log(o);let s=await re.setDataScope({scope_type:"filter",app_label:"cmdb",targets:o,...b.value});s.status=="201"?(G.success("权限更新成功!"),Z()):G.error("保存失败,"+JSON.stringify(s.data)),I.value=[...w.value],x.value=[...R.value]},e=_([]),k=_([]),D=_(!0),Z=async()=>{try{D.value=!0;let o=await re.getDataScope({...b.value});e.value=[],k.value=[],o.data.results.forEach(s=>{s.scope_type=="filter"&&Object.entries(s.targets_detail).forEach(([p,m])=>{["cmdb.modelfields","cmdb.modelfieldgroups"].indexOf(p)!==-1?m&&e.value.push(...m):["cmdb.modelinstance","cmdb.modelinstancegroup"].indexOf(p)!==-1&&m&&k.value.push(...m)})}),H(()=>{O.value.setCheckedKeys(e.value),v.value.setCheckedKeys(k.value),I.value=[...e.value],x.value=[...k.value],w.value=[...e.value],R.value=[...k.value]})}catch(o){console.error("获取数据范围失败:",o),e.value=[],k.value=[],O.value.setCheckedKeys([]),v.value.setCheckedKeys([]),I.value=[],x.value=[],w.value=[],R.value=[]}finally{setTimeout(()=>{D.value=!1},500)}};return me(()=>{se(),Z(),d.getModel(),d.getAllModelTreeInstances()}),(o,s)=>{const p=f("el-icon"),m=f("el-input"),g=f("el-tag"),u=f("el-tree-v2"),N=f("el-card"),M=f("el-button"),V=f("el-tooltip"),F=ve("loading");return K(),ee("div",$e,[r("div",Ve,[t(N,{class:"permission-panel"},{header:n(()=>[r("div",xe,[s[2]||(s[2]=r("span",{class:"panel-title"},"字段授权",-1)),r("div",Re,[t(m,{modelValue:T.value,"onUpdate:modelValue":s[0]||(s[0]=$=>T.value=$),placeholder:"输入关键字检索",clearable:"",class:"search-input",onInput:P},{prefix:n(()=>[t(p,null,{default:n(()=>[t(B(de))]),_:1})]),_:1},8,["modelValue"])])])]),default:n(()=>[r("div",Me,[pe((K(),oe(u,{data:h.value,props:E,"node-key":"id","show-checkbox":"",ref_key:"fieldTreeRef",ref:O,"filter-method":U,height:850,class:"permission-tree",onCheck:X},{default:n(({node:$,data:j})=>[r("div",Ie,[t(g,{size:"small",type:l[j.type]?l[j.type]:"info",class:"node-tag"},{default:n(()=>[L(z(W[j.type]),1)]),_:2},1032,["type"]),r("span",De,z($.label),1)])]),_:1},8,["data"])),[[F,D.value]])])]),_:1}),t(N,{class:"permission-panel"},{header:n(()=>[r("div",qe,[s[3]||(s[3]=r("span",{class:"panel-title"},"实例授权",-1)),r("div",Ke,[t(m,{modelValue:T.value,"onUpdate:modelValue":s[1]||(s[1]=$=>T.value=$),placeholder:"输入关键字检索",clearable:"",class:"search-input",onInput:P},{prefix:n(()=>[t(p,null,{default:n(()=>[t(B(de))]),_:1})]),_:1},8,["modelValue"]),t(V,{content:"刷新实例",placement:"top"},{default:n(()=>[t(M,{link:"",icon:B(be),onClick:te,class:"refresh-btn"},null,8,["icon"])]),_:1})])])]),default:n(()=>[r("div",Ue,[pe((K(),oe(u,{data:S.value,props:E,"node-key":"id","show-checkbox":"",ref_key:"instanceTreeRef",ref:v,height:850,class:"permission-tree",onCheck:X},{default:n(({node:$,data:j})=>[r("div",ze,[t(g,{size:"small",type:l[j.type]?l[j.type]:"info",class:"node-tag"},{default:n(()=>[L(z(W[j.type]),1)]),_:2},1032,["type"]),r("span",Se,z($.label),1),j.instance_count!==void 0?(K(),ee("span",Ee," ("+z(j.instance_count)+") ",1)):_e("",!0)])]),_:1},8,["data"])),[[F,D.value]])])]),_:1})]),r("div",Fe,[t(M,{type:"primary",size:"large",onClick:a,disabled:!c.value},{default:n(()=>[...s[4]||(s[4]=[L(" 保存 ",-1)])]),_:1},8,["disabled"])])])}}}),He=fe(Ge,[["__scopeId","data-v-061d398d"]]),Le={class:"permission-container"},Be={class:"left-panel"},Je={class:"panel-header"},Ae={class:"tree-container"},Qe={class:"custom-tree-node"},We={class:"right-panel"},Xe={key:0,class:"empty-placeholder"},Ye={key:1,class:"protected-object"},Ze={key:2,class:"permission-config"},es={class:"config-header"},ss={class:"header-info"},ts={class:"header-text"},ns={class:"object-name"},as={class:"object-type"},ls=ce({__name:"permissionView",setup(J){const{proxy:A}=ue();he();const d=ge(),b=_("user"),T=_([]),O=_(""),v=_(),C=_(),Q=_(),I={children:"children",label:"label",disabled:"disabled"};q(()=>window.innerHeight-200+"px");const x=()=>{};ye(()=>{window.removeEventListener("resize",x)}),ke(O,a=>{v.value.filter(a)});const w=a=>{switch(b.value){case"user":return{user:a};case"user_group":return{user_group:a};case"role":return{role:a}}},R=(a,e)=>a?e.label.includes(a):!0,E=_("menu"),W=(a,e)=>{},l=_(""),c=_({}),h=q(()=>["admin","sysadmin","系统管理组"].includes(l.value)),S=q(()=>({user:"用户",user_group:"用户组",role:"角色"})[b.value]||"未知"),X=q(()=>({user:"primary",user_group:"success",role:"warning"})[b.value]||"info"),P=a=>{l.value=a.label,c.value=w(a.id),!h.value&&H(()=>{C.value.getPermissionTreeData(),C.value.getPermissionOnRight()})},U=async()=>{const a=await A.$api.user();T.value=a.data.results.map(e=>({id:e.id,label:e.username,disabled:e.username==="admin"}))},Y=async()=>{const a=await A.$api.getUserGroup();T.value=a.data.results.map(e=>({id:e.id,label:e.group_name,disabled:e.group_name==="系统管理组"}))},se=async()=>{const a=await A.$api.getRole();T.value=a.data.results.map(e=>({id:e.id,label:e.role,disabled:e.role==="sysadmin"}))},te=a=>{switch(console.log(111),a){case"user":U(),l.value="";break;case"user_group":Y(),l.value="";break;case"role":se(),l.value="";break}},ie=async()=>{if(Object.keys(d.query).length>0){if(console.log("Route query:",d.query),d.query.role){b.value="role",await se(),v.value.setCurrentKey(d.query.role);const a=v.value.getNode(d.query.role);a&&(l.value=a.data.label,c.value=w(d.query.role),H(()=>{var e,k;(e=C.value)==null||e.getPermissionTreeData(),(k=C.value)==null||k.getPermissionOnRight()}))}else if(d.query.user){b.value="user",await U(),v.value.setCurrentKey(d.query.user);const a=v.value.getNode(d.query.user);a&&(l.value=a.data.label,c.value=w(d.query.user),H(()=>{var e,k;(e=C.value)==null||e.getPermissionTreeData(),(k=C.value)==null||k.getPermissionOnRight()}))}else if(d.query.user_group){b.value="user_group",await Y(),v.value.setCurrentKey(d.query.user_group);const a=v.value.getNode(d.query.user_group);a&&(l.value=a.data.label,c.value=w(d.query.user_group),H(()=>{var e,k;(e=C.value)==null||e.getPermissionTreeData(),(k=C.value)==null||k.getPermissionOnRight()}))}}else te("user")};return me(()=>{window.addEventListener("resize",x),ie()}),(a,e)=>{const k=f("el-text"),D=f("el-icon"),Z=f("el-radio-button"),o=we,s=f("el-radio-group"),p=f("el-input"),m=f("el-tag"),g=f("el-tree"),u=f("el-scrollbar"),N=f("el-splitter-panel"),M=f("el-empty"),V=f("el-result"),F=f("el-avatar"),$=f("el-tab-pane"),j=f("el-tabs"),ne=f("el-splitter"),ae=f("el-card");return K(),ee("div",Le,[t(ae,{class:"permission-card"},{default:n(()=>[t(ne,{class:"main-splitter"},{default:n(()=>[t(N,{min:250,size:250},{default:n(()=>[r("div",Be,[r("div",Je,[t(k,{class:"panel-title"},{default:n(()=>[...e[7]||(e[7]=[L("授权对象",-1)])]),_:1}),t(s,{modelValue:b.value,"onUpdate:modelValue":e[0]||(e[0]=y=>b.value=y),size:"small",onChange:te},{default:n(()=>[t(Z,{label:"user"},{default:n(()=>[t(D,null,{default:n(()=>[t(B(Ce))]),_:1}),e[8]||(e[8]=r("span",null,"用户",-1))]),_:1}),t(Z,{label:"user_group"},{default:n(()=>[t(D,null,{default:n(()=>[t(o,{icon:"material-symbols:group-outline"})]),_:1}),e[9]||(e[9]=r("span",null,"用户组",-1))]),_:1}),t(Z,{label:"role"},{default:n(()=>[t(D,null,{default:n(()=>[t(B(Ne))]),_:1}),e[10]||(e[10]=r("span",null,"角色",-1))]),_:1})]),_:1},8,["modelValue"])]),r("div",Ae,[t(p,{modelValue:O.value,"onUpdate:modelValue":e[1]||(e[1]=y=>O.value=y),placeholder:"搜索对象...",clearable:"",class:"search-input"},{prefix:n(()=>[t(D,null,{default:n(()=>[t(B(de))]),_:1})]),_:1},8,["modelValue"]),t(u,{class:"tree-scrollbar"},{default:n(()=>[t(g,{ref_key:"treeRef",ref:v,class:"object-tree",data:T.value,props:I,"default-expand-all":"","node-key":"id","highlight-current":"","filter-node-method":R,onNodeClick:P},{default:n(({node:y,data:i})=>[r("div",Qe,[r("span",null,z(y.label),1),i.disabled?(K(),oe(m,{key:0,type:"warning",size:"small",effect:"plain"},{default:n(()=>[...e[11]||(e[11]=[L(" 内置对象 ",-1)])]),_:1})):_e("",!0)])]),_:1},8,["data"])]),_:1})])])]),_:1}),t(N,{"min-size":30},{default:n(()=>[r("div",We,[l.value?h.value?(K(),ee("div",Ye,[t(V,{icon:"info",title:"受保护对象","sub-title":"此对象为系统内置对象，无需配置权限"},{icon:n(()=>[t(D,{class:"protected-icon"},{default:n(()=>[t(B(Oe))]),_:1})]),_:1})])):(K(),ee("div",Ze,[r("div",es,[r("div",ss,[t(F,{size:40},{default:n(()=>[L(z(l.value.charAt(0).toUpperCase()),1)]),_:1}),r("div",ts,[r("div",ns,z(l.value),1),r("div",as,[t(m,{type:X.value,effect:"plain"},{default:n(()=>[L(z(S.value),1)]),_:1},8,["type"])])])])]),t(j,{modelValue:E.value,"onUpdate:modelValue":e[6]||(e[6]=y=>E.value=y),type:"border-card",class:"permission-tabs",onTabClick:W},{default:n(()=>[t($,{label:"菜单授权",name:"menu"},{default:n(()=>[t(Pe,{ref_key:"menuPermissionRef",ref:C,nowNodeObject:c.value,"onUpdate:nowNodeObject":e[2]||(e[2]=y=>c.value=y),permissionObject:b.value,"onUpdate:permissionObject":e[3]||(e[3]=y=>b.value=y)},null,8,["nowNodeObject","permissionObject"])]),_:1}),t($,{label:"资产授权",name:"cmdb"},{default:n(()=>[t(He,{ref_key:"cmdbPermissionRef",ref:Q,nowNodeObject:c.value,"onUpdate:nowNodeObject":e[4]||(e[4]=y=>c.value=y),permissionObject:b.value,"onUpdate:permissionObject":e[5]||(e[5]=y=>b.value=y)},null,8,["nowNodeObject","permissionObject"])]),_:1})]),_:1},8,["modelValue"])])):(K(),ee("div",Xe,[t(M,{description:"请选择左侧授权对象"})]))])]),_:1})]),_:1})]),_:1})])}}}),cs=fe(ls,[["__scopeId","data-v-145e3622"]]);export{cs as default};
