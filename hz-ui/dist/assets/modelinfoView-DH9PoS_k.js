import{d as he,u as qe,b as Ae,bu as al,r,M as ae,c as ve,e as n,b3 as Be,o as _,f as T,h,g as e,w as t,F as G,b1 as ee,O as z,j as w,t as Q,bO as k,bQ as Je,bo as N,c0 as Pe,c1 as He,P as Ge,aE as sl,bF as oe,c4 as p,bV as _e,aD as Ie,k as Ne,_ as Qe,a as nl,aN as dl,aS as il,aI as ul,bZ as rl}from"./index-LFaOStT9.js";import{i as ml}from"./iconSelectCom-CY-Kwd5u.js";import{u as pl}from"./tabs-CVkWCk7m.js";import{l as Ze}from"./vue-draggable-plus-Dktzy7T_.js";const cl={class:"operation_show"},fl={class:"dialog-footer"},vl={class:"demo-drawer__content"},_l={style:{float:"left"}},bl={style:{float:"right",color:"var(--el-text-color-secondary)","font-size":"13px"}},gl={class:"demo-drawer__footer"},yl=he({__name:"ciModelField",props:{ciModelInfo:{},ciModelInfoModifiers:{}},emits:["update:ciModelInfo"],setup(be,{expose:D}){const{proxy:x}=Ne(),U=qe(),y=Ae(),I=al(be,"ciModelInfo"),A=r([]),H=r([]),le=r([]),Z=ae(()=>{let o=[];return A.value.forEach(l=>{l.fields.forEach(m=>{m.type==="model_ref"&&o.push(m.ref_model)})}),o}),q=ae(()=>{var l;let o=[];return(l=le.value)==null||l.forEach(m=>{m.id!==I.value.id&&(Z.value.indexOf(m.id)===-1?o.push({value:m.id,label:m.verbose_name,disabled:!1}):o.push({value:m.id,label:m.verbose_name,disabled:!0}))}),o}),V=()=>{s.default="",s.validation_rule="",s.type=="boolean"?s.default=!0:s.type=="enum"?c.value=!0:s.type=="string"&&(c.value=!1)},P=r([]),te=o=>{let l=JSON.parse(F.value[o].rule),m=[];Object.keys(l).forEach(b=>{m.push({value:b,label:l[b]})}),P.value=m},M=o=>{let l=JSON.parse(F.value[o].rule),m=[];Object.keys(l).forEach(b=>{m.push({value:b,label:l[b]})}),P.value=m,s.default!=P.value[0].value&&(s.default=P.value[0].value)},c=r(!1),B=ae(()=>s.type==="fromModel"),se=r([]),ne=async(o=null)=>{let l=await x.$api.getValidationRules({page:1,page_size:1e4,...o});se.value=l.data.results,l.data.results.forEach(m=>{F.value[m.id]=m})},F=r({}),S=ae(()=>{let o=[];return se.value.forEach(l=>{l.field_type==s.type&&o.push({value:l.id,label:l.verbose_name})}),o}),$=async()=>{let o=await x.$api.getCiModel(y.query,y.query.id);I.value=o.data.model,A.value=o.data.field_groups,H.value=o.data.field_groups.map(l=>l.name)},f=r([]),u=r([]);D({getModelField:$,getCiModelList:async()=>{let o=await x.$api.getCiModel();le.value=o.data.results},getRules:ne,getModelFieldType:async()=>{let o=await x.$api.getCiModelFieldType(),l=o.data.field_types;Object.keys(l).forEach(m=>{f.value.push({value:m,label:l[m]})}),u.value=o.data.limit_fields}});const O=ve({name:"",verbose_name:""}),ge=(o,l,m)=>{console.log(l),u.value.includes(l)?m(new Error(`${u.value.join(",")}不能用!`)):m()},ye=ve({name:[{required:!0,message:"请输入唯一标识",trigger:"blur"},{pattern:/^[a-z][\w\d]{4,20}$/,trigger:"blur",message:"以英文字符开头,可以使用英文,数字,下划线,长度4-20 "}],verbose_name:[{required:!0,message:"请输入组名称",trigger:"blur"}]}),ue=r(),d=r(!1),i=o=>{d.value=!1,ie(o)},W=r(!1),R=r(""),de=async o=>{o&&await o.validate(async(l,m)=>{if(l)if(W.value){console.log(O);let b=await x.$api.addCiModelFieldGroup({model:I.value.id,create_user:U.state.username,update_user:U.state.username,...O});console.log(b),b.status=="201"?(p({type:"success",message:"添加成功"}),d.value=!1,ie(o),$()):p({showClose:!0,message:"添加失败:"+JSON.stringify(b.data),type:"error"})}else{let b=await x.$api.updateCiModelFieldGroup({id:R.value,update_user:U.state.username,...O});console.log(b),b.status=="200"?(p({type:"success",message:"更新成功"}),d.value=!1,ie(o),$()):p({showClose:!0,message:"更新失败:"+JSON.stringify(b.data),type:"error"})}else console.log("error submit!",m)})},ce=o=>{_e.confirm("是否确认关闭?").then(()=>{o(),ie(ue.value)}).catch(()=>{})},v=r("新增"),E=o=>{v.value="新增",Ie(()=>{}),d.value=!0,W.value=!0},re=o=>{v.value="修改",d.value=!0,Ie(()=>{W.value=!1,O.name=o.name,O.verbose_name=o.verbose_name,R.value=o.id})},Fe=o=>{_e.confirm("是否确认删除?","删除组",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{let l=await x.$api.deleteCiModelFieldGroup(o);l.status==204||l.status==200?(p({type:"success",message:"删除成功"}),await $()):p({type:"error",message:"删除失败"})}).catch(()=>{p({type:"info",message:"取消删除"})})},X=r(!1),s=ve({name:"",verbose_name:"",type:"string",required:!1,editable:!0,validation_rule:"",ref_model:"",description:"",default:"",unit:""}),we=ve({name:[{required:!0,message:"请输入唯一标识",trigger:"blur"},{pattern:/^[a-z][\w\d]{1,20}$/,trigger:"blur",message:"以英文字符开头,可以使用英文,数字,下划线,长度2-20 ",required:!0},{validator:ge,trigger:"blur"}],verbose_name:[{required:!0,message:"请输入字段显示名称",trigger:"blur"}],type:[{required:!0,message:"字段类型",trigger:"blur"}],model_name:[{required:B,message:"请选择模型",trigger:"blur"}],validation_rule:[{required:c,message:"选择校验规则",trigger:""}]}),me=r();r(!1);const pe=r(!1),Y=r({}),Me=r(!0),Se=o=>{X.value=!0,v.value="修改",pe.value=!0,Y.value=o,Me.value=!1,Ie(()=>{Object.keys(o).forEach(l=>{s.hasOwnProperty(l)&&(s[l]=o[l])}),s.validation_rule===null?c.value=!1:c.value=!0})},Oe=o=>{ie(o),console.log(s),X.value=!1},C=o=>{v.value="新增",Y.value={},X.value=!0,Me.value=!0,pe.value=!1,c.value=!1,Ie(()=>{R.value=o.id})},Ce=async o=>{o&&await o.validate(async(l,m)=>{if(l)if(Me.value){let b=await x.$api.addCiModelField({model:I.value.id,model_field_group:R.value,create_user:U.state.username,update_user:U.state.username,...s});console.log(b),b.status=="201"?(p({type:"success",message:"添加成功"}),X.value=!1,ie(o),$()):p({showClose:!0,message:"添加失败:"+JSON.stringify(b.data),type:"error"})}else{c.value||(s.validation_rule="");let b=await x.$api.updateCiModelField({id:Y.value.id,update_user:U.state.username,...s});console.log(b),b.status=="200"?(p({type:"success",message:"更新成功"}),X.value=!1,ie(o),$()):p({showClose:!0,message:"更新失败:"+JSON.stringify(b.data),type:"error"})}else console.log("error submit!",m)})},Te=o=>{_e.confirm("是否确认关闭?").then(()=>{o(),ie(me.value),X.value=!1}).catch(()=>{})},Ke=o=>{_e.confirm("是否确认删除?","删除组",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await x.$api.deleteCiModelField(Y.value.id)).status==204?(p({type:"success",message:"删除成功"}),await $(),ie(me.value),X.value=!1):p({type:"error",message:"删除失败"})}).catch(()=>{p({type:"info",message:"取消删除"})})},ie=o=>{o&&o.resetFields()},We=async(o,l)=>{if(o.oldIndex==o.newIndex)return;if(o.pullMode){console.log("跨组移动，在onAdd中触发");return}let m=await x.$api.updateCiModelField({id:o.data.id,order:o.newIndex+1});m.status=="200"?p({type:"success",message:"更新排序成功"}):p({showClose:!0,message:"更新排序失败:"+JSON.stringify(m.data),type:"error"}),$()},Xe=async(o,l)=>{let m=await x.$api.updateCiModelField({id:o.data.id,order:o.newIndex+1,model_field_group:l.id});m.status=="200"?p({type:"success",message:"更新排序成功"}):p({showClose:!0,message:"更新排序失败:"+JSON.stringify(m.data),type:"error"}),$()};return(o,l)=>{const m=n("el-text"),b=n("el-button"),ke=n("el-tooltip"),Ye=n("el-space"),je=n("el-col"),Ee=n("el-row"),ze=n("el-card"),el=n("el-collapse-item"),ll=n("el-collapse"),Ve=n("el-input"),J=n("el-form-item"),De=n("el-form"),tl=n("el-dialog"),Re=n("el-switch"),xe=n("el-option"),$e=n("el-select"),ol=n("el-drawer"),fe=Be("permission");return _(),T(G,null,[h("div",null,[e(ll,{modelValue:H.value,"onUpdate:modelValue":l[0]||(l[0]=g=>H.value=g)},{default:t(()=>[(_(!0),T(G,null,ee(A.value,(g,Ue)=>(_(),z(el,{name:g.name,key:Ue},{title:t(()=>[e(m,{tag:"b",size:"large"},{default:t(()=>[w(Q(g.verbose_name),1)]),_:2},1024),h("div",cl,[g.built_in?Ge("",!0):(_(),z(Ye,{key:0},{default:t(()=>{var a;return[k((_(),z(ke,{class:"box-item",effect:"dark",content:"编辑",placement:"top"},{default:t(()=>{var L;return[k(e(b,{size:"small",onClick:Je(Le=>re(g),["stop"]),icon:N(Pe),circle:""},null,8,["onClick","icon"]),[[fe,`${(L=N(y).name)==null?void 0:L.replace("_info","")}:edit`]])]}),_:2},1024)),[[fe,`${(a=N(y).name)==null?void 0:a.replace("_info","")}:edit`]]),e(ke,{class:"box-item",effect:"dark",content:"删除",placement:"top"},{default:t(()=>{var L;return[k(e(b,{size:"small",onClick:Je(Le=>Fe(g.id),["stop"]),icon:N(He),circle:""},null,8,["onClick","icon"]),[[fe,`${(L=N(y).name)==null?void 0:L.replace("_info","")}:delete`]])]}),_:2},1024)]}),_:2},1024))])]),default:t(()=>[h("div",null,[e(N(Ze),{"force-fallback":!0,"scroll-sensitivity":200,ref_for:!0,ref:"el",group:"modelField",modelValue:g.fields,"onUpdate:modelValue":a=>g.fields=a,onEnd:a=>We(a,g),onAdd:a=>Xe(a,g),style:{width:"100%","flex-wrap":"wrap",display:"flex",gap:"10px","justify-items":"flex-start"}},{default:t(()=>{var a;return[(_(!0),T(G,null,ee(g.fields,(L,Le)=>(_(),T("div",{key:Le},[e(ke,{effect:"light",content:"点击编辑字段",placement:"top"},{default:t(()=>[e(ze,{shadow:"hover",class:sl(["modelFieldCard",L.built_in?"isBuiltClass":""]),onClick:hl=>Se(L)},{default:t(()=>[e(m,{tag:"b"},{default:t(()=>[w(Q(L.verbose_name),1)]),_:2},1024),e(Ee,{justify:"space-between"},{default:t(()=>[e(ke,{class:"box-item",effect:"light",content:L.name,placement:"bottom"},{default:t(()=>[e(je,{span:13,class:"describe-class"},{default:t(()=>[e(m,null,{default:t(()=>[w(Q(L.name),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["content"]),e(ke,{class:"box-item",effect:"light",content:L.type,placement:"bottom"},{default:t(()=>[e(je,{span:10,class:"describe-class"},{default:t(()=>[e(m,null,{default:t(()=>[w(Q(L.type),1)]),_:2},1024)]),_:2},1024)]),_:2},1032,["content"])]),_:2},1024)]),_:2},1032,["class","onClick"])]),_:2},1024)]))),128)),h("div",null,[k((_(),z(ze,{class:"modelFieldCard",style:{"align-items":"center","justify-content":"center"},onClick:L=>C(g)},{default:t(()=>[e(m,{type:"primary"},{default:t(()=>l[26]||(l[26]=[w("+ 添加字段")])),_:1})]),_:2},1032,["onClick"])),[[fe,`${(a=N(y).name)==null?void 0:a.replace("_info","")}:add`]])])]}),_:2},1032,["modelValue","onUpdate:modelValue","onEnd","onAdd"])])]),_:2},1032,["name"]))),128))]),_:1},8,["modelValue"]),e(Ee,{style:{"margin-top":"10px"}},{default:t(()=>[e(je,null,{default:t(()=>{var g;return[k((_(),z(b,{bg:"",text:"",onClick:l[1]||(l[1]=Ue=>E(I.value))},{default:t(()=>l[27]||(l[27]=[w("添加分组")])),_:1})),[[fe,`${(g=N(y).name)==null?void 0:g.replace("_info","")}:add`]])]}),_:1})]),_:1})]),e(tl,{modelValue:d.value,"onUpdate:modelValue":l[6]||(l[6]=g=>d.value=g),title:v.value+"字段分组",width:"500","before-close":ce},{footer:t(()=>[h("div",fl,[e(b,{onClick:l[4]||(l[4]=g=>i(ue.value))},{default:t(()=>l[28]||(l[28]=[w("取消")])),_:1}),e(b,{type:"primary",onClick:l[5]||(l[5]=g=>de(ue.value))},{default:t(()=>l[29]||(l[29]=[w(" 确认 ")])),_:1})])]),default:t(()=>[e(De,{ref_key:"groupFormRef",ref:ue,style:{"max-width":"600px"},model:O,rules:ye,"label-width":"auto",class:"demo-modelForm","status-icon":""},{default:t(()=>[e(J,{label:"字段组标识",prop:"name"},{default:t(()=>[e(Ve,{modelValue:O.name,"onUpdate:modelValue":l[2]||(l[2]=g=>O.name=g),disabled:!W.value},null,8,["modelValue","disabled"])]),_:1}),e(J,{label:"字段分组名称",prop:"verbose_name"},{default:t(()=>[e(Ve,{modelValue:O.verbose_name,"onUpdate:modelValue":l[3]||(l[3]=g=>O.verbose_name=g)},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue","title"]),e(ol,{modelValue:X.value,"onUpdate:modelValue":l[25]||(l[25]=g=>X.value=g),title:"模型字段","before-close":Te,direction:"rtl",class:"demo-drawer"},{default:t(()=>{var g,Ue;return[h("div",vl,[e(De,{model:s,ref_key:"modelFieldFormRef",ref:me,"label-width":"auto","label-position":"right",rules:we},{default:t(()=>[e(J,{label:"唯一标识",prop:"name"},{default:t(()=>[e(Ve,{modelValue:s.name,"onUpdate:modelValue":l[7]||(l[7]=a=>s.name=a),autocomplete:"off",disabled:!!(Y.value.built_in||pe.value)},null,8,["modelValue","disabled"])]),_:1}),e(J,{label:"显示名称",prop:"verbose_name"},{default:t(()=>[e(Ve,{modelValue:s.verbose_name,"onUpdate:modelValue":l[8]||(l[8]=a=>s.verbose_name=a),autocomplete:"off"},null,8,["modelValue"])]),_:1}),e(J,{label:"可编辑",prop:"editable"},{default:t(()=>[e(Re,{modelValue:s.editable,"onUpdate:modelValue":l[9]||(l[9]=a=>s.editable=a),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},disabled:Y.value.built_in},null,8,["modelValue","disabled"])]),_:1}),e(J,{label:"必填",prop:"required"},{default:t(()=>[e(Re,{modelValue:s.required,"onUpdate:modelValue":l[10]||(l[10]=a=>s.required=a),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"}},null,8,["modelValue"])]),_:1}),e(J,{label:"字段类型",prop:"type"},{default:t(()=>[e($e,{modelValue:s.type,"onUpdate:modelValue":l[11]||(l[11]=a=>s.type=a),placeholder:"Select",style:{width:"240px"},onChange:V,disabled:!!(Y.value.built_in||pe.value)},{default:t(()=>[(_(!0),T(G,null,ee(f.value,a=>(_(),z(xe,{key:a.value,label:a.label,value:a.value},{default:t(()=>[h("span",_l,Q(a.label),1),h("span",bl,Q(a.value),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),k(e(J,{label:"校验规则",prop:"validation_rule"},{default:t(()=>[e(Re,{modelValue:c.value,"onUpdate:modelValue":l[12]||(l[12]=a=>c.value=a),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949","margin-right":"10px"}},null,8,["modelValue"]),k(e($e,{modelValue:s.validation_rule,"onUpdate:modelValue":l[13]||(l[13]=a=>s.validation_rule=a),placeholder:"选择校验规则",style:{width:"240px"}},{default:t(()=>[(_(!0),T(G,null,ee(S.value,a=>(_(),z(xe,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"]),[[oe,c.value]])]),_:1},512),[[oe,s.type==="string"]]),k(e(J,{label:"枚举值",prop:"validation_rule"},{default:t(()=>[e($e,{modelValue:s.validation_rule,"onUpdate:modelValue":l[14]||(l[14]=a=>s.validation_rule=a),placeholder:"选择校验规则",style:{width:"240px"},onChange:l[15]||(l[15]=a=>M(s.validation_rule))},{default:t(()=>[(_(!0),T(G,null,ee(S.value,a=>(_(),z(xe,{key:a.value,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},512),[[oe,s.type==="enum"]]),k(e(J,{label:"默认值",prop:"default"},{default:t(()=>[e($e,{modelValue:s.default,"onUpdate:modelValue":l[16]||(l[16]=a=>s.default=a),placeholder:"选择默认值",size:"large",onVisibleChange:l[17]||(l[17]=a=>te(s.validation_rule))},{default:t(()=>[(_(!0),T(G,null,ee(P.value,(a,L)=>(_(),z(xe,{key:L,label:a.label,value:a.value},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1},512),[[oe,s.type==="enum"]]),k(e(J,{label:"模型引用",prop:"ref_model"},{default:t(()=>[e($e,{modelValue:s.ref_model,"onUpdate:modelValue":l[18]||(l[18]=a=>s.ref_model=a),placeholder:"选择CI模型",disabled:!!(Y.value.built_in||pe.value)},{default:t(()=>[(_(!0),T(G,null,ee(q.value,a=>(_(),z(xe,{key:a.value,label:a.label,disabled:a.disabled,value:a.value},null,8,["label","disabled","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1},512),[[oe,s.type==="model_ref"]]),k(e(J,{label:"默认值",prop:"default"},{default:t(()=>[e(Re,{modelValue:s.default,"onUpdate:modelValue":l[19]||(l[19]=a=>s.default=a),style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"}},null,8,["modelValue"])]),_:1},512),[[oe,s.type==="boolean"]]),k(e(J,{label:"单位",prop:"unit"},{default:t(()=>[e(Ve,{modelValue:s.unit,"onUpdate:modelValue":l[20]||(l[20]=a=>s.unit=a),style:{width:"120px"}},null,8,["modelValue"])]),_:1},512),[[oe,s.type==="integer"||s.type==="float"]]),e(J,{label:"描述",prop:"description"},{default:t(()=>[e(Ve,{modelValue:s.description,"onUpdate:modelValue":l[21]||(l[21]=a=>s.description=a),type:"textarea"},null,8,["modelValue"])]),_:1})]),_:1},8,["model","rules"]),h("div",gl,[e(b,{onClick:l[22]||(l[22]=a=>Oe(me.value))},{default:t(()=>l[30]||(l[30]=[w("取消")])),_:1}),pe.value&&!Y.value.built_in?k((_(),z(b,{key:0,type:"danger",onClick:l[23]||(l[23]=a=>Ke())},{default:t(()=>l[31]||(l[31]=[w("删除")])),_:1})),[[fe,`${(g=N(y).name)==null?void 0:g.replace("_info","")}:delete`]]):Ge("",!0),k((_(),z(b,{type:"primary",onClick:l[24]||(l[24]=a=>Ce(me.value))},{default:t(()=>l[32]||(l[32]=[w(" 确定 ")])),_:1})),[[fe,`${(Ue=N(y).name)==null?void 0:Ue.replace("_info","")}:edit`]])])])]}),_:1},8,["modelValue"])],64)}}}),wl=Qe(yl,[["__scopeId","data-v-9d0d5824"]]),Cl={style:{width:"100%"}},Vl={class:"table-header"},Fl={class:"header-button-lf"},Ml={class:"dialog-footer"},kl=he({__name:"ciModelUnique",props:["modelId","modelFieldLists"],setup(be,{expose:D}){const x=Ae(),{proxy:U}=Ne(),y=qe(),I=r([]),A=be,H=()=>{V.value=!0,te.value=!0},le=ae(()=>{let f={};return A.modelFieldLists.forEach(u=>{f[u.name]=u.verbose_name}),f}),Z=r(""),q=ve({fields:[],validate_null:!1,description:null}),V=r(!1),P=()=>{V.value=!1,B(Z.value)},te=r(!0),M=r({}),c=f=>{M.value=f,V.value=!0,te.value=!1,Ie(()=>{Object.keys(f).forEach(u=>{u!=="id"&&Object.keys(q).indexOf(u)!==-1&&(q[u]=f[u])})})},B=f=>{f&&(f.resetFields(),M.value={})},se=async f=>{await f.validate(async(u,K)=>{if(u)if(te.value){let j=await U.$api.addCiModelUnique({create_user:y.state.username,update_user:y.state.username,...q,model:A.modelId});j.status=="201"?(p({type:"success",message:"添加成功"}),V.value=!1,B(f),$({model:A.modelId})):p({showClose:!0,message:"添加失败:"+JSON.stringify(j.data),type:"error"})}else{let j=await U.$api.updateCiModelUnique({id:M.value.id,update_user:y.state.username,...q});j.status=="200"?(p({type:"success",message:"更新成功"}),V.value=!1,B(f),$({model:A.modelId})):p({showClose:!0,message:"更新失败:"+JSON.stringify(j.data),type:"error"})}})},ne=async f=>{let u=await U.$api.updateCiModelUnique({update_user:y.state.username,...f});u.status=="200"?(p({type:"success",message:"更新成功"}),B(Z.value),$({model:A.modelId})):p({showClose:!0,message:"更新失败:"+JSON.stringify(u.data),type:"error"})},F=f=>{_e.confirm("是否确认删除?","删除",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await U.$api.deleteCiModelUnique(f)).status==204?(p({type:"success",message:"删除成功"}),$({model:A.modelId}),B(Z.value),V.value=!1):p({type:"error",message:"删除失败"})}).catch(()=>{p({type:"info",message:"取消删除"})})},S=ae(()=>{let f={};return I.value.forEach(u=>{var j;let K=u.fields.map(O=>le.value[O]);f[(j=u.fields)==null?void 0:j.join("+")]=K.join("+")}),f}),$=async f=>{let u=await U.$api.getCiModelUnique(f);I.value=u.data.results};return D({getTableData:$}),(f,u)=>{const K=n("el-button"),j=n("el-table-column"),O=n("el-switch"),ge=n("el-tooltip"),ye=n("el-table"),ue=n("el-option"),d=n("el-select"),i=n("el-form-item"),W=n("el-input"),R=n("el-form"),de=n("el-dialog"),ce=Be("permission");return _(),T("div",Cl,[h("div",Vl,[h("div",Fl,[e(K,{type:"primary",onClick:H},{default:t(()=>u[5]||(u[5]=[w("添加")])),_:1})])]),e(ye,{ref:"multipleTableRef",data:I.value,style:{width:"100%"},border:""},{default:t(()=>[e(j,{prop:"fields",label:"校验规则"},{default:t(v=>[h("span",null,Q(S.value[v.row.fields.join("+")]),1)]),_:1}),e(j,{prop:"validate_null",label:"空值校验"},{default:t(v=>{var E;return[k(e(O,{modelValue:v.row.validate_null,"onUpdate:modelValue":re=>v.row.validate_null=re,class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},onChange:re=>ne({id:v.row.id,validate_null:v.row.validate_null}),disabled:v.row.built_in},null,8,["modelValue","onUpdate:modelValue","onChange","disabled"]),[[ce,{id:`${(E=N(x).name)==null?void 0:E.replace("_info","")}:edit`,action:"disabled"}]])]}),_:1}),e(j,{prop:"description",label:"描述"}),e(j,{fixed:"right",width:"100",label:"操作"},{default:t(v=>[e(ge,{class:"box-item",effect:"dark",content:"编辑",placement:"top"},{default:t(()=>{var E;return[k(e(K,{link:"",type:"primary",icon:N(Pe),onClick:re=>c(v.row)},null,8,["icon","onClick"]),[[ce,`${(E=N(x).name)==null?void 0:E.replace("_info","")}:edit`]])]}),_:2},1024),e(ge,{class:"box-item",effect:"dark",content:"删除",placement:"top"},{default:t(()=>{var E;return[k(e(K,{link:"",type:"danger",icon:N(He),disabled:v.row.built_in,onClick:re=>F(v.row.id)},null,8,["icon","disabled","onClick"]),[[ce,`${(E=N(x).name)==null?void 0:E.replace("_info","")}:delete`]])]}),_:2},1024)]),_:1})]),_:1},8,["data"]),e(de,{modelValue:V.value,"onUpdate:modelValue":u[4]||(u[4]=v=>V.value=v),title:"唯一校验配置",width:"500","before-close":P},{footer:t(()=>[h("div",Ml,[e(K,{onClick:P},{default:t(()=>u[6]||(u[6]=[w("取消")])),_:1}),e(K,{type:"primary",onClick:u[3]||(u[3]=v=>se(Z.value))},{default:t(()=>u[7]||(u[7]=[w(" 提交 ")])),_:1})])]),default:t(()=>[e(R,{inline:!0,"label-position":"right",model:q,"label-width":"auto",ref_key:"formRef",ref:Z},{default:t(()=>[e(i,{label:"唯一校验组合",prop:"fields"},{default:t(()=>[e(d,{modelValue:q.fields,"onUpdate:modelValue":u[0]||(u[0]=v=>q.fields=v),fields:"选择字段组合",multiple:"","multiple-limit":5,clearable:"",filterable:"",style:{width:"240px"},disabled:!!(M.value.built_in||!te.value)},{default:t(()=>[(_(!0),T(G,null,ee(A.modelFieldLists,(v,E)=>(_(),z(ue,{label:v.verbose_name,value:v.name,key:E},null,8,["label","value"]))),128))]),_:1},8,["modelValue","disabled"])]),_:1}),e(i,{label:"空置校验",prop:"validate_null"},{default:t(()=>[e(O,{modelValue:q.validate_null,"onUpdate:modelValue":u[1]||(u[1]=v=>q.validate_null=v),class:"ml-2",style:{"--el-switch-on-color":"#13ce66","--el-switch-off-color":"#ff4949"},disabled:M.value.built_in},null,8,["modelValue","disabled"])]),_:1}),e(i,{label:"描述",prop:"description"},{default:t(()=>[e(W,{modelValue:q.description,"onUpdate:modelValue":u[2]||(u[2]=v=>q.description=v),style:{width:"240px"},autosize:{minRows:2,maxRows:4},type:"textarea"},null,8,["modelValue"])]),_:1})]),_:1},8,["model"])]),_:1},8,["modelValue"])])}}}),xl={class:"card"},$l={class:"listItem"},Ul=he({__name:"ciModelTemplateName",props:["modelId","modelFieldLists","ciModelInfo"],setup(be,{expose:D}){const{proxy:x}=Ne();qe();const U=be,y=r(!1),I=r([]),A=M=>{console.log(M),console.log(I.value)},H=ae(()=>U.modelFieldLists.filter(M=>["string","enum","model_ref"].includes(M.type))),le=ae(()=>{let M=new Object;return U.modelFieldLists.forEach(c=>{M[c.id]=c}),M}),Z=()=>{},q=()=>{y.value=!0},V=()=>{y.value=!1},P=async()=>{let M=await x.$api.updateCiModel({id:U.modelId,instance_name_template:I.value});M.status=="200"?(p({type:"success",message:"更新成功"}),y.value=!1,emits("getCiModel")):p({showClose:!0,message:"更新失败:"+JSON.stringify(M.data),type:"error"})};return D({getModel:async()=>{let M=await x.$api.getCiModel(null,U.modelId);I.value=M.data.model.instance_name_template}}),(M,c)=>{const B=n("el-button"),se=n("el-divider"),ne=n("el-checkbox"),F=n("el-checkbox-group");return _(),T(G,null,[c[6]||(c[6]=h("div",null,null,-1)),h("div",xl,[k(e(B,{type:"primary",onClick:q},{default:t(()=>c[1]||(c[1]=[w("编辑")])),_:1},512),[[oe,!y.value]]),k(e(B,{onClick:V},{default:t(()=>c[2]||(c[2]=[w("取消")])),_:1},512),[[oe,y.value]]),k(e(B,{type:"primary",onClick:P},{default:t(()=>c[3]||(c[3]=[w("保存")])),_:1},512),[[oe,y.value]]),e(se,null,{default:t(()=>c[4]||(c[4]=[w("可选择指标")])),_:1}),e(F,{modelValue:I.value,"onUpdate:modelValue":c[0]||(c[0]=S=>I.value=S),onChange:A,max:5,disabled:!y.value},{default:t(()=>[(_(!0),T(G,null,ee(H.value,(S,$)=>(_(),z(ne,{key:$,label:S.verbose_name,value:S.id},{default:t(()=>[w(Q(S.verbose_name),1)]),_:2},1032,["label","value"]))),128))]),_:1},8,["modelValue","disabled"]),e(se,null,{default:t(()=>c[5]||(c[5]=[w("拖拽调整顺序")])),_:1}),e(N(Ze),{disabled:!0,"force-fallback":!0,"scroll-sensitivity":200,ref:"el",onEnd:Z,style:{width:"100%",overflow:"auto"}},{default:t(()=>[(_(!0),T(G,null,ee(I.value,(S,$)=>(_(),T("div",{key:$},[h("div",$l,[h("span",null,Q(le.value[S].verbose_name),1)])]))),128))]),_:1},512)])],64)}}}),Il={class:"card"},Ol={class:"dialog-footer"},Rl=he({__name:"modelinfoView",setup(be){const D=Ae(),x=pl(),U=r(""),y=r(""),I=r("");nl();const A=qe(),{proxy:H}=Ne();r("");const le=r([]),Z=async()=>{let d=await H.$api.getCiModelGroup();console.log(d),le.value=d.data.results,console.log(le.value)},q=r({}),V=r({}),P=async()=>{let d=await H.$api.getCiModel(D.query,D.query.id);V.value=d.data.model,q.value=d.data,console.log(V.value)},te=ae(()=>{var i;let d=new Array;return(i=q.value.field_groups)==null||i.forEach(W=>{W.fields.forEach(R=>{d.push(R)})}),d}),M=(d,i)=>{d.props.name==="verification"?U.value.getTableData({model:ne.value}):d.props.name==="field"||d.props.name==="instance_name_temp"&&I.value.getModel()},c=r("field");console.log(D);const B=r(!1),se=()=>{B.value=!0};r("ElemeFilled");const ne=ae(()=>{var d;return(d=V.value)==null?void 0:d.id}),F=ve({name:"",verbose_name:"",model_group:"",icon:"ElemeFilled",built_in:!1,update_user:"admin"}),S=r(),$=ve({name:[{required:!0,message:"请输入模型标识",trigger:"blur"},{pattern:/^[a-z][a-z_]{3,20}$/,trigger:"blur",message:"以英文字符开头,可以使用英文,下划线,长度3-20 ",required:!0}],verbose_name:[{required:!0,message:"请输入模型名称",trigger:"blur"}],model_group:[{required:!0,message:"请选择分组",trigger:"blur"}]});r(!1);const f=r(!1),u=d=>{f.value=!1,O(d)},K=async d=>{d&&await d.validate(async(i,W)=>{if(i){let R=await H.$api.updateCiModel({id:ye.value,...F});console.log(R),R.status=="200"?(p({type:"success",message:"更新成功"}),f.value=!1,O(d),getCiModelInfo(D.query,D.query.id)):p({showClose:!0,message:"添加失败:"+JSON.stringify(R.data),type:"error"})}})},j=d=>{_e.confirm("是否确认关闭?").then(()=>{d(),O(S.value)}).catch(()=>{})},O=d=>{d&&d.resetFields()},ge=d=>{_e.confirm("是否确认删除?","删除组",{confirmButtonText:"确认删除",cancelButtonText:"取消",type:"warning",draggable:!0}).then(async()=>{(await H.$api.deleteCiModel(d)).status==204?(p({type:"success",message:"删除成功"}),x.removeTabs(D.path,!0)):p({type:"error",message:"删除失败"})}).catch(()=>{p({type:"info",message:"取消删除"})})},ye=r(""),ue=d=>{console.log(d),F.icon=d.icon,F.verbose_name=d.verbose_name,F.name=d.name,F.model_group=d.model_group,F.update_user=A.state.username,console.log(F),f.value=!0,ye.value=d.id,Z()};return dl(async()=>{console.log("onMount"),await P(),await y.value.getModelField(),await y.value.getCiModelList(),await y.value.getRules(),await y.value.getModelFieldType()}),il(()=>{console.log("onUnmounted")}),ul(()=>{console.log("onBeforeMount")}),(d,i)=>{const W=rl,R=n("el-button"),de=n("el-text"),ce=n("el-link"),v=n("el-space"),E=n("el-col"),re=n("el-row"),Fe=n("el-tab-pane"),X=n("el-tabs"),s=n("el-scrollbar"),we=n("el-form-item"),me=n("el-input"),pe=n("el-option"),Y=n("el-select"),Me=n("el-form"),Se=n("el-dialog"),Oe=Be("permission");return _(),T(G,null,[h("div",Il,[e(s,null,{default:t(()=>[e(re,{class:"cimodelinfo",justify:"space-between"},{default:t(()=>[e(E,{span:20},{default:t(()=>[e(v,{size:30,style:{width:"40%"}},{default:t(()=>[e(R,{size:"large",circle:"",disabled:"",style:{margin:"10px"}},{default:t(()=>{var C;return[e(W,{icon:(C=V.value)==null?void 0:C.icon},null,8,["icon"])]}),_:1}),e(de,null,{default:t(()=>[i[11]||(i[11]=w("唯一标识:   ")),e(de,{tag:"b"},{default:t(()=>[w(Q(V.value.name),1)]),_:1})]),_:1}),e(de,null,{default:t(()=>[i[12]||(i[12]=w("名称:   ")),e(de,{tag:"b"},{default:t(()=>[w(Q(V.value.verbose_name),1)]),_:1})]),_:1}),e(de,null,{default:t(()=>[i[13]||(i[13]=w("实例数:   ")),e(ce,{type:"primary",tag:"b",disabled:"",href:"/#/cmdb/cidata"},{default:t(()=>[w(Q(V.value.instance_count),1)]),_:1})]),_:1})]),_:1})]),_:1}),e(E,{span:2,style:{display:"flex","align-items":"center","justify-content":"center"}},{default:t(()=>[e(v,{alignment:"flex-end"},{default:t(()=>{var C,Ce;return[k(e(R,{disabled:V.value.built_in,icon:"Delete",onClick:i[0]||(i[0]=Te=>ge(V.value.id)),circle:""},null,8,["disabled"]),[[Oe,`${(C=N(D).name)==null?void 0:C.replace("_info","")}:delete`]]),k(e(R,{disabled:V.value.built_in,icon:"Edit",onClick:i[1]||(i[1]=Te=>ue(V.value)),circle:""},null,8,["disabled"]),[[Oe,`${(Ce=N(D).name)==null?void 0:Ce.replace("_info","")}:edit`]])]}),_:1})]),_:1})]),_:1}),e(X,{modelValue:c.value,"onUpdate:modelValue":i[2]||(i[2]=C=>c.value=C),type:"card",class:"demo-tabs",onTabClick:M},{default:t(()=>[e(Fe,{label:"模型字段",name:"field"},{default:t(()=>[e(wl,{ref_key:"ciModelFieldRef",ref:y},null,512)]),_:1}),e(Fe,{label:"唯一校验",name:"verification"},{default:t(()=>[e(kl,{modelId:ne.value,modelFieldLists:te.value,ref_key:"ciModelUniqueRef",ref:U},null,8,["modelId","modelFieldLists"])]),_:1}),e(Fe,{label:"唯一标识命名",name:"instance_name_temp"},{default:t(()=>[e(Ul,{modelId:ne.value,ciModelInfo:V.value,modelFieldLists:te.value,ref_key:"ciModelTemplateRef",ref:I,onGetCiModel:P},null,8,["modelId","ciModelInfo","modelFieldLists"])]),_:1})]),_:1},8,["modelValue"])]),_:1})]),e(Se,{modelValue:f.value,"onUpdate:modelValue":i[10]||(i[10]=C=>f.value=C),title:"编辑模型",width:"500","before-close":j},{footer:t(()=>[h("div",Ol,[e(R,{onClick:i[8]||(i[8]=C=>u(S.value))},{default:t(()=>i[14]||(i[14]=[w("取消")])),_:1}),e(R,{type:"primary",onClick:i[9]||(i[9]=C=>K(S.value))},{default:t(()=>i[15]||(i[15]=[w(" 确认 ")])),_:1})])]),default:t(()=>[e(Me,{ref_key:"modelFormRef",ref:S,style:{"max-width":"600px"},model:F,rules:$,"label-width":"auto",class:"demo-modelForm","status-icon":""},{default:t(()=>[e(we,{label:"模型图标",prop:"icon"},{default:t(()=>[e(R,{onClick:se,icon:F.icon},null,8,["icon"]),e(ml,{isShow:B.value,"onUpdate:isShow":i[3]||(i[3]=C=>B.value=C),iconName:F.icon,"onUpdate:iconName":i[4]||(i[4]=C=>F.icon=C)},null,8,["isShow","iconName"])]),_:1}),e(we,{label:"唯一标识",prop:"name"},{default:t(()=>[e(me,{modelValue:F.name,"onUpdate:modelValue":i[5]||(i[5]=C=>F.name=C),placeholder:"请输入模型的唯一标识",disabled:""},null,8,["modelValue"])]),_:1}),e(we,{label:"模型名称",prop:"verbose_name"},{default:t(()=>[e(me,{modelValue:F.verbose_name,"onUpdate:modelValue":i[6]||(i[6]=C=>F.verbose_name=C)},null,8,["modelValue"])]),_:1}),e(we,{label:"所属分组",prop:"model_group"},{default:t(()=>[e(Y,{modelValue:F.model_group,"onUpdate:modelValue":i[7]||(i[7]=C=>F.model_group=C),placeholder:"选择分组"},{default:t(()=>[(_(!0),T(G,null,ee(le.value,(C,Ce)=>(_(),z(pe,{label:C.verbose_name,value:C.id,key:Ce},null,8,["label","value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["model","rules"])]),_:1},8,["modelValue"])],64)}}}),jl=Qe(Rl,[["__scopeId","data-v-c34da6fa"]]);export{jl as default};
